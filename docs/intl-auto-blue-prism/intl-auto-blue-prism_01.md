

# 第一章：机器学习即服务：数字交换和 Web API

我们今天与 ML 互动的大部分方式都是通过**Web API**。即使是通过 Web 浏览器使用**大型语言模型**（**LLM**）聊天机器人，也会在后台进行 Web API 调用以给我们回复。通常情况下，您的 BP 流程也将使用 Web API 来获取在线托管 ML 预测的结果。

在本章中，我们将探讨 IA 中最流行的 ML Web API，如何在 BP 的**数字交换**（**DX**）上找到它们，如何将它们连接到 BP，以及如何自己构建一个，以便在自动化用例中进行预测。更具体地说，我们将涵盖以下内容：

+   了解最常见的 ML 服务、它们的一些常见用例以及如何在 DX 上找到它们

+   通过两个示例说明如何使用 DX 中预构建的可下载资产进行 ML 预测

+   从头开始构建 BP **Web API 服务**以连接到 DX 上目前不可用的 ML 服务

到本章结束时，我们将涵盖三个最常用的**机器学习即服务**（**MLaaS**）平台：**亚马逊网络服务**（**AWS**）、**Azure**和**谷歌云平台**（**GCP**）的示例。这些示例还涵盖了某些最常见的 IA 用例：从非结构化文本中提取数据、从表格中提取数据以及从图像中提取文本。我们还将涵盖一些关键概念，这些概念将指导我们未来的解决方案设计：**单次**与**批量**以及**同步**与**异步**预测。

# 技术要求

对于本章，请确保以下条件满足：

+   一个有效的 Blue Prism Portal ([`portal.blueprism.com`](https://portal.blueprism.com)) 账户。这是从 DX 下载资产所必需的。账户可以免费创建。

+   在 AWS、Azure 和 GCP 上有一个活跃的账户。在本章中，我们将使用每个供应商的示例。所有示例都可以在服务提供的免费层中运行。

+   从 GitHub [`github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/Ex_1_to_3.bprelease`](https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/Ex_1_to_3.bprelease) 下载以下文件。将`.bprelease`文件导入 BP。这包含将在我们的示例中使用的示例流程。

# 使用 DX

DX 是 BP 的市场，包含许多 BP 开发和社区提交的`.bprelease`、`.bpskill`、`.bpobject`、`.bpprocess`和`.xml`文件。DX 上的大多数资产都可以免费下载和集成；然而，使用 ML API 服务本身可能存在成本。如果服务符合您的用例，使用 DX 中的预构建资产是**最快和最简单的方法**来将 ML 集成到您的自动化业务流程中。

在本节中，我们将了解 DX 上可用的流行机器学习服务以及潜在的使用案例。在可能的情况下，将提供真实世界的使用案例示例，这些示例来自我对超过 100 个 IA 用例和技术的研究。

## 访问 DX

可以通过[`digitalexchange.blueprism.com`](https://digitalexchange.blueprism.com)访问 DX。你需要使用你的 BP 门户账户凭据登录以下载资产。

DX 上可用的不仅仅是 Web API。由于我们只对本章中的 Web API 感兴趣，请点击**更多过滤器**并根据**连接器**过滤以缩小搜索结果：

![图 1.1 – 在 DX 上过滤 Web API](img/B18416_01_1.jpg)

图 1.1 – 在 DX 上过滤 Web API

可以使用**搜索资产**搜索框来查找特定的 ML 服务，如果你已经知道服务名称。稍后，我将提供所有最流行的搜索术语的摘要，你可以根据它们的使用案例在 DX 上找到 ML 资产。但首先，让我们讨论一些使用 ML Web API 所需的基本知识。

## 机器学习 Web API 基础知识

在传统的 RPA 中，BP 通过网页浏览器与桌面应用程序或网站交互。通常无法通过这两种方法连接到机器学习算法。相反，超过 90%的商业可用算法，包括 AWS、Azure、GCP、OpenAI 等，都作为 Web API 公开。

以下图像显示了从 BP 数字工作者发出的标准 Web API 调用。首先，数字工作者发起 API 请求，通过互联网到达 API 端点。做出机器学习预测后，端点返回包含预测的 API 响应，返回到 BP。

![图 1.2 – 使用 RPA 与 ML 最常见的方式：通过互联网进行 Web API 调用](img/B18416_01_2.jpg)

图 1.2 – 使用 RPA 与 ML 最常见的方式：通过互联网进行 Web API 调用

许多机器学习模型是专有的。供应商希望通过在自己的服务器上托管模型来保护他们的知识产权，这些服务器具有受保护的 API 端点。如果你的 BP 环境不允许连接到互联网，你需要咨询你的网络和安全团队，看看是否可以做出例外。

如果不行，那么使用公开托管的机器学习 API 将不可行。你将不得不在 Intranet 上开发和托管自己的模型，或者直接在数字工作者上做出预测。请注意，是数字工作者发起机器学习请求。有些人错误地认为 BP 应用程序服务器会调用 API 端点。

注意区分*Web API*，这是我们连接以获取机器学习预测的 API，以及*Web API 服务*，这是 BP 产品的一个功能。Web API 服务功能用于定义和设置与 Web API 的连接。我们将在这个章节的最后创建一个 Web API 服务作为最后一个示例。

关于此产品功能的官方文档可以在此处找到：[`bpdocs.blueprism.com/bp-7-1/en-us/Web%20API/HTML/configure-api-definition.htm`](https://bpdocs.blueprism.com/bp-7-1/en-us/Web%20API/HTML/configure-api-definition.htm)

在本节的剩余部分，我们将从 IA 集成角度探讨了解 Web API 的重要信息。这包括**认证**、**JSON**、**定价**、**单次**与**批量**预测，以及**同步**与**异步**预测。

### 认证

大多数 Web API 服务在使用前都需要你注册。注册后，你会得到一个或多个唯一的 ID，类似于用户名和密码，以唯一地识别你。根据具体的服务，这些唯一的 ID 可能足以直接获取访问权限并调用你的 ML API 以接收你的预测。这如图*图 1**.3*所示：

![图 1.3 – 当唯一 ID 作为认证凭证有效时](img/B18416_01_3.jpg)

图 1.3 – 当唯一 ID 作为认证凭证有效时

例如，Azure 就是一个这样的例子。你可以传入一个唯一的 ID，在 Azure 术语中称为**订阅密钥**，以访问你的预测端点。

然而，大多数服务将要求你在调用 ML API 之前使用你的 ID 请求一个临时访问令牌。首先，你使用你的唯一凭证发送一个请求以接收一个临时访问令牌。然后，将这个临时令牌连同输入数据一起传递给你的 ML API 请求以获取你的预测结果。例如，AWS 将他们的唯一 ID 称为**访问密钥 ID**和**秘密访问密钥**。在 GCP 中，它们被称为**客户端 ID**和**客户端密钥**。AWS 和 GCP 都要求在 ML API 调用中传递一个临时访问令牌。

![图 1.4 – 两部分 API 调用：获取访问令牌和调用 ML API](img/B18416_01_4.jpg)

图 1.4 – 两部分 API 调用：获取访问令牌和调用 ML API

这种工作方式的具体方式因供应商而异。例如，一些供应商会让你将唯一 ID 作为查询参数提交，而另一些则要求你在请求头中提交。一些使用专有算法生成你的临时访问令牌（包括 AWS），而另一些则使用开放标准，如 OAuth2（包括 GCP）。

你需要查阅供应商的文档以获取具体细节。使用 DX 中预构建资产的主要好处之一是，认证逻辑通常已经为你处理！你所需要做的就是从 ML 提供者那里生成你的唯一凭证，并且（如果有的话）临时访问令牌处理逻辑也已经为你处理。

### JSON

JSON 是用于在 Web 服务之间交换数据的最流行的数据格式之一。几乎所有机器学习 Web API 都期望接收 JSON 作为输入数据，并返回 JSON 作为输出数据。当使用来自 DX 的 Web API 时，BP 的数据类型与 JSON 之间的几乎所有转换都将为您自动完成。

可能存在需要手动将 BP 数据转换为 JSON 的情况。这种情况最可能发生在“实用工具 – JSON”VBO 上，该 VBO 可在 BP 安装目录下的`VBO`子文件夹中找到。

以 JSON 格式发送文件需要您首先对其进行编码，通常使用 Base64 格式。BP 在 DX 上提供了三个 VBO 来帮助完成这项工作：`实用工具 – 编码解码`、`实用工具 – 文件操作`和`Base64Encoder`。

### 定价

MLaaS 提供的通常在达到一定限制内是免费的。使用免费限额后，您将开始按交易付费。这些限制通常每月重置。例如，让我们看看 Azure 的计算机视觉 API ([`azure.microsoft.com/en-us/pricing/details/cognitive-services/computer-vision/`](https://azure.microsoft.com/en-us/pricing/details/cognitive-services/computer-vision/))。在撰写本书时，它每月提供 5,000 次免费交易。对于接下来的 1,000,000 次交易，每次交易的费用是 10 美分。在 1 到 10 百万次交易之间，每次交易的费用是 6.5 美分。随着您每月交易次数的增加，每次交易的成本会降低。

定价取决于许多因素，例如您所在的地区、您在计算机视觉库中使用的特定服务，以及您是否愿意预先承诺使用最低数量的交易。

需要注意的是，*一次交易并不等同于一次 API 调用*！例如，可能有一种服务允许您一次性发送多个文档。每个文档可能被视为单独的交易，尽管它们是在一个 API 调用中提交的。魔鬼在于细节，因此在评估 MLaaS 提供是否适合您的用例时，您需要仔细查看定价页面。这代表了 IA 解决方案运营的持续成本，必须权衡其带来的好处。

### 单个与批量预测

在使用 API 之前，通过阅读其文档来理解 API 是非常重要的。在查看文档时需要注意的一个重要事项是，API 是否仅允许每个 API 请求进行一次预测，或者是否可以接受单个 API 调用中的批量多个输入。可能存在针对这两种情况的不同端点。

![图 1.5 – 批量预测](img/B18416_01_5.jpg)

图 1.5 – 批量预测

对于批处理预测，您将首先在单个请求中将多个预测的输入数据发送到 API 端点（*图 1.5*中的第一步）。预测将被执行（第二步），响应将返回所有预测结果（第三步）。在单次预测的情况下，每个 API 请求调用只能进行一次预测。

注意图中显示的“单个请求”和“单个响应”并不是单次与批量之间的特性；这是一个同步与异步的问题，将在下一节讨论。

### 同步与异步预测

单次与批量指的是在单个 API 调用中可以请求的预测数量。另一方面，同步与异步指的是预测结果是否在同一个 API 调用中作为请求返回。

对于同步（也称为**在线**）调用，预测结果在同一个请求中返回。这用于预测可以相对快速完成的情况，例如短文档和单张图片。*图 1.5*也显示了一个在线案例，其中响应在同一个 API 调用中返回。

对于异步（也称为**离线**）调用，您不会在同一个 API 调用中收到预测结果。相反，您将首先收到一个用于查询预测作业状态的唯一 ID。想象一下，如果您需要处理一个大的视频作为输入，ML 服务可能需要几分钟甚至几小时才能返回其预测。以下以 AWS 的 Rekognition Video API 为例：

![图 1.6 – AWS 的 Rekognition Video API：异步调用](img/B18416_01_6.jpg)

图 1.6 – AWS 的 Rekognition Video API：异步调用

首先，您通过提供一个视频的 S3 链接来创建一个预测的 API 请求。在这个第一个 API 调用中，您将收到一个`JobId`。对于第二个 API 调用，您将`JobId`传递给`GetLabelDetection`端点，该端点返回`JobStatus`。如果视频仍在处理中，您将收到`JobStatus`为`IN_PROGRESS`。

根据视频的大小，您可能需要等待几秒钟甚至几分钟，直到预测完成。在这段时间内，您可以继续调用`GetLabelDetection` API 端点来检查作业状态。当它完成时，JobStatus 将变为`SUCCEEDED`，并且预测的标签将与请求一起返回。

虽然“批处理”通常意味着异步，但这并不总是如此！单个预测可以是异步的（例如在 AWS Rekognition Video 示例中），而批处理预测可以是同步的（正如本章最后的一个示例所示）。

现在我们已经介绍了 ML Web API 的基础知识，让我们看看我们如何使用 DX 下载预构建的资产，并快速进行 ML 预测，而无需自己开发 ML 模型。

## DX 上 MLaaS 的概述

机器学习即服务（MLaaS）提供的产品，如 Azure、AWS、GCP 和 IBM 的产品，允许你快速将预训练的机器学习算法集成到业务流程（BP）中。你将能够使用智能自动化（IA）的机器学习部分，而无需处理机器学习生命周期中的复杂性，如训练、选择算法、调整、托管、维护等。然而，MLaaS 通常不太灵活，因为模型是预训练的，通常不能根据你的特定用例进行定制。这些服务中的大多数提供的是*通用*而不是*特定*的机器学习功能。

为了节省你搜索 DX 的时间，我已经整理并总结了目前最流行的机器学习即服务（MLaaS）提供的产品列表，按你打算提供给算法的输入数据类型进行分组。这将给你一个关于你可以快速简单地实现的智能自动化案例的感觉。输入数据类型被分类为**图像**、**视频**、**语音**和**文本**。

能够接受不同类型输入的多模态机器学习模型开始出现。GPT-4 就是这样一个例子，它可以接受文本和图像作为输入。这些模型在本节中不会涉及，因为它们在本书撰写期间尚未完全可用。

注意，数值数据并未列为输入项。数值输入通常用于回归问题，而且提供足够通用的机器学习模型以用于回归的服务并不多。如果你试图预测数值数据，你可能需要构建自己的机器学习模型。

从开发或概念验证的角度来看，大多数机器学习（ML）供应商提供其预测服务的慷慨免费使用层。这使你能够在短时间内评估是否值得追求特定的智能自动化（IA）项目。

在调查我的论文研究中的 122 个智能自动化（IA）用例时，我发现其中 75%有可能通过机器学习即服务（MLaaS）来实现，因此调查这些服务和数字化转型（DX）非常值得你的时间。基于文本的服务是最常见的，占所有智能自动化用例的 66%以上。

### 图像服务

图像服务可以提供关于图像中内容的洞察。这些服务中的大多数对可以提交给其服务的图像有具体要求。这可能包括文件大小要求、图像格式（PNG 和 JPG 是最常见的）、图像分辨率、最小和最大尺寸以及图像方向。

一些服务可能要求你将文件作为 API 请求体内容的一部分上传，而其他服务可能要求你首先将文件上传到某个地方，并提供图像的 URL。许多这些 API 提供*单次和批量操作*，通常是*同步的*，在同一个请求中返回检测到的标签和初始响应。

基于图像的机器学习服务仅占我发现的人工智能用例的 10%。这些类型服务的问题在于预测返回的通用对象不够具体，无法发挥作用。然而，许多这些服务也允许您自定义标签，这意味着您可以使用供应商的模型作为起点，进一步训练机器学习模型，以匹配您感兴趣寻找的内容。这正是许多潜在基于图像的使用案例得以解锁的地方。

预测完成后，您将获得以下信息：

+   图像中找到的标签列表

+   *X* 和 *Y* 坐标表示发现对象的边界

+   确信度分数显示对象属于特定标签的确定性程度

基于图像的服务及其潜在用例包括以下内容：

+   **对象检测**：这允许您在来自通用类别的图像中找到标签，例如动物、人、汽车、建筑物等。在许多情况下，这可以进一步定制，以检测*特定对象*，例如通过 AWS 的**DetectCustomLabels**和 Azure 的**Custom Vision**。一些现实生活中的人工智能用例包括在工厂中用于计数和查找产品缺陷以及分发处方药物的质量保证。

+   **面部及面部特征检测**：这预测图像中是否存在面部，以及面部显示的性别、估计年龄和整体情绪。这可以用于监控和处理包含照片的申请。我发现的唯一实现面部识别的人工智能用例是在在线学习课程中记录出勤和量化学生参与度。

+   **图像内容审查**：这允许我们确定图像是否包含成人或暴力主题。这通常用于社交媒体上的用户上传内容审查。我在人工智能中没有找到这个功能的实际用例。

+   **文本检测**：这返回图像中文字的位置和文字内容。这是最常见的基于图像的人工智能用例之一。

+   **表单检测**：这告诉我们图像中是否包含可提取的表单字段或表格。这对于人工智能来说具有通用性，可以用于处理发票、收据和财务报告数据。一个现实生活中的例子是从手写银行账户申请表扫描中提取数据。

|  | **DX 技能**的搜索词 |
| --- | --- |
| **功能** | **AWS** | **Azure** | **Google Cloud** | **IBM** |
| 对象检测 | Rekognition | 计算机视觉 | 云视觉 API，谷歌视觉技能 | IBM Watson 视觉识别技能 |
| 面部及面部特征检测 | Rekognition | 计算机视觉 | 云视觉 API，谷歌视觉技能 | IBM Watson 视觉识别技能 |
| 内容审查 | Rekognition | 计算机视觉 | 云视觉 API，谷歌视觉技能 | IBM Watson 视觉识别技能 |
| 文本检测 | Rekognition, Textract | 计算机视觉 | 云视觉 API，谷歌视觉技能 | IBM Watson 视觉识别技能 |
| 表单检测 | Textract | 表单识别客户端 | 云文档 AI | N/A* |

表 1.1 – DX 上基于图像的 ML 服务的搜索词

**从供应商处提供，但不在 DX 上，因此您必须自行构建** **web API**。

### 视频服务

以视频为输入的服务具有与图像服务类似的功能。它们允许在**几乎实时**的情况下分析视频。根据服务不同，您可能需要提供输入作为流 URL，或者上传您的视频文件到预指定的区域。

几乎实时是一个需要记住的关键点。大多数处理视频的 ML 服务都是**异步的**，不会立即给出预测结果。首先，您需要调用 API 请求预测。然后，您必须进行进一步的调用以检查预测是否准备就绪。

通常会对视频长度（3-6 小时）和文件大小（10-50 GB）的处理设置最大限制。这些限制因供应商而异。请检查他们的 API 文档，并遵循他们关于这些限制、分辨率、摄像机角度、视频比特率等方面的指南。在我的研究中，我没有找到任何使用视频作为输入源的用例。相反，可能更有意义的是在固定间隔（例如，每 5 秒）对视频进行快照，并使用基于图像的 ML 服务。

预测完成后，您将获得以下信息：

+   视频中找到的标签列表

+   表示发现对象边界的**X**和**Y**坐标

+   每个检测到的标签的开始和结束时间范围或时间戳

+   显示对象属于特定标签的置信度分数

基于图像的服务及其潜在用例包括以下内容：

+   **对象检测**：此功能可以用于检测通用标签，如动物、人、汽车、建筑物等。示例用例包括监控、无人机视频分析和质量保证。

+   **场景变化检测**：此功能用于检测视频流是否从一个摄像头切换到另一个摄像头。这可以用于视频编目、存档和剪辑。

+   **内容审核**：此功能预测视频是否包含成人或暴力主题。它通常用于社交媒体上的用户上传内容审核。

+   **标志检测**：此功能用于检测视频中的标志。它可以用于自动标记或检测视频中的品牌和标志，或用于监控用户提交的内容。

+   **人脸检测**：此功能用于检测视频中的人脸。它可以用于自动化设施访问控制、跟踪移动和监控。

+   **文本提取**：这用于从视频中提取文本。即使文本在视频的部分时间段被遮挡，这些服务也可以在摄像头移动足够覆盖整个文本的过程中重建完整的文本。这可以用于从现场活动提取演示文稿幻灯片内容。

|  | **DX 技能的搜索词** |
| --- | --- |
| **特性** | **AWS** | **Azure** | **Google Cloud** | **IBM** |
| 物体检测 | N/A* | N/A* | 云视频智能 | N/A |
| 场景变化 | N/A* | N/A* | 云视频智能 | N/A |
| 内容审核 | N/A* | N/A* | 云视频智能 | N/A |
| 标志检测 | N/A | N/A | 云视频智能 | N/A |
| 人脸检测 | N/A* | N/A* | 云视频智能 | N/A |
| 文本提取 | N/A* | N/A* | 云视频智能 | N/A |

表 1.2 - DX 上基于视频的机器学习服务的搜索词

***由供应商提供但不在 DX 上，因此您必须构建自己的** **Web API**。

### 语音服务

这些允许您从直播音频和保存的音频文件中提取数据。这可以是同步的，也可以是异步的，具体取决于音频的长度或文件的大小。通常，较短的文件会同步处理。

根据 API，供应商可能要求您直接将音频文件上传到机器学习端点或上传到云存储。他们还会对音频的长度和使用的语言有要求。在我的研究中，我没有找到任何使用语音作为输入的 IA 实现案例。

基于语音的机器学习服务的典型输出如下：

+   转录文本

+   转录文本的间隔时间戳

+   置信度分数

语音机器学习的常见功能和用例如下：

+   **语音转录**：这会将语音音频转换为文本。

+   **文本到语音**：这允许文本被大声朗读出来。

+   `购买`、`修改`或`取消``一张票`。

+   **说话人识别**：这有助于您识别不同的说话人。当将预测的说话人数目作为输入传递给算法时，效果最佳。它还会为每个说话人分配一个唯一的标识符。如果您已经知道说话人的身份，可以使用唯一标识符手动将音频映射回人类说话人。这可以用于自动添加包含说话人名字的子标题。

+   **语音翻译**：这允许您将音频转录成不同语言的文本。这也可以通过将语音转录服务链接到文本翻译服务来实现。

|  | **DX 技能的搜索词** |
| --- | --- |
| **特性** | **AWS** | **Azure** | **Google Cloud** | **IBM** |
| 语音转录 | Transcribe | 语音到文本 | 云语音到文本 API | N/A* |
| 文本到语音 | Polly | N/A* | 云文本到语音 | N/A* |
| 意图识别 | N/A* | N/A* | N/A* | N/A* |
| 说话人识别 | N/A* | Azure 说话人识别 Beta | N/A* | N/A* |
| 语音翻译 | N/A | N/A* | N/A | N/A |

表 1.3 – 在 DX 上基于视频的机器学习服务的搜索词

***由供应商提供但不在 DX 上，因此你必须构建自己的** **Web API**。

### 文本服务

基于文本的机器学习服务是目前人工智能中最常用的机器学习服务。在我发现的 122 个人工智能用例中，大约三分之二都是基于文本的，其中 52%的案例涉及使用翻译、**自然语言处理**（**NLP**）、**命名实体识别**（**NER**）、OCR 和文档分类，15%的用例使用聊天机器人作为触发人工智能的接口。

文本服务通常是**同步**的，并且根据服务不同，预测请求可以逐个发送或批量发送。基于文本的机器学习服务接收要分析的文本和语言作为输入参数。

从文本机器学习收到的典型输出如下：

+   预测标签

+   置信度分数

以下是一些常见的文本机器学习的使用方式：

+   **文档分类**：这允许你区分不同类型的文档。这通常会导致进一步的机器学习处理，例如实体识别。一个例子是发票处理。文档分类可以用来根据供应商对发票进行分类。另一个例子是将文档分为发票和采购订单，因为它们通常看起来很相似。

+   **实体识别**：这将从预定义的类别中提取文本，例如名称、日期、数字和事件。这可以用于对文本进行分类、过滤简历和从非结构化报告中提取数据。这是最受欢迎的使用案例之一，尤其是在处理发票、索赔和其他标准化表格时。许多供应商允许你自定义实体列表以匹配你的特定用例。

+   `我等了 45 分钟才轮到我`，关键短语可以是“等了”和“45 分钟”。

+   **情感分析**：这可以找到在一段文本中表达的高层次观点或态度。一些常见的返回标签包括*正面*、*中性*、*负面*和*混合*。大多数模型无法在同一标签下区分更细微的情感；例如，“兴奋”和“快乐”都会被返回为正面，尽管在现实中它们是不同的。这种方法的常见用途是对电子邮件或客户支持工单进行分类，以及在社交媒体和产品评论中检测情感。

+   **语言检测**：这通常在将文本发送到其他基于文本的机器学习算法之前作为第一步使用。

+   **翻译**：这可以在实时或按需将文本从一种语言翻译成另一种语言。所有供应商都支持超过 50 种语言。

+   **聊天机器人**：这些服务允许公司为其应用程序创建对话式界面。例如，一个政府机构使用聊天机器人作为人们请求社会保障福利的接口，这进一步触发了人工智能来完成处理。

+   **问答**：这是 LLMs 的主要功能之一。由于这项技术相对较新，我还没有遇到任何在 IA 中使用此技术的用例。

+   **文本生成**：这是由 LLMs 启动的一个相对较新的用例。这可以作为一种创建对用户投诉或电子邮件的回复的方式。

|  | **DX 技能的搜索词** |
| --- | --- |
| **功能** | **AWS** | **Azure** | **Google Cloud** | **IBM** |
| 文档分类 | N/A* | 形态识别客户端 | 自动机器学习自然语言，云自然语言 API | N/A |
| 实体识别 | AWS 的 Comprehend 功能 | 文本分析，OpenAI，ChatGPT | 自动机器学习自然语言，云自然语言 API | 语言理解 |
| 关键词提取 | AWS 的 Comprehend 功能 | 文本分析，OpenAI，ChatGPT | 云自然语言 API | 语言理解 |
| 情感分析 | AWS 的 Comprehend 功能 | 文本分析，OpenAI，ChatGPT | 自动机器学习自然语言，云自然语言 API | 语言理解 |
| 语言检测 | AWS 的 Comprehend 功能 | 文本分析，OpenAI，ChatGPT | 云自然语言 API | 语言理解 |
| 翻译 | AWS 的翻译功能 | Azure 云的翻译技能，OpenAI，ChatGPT | Google Cloud 的翻译技能 | IBM 的语言翻译技能 |
| 聊天机器人 | N/A* | QnAMaker，OpenAI，ChatGPT | N/A* | N/A* |
| 问答 | N/A | OpenAI，ChatGPT^ | N/A* | N/A |
| 文本生成 | N/A | OpenAI，ChatGPT^ | N/A* | N/A |

表 1.4 - DX 上基于视频的 ML 服务的搜索词

**从供应商处提供，但不在 DX 上，因此您必须自行构建** **web API**。

**^OpenAI 并非完全由微软拥有，尽管他们有一个** **强大的合作伙伴关系**。**

随着 GPT-4、Bard 和其他大型语言模型（LLM）的发布，发生了一些有趣的发展。这些模型天生具有执行文本翻译、实体提取、语言检测、情感分析等任务的能力，尽管它们并没有被明确训练来做这些事情。我预计，随着 LLM 的日益成熟，它们将成为许多基于文本和基于图像的机器学习 API 的可行替代品。

## 供应商选择

在上一节中，我们探讨了四个主要的机器学习即服务（MLaaS）供应商：AWS、Azure、GCP 和 IBM。选择其中一个而不是另一个的决定是复杂的，并且高度依赖于您公司可能已经存在的限制。选择标准可以包括以下内容：

+   在特定供应商处的现有偏好或折扣

+   在使用一个平台而不是另一个平台时，现有的组织或团队知识

+   只由一家供应商提供的必备服务

+   服务在理想地理位置的可用性

+   服务本身的成本

+   根据您的输入数据，服务的准确性

+   服务是否支持您期望的单个与批量或同步与异步处理

+   数据保留和安全策略

+   上线 SLA 和 API 使用限制

+   服务作为 DX 上的现成资产的可用性

在继续进行实际示例之前，让我们总结一下我们刚刚学到的内容。DX 是 BP 的“应用商店”，在这里可以找到许多连接到 ML 服务的连接器。这些连接器中的大多数都是使用 JSON 作为数据交换格式的 Web API。使用 ML Web 服务（如身份验证）和特定 API 要求的一些最具挑战性的部分已经包含在 DX 资产中，这使得您能够快速将 ML 集成到 BP 流程中。

接下来，我们研究了主要 ML 服务提供商（AWS、Azure、GCP 和 IBM）的 ML 的常见用例。每个供应商为其 ML 服务都有营销名称。仅根据其名称了解每个服务做什么并不直接。我已经根据它期望接收的输入类型（图像、视频、语音和文本）对所有的服务进行了分类。我还列出了它们的营销名称以及您可以在 DX 上使用的搜索词，如果它们存在的话。最后，我们研究了可能影响我们选择一个 ML 供应商而不是另一个供应商的一些因素。

# 示例

在本节中，我们将通过三个使用 Web API 进行 ML 预测的示例来演示。在前两个示例中，我们将从 DX 下载并使用两个不同的资产。在第三个示例中，我们将从头创建一个 Web API 服务。我们将使用每个主要供应商的一个 Web API：AWS、Azure 和 GCP。这些示例将需要您注册免费账户以使用他们的服务。如果您没有每个供应商的账户，请跟随您有账户的供应商进行操作。

从 AWS，我们将使用 Comprehend 对电子邮件服务请求进行文本分析。使用 Azure，我们将使用表单识别器从发票中提取数据。最后，从 GCP，我们将使用 Cloud Vision API 从基于图像的 PDF 中提取文本。这三个服务被选中是因为它们是最受欢迎的 ML 服务供应商，具有不同的身份验证方法，并且涵盖了在 IA 中遇到的最常见的用例，包括处理文本数据、表格和图像。

使 Web API 正常工作的最具挑战性的部分如下：

+   **身份验证**：这部分是在 MLaaS 供应商门户上完成的，以生成正确的密钥。另一部分是将这些密钥输入 BP 的正确部分，通常是凭证。DX 资产的文档将指导您如何进行此操作。

+   **格式化输入数据**：这通常需要阅读 API 的文档，但这是由 Web API 服务或对象提供的。

+   **格式化输出数据**：这通常需要阅读 API 的文档，但这是由 Web API 服务或对象提供的。

我们将要讨论的三个示例以及它们之间的差异总结在下表中：

| **服务** | **BP 中 API 的实现** | **身份验证** | **批量/单次** | **同步/异步** | **用例** |
| --- | --- | --- | --- | --- | --- |
| AWS Comprehend | 对象 + 网页 API | 暂时访问令牌（对象）+ 访问密钥 ID + 密钥 | 单个 | 同步 | 从支持票文提取实体 |
| Azure 表单识别器 | 对象 + HTTP 和 JSON VBOs | 单个订阅密钥 | 单个 | 异步 | 从数字发票中提取数据 |
| GCP 云视觉 | 自定义构建的 Web API 服务 | 暂时访问令牌（OAuth2）+ 客户端 ID + 客户端密钥 | 批量 | 同步 | 从图像中提取文本 |

表 1.5 – 我们将经历的三个示例的摘要

## 示例 1 – AWS Comprehend 用于文本实体提取、关键短语提取和情感分析

AWS Comprehend 是一种机器学习服务，可以从文本中提取信息并理解数据。在本例中，我们将使用 Comprehend 对电子邮件支持案例进行分类。与通过网页表单或聊天机器人提交支持请求不同，你可以要求用户为你分类问题，直接通过电子邮件发送的问题分类必须手动完成、通过规则或通过机器学习来完成。

在 Comprehend 中，你可以构建一个自定义模型来直接将文本分类到所需的类别，但这超出了本例的范围。相反，我们将使用 AWS 预构建的模型来提取支持请求中的实体、关键短语和情感。即使没有自定义模型，这些预构建模型的预测对客户支持代理仍然很有用。本例中使用的支持请求如下：

我写信请求帮助我的 iPhone 14，它的屏幕已经破裂。我的客户 ID 是 abcd@email.com。我非常感谢您帮助解决这个问题。我明白该设备可能由保修或保险计划覆盖，并且我想探索所有可用的维修或更换手机的选择。如果可能的话，您能否提供有关我应采取的下一步来启动维修或更换请求的信息？此外，请告知此过程中是否有任何费用。

Comprehend 目前每月每个 API 提供免费使用额度为 500 万字符。DX 资产提供的操作在 *单* 和 *同步* 模式下运行。

AWS 网页 API 使用专有算法来实现刷新令牌身份验证。一旦你导入了 DX 资产，你会注意到既有 Web API 服务又有对象。对象的主要目的是作为实现自定义身份验证的网页 API 的包装器。在本例中，我们将执行四个高级步骤：

1.  从 DX 下载资产

1.  将资产导入 BP

1.  配置 BP 凭证

1.  通过进行机器学习预测来测试 DX API 资产

### 从 DX 下载

在此步骤中，我们将访问 DX ([`digitalexchange.blueprism.com/dx/search`](https://digitalexchange.blueprism.com/dx/search)) 以搜索和下载 AWS Comprehend 资产：

1.  访问 DX 并在搜索栏中输入 `comprehend capability aws`（大小写不敏感）。搜索并点击结果中的 **Comprehend Capability AWS** **云** 资产。

1.  点击屏幕右侧的绿色下载按钮，并将 `.bprelease` 资产保存到您的计算机上。如果您尚未登录，DX 网站将要求您登录。此 `.bprelease` 包含一个网络 API、一个对象和一个凭证。

1.  在 **Comprehend Capability AWS Cloud 连接器** 页面上继续向下滚动并下载 **AWS Comprehend** **用户指南**。

![图 1.7 – 下载资产和 AWS Comprehend 用户指南](img/B18416_01_7.jpg)

图 1.7 – 下载资产和 AWS Comprehend 用户指南

重要提示

AWS Comprehend 用户指南提供了如何设置您的 AWS 账户以允许从 BP 进行 API 调用的链接和详细信息。请按照用户指南中的步骤正确设置您的 AWS 账户和身份验证详细信息。我们不会在这里介绍设置 AWS 账户的步骤。

### 将 Comprehend 资产导入到 BP 中

让我们将下载的资产导入到 BP 中并检查导入的内容：

1.  打开 BP 并登录。点击 **文件** | **导入** | **发布 / 技能**。导入 AWS Comprehend 发布。导入时接受所有默认设置。

1.  验证 `.bprelease` 是否已成功导入到 BP 中。应该有一个对象、一个网络 API 服务和一个凭证。对象可以在 BP 的 **工作室** 部分找到。

![图 1.8 – 在工作室部分找到对象](img/B18416_01_8.jpg)

图 1.8 – 在工作室部分找到对象

1.  在 **系统** | **对象** | **网络** **API 服务** 下找到 Comprehend 网络 API。

![图 1.9 – 在系统 | 对象 | 网络 API 服务下找到 AWS: Comprehend](img/B18416_01_9.jpg)

图 1.9 – 在系统 | 对象 | 网络 API 服务下找到 AWS: Comprehend

1.  在 **系统** | **安全** | **凭证** 下找到凭证。

![图 1.10 – 在系统 | 安全 | 凭证下找到 AWS 凭证](img/B18416_01_10.jpg)

图 1.10 – 在系统 | 安全 | 凭证下找到 AWS 凭证

### 配置 AWS 凭证

在此步骤中，我们将导入 `AWS` 凭证（如果您还没有创建这些凭证，请查看下载的用户指南）到 BP 中。然后，我们将设置凭证的权限，以便我们可以在流程中测试它：

1.  将您的 AWS 访问密钥 ID 复制到 `AWS` 凭证中。将您的秘密访问密钥复制到两个 **密码** 字段中。

![图 1.11 – 输入 AWS 访问密钥 ID 和秘密访问密钥](img/B18416_01_11.jpg)

图 1.11 – 输入 AWS 访问密钥 ID 和秘密访问密钥

1.  在凭证的 **访问权限** 选项卡上，将 **安全角色** 设置为 **所有角色**，**流程（旧版）** 设置为 **所有流程**，**资源（旧版）** 设置为 **所有资源**。虽然这不是最佳实践，但我们只为测试目的这样做。

### 测试 AWS Comprehend 对象

最后，让我们测试 DX 资产并做出预测！注意在测试流程中，操作使用的是**对象**而不是 Web API 服务。直接使用 Web API 服务不会工作，因为它不包含身份验证部分。请按照以下步骤操作：

1.  在 Process Studio 的`Ch1`组中打开“示例 1 - 测试 AWS Comprehend”流程。此流程还需要导入“Utility – General”VBO。这可以在 BP 安装目录下的`VBO`子文件夹中找到。

1.  在 Process Studio 中运行流程。此流程执行三个 API 调用：1）检测实体，2）查找关键词，3）检测情感。如果成功，**预测**块中的“主页面”上的三个集合将被填充。

![图 1.12 – 来自三个 API 调用的三个预测集合](img/B18416_01_12.jpg)

图 1.12 – 来自三个 API 调用的三个预测集合

查看“实体响应”集合显示 AWS 的通用模型可以提取电子邮件和电话型号：

![图 1.13 – 将电话型号和客户 ID 提取为实体](img/B18416_01_13.jpg)

图 1.13 – 将电话型号和客户 ID 提取为实体

即使没有自定义模型来将电子邮件分类到精确标签，Comprehend 的预训练模型也能提取高级信息，这可以简化客户支持代理的工作。我们还看到预测结果带有**分数**。这个置信度分数将作为本书第二部分 IA 解决方案的设计元素。

在本例中，我们使用了 AWS Comprehend 从非结构化文本中提取数据。由于 AWS 使用自定义身份验证方案，DX 资产包含一个 Web API 服务和一个对象。通常处理身份验证是复杂的，但对象为我们处理了一切。导入资产后，我们只需设置凭据即可使一切工作。这就是将 BP 与 AWS 的 Comprehend API 连接起来的简便方法。

让我们继续到下一个示例，该示例使用 Azure。

## 示例 2 – Azure 表单识别器用于发票提取

Azure 的表单识别器包含预构建的模型，允许您从收据、发票、税务表格、名片和通用文档中提取数据。以可用的格式从发票和收据中提取数据*是一个非常常见的 IA 用例*。如此常见，以至于 BP 和大多数其他 RPA 供应商都有专门针对发票提取的产品。有关 BP 文档提取产品 Decipher 的更多信息，请参阅本书最后一章。Form Recognizer 提供免费定价层以供测试。

本例中使用的发票可以在此处下载以供参考：[`github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/ex2_invoice.pdf`](https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/ex2_invoice.pdf)

这个 PDF 直接嵌入到本例的流程中作为二进制数据项，因此下载它是可选的。

你也可以在表单识别器内部构建自定义模型来识别你特定的文档类型，例如银行或信用卡对账单。这些自定义模型可以为你的业务解锁更多用例，并且可以通过本例中使用的 DX 资产由 BP 调用。

除了 API 的目的之外，这个 Azure API 与 AWS Comprehend 有两个主要区别。第一个区别是使用的**认证**方案。对于 Azure，我们只需要在每个请求中传递一个订阅密钥。这比 AWS 简单，AWS 需要单独的对象来刷新临时访问令牌。与 AWS Comprehend 不同，表单识别器的调用是**异步的**，需要你反复检查预测是否完成。

表单识别器的 DX 资产存储为`.bprelease`文件，包含一个 BP 对象。这与 DX 上大多数其他打包为`.bpskill`文件并在 BP 的**系统** | **对象** | **Web API 服务**部分显示的 Web API 不同。

表单识别器被选为示例之一，因为表单处理也是主要的人工智能应用案例之一。表单识别器的 DX 资产还展示了实现 Web API 连接器的一种不同方式——直接作为对象使用 HTTP 和 JSON VBO，而不是 Web API 服务。作为对象实现允许运行旧版本 BP（< V6.4）的公司调用 Web API。

在本例中，我们将执行四个高级步骤：

1.  从 GitHub（或 DX）下载资产

1.  将资产导入 BP

1.  配置表单识别器对象

1.  通过进行预测来测试 API 调用

### 从 DX 下载

重要提示

微软自 DX 上的表单识别器资产发布以来已经更改了 URL 端点。因此，DX 上的资产如果不更改其中的 URL 将无法工作。已经修改的版本可以在[`github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/Ex_2_Azure_Form_Recognizer_Client_Service.bprelease`](https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/Ex_2_Azure_Form_Recognizer_Client_Service.bprelease)找到。我建议下载这个 GitHub 版本，而不是 DX 上的版本。

虽然我们不会从 DX 下载资产，但我们仍然需要下载文档，以便配置 Azure API。在这里，我们将访问 DX ([`digitalexchange.blueprism.com/dx/search`](https://digitalexchange.blueprism.com/dx/search))以下载文档：

1.  在 DX 搜索栏中输入`form recognizer client`（大小写不敏感）进行搜索。点击**表单识别器** **客户端**资产。

1.  在**表单识别器客户端连接器 – 1.0.0**页面向下滚动并下载**用户指南**。

![图 1.14 – 下载资产和用户指南](img/B18416_01_14.jpg)

图 1.14 – 下载资产和用户指南

重要提示

用户指南提供了如何设置 Azure 账户以允许从 BP 进行 API 调用的详细信息。请按照指南中的步骤正确设置 Azure。指南还列出了两个必须导入到 BP 中的其他 VBO：`Utility - JSON` 和 `Utility – HTTP` VBO。这两个都包含在之前的 GitHub 链接中。如果您希望单独下载它们，它们也可以从 DX 获取。

### 导入到 BP

下载资产后，必须将其导入到 BP 中。这一步骤无论您是从 DX 还是 GitHub 下载资产都是相同的：

1.  打开 BP 并登录。点击 **文件** | **导入** | **发布 / 技能** 并导入资产。

1.  验证 `表单识别客户端服务` 对象是否存在。还要验证 HTTP 和 JSON VBO 的正确版本是否存在，这是用户指南所要求的。

![图 1.15 – 验证三个对象是否存在](img/B18416_01_15.jpg)

图 1.15 – 验证三个对象是否存在

### 配置表单识别客户端服务对象

DX 资产的作者选择将身份验证 ID 作为对象中的数据项存储。这 **不是最佳实践**，因为这些应该作为凭据存储。但由于对象就是这样设计的，让我们编辑这些数据项以配置连接到 Web API 所需要的身份验证详细信息。如果您没有订阅密钥，请按照资产文档创建一个。

重要提示

配置对象所需的访问令牌和基础 URL 可以从 Azure 网站的 **表单识别** 页面获取。*图 1.15* 中显示的用户指南提供了更多关于如何找到此页面的详细信息。

1.  在对象工作室中打开 `表单识别客户端服务` 对象。在 `访问令牌` 集合和需要填写的数据项 `基础 URL` 上。

![图 1.16 – 在初始化页面填写访问令牌和基础 URL](img/B18416_01_16.jpg)

图 1.16 – 在初始化页面填写访问令牌和基础 URL

1.  打开 `访问令牌` 集合并点击 **初始值** 选项卡。在 **Ocp-Apim-Subscription-Key** 字段中填写您的订阅密钥并保存。

![图 1.17 – 将订阅密钥填写到访问令牌中](img/B18416_01_17.jpg)

图 1.17 – 将订阅密钥填写到访问令牌中

1.  打开 `基础 URL` 数据项并将 **初始值** 设置为 Azure 网站上的端点 URL。不要在 URL 末尾包含尾部斜杠。

![图 1.18 – 在没有尾部斜杠的情况下填写基础 URL](img/B18416_01_18.jpg)

图 1.18 – 在没有尾部斜杠的情况下填写基础 URL

现在我们已经配置了 Azure 对象，我们可以对其进行测试。

### 测试表单识别客户端服务对象

在章节开头“技术要求”部分导入的发布文件中包含了一个测试流程。此流程需要导入 `Utility – General` 和 `Utility – File Management`。这两个都可以在安装文件夹的 `VBO` 子文件夹中找到。

1.  在 Process Studio 的 `Ch1` 组中打开 `示例 2 – 测试 Azure 表单识别器客户端服务` 流程。

1.  在 Process Studio 中运行流程。此流程至少进行两次 API 调用。第一次调用将发票文件发送到请求处理。这会返回一个 **结果 ID**。第二次 API 调用通过引用 **结果 ID** 检查最多六次是否完成了 **异步** 机器学习预测。当预测完成时，**预测** 块中的集合和数据项将变得充实。您可以验证提取的内容与实际的 PDF 文档非常接近。

![图 1.19 – Azure 发票表单识别器的预测结果](img/B18416_01_19.jpg)

图 1.19 – Azure 发票表单识别器的预测结果

现在我们已经看到了两个示例，涉及两种不同类型的 Web API 身份验证，以及同步和异步 API 调用案例。在本章的最后一个示例中，我们将从头开始创建一个用于 GCP 批量 PDF 处理的 Web API 服务。

## 示例 3 – GCP 云视觉批量 OCR 处理

Google Cloud 的 Cloud Vision 允许您从图像中提取标签和文本。在 IA 中，这最常用于基于图像文本的 OCR，例如文档和收据的照片。如果文档被扫描，GCP 建议使用其 Document AI 服务。在本例中，我们将从带有少量手写的基于图像的 PDF 中提取文本。我们还将展示一个同步批量案例，其中一次处理基于图像文档的五页 PDF，并收到这五页的预测结果。

本例中使用的开源 PDF 文档可以在 [`github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/ex3_pdf.pdf`](https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/blob/main/ch1/ex3_pdf.pdf) 找到。此 PDF 已经作为二进制数据项嵌入到测试流程中，因此下载它是可选的。

GCP 使用 OAuth2 进行身份验证，这同样是一种临时访问令牌方法，类似于 AWS Comprehend 在第一个示例中所做的那样。OAuth2 和 AWS 方法之间的区别在于 AWS 的身份验证是专有的。OAuth2 是许多厂商采用的开放标准，BP 的 Web API 服务功能可以直接处理它。与 AWS Comprehend 的情况不同，不需要对象包装器。

在这个第三个示例中，我们将从头开始构建一个 Web API。我们将使用的 API 端点没有 DX 资产。从头开始构建 Web API 所需的关键技能是能够仔细阅读和理解供应商的 API 文档。GCP 的 API 文档的相关部分将与 BP Web API 服务的配置并排显示，以供参考。

与前两个示例相比，本例的步骤非常不同。从高层次上讲，我们将执行以下四个步骤：

1.  访问 GCP 网站以设置 API 认证所需的密钥

1.  将 API 认证密钥保存到凭证中

1.  在 BP 中创建 Web API 服务

1.  通过进行预测来测试 Web API

### 设置服务帐户和密钥

本节包含在 GCP 网站上执行的操作步骤。目的是生成可以下载并在 BP Web API 服务内部使用的认证凭证。如果这些步骤过时了，请使用*步骤 1*中的链接作为参考：

1.  访问[`cloud.google.com/iam/docs/service-accounts-create#creating_a_service_account`](https://cloud.google.com/iam/docs/service-accounts-create#creating_a_service_account)并按照说明创建您的服务帐户。确保您的服务帐户有权访问*Vision API*。

1.  在**IAM & Admin**的**服务帐户**部分下，点击**密钥**选项卡，然后点击**添加密钥**：

![图 1.20 – 为您的服务帐户创建密钥](img/B18416_01_20.jpg)

图 1.20 – 为您的服务帐户创建密钥

1.  选择**JSON**作为**密钥类型**并按**创建**：

![图 1.21 – 创建 JSON 密钥](img/B18416_01_21.jpg)

图 1.21 – 创建 JSON 密钥

1.  在按**创建**后下载出现的 JSON 文件。

### 将服务帐户电子邮件和私钥保存为凭证

我们已创建认证凭证并以 JSON 格式下载。现在我们需要将相关信息保存到 BP 凭证中：

1.  在任何文本编辑器中打开 JSON 文件。您会看到一个`private_key`行。将两个双引号之间的所有内容复制到您的剪贴板。这在 GCP 文档中被称为**客户端密钥**。

    ```py
    "type": "service_account",
    "project_id": "project_id_here",
    "private_key_id": "abcdefg",
    "private_key": "-----BEGIN PRIVATE KEY-----\n
    PRIVATE KEY HERE
    \n-----END PRIVATE KEY-----\n",
    ```

1.  在 BP 中访问**系统** | **安全** | **凭证**。点击**新建**以创建新的凭证。

1.  设置`GCP Cloud Vision`。将**类型**设置为**OAuth 2.0 (JWT Bearer Token**)。将**发行者**设置为服务帐户电子邮件地址，对于**私钥**，粘贴在*步骤 1*中复制的部分：

![图 1.22 – 使用 GCP 门户信息保存凭证](img/B18416_01_22.jpg)

图 1.22 – 使用 GCP 门户信息保存凭证

1.  点击凭据的**访问权限**选项卡。将**安全角色**设置为**所有角色**，**进程（旧版）**设置为**所有进程**，**资源（旧版）**设置为**所有资源**。虽然这不是最佳实践，但我们只是在测试，并没有将任何东西部署到生产环境中。保存凭据。

### 创建 Web API 服务

在这里，我们将从头开始创建一个 Web API 服务。在这次练习中，将频繁查阅 Google 的 API 文档（[`cloud.google.com/vision/docs/file-small-batch`](https://cloud.google.com/vision/docs/file-small-batch)）。

在从头开始构建一个 Web API 时，一个需要考虑的关键提示是查看供应商是否已经在 DX 上提供了一种*不同的*服务。如果是这样，请下载它，导入它，并将其用作参考。每个供应商都试图保持其 API 的内部一致性。在一个供应商内部，它们的 API 可能使用相同的认证方法，并且它们的输入和输出具有相似的 JSON 结构。你很可能会将一个工作的 Web API 服务的一部分复制到自己的 API 中！

1.  访问**系统**|**对象**|**Web API 服务**。点击**添加服务**。

1.  设置`Google Cloud Vision Batch Annotation Online`。这是一个任意名称，它将作为一个可选择的选项出现在动作阶段。将**基本 URL**设置为[`vision.googleapis.com/`](https://vision.googleapis.com/)，包括尾随斜杠。在这个步骤结束时，你的 Web API 应该看起来像这样：

![图 1.23 – 设置名称和基本 URL](img/B18416_01_23.jpg)

图 1.23 – 设置名称和基本 URL

基本 URL 取自 GCP 的文档：

![图 1.24 – GCP 文档中的基本 URL](img/B18416_01_24.jpg)

图 1.24 – GCP 文档中的基本 URL

1.  点击`Content-Type`和`application/json; charset=utf-8`。**公共头信息**部分应该看起来像这样：

![图 1.25 – 设置公共头信息](img/B18416_01_25.jpg)

图 1.25 – 设置公共头信息

这些公共头信息来自 GCP 文档中显示的示例 API 请求：

![图 1.26 – GCP 文档中的头信息（其他头信息可以忽略）](img/B18416_01_26.jpg)

图 1.26 – GCP 文档中的头信息（其他头信息可以忽略）

1.  点击`GCP Cloud Vision`，这是在*步骤 2*中*保存服务账户电子邮件和私钥作为凭据*部分创建的。取消选中**暴露给****进程**框。

重要提示

令牌端点数据来自[`accounts.google.com/.well-known/openid-configuration`](https://accounts.google.com/.well-known/openid-configuration)，作用域端点来自[`developers.google.com/oauthplayground`](https://developers.google.com/oauthplayground)。

**公共认证**部分应该看起来像这样：

![图 1.27 – 设置公共认证](img/B18416_01_27.jpg)

图 1.27 – 设置公共认证

1.  点击 `Annotate Batch`。这是将在 BP 中作为可选项目出现的操作名称。每个操作相当于一个 Web API 端点。完成此步骤后，您的 **操作** 部分应如下所示：

![图 1.28 – 创建操作](img/B18416_01_28.jpg)

图 1.28 – 创建操作

1.  点击 `mimeType`、`pages` 和 `content`。将 **初始值** 留空，并为所有三个选项勾选 **暴露**。完成此步骤后，您的 **参数** 部分应如下所示：

![图 1.29 – 设置操作参数](img/B18416_01_29.jpg)

图 1.29 – 设置操作参数

这三个参数是从 GCP 请求 JSON 主体中期望接收的示例中提取的。我们将这些作为 Web API 的输入参数公开，以便它们可以根据流程的需求传递和更改。

![图 1.30 – GCP 文档的参数](img/B18416_01_30.jpg)

图 1.30 – GCP 文档的参数

1.  点击 `/v1/files:annotate`，将 **Body Content** 转换为 **模板**。在 **模板** 文本框中，输入以下内容：

    ```py
    {
      "requests": [[
        {
          "inputConfig": {
            "content": "[content]",
            "mimeType": "[mimeType]"
          },
          "features": [[
            {
              "type": "DOCUMENT_TEXT_DETECTION"
            },
            {
              "type": "LABEL_DETECTION"
            }
          ],
          "pages": [[
            [pages]
          ]
        }
      ]
    }
    ```

    注意，我们使用 `[parameter name]` 将参数插入到模板中，类似于 BP 数据项。在 `[` 的一些区域。这就是我们如何转义开方括号字符的方法。我们还 *硬编码* 提取类型为 `DOCUMENT_TEXT_DETECTION` 和 `LABEL_DETECTION`。

    本节所做的操作是设置将发送到 API 端点的确切 JSON 结构。我们希望这个结构与 *图 1.30* 完全匹配。完成此步骤后，**请求** 部分应如下所示：

![图 1.31 – 设置请求图 1.31 – 设置请求 1.  点击 `responses`、`$.responses`。这部分定义了 Web API 将作为输出参数发送给操作的什么内容。在我们的例子中，我们只是将整个 JSON 响应保存为一个集合。完成此步骤后，您的 **响应** 配置应如下所示：![图 1.32 – 设置响应](img/B18416_01_32.jpg)

图 1.32 – 设置响应

1.  我们的单个输出 `responses` 集合相当于 GCP 文档样本响应输出中突出显示的项目：

![图 1.33 – GCP 文档的响应](img/B18416_01_33.jpg)

图 1.33 – GCP 文档的响应

1.  保存 Web API 服务。

现在我们已经完成了新 Web API 的设置。让我们用一个流程来测试它。

### 测试批处理图像 Web API 服务

样本流程应已从 *技术要求* 部分导入。我们还需要导入一个额外的 VBO 来将我们的 PDF 文件转换为 Base64 格式，这是 GCP 视觉 API 的要求：

1.  从 DX 中下载并导入`Utility – File Manipulation`资产，链接为[`digitalexchange.blueprism.com/dx/entry/9648/solution/utility---file-manipulation`](https://digitalexchange.blueprism.com/dx/entry/9648/solution/utility---file-manipulation)。这个工具用于将 PDF 文件转换为 Base64 格式。

1.  在流程工作室的`Ch1`组中打开`Example 3 – Test GCP Batch PDF`流程。

1.  在流程工作室中运行流程。此流程进行一次 API 调用，批量处理五个 PDF 页面。该调用是同步的，因为五个页面的预测在同一个请求中返回。一旦成功，**预测**块中的集合和数据项将变得完整：

![图 1.34 – 新创建的 Web API 的预测](img/B18416_01_34.jpg)

图 1.34 – 新创建的 Web API 的预测

在这个第三个示例中，我们查看了一个从文档中提取文本的批处理/同步处理案例。我们还从头开始构建了一个使用 OAuth2 认证的 Web API 服务。这是一个将现有 API 信息输入 BP 的 Web API 服务正确部分的练习。在示例流程中，我们还使用了 Base64 对 PDF 文件进行编码，以便在 API 请求体中以纯文本形式发送。

# 摘要

在本章中，我们讨论了 DX 以及如何下载 Web API 连接器以极大地加快我们的开发时间。当使用 Web API 时，人们经常遇到的问题包括认证以及根据供应商的 API 文档正确映射输入和输出 JSON 数据。

ML web API 在两个影响 IA 解决方案设计的领域也有所不同。这些是单次与批量以及同步与异步预测。我们将在本书的后面重新讨论这些特性。

接下来，我们考察了四个主要的 MLaaS 供应商：AWS、Azure、GCP 和 IBM。我们探讨了他们在 DX 上提供的 ML web API。每个供应商都为其服务使用营销名称，掩盖了这些服务实际上做什么。我已经将营销名称背后的服务进行了分组和总结，提供了你可以在 DX 上搜索它们的搜索词，并给出了它们可以满足的用例的想法。

最后，我们通过三个实际操作示例进行了学习。我们选择了不同的供应商、API 实现方法、认证方法和用例，以覆盖你将在现实生活中遇到的大部分场景。在我的研究过程中，我发现的大多数实际生活中的 IA 示例都与文本处理有关。我们的示例展示了三种不同的 IA 文本案例：从*非结构化文本*中提取数据、从*表格*中提取数据以及从*图像*中提取文本。

在下一章中，我们将不再从 Web API 调用 ML 预测，而是更多地探讨 BP 如何直接从 Digital Worker 的命令行界面调用模型。
