<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Case Study &#x2013; Building Your Own Recommendation Engine"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Case Study – Building Your Own Recommendation Engine</h1></div></div></div><p>The previous two chapters showed how you how to build, test, and optimize recommender systems using R. Although the chapters were full of examples, they were based on datasets provided by an R package. The data was structured using redyal and was ready to be processed. However, in real life, the data preparation is an important, time-consuming, and tough step.</p><p>Another limitation of the previous examples is that they are based on the ratings only. In most of the situations, there are other data sources such as item descriptions and user profiles. A good solution comes from a combination of all the relevant information.</p><p>This chapter shows a practical example in which we will build and optimize a recommender system, starting from raw data. This chapter will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Preparing the data to build a recommendation engine</li><li class="listitem" style="list-style-type: disc">Exploring the data through visualization techniques</li><li class="listitem" style="list-style-type: disc">Choosing and building a recommendation model</li><li class="listitem" style="list-style-type: disc">Optimizing the performance of the recommendation model by setting its parameters</li></ul></div><p>In the end, we will build an engine that generates recommendations.</p><div class="section" title="Preparing the data"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Preparing the data</h1></div></div></div><p>Starting from<a class="indexterm" id="id219"/> raw data, this section will show you how to prepare the input for the recommendation models.</p><div class="section" title="Description of the data"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec45"/>Description of the data</h2></div></div></div><p>The data is about<a class="indexterm" id="id220"/> Microsoft users visiting a website during one week. For each user, the data displays which areas the users visited. For the sake of simplicity, from now on we will refer to the website areas with the term "items".</p><p>There are 5,000 users and they are represented by sequential numbers between 10,001 and 15,000. Items are represented by numbers between 1,000 and 1,297, even if they are less than 298.</p><p>The dataset is an unstructured text file. Each record contains a number of fields between 2 and 6. The first field is a letter defining what the record contains. There are three main types of records, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Attribute (A)</strong></span>: This is the <a class="indexterm" id="id221"/>description of the website area</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Case (C)</strong></span>: This is the case for each user, containing its ID</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Vote (V)</strong></span>: This is the vote lines for the case</li></ul></div><p>Each case record is followed by one or more votes, and there is just one case for each user.</p><p>Our target is to recommend each user to explore some areas of the website that they haven't explored yet.</p></div><div class="section" title="Importing the data"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec46"/>Importing the data</h2></div></div></div><p>This section<a class="indexterm" id="id222"/> will show you how to import data. First, let's load the packages that we will use:</p><div class="informalexample"><pre class="programlisting">library("data.table")
library("ggplot2")
library("recommenderlab")
library("countrycode")</pre></div><p>The preceding code is explained in the following points:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">data.table</code>: This manipulates the data</li><li class="listitem" style="list-style-type: disc"><code class="literal">ggplot2</code>: This builds charts</li><li class="listitem" style="list-style-type: disc"><code class="literal">recommenderlab</code>: This builds recommendation engines</li><li class="listitem" style="list-style-type: disc"><code class="literal">countrycode</code>: This package contains the country names</li></ul></div><p>Then, let's load the table into memory. If the text file is already in our working directory, it's enough to define its name. Otherwise, we need to define its full path:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>file_in &lt;- "anonymous-msweb.test.txt"</strong></span>
</pre></div><p>The rows contain different numbers of columns, which means that the data is unstructured. However, there are at most six columns, so we can load the file into a table using <code class="literal">read.csv</code>. The rows with fewer than six fields will have just empty values:</p><div class="informalexample"><pre class="programlisting">table_in &lt;- read.csv(file_in, header = FALSE)
head(table_in)</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>V1</p>
</th><th style="text-align: left" valign="bottom">
<p>V2</p>
</th><th style="text-align: left" valign="bottom">
<p>V3</p>
</th><th style="text-align: left" valign="bottom">
<p>V4</p>
</th><th style="text-align: left" valign="bottom">
<p>V5</p>
</th><th style="text-align: left" valign="bottom">
<p>V6</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">I</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">4</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">www.microsoft.com</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">created by getlog.pl</code></p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">T</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">VRoot</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">VRoot</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">N</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">N</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">T</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Hide1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Hide</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">N</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0</code></p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr></tbody></table></div><p>The first two columns contain the user IDs and their purchases. We can just drop the other columns:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_users &lt;- table_in[, 1:2]</strong></span>
</pre></div><p>In order to process the data more easily, we can convert it into a data table, using this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_users &lt;- data.table(table_users)</strong></span>
</pre></div><p>The columns <a class="indexterm" id="id223"/>are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">category</code>: This is a letter specifying the content of the column. The columns containing a user or an item ID belong to the categories C and V, respectively.</li><li class="listitem" style="list-style-type: disc"><code class="literal">value</code>: This is a number specifying the user or item ID.</li></ul></div><p>We can assign the column names and select the rows containing either users or items:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>setnames(table_users, 1:2, c("category", "value"))</strong></span>
<span class="strong"><strong>table_users &lt;- table_users[category %in% c("C", "V")]</strong></span>
<span class="strong"><strong>head(table_users)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>category</p>
</th><th style="text-align: left" valign="bottom">
<p>value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">C</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10001</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1038</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1026</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1034</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">C</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10002</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1008</code></p>
</td></tr></tbody></table></div><p>The <code class="literal">table_users</code> object contains structured data, which is our starting point to define a rating matrix.</p></div><div class="section" title="Defining a rating matrix"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec47"/>Defining a rating matrix</h2></div></div></div><p>Our target is to <a class="indexterm" id="id224"/>define a table having a row for each item and a column for each purchase. For each user, <code class="literal">table_users</code> contains its ID and purchases in separate rows. In each block or rows, the first column contains the user ID and the other contains the item IDs.</p><p>You can use the following steps to define a rating matrix:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Label the cases.</li><li class="listitem">Define a table in the long format.</li><li class="listitem">Define a table in the wide format.</li><li class="listitem">Define the rating matrix.</li></ol></div><p>In order to reshape the table, the first step is to define a field called <code class="literal">chunk_user</code> containing an incremental number for each user. The <code class="literal">category == "C"</code> condition is true for the user rows, which are the first rows of the chunks. Using <code class="literal">cumsum</code>, we are incrementing the index of 1 whenever there is a row with a new user:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_users[, chunk_user := cumsum(category == "C")]</strong></span>
<span class="strong"><strong>head(table_users)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>category</p>
</th><th style="text-align: left" valign="bottom">
<p>value</p>
</th><th style="text-align: left" valign="bottom">
<p>chunk_user</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">C</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1038</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1026</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1034</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">C</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">V</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1008</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td></tr></tbody></table></div><p>The next step is to define a table in which rows correspond to the purchases. We need a column with the user ID and a column with the item ID. The new table is called <code class="literal">table_long</code>, because it's in a <code class="literal">long</code> format:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_long &lt;- table_users[, list(user = value[1], item = value[-1]), by = "chunk_user"]</strong></span>
<span class="strong"><strong>head(table_long)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>chunk_user</p>
</th><th style="text-align: left" valign="bottom">
<p>user</p>
</th><th style="text-align: left" valign="bottom">
<p>item</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1038</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1026</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1034</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1008</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1056</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1032</code></p>
</td></tr></tbody></table></div><p>Now, we can define a table having a row for each user and a column for each item. The values are equal to 1 if the item has been purchased, and 0 otherwise. We can build the table using<a class="indexterm" id="id225"/> the <code class="literal">reshape</code> function. Its inputs are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: This is the table in the <code class="literal">long</code> format.</li><li class="listitem" style="list-style-type: disc"><code class="literal">direction</code>: This shows whether we are reshaping from long to wide or otherwise.</li><li class="listitem" style="list-style-type: disc"><code class="literal">idvar</code>: This is the variable identifying the group, which, in this case, is the user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">timevar</code>: This is the variable identifying the record within the same group. In this case, it's the item.</li><li class="listitem" style="list-style-type: disc"><code class="literal">v.names</code>: This is name of the values. In this case, it's the rating that is always equal to one. Missing user-item combinations will be NA values.</li></ul></div><p>After defining the column <code class="literal">value</code> equal to <code class="literal">1</code>, we can build <code class="literal">table_wide</code> using <code class="literal">reshape</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_long[, value := 1]</strong></span>
<span class="strong"><strong>table_wide &lt;- reshape(data = table_long,direction = "wide",idvar = "user",timevar = "item",v.names = "value")</strong></span>
<span class="strong"><strong>head(table_wide[, 1:5, with = FALSE])</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>chunk_user</p>
</th><th style="text-align: left" valign="bottom">
<p>user</p>
</th><th style="text-align: left" valign="bottom">
<p>value.1038</p>
</th><th style="text-align: left" valign="bottom">
<p>value.1026</p>
</th><th style="text-align: left" valign="bottom">
<p>value.1034</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">3</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10003</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">4</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10004</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">5</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10005</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">6</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">10006</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr></tbody></table></div><p>In order to build the rating matrix, we need to keep only the columns containing ratings. In addition, the user name will be the matrix row names, so we need to store them in the <code class="literal">vector_users</code> vector:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>vector_users &lt;- table_wide[, user]</strong></span>
<span class="strong"><strong>table_wide[, user := NULL]</strong></span>
<span class="strong"><strong>table_wide[, chunk_user := NULL]</strong></span>
</pre></div><p>In order to have the column names equal to the item names, we need from the <code class="literal">value</code> prefix. For this purpose, we can use the <code class="literal">substring</code> function:</p><div class="informalexample"><pre class="programlisting">setnames(x = table_wide,old = names(table_wide),new = substring(names(table_wide), 7))</pre></div><p>We need<a class="indexterm" id="id226"/> to store the rating matrix within a <code class="literal">recommenderlab</code> object. For this purpose, we need to convert <code class="literal">table_wide</code> in a matrix first. In addition, we need to set the row names equal to the user names:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>matrix_wide &lt;- as.matrix(table_wide)rownames(matrix_wide) &lt;- vector_users</strong></span>
<span class="strong"><strong>head(matrix_wide[, 1:6])</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>user</p>
</th><th style="text-align: left" valign="bottom">
<p>1038</p>
</th><th style="text-align: left" valign="bottom">
<p>1026</p>
</th><th style="text-align: left" valign="bottom">
<p>1034</p>
</th><th style="text-align: left" valign="bottom">
<p>1008</p>
</th><th style="text-align: left" valign="bottom">
<p>1056</p>
</th><th style="text-align: left" valign="bottom">
<p>1032</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>10001</strong></span></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>10002</strong></span></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>10003</strong></span></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>10004</strong></span></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>10005</strong></span></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>10006</strong></span></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NA</code></p>
</td></tr></tbody></table></div><p>The last step is coercing <code class="literal">matrix_wide</code> into a binary rating matrix using <code class="literal">as</code>, in the following way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>matrix_wide[is.na(matrix_wide)] &lt;- 0</strong></span>
<span class="strong"><strong>ratings_matrix &lt;- as(matrix_wide, "binaryRatingMatrix")</strong></span>
<span class="strong"><strong>ratings_matrix</strong></span>
<span class="strong"><strong>## 5000 x 236 rating matrix of class binaryRatingMatrix with 15191 ratings.</strong></span>
</pre></div><p>Let's take a look at the matrix using <code class="literal">image</code>:</p><div class="informalexample"><pre class="programlisting">image(ratings_matrix[1:50, 1:50], main = "Binary rating matrix")</pre></div><p>The following image shows the binary rating matrix:</p><div class="mediaobject"><img alt="Defining a rating matrix" src="graphics/B03888_05_01.jpg"/></div><p>As expected, the<a class="indexterm" id="id227"/> matrix is sparse. We can also visualize the distributions of the number of users purchasing an item:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>n_users &lt;- colCounts(ratings_matrix)</strong></span>
<span class="strong"><strong>qplot(n_users) + stat_bin(binwidth = 100) + ggtitle("Distribution of the number of users")</strong></span>
</pre></div><p>The following image displays the distribution of the number of users:</p><div class="mediaobject"><img alt="Defining a rating matrix" src="graphics/B03888_05_02.jpg"/></div><p>There are <a class="indexterm" id="id228"/>some outliers, that is, items purchased by many users. Let's visualize the distribution excluding them:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>qplot(n_users[n_users &lt; 100]) + stat_bin(binwidth = 10) + ggtitle("Distribution of the number of users")</strong></span>
</pre></div><p>The following image displays the distribution of the numbers of users:</p><div class="mediaobject"><img alt="Defining a rating matrix" src="graphics/B03888_05_03.jpg"/></div><p>There are many items that have been purchased by a few users only, and we won't recommend<a class="indexterm" id="id229"/> them. Since they increase the computational time, we can just remove them by defining a minimum number of purchases, for example, <code class="literal">5</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ratings_matrix &lt;- ratings_matrix[, colCounts(ratings_matrix) &gt;= 5]</strong></span>
<span class="strong"><strong>ratings_matrix</strong></span>
<span class="strong"><strong>## 5000 x 166 rating matrix of class 'binaryRatingMatrix' with 15043 ratings.</strong></span>
</pre></div><p>Now, we have 166 items, compared to the initial 236. As regards users, we want to recommend items to everyone. However, there might be users that have purchased only items that we removed. Let's check it:</p><div class="informalexample"><pre class="programlisting">sum(rowCounts(ratings_matrix) == 0)
## _15_</pre></div><p>There are 15 users with no purchases. These purchases should be removed. In addition, users who have purchased just a few items are difficult to deal with. Therefore, we only keep users that have purchased at least five items:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ratings_matrix &lt;- ratings_matrix[rowCounts(ratings_matrix) &gt;= 5, ]</strong></span>
<span class="strong"><strong>ratings_matrix</strong></span>
<span class="strong"><strong>## 959 x 166 rating matrix of class 'binaryRatingMatrix' with 6816 ratings</strong></span>
</pre></div></div><div class="section" title="Extracting item attributes"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec48"/>Extracting item attributes</h2></div></div></div><p>The <code class="literal">table_in</code> raw <a class="indexterm" id="id230"/>data contains some records starting with <code class="literal">A</code>, and they display some information about the items. In order to extract these records, we can convert <code class="literal">table_in</code> into a data table and extract the rows having <code class="literal">A</code> in the first column:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_in &lt;- data.table(table_in)</strong></span>
<span class="strong"><strong>table_items &lt;- table_in[V1 == "A"]</strong></span>
<span class="strong"><strong>head(table_items)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>V1</p>
</th><th style="text-align: left" valign="bottom">
<p>V2</p>
</th><th style="text-align: left" valign="bottom">
<p>V3</p>
</th><th style="text-align: left" valign="bottom">
<p>V4</p>
</th><th style="text-align: left" valign="bottom">
<p>V5</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">A</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1277</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NetShow for PowerPoint</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/stream</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">A</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1253</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">MS Word Development</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/worddev</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">A</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1109</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">TechNet (World Wide Web Edition)</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/technet</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">A</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1038</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">SiteBuilder Network Membership</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/sbnmember</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">A</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1205</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Hardware Supprt</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/hardwaresupport</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">A</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1076</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">NT Workstation Support</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/ntwkssupport</code></p>
</td></tr></tbody></table></div><p>The relevant columns are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>V2</strong></span>: Item ID</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>V4</strong></span>: Item description</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>V5</strong></span>: Web page URL</li></ul></div><p>In order to have a more clear table, we can extract and rename them. In addition, we can sort the table by item ID:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_items &lt;- table_items[, c(2, 4, 5), with = FALSE]</strong></span>
<span class="strong"><strong>setnames(table_items, 1:3, c("id", "description", "url"))</strong></span>
<span class="strong"><strong>table_items &lt;- table_items[order(id)]</strong></span>
<span class="strong"><strong>head(table_items)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>id</p>
</th><th style="text-align: left" valign="bottom">
<p>description</p>
</th><th style="text-align: left" valign="bottom">
<p>url</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">1000</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">regwiz</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/regwiz</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Support desktop</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/support</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">End user produced view</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/athome</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1003</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Knowledge base</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/kb</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1004</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Microsoft.com search</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/search</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1005</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Norway</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/norge</code></p>
</td></tr></tbody></table></div><p>We need to identify one or more features describing the items. If we look at the table, we can identify<a class="indexterm" id="id231"/> two categories of web pages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Microsoft product</li><li class="listitem" style="list-style-type: disc">Geographic location</li></ul></div><p>We can identify the records containing a geographic location, and consider the remaining as products. For this purpose, we can start defining the field <code class="literal">category</code> that, at the moment, is equal to <code class="literal">product</code> for all the records:</p><div class="informalexample"><pre class="programlisting">table_items[, category := "product"]</pre></div><p>The country code package provides us with the <code class="literal">countrycode_data</code> object that contains most of the country names. We can define the <code class="literal">name_countries</code> vector that contains the names of countries and geographic locations. Then, we can categorize as <code class="literal">region</code> all the records whose description is in <code class="literal">name_countries</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>name_countries &lt;- c(countrycode_data$country.name, "Taiwan", "UK", "Russia", "Venezuela", "Slovenija", "Caribbean", "Netherlands (Holland)", "Europe", "Central America", "MS North Africa")</strong></span>
<span class="strong"><strong>table_items[description %in% name_countries, category := "region"]</strong></span>
</pre></div><p>There are other records containing the word <code class="literal">region</code>. We can identify them through a regular expression using <code class="literal">grepl</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_items[grepl("Region", description), category := "region"]</strong></span>
<span class="strong"><strong>head(table_items)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>V2</p>
</th><th style="text-align: left" valign="bottom">
<p>description</p>
</th><th style="text-align: left" valign="bottom">
<p>url</p>
</th><th style="text-align: left" valign="bottom">
<p>category</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">1000</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">regwiz</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/regwiz</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1001</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Support Desktop</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/support</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1002</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">End User Produced View</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/athome</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1003</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Knowledge Base</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/kb</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1004</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Microsoft.com Search</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/search</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1005</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Norway</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/norge</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">region</code></p>
</td></tr></tbody></table></div><p>Let's take a look at the result and find out the number of items we have for each category:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_items[, list(n_items = .N), by = category]</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>category</p>
</th><th style="text-align: left" valign="bottom">
<p>n_items</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">248</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">region</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">46</code></p>
</td></tr></tbody></table></div><p>About 80 percent of the web pages are products, and the remaining 20 percent are regions.</p><p>We are now ready<a class="indexterm" id="id232"/> to build recommendation models.</p></div></div></div>
<div class="section" title="Building the model"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Building the model</h1></div></div></div><p>This section<a class="indexterm" id="id233"/> will show you how to build a recommendation model using item descriptions and user purchases. The model combines item-based collaborative filtering with some information about the items. We will include the item description using a monolithic hybrid system with feature combination. The recommender will learn from the two data sources in two separate stages.</p><p>Following the approach described in <a class="link" href="ch03.html" title="Chapter 3. Recommender Systems">Chapter 3</a>, <span class="emphasis"><em>Recommender Systems</em></span>, let's split the data into the training and the test set:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>which_train &lt;- sample(x = c(TRUE, FALSE),size = nrow(ratings_matrix),replace = TRUE,prob = c(0.8, 0.2))recc_data_train &lt;- ratings_matrix[which_train, ]</strong></span>
<span class="strong"><strong>recc_data_test &lt;- ratings_matrix[!which_train, ]</strong></span>
</pre></div><p>Now, we can build an IBCF model using <code class="literal">Recommender</code>. Since the rating matrix is binary, we will set the distance method to <code class="literal">Jaccard</code>. For more details, look at the <span class="emphasis"><em>Collaborative filtering on binary data</em></span> section in <a class="link" href="ch03.html" title="Chapter 3. Recommender Systems">Chapter 3</a>, <span class="emphasis"><em>Recommender Systems</em></span>. The remaining parameters are left to their defaults:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>recc_model &lt;- Recommender(data = recc_data_train,method = "IBCF",parameter = list(method = "Jaccard"))</strong></span>
</pre></div><p>The engine of IBCF is based on a similarity matrix about the items. The distances are computed from the purchases. The more the number of items purchased by the same users, the more similar they are.</p><p>We can extract the matrix from the <code class="literal">sim</code> element in the slot model. Let's take a look at it:</p><div class="informalexample"><pre class="programlisting">class(recc_model@model$sim)
## dgCMatrix
dim(recc_model@model$sim)
## _166_ and _166_</pre></div><p>The matrix belongs to the <code class="literal">dgCMatrix</code> class, and it is square. We can visualize it using <code class="literal">image</code>:</p><div class="informalexample"><pre class="programlisting">image(recc_model@model$sim)</pre></div><p>The following<a class="indexterm" id="id234"/> image is the output of the preceding code:</p><div class="mediaobject"><img alt="Building the model" src="graphics/B03888_05_04.jpg"/></div><p>We can't identify any clear pattern, and it's because the items are not sorted. Let's take a look at the range of values:</p><div class="informalexample"><pre class="programlisting">range(recc_model@model$sim)
## _0_ and _1_</pre></div><p>All the distances are between 0 and 1.</p><p>Our target is to combine the distance matrix with the item descriptions, via the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Define a similarity matrix based on the purchases.</li><li class="listitem">Define a similarity matrix based on the item descriptions.</li><li class="listitem">Combine the two matrices.</li></ol></div><p>Starting from <code class="literal">recc_model</code>, we can define the purchases similarity matrix. All we need to do is to convert the <code class="literal">dgCMatrix</code> object into <code class="literal">matrix</code>:</p><div class="informalexample"><pre class="programlisting">dist_ratings &lt;- as(recc_model@model$sim, "matrix")</pre></div><p>In order to build the matrix based on item descriptions, we can use the <code class="literal">dist</code> function. Given that it's based on a category column only, the distance will be as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">1, if the two items belong to the same category</li><li class="listitem" style="list-style-type: disc">0, if the two items belong to different categories</li></ul></div><p>We need to <a class="indexterm" id="id235"/>build a similarity matrix, and we have a distance matrix. Since distances are between 0 and 1, we can just use <code class="literal">1 - dist()</code>. All the operations are performed within the data table:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dist_category &lt;- table_items[, 1 - dist(category == "product")]class(dist_category)</strong></span>
<span class="strong"><strong>## dist</strong></span>
</pre></div><p>The <code class="literal">dist_category</code> raw data is a <code class="literal">dist</code> object that can be easily converted into a matrix using the <code class="literal">as()</code> function :</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dist_category &lt;- as(dist_category, "matrix")</strong></span>
</pre></div><p>Let's compare the dimensions of <code class="literal">dist_category</code> with <code class="literal">dist_ratings</code>:</p><div class="informalexample"><pre class="programlisting">dim(dist_category)
## _294_ and _294_
dim(dist_ratings)
## _166_ and _166_</pre></div><p>The <code class="literal">dist_category</code> table has more rows and columns, and the reason is that it contains all the items, whereas <code class="literal">dist_ratings</code> contains only the ones that have been purchased.</p><p>In order to combine <code class="literal">dist_category</code> with <code class="literal">dist_ratings</code>, we need to have the same items. In addition, they need to be sorted in the same way. We can match them using the item names using these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make sure that both the matrices have the item names in their row and column names.</li><li class="listitem">Extract the row and column names from <code class="literal">dist_ratings</code>.</li><li class="listitem">Subset and order <code class="literal">dist_category</code> according to the names of <code class="literal">dist_ratings</code>.</li></ol></div><p>The <code class="literal">dist_ratings</code> table already contains the row and column names. We need to add them to <code class="literal">dist_category</code>, starting from <code class="literal">table_items</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>rownames(dist_category) &lt;- table_items[, id]</strong></span>
<span class="strong"><strong>colnames(dist_category) &lt;- table_items[, id]</strong></span>
</pre></div><p>Now, it's sufficient to extract the names from <code class="literal">dist_ratings</code> and subset <code class="literal">dist_category</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>vector_items &lt;- rownames(dist_ratings)</strong></span>
<span class="strong"><strong>dist_category &lt;- dist_category[vector_items, vector_items]</strong></span>
</pre></div><p>Let's check whether the two matrices match:</p><div class="informalexample"><pre class="programlisting">identical(dim(dist_category), dim(dist_ratings))
## TRUE
identical(rownames(dist_category), rownames(dist_ratings))
## TRUE
identical(colnames(dist_category), colnames(dist_ratings))
## TRUE</pre></div><p>Everything<a class="indexterm" id="id236"/> is identical, so they match. Let's take a look at <code class="literal">dist_category</code>:</p><div class="informalexample"><pre class="programlisting">image(dist_category)</pre></div><p>The following image is the output of the preceding code:</p><div class="mediaobject"><img alt="Building the model" src="graphics/B03888_05_05.jpg"/></div><p>The matrix contains only 0s and 1s, and it's based on two categories, so there are clear patterns. In addition, we can notice that the matrix is symmetric.</p><p>We need to combine the two tables, and we can do it with a weighted average. Since <code class="literal">dist_category</code> takes account of two categories of items only, it's better not to give it too much relevance. For instance, we can set its weight to 25 percent:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>weight_category &lt;- 0.25</strong></span>
<span class="strong"><strong>dist_tot &lt;- dist_category * weight_category + dist_ratings * (1 - weight_category)</strong></span>
</pre></div><p>Let's take a look at the <code class="literal">dist_tot</code> matrix using <code class="literal">image</code>:</p><div class="informalexample"><pre class="programlisting">image(dist_tot)</pre></div><p>The following<a class="indexterm" id="id237"/> image is the output of the preceding code:</p><div class="mediaobject"><img alt="Building the model" src="graphics/B03888_05_06.jpg"/></div><p>We can see some white dots representing items that are very similar. In addition, we can still see the patterns of <code class="literal">dist_category</code> in the background.</p><p>Now, we can include the new matrix within <code class="literal">recc_model</code>. For this purpose, it's sufficient to convert <code class="literal">dist_tot</code> into <code class="literal">dgCMatrix</code> and insert it in <code class="literal">recc_model</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>recc_model@model$sim &lt;- as(dist_tot, "dgCMatrix")</strong></span>
<span class="strong"><strong>recc_model@model$sim &lt;- as(dist_tot, "dgCMatrix")</strong></span>
</pre></div><p>As shown in <a class="link" href="ch03.html" title="Chapter 3. Recommender Systems">Chapter 3</a>, <span class="emphasis"><em>Recommender Systems</em></span>, we can recommend items using <code class="literal">predict()</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>n_recommended &lt;- 10</strong></span>
<span class="strong"><strong>recc_predicted &lt;- predict(object = recc_model, newdata = recc_data_test, n = n_recommended)</strong></span>
</pre></div><p>The <code class="literal">itemLabels</code> slot of <code class="literal">recc_predicted</code> contains the item names, that is, their code:</p><div class="informalexample"><pre class="programlisting">head(recc_predicted@itemLabels)

1038, 1026, 1034, 1008, 1056 and 1032</pre></div><p>In order to display the item description, we can use <code class="literal">table_items</code>. All we need to do is make sure that the items are ordered in the same way as <code class="literal">itemLabels</code>. For this purpose, we will prepare a data frame containing the item information. We will also make sure that it's sorted in the same way as the item labels using the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Define a<a class="indexterm" id="id238"/> data frame having a column with the ordered item labels.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_labels &lt;- data.frame(id = recc_predicted@itemLabels)</strong></span>
</pre></div></li><li class="listitem">Left-join between <code class="literal">table_labels</code> and <code class="literal">table_items</code>. Note the argument <code class="literal">sort = FALSE</code> that does not let us re-sort the table:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_labels &lt;- merge(table_labels, table_items,</strong></span>
<span class="strong"><strong>                      by = "id", all.x = TRUE, all.y = FALSE,</strong></span>
<span class="strong"><strong>                      sort = FALSE)</strong></span>
</pre></div></li><li class="listitem">Convert the description from factor to character:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>descriptions &lt;- as(table_labels$description, "character")</strong></span>
</pre></div></li></ol></div><p>Let's take a look at <code class="literal">table_labels</code>:</p><div class="informalexample"><pre class="programlisting">head(table_labels)</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>id</p>
</th><th style="text-align: left" valign="bottom">
<p>description</p>
</th><th style="text-align: left" valign="bottom">
<p>url</p>
</th><th style="text-align: left" valign="bottom">
<p>category</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">1038</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">SiteBuilder Network Membership</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/sbnmember</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1026</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Internet Site Construction for Developers</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/sitebuilder</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1034</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Internet Explorer</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/ie</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1008</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Free Downloads</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/msdownload</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1056</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">sports</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/sports</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">1032</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">Games</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">/games</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">product</code></p>
</td></tr></tbody></table></div><p>As expected, the table contains the description of the items. Now, we are able to extract the recommendations. For instance, we can do it for the first user:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>recc_user_1 &lt;- recc_predicted@items[[1]]</strong></span>
<span class="strong"><strong>items_user_1 &lt;- descriptions[recc_user_1]</strong></span>
<span class="strong"><strong>head(items_user_1)</strong></span>
</pre></div><p>Windows family of OSs, Support Desktop, Knowledge Base, Microsoft.com Search, Products, and Windows 95.</p><p>Now, we can define a table with the recommendations to all users. Each column corresponds to a user and each row to a recommended item. Having set <code class="literal">n_recommended</code> to <code class="literal">10</code>, the table should have 10 rows. For this purpose, we can use <code class="literal">sapply()</code> For each element of <code class="literal">recc_predicted@items</code>, we identify the related item descriptions.</p><p>However, the number of recommended items per user is a number between 1 and 10, which is not the same for each user. In order to define a structured table with 10 rows, we need the same<a class="indexterm" id="id239"/> number of elements for each user. For this reason, we will replace the missing recommendations with empty strings. We can obtain it by replicating the empty string with <code class="literal">rep()</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>recc_matrix &lt;- sapply(recc_predicted@items, function(x){</strong></span>
<span class="strong"><strong>  recommended &lt;- descriptions[x]</strong></span>
<span class="strong"><strong>  c(recommended, rep("", n_recommended - length(recommended)))</strong></span>
<span class="strong"><strong>})</strong></span>
<span class="strong"><strong>dim(recc_matrix)</strong></span>
<span class="strong"><strong>## _10_ and _191_</strong></span>
</pre></div><p>Let's take a look at the recommendations for the first three users:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>head(recc_matrix[, 1:3])</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Windows family of OSs</p>
</th><th style="text-align: left" valign="bottom">
<p>Products</p>
</th><th style="text-align: left" valign="bottom">
<p>Developer workshop</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Support Desktop</p>
</td><td style="text-align: left" valign="top">
<p>MS Word</p>
</td><td style="text-align: left" valign="top">
<p>SiteBuilder Network Membership</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Knowledge Base</p>
</td><td style="text-align: left" valign="top">
<p>isapi</p>
</td><td style="text-align: left" valign="top">
<p>isapi</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Microsoft.com Search</p>
</td><td style="text-align: left" valign="top">
<p>regwiz</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft.com Search</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Products</p>
</td><td style="text-align: left" valign="top">
<p>Windows family of OSs</p>
</td><td style="text-align: left" valign="top">
<p>Windows Family of OSs</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Windows 95</p>
</td><td style="text-align: left" valign="top">
<p>Microsoft.com Search</p>
</td><td style="text-align: left" valign="top">
<p>Web Site Builder's Gallery</p>
</td></tr></tbody></table></div><p>We can notice that some items have been recommended to the three of them: Products and Support Desktop. Therefore, we suspect that some items are much more likely to be recommended.</p><p>Just like we did in <a class="link" href="ch03.html" title="Chapter 3. Recommender Systems">Chapter 3</a>, <span class="emphasis"><em>Recommender Systems</em></span>, we can explore the output. For each item, we can count how many times it has been recommended:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_recomm_per_item &lt;- table(recc_matrix)</strong></span>
<span class="strong"><strong>recomm_per_item &lt;- as(table_recomm_per_item, "numeric")</strong></span>
</pre></div><p>In order to visualize the result, we <code class="literal">bin_recomm_per_item</code> using <code class="literal">cut()</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>bin_recomm_per_item &lt;- cut(recomm_per_item,breaks = c(0, 10, 20, 100,max(recomm_per_item)))</strong></span>
</pre></div><p>Using <code class="literal">qplot</code>, we can visualize the <code class="literal">recomm_per_item</code> distribution:</p><div class="informalexample"><pre class="programlisting">qplot(bin_recomm_per_item) + ggtitle("Recommendations per item")</pre></div><p>The following<a class="indexterm" id="id240"/> image displays the recommendations per item:</p><div class="mediaobject"><img alt="Building the model" src="graphics/B03888_05_07.jpg"/></div><p>Most of the items have been recommended 10 times or fewer, and a few of them have more than 100 recommendations. The distribution has a long tail.</p><p>We can also identify the most popular items by sorting <code class="literal">recomm_per_item</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>recomm_per_item_sorted &lt;- sort(table_recomm_per_item,decreasing = TRUE) recomm_per_item_top &lt;- head(recomm_per_item_sorted, n = 4)</strong></span>
<span class="strong"><strong>table_top &lt;- data.frame(</strong></span>
<span class="strong"><strong>  name = names(recomm_per_item_top), n_recomm = recomm_per_item_top)</strong></span>
<span class="strong"><strong>table_top</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>name</p>
</th><th style="text-align: left" valign="bottom">
<p>n_recomm</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">Internet Explorer</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">126</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">Windows Family of OSs</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">120</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">Knowledge Base</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">118</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">Products</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">115</code></p>
</td></tr></tbody></table></div><p>In this section, we built and explored a hybrid recommender model. The next step is to evaluate it <a class="indexterm" id="id241"/>and optimize its parameters.</p></div>
<div class="section" title="Evaluating and optimizing the model"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Evaluating and optimizing the model</h1></div></div></div><p>This section will <a class="indexterm" id="id242"/>show you how to evaluate the performance of our recommender. Starting from the <a class="indexterm" id="id243"/>evaluation, we can try some parameter configurations and choose the one performing the best. For more details, see <a class="link" href="ch04.html" title="Chapter 4. Evaluating the Recommender Systems">Chapter 4</a>, <span class="emphasis"><em>Evaluating the Recommender Systems</em></span>.</p><p>The following are the steps to evaluate and optimize the model:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Build a function that evaluates the model given a parameter configuration</li><li class="listitem" style="list-style-type: disc">Use the function to test different parameter configurations and pick the best one</li></ul></div><p>Let's go through these steps in detail.</p><div class="section" title="Building a function to evaluate the model"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>Building a function to evaluate the model</h2></div></div></div><p>This section will <a class="indexterm" id="id244"/>show you how to define a function that:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Sets up <a class="indexterm" id="id245"/>cross validation using the <span class="emphasis"><em>k</em></span>-fold.</li><li class="listitem">Builds a hybrid IBCF.</li><li class="listitem">Recommends the items to the users in the test sets.</li><li class="listitem">Evaluates the recommendation.</li></ol></div><p>The inputs of our function are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Data</strong></span>: This is<a class="indexterm" id="id246"/> the rating matrix table with the item description</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>k-fold parameters</strong></span>: This is the<a class="indexterm" id="id247"/> number of folds, the number of items to keep in the test set</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Model parameters</strong></span>: This is the number of nearest neighbors, weight to the description-based distance, number of items to recommend</li></ul></div><p>Let's define the function <a class="indexterm" id="id248"/>arguments. You can find the description of each argument as a comment next to its name:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>evaluateModel &lt;- function (</strong></span>
<span class="strong"><strong>  # data inputs</strong></span>
<span class="strong"><strong>  ratings_matrix, # rating matrix</strong></span>
<span class="strong"><strong>  table_items, # item description table</strong></span>
<span class="strong"><strong>  # K-fold parameters</strong></span>
<span class="strong"><strong>  n_fold = 10, # number of folds</strong></span>
<span class="strong"><strong>  items_to_keep = 4, # number of items to keep in the test set</strong></span>
<span class="strong"><strong>  # model parameters</strong></span>
<span class="strong"><strong>  number_neighbors = 30, # number of nearest neighbors</strong></span>
<span class="strong"><strong>  weight_description = 0.2, # weight to the item description-based distance</strong></span>
<span class="strong"><strong>  items_to_recommend = 10 # number of items to recommend</strong></span>
<span class="strong"><strong>){</strong></span>
<span class="strong"><strong>  # build and evaluate the model</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>Now, we <a class="indexterm" id="id249"/>can walk through the function body step by step. For a more detailed explanation, see the previous section and <a class="link" href="ch04.html" title="Chapter 4. Evaluating the Recommender Systems">Chapter 4</a>, <span class="emphasis"><em>Evaluating the Recommender Systems</em></span>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using the <code class="literal">evaluationScheme()</code> function, set-up a <span class="emphasis"><em>k</em></span>-fold. The parameters <span class="emphasis"><em>k</em></span> and given are set according to the inputs <code class="literal">n_fold</code> and <code class="literal">items_to_keep</code>, respectively. The <code class="literal">set.seed(1)</code> command makes sure that the example is reproducible, that is, the random component will be the same if repeated:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>set.seed(1)</strong></span>
<span class="strong"><strong>eval_sets &lt;- evaluationScheme(data = ratings_matrix,</strong></span>
<span class="strong"><strong>                              method = "cross-validation",</strong></span>
<span class="strong"><strong>                              k = n_fold,</strong></span>
<span class="strong"><strong>                              given = items_to_keep)</strong></span>
</pre></div></li><li class="listitem">Using <code class="literal">Recommender()</code>, build an IBCF defining the distance function as <code class="literal">Jaccard</code> and the <span class="emphasis"><em>k</em></span> argument as the <code class="literal">number_neighbors</code> input:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>recc_model &lt;- Recommender(data = getData(eval_sets, "train"),</strong></span>
<span class="strong"><strong>                          method = "IBCF",</strong></span>
<span class="strong"><strong>                          parameter = list(method = "Jaccard",</strong></span>
<span class="strong"><strong>                          k = number_neighbors))</strong></span>
</pre></div></li><li class="listitem">Extract the rating-based distance matrix from the <code class="literal">recc_model</code> model:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dist_ratings &lt;- as(recc_model@model$sim, "matrix")</strong></span>
<span class="strong"><strong>vector_items &lt;- rownames(dist_ratings)</strong></span>
</pre></div></li><li class="listitem">Starting from the <code class="literal">table_items</code> input, define the description-based distance matrix:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dist_category &lt;- table_items[, 1 - as.matrix(dist(category == "product"))]</strong></span>
<span class="strong"><strong>rownames(dist_category) &lt;- table_items[, id]</strong></span>
<span class="strong"><strong>colnames(dist_category) &lt;- table_items[, id]</strong></span>
<span class="strong"><strong>dist_category &lt;- dist_category[vector_items, vector_items]</strong></span>
</pre></div></li><li class="listitem">Define the distance matrix combining <code class="literal">dist_ratings</code> and <code class="literal">dist_category</code>. The combination is a weighted average, and the weight is defined by the <code class="literal">weight_description</code> input:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>dist_tot &lt;- dist_category * weight_description +</strong></span>
<span class="strong"><strong>  dist_ratings * (1 - weight_description)</strong></span>
<span class="strong"><strong>recc_model@model$sim &lt;- as(dist_tot, "dgCMatrix")</strong></span>
</pre></div></li><li class="listitem">Predict the<a class="indexterm" id="id250"/> test set users with known purchases. Since we are using a table with 0 and 1 ratings only, we can specify that we predict the top <code class="literal">n</code> recommendations with the argument <code class="literal">type = "topNList"</code>. The argument <code class="literal">n</code>, defining the number of items to recommend, comes from the <code class="literal">items_to_recommend</code> input:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>eval_prediction &lt;- predict(object = recc_model, newdata = getData(eval_sets, "known"), n = items_to_recommend, type = "topNList")</strong></span>
</pre></div></li><li class="listitem">Evaluate the model performance using <code class="literal">calcPredictionAccuracy()</code>. Specifying <code class="literal">byUser = FALSE</code>, we have a table with the average indices such as precision and recall:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>eval_accuracy &lt;- calcPredictionAccuracy(</strong></span>
<span class="strong"><strong>  x = eval_prediction,</strong></span>
<span class="strong"><strong>  data = getData(eval_sets, "unknown"),</strong></span>
<span class="strong"><strong>  byUser = FALSE,</strong></span>
<span class="strong"><strong>  given = items_to_recommend)</strong></span>
</pre></div></li><li class="listitem">The function output is the <code class="literal">eval_accuracy</code> table:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>return(eval_accuracy)</strong></span>
</pre></div></li><li class="listitem">Now, we can test our function:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>model_evaluation &lt;- evaluateModel(ratings_matrix = ratings_matrix, table_items = table_items)</strong></span>
<span class="strong"><strong>model_evaluation</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>index</p>
</th><th style="text-align: left" valign="bottom">
<p>value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">TP</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">2</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">FP</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">8</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">FN</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">TN</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">145</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">precision</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">19%</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">recall</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">64%</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">TPR</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">64%</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">FPR</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">5%</code></p>
</td></tr></tbody></table></div></li></ol></div><p>You can find a<a class="indexterm" id="id251"/> detailed description of the indices in <a class="link" href="ch04.html" title="Chapter 4. Evaluating the Recommender Systems">Chapter 4</a>, <span class="emphasis"><em>Evaluating the Recommender Systems</em></span>.</p><p>In this section, we defined a function evaluating our model with given settings. This function will help us with parameter optimization.</p></div><div class="section" title="Optimizing the model parameters"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>Optimizing the model parameters</h2></div></div></div><p>Starting with our <code class="literal">evaluateModel()</code> function, we can optimize the model parameters. In this section, we will <a class="indexterm" id="id252"/>optimize these parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">number_neighbors</code>: This is the number of nearest neighbors of IBCF</li><li class="listitem" style="list-style-type: disc"><code class="literal">weight_description</code>: This is the weight given to the description-based distance</li></ul></div><p>Although we could optimize other parameters, we will just leave them to their defaults, for the sake of simplicity.</p><p>Our recommender model combines IBCF with the item descriptions. Therefore, it's a good practice to optimize IBCF first, that is, the <code class="literal">number_neighbors</code> parameter.</p><p>First, we have to decide which values we want to test. We take account of k, that is, at most, half of the items, that is, about <code class="literal">80</code>. On the other hand, we exclude values that are smaller than 4, since the algorithm would be too unstable. Setting a granularity of <code class="literal">2</code>, we can generate a vector with the values to test:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>nn_to_test &lt;- seq(4, 80, by = 2)</strong></span>
</pre></div><p>Now, we can measure the performance depending on <code class="literal">number_neighbors</code>. Since we are optimizing the IBCF part only, we will set weight_<code class="literal">description = 0</code>. Using <code class="literal">lapply</code>, we can build a list of elements that contain the performance for each value of <code class="literal">nn_to_test</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>list_performance &lt;- lapply(</strong></span>
<span class="strong"><strong>  X = nn_to_test,</strong></span>
<span class="strong"><strong>  FUN = function(nn){</strong></span>
<span class="strong"><strong>    evaluateModel(ratings_matrix = ratings_matrix, table_items = table_items, number_neighbors = nn, weight_description = 0)</strong></span>
<span class="strong"><strong>  })</strong></span>
</pre></div><p>Let's take a<a class="indexterm" id="id253"/> look at the first element of the list:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>list_performance[[1]]</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>name</p>
</th><th style="text-align: left" valign="bottom">
<p>value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">TP</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1.663</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">FP</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">8.337</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">FN</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">1.683</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">TN</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">144.3</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">precision</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.1663</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">recall</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.5935</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">TPR</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.5935</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">FPR</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.05449</code></p>
</td></tr></tbody></table></div><p>The first element contains all the performance metrics. In order to evaluate our model, we can use the precision and recall. See <a class="link" href="ch04.html" title="Chapter 4. Evaluating the Recommender Systems">Chapter 4</a>, <span class="emphasis"><em>Evaluating the Recommender Systems</em></span> for more information.</p><p>We can extract a vector of precisions (or recalls) using <code class="literal">sapply</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sapply(list_performance, "[[", "precision")^t</strong></span>

<span class="strong"><strong>0.1663, 0.1769, 0.1769, 0.175, 0.174, 0.1808, 0.176, 0.1779, 0.1788, 0.1788, 0.1808, 0.1817, 0.1817, 0.1837, 0.1846, 0.1837, 0.1827, 0.1817, 0.1827, 0.1827, 0.1817, 0.1808, 0.1817, 0.1808, 0.1808, 0.1827, 0.1827, 0.1837, 0.1827, 0.1808, 0.1798, 0.1798, 0.1798, 0.1798, 0.1798, 0.1798, 0.1788, 0.1788 and 0.1788</strong></span>
</pre></div><p>In order to analyze the output, we can define a table whose columns are <code class="literal">nn_to_test</code>, precisions, and recalls:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_performance &lt;- data.table(</strong></span>
<span class="strong"><strong>  nn = nn_to_test, precision = sapply(list_performance, "[[", "precision"), recall = sapply(list_performance, "[[", "recall")</strong></span>
<span class="strong"><strong>)</strong></span>
</pre></div><p>In addition, we can define a performance index that we will optimize. The performance index can be a weighted average between the precision and the recall. The weights depend on the <a class="indexterm" id="id254"/>use case, so we can just leave them to 50 percent:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>weight_precision &lt;- 0.5</strong></span>
<span class="strong"><strong>table_performance[</strong></span>
<span class="strong"><strong>    performance := precision * weight_precision + recall * (1 - weight_precision)]</strong></span>
<span class="strong"><strong>head(table_performance)</strong></span>
</pre></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>nn</p>
</th><th style="text-align: left" valign="bottom">
<p>precision</p>
</th><th style="text-align: left" valign="bottom">
<p>recall</p>
</th><th style="text-align: left" valign="bottom">
<p>performance</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">4</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.1663</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.5935</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.3799</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">6</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.1769</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.621</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.399</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">8</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.1769</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.5973</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.3871</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">10</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.175</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.5943</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.3846</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">12</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.174</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.5909</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.3825</code></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">14</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.1808</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.6046</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">0.3927</code></p>
</td></tr></tbody></table></div><p>The precision is the percentage of recommended items that have been purchased, and the recall is the percentage of purchased items that have been recommended.</p><p>The <code class="literal">table_performance</code> table contains all the evaluation metrics. Starting with it, we can build charts that help us identify the optimal <code class="literal">nn</code>.</p><p>Before building the charts, let's define the <code class="literal">convertIntoPercent()</code> function that we will use within the <code class="literal">ggplot2</code> functions:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>convertIntoPercent &lt;- function(x){</strong></span>
<span class="strong"><strong>  paste0(round(x * 100), "%")</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div><p>We are ready to build the charts. The first chart is about the precision based on <code class="literal">nn</code>. We can build it using these functions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">qplot</code>: This builds the scatterplot.</li><li class="listitem" style="list-style-type: disc"><code class="literal">geom_smooth</code>: This adds a smoothing line.</li><li class="listitem" style="list-style-type: disc"><code class="literal">scale_y_continuous</code>: This changes the <code class="literal">y</code> scale. In our case, we just want to display the percentage.</li></ul></div><p>The following command consists of the preceding points:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  qplot(table_performance[, nn], table_performance[, precision]) + geom_smooth() + scale_y_continuous(labels = convertIntoPercent)</strong></span>
</pre></div><p>The following image is the output of the preceding code:</p><div class="mediaobject"><img alt="Optimizing the model parameters" src="graphics/B03888_05_08.jpg"/></div><p>The smoothed<a class="indexterm" id="id255"/> line grows until the global maximum, which is around <code class="literal">nn = 35</code>, slowly decreases. This index expresses the percentage of recommendations that have been successful, so it's useful when there are high costs associated with advertising.</p><p>Let's take a look at the recall, using the same commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  qplot(table_performance[, nn], table_performance[, recall]) + geom_smooth() + scale_y_continuous(labels = convertIntoPercent)</strong></span>
</pre></div><p>The following image is the output of the preceding screenshot:</p><div class="mediaobject"><img alt="Optimizing the model parameters" src="graphics/B03888_05_09.jpg"/></div><p>The maximum recall is around <code class="literal">nn = 40</code>. This index expresses the percentage of purchases that<a class="indexterm" id="id256"/> we recommended, so it's useful if we want to be sure to predict most of the purchases.</p><p>The performance takes account of the precision and the recall at the same time. Let's take a look at it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  qplot(table_performance[, nn], table_performance[, performance]) + geom_smooth() + scale_y_continuous(labels = convertIntoPercent)</strong></span>
</pre></div><div class="mediaobject"><img alt="Optimizing the model parameters" src="graphics/B03888_05_10.jpg"/></div><p>The optimal<a class="indexterm" id="id257"/> performances are between 30 and 45. We can identify the best <code class="literal">nn</code> using <code class="literal">which.max</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>row_best &lt;- which.max(table_performance$performance)</strong></span>
<span class="strong"><strong>number_neighbors_opt &lt;- table_performance[row_best, nn]</strong></span>
<span class="strong"><strong>number_neighbors_opt</strong></span>
<span class="strong"><strong>## _34_</strong></span>
</pre></div><p>The optimal value is <code class="literal">34</code>. We optimized the IBCF parameter, and the next step is determining the weight of the item description component. First, let's define the weights to try. The possible weights range between 0 and 1, and we just need to set the granularity, for instance, <code class="literal">0.05</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wd_to_try &lt;- seq(0, 1, by = 0.05)</strong></span>
</pre></div><p>Using <code class="literal">lapply</code>, we can test the recommender based on the weight:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>list_performance &lt;- lapply(</strong></span>
<span class="strong"><strong>  X = wd_to_try, FUN = function(wd){</strong></span>
<span class="strong"><strong>    evaluateModel(ratings_matrix = ratings_matrix, table_items = table_items, number_neighbors = number_neighbors_opt, weight_description = wd) })</strong></span>
</pre></div><p>Just like we did earlier, we can build a table containing precisions, recalls, and performances:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>table_performance &lt;- data.table(</strong></span>
<span class="strong"><strong>  wd = wd_to_try, precision = sapply(list_performance, "[[", "precision"), recall = sapply(list_performance, "[[", "recall")</strong></span>
<span class="strong"><strong>)</strong></span>
<span class="strong"><strong>table_performance[</strong></span>
<span class="strong"><strong>    performance := precision * weight_precision + recall * (1 - weight_precision)]</strong></span>
</pre></div><p>Now, we can visualize the performance based on the weight through a chart:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  qplot(table_performance[, wd], table_performance[, performance]) + geom_smooth() + scale_y_continuous(labels = convertIntoPercent)</strong></span>
</pre></div><p>The following image is the output of the preceding command:</p><div class="mediaobject"><img alt="Optimizing the model parameters" src="graphics/B03888_05_11.jpg"/></div><p>The performance is the same for each point, with the exception of the extremes. Therefore, the<a class="indexterm" id="id258"/> smoothing line is not useful.</p><p>We have the best performance that takes account of both ratings and descriptions. The extreme <span class="strong"><strong>0.00</strong></span> corresponds to pure IBCF, and it performs slightly worse than the hybrid. The model in the extreme <span class="strong"><strong>1.00</strong></span> is based on the item description only, and that's why it performs so badly.</p><p>The reason why the performance doesn't change much is that the item description is based on a binary feature only. If we add other features, we will see a greater impact.</p><p>This section showed you how to optimize our recommendation algorithm on the basis of two parameters. A next step could be optimizing on the basis of the remaining IBCF parameters and<a class="indexterm" id="id259"/> improving the item description.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Summary</h1></div></div></div><p>This chapter showed you how to apply the techniques in a real-life context. Starting with raw unstructured data, we built a rating matrix, which is the input of collaborative filtering. In addition, we extracted the item description, which improved the performance of our model. Using performance evaluations, we optimized the model parameters. The same approach can be applied in real-life contexts, if properly refined.</p><p>This book is a path that shows, first, the basics of machine learning and then a practical application. After having read this book, you will be able to deal with real-life challenges, identifying the most appropriate recommendation solution. Thank you for following until this point.</p><p>If you have any queries, don't hesitate to contact us.</p></div></body></html>