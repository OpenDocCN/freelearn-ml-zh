<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression"><div class="book" id="MSDG2-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02" class="calibre1"/>Chapter 2. AdventureWorks Regression</h1></div></div></div><p class="calibre6">Imagine you're a business developer at AdventureWorks, a bicycle manufacturing company based in Seattle, Washington. You are responsible for three applications that run at the top of a single SQL Server instance. The applications are:</p><div class="book"><ul class="itemizedlist"><li class="listitem">A customer ordering website with a section for direct customer sales and another section for resellers to buy in bulk</li><li class="listitem">A desktop inventory control management application</li><li class="listitem">A reporting solution using Power BI as a frontend</li></ul></div><p class="calibre6">All three of these applications share similar characteristics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">They are database-first applications where their primary role is to wireframe the database</li><li class="listitem">They are all .NET applications that use standard Microsoft templating and frameworks, such as MVC for the website and Entity Frameworks for both web and desktop solutions</li></ul></div><p class="calibre6">One day, your boss calls you into her office and says, "we are concerned about the reseller's section of the website. We've noticed through some basic charting in the Power BI that many resellers are dropping their order depending on the average customer reviews of the product.</p><p class="calibre6">Here is the one of the charts we are looking at:</p><div class="mediaobject"><img src="../images/00020.jpeg" alt="AdventureWorks Regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Obviously, if we can prevent people from doing this, we will maximize sales. We want to maximize our existing code assets, so your solution needs to integrate with the existing website and we want our customers to experience the same look and feel they currently have."</p><p class="calibre6">This is what the current webpage looks like:</p><div class="mediaobject"><img src="../images/00021.jpeg" alt="AdventureWorks Regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">You tell your boss that you will take a look, think about it for a couple of days, and come up with some ideas. Inside, you are thrilled because this will take you out of the traditional role of web dev and into data science. After researching some different machine learning techniques, you settle on using a simple regression to help achieve this goal.</p></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression">
<div class="book" title="Simple linear regression"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch02lvl1sec17" class="calibre1"/>Simple linear regression</h1></div></div></div><p class="calibre6">Regressions attempt to predict one number given a set of different numbers. For example, imagine we had a box where we enter in a number and another number comes out:</p><div class="mediaobject"><img src="../images/00022.jpeg" alt="Simple linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">I enter the number 1 into the box, and the number 6 comes out. Then, I enter another 1 into the box and the number 7 comes out. I do this five times and I get the following results:</p><div class="informalexample"><pre class="programlisting">1 -&gt; 6
1 -&gt; 7
1 -&gt; 6
1 -&gt; 5
1 -&gt; 6</pre></div><p class="calibre6">Before entering in<a id="id54" class="calibre1"/> another one, what do you think the output will be? You probably guessed 6. However, if I asked you whether you were 100% sure that 6 would come out, you would say, "no, but it will probably be 6." In fact, you might say that 6 has a 60% chance of coming out based on prior experience (three sixes in five total attempts).</p><p class="calibre6">What you are doing mentally is a kind of regression. Typically, linear regressions are written using a formula like this:</p><div class="informalexample"><pre class="programlisting">y = x0 + x1 + x2 + E</pre></div><p class="calibre6">Here, <span class="strong"><em class="calibre11">y</em></span> is the number you want to predict and <span class="strong"><em class="calibre11">x0</em></span>, <span class="strong"><em class="calibre11">x1</em></span>, and <span class="strong"><em class="calibre11">x2</em></span> are some numbers that might affect <span class="strong"><em class="calibre11">y</em></span>. Back to AdventureWorks, <span class="strong"><em class="calibre11">y</em></span> is the number of bikes a retail store will order in a month, <span class="strong"><em class="calibre11">x0</em></span> is the month of the year, <span class="strong"><em class="calibre11">x1</em></span> is the order from the previous three months, and <span class="strong"><em class="calibre11">x2</em></span> is the number of other bikes that are being ordered by their immediate competitors. <span class="strong"><em class="calibre11">E</em></span> is all of the things that our formula cannot account for that still affects the bike sales—like an individual store losing a key sales person. If we knew that <span class="strong"><em class="calibre11">x0 + x1 + x2</em></span> accounted for 75% of <span class="strong"><em class="calibre11">y</em></span>, we would know that 25% of <span class="strong"><em class="calibre11">y</em></span> cannot be explained.</p><p class="calibre6">Our goal, then, is to find as few <span class="strong"><em class="calibre11">x</em></span> parameters as possible that have the greatest impact on <span class="strong"><em class="calibre11">y</em></span> and then make a reasonable attempt to have our website reflect both the predicted value and to influence the users for our benefit.</p><p class="calibre6">There are many types of regressions, and we will start with the most basic, though surprisingly powerful one—the simple regression. In a simple regression, there is only one input variable and one output, so the formula is <span class="strong"><em class="calibre11">y = x0 + E</em></span>. Because there are only two variables, we can plot them on a two-dimensional graph. For example, if we had this data:</p><div class="mediaobject"><img src="../images/00023.jpeg" alt="Simple linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">We can plot the data like this:</p><div class="mediaobject"><img src="../images/00024.jpeg" alt="Simple linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">What we want to do with <a id="id55" class="calibre1"/>a simple regression is find the line that "fits" best through all of the data points:</p><div class="mediaobject"><img src="../images/00025.jpeg" alt="Simple linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In this example, you can see that the line goes through points 1, 2, and 5. If the line does not intersect a given point, we want to know the distance from the line to the point. In this example, we want to know the distance of the dotted red line for points 3 and 4.</p><div class="mediaobject"><img src="../images/00026.jpeg" alt="Simple linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">If we add up the distance of all of the dotted red lines and divide by the number of total points on our graph, we have a pretty good idea of how well this line represents the plot. If we are then given a number that is on our graph, we can make a prediction about where it will land. For example, if we are given another 2, we can predict that we will probably result in a 2. Not <a id="id56" class="calibre1"/>only that, we can make predictions about where the line is headed (slope) for inputs that we have not seen before. For example, if we input 6, we can guess that it will probably be close to 6.</p><p class="calibre6">In a real-word example, we typically don't have a single input for a given number. So, we might get a hundred 1s and 90% of the time the output will be 1, 5% of the time the output will be 1.25, and 5% of the time, the output will be 0.75. If we placed all the 100s on our scatter plot, we will see lots of points on 1 (or a really dark dot), some on 1.25, and some on 0.75. With this mental model in place, let's go ahead and create a simple linear regression from scratch.</p></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression">
<div class="book" title="Simple linear regression">
<div class="book" title="Setting up the environment"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec11" class="calibre1"/>Setting up the environment</h2></div></div></div><p class="calibre6">Open Visual Studio <a id="id57" class="calibre1"/>2015 and create a new F# Library:</p><div class="mediaobject"><img src="../images/00027.jpeg" alt="Setting up the environment" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Once Visual Studio finishes <a id="id58" class="calibre1"/>creating the project and files for you, go into the solution explorer, and open <code class="literal">Script1.fsx</code> and delete all the contents in the file. You should now have an empty script file ready for your code.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression">
<div class="book" title="Simple linear regression">
<div class="book" title="Preparing the test data"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec12" class="calibre1"/>Preparing the test data</h2></div></div></div><p class="calibre6">The first thing we will do<a id="id59" class="calibre1"/> is create a dataset that we can use in our regression that gives us predictable results. Create an array like this:</p><div class="informalexample"><pre class="programlisting">let input = [|1,1.;2,2.;3,2.25;4,4.75;5,5.|]</pre></div><p class="calibre6">Here, <code class="literal">input</code> is an array of tuples. A tuple is a data structure that contains groups of data that are unnamed—usually there are two items. The types do <span class="strong"><em class="calibre11">not</em></span> have to be the same as a tuple's items. If you are familiar with the concept of a key/value pair, you can use that as a mental model of a tuple. The only real "gotcha" is that tuples can have many items so this it is a perfectly valid tuple: <code class="literal">2,true,"dog"</code> where the first position is an <code class="literal">int</code>, the second is a Boolean, and the third is a string.</p><p class="calibre6">If you highlight our single line of code and send it to the REPL using <span class="strong"><em class="calibre11">Alt</em></span> + <span class="strong"><em class="calibre11">Enter</em></span>, you will get this back:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val input : (int * float) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(1, 1.0); (2, 2.0); (3, 2.25); (4, 4.75); (5, 5.0)|]</strong></span>
</pre></div><p class="calibre6">The F# compiler is telling us that we have an array that contains tuples of type <code class="literal">int</code> and <code class="literal">float</code>. In this example, we will use the first value of the tuples to be the <span class="strong"><em class="calibre11">X</em></span> and the second to be the <span class="strong"><em class="calibre11">Y</em></span> of our simple linear regression.</p><p class="calibre6">With the data set up, let's think <a id="id60" class="calibre1"/>about how to calculate a regression. A more mathematical definition than what I used earlier is <span class="strong"><em class="calibre11">y = A + Bx</em></span>, where <span class="strong"><em class="calibre11">A</em></span> is the <span class="strong"><em class="calibre11">Y</em></span> intercept of the line and <span class="strong"><em class="calibre11">B</em></span> is the slope of the line. Therefore, we need to figure out how to calculate the intercept of the line and the slope of the line. Turns out that we need to<a id="id61" class="calibre1"/> calculate the standard deviation of the <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span> values and something called the <span class="strong"><strong class="calibre7">Person's correlation</strong></span>. Let's tackle each one of these separately.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression">
<div class="book" title="Simple linear regression">
<div class="book" title="Standard deviation"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec13" class="calibre1"/>Standard deviation</h2></div></div></div><p class="calibre6">The best explanation of <a id="id62" class="calibre1"/>standard deviation that I have<a id="id63" class="calibre1"/> run across is at <a class="calibre1" href="http://www.mathsisfun.com/data/standard-deviation.html">http://www.mathsisfun.com/data/standard-deviation.html</a>.</p><p class="calibre6">Standard deviation is the square root of the variance; to calculate the variance:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Work out the mean (the simple average of the numbers).</li><li class="listitem" value="2">Then, for each number, subtract the mean and square the result (the squared difference).</li><li class="listitem" value="3">Then, work out the average of those squared differences.</li></ol><div class="calibre13"/></div><p class="calibre6">So, taking MathIsFun's explanation and<a id="id64" class="calibre1"/> applying it to F#, we can write:</p><div class="informalexample"><pre class="programlisting">let variance (source:float seq) =
    let mean = Seq.average source
    let deltas = Seq.map (fun x -&gt; pown (x-mean) 2) source
    Seq.average deltas</pre></div><p class="calibre6">Sending that to the REPL gives us:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val variance : source:seq&lt;float&gt; -&gt; float</strong></span>
</pre></div><p class="calibre6">Notice how there is a one-to-one correspondence between each line of the English explanation and the F# code. This is not an accident. F# is really great at matching your thought process. In fact, we even resisted to temptation to <code class="literal">for…each</code> in code when we saw those words in the English version.</p><p class="calibre6">There is some new F# code here that might be confusing. Notice that when I calculated the mean, I called the <code class="literal">Seq.average</code> function:</p><div class="informalexample"><pre class="programlisting"> Seq.average source</pre></div><p class="calibre6">And hence, the <code class="literal">source</code> argument came after the function. I could have just as well written:</p><div class="informalexample"><pre class="programlisting"> source |&gt; Seq.average</pre></div><p class="calibre6">This is something you will have<a id="id65" class="calibre1"/> seen before if you worked through <a class="calibre1" title="Chapter 1. Welcome to Machine Learning Using the .NET Framework" href="part0015_split_000.html#E9OE1-a18db0be6c20485ba81f22e43ca13055">Chapter 1</a>, <span class="strong"><em class="calibre11">Welcome to Machine Learning Using the .NET Framework</em></span>. There is really no consensus in the F# community about which way is more idiomatic, though the style guidelines argue for the non-pipe forward way. Since both are supported by the languages and widely used, I use both depending on<a id="id66" class="calibre1"/> the code. Typically, when I have a string of thoughts to push together I use the pipe operator, but if there is only one calculation, I just call the function directly. Notice that I did this <span class="strong"><em class="calibre11">after syntax</em></span> technique in all three lines: mean, deltas, and the return of the function.</p><p class="calibre6">With variance out of the way, we can make our standard deviation:</p><div class="informalexample"><pre class="programlisting">let standardDeviation values =
     sqrt (variance values)</pre></div><p class="calibre6">Sending that to the REPL gives us:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val standardDeviation : values:seq&lt;float&gt; -&gt; float</strong></span>
</pre></div><p class="calibre6">With the standard deviation ready, we can plug in our numbers. Since we will be calculating the standard deviation of <span class="strong"><em class="calibre11">X</em></span> and <span class="strong"><em class="calibre11">Y</em></span> independently, let's break the tuple apart into separate arrays and calculate their average and standard deviations:</p><div class="informalexample"><pre class="programlisting">let x = input |&gt; Seq.map (fun (x,y) -&gt; float x)
let y = input |&gt; Seq.map (fun (x,y) -&gt; y) 

let mX = Seq.average x
let mY = Seq.average y

let sX = standardDeviation x
let sY = standardDeviation y</pre></div><p class="calibre6">Sending that to the REPL gives us:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val x : seq&lt;float&gt;</strong></span>
<span class="strong"><strong class="calibre7">val y : seq&lt;float&gt;</strong></span>
<span class="strong"><strong class="calibre7">val mX : float = 3.0</strong></span>
<span class="strong"><strong class="calibre7">val mY : float = 3.0</strong></span>
<span class="strong"><strong class="calibre7">val sX : float = 1.414213562</strong></span>
<span class="strong"><strong class="calibre7">val sY : float = 1.589024858</strong></span>
</pre></div><p class="calibre6">There is one thing new here. Notice that when calculating <span class="strong"><em class="calibre11">x</em></span>, I used this syntax:</p><div class="informalexample"><pre class="programlisting">Seq.map(fun (x,y) -&gt; float x)</pre></div><p class="calibre6">With <code class="literal">float x</code> as the return. <code class="literal">float</code> is a function that casts the int into, well, a float. If you are coming from VB.NET/C#, the<a id="id67" class="calibre1"/> comparable <a id="id68" class="calibre1"/>syntax will be <code class="literal">(float)x</code>.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression">
<div class="book" title="Simple linear regression">
<div class="book" title="Pearson's correlation"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec14" class="calibre1"/>Pearson's correlation</h2></div></div></div><p class="calibre6">Next, let's calculate the Pearson's correlation. The best <a id="id69" class="calibre1"/>explanation I have found for it is available at <a class="calibre1" href="http://onlinestatbook.com/2/describing_bivariate_data/calculation.html">http://onlinestatbook.com/2/describing_bivariate_data/calculation.html</a>. You can think of creating the<a id="id70" class="calibre1"/> Pearson's correlation as filling in columns in an Excel spreadsheet and then<a id="id71" class="calibre1"/> doing some calculations on the column totals. Start a grid with <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span> in different rows:</p><div class="mediaobject"><img src="../images/00028.jpeg" alt="Pearson's correlation" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Then, calculate the mean for <span class="strong"><em class="calibre11">X</em></span> and <span class="strong"><em class="calibre11">Y</em></span>:</p><div class="mediaobject"><img src="../images/00029.jpeg" alt="Pearson's correlation" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, calculate <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span>. <span class="strong"><em class="calibre11">x</em></span> is calculated by subtracting the mean of <span class="strong"><em class="calibre11">X</em></span> from <span class="strong"><em class="calibre11">X</em></span> and <span class="strong"><em class="calibre11">y</em></span> is calculated by subtracting the mean of <span class="strong"><em class="calibre11">Y</em></span> from <span class="strong"><em class="calibre11">Y</em></span>:</p><div class="mediaobject"><img src="../images/00030.jpeg" alt="Pearson's correlation" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, fill in <span class="strong"><em class="calibre11">xy</em></span>, <span class="strong"><em class="calibre11">x</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>, and <span class="strong"><em class="calibre11">y</em></span>
<span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>:</p><div class="mediaobject"><img src="../images/00031.jpeg" alt="Pearson's correlation" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">With<a id="id72" class="calibre1"/> the grid<a id="id73" class="calibre1"/> filled in, you can sum up <span class="strong"><em class="calibre11">xy</em></span>, <span class="strong"><em class="calibre11">x<sup class="calibre17">2</sup></em></span>, and <span class="strong"><em class="calibre11">y<sup class="calibre17">2</sup></em></span>:</p><div class="mediaobject"><img src="../images/00032.jpeg" alt="Pearson's correlation" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">The final answer is computed by dividing the sum of the <span class="strong"><em class="calibre11">xy</em></span> column (<span class="strong"><em class="calibre11">Σxy</em></span>) by the square root of the product of the sum of the <span class="strong"><em class="calibre11">x<sup class="calibre17">2</sup></em></span> column (<span class="strong"><em class="calibre11">Σx</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>) and the sum of the <span class="strong"><em class="calibre11">y</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span> column (<span class="strong"><em class="calibre11">Σy</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>). So, in our example, it will be:</p><div class="informalexample"><pre class="programlisting">10.75/ √(10 * 12.63)</pre></div><p class="calibre6">I now want to<a id="id74" class="calibre1"/> repeat these steps without that grid in English:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Calculate the mean for <span class="strong"><em class="calibre11">X</em></span>.</li><li class="listitem" value="2">Calculate the mean for <span class="strong"><em class="calibre11">Y</em></span>.</li><li class="listitem" value="3">Calculate <span class="strong"><em class="calibre11">x</em></span>.</li><li class="listitem" value="4">Calculate <span class="strong"><em class="calibre11">y</em></span>.</li><li class="listitem" value="5">Fill in <span class="strong"><em class="calibre11">xy</em></span>, <span class="strong"><em class="calibre11">x</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>, and <span class="strong"><em class="calibre11">y</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>.</li><li class="listitem" value="6">Sum up <span class="strong"><em class="calibre11">y</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>.</li><li class="listitem" value="7">Sum up <span class="strong"><em class="calibre11">x</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>.</li><li class="listitem" value="8">Sum up <span class="strong"><em class="calibre11">y</em></span><span class="strong"><em class="calibre11"><sup class="calibre17">2</sup></em></span>.</li><li class="listitem" value="9">Do the final formula.</li></ol><div class="calibre13"/></div><p class="calibre6">And this is how I <a id="id75" class="calibre1"/>would write it in F#:</p><div class="informalexample"><pre class="programlisting">let pearsonsCorrelation(a:float seq, b:float seq) =
    let mX = Seq.average a
    let mY = Seq.average b

    let x = a |&gt; Seq.map (fun x -&gt; x - mX)
    let y = b |&gt; Seq.map (fun y -&gt; y - mY)

    let xys = Seq.zip x y
    let xy = xys |&gt; Seq.map (fun (x, y) -&gt; x*y, x*x, y*y)
    let sxy = xy |&gt; Seq.sumBy (fun (xy, x2, y2) -&gt; xy)
    let sx2 = xy |&gt; Seq.sumBy (fun (xy, x2, y2) -&gt; x2)
    let sy2 = xy |&gt; Seq.sumBy (fun (xy, x2, y2) -&gt; y2)
    sxy / sqrt (sx2*sy2)</pre></div><p class="calibre6">Sending that to the REPL gives us:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val pearsonsCorrelation : a:seq&lt;float&gt; * b:seq&lt;float&gt; -&gt; float</strong></span>
</pre></div><p class="calibre6">Again, you can see that there is almost a one-to-one correspondence between the formula and the code. There are a couple of things to note.</p><p class="calibre6"><code class="literal">Seq.zip x y</code> is a function that takes in two sequences of equal length and combines them together into a single tuple. So for <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span> zipped:</p><div class="mediaobject"><img src="../images/00033.jpeg" alt="Pearson's correlation" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Another thing to notice<a id="id76" class="calibre1"/> is that there is a three-item tuple being used in the <code class="literal">Seq.SumBys</code>. Each item of the tuple represents a different column in the grid we were filling out: <span class="strong"><em class="calibre11">xy</em></span>, <span class="strong"><em class="calibre11">x<sup class="calibre17">2</sup></em></span>, and <span class="strong"><em class="calibre11">y<sup class="calibre17">2</sup></em></span>. Although I normally don't like<a id="id77" class="calibre1"/> to create tuples greater than two items, I can make an exception in this case because I am only using the tuple in the context of these higher-order functions. Because the data structure is contained and short-lived, a tuple is the best choice. If I needed that data structure outside of the higher-order function, a record type would have been more appropriate. We'll get more exposure to a record type later in this chapter.</p><p class="calibre6">A final thing to notice is the <code class="literal">Seq.sumBy</code> higher-ordered function. As you may expect, <code class="literal">sumBy</code> computes the sum of things. The key thing to realize is that the <code class="literal">sumBy</code> expects a function to be passed, not a data structure. If you just want to sum up the values in an array, you can use the <code class="literal">Seq.sum()</code> function:</p><div class="informalexample"><pre class="programlisting">Seq.sum ([1;2;3])
val it : int = 6

Seq.sumBy ([1;2;3])
Does not compile

Seq.sumBy (fun i -&gt; i) [1;2;3]
val it : int = 6</pre></div><p class="calibre6">And so to run a Pearson's correlation for <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span>, type this into the script:</p><div class="informalexample"><pre class="programlisting">let r = pearsonsCorrelation (x,y)</pre></div><p class="calibre6">Sending that to the REPL gives us:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val r : float = 0.9567374429</strong></span>
</pre></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;AdventureWorks Regression">
<div class="book" title="Simple linear regression">
<div class="book" title="Linear regression"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch02lvl2sec15" class="calibre1"/>Linear regression</h2></div></div></div><p class="calibre6">With standard deviation and<a id="id78" class="calibre1"/> <code class="literal">r</code> calculated, we are ready for our linear regression:</p><div class="informalexample"><pre class="programlisting">let b = r*(sY/sX)
let A = mY - b*mX
val b : float = 1.075
val A : float = -0.225</pre></div><p class="calibre6">What these two values mean is that our <span class="strong"><em class="calibre11">y</em></span> intercept is <code class="literal">-.22</code>, or very close to the origin, and our slope is <code class="literal">1.075</code>. Laying them out on the same grid, you can see that the predicted numbers are close to the actual:</p><div class="mediaobject"><img src="../images/00034.jpeg" alt="Linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">These are still different enough on the plot that we eye-balled earlier with the red line going directly through 1, 2, 3, 4, 5 (solid line) and the regression line taking a slightly different path (dashed line):</p><div class="mediaobject"><img src="../images/00035.jpeg" alt="Linear regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">We will revisit how good this regression is at describing our data (and making predictions) in a bit. Until then, we can safely say that we have a regression, which seems to fit our data pretty well.</p><p class="calibre6">We now have a library we could compile for our AdventureWorks problem. However, we may not want to roll our own because this is a fairly limited implementation. For example, when we <a id="id79" class="calibre1"/>calculated variance and standard deviation, we were using the formula for the variance and standard deviation for an entire population. If we had only a small sample of the population, there is a different formula that we will implement. Also, linear regressions have several parameters that we can enter to try and <span class="strong"><em class="calibre11">tune up</em></span> the model in our implementation. As you can guess, there is quite a bit of effort in writing your own library, and you still may not get it right. If you were wondering in the middle of the prior exercise of rolling our own, "is there an easier way?" The answer is "yes."</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Math.NET" id="NQU21-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec18" class="calibre1"/>Math.NET</h1></div></div></div><p class="calibre6">We had a brief introduction<a id="id80" class="calibre1"/> to Math.Net in <a class="calibre1" title="Chapter 1. Welcome to Machine Learning Using the .NET Framework" href="part0015_split_000.html#E9OE1-a18db0be6c20485ba81f22e43ca13055">Chapter 1</a>, <span class="strong"><em class="calibre11">Welcome to Machine Learning Using the .NET Framework</em></span>. In this section, we will add it to our project and see how it can help us do a simple linear regression. In the solution explorer of your open project, add a new script file and name it <code class="literal">MathDotNet.fsx</code>.</p><p class="calibre6">Next, open the NuGet Package Manager Console (<span class="strong"><strong class="calibre7">Tools</strong></span> | <span class="strong"><strong class="calibre7">NuGet Package Manger</strong></span> | <span class="strong"><strong class="calibre7">Package Manager Console</strong></span>):</p><div class="mediaobject"><img src="../images/00036.jpeg" alt="Math.NET" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In the console, enter the following line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; install-package MathNet.Numerics</strong></span>
</pre></div><p class="calibre6">You will see that the <a id="id81" class="calibre1"/>package installs successfully:</p><div class="mediaobject"><img src="../images/00037.jpeg" alt="Math.NET" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Close the Package Manager Console and the <code class="literal">readme.txt</code> file that opens when you install Math.NET. In the future, I will assume that you know how to open and enter commands to install NuGet packages.</p></div>

<div class="book" title="Math.NET" id="NQU21-a18db0be6c20485ba81f22e43ca13055">
<div class="book" title="Regression try 1"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec16" class="calibre1"/>Regression try 1</h2></div></div></div><p class="calibre6">In the script file, create<a id="id82" class="calibre1"/> the same input that we saw in the hand-rolled script and calculate the means of <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span>:</p><div class="informalexample"><pre class="programlisting">let input = [|1,1.;2,2.;3,2.25;4,4.75;5,5.|]

let x = input |&gt; Array.map(fun (x,y) -&gt; float x)
let y = input |&gt; Array.map(fun (x,y) -&gt; y) 
let mX = Array.average x
let mY = Array.average y </pre></div><p class="calibre6">The following is the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val input : (int * float) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(1, 1.0); (2, 2.0); (3, 2.25); (4, 4.75); (5, 5.0)|]</strong></span>
<span class="strong"><strong class="calibre7">val x : float [] = [|1.0; 2.0; 3.0; 4.0; 5.0|]</strong></span>
<span class="strong"><strong class="calibre7">val y : float [] = [|1.0; 2.0; 2.25; 4.75; 5.0|]</strong></span>
<span class="strong"><strong class="calibre7">val mX : float = 3.0</strong></span>
<span class="strong"><strong class="calibre7">val mY : float = 3.0</strong></span>
</pre></div><p class="calibre6">Then, point to the Math.NET library installed with the nugget package and add a reference to it:</p><div class="informalexample"><pre class="programlisting">#r "../packages/MathNet.Numerics.3.8.0/lib/net40/MathNet.Numerics.dll"
open MathNet.Numerics.Statistics</pre></div><p class="calibre6">Next, use Math.Net to calculate the standard deviation of <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span>:</p><div class="informalexample"><pre class="programlisting">let sX = ArrayStatistics.StandardDeviation x
let sY = ArrayStatistics.StandardDeviation y</pre></div><p class="calibre6">The preceding code statements will give you:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val sX : float = 1.58113883</strong></span>
<span class="strong"><strong class="calibre7">val sY : float = 1.7765838</strong></span>
</pre></div><p class="calibre6">Finally, use Math.Net to calculate the <code class="literal">r</code>:</p><div class="informalexample"><pre class="programlisting">let r = Correlation.Pearson (x,y)</pre></div><p class="calibre6">The following will be the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val r : float = 0.9567374429</strong></span>
</pre></div><p class="calibre6">Now, you can calculate the regression:</p><div class="informalexample"><pre class="programlisting">let b = r*(sY/sX)
let A = mY - b*mX</pre></div><p class="calibre6">And here is what you will get in the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val b : float = 1.075</strong></span>
<span class="strong"><strong class="calibre7">val A : float = -0.225</strong></span>
</pre></div><p class="calibre6">There is one new thing I want to point out in the script. You had to type:</p><div class="informalexample"><pre class="programlisting">#r "../packages/MathNet.Numerics.3.8.0/lib/net40/MathNet.Numerics.dll"
open MathNet.Numerics.Statistics</pre></div><p class="calibre6">The <code class="literal">#r</code> stands for reference and points the FSI to the filesystem to locate the assembly that we want to use. The FSI loads with very few libraries installed, so you typically have to add a reference the ones you need. Notice the <code class="literal">".."</code> shorthand as the prefix for the file path. This is a relative locator that translates into the solution location.</p><p class="calibre6">The <code class="literal">open</code> command tells the FSI to open up the <code class="literal">.dll</code> file that we pointed to in the previous line. This is the same as <code class="literal">using</code> in C#, <code class="literal">Imports</code> in VB.NET, and <code class="literal">library</code> in R.</p><p class="calibre6">So, this is a much easier way to calculate the components of a simple linear regression than by hand. But wait, there is even more.</p></div></div>

<div class="book" title="Math.NET" id="NQU21-a18db0be6c20485ba81f22e43ca13055">
<div class="book" title="Regression try 2"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec17" class="calibre1"/>Regression try 2</h2></div></div></div><p class="calibre6">Math.NET makes it even easier to<a id="id83" class="calibre1"/> calculate the regression without going into the components. In the script, enter the following code:</p><div class="informalexample"><pre class="programlisting">open MathNet.Numerics
let fit = Fit.Line(x,y)
let i = fst fit
let s = snd fit</pre></div><p class="calibre6">You will get the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val fit : float * float = (-0.225, 1.075)</strong></span>
<span class="strong"><strong class="calibre7">val i : float = -0.225</strong></span>
<span class="strong"><strong class="calibre7">val s : float = 1.075</strong></span>
</pre></div><p class="calibre6"><code class="literal">Math.Numerics</code> already has the regression available via the <code class="literal">Fit()</code> function. <code class="literal">Fit()</code> takes in two arrays (in our case, <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span>) and returns a tuple. The first item of the tuple is the intercept and the second is the slope. The only new code that I introduced here are the <code class="literal">fst</code> and <code class="literal">snd</code> operators. These are shorthand notations for tuples that have a length of two. Calling <code class="literal">fst</code> on a tuple returns the first item and <code class="literal">snd</code> returns the second. If you call <code class="literal">fst</code> and <code class="literal">snd</code> on a tuple that has more than two items, you will get a type mismatch compiler error.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Accord.NET"><div class="book" id="OPEK2-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec19" class="calibre1"/>Accord.NET</h1></div></div></div><p class="calibre6">With Math.NET doing all of our<a id="id84" class="calibre1"/> heavy lifting, we have a better way to get the results of a simple linear regression. However, there is another way I want to discuss, Accord.NET. Open the NuGet Package Manager and install the following three packages:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Accord</li><li class="listitem">Accord.Statistics</li><li class="listitem">FSharp.Data</li></ul></div><p class="calibre6">Note that you will<a id="id85" class="calibre1"/> get a pop-up window when you install FSharp.Data:</p><div class="mediaobject"><img src="../images/00038.jpeg" alt="Accord.NET" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Click on <span class="strong"><strong class="calibre7">Enable</strong></span>.</p></div>

<div class="book" title="Accord.NET">
<div class="book" title="Regression"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec18" class="calibre1"/>Regression</h2></div></div></div><p class="calibre6">Back in the script file, enter<a id="id86" class="calibre1"/> the following lines of code:</p><div class="informalexample"><pre class="programlisting">#r "../packages/Accord.3.0.2/lib/net40/Accord.dll"
#r "../packages/Accord.Statistics.3.0.2/lib/net40/Accord.Statistics.dll"
#r "../packages/Accord.Math.3.0.2/lib/net40/Accord.Math.dll"

open Accord
open Accord.Statistics.Models.Regression.Linear

let input = [|1,1.;2,2.;3,2.25;4,4.75;5,5.|]
let x = input |&gt; Array.map (fun (x,y) -&gt; float x)
let y = input |&gt; Array.map (fun (x,y) -&gt; y) let regression = SimpleLinearRegression()
let sse = regression.Regress(x,y)
let intercept = regression.Intercept
let slope = regression.Slope
let mse = sse/float x.Length 
let rmse = sqrt mse
let r2 = regression.CoefficientOfDetermination(x,y)</pre></div><p class="calibre6">When you send this to the REPL, you will see the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val input : (int * float) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(1, 1.0); (2, 2.0); (3, 2.25); (4, 4.75); (5, 5.0)|]</strong></span>
<span class="strong"><strong class="calibre7">val x : float [] = [|1.0; 2.0; 3.0; 4.0; 5.0|]</strong></span>
<span class="strong"><strong class="calibre7">val y : float [] = [|1.0; 2.0; 2.25; 4.75; 5.0|]</strong></span>
<span class="strong"><strong class="calibre7">val regression : SimpleLinearRegression = y(x) = 1.075x + -0.224999999999998</strong></span>
<span class="strong"><strong class="calibre7">val sse : float = 1.06875</strong></span>
<span class="strong"><strong class="calibre7">val intercept : float = -0.225</strong></span>
<span class="strong"><strong class="calibre7">val slope : float = 1.075</strong></span>
<span class="strong"><strong class="calibre7">val mse : float = 0.21375</strong></span>
<span class="strong"><strong class="calibre7">val rmse : float = 0.4623310502</strong></span>
<span class="strong"><strong class="calibre7">val r2 : float = 0.9153465347</strong></span>
</pre></div><p class="calibre6">What you see here is the <a id="id87" class="calibre1"/>exact same calculation as before with the formula kindly printed out (I have rounded it to three decimal places):</p><div class="informalexample"><pre class="programlisting">y(x) = 1.075x + -0.225</pre></div></div></div>

<div class="book" title="Accord.NET">
<div class="book" title="Regression evaluation using RMSE"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec19" class="calibre1"/>Regression evaluation using RMSE</h2></div></div></div><p class="calibre6">Accord.NET goes one<a id="id88" class="calibre1"/> better than Math.NET <code class="literal">Fit()</code> as it returns the sum of the squared errors and the coefficient of determination (called r squared). In<a id="id89" class="calibre1"/> this case, the sum of squared errors is <code class="literal">1.06875</code> and the r squared is <code class="literal">0.915</code> (rounded to three decimal places). This is great because we now have two vital pieces of information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">A model to predict</li><li class="listitem">Some way to help us evaluate how good the model is at predicting</li></ul></div><p class="calibre6">In machine learning, it is not enough to simply implement a model and get some answers. We also have to be able to speak to know how good our answer really is. The <span class="strong"><strong class="calibre7">sum of squares error</strong></span>, often called <span class="strong"><strong class="calibre7">SSE</strong></span>, is a<a id="id90" class="calibre1"/> common way to evaluate a simple linear regression. To start thinking about SSE, we need to know two pieces of information for each <span class="strong"><em class="calibre11">y</em></span> that we used—what we guessed and what the actual value is. Using our existing dataset:</p><div class="mediaobject"><img src="../images/00039.jpeg" alt="Regression evaluation using RMSE" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">You can see that the model was created based on all of the <span class="strong"><em class="calibre11">y</em></span> data points, and then Accord.NET went back and checked how close that model <span class="strong"><em class="calibre11">fits</em></span> each data point. These differences are squared, then the squared values are summed. The goal is to get the sums of squares as low as<a id="id91" class="calibre1"/> possible. Once we have the SSE, we can change our model to try to get the sum of squares lower. For example, what if <a id="id92" class="calibre1"/>we changed the slope from <code class="literal">1.075x</code> to <code class="literal">1.000x</code>, which is what we were eyeballing earlier?</p><div class="mediaobject"><img src="../images/00040.jpeg" alt="Regression evaluation using RMSE" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Since we have all five data points that are available for the initial model calculation, you are not going to improve on the model by making manual changes like this. The original regression is the best way of describing the relationship among these five data points. It is important to note that the SSE is a context-free measure. This means 1.069 does not have any value in and of itself. We only know that 1.069 is better than 1.367. Basically, we want the SSE to be as low as possible.</p><p class="calibre6">A slightly better variation of the SSE is the <a id="id93" class="calibre1"/>
<span class="strong"><strong class="calibre7">Mean Square Error</strong></span> (<span class="strong"><strong class="calibre7">MSE</strong></span>). The MSE is the SSE divided by the number of observations of the regression:</p><div class="mediaobject"><img src="../images/00041.jpeg" alt="Regression evaluation using RMSE" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In this case, the MSE is <code class="literal">0.2138</code>. Like the MSE, the number itself is not particularly useful. However, if we take the<a id="id94" class="calibre1"/> square root of the MSE, often called the <span class="strong"><strong class="calibre7">Root Of Mean Square Error</strong></span>, or <span class="strong"><strong class="calibre7">RMSE</strong></span>, the result is an error measure in the same units as our original numbers.</p><div class="informalexample"><pre class="programlisting">RMSE = Square Root of MSE = sqrt(.2137) = .462</pre></div><p class="calibre6">In our case, the RMSE is <code class="literal">0.462</code> means that any given guess is likely off by 0.46. When you talk to other data scientists at your next cocktail party (you do go to cocktail parties with data scientists, don't you?), you will typically use the RMSE when evaluating the predictive capabilities of a simple linear model.</p><p class="calibre6">Using the RMSE, we<a id="id95" class="calibre1"/> now have a measure of how accurate our model is when predicting values. We also have a second measure, called the r2, that calculates how much correlation our model has. The r2 takes the r (in this case, Pearson's correlation) and squares it. The r2 is always between zero and one, with zero meaning that there is no correlation between <span class="strong"><em class="calibre11">x</em></span> and <span class="strong"><em class="calibre11">y</em></span> and one meaning that the regression line perfectly fits the data. In practical terms, we want a low as possible RMSE with a high as possible r2.</p></div></div>

<div class="book" title="Accord.NET">
<div class="book" title="Regression and the real world"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec20" class="calibre1"/>Regression and the real world</h2></div></div></div><p class="calibre6">So far, we really haven't done<a id="id96" class="calibre1"/> any machine learning, in that we can't make our model any better. The initial regression is the best and explains 91.5% of the data. However, the world does not work in such a straightforward manner.</p><p class="calibre6">The challenge is that we will start applying a simple linear regression on a dataset that represents human activity (in our case, AdventureWorks sales), and human activity is fraught with uncertainty. Consider a more realistic data frame with a product, its list price, and its customer reviews:</p><div class="mediaobject"><img src="../images/00042.jpeg" alt="Regression and the real world" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Notice that the rating<a id="id97" class="calibre1"/> seems to have some wide variance. Some customers gave the bike a 5 while others gave it a 1 or 2. You would think for the same product, the average reviews would be fairly similar. Perhaps we have a problem with manufacturing quality or perhaps the price is such that low-end customers expect more from what they perceive to be a very expensive bike and high-end customers are thrilled with the value they got from what they perceive to be a low-cost bike. Now can we start with our model? Yes! Let's take the data from AdventureWorks and see how it stacks up with an initial model using Accord.NET.</p></div></div>

<div class="book" title="Accord.NET">
<div class="book" title="Regression against actual data"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec21" class="calibre1"/>Regression against actual data</h2></div></div></div><p class="calibre6">As this is the first time we are using AdventureWorks, there are a couple of housekeeping items we<a id="id98" class="calibre1"/> need to take care of. We will be using the <a id="id99" class="calibre1"/>AdventureWorks 2014 full database found at <a class="calibre1" href="https://msftdbprodsamples.codeplex.com/releases/view/125550">https://msftdbprodsamples.codeplex.com/releases/view/125550</a>. If you want to bring the data locally, you can do that by restoring the <code class="literal">.bak</code> file from their website. If you go this route, note that I added some additional data to the <code class="literal">Production.ProductReview</code> table for this chapter. You will need to run the <code class="literal">populateProductReview.sql</code> script found in this chapter's GitHub repository after your database is installed to match the examples found in the book. In addition, you will have to generate your own connection string. If you just want to use the data on our server, you can use the connection string that is in the upcoming code sample.</p><p class="calibre6">You might be thinking that I am nuts to put a connection string out in the public domain like this. First, don't tell anyone you have it. Second, if by some stroke of fortune millions of people buy this book and they all pound on this server to do the examples, I will be happy to pay Microsoft more $$ for the compute time.</p><p class="calibre6">In Visual Studio, add <a id="id100" class="calibre1"/>a new script to your project and call it <code class="literal">AccordDotNet2.fsx</code>. Then, add the following references and open the script file:</p><div class="informalexample"><pre class="programlisting">#r "System.Transactions.dll"
#r "../packages/Accord.3.0.2/lib/net40/Accord.dll"
#r "../packages/Accord.Statistics.3.0.2/lib/net40/Accord.Statistics.dll"
#r "../packages/Accord.Math.3.0.2/lib/net40/Accord.Math.dll"
#r "../packages/FSharp.Data.2.2.5/lib/net40/FSharp.Data.dll"

open Accord
open Accord.Statistics
open Accord.Statistics.Models.Regression.Linear

open System
open System.Data.SqlClient</pre></div><p class="calibre6">Next, add a record type, a list of that record type, a connection string, and a query:</p><div class="informalexample"><pre class="programlisting">type ProductReview = {ProductID:int; TotalOrders:float; AvgReviews:float}

let reviews = ResizeArray&lt;ProductReview&gt;()

[&lt;Literal&gt;]
let connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=AdventureWorks2014;user id=chickenskills@nc54a9m5kk;password=sk1lzm@tter;"

[&lt;Literal&gt;]
let query = "Select 
                A.ProductID, TotalOrders, AvgReviews
                From
                (Select 
                ProductID,
                Sum(OrderQty) as TotalOrders
                from [Sales].[SalesOrderDetail] as SOD
                inner join [Sales].[SalesOrderHeader] as SOH
                on SOD.SalesOrderID = SOH.SalesOrderID
                inner join [Sales].[Customer] as C
                on SOH.CustomerID = C.CustomerID
                Where C.StoreID is not null
                Group By ProductID) as A
                Inner Join 
                (Select
                ProductID,
                (Sum(Rating) + 0.0) / (Count(ProductID) + 0.0) as AvgReviews
                from [Production].[ProductReview] as PR
                Group By ProductID) as B
                on A.ProductID = B.ProductID"</pre></div><p class="calibre6">There are three new language features here. The first is a record type called <code class="literal">ProductReview</code>. Record types are immutable named data structures and stand in contrast to tuples, which are unnamed. You can think of a record type as an immutable DTO/POCO that you<a id="id101" class="calibre1"/> might encounter in the VB.NET/C# world. <code class="literal">ProductReview</code> has three members: <code class="literal">ProductId</code>, <code class="literal">TotalOrders</code>, and <code class="literal">AvgReviews</code>. You can think of these members as properties of a POCO in the C#/VB.NET world.</p><p class="calibre6">The second new language feature is the attribute added to the <code class="literal">connectionString</code> and query values. Most .NET developers are familiar with attributes, so you should be comfortable using them. By making <code class="literal">connectionString</code> and query literal, I can pass them into type providers in the script file.</p><p class="calibre6">Finally, we will use a <code class="literal">ResizeArray</code> datatype to keep our <code class="literal">seq</code> of product reviews. Because arrays are immutable in F# and we don't know how many reviews we will be getting back from the database, we need to use a special array that does allow resizing. This is equivalent to <code class="literal">System.Collections.Generic.List&lt;&gt;</code> that you might be familiar with in your C#/VB.NET code.</p><p class="calibre6">Next, add some ADO.Net code to extract the data from the database and put it into the list:</p><div class="informalexample"><pre class="programlisting">let connection = new SqlConnection(connectionString)
let command = new SqlCommand(query,connection)
connection.Open()
let reader = command.ExecuteReader()
while reader.Read() do
    reviews.Add({ProductID=reader.GetInt32(0);TotalOrders=(float)(reader.GetInt32(1));AvgReviews=(float)(reader.GetDecimal(2))})</pre></div><p class="calibre6">This code should be familiar to most .Net developers. Sending it to the REPL, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">type ProductReview =</strong></span>
<span class="strong"><strong class="calibre7">  {ProductID: int;</strong></span>
<span class="strong"><strong class="calibre7">   TotalOrders: float;</strong></span>
<span class="strong"><strong class="calibre7">   AvgReviews: float;}</strong></span>
<span class="strong"><strong class="calibre7">val reviews : System.Collections.Generic.List&lt;ProductReview&gt;</strong></span>
<span class="strong"><strong class="calibre7">val connectionString : string =</strong></span>
<span class="strong"><strong class="calibre7">  "data source=nc54a9m5kk.database.windows.net;initial catalog=A"+[72 chars]</strong></span>
<span class="strong"><strong class="calibre7">val query : string =</strong></span>
<span class="strong"><strong class="calibre7">  "Select </strong></span>
<span class="strong"><strong class="calibre7">                A.ProductID, AvgOrders, AvgReviews</strong></span>
<span class="strong"><strong class="calibre7">  "+[814 chars]</strong></span>
<span class="strong"><strong class="calibre7">val connection : System.Data.SqlClient.SqlConnection =</strong></span>
<span class="strong"><strong class="calibre7">  System.Data.SqlClient.SqlConnection</strong></span>
<span class="strong"><strong class="calibre7">val command : System.Data.SqlClient.SqlCommand =</strong></span>
<span class="strong"><strong class="calibre7">  System.Data.SqlClient.SqlCommand</strong></span>
<span class="strong"><strong class="calibre7">val reader : System.Data.SqlClient.SqlDataReader</strong></span>
<span class="strong"><strong class="calibre7">val it : unit = ()</strong></span>
</pre></div><p class="calibre6">With the data coming down, let's see if our models reflect what our manager noticed in the power <code class="literal">bi'</code> charting:</p><div class="informalexample"><pre class="programlisting">let x = reviews |&gt; Seq.map (fun pr -&gt; pr.AvgReviews) |&gt; Seq.toArray
let y = reviews |&gt; Seq.map (fun pr -&gt; pr.TotalOrders) |&gt; Seq.toArray
let regression = SimpleLinearRegression()
let sse = regression.Regress(x,y)
let mse = sse/float x.Length 
let rmse = sqrt mse
let r2 = regression.CoefficientOfDetermination(x,y)</pre></div><p class="calibre6">You will see the<a id="id102" class="calibre1"/> following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val regression : SimpleLinearRegression =</strong></span>
<span class="strong"><strong class="calibre7">  y(x) = 1277.89025884053x + -4092.62506538369</strong></span>
<span class="strong"><strong class="calibre7">val sse : float = 39480886.74</strong></span>
<span class="strong"><strong class="calibre7">val mse : float = 203509.7254</strong></span>
<span class="strong"><strong class="calibre7">val rmse : float = 451.1205221</strong></span>
<span class="strong"><strong class="calibre7">val r2 : float = 0.2923784167</strong></span>
</pre></div><p class="calibre6">We now see a <code class="literal">0.29 r2</code> and a <code class="literal">451 rmse</code>, which shows a weak relationship between customer reviews and order quantity and that there is a 450 order margin of error.</p><p class="calibre6">Another point is that<a id="id103" class="calibre1"/> simple linear regressions tend to have a problem with outliers. We'll have a lot to say about this topic in the next chapter. Also, by doing a one-shot analysis, we have a large problem with over-fitting. We'll be talking about over-fitting extensively in <a class="calibre1" title="Chapter 8. Feature Selection and Optimization" href="part0049_split_000.html#1ENBI2-a18db0be6c20485ba81f22e43ca13055">Chapter 8</a>, <span class="strong"><em class="calibre11">Feature Selection and Optimization</em></span>. For now, I just wanted to acknowledge that although we have a pretty good model, it is far from perfect. However, it is still better than eyeballing a chart and it does have some statistical validity. We now have a model and we can predict some sales. How do we put this in production?</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="AdventureWorks app"><div class="book" id="PNV62-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec20" class="calibre1"/>AdventureWorks app</h1></div></div></div><p class="calibre6">We will start by thinking about how we want to prevent users from abandoning orders based on low product<a id="id104" class="calibre1"/> reviews. One option would be to drop the review entirely. While this will prevent that undesirable effect of people dropping orders because of a low rating, it also prevents the desirable effect of people purchasing items based on a high rating. We could also hide the ratings for low-score items, but that would be seen through very easily. Another possibility is to lower the price of low-rated products, but lowering prices is anathema to most companies. Perhaps a better way is to have our site have knowledge of low-rated products and give people an incentive to order them by prefilling the amount that most people order for that given review. Consumer behaviorists have demonstrated that if you prefill a quantity, the consumer is less likely to abandon their purchase.</p></div>

<div class="book" title="AdventureWorks app">
<div class="book" title="Setting up the environment"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec22" class="calibre1"/>Setting up the environment</h2></div></div></div><p class="calibre6">Go get a copy of <a id="id105" class="calibre1"/>AdventureWorks UI from GitHub at this uri. Next, open the copy using Visual Studio 2015.</p><p class="calibre6">Now, follow these steps, which will guide you to set up the environment:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Let's go into our <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add an F# project (<span class="strong"><strong class="calibre7">File</strong></span> | <span class="strong"><strong class="calibre7">New Project</strong></span>).<div class="mediaobject"><img src="../images/00043.jpeg" alt="Setting up the environment" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="2">Delete the script file<a id="id106" class="calibre1"/> and rename <code class="literal">Library1.fs</code> to <code class="literal">OrderPrediction.fs</code>.<div class="mediaobject"><img src="../images/00044.jpeg" alt="Setting up the environment" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="3">Open NuGet Package Manager and install Accord.NET to the F# project:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; install-package Accord</strong></span>
<span class="strong"><strong class="calibre7">PM&gt; install-package Accord.Statistics</strong></span>
</pre></div></li><li class="listitem" value="4">Make sure that the default project is <code class="literal">AdventureWorks.MachineLearning</code>:<div class="mediaobject"><img src="../images/00045.jpeg" alt="Setting up the environment" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="5">Open up <code class="literal">OrderPrediction.fs</code> and rename <code class="literal">Class1</code> to <code class="literal">OrderPrediction</code>.<div class="informalexample"><pre class="programlisting">namespace AdventureWorks.MachineLearning

type OrderPrediction() = 
    member this.X = "F#"</pre></div></li><li class="listitem" value="6">Then, rename <code class="literal">X</code> to <code class="literal">PredictQuantity</code> with a single integer parameter of <code class="literal">ProductId</code> and a<a id="id107" class="calibre1"/> return value of a float. For now, make it <code class="literal">0.0</code>. Make the type public.<div class="informalexample"><pre class="programlisting">namespace AdventureWorks.MachineLearning

type public OrderPrediction() = 
    member this.PredictQuantity(productId:int) = 0.0</pre></div></li><li class="listitem" value="7">Compile the F# project.</li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="AdventureWorks app">
<div class="book" title="Updating the existing web project"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec23" class="calibre1"/>Updating the existing web project</h2></div></div></div><p class="calibre6">Next, go to the C# project in<a id="id108" class="calibre1"/> the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add a reference to the F# project:</p><div class="mediaobject"><img src="../images/00046.jpeg" alt="Updating the existing web project" class="calibre8"/></div><p class="calibre9"> </p><div class="mediaobject"><img src="../images/00047.jpeg" alt="Updating the existing web project" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Go into <a id="id109" class="calibre1"/>
<code class="literal">PurchaseOrderDetailsController.cs</code> and add a <code class="literal">using</code> statement to <code class="literal">AdventureWorks.MachineLearning</code>:</p><div class="mediaobject"><img src="../images/00048.jpeg" alt="Updating the existing web project" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, create an endpoint that can take in a <code class="literal">productId</code> and predict the quantity of the order:</p><div class="informalexample"><pre class="programlisting">        // GET: PurchaseOrderDetails/PredictQuantity/1
        public Int32 PredictQuantity(int id)
        {
            var orderPrediction = new OrderPrediction();
            return (Int32)orderPrediction.PredictQuantity(id);
        }</pre></div><p class="calibre6">Forgive me that this is<a id="id110" class="calibre1"/> RPC and not very RESTful. The intention of this exercise is about machine learning and not web development. If you want to rewrite, this is a more MVC idiomatic form, feel free.</p><p class="calibre6">With the controller set up, hop over to the Create view:</p><div class="mediaobject"><img src="../images/00049.jpeg" alt="Updating the existing web project" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Add the following<a id="id111" class="calibre1"/> JavaScript at the bottom of the page in the <code class="literal">@section Scripts</code> block:</p><div class="informalexample"><pre class="programlisting">@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
&lt;script type="text/javascript"&gt;
        $(document).ready(function(){
            $("#ProductID").change(function(){
                var productID = $(this).val();
                $.get("/PurchaseOrderDetails/PredictQuantity/" + productID, function(result){
                    $("#OrderQty").val(result);
                });
            });
        });
&lt;/script&gt;
}</pre></div><p class="calibre6">With that in place, you should be able to run the project and after selecting a new product from the dropdown, the order quantity should populate with a <code class="literal">0.0</code>.</p><div class="mediaobject"><img src="../images/00050.jpeg" alt="Updating the existing web project" class="calibre8"/></div><p class="calibre9"> </p></div></div>

<div class="book" title="AdventureWorks app">
<div class="book" title="Implementing the regression"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec24" class="calibre1"/>Implementing the regression</h2></div></div></div><p class="calibre6">With the app wired up, let's hop back<a id="id112" class="calibre1"/> to the F# project and implement the prediction for real. First, make sure that you have a reference to <code class="literal">System.Data</code>.</p><div class="mediaobject"><img src="../images/00051.jpeg" alt="Implementing the regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, open up <code class="literal">OrderPrediction.fs</code> and enter this in the following code:</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip04" class="calibre1"/>Tip</h3><p class="calibre6">Since this is (almost) verbatim from the REPL project, you can go ahead with copying and pasting if you want to avoid some typing.</p></div><div class="informalexample"><pre class="programlisting">namespace AdventureWorks.MachineLearning

open Accord
open Accord.Statistics
open Accord.Statistics.Models.Regression.Linear

open System
open System.Data.SqlClient
open System.Collections.Generic

type internal ProductReview = {ProductID:int; TotalOrders:float; AvgReviews: float}

type public OrderPrediction () = 
    let reviews = List&lt;ProductReview&gt;()

    [&lt;Literal&gt;]
    let connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=AdventureWorks2014;user id=chickenskills@nc54a9m5kk;password=sk1lzm@tter;"

    [&lt;Literal&gt;]
    let query = "Select 
                A.ProductID, TotalOrders, AvgReviews
                From
                (Select 
                ProductID,
                Sum(OrderQty) as TotalOrders
                from [Sales].[SalesOrderDetail] as SOD
                inner join [Sales].[SalesOrderHeader] as SOH
                on SOD.SalesOrderID = SOH.SalesOrderID
                inner join [Sales].[Customer] as C
                on SOH.CustomerID = C.CustomerID
                Where C.StoreID is not null
                Group By ProductID) as A
                Inner Join 
                (Select
                ProductID,
                (Sum(Rating) + 0.0) / (Count(ProductID) + 0.0) as AvgReviews
                from [Production].[ProductReview] as PR
                Group By ProductID) as B
                on A.ProductID = B.ProductID"

    member this.PredictQuantity(productId:int) = 
        use connection = new SqlConnection(connectionString)
        use command = new SqlCommand(query,connection)
        connection.Open()
        use reader = command.ExecuteReader()
        while reader.Read() do
            reviews.Add({ProductID=reader.GetInt32(0);TotalOrders=(float)(reader.GetInt32(1));AvgReviews=(float)(reader.GetDecimal(2))})

        let x = reviews |&gt; Seq.map (fun pr -&gt; pr.AvgReviews) |&gt; Seq.toArray
        let y = reviews |&gt; Seq.map (fun pr -&gt; pr.TotalOrders) |&gt; Seq.toArray
        let regression = SimpleLinearRegression()
        let sse = regression.Regress(x,y)
        let mse = sse/float x.Length 
        let rmse = sqrt mse
        let r2 = regression.CoefficientOfDetermination(x,y)

        let review = reviews |&gt; Seq.find (fun r -&gt; r.ProductID = productId)
        regression.Compute(review.AvgReviews)</pre></div><p class="calibre6">The only change from the REPL code is that <code class="literal">connection</code>, <code class="literal">command</code>, and <code class="literal">reader</code> are now assigned with the <code class="literal">use</code> keyword and not <code class="literal">let</code>. This is equivalent to the <code class="literal">using</code> statement in C# so that all resources are cleaned up in the most efficient manner.</p><p class="calibre6">With that in place, you <a id="id113" class="calibre1"/>can run the UI and see the actual value being predicted from the regression that uses all of our data:</p><div class="mediaobject"><img src="../images/00052.jpeg" alt="Implementing the regression" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Congratulations! You have successfully wired up a website with a simple linear regression. This prediction is dynamic because the regression is calculated on every page refresh. This means as more data goes into our database, the websites reflect changes in the product reviews at real time. The software architect in you should be pulling the alarm because this will have a severe impact on performance; we pull the aggregate data and then do the regression calculation on each call. We will discuss better strategies later in the book that allow our site to have real-time or near-time performance to go with a machine learning algorithm.</p></div></div>
<div class="book" title="Summary" id="QMFO1-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec21" class="calibre1"/>Summary</h1></div></div></div><p class="calibre6">This chapter dipped our toes into the water of creating a machine learning model and implementing those models in a line of business application. There are many things that we glossed over that will get all of your data science friends mad, such as my dumbed-down formula for a regression, overfitting, and using a regression without dealing with outliers. Also, the web developers in the room have plenty to be mad about, including my rudimentary website design and injecting a data-intensive operation in a page load. Fear not. We will address these issues (and many more) in the coming chapters.</p></div></body></html>