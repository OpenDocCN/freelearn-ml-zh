<html><head></head><body>
<div id="_idContainer195">
<h1 class="chapter-number" id="_idParaDest-93"><a id="_idTextAnchor537"/><a id="_idTextAnchor538"/><a id="_idTextAnchor539"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-94"><a id="_idTextAnchor540"/><span class="koboSpan" id="kobo.2.1">Influencing Trend Changepoints</span></h1>
<p><span class="koboSpan" id="kobo.3.1">During the development of Prophet, the engineering team recognized that real-world time series will frequently exhibit abrupt changes in their trajectories. </span><span class="koboSpan" id="kobo.3.2">As a fundamentally linear regression model, Prophet would not be capable of capturing these changes without special care being taken. </span><span class="koboSpan" id="kobo.3.3">You may have noticed in the previous chapters, however, that when we plotted the forecast components in our examples, the trend line was not always perfectly straight. </span><span class="koboSpan" id="kobo.3.4">Clearly, the Prophet team has developed a way for Prophet to capture these bends in the linear model. </span><span class="koboSpan" id="kobo.3.5">The </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.4.1">locations of these bends</span><a id="_idTextAnchor541"/><span class="koboSpan" id="kobo.5.1"> are </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">called </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.7.1">changepoints</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">Prophet will automatically identify these changepoints and allow the trend to adapt appropriately. </span><span class="koboSpan" id="kobo.9.2">However, there are several tools you can use to control this behavior if Prophet is underfitting or overfitting these rate changes. </span><span class="koboSpan" id="kobo.9.3">In this chapter, we’ll look at Prophet’s automatic changepoint detection to provide you with an understanding of what is happening in your model with the default settings. </span><span class="koboSpan" id="kobo.9.4">We will then look at two further techniques you can use if you need finer control over the </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">changepoint process.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">Specifically, in this chapter, you will learn about </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.13.1">Automatic trend </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">changepoint detection</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.15.1">Regularizing changepoints</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Specifying custom </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">changepoint location</span><a id="_idTextAnchor542"/><span class="koboSpan" id="kobo.18.1">s</span></span><a id="_idTextAnchor543"/><a id="_idTextAnchor544"/></li>
</ul>
<h1 id="_idParaDest-95"><a id="_idTextAnchor545"/><span class="koboSpan" id="kobo.19.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.20.1">The data files and code for the examples in this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">at </span></span><a href="https://github.com/PacktPublishing/Forecasting-Time-Series-Data-with-Prophet-Second-Edition"><span class="No-Break"><span class="koboSpan" id="kobo.22.1">https://github.com/PacktPublishing/Forecasting-Time-Series-Data-with-Prophet-Second-Edition</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.23.1">.</span></span><a id="_idTextAnchor546"/><a id="_idTextAnchor547"/></p>
<h1 id="_idParaDest-96"><a id="_idTextAnchor548"/><span class="koboSpan" id="kobo.24.1">Automatic trend changepoint detection</span></h1>
<p><span class="koboSpan" id="kobo.25.1">Trend</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.26.1"> changepoints are locations in your</span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.27.1"> time series where the trend component of the model sudden</span><a id="_idTextAnchor549"/><span class="koboSpan" id="kobo.28.1">ly changes its slope. </span><span class="koboSpan" id="kobo.28.2">There are many reasons why these changepoints occur, depending upon your dataset. </span><span class="koboSpan" id="kobo.28.3">For example, Facebook (now Meta) developed Prophet to forecast its own business problems; it may model the number of daily active users and see a sudden change of trend upon the release of a </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">new feature.</span></span></p>
<p><span class="koboSpan" id="kobo.30.1">Airline passenger numbers may suddenly change as economies of scale allow much cheaper flights. </span><span class="koboSpan" id="kobo.30.2">The trend of carbon dioxide in the atmosphere was relatively flat for tens of thousands of years, but then suddenly changed during the </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">Industrial Revolution.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">From our work with the Divvy dataset in previous chapters, we saw a slowdown of growth after approximately two years. </span><span class="koboSpan" id="kobo.32.2">Let’s take a closer look at this example to learn about automatic </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">changepoint detectio</span><a id="_idTextAnchor550"/><a id="_idTextAnchor551"/><span class="koboSpan" id="kobo.34.1">n.</span></span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor552"/><span class="koboSpan" id="kobo.35.1">Default changepoint detection</span></h2>
<p><span class="koboSpan" id="kobo.36.1">Prophet </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.37.1">s</span><a id="_idTextAnchor553"/><span class="koboSpan" id="kobo.38.1">ets changepoints by first specifying the number of potential dates on which a changepoint may occur. </span><span class="koboSpan" id="kobo.38.2">Prophet then works on calculating the magnitude of change at each of these points, attempting to fit the trend curve while keeping those magnitudes as low as possible. </span><span class="koboSpan" id="kobo.38.3">You can tune Prophet’s flexibility here by adjusting </span><strong class="source-inline"><span class="koboSpan" id="kobo.39.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.40.1">. </span><span class="koboSpan" id="kobo.40.2">You may recognize that argument from earlier—both seasonalities and holidays had their own prior scales </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">for regularization.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">With</span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.43.1"> changepoints, it has much the same effect, and we’ll explore it later in this chapter. </span><span class="koboSpan" id="kobo.43.2">In Prophet’s default settings, the magnitudes of most of these potential changepoints will very nearly be zero and therefore will have a negligible effect on our </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">trend curve.</span></span></p>
<p><span class="koboSpan" id="kobo.45.1">To get started with our code, we need to make the necessary imports and load our Divvy data. </span><span class="koboSpan" id="kobo.45.2">We’ll be using the daily Divvy data here. </span><span class="koboSpan" id="kobo.45.3">We are also going to import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.46.1">add_changepoints_to_plot</span></strong><span class="koboSpan" id="kobo.47.1"> function, which you were introduced to in </span><a href="B19630_07.xhtml#_idTextAnchor453"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.48.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.49.1">, </span><em class="italic"><span class="koboSpan" id="kobo.50.1">Controlling Growth Modes</span></em><span class="koboSpan" id="kobo.51.1">; we’ll be using that a </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">lot here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.53.1">
import pandas as pd
import matplotlib.pyplot as plt
from prophet import Prophet
from prophet.plot import add_changepoints_to_plot
df = pd.read_csv('divvy_daily.csv')
df = df[['date', 'rides']]
df['date'] = pd.to_datetime(df['date'])
df.columns = ['ds', 'y']</span></pre>
<p><span class="koboSpan" id="kobo.54.1">With the</span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.55.1"> default settings, Prophet will place </span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.56.1">25 potential changepoints, evenly spaced in the first 80% </span><a id="_idTextAnchor554"/><span class="koboSpan" id="kobo.57.1">of the data, before determining their magnitudes. </span><span class="koboSpan" id="kobo.57.2">With this Divvy data, those 25 locations are denoted by the vertical dashed bars in </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">this fi</span><a id="_idTextAnchor555"/><span class="koboSpan" id="kobo.59.1">gure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer182">
<span class="koboSpan" id="kobo.60.1"><img alt="Figure 8.1 – Divvy data with potential changepoint locations" src="image/Fig_8.1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.61.1">Figure 8.1 – Divvy data with potential changepoint locations</span></p>
<p><span class="koboSpan" id="kobo.62.1">Now, let’s fit our Prophet model. </span><span class="koboSpan" id="kobo.62.2">In this step, Prophet will determine what magnitudes to apply at each of those potential changepoints. </span><span class="koboSpan" id="kobo.62.3">From the examples in the previous chapters, we’ve learned how to model this data with multiplicative seasonality and hold down the Fourier order of the yearly seasonality a bit. </span><span class="koboSpan" id="kobo.62.4">You can see that reflected here when we instantiate our </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">Prophet object.</span></span></p>
<p><span class="koboSpan" id="kobo.64.1">After fitting the model, we’ll call </span><strong class="source-inline"><span class="koboSpan" id="kobo.65.1">predict</span></strong><span class="koboSpan" id="kobo.66.1"> with no </span><strong class="source-inline"><span class="koboSpan" id="kobo.67.1">future</span></strong><span class="koboSpan" id="kobo.68.1"> DataFrame specified, which causes Prophet to build its model and predict historical values but not any </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">forecasted ones:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.70.1">
model = Prophet(seasonality_mode='multiplicative',
                yearly_seasonality=4)
model.fit(df)
forecast = model.predict()</span></pre>
<p><span class="koboSpan" id="kobo.71.1">At this</span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.72.1"> point, w</span><a id="_idTextAnchor556"/><span class="koboSpan" id="kobo.73.1">e will plot the model. </span><span class="koboSpan" id="kobo.73.2">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">add_changepoints_to_plot</span></strong><span class="koboSpan" id="kobo.75.1"> function to see the locations of significant </span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.76.1">changepoints. </span><span class="koboSpan" id="kobo.76.2">As you saw in </span><a href="B19630_07.xhtml#_idTextAnchor453"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.77.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.78.1">, </span><em class="italic"><span class="koboSpan" id="kobo.79.1">Controlling Growth Modes</span></em><span class="koboSpan" id="kobo.80.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">add_changepoints_to_plot</span></strong><span class="koboSpan" id="kobo.82.1"> function takes three required arguments. </span><span class="koboSpan" id="kobo.82.2">The first argument is the axes upon which to add the changepoints. </span><span class="koboSpan" id="kobo.82.3">We specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.83.1">fig</span></strong><span class="koboSpan" id="kobo.84.1"> created in our first plot call, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">gca()</span></strong><span class="koboSpan" id="kobo.86.1"> method, which stands for </span><em class="italic"><span class="koboSpan" id="kobo.87.1">get current axes</span></em><span class="koboSpan" id="kobo.88.1">. </span><span class="koboSpan" id="kobo.88.2">The second argument is our model and the third argument is </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">our forecast.</span></span></p>
<p><span class="koboSpan" id="kobo.90.1">In </span><a href="B19630_07.xhtml#_idTextAnchor453"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.91.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.92.1">, </span><em class="italic"><span class="koboSpan" id="kobo.93.1">Controlling Growth Modes</span></em><span class="koboSpan" id="kobo.94.1">, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">cp_linestyle</span></strong><span class="koboSpan" id="kobo.96.1"> argument to force Prophet not to plot the changepoints, only the trend; we will not use that argument in </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">this case:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.98.1">
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.99.1">You should now see that Prophet determined that 5 of those 25 potential changepoints were actually significant. </span><span class="koboSpan" id="kobo.99.2">These 5 are denoted with the vertical dashed lines in </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">this</span><a id="_idTextAnchor557"/><span class="koboSpan" id="kobo.101.1"> plot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer183">
<span class="koboSpan" id="kobo.102.1"><img alt="Figure 8.2 – Divvy changepoint plot" src="image/Fig_8.2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.103.1">Figure 8.2 – Divvy changepoint plot</span></p>
<p><span class="koboSpan" id="kobo.104.1">It is hard to </span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.105.1">tell from the first changepoint that the trend is actually bending, but from the next four, it is much clea</span><a id="_idTextAnchor558"/><span class="koboSpan" id="kobo.106.1">rer. </span><span class="koboSpan" id="kobo.106.2">At </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.107.1">each of those changepoints, the slope of the trend is allowed to </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">become shallower.</span></span></p>
<p><span class="koboSpan" id="kobo.109.1">The magnitude of each of the 25 potential changepoints is stored in </span><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">model.params</span></strong><span class="koboSpan" id="kobo.111.1">, but these values have been normalized, so their absolute values are meaningless but their relative magnitudes are not. </span><span class="koboSpan" id="kobo.111.2">The model parameters are stored in a dictionary, with </span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">'delta'</span></strong><span class="koboSpan" id="kobo.113.1"> being the key for the changepoint magnitudes. </span><span class="koboSpan" id="kobo.113.2">Let’s take </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">a look:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.115.1">
print(model.params['delta'])</span></pre>
<p><span class="koboSpan" id="kobo.116.1">In this model, those changepoint magnitudes should be similar to the changepoint magnitudes shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.117.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.118.1">.3</span></em><span class="koboSpan" id="kobo.119.1">. </span><span class="koboSpan" id="kobo.119.2">Because these numbers are calculated using an optimization process instead of a deterministic equation, you may arrive at different exact values but the exponents should be roughly </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">th</span><a id="_idTextAnchor559"/><span class="koboSpan" id="kobo.121.1">e same:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer184">
<span class="koboSpan" id="kobo.122.1"><img alt="Figure 8.3 – Divvy changepoint magnitudes" src="image/Fig_8.3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.123.1">Figure 8.3 – Divvy changepoint magnitudes</span></p>
<p><span class="koboSpan" id="kobo.124.1">Most of those</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.125.1"> magnitudes have an exponent of -08 or -09, meaning that in standard notation, you should shift the decimal point that </span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.126.1">number of digits, 8 or 9 digits to the left, which is to say that those numbers are very close to zero. </span><span class="koboSpan" id="kobo.126.2">You can visualize these magn</span><a id="_idTextAnchor560"/><span class="koboSpan" id="kobo.127.1">itudes by plotting them. </span><span class="koboSpan" id="kobo.127.2">Here, I am overlaying the trend line and the significant changepoints with the magnitudes of </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">all chang</span><a id="_idTextAnchor561"/><span class="koboSpan" id="kobo.129.1">epoints:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer185">
<span class="koboSpan" id="kobo.130.1"><img alt="Figure 8.4 – Changepoint magnitudes" src="image/Fig_8.4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.131.1">Figure 8.4 – Changepoint magnitudes</span></p>
<p><span class="koboSpan" id="kobo.132.1">Let me explain this plot a bit. </span><span class="koboSpan" id="kobo.132.2">The left axis is the same </span><em class="italic"><span class="koboSpan" id="kobo.133.1">y</span></em><span class="koboSpan" id="kobo.134.1"> axis as in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.135.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.136.1">.2</span></em><span class="koboSpan" id="kobo.137.1">. </span><span class="koboSpan" id="kobo.137.2">The trend line—the solid line cutting from the lower left across to the upper right—is plotted on this axis. </span><span class="koboSpan" id="kobo.137.3">The vertical dashed lines are the significant changepoints identified by Prophet. </span><span class="koboSpan" id="kobo.137.4">The solid vertical bars are the changepoint magnitudes; these are plotted on the right axis, </span><strong class="bold"><span class="koboSpan" id="kobo.138.1">Trend </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.139.1">rate change</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.141.1">Again, most of these magnitudes are very nearly zero so they do not appear on the plot. </span><span class="koboSpan" id="kobo.141.2">The horizontal dashed line denotes a changepoint magnitude of zero. </span><span class="koboSpan" id="kobo.141.3">Bars extending upward from here are changepoints with positive magnitude, where the trend bends upward, and bars e</span><a id="_idTextAnchor562"/><span class="koboSpan" id="kobo.142.1">xtending downward from here are changepoints with negative magnitude, where the trend </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">bends downward.</span></span></p>
<p><span class="koboSpan" id="kobo.144.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">add_changepoints_to_plot</span></strong><span class="koboSpan" id="kobo.146.1"> function will </span><em class="italic"><span class="koboSpan" id="kobo.147.1">only</span></em><span class="koboSpan" id="kobo.148.1"> plot those changepoints with an absolute magnitude greater than 0.01. </span><span class="koboSpan" id="kobo.148.2">The two horizontal dotted lines are located at magnitude levels of 0.01 and -0.01; Prophet only plots magnitudes that extend beyond these limits. </span><span class="koboSpan" id="kobo.148.3">You can change this threshold using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">threshold</span></strong><span class="koboSpan" id="kobo.150.1"> argument in the function; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">add_changepoints_to_plot(fig.gca(), model, forecast, threshold=0.1)</span></strong><span class="koboSpan" id="kobo.152.1"> will widen that threshold to an upper bound of </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">0.1</span></strong><span class="koboSpan" id="kobo.154.1"> and a lower bound of </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">-0.1</span></strong><span class="koboSpan" id="kobo.156.1">. </span><span class="koboSpan" id="kobo.156.2">This only affects the plotting visualization, not your </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">actual changepoints.</span></span></p>
<p><span class="koboSpan" id="kobo.158.1">So, </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.159.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.160.1">.4</span></em><span class="koboSpan" id="kobo.161.1"> illustrates </span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.162.1">that Prophet was successful </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.163.1">in forcing nearly all of the potential changepoints to have an insignificant effect. </span><span class="koboSpan" id="kobo.163.2">Eight total changepoints had magnitudes large enough to be visible on our plot, but only five of them were higher than Prophet’s plotting threshold (although their small effect on the trend is still applied). </span><span class="koboSpan" id="kobo.163.3">Even though it can be hard to see, the only positively valued changepoint, plotted just after </span><strong class="bold"><span class="koboSpan" id="kobo.164.1">2015-01</span></strong><span class="koboSpan" id="kobo.165.1">, does indeed cause the trend to bend a little bit more steeply at that point. </span><span class="koboSpan" id="kobo.165.2">At the locations of the other significant changepoints, the trend </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">becomes shallower.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">The preceding example demonstrates Prophet’s behavior with regard to changepoints in a fully automatic setting. </span><span class="koboSpan" id="kobo.167.2">In the next section, let’s examine the levers you can use to gain some control of </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">the cha</span><a id="_idTextAnchor563"/><a id="_idTextAnchor564"/><span class="koboSpan" id="kobo.169.1">ngepoints.</span></span></p>
<h1 id="_idParaDest-98"><a id="_idTextAnchor565"/><span class="koboSpan" id="kobo.170.1">Regularizing changepoints</span></h1>
<p><span class="koboSpan" id="kobo.171.1">As</span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.172.1"> stated earlier, Prophet will place 25 potential changepoints in the first 80% of the tim</span><a id="_idTextAnchor566"/><span class="koboSpan" id="kobo.173.1">e series by default. </span><span class="koboSpan" id="kobo.173.2">To control Prophet’s automatic changepoint detection, you can modify both of these values with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">n_changepoints</span></strong><span class="koboSpan" id="kobo.175.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">changepoint_range</span></strong><span class="koboSpan" id="kobo.177.1"> arguments during model instantiation. </span><span class="koboSpan" id="kobo.177.2">For example, changing the number of potential changepoints to </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">5</span></strong><span class="koboSpan" id="kobo.179.1"> is done </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.181.1">
model = Prophet(seasonality_mode='multiplicative',
                yearly_seasonality=4,
                n_changepoints=5)</span></pre>
<p><span class="koboSpan" id="kobo.182.1">This </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.183.1">results in five evenly spaced potential changepoints in the first 80% of the data, as </span><a id="_idTextAnchor567"/><span class="No-Break"><span class="koboSpan" id="kobo.184.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer186">
<span class="koboSpan" id="kobo.185.1"><img alt="Figure 8.5 – Five potential changepoints" src="image/Fig_8.5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.186.1">Figure 8.5 – Five potential changepoints</span></p>
<p><span class="koboSpan" id="kobo.187.1">Or, you could instead force all 25 changepoints to lie not in the first 80% of data, but rather in the </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">first 50%:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.189.1">
model = Prophet(seasonality_mode='multiplicative',
                yearly_seasonality=4,
                changepoint_range=.5)</span></pre>
<p><span class="koboSpan" id="kobo.190.1">Now,</span><a id="_idTextAnchor568"/><span class="koboSpan" id="kobo.191.1"> we see the potential changepoints are placed only in the first half of the </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">d</span><a id="_idTextAnchor569"/><span class="koboSpan" id="kobo.193.1">ata range:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer187">
<span class="koboSpan" id="kobo.194.1"><img alt="Figure 8.6 – Changepoints in the first 50% of the data" src="image/Fig_8.6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.195.1">Figure 8.6 – Changepoints in the first 50% of the data</span></p>
<p><span class="koboSpan" id="kobo.196.1">You can, of</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.197.1"> course, use both of these arguments in one model. </span><span class="koboSpan" id="kobo.197.2">In both cases, it is important to remember that you’re not instructing Prophet to place changepoints at these locations, only </span><em class="italic"><span class="koboSpan" id="kobo.198.1">potential</span></em><span class="koboSpan" id="kobo.199.1"> changepoints. </span><span class="koboSpan" id="kobo.199.2">It will still try to force as many of them as possible to zero, and indeed both cases do leave us with predicted trends that are nearly identical to the example we built with </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">default values.</span></span></p>
<p><span class="koboSpan" id="kobo.201.1">Also, remember that Prophet will never place a changepoint in the future. </span><span class="koboSpan" id="kobo.201.2">This is why by default, Prophet will only use the first 80% of data—to prevent it from choosing a poor changepoint with few upcoming data points with which to correct its mistake. </span><span class="koboSpan" id="kobo.201.3">Prophet will, however, estimate future changepoints when creating uncertainty intervals; so, a model that features many large changepoints will also see greater </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">forecast uncertainty.</span></span></p>
<p><span class="koboSpan" id="kobo.203.1">In general, setting changepoints at very late moments in the series has a higher likelihood of overfitting. </span><span class="koboSpan" id="kobo.203.2">To see why, I have built a two-year forecast of the Divvy data and forced</span><a id="_idTextAnchor570"/><span class="koboSpan" id="kobo.204.1"> Prophet to choose just one changepoint, placed in the final two months of data. </span><span class="koboSpan" id="kobo.204.2">During November, the number of rides per day drops quickly as usage declines in winter. </span><span class="koboSpan" id="kobo.204.3">Prophet saw this decline and decided it must be a negative trend change and so adjusted its future </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">predictions ac</span><a id="_idTextAnchor571"/><span class="koboSpan" id="kobo.206.1">cordingly:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer188">
<span class="koboSpan" id="kobo.207.1"><img alt="Figure 8.7 – Prophet with a very late changepoint" src="image/Fig_8.7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.208.1">Figure 8.7 – Prophet with a very late changepoint</span></p>
<p><span class="koboSpan" id="kobo.209.1">I may be no better at predicting the future than Prophet is, but I’ve got a high degree of confidence that Prophet’s forecast in this case is not going to be very accurate in </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">the future.</span></span></p>
<p><span class="koboSpan" id="kobo.211.1">With all </span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.212.1">that said, you should not need to adjust the number of changepoints or the changepoint range very often. </span><span class="koboSpan" id="kobo.212.2">The defaults almost always work out very well. </span><span class="koboSpan" id="kobo.212.3">If you find Prophet is either overfitting or underfitting the changepoints, it is better to control this through regularization. </span><span class="koboSpan" id="kobo.212.4">Just as we did in </span><a href="B19630_05.xhtml#_idTextAnchor254"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.213.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.214.1">, </span><em class="italic"><span class="koboSpan" id="kobo.215.1">Working with Seasonality</span></em><span class="koboSpan" id="kobo.216.1">, and </span><a href="B19630_06.xhtml#_idTextAnchor375"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.217.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.218.1">, </span><em class="italic"><span class="koboSpan" id="kobo.219.1">Forecasting Holiday Effects</span></em><span class="koboSpan" id="kobo.220.1">, we use the </span><strong class="bold"><span class="koboSpan" id="kobo.221.1">prior scale</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.222.1">for regularization.</span></span></p>
<p><span class="koboSpan" id="kobo.223.1">If you recall from </span><a href="B19630_05.xhtml#_idTextAnchor254"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.224.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.225.1">, </span><em class="italic"><span class="koboSpan" id="kobo.226.1">Working with Seasonality</span></em><span class="koboSpan" id="kobo.227.1">, and </span><a href="B19630_06.xhtml#_idTextAnchor375"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.228.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.229.1">, </span><em class="italic"><span class="koboSpan" id="kobo.230.1">Forecasting Holiday Effects</span></em><span class="koboSpan" id="kobo.231.1">, the prior scale is used to control the flexibility of Prophet. </span><span class="koboSpan" id="kobo.231.2">A model that is too flexible has a high chance of overfitting the data, that is, modeling too much noise in addition to the true signal. </span><span class="koboSpan" id="kobo.231.3">A model that is not flexible enough has a high chance of underfitting the data or of not capturing all of the </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">available signals.</span></span></p>
<p><span class="koboSpan" id="kobo.233.1">By default, both </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">seasonality_prior_scale</span></strong><span class="koboSpan" id="kobo.235.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">holidays_prior_scale</span></strong><span class="koboSpan" id="kobo.237.1"> were set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">10</span></strong><span class="koboSpan" id="kobo.239.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.241.1">, however, is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">0.05</span></strong><span class="koboSpan" id="kobo.243.1"> by default. </span><span class="koboSpan" id="kobo.243.2">But just </span><a id="_idTextAnchor572"/><span class="koboSpan" id="kobo.244.1">as with the seasonality and holidays prior scales, increasing this value will make the trend more flexible, and decreasing it will make the trend less flexible. </span><span class="koboSpan" id="kobo.244.2">Reasonable values are typically in the range of </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">0.001</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.246.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">0.5</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.249.1">Let’s fit and plot a model with </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.251.1"> increased to </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">1</span></strong><span class="koboSpan" id="kobo.253.1">. </span><span class="koboSpan" id="kobo.253.2">This should allow Prophet’s trend to have a great deal </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">of flexibility:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.255.1">
model = Prophet(seasonality_mode='multiplicative',
                yearly_seasonality=4,
                changepoint_prior_scale=1)
model.fit(df)
forecast = model.predict()
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.256.1">Here, we</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.257.1"> can see that Prophet’s trend is now </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">wildly o</span><a id="_idTextAnchor573"/><span class="koboSpan" id="kobo.259.1">verfitting:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer189">
<span class="koboSpan" id="kobo.260.1"><img alt="Figure 8.8 – Prophet with too little trend regularization" src="image/Fig_8.8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.261.1">Figure 8.8 – Prophet with too little trend regularization</span></p>
<p><span class="koboSpan" id="kobo.262.1">When we</span><a id="_idTextAnchor574"/><span class="koboSpan" id="kobo.263.1"> loosen the regularization parameter, Prophet starts overfitting the trend line and tries to capture some of the yearly seasonality. </span><span class="koboSpan" id="kobo.263.2">We have given Prophet too much flexibility with its </span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">trend fit.</span></span></p>
<p><span class="koboSpan" id="kobo.265.1">On the other </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.266.1">hand, let’s now see what happens when we regularize too strictly. </span><span class="koboSpan" id="kobo.266.2">In this example, we decrease </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.268.1"> from the default down </span><span class="No-Break"><span class="koboSpan" id="kobo.269.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">0.007</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.272.1">
model = Prophet(seasonality_mode='multiplicative',
                yearly_seasonality=4,
                changepoint_prior_scale=.007)
model.fit(df)
forecast = model.predict()
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.sho</span><a id="_idTextAnchor575"/><span class="koboSpan" id="kobo.273.1">w()</span></pre>
<p><span class="koboSpan" id="kobo.274.1">With the reduced </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.276.1">, the following plot shows Prophet’s trend to not be </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">flexi</span><a id="_idTextAnchor576"/><span class="koboSpan" id="kobo.278.1">ble enough:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer190">
<span class="koboSpan" id="kobo.279.1"><img alt="Figure 8.9 – Prophet with too much trend regularization" src="image/Fig_8.9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.280.1">Figure 8.9 – Prophet with too much trend regularization</span></p>
<p><span class="koboSpan" id="kobo.281.1">Compare </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.282.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.283.1">.9</span></em><span class="koboSpan" id="kobo.284.1"> with </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.285.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.286.1">.2</span></em><span class="koboSpan" id="kobo.287.1"> at the beginning of this chapter. </span><span class="koboSpan" id="kobo.287.2">Although the locations </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.288.1">of the changepoints in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.289.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.290.1">.9</span></em><span class="koboSpan" id="kobo.291.1"> are roughly the same as in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.292.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.293.1">.2</span></em><span class="koboSpan" id="kobo.294.1">, the magnitudes of the changepoints were constrained too much with the regularization levels we used. </span><span class="koboSpan" id="kobo.294.2">That bend that was evident in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.295.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.296.1">.2</span></em><span class="koboSpan" id="kobo.297.1"> is now so minor in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.298.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.299.1">.9</span></em><span class="koboSpan" id="kobo.300.1"> that it is hard </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">to spot.</span></span></p>
<p><span class="koboSpan" id="kobo.302.1">There is one</span><a id="_idTextAnchor577"/><span class="koboSpan" id="kobo.303.1"> more way to control the changepoints in Prophet: by specifying your own custom changepoint locations. </span><span class="koboSpan" id="kobo.303.2">We’re going to look at a new dataset to explore this topic, the Instagram account of soccer player James Rodríguez, </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">@jamesrodriguez10</span></strong><span class="koboSpan" id="kobo.305.1">. </span><span class="koboSpan" id="kobo.305.2">This data was collected on Novemb</span><a id="_idTextAnchor578"/><a id="_idTextAnchor579"/><span class="koboSpan" id="kobo.306.1">er </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">22, 2019.</span></span></p>
<h1 id="_idParaDest-99"><a id="_idTextAnchor580"/><span class="koboSpan" id="kobo.308.1">Specifying custom changepoint locations</span></h1>
<p><span class="koboSpan" id="kobo.309.1">James Rodríguez is</span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.310.1"> a Colombian soccer</span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.311.1"> player who played in both the 2014 and 2018 World </span><a id="_idTextAnchor581"/><span class="koboSpan" id="kobo.312.1">Cups. </span><span class="koboSpan" id="kobo.312.2">He was a standout player in both World Cups but won the Golden Boot award in 2014 for scoring more goals than any other player in the competition. </span><span class="koboSpan" id="kobo.312.3">I chose his account because it exhibits some very interesting behavior that would be extremely difficult to model </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">without </span><a id="_idTextAnchor582"/><span class="koboSpan" id="kobo.314.1">changepoints:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer191">
<span class="koboSpan" id="kobo.315.1"><img alt="Figure 8.10 – James Rodríguez’s Instagram likes per day" src="image/Fig_8.10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.316.1">Figure 8.10 – James Rodríguez’s Instagram likes per day</span></p>
<p><span class="koboSpan" id="kobo.317.1">The </span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.318.1">number of likes his Instagram </span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.319.1">posts get is gradually increasing over time, but there have been two notable spikes, in the summers of 2014 and 2018 when he was playing in the World Cup. </span><span class="koboSpan" id="kobo.319.2">It is clear that the spike in 2014 resulted in a significant trend change. </span><span class="koboSpan" id="kobo.319.3">The number of likes that his posts were getting increased dramatically during the World Cup and dropped afterward, but not to the same baseline as before. </span><span class="koboSpan" id="kobo.319.4">He gained a large number of new followers during this period and consistently earned more likes per post as </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">a result.</span></span></p>
<p><span class="koboSpan" id="kobo.321.1">Similarly, in 2018, his profile saw a large summer spike in likes during the World Cup, but it is not clear that there was a significant trend change after the tournament ended. </span><span class="koboSpan" id="kobo.321.2">Also, you can see another spike in the summer of 2017. </span><span class="koboSpan" id="kobo.321.3">On July 11 of that year, Rodríguez announced that he had signed with a new team, Bayern Munich. </span><span class="koboSpan" id="kobo.321.4">We’ll include this fact in our model </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">as well</span><a id="_idTextAnchor583"/><span class="koboSpan" id="kobo.323.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">To model this behavior, we need to first account for the special events of the World Cups and the new team announcement. </span><span class="koboSpan" id="kobo.324.2">We will do this by creating custom holidays for them. </span><span class="koboSpan" id="kobo.324.3">And second, we need to account for the trend changes; we’ll accomplish this by setting custom trend changepoints. </span><span class="koboSpan" id="kobo.324.4">There does not appear to be much seasonality in the data so to simplify our model, we’ll just instruct Prophet not to </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">fit any.</span></span></p>
<p><span class="koboSpan" id="kobo.326.1">We already have our necessary imports completed, so we first need to load the data into our </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">Prophet DataFrame:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.328.1">
df = pd.read_csv('instagram_jamesrodriguez10.csv')
df['Date'] = pd.to_datetime(df['Date'])
df.columns = ['ds', 'y']</span></pre>
<p><span class="koboSpan" id="kobo.329.1">Next, we </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.330.1">need to create a DataFrame </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.331.1">for the special events. </span><span class="koboSpan" id="kobo.331.2">This is the same procedure you learned about in </span><a href="B19630_06.xhtml#_idTextAnchor375"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.332.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.333.1">, </span><em class="italic"><span class="koboSpan" id="kobo.334.1">Forecasting Holiday Effects</span></em><span class="koboSpan" id="kobo.335.1">. </span><span class="koboSpan" id="kobo.335.2">We have three events to add in this case: the 2014 World Cup, the 2017 signing for Bayern Munich, and the 2018 World Cup. </span><span class="koboSpan" id="kobo.335.3">Each event must have a name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">'holiday'</span></strong><span class="koboSpan" id="kobo.337.1"> column and the date in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">'</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">ds'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.340.1"> column.</span></span></p>
<p><span class="koboSpan" id="kobo.341.1">The two World Cups took place over 31 days each, so we’ll specify the first date and set </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">'upper_window'</span></strong><span class="koboSpan" id="kobo.343.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">31</span></strong><span class="koboSpan" id="kobo.345.1">. </span><span class="koboSpan" id="kobo.345.2">We’ll leave </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">'lower_window'</span></strong><span class="koboSpan" id="kobo.347.1"> at </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">0</span></strong><span class="koboSpan" id="kobo.349.1">. </span><span class="koboSpan" id="kobo.349.2">For the last event, signing with a new team, we’ll add a two-week window to generously assume that the effect of signing for Bayern Munich impacted his posts for the next </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">several days:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.351.1">
wc_2014 = pd.DataFrame({'holiday': 'World Cup 2014',
                       'ds':pd.to_datetime(['2014-06-12']),
                       'lower_window': 0,
                       'upper_window': 31})
wc_2018 = pd.DataFrame({'holiday': 'World Cup 2018',
                       'ds›:pd.to_datetime(['2018-06-14']),
                       'lower_window': 0,
                       'upper_window': 31})
signing = pd.DataFrame({'holiday': 'Bayern Munich',
                       'ds':pd.to_datetime(['2017-07-11']),
                       'lower_window': 0,
                       'upper_window': 14})
special_events = pd.concat([wc_2014, wc_2018, signi</span><a id="_idTextAnchor584"/><span class="koboSpan" id="kobo.352.1">ng])</span></pre>
<p><span class="koboSpan" id="kobo.353.1">Now, we need to specify our custom changepoints. </span><span class="koboSpan" id="kobo.353.2">We can simply pass Prophet a list of dates. </span><span class="koboSpan" id="kobo.353.3">Any date that pandas recognizes as a valid date-time format can </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">be used:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.355.1">
changepoints = ['2014-06-12',
                '2014-07-13',
                '2017-07-11',
                '2017-07-31',
                '2018-06-14',
                '2018-07-15']</span></pre>
<p><span class="koboSpan" id="kobo.356.1">For each </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.357.1">of those special events, we </span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.358.1">add one potential changepoint at the beginning of the event and one at the end. </span><span class="koboSpan" id="kobo.358.2">The rationale behind this decision is that we need to account for the fact that the number of likes per photo will follow a certain trend, proportional to the number of followers of the account until the trend is upset by a </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">special event.</span></span></p>
<p><span class="koboSpan" id="kobo.360.1">During the special event, the number of followers will increase at a much higher rate, and so the number of likes per photo will also increase, requiring a new trend line. </span><span class="koboSpan" id="kobo.360.2">After the event concludes, the dramatic rate of new followers will slow, so we need a third trend line at this point—resulting in three different trend slopes with two trend changepoints </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">connecting them.</span></span></p>
<p><span class="koboSpan" id="kobo.362.1">With our special events created and our potential changepoints determined, we next instantiate our Prophet object while passing it these special events and changepoints. </span><span class="koboSpan" id="kobo.362.2">For this example, we’ll set the seasonality to multiplicative. </span><span class="koboSpan" id="kobo.362.3">This is count data and as discussed in </span><a href="B19630_05.xhtml#_idTextAnchor254"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.363.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.364.1">, </span><em class="italic"><span class="koboSpan" id="kobo.365.1">Working with Seasonality</span></em><span class="koboSpan" id="kobo.366.1">, count data is </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">often multiplicative.</span></span></p>
<p><span class="koboSpan" id="kobo.368.1">However, there is an argument for using additive seasonality in this case—it is possible that the increased likes came from non-followers who visited Rodríguez’s profile due to the World Cup but did not subsequently follow, which would be an additive effect, as opposed to increased activity from current followers, possibly due to Instagram’s algorithmic feed ordering, which would be a multiplicative effect. </span><span class="koboSpan" id="kobo.368.2">In either case, the following procedure is </span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">the </span><a id="_idTextAnchor585"/><span class="koboSpan" id="kobo.370.1">same.</span></span></p>
<p><span class="koboSpan" id="kobo.371.1">We decided to simplify our model by removing seasonalities, so we’ll set both </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">yearly_seasonality</span></strong><span class="koboSpan" id="kobo.373.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">weekly_seasonality</span></strong><span class="koboSpan" id="kobo.375.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">False</span></strong><span class="koboSpan" id="kobo.377.1">. </span><span class="koboSpan" id="kobo.377.2">You may be wondering why we bothered to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">seasonality_mode</span></strong><span class="koboSpan" id="kobo.379.1"> if we don’t have any seasonalities—this is because </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">seasonality_mode</span></strong><span class="koboSpan" id="kobo.381.1"> affects holidays </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">as well.</span></span></p>
<p><span class="koboSpan" id="kobo.383.1">Finally, we set</span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.384.1"> the prior scale for the</span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.385.1"> changepoints to </span><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">1</span></strong><span class="koboSpan" id="kobo.387.1"> because we want to loosen the regularization a bit (feel free to experiment on your own with this number; I found the default to be too restrictive on this data), and pass our list of changepoints to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">changepoints</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.389.1"> argument:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.390.1">
model = Prophet(seasonality_mode='multiplicative',
                holidays=special_events,
                yearly_seasonality=False,
                weekly_seasonality=False,
                changepoint_prior_scale=1,
                changepoints=changepoints)</span></pre>
<p><span class="koboSpan" id="kobo.391.1">We will now continue as in the previous examples by calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">fit</span></strong><span class="koboSpan" id="kobo.393.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">predict</span></strong><span class="koboSpan" id="kobo.395.1"> methods on our model. </span><span class="koboSpan" id="kobo.395.2">We are not predicting the future in this example, but if you wanted to, you would need to add any future special events that you expected. </span><span class="koboSpan" id="kobo.395.3">Lastly, let’s plot both our forecast and our components to observe </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">the results:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.397.1">
model.fit(df)
forecast = model.predict()
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.show()
fig2 = model.plot_components(forec</span><a id="_idTextAnchor586"/><span class="koboSpan" id="kobo.398.1">ast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.399.1">First</span><a id="_idTextAnchor587"/><span class="koboSpan" id="kobo.400.1"> up is </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">our forecast:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer192">
<span class="koboSpan" id="kobo.402.1"><img alt="Figure 8.11 – James Rodríguez forecast" src="image/Fig_8.11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.403.1">Figure 8.11 – James Rodríguez forecast</span></p>
<p><span class="koboSpan" id="kobo.404.1">Despite the </span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.405.1">simplifications</span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.406.1"> we made in our model, the trend is a remarkably good fit. </span><span class="koboSpan" id="kobo.406.2">Now, let’s look at</span><a id="_idTextAnchor588"/><span class="koboSpan" id="kobo.407.1"> our </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">components plot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer193">
<span class="koboSpan" id="kobo.409.1"><img alt="Figure 8.12 – James Rodríguez co﻿mponents plot" src="image/Fig_8.12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.410.1">Figure 8.12 – James Rodríguez co</span><a id="_idTextAnchor589"/><span class="koboSpan" id="kobo.411.1">mponents plot</span></p>
<p><span class="koboSpan" id="kobo.412.1">You can see from the </span><strong class="bold"><span class="koboSpan" id="kobo.413.1">holidays</span></strong><span class="koboSpan" id="kobo.414.1"> plot that both World Cups provided a roughly 200% increase in likes per post on James Rodríguez’s account. </span><span class="koboSpan" id="kobo.414.2">When he signed for Bayern Munich, he saw a more modest, though still impressive, doubling of likes. </span><span class="koboSpan" id="kobo.414.3">And the trend line reflects </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">these changes.</span></span></p>
<p><span class="koboSpan" id="kobo.416.1">During each </span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.417.1">World Cup, he saw a rapid rise in the number of likes per post before the rate of increase of likes slowed while</span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.418.1"> maintaining a higher baseline than before the event. </span><span class="koboSpan" id="kobo.418.2">Prophet determined that two changepoints before and after each World Cup were necessary but found that the new team announcement made only one significant change to </span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">the trend.</span></span></p>
<p><span class="koboSpan" id="kobo.420.1">There is one more way to handle changepoint locations, a hybrid technique blending custom changepoints with Prophet’s default behavior. </span><span class="koboSpan" id="kobo.420.2">With this method, you would create an evenly spaced grid of changepoints, as Prophet does by default, and enrich it with your custom changepoints. </span><span class="koboSpan" id="kobo.420.3">Let’s squeeze in one more example to see how to </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">do this.</span></span></p>
<p><span class="koboSpan" id="kobo.422.1">In Prophet’s source code, there is a class method for creating the grid of</span><a id="_idTextAnchor590"/><span class="koboSpan" id="kobo.423.1"> potential changepoints called </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">set_changepoints</span></strong><span class="koboSpan" id="kobo.425.1">. </span><span class="koboSpan" id="kobo.425.2">This method is called automatically during the </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">fit</span></strong><span class="koboSpan" id="kobo.427.1"> command if no changepoints have already been specified. </span><span class="koboSpan" id="kobo.427.2">The following function mimics that </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">set_changepoints</span></strong><span class="koboSpan" id="kobo.429.1"> method to allow us to create a grid of potential changepoints outside the Prophet class. </span><span class="koboSpan" id="kobo.429.2">We will also need to import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">numpy</span></strong><span class="koboSpan" id="kobo.431.1"> library for use in </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">this function:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.433.1">
import numpy as np
def set_changepoints(df, n_changepoints=25,
                     changepoint_range=0.8):
    df = df.sort_values('ds').reset_index(drop=True)
    hist_size = int(np.floor(df.shape[0] * \
                             changepoint_range))
    if n_changepoints + 1 &gt; hist_size:
        n_changepoints = hist_size - 1
        print(‹n_changepoints greater than number of '+
              'observations. </span><span class="koboSpan" id="kobo.433.2">Using {}.'\
              .format(n_changepoints))
    if n_changepoints &gt; 0:
        cp_indexes = (np.linspace(0,
                                  hist_size - 1,
                                  n_changepoints + 1).
</span><span class="koboSpan" id="kobo.433.3">                      round().astype(np.int))
        changepoints = df.iloc[cp_indexes]['ds'].tail(-1)
    else:
        # set empty changepoints
        changepoints = pd.Series(pd.to_datetime([]),
                                 name=›ds›)
    return changepoints</span></pre>
<p><span class="koboSpan" id="kobo.434.1">This</span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.435.1"> function requires three arguments. </span><span class="koboSpan" id="kobo.435.2">The first is your Prophet DataFrame with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">'</span><a id="_idTextAnchor591"/><span class="koboSpan" id="kobo.437.1">ds'</span></strong><span class="koboSpan" id="kobo.438.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">'y'</span></strong><span class="koboSpan" id="kobo.440.1"> columns. </span><span class="koboSpan" id="kobo.440.2">The second </span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.441.1">argument is the number of changepoints to create, defaulting to the same value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">25</span></strong><span class="koboSpan" id="kobo.443.1"> as Prophet uses, and the third argument is the changepoint range, again defaulting to Prophet’s value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">0.8</span></strong><span class="koboSpan" id="kobo.445.1">. </span><span class="koboSpan" id="kobo.445.2">This returns a pandas series of potential changepoint locations. </span><span class="koboSpan" id="kobo.445.3">You simply then append your custom changepoints </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">to it.</span></span></p>
<p><span class="koboSpan" id="kobo.447.1">Using this function, let’s create five evenly spaced changepoints in the first 80% of the data, and then enrich the automatic changepoints with our six special event changepoints from the </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">previous example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.449.1">
changepoints = set_changepoints(df, 5, 0.8)
new_changepoints = pd.Series(pd.to_datetime(['2014-05-02',
                                            '2014-08-25',
                                            '‹2017-07-31',
                                            '2018-06-14',
                                            '2018-06-04',
                                            '2018-07-03']))
changepoints = changepoints = pd.concat([changepoints, 
new_changepoints])
changepoints = \
changepoints.sort_values().reset_index(drop=</span><a id="_idTextAnchor592"/><span class="koboSpan" id="kobo.450.1">True)</span></pre>
<p><span class="koboSpan" id="kobo.451.1">Now, let’s</span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.452.1"> recreate our previous</span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.453.1"> model, but this time, send it our new list </span><span class="No-Break"><span class="koboSpan" id="kobo.454.1">of changepoints:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.455.1">
model = Prophet(seasonality_mode='multiplicative',
                holidays=special_events,
                yearly_seasonality=False,
                weekly_seasonality=False,
                changepoint_prior_scale=1,
                changepoints=changepoints)
model.fit(df)
forecast = model.predict()
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.456.1">And now we can see that Prophet has used many more</span><a id="_idTextAnchor593"/><span class="koboSpan" id="kobo.457.1"> changepoints </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">than before:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer194">
<span class="koboSpan" id="kobo.459.1"><img alt="Figure 8.13 – Forecast with hybrid automatic/manual potential changepoints﻿" src="image/Fig_8.13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.460.1">Figure 8.13 – Forecast with hybrid automatic/manual potential changepoints</span><a id="_idTextAnchor594"/></p>
<p><span class="koboSpan" id="kobo.461.1">We also </span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.462.1">have a trend line that is very </span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.463.1">flexible; perhaps it is overfitting. </span><span class="koboSpan" id="kobo.463.2">That is something for you, the analyst, to</span><a id="_idTextAnchor595"/><span class="koboSpan" id="kobo.464.1"> determine, but as a demonstration of how to blend your own custom changepoints with an automatically selected grid of potential changepoints</span><a id="_idTextAnchor596"/><a id="_idTextAnchor597"/><span class="koboSpan" id="kobo.465.1">, this example </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">will suffice.</span></span></p>
<h1 id="_idParaDest-100"><a id="_idTextAnchor598"/><span class="koboSpan" id="kobo.467.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.468.1">In this chapter, you learned how to control the fit of the trend line by using changepoints. </span><span class="koboSpan" id="kobo.468.2">First, you used Divvy data to see how Prophet automatically selects potential changepoint locations and how you can control this by modifying the default number of potential changepoints and the </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">changepoint range.</span></span></p>
<p><span class="koboSpan" id="kobo.470.1">Then, you learned a more robust way to control Prophet’s changepoint selection through regularization. </span><span class="koboSpan" id="kobo.470.2">Just as with seasonality and holidays, changepoints are regularized by setting the prior scale. </span><span class="koboSpan" id="kobo.470.3">You then looked at the Instagram data of James Rodríguez and learned how to model the increase in likes per post he received both during and after the World Cups of 2014 and 2018. </span><span class="koboSpan" id="kobo.470.4">Finally, you learned how to blend these two techniques and enrich an automatically selected grid of potential changepoints with your custom </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">changepoint locations.</span></span></p>
<p><span class="koboSpan" id="kobo.472.1">In the next chapter, we will again look at the Divvy data, but this time, we’ll include the additional columns for temperature and weather conditions in order to learn how to include additional regressors in a </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">Prophet forecast.</span></span></p>
</div>
<div>
<div class="IMG---Figure" id="_idContainer196">
</div>
</div>
</body></html>