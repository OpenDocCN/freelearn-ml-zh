<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer107">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 class="chapterTitle" id="_idParaDest-165"><span class="koboSpan" id="kobo.2.1">Kubernetes Container Orchestration Infrastructure Management</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">While establishing a local data science setup for individual use for simple ML tasks may seem straightforward, creating a robust and scalable data science environment for multiple users (catering to diverse ML tasks and effectively tracking ML experiments) poses significant challenges. </span><span class="koboSpan" id="kobo.3.2">To overcome the scalability and control challenges of having a large number of users, companies normally implement ML platforms. </span><span class="koboSpan" id="kobo.3.3">There are different approaches to building ML platforms including build-your-own using open-source technologies or fully managed cloud ML platforms. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, we will</span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.5.1"> explore the open-source option, and specifically, Kubernetes, an indispensable open-source container orchestration platform that serves as a critical foundation for constructing open-source ML platforms. </span><span class="koboSpan" id="kobo.5.2">Kubernetes offers a wealth of capabilities, enabling the seamless management and orchestration of containers at scale. </span><span class="koboSpan" id="kobo.5.3">By leveraging Kubernetes, organizations can efficiently deploy and manage ML workloads, ensuring high availability, scalability, and resource utilization optimization.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.6.1">We will delve into the core concepts of Kubernetes, gaining insights into its networking architecture and essential components. </span><span class="koboSpan" id="kobo.6.2">Furthermore, we will explore its robust security features and granular access control mechanisms, crucial for safeguarding ML environments and sensitive data. </span><span class="koboSpan" id="kobo.6.3">Through practical exercises, you will have the opportunity to build your own Kubernetes cluster and leverage its power to deploy containerized applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.7.1">Specifically, we will cover the following topics:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Introduction to containers</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Kubernetes overview and core concepts</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Kubernetes networking</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Kubernetes security and access control</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Hands-on lab – building a Kubernetes infrastructure on AWS</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-166"><span class="koboSpan" id="kobo.13.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.14.1">You will continue to use services in your AWS account for the hands-on portion of the chapter. </span><span class="koboSpan" id="kobo.14.2">We will be using several AWS services, including the AWS </span><strong class="keyWord"><span class="koboSpan" id="kobo.15.1">Elastic Kubernetes Service</span></strong><span class="koboSpan" id="kobo.16.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.17.1">EKS</span></strong><span class="koboSpan" id="kobo.18.1">), AWS </span><strong class="keyWord"><span class="koboSpan" id="kobo.19.1">CloudShell</span></strong><span class="koboSpan" id="kobo.20.1">, and AWS </span><strong class="keyWord"><span class="koboSpan" id="kobo.21.1">EC2</span></strong><span class="koboSpan" id="kobo.22.1">. </span><span class="koboSpan" id="kobo.22.2">All code files used in this chapter are located on GitHub: </span><a href="https://github.com/PacktPublishing/The-Machine-Learning-Solutions-Architect-and-Risk-Management-Handbook-Second-Edition/tree/main/Chapter06"><span class="url"><span class="koboSpan" id="kobo.23.1">https://github.com/PacktPublishing/The-Machine-Learning-Solutions-Architect-and-Risk-Management-Handbook-Second-Edition/tree/main/Chapter06</span></span></a><span class="koboSpan" id="kobo.24.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-167"><span class="koboSpan" id="kobo.25.1">Introduction to containers</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.26.1">To understand Kubernetes, we first need to understand containers as they are the core building blocks of Kubernetes. </span><span class="koboSpan" id="kobo.26.2">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.27.1">container</span></strong><span class="koboSpan" id="kobo.28.1"> is a</span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.29.1"> form of operating system virtualization and is a very popular computing platform for software deployment and running modern software based on microservices architecture. </span><span class="koboSpan" id="kobo.29.2">A container allows you to package and run computer software with isolated dependencies. </span><span class="koboSpan" id="kobo.29.3">Compared to server virtualization, such as Amazon EC2 or </span><strong class="keyWord"><span class="koboSpan" id="kobo.30.1">VMware</span></strong><span class="koboSpan" id="kobo.31.1"> virtual machines, containers are more lightweight and </span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.32.1">portable, as they share the same operating system and do not contain operating system images in each container. </span><span class="koboSpan" id="kobo.32.2">Each container has its own filesystem, shares of computing resources, and process space for the custom applications running inside it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.33.1">The concept of containerization technology traced back to the 1970s with</span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.34.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.35.1">chroot system</span></strong><span class="koboSpan" id="kobo.36.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.37.1">Unix Version 7</span></strong><span class="koboSpan" id="kobo.38.1">. </span><span class="koboSpan" id="kobo.38.2">However, container technology did not gain much attention in the</span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.39.1"> software development community for the next two decades and remained dormant. </span><span class="koboSpan" id="kobo.39.2">While it picked up some steam and made remarkable advances from 2000 to 2011, it was the</span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.40.1"> introduction of </span><strong class="keyWord"><span class="koboSpan" id="kobo.41.1">Docker</span></strong><span class="koboSpan" id="kobo.42.1"> in 2013 that started a renaissance of container technology.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.43.1">You can run all kinds of applications inside containers, such as simple programs like data processing scripts or complex systems like databases. </span><span class="koboSpan" id="kobo.43.2">The following diagram illustrates how container deployment is different from other types of deployment. </span><span class="koboSpan" id="kobo.43.3">With bare metal deployment, all different applications share the same hosting operating systems. </span><span class="koboSpan" id="kobo.43.4">If there is an</span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.44.1"> issue with the hosting operating system, all applications will be impacted on the same physical machine. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.45.1">With the virtualized deployment, multiple guest operating systems can share the same hosting operating system. </span><span class="koboSpan" id="kobo.45.2">If one guest operating system has an issue, only the applications running in that guest operating system are impacted. </span><span class="koboSpan" id="kobo.45.3">Each guest operating system would have a full installation, thus consuming a lot of resources. </span><span class="koboSpan" id="kobo.45.4">With container deployment, a container runtime runs on a single host operating system, allowing the sharing of some common resources, while still providing the isolation of different environments for running different applications. </span><span class="koboSpan" id="kobo.45.5">A container is a lot more lightweight than a guest operating system, thus much more resource-efficient and faster. </span><span class="koboSpan" id="kobo.45.6">Note that a container runtime can also run in the guest operating system of a virtualized environment to host containerized applications:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.46.1"><img alt="Figure 6.1 – The differences between bare metal, virtualized, and container deployment " src="../Images/B20836_06_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.47.1">Figure 6.1: The differences between bare metal, virtualized, and container deployment</span></p>
<p class="normal"><span class="koboSpan" id="kobo.48.1">Containers are packaged as Docker images, which</span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.49.1"> are made of all the files (such as installation, application code, and dependencies) that are essential for running the containers and the applications in them. </span><span class="koboSpan" id="kobo.49.2">One way to build a Docker image is the use of a </span><code class="inlineCode"><span class="koboSpan" id="kobo.50.1">Dockerfile</span></code><span class="koboSpan" id="kobo.51.1"> – a plain-text file </span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.52.1">that provides specifications on how to build a Docker image. </span><span class="koboSpan" id="kobo.52.2">Once a Docker image is created, it can be executed in a container runtime environment. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.53.1">The following is an example </span><code class="inlineCode"><span class="koboSpan" id="kobo.54.1">Dockerfile</span></code><span class="koboSpan" id="kobo.55.1"> for building a Docker image to create a runtime environment based </span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.56.1">on the </span><strong class="keyWord"><span class="koboSpan" id="kobo.57.1">Ubuntu</span></strong><span class="koboSpan" id="kobo.58.1"> operating system (the </span><code class="inlineCode"><span class="koboSpan" id="kobo.59.1">FROM</span></code><span class="koboSpan" id="kobo.60.1"> instruction) and install </span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.61.1">various </span><strong class="keyWord"><span class="koboSpan" id="kobo.62.1">Python</span></strong><span class="koboSpan" id="kobo.63.1"> packages, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.64.1">python3</span></code><span class="koboSpan" id="kobo.65.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">numpy</span></code><span class="koboSpan" id="kobo.67.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">scikit-learn</span></code><span class="koboSpan" id="kobo.69.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">pandas</span></code><span class="koboSpan" id="kobo.71.1"> (the </span><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">RUN</span></code><span class="koboSpan" id="kobo.73.1"> instructions):</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.74.1">FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
wget \         
python3-pip \         
python3-dev \         
build-essential \         
libffi-dev \         
libssl-dev \         
nginx \         
ca-certificates \    
&amp;&amp; rm -rf /var/lib/apt/lists/*
RUN pip --no-cache-dir install numpy scipy scikit-learn pandas flask unicor
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.75.1">To build a </span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.76.1">Docker image from this </span><code class="inlineCode"><span class="koboSpan" id="kobo.77.1">Dockerfile</span></code><span class="koboSpan" id="kobo.78.1">, you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">Docker build - &lt; Dockerfile</span></code><span class="koboSpan" id="kobo.80.1"> command, which is a utility that comes as part of the Docker installation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.81.1">Now we have an understanding of containers, next, let’s dive into Kubernetes.</span></p>
<h1 class="heading-1" id="_idParaDest-168"><span class="koboSpan" id="kobo.82.1">Overview of Kubernetes and its core concepts</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.83.1">Managing and </span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.84.1">orchestrating a small number of containers and containerized applications manually within a compute environment can be relatively manageable. </span><span class="koboSpan" id="kobo.84.2">However, as the number of containers and servers grows, the task becomes increasingly complex. </span><span class="koboSpan" id="kobo.84.3">Enter Kubernetes, a powerful open-source system specifically designed to address these challenges. </span><span class="koboSpan" id="kobo.84.4">First introduced in 2014, Kubernetes (commonly abbreviated to K8s, derived from replacing “ubernete” with the digit 8) offers a comprehensive solution for efficiently managing containers at scale across clusters of servers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.85.1">Kubernetes follows a distributed architecture consisting of a master node and multiple worker nodes within a server cluster. </span><span class="koboSpan" id="kobo.85.2">Here, a server cluster refers to the set of machines and resources that Kubernetes manages, and a node is a single physical or virtual machine in the cluster. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.86.1">The master node, often </span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.87.1">referred to as the control plane, assumes the primary role in managing the entire Kubernetes cluster. </span><span class="koboSpan" id="kobo.87.2">It receives data about internal cluster events, external systems, and third-party applications, then processes the data and makes and executes decisions in response. </span><span class="koboSpan" id="kobo.87.3">It comprises four essential components, each playing a distinct role in the overall system:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.88.1">API server</span></strong><span class="koboSpan" id="kobo.89.1">: The API server</span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.90.1"> acts as the central communication hub for all interactions with the Kubernetes cluster. </span><span class="koboSpan" id="kobo.90.2">It provides a RESTful interface through which users, administrators, and other components can interact with the cluster. </span><span class="koboSpan" id="kobo.90.3">The API server handles authentication, authorization, and validation of requests, ensuring secure and controlled access to the cluster’s resources.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.91.1">Scheduler:</span></strong><span class="koboSpan" id="kobo.92.1"> The scheduler component </span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.93.1">is responsible for determining the optimal placement of workloads or Pods across the available worker nodes within the cluster.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.94.1">Controller:</span></strong><span class="koboSpan" id="kobo.95.1"> The</span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.96.1"> controller manager oversees the cluster’s overall state and manages various background tasks to maintain the desired system state.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.97.1">etcd:</span></strong><span class="koboSpan" id="kobo.98.1"> etcd is </span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.99.1">a distributed key-value store that serves as the cluster’s reliable data store, ensuring consistent and consistent access to critical configuration and state information. </span><span class="koboSpan" id="kobo.99.2">It stores the cluster’s current state, configuration details, and other essential data, providing a reliable source of truth for the entire system.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.100.1">Lastly, worker nodes are machines</span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.101.1"> that run containerized workloads. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.102.1">The following figure shows the core architecture components of a Kubernetes cluster:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.103.1"><img alt="Figure 6.2 – Kubernetes architecture " src="../Images/B20836_06_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.104.1">Figure 6.2: Kubernetes architecture</span></p>
<p class="normal"><span class="koboSpan" id="kobo.105.1">The master node</span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.106.1"> exposes</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.107.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.108.1">API server</span></strong><span class="koboSpan" id="kobo.109.1"> layer, which allows programmatic control of the cluster. </span><span class="koboSpan" id="kobo.109.2">An example of an API call could be the deployment of a web application on the cluster. </span><span class="koboSpan" id="kobo.109.3">The control plane also tracks and manages all configuration</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.110.1"> data in </span><strong class="keyWord"><span class="koboSpan" id="kobo.111.1">etcd</span></strong><span class="koboSpan" id="kobo.112.1">, which is responsible for storing all the cluster data, such as the desired number of container images to run, compute resource specification, and size of storage volume for a web application running on the cluster. </span><span class="koboSpan" id="kobo.112.2">Kubernetes uses</span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.113.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.114.1">controller</span></strong><span class="koboSpan" id="kobo.115.1"> to monitor the current states of Kubernetes resources and take the necessary actions (for example, request the change via the API server) to move the current states to the desired states if there are differences (such as the difference in the number of the running containers) between the two states. </span><span class="koboSpan" id="kobo.115.2">The controller manager in the master node is responsible for managing all the Kubernetes controllers. </span><span class="koboSpan" id="kobo.115.3">Kubernetes comes with a set of built-in controllers such</span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.116.1"> as </span><strong class="keyWord"><span class="koboSpan" id="kobo.117.1">scheduler</span></strong><span class="koboSpan" id="kobo.118.1">, which is responsible for</span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.119.1"> scheduling </span><strong class="keyWord"><span class="koboSpan" id="kobo.120.1">Pods</span></strong><span class="koboSpan" id="kobo.121.1"> (units of deployment, which we will discuss in more detail later) to run on worker nodes when there is a change request. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.122.1">Other examples include</span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.123.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.124.1">Job controller</span></strong><span class="koboSpan" id="kobo.125.1">, which is responsible for running and stopping one or more Pods for a task, and</span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.126.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.127.1">Deployment controller</span></strong><span class="koboSpan" id="kobo.128.1">, which is responsible for deploying Pods based on a deployment manifest, such as a deployment manifest for a web application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.129.1">To interact with a Kubernetes cluster control plane, you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">kubectl</span></code><span class="koboSpan" id="kobo.131.1"> command-line utility, the Kubernetes Python client (</span><a href="https://github.com/kubernetes-client/python"><span class="url"><span class="koboSpan" id="kobo.132.1">https://github.com/kubernetes-client/python</span></span></a><span class="koboSpan" id="kobo.133.1">), or access it directly using the RESTful API. </span><span class="koboSpan" id="kobo.133.2">You can find a list of supported </span><code class="inlineCode"><span class="koboSpan" id="kobo.134.1">kubectl</span></code><span class="koboSpan" id="kobo.135.1"> commands at </span><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/"><span class="url"><span class="koboSpan" id="kobo.136.1">https://kubernetes.io/docs/reference/kubectl/cheatsheet/</span></span></a><span class="koboSpan" id="kobo.137.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.138.1">There are several fundamental technical concepts that form the core of the Kubernetes architecture. </span><span class="koboSpan" id="kobo.138.2">These concepts are essential to understanding and effectively working with Kubernetes. </span><span class="koboSpan" id="kobo.138.3">Let’s look at some of the key concepts in detail.</span></p>
<h2 class="heading-2" id="_idParaDest-169"><span class="koboSpan" id="kobo.139.1">Namespaces</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.140.1">Namespaces </span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.141.1">organize clusters of worker machines into virtual sub-clusters. </span><span class="koboSpan" id="kobo.141.2">They are used to provide logical separation of resources owned by different teams and projects while still allowing ways for different namespaces to communicate. </span><span class="koboSpan" id="kobo.141.3">A namespace can span multiple worker nodes, and it can be used to group a list of permissions under a single name to allow authorized users to access resources in a namespace. </span><span class="koboSpan" id="kobo.141.4">Resource usage controls can be enforced to namespaces such as quotas for CPU and memory resources. </span><span class="koboSpan" id="kobo.141.5">Namespaces also make it possible to name resources with identical names if the resources reside in different namespaces to avoid naming conflicts. </span><span class="koboSpan" id="kobo.141.6">By default, there is a </span><code class="inlineCode"><span class="koboSpan" id="kobo.142.1">default</span></code><span class="koboSpan" id="kobo.143.1"> namespace in Kubernetes. </span><span class="koboSpan" id="kobo.143.2">You can create additional namespaces as needed. </span><span class="koboSpan" id="kobo.143.3">The default namespace is used if a namespace is not specified.</span></p>
<h2 class="heading-2" id="_idParaDest-170"><span class="koboSpan" id="kobo.144.1">Pods</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.145.1">Kubernetes</span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.146.1"> deploys</span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.147.1"> computing in a logical unit called a Pod. </span><span class="koboSpan" id="kobo.147.2">All Pods must belong to a Kubernetes namespace (either the default namespace or a specified namespace). </span><span class="koboSpan" id="kobo.147.3">One or more containers can be grouped into a Pod, and all containers in the Pod are deployed and scaled together as a single unit and share the same context, such as Linux namespaces and filesystems. </span><span class="koboSpan" id="kobo.147.4">Each Pod has a unique IP address that’s shared by all the containers in the Pod. </span><span class="koboSpan" id="kobo.147.5">A Pod is normally created as a workload resource, such as a Kubernetes Deployment or Kubernetes Job.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.148.1"><img alt="Figure 6.3 – Namespaces, Pods, and containers " src="../Images/B20836_06_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.149.1">Figure 6.3: Namespaces, Pods, and containers</span></p>
<p class="normal"><span class="koboSpan" id="kobo.150.1">The</span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.151.1"> preceding</span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.152.1"> figure shows the relationship between namespaces, Pods, and containers in a Kubernetes cluster. </span><span class="koboSpan" id="kobo.152.2">In this figure, each namespace contains its own set of Pods and each Pod can contain one or more containers running in it.</span></p>
<h2 class="heading-2" id="_idParaDest-171"><span class="koboSpan" id="kobo.153.1">Deployment</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.154.1">A Deployment is used </span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.155.1">by Kubernetes to create or modify Pods that run containerized applications. </span><span class="koboSpan" id="kobo.155.2">For example, to deploy a containerized application, you create a configuration manifest file (usually in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.156.1">YAML</span></code><span class="koboSpan" id="kobo.157.1"> file format) that specifies details, such as the container deployment name, namespaces, container image URI, number of Pod replicas, and the communication port for the application. </span><span class="koboSpan" id="kobo.157.2">After the Deployment is applied using a Kubernetes client utility (</span><code class="inlineCode"><span class="koboSpan" id="kobo.158.1">kubectl</span></code><span class="koboSpan" id="kobo.159.1">), the corresponding Pods running the specified container images will be created on the worker nodes. </span><span class="koboSpan" id="kobo.159.2">The following example creates a Deployment of Pods for an </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">nginx</span></code><span class="koboSpan" id="kobo.161.1"> server with the desired specification:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.162.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.163.1">apps/v1</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.164.1"># k8s API version used for creating this deployment</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.165.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.166.1">Deployment</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.167.1"># the type of object. </span><span class="koboSpan" id="kobo.167.2">In this case, it is deployment</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.168.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.169.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.170.1">nginx-deployment</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.171.1"># name of the deployment</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.172.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.173.1">selector:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.174.1">matchLabels:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.175.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.176.1">nginx</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.177.1"># an app label for the deployment.  </span><span class="koboSpan" id="kobo.177.2">This can be used to look up/select Pods</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.178.1">replicas:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.179.1">2</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.180.1"># tells deployment to run 2 Pods matching the template</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.181.1">template:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.182.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.183.1">labels:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.184.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.185.1">nginx</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.186.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.187.1">containers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.188.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.189.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.190.1">nginx</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.191.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.192.1">nginx:1.14.2</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.193.1"># Docker container image used for the deployment</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.194.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.195.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.196.1">containerPort:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.197.1">80</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.198.1"># the networking port to communicate with the containers</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.199.1">The following </span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.200.1">figure shows the flow of applying the preceding deployment manifest file to a Kubernetes cluster and creating two Pods to host two copies of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.201.1">nginx</span></code><span class="koboSpan" id="kobo.202.1"> container:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.203.1"><img alt="Figure 6.4 – Creating an Nginx deployment " src="../Images/B20836_06_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.204.1">Figure 6.4: Creating an nginx deployment</span></p>
<p class="normal"><span class="koboSpan" id="kobo.205.1">After the Deployment, a Deployment controller monitors the deployed container instances. </span><span class="koboSpan" id="kobo.205.2">If an instance goes down, the controller will replace it with another instance on the worker node.</span></p>
<h2 class="heading-2" id="_idParaDest-172"><span class="koboSpan" id="kobo.206.1">Kubernetes Job</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.207.1">A </span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.208.1">Kubernetes Job is a controller that creates one or more Pods to run some tasks and ensures the job is successfully completed. </span><span class="koboSpan" id="kobo.208.2">If a number of Pods fail due to node failure or other system issues, a Kubernetes Job will recreate the Pods to complete the task. </span><span class="koboSpan" id="kobo.208.3">A Kubernetes Job can be used to run batch-oriented tasks, such as running batch data processing scripts, ML model training scripts, or ML batch inference scripts on a large number of inference requests. </span><span class="koboSpan" id="kobo.208.4">After a Job is completed, the Pods are not terminated, so you can access the Job logs and inspect the detailed status of the Job. </span><span class="koboSpan" id="kobo.208.5">The following is an example template for running a training job:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.209.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.210.1">batch/v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.211.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.212.1">Job</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.213.1"># indicate that this is the Kubernetes Job resource</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.214.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.215.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.216.1">train-job</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.217.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.218.1">template:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.219.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.220.1">containers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.221.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.222.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.223.1">train-container</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.224.1">imagePullPolicy:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.225.1">Always</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.226.1"># tell the job to always pull a new container image when it is started</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.227.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.228.1">&lt;uri</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.229.1">to</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.230.1">Docker</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.231.1">image</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.232.1">containing</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.233.1">training</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.234.1">script&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.235.1">command:</span></span><span class="koboSpan" id="kobo.236.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.237.1">"python3"</span></span><span class="koboSpan" id="kobo.238.1">,  </span><span class="hljs-string"><span class="koboSpan" id="kobo.239.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.240.1">train.py"</span></span><span class="koboSpan" id="kobo.241.1">]  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.242.1"># tell the container to run this command after it is started</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.243.1">restartPolicy:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.244.1">Never</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.245.1">backoffLimit:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.246.1">0</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.247.1">Note that this configuration contains a parameter called </span><code class="inlineCode"><span class="koboSpan" id="kobo.248.1">restartPolicy</span></code><span class="koboSpan" id="kobo.249.1">, which controls how the Pod is restarted when the container exits and fails. </span><span class="koboSpan" id="kobo.249.2">There are three configurations:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.250.1">OnFailure</span></code><span class="koboSpan" id="kobo.251.1">: Only restart the Pod if it fails, not if it succeeds. </span><span class="koboSpan" id="kobo.251.2">This is the default.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">Never</span></code><span class="koboSpan" id="kobo.253.1">: Do not restart the Pod under any circumstances.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.254.1">Always</span></code><span class="koboSpan" id="kobo.255.1">: Always restart the Pod regardless of its exit status.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.256.1">You can use this parameter to control whether you want to restart training if the container terminates on failure.</span></p>
<h2 class="heading-2" id="_idParaDest-173"><span class="koboSpan" id="kobo.257.1">Kubernetes custom resources and operators</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.258.1">Kubernetes </span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.259.1">provides a list of built-in resources, such as Pods or Deployments for different needs. </span><span class="koboSpan" id="kobo.259.2">It also allows you to create </span><strong class="keyWord"><span class="koboSpan" id="kobo.260.1">custom resources</span></strong><span class="koboSpan" id="kobo.261.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.262.1">CRs</span></strong><span class="koboSpan" id="kobo.263.1">) and </span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.264.1">manage them just like the built-in resources, and you can use the same tools (such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.265.1">kubectl</span></code><span class="koboSpan" id="kobo.266.1">) to manage them. </span><span class="koboSpan" id="kobo.266.2">When you create the CR in Kubernetes, Kubernetes creates a new API (for example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.267.1">&lt;custom resource name&gt;/&lt;version&gt;</span></code><span class="koboSpan" id="kobo.268.1">) for each version of the resource. </span><span class="koboSpan" id="kobo.268.2">This is also known as </span><em class="italic"><span class="koboSpan" id="kobo.269.1">extending</span></em><span class="koboSpan" id="kobo.270.1"> the Kubernetes APIs. </span><span class="koboSpan" id="kobo.270.2">To create a CR, you</span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.271.1"> create a </span><strong class="keyWord"><span class="koboSpan" id="kobo.272.1">custom resource definition</span></strong><span class="koboSpan" id="kobo.273.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.274.1">CRD</span></strong><span class="koboSpan" id="kobo.275.1">) </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">YAML</span></code><span class="koboSpan" id="kobo.277.1"> file. </span><span class="koboSpan" id="kobo.277.2">To </span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.278.1">register the CRD in Kubernetes, you simply run </span><code class="inlineCode"><span class="koboSpan" id="kobo.279.1">kubectl apply -f &lt;name of the CRD yaml file&gt;</span></code><span class="koboSpan" id="kobo.280.1"> to apply the file. </span><span class="koboSpan" id="kobo.280.2">After that, you can use it just like any other Kubernetes resource. </span><span class="koboSpan" id="kobo.280.3">For example, to manage a custom model training job on Kubernetes, you can define a CRD with specifications such as algorithm name, data encryption setting, training image, input data sources, number of job failure retries, number of replicas, and job liveness probe frequency.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.281.1">A Kubernetes operator is a controller that operates on a custom resource. </span><span class="koboSpan" id="kobo.281.2">The operator watches the CR types and takes specific actions to make the current state match the desired state, just as a built-in controller does. </span><span class="koboSpan" id="kobo.281.3">For example, if you want to create a training job for the training job CRD mentioned previously, you create an operator that monitors training job requests and performs application-specific actions to start up the Pods and run the training job throughout the lifecycle. </span><span class="koboSpan" id="kobo.281.4">The following figure shows the components involved with an operator deployment:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.282.1"><img alt="Figure 6.5 – A Kubernetes custom resource and its interaction with the operator " src="../Images/B20836_06_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.283.1">Figure 6.5: A Kubernetes custom resource and its interaction with the operator</span></p>
<p class="normal"><span class="koboSpan" id="kobo.284.1">The most </span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.285.1">common way to deploy an operator is to deploy a CR definition and the associated controller. </span><span class="koboSpan" id="kobo.285.2">The controller runs outside of the Kubernetes control plane, similar to running a containerized application in a Pod.</span></p>
<h2 class="heading-2" id="_idParaDest-174"><span class="koboSpan" id="kobo.286.1">Services</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.287.1">Kubernetes </span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.288.1">Services play a crucial role in enabling reliable and scalable communication between various components and applications within a Kubernetes cluster. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.289.1">As applications in a cluster are often dynamic and can be scaled up or down, Services provide a stable and abstracted endpoint that other components can use to access the running instances of those applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.290.1">At its core, a Kubernetes Service is an abstraction layer that exposes a set of Pods as a single, well-defined network endpoint. </span><span class="koboSpan" id="kobo.290.2">It acts as a load balancer, distributing incoming network traffic to the available Pods behind the Service. </span><span class="koboSpan" id="kobo.290.3">This abstraction allows applications to interact with the Service without needing to know the specific details of the underlying Pods or their IP addresses.</span></p>
<h1 class="heading-1" id="_idParaDest-175"><span class="koboSpan" id="kobo.291.1">Networking on Kubernetes</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.292.1">Kubernetes</span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.293.1"> operates a flat private network among all the resources in a Kubernetes cluster. </span><span class="koboSpan" id="kobo.293.2">Within a cluster, all Pods can communicate with each </span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.294.1">other cluster-wide</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.295.1"> without a </span><strong class="keyWord"><span class="koboSpan" id="kobo.296.1">network address translation</span></strong><span class="koboSpan" id="kobo.297.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.298.1">NAT</span></strong><span class="koboSpan" id="kobo.299.1">). </span><span class="koboSpan" id="kobo.299.2">Kubernetes gives each Pod its own cluster private IP address, which is the same IP address seen by the Pod itself and what others see it as. </span><span class="koboSpan" id="kobo.299.3">All containers inside a single Pod can reach each container’s port on the localhost. </span><span class="koboSpan" id="kobo.299.4">All nodes in a cluster have their individually assigned IP addresses as well and can communicate with all Pods without a NAT. </span><span class="koboSpan" id="kobo.299.5">The following figure shows the different IP assignments for Pods and nodes, and communication flows from different resources:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.300.1"><img alt="Figure 6.6 – IP assignments and communication flow " src="../Images/B20836_06_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.301.1">Figure 6.6: IP assignments and communication flow</span></p>
<p class="normal"><span class="koboSpan" id="kobo.302.1">Sometimes, you might need a set of Pods running the same application container (the container for an </span><code class="inlineCode"><span class="koboSpan" id="kobo.303.1">nginx</span></code><span class="koboSpan" id="kobo.304.1"> application) for high availability and load balancing, for example. </span><span class="koboSpan" id="kobo.304.2">Instead of calling each Pod by its private IP address separately to access the application running in a Pod, you want to call an abstraction layer for this set of Pods, and this abstraction </span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.305.1">layer can dynamically send traffic to each Pod behind it. </span><span class="koboSpan" id="kobo.305.2">In this case, you can create a Kubernetes Service as an abstraction layer for a logical set of Pods. </span><span class="koboSpan" id="kobo.305.3">A Kubernetes Service can dynamically select the Pod behind it by matching an </span><code class="inlineCode"><span class="koboSpan" id="kobo.306.1">app</span></code><span class="koboSpan" id="kobo.307.1"> label for the Pod using a</span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.308.1"> Kubernetes feature called </span><code class="inlineCode"><span class="koboSpan" id="kobo.309.1">selector</span></code><span class="koboSpan" id="kobo.310.1">. </span><span class="koboSpan" id="kobo.310.2">The following example shows the specification that would create a Service called </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">nginx-service</span></code><span class="koboSpan" id="kobo.312.1">, which sends traffic to Pods with the app </span><code class="inlineCode"><span class="koboSpan" id="kobo.313.1">nginx</span></code><span class="koboSpan" id="kobo.314.1"> label on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.315.1">9376</span></code><span class="koboSpan" id="kobo.316.1">. </span><span class="koboSpan" id="kobo.316.2">A service is also assigned with its own cluster private IP address, so it is reachable by other resources inside a cluster:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.317.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.318.1">v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.319.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.320.1">Service</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.321.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.322.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.323.1">nginx-service</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.324.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.325.1">selector:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.326.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.327.1">nginx</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.328.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.329.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.330.1">protocol:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.331.1">TCP</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.332.1">port:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.333.1">80</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.334.1">targetPort:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.335.1">9376</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.336.1">In addition to using </span><code class="inlineCode"><span class="koboSpan" id="kobo.337.1">selector</span></code><span class="koboSpan" id="kobo.338.1"> to automatically detect Pods behind the service, you can also manually create an </span><code class="inlineCode"><span class="koboSpan" id="kobo.339.1">Endpoint</span></code><span class="koboSpan" id="kobo.340.1"> and map a fixed IP address and port to a service, as shown in the following example:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.341.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.342.1">v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.343.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.344.1">Endpoints</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.345.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.346.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.347.1">nginx-service</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.348.1">subsets:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.349.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.350.1">addresses:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.351.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.352.1">ip:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.353.1">192.0.2.42</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.354.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.355.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.356.1">port:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.357.1">9376</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.358.1">While nodes, Pods, and services are all assigned with cluster private IPs, these IPs are not routable from outside of a cluster. </span><span class="koboSpan" id="kobo.358.2">To access Pods or services from outside of a cluster, you have</span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.359.1"> the following options:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.360.1">Access from a node or Pod</span></strong><span class="koboSpan" id="kobo.361.1">: You can connect to the shell of a running Pod using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.362.1">kubectl exec</span></code><span class="koboSpan" id="kobo.363.1"> command and access other Pods, nodes, and services from the shell.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.364.1">Kubernetes proxy</span></strong><span class="koboSpan" id="kobo.365.1">: You can start a Kubernetes proxy </span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.366.1">to access services by running the </span><code class="inlineCode"><span class="koboSpan" id="kobo.367.1">kubectl proxy --port=&lt;port number&gt;</span></code><span class="koboSpan" id="kobo.368.1"> command on your local machine. </span><span class="koboSpan" id="kobo.368.2">Once the proxy is running, you can access nodes, Pods, or services. </span><span class="koboSpan" id="kobo.368.3">For example, you can access a service using the following scheme:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.369.1">http://localhost:&lt;port number&gt;/api/v1/proxy/namespaces/&lt;NAMESPACE&gt;/services/&lt;SERVICE NAME&gt;:&lt;PORT NAME&gt;
</span></code></pre>
</li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.370.1">NodePort</span></strong><span class="koboSpan" id="kobo.371.1">: </span><code class="inlineCode"><span class="koboSpan" id="kobo.372.1">NodePort</span></code><span class="koboSpan" id="kobo.373.1"> opens</span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.374.1"> a specific port on all the worker nodes, and any traffic </span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.375.1">sent to this port on the IP address of any of the nodes is forwarded to the service behind the port. </span><span class="koboSpan" id="kobo.375.2">The nodes’ IP addresses need to be routable from external sources. </span><span class="koboSpan" id="kobo.375.3">The following figure shows the communication flow using </span><code class="inlineCode"><span class="koboSpan" id="kobo.376.1">NodePort</span></code><span class="koboSpan" id="kobo.377.1">:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.378.1"><img alt="Figure 6.7 – Accessing Kubernetes Service via NodePort " src="../Images/B20836_06_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.379.1">Figure 6.7: Accessing a Kubernetes Service via NodePort</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.380.1">NodePort</span></code><span class="koboSpan" id="kobo.381.1"> is simple to use, but it has some limitations, such as one service per </span><code class="inlineCode"><span class="koboSpan" id="kobo.382.1">NodePort</span></code><span class="koboSpan" id="kobo.383.1">, a fixed port range to use (</span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">3000</span></code><span class="koboSpan" id="kobo.385.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.386.1">32767</span></code><span class="koboSpan" id="kobo.387.1">), and you need to know the IP addresses of individual worker nodes.</span></p></li>
</ul>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.388.1">Load balancer</span></strong><span class="koboSpan" id="kobo.389.1">: A load balancer</span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.390.1"> is a way to expose services to the internet when you use a cloud provider such as AWS. </span><span class="koboSpan" id="kobo.390.2">With a load balancer, you get a public IP address that’s accessible to the internet, and all traffic sent to the IP address will </span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.391.1">be forwarded to the service behind the load balancer. </span><span class="koboSpan" id="kobo.391.2">A load balancer is not part of Kubernetes and it is provided by whatever cloud infrastructure</span><a id="_idIndexMarker578"/><span class="koboSpan" id="kobo.392.1"> a Kubernetes cluster resides on (for example, AWS). </span><span class="koboSpan" id="kobo.392.2">The following figure shows the communication flow from a load balancer to services and Pods:
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.393.1"><img alt="Figure 6.8 – Accessing a Kubernetes service via a load balancer " src="../Images/B20836_06_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.394.1">Figure 6.8: Accessing a Kubernetes Service via a load balancer</span></p>
<p class="normal"><span class="koboSpan" id="kobo.395.1">A load balancer</span><a id="_idIndexMarker579"/><span class="koboSpan" id="kobo.396.1"> allows you to choose the exact port to use and can support multiple ports per service. </span><span class="koboSpan" id="kobo.396.2">However, it does require a separate load balancer per service.</span></p></li>
</ul>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.397.1">Ingress</span></strong><span class="koboSpan" id="kobo.398.1">: An Ingress gateway</span><a id="_idIndexMarker580"/><span class="koboSpan" id="kobo.399.1"> is the entry point to a cluster. </span><span class="koboSpan" id="kobo.399.2">It acts as a load balancer and routes incoming traffic to the different services based on routing rules.
    </span><figure class="mediaobject"><span class="koboSpan" id="kobo.400.1"><img alt="Figure 6.9 – Accessing a Kubernetes service via Ingress " src="../Images/B20836_06_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.401.1">Figure 6.9: Accessing a Kubernetes Service via Ingress</span></p></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.402.1">An Ingress</span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.403.1"> is different from a load balancer and </span><code class="inlineCode"><span class="koboSpan" id="kobo.404.1">NodePort</span></code><span class="koboSpan" id="kobo.405.1"> in that it acts as a proxy to manage traffic to clusters. </span><span class="koboSpan" id="kobo.405.2">It works with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.406.1">NodePort</span></code><span class="koboSpan" id="kobo.407.1"> and load balancer and routes the traffic to the different services. </span><span class="koboSpan" id="kobo.407.2">The Ingress way is becoming more commonly used, especially in combination with a load balancer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.408.1">In addition</span><a id="_idIndexMarker582"/><span class="koboSpan" id="kobo.409.1"> to network traffic management from outside of the cluster, another important aspect of Kubernetes network management is to control the traffic flow between different Pods and services within a cluster. </span><span class="koboSpan" id="kobo.409.2">For example, you might want to allow certain traffic to access a Pod or service while denying traffic from other sources. </span><span class="koboSpan" id="kobo.409.3">This is especially important for applications built on microservices architecture, as there could be many services or Pods that need to work together. </span><span class="koboSpan" id="kobo.409.4">Such a network of microservices is also</span><a id="_idIndexMarker583"/><span class="koboSpan" id="kobo.410.1"> called a </span><strong class="keyWord"><span class="koboSpan" id="kobo.411.1">service mesh</span></strong><span class="koboSpan" id="kobo.412.1">. </span><span class="koboSpan" id="kobo.412.2">As the number of services grows larger, it becomes challenging to understand and manage the networking requirements, such as </span><em class="italic"><span class="koboSpan" id="kobo.413.1">service discovery</span></em><span class="koboSpan" id="kobo.414.1">, </span><em class="italic"><span class="koboSpan" id="kobo.415.1">network routing</span></em><span class="koboSpan" id="kobo.416.1">, </span><em class="italic"><span class="koboSpan" id="kobo.417.1">network metrics</span></em><span class="koboSpan" id="kobo.418.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.419.1">failure recovery</span></em><span class="koboSpan" id="kobo.420.1">. </span><strong class="keyWord"><span class="koboSpan" id="kobo.421.1">Istio</span></strong><span class="koboSpan" id="kobo.422.1"> is an</span><a id="_idIndexMarker584"/><span class="koboSpan" id="kobo.423.1"> open-source service mesh management software that makes it easy to manage a large service mesh on Kubernetes, and it provides the following core functions:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.424.1">Ingress</span></strong><span class="koboSpan" id="kobo.425.1">: Istio </span><a id="_idIndexMarker585"/><span class="koboSpan" id="kobo.426.1">provides an Ingress gateway that can be used to expose Pods and services inside a service mesh to the internet. </span><span class="koboSpan" id="kobo.426.2">It acts as a load balancer that manages the inbound and outbound traffic for the service mesh. </span><span class="koboSpan" id="kobo.426.3">A gateway only allows traffic to come in/out of a mesh – it does not do routing of the traffic. </span><span class="koboSpan" id="kobo.426.4">To route traffic from the gateway to the service inside the service mesh, you create an object called </span><code class="inlineCode"><span class="koboSpan" id="kobo.427.1">VirtualService</span></code><span class="koboSpan" id="kobo.428.1"> to provide routing rules to route incoming traffic to different destinations inside a cluster, and you create a binding between virtual services and the gateway object to connect the two.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.429.1">Network traffic management</span></strong><span class="koboSpan" id="kobo.430.1">: Istio provides easy rule-based network routing to</span><a id="_idIndexMarker586"/><span class="koboSpan" id="kobo.431.1"> control the flow of traffic and API calls between</span><a id="_idIndexMarker587"/><span class="koboSpan" id="kobo.432.1"> different services. </span><span class="koboSpan" id="kobo.432.2">When Istio is installed, it automatically detects services and endpoints in a cluster. </span><span class="koboSpan" id="kobo.432.3">Istio uses an object called </span><code class="inlineCode"><span class="koboSpan" id="kobo.433.1">VirtualService</span></code><span class="koboSpan" id="kobo.434.1"> to provide routing rules to route incoming traffic to different destinations inside a cluster. </span><span class="koboSpan" id="kobo.434.2">Istio uses a load balancer called </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">gateway</span></code><span class="koboSpan" id="kobo.436.1"> to manage the inbound and outbound traffic for the network mesh. </span><span class="koboSpan" id="kobo.436.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.437.1">gateway</span></code><span class="koboSpan" id="kobo.438.1"> load balancer only allows traffic to come in/out of a mesh – it does not do routing of the traffic. </span><span class="koboSpan" id="kobo.438.2">To route traffic from the gateway, you create a binding between virtual services and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.439.1">gateway</span></code><span class="koboSpan" id="kobo.440.1"> object.
    </span><p class="normal"><span class="koboSpan" id="kobo.441.1">In order to manage the traffic in and out of a Pod, an Envoy proxy component (aka </span><code class="inlineCode"><span class="koboSpan" id="kobo.442.1">sidecar</span></code><span class="koboSpan" id="kobo.443.1">) is injected into a Pod, and it intercepts and decides how to route all traffic. </span><span class="koboSpan" id="kobo.443.2">The Istio component that manages the traffic configurations of the sidecars and service discovery is called the </span><code class="inlineCode"><span class="koboSpan" id="kobo.444.1">Pilot</span></code><span class="koboSpan" id="kobo.445.1">. </span><span class="koboSpan" id="kobo.445.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.446.1">Citadel</span></code><span class="koboSpan" id="kobo.447.1"> component manages authentication for service to service and end user. </span><span class="koboSpan" id="kobo.447.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.448.1">Gallery</span></code><span class="koboSpan" id="kobo.449.1"> component is responsible for insulating other Istio components from the underlying Kubernetes infrastructure. </span><span class="koboSpan" id="kobo.449.2">The following figure shows the architecture of Istio on Kubernetes:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.450.1"><img alt="Figure 6.10 – Istio architecture " src="../Images/B20836_06_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.451.1">Figure 6.10: Istio architecture</span></p></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.452.1">Istio also </span><a id="_idIndexMarker588"/><span class="koboSpan" id="kobo.453.1">has support for security and observability, which are critical for building production systems:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.454.1">Security</span></strong><span class="koboSpan" id="kobo.455.1">: Istio provides</span><a id="_idIndexMarker589"/><span class="koboSpan" id="kobo.456.1"> authentication and authorization for inter-service communications.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.457.1">Observability</span></strong><span class="koboSpan" id="kobo.458.1">: Istio captures metrics, logs, and traces of all service communications within a cluster. </span><span class="koboSpan" id="kobo.458.2">Examples of metrics include network latency, errors, and saturation. </span><span class="koboSpan" id="kobo.458.3">Examples of traces include call flows and service dependencies within a mesh.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.459.1">Istio can handle a wide range of Deployment needs, such as load balancing and service-to-service authentication. </span><span class="koboSpan" id="kobo.459.2">It can even extend to other clusters.</span></p>
<h1 class="heading-1" id="_idParaDest-176"><span class="koboSpan" id="kobo.460.1">Security and access management</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.461.1">Security</span><a id="_idIndexMarker590"/><span class="koboSpan" id="kobo.462.1"> is a critical consideration for building production-grade systems on Kubernetes. </span><span class="koboSpan" id="kobo.462.2">As a practitioner planning to use Kubernetes as the foundational platform for ML, it is important to become familiar with the various security aspects of Kubernetes. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.463.1">Kubernetes has many built-in security features. </span><span class="koboSpan" id="kobo.463.2">These security features allow you to implement fine-grained network traffic control and access control to different Kubernetes APIs and services. </span><span class="koboSpan" id="kobo.463.3">In this section, we will discuss network security, authentication, and authorization.</span></p>
<h2 class="heading-2" id="_idParaDest-177"><span class="koboSpan" id="kobo.464.1">API authentication and authorization</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.465.1">Access </span><a id="_idIndexMarker591"/><span class="koboSpan" id="kobo.466.1">to Kubernetes APIs can be authenticated and authorized for both users</span><a id="_idIndexMarker592"/><span class="koboSpan" id="kobo.467.1"> and Kubernetes </span><strong class="keyWord"><span class="koboSpan" id="kobo.468.1">service accounts</span></strong><span class="koboSpan" id="kobo.469.1"> (a service account provides an identity for processes running in a Pod).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.470.1">Users are handled outside of Kubernetes, and there are a number of user authentication strategies for Kubernetes:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.471.1">X.509 client certificate</span></strong><span class="koboSpan" id="kobo.472.1">: A </span><a id="_idIndexMarker593"/><span class="koboSpan" id="kobo.473.1">signed certificate is sent to the API server for authentication. </span><span class="koboSpan" id="kobo.473.2">The API server verifies this with the certificate authority to validate the user.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.474.1">Single sign-on with OpenID Connect</span></strong><span class="koboSpan" id="kobo.475.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.476.1">OIDC</span></strong><span class="koboSpan" id="kobo.477.1">): The user authenticates with the OIDC </span><a id="_idIndexMarker594"/><span class="koboSpan" id="kobo.478.1">provider and receives a bearer</span><a id="_idIndexMarker595"/><span class="koboSpan" id="kobo.479.1"> token (</span><strong class="keyWord"><span class="koboSpan" id="kobo.480.1">JSON</span></strong> <strong class="keyWord"><span class="koboSpan" id="kobo.481.1">Web Token </span></strong><span class="koboSpan" id="kobo.482.1">(</span><strong class="keyWord"><span class="koboSpan" id="kobo.483.1">JWT</span></strong><span class="koboSpan" id="kobo.484.1">)) that contains information about the user. </span><span class="koboSpan" id="kobo.484.2">The user passes the bearer token to the API server, which verifies the validity of the token by checking the certificate in the token.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.485.1">HTTP basic authentication</span></strong><span class="koboSpan" id="kobo.486.1">: HTTP basic authentication</span><a id="_idIndexMarker596"/><span class="koboSpan" id="kobo.487.1"> requires a user ID and password to be sent as part of the API request, and it validates the user ID and password against a password file associated with the API server.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.488.1">Authentication proxy</span></strong><span class="koboSpan" id="kobo.489.1">: The </span><a id="_idIndexMarker597"/><span class="koboSpan" id="kobo.490.1">API server extracts the user identity in the HTTP header and verifies the user with the certificate authority.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.491.1">Authentication webhook</span></strong><span class="koboSpan" id="kobo.492.1">: An</span><a id="_idIndexMarker598"/><span class="koboSpan" id="kobo.493.1"> external service is used for handling the authentication for the API server.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.494.1">Service accounts are used to provide identity for processes running in a Pod. </span><span class="koboSpan" id="kobo.494.2">They are created and managed in Kubernetes. </span><span class="koboSpan" id="kobo.494.3">Service accounts need to reside within a namespace, by default. </span><span class="koboSpan" id="kobo.494.4">There is also a </span><em class="italic"><span class="koboSpan" id="kobo.495.1">default</span></em><span class="koboSpan" id="kobo.496.1"> service account in each namespace. </span><span class="koboSpan" id="kobo.496.2">If a Pod is not assigned a service account, the default service account will be assigned to the Pod. </span><span class="koboSpan" id="kobo.496.3">A service account has an associated authentication token, saved as a Kubernetes Secret, and used for API authentication. </span><span class="koboSpan" id="kobo.496.4">A Kubernetes Secret is used for storing sensitive information such as passwords, authentication tokens, and SSH keys. </span><span class="koboSpan" id="kobo.496.5">We will cover Secrets in more detail later in this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.497.1">After a user or service account is authenticated, the request needs to be authorized to perform allowed operations. </span><span class="koboSpan" id="kobo.497.2">Kubernetes authorizes authenticated requests using the API server in the control plane, and it has several modes for authorization:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.498.1">Attribute-based access control</span></strong><span class="koboSpan" id="kobo.499.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.500.1">ABAC</span></strong><span class="koboSpan" id="kobo.501.1">): Access rights are granted to users through</span><a id="_idIndexMarker599"/><span class="koboSpan" id="kobo.502.1"> policies. </span><span class="koboSpan" id="kobo.502.2">Note that every service account has a corresponding username. </span><span class="koboSpan" id="kobo.502.3">The following sample policy allows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.503.1">joe</span></code><span class="koboSpan" id="kobo.504.1"> user access to all APIs in all namespaces.
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation"><span class="koboSpan" id="kobo.505.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.506.1">"apiVersion"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.507.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.508.1">"abac.authorization.kubernetes.io/v1beta1"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.509.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.510.1">"kind"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.511.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.512.1">"Policy"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.513.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.514.1">"spec"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.515.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.516.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.517.1">"user"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.518.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.519.1">"joe"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.520.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.521.1">"namespace"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.522.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.523.1">"*"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.524.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.525.1">"resource"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.526.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.527.1">"*"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.528.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.529.1">"apiGroup"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.530.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.531.1">"*"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.532.1">}</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.533.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.534.1">The following policy allows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.535.1">system:serviceaccount:kube-system:default</span></code><span class="koboSpan" id="kobo.536.1"> service account access to all APIs in all namespaces:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation"><span class="koboSpan" id="kobo.537.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.538.1">"apiVersion"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.539.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.540.1">"abac.authorization.kubernetes.io/v1beta1"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.541.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.542.1">"kind"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.543.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.544.1">"Policy"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.545.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.546.1">"spec"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.547.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.548.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.549.1">"user"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.550.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.551.1">"system:serviceaccount:kube-system:default"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.552.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.553.1">"namespace"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.554.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.555.1">"*"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.556.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.557.1">"resource"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.558.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.559.1">"*"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.560.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.561.1">"apiGroup"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.562.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.563.1">"*"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.564.1">}</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.565.1">}</span></span>
</code></pre></li>
</ul>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.566.1">Role-based access control</span></strong><span class="koboSpan" id="kobo.567.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.568.1">RBAC</span></strong><span class="koboSpan" id="kobo.569.1">): Access</span><a id="_idIndexMarker600"/><span class="koboSpan" id="kobo.570.1"> rights are granted based on the role of a user. </span><span class="koboSpan" id="kobo.570.2">RBAC authorizes using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.571.1">rbac.authorization.k8s.io</span></code><span class="koboSpan" id="kobo.572.1"> API group. </span><span class="koboSpan" id="kobo.572.2">The RBAC API works with four Kubernetes objects: </span><code class="inlineCode"><span class="koboSpan" id="kobo.573.1">Role</span></code><span class="koboSpan" id="kobo.574.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.575.1">ClusterRole</span></code><span class="koboSpan" id="kobo.576.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.577.1">RoleBinding</span></code><span class="koboSpan" id="kobo.578.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">ClusterRoleBinding</span></code><span class="koboSpan" id="kobo.580.1">.</span></li>
</ul>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.581.1">Role</span></code><span class="koboSpan" id="kobo.582.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.583.1">ClusterRole</span></code><span class="koboSpan" id="kobo.584.1"> contain a set of permissions. </span><span class="koboSpan" id="kobo.584.2">The permissions are </span><em class="italic"><span class="koboSpan" id="kobo.585.1">additive</span></em><span class="koboSpan" id="kobo.586.1">, meaning</span><a id="_idIndexMarker601"/><span class="koboSpan" id="kobo.587.1"> there are no deny permissions, and you need to explicitly add permission to resources. </span><span class="koboSpan" id="kobo.587.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.588.1">Role</span></code><span class="koboSpan" id="kobo.589.1"> object is namespaced and is used to specify permissions within a namespace. </span><span class="koboSpan" id="kobo.589.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.590.1">ClusterRole</span></code><span class="koboSpan" id="kobo.591.1"> object is non-namespaced but can be used for granting permission for a given namespace or cluster-scoped permissions. </span><span class="koboSpan" id="kobo.591.2">See the following illustration:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.592.1"><img alt="" role="presentation" src="../Images/B20836_06_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.593.1">Figure 6.11: Role versus ClusterRole</span></p>
<p class="normal"><span class="koboSpan" id="kobo.594.1">The</span><a id="_idIndexMarker602"/><span class="koboSpan" id="kobo.595.1"> following .</span><code class="inlineCode"><span class="koboSpan" id="kobo.596.1">yaml</span></code><span class="koboSpan" id="kobo.597.1"> file provides get, watch, and list access to all Pods resources in the default namespace for the core API group:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.598.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.599.1">rbac.authorization.k8s.io/v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.600.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.601.1">Role</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.602.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.603.1">namespace:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.604.1">default</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.605.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.606.1">pod-reader</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.607.1">rules:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.608.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.609.1">apiGroups:</span></span><span class="koboSpan" id="kobo.610.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.611.1">""</span></span><span class="koboSpan" id="kobo.612.1">]
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.613.1">resources:</span></span><span class="koboSpan" id="kobo.614.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.615.1">"pods"</span></span><span class="koboSpan" id="kobo.616.1">]
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.617.1">verbs:</span></span><span class="koboSpan" id="kobo.618.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.619.1">"get"</span></span><span class="koboSpan" id="kobo.620.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.621.1">"watch"</span></span><span class="koboSpan" id="kobo.622.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.623.1">"list"</span></span><span class="koboSpan" id="kobo.624.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.625.1">The following policy allows get, watch, and list access for all Kubernetes nodes across the cluster:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.626.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.627.1">rbac.authorization.k8s.io/v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.628.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.629.1">ClusterRole</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.630.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.631.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.632.1">nodes-reader</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.633.1">rules:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.634.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.635.1">apiGroups:</span></span><span class="koboSpan" id="kobo.636.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.637.1">""</span></span><span class="koboSpan" id="kobo.638.1">]
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.639.1">resources:</span></span><span class="koboSpan" id="kobo.640.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.641.1">"nodes"</span></span><span class="koboSpan" id="kobo.642.1">]
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.643.1">verbs:</span></span><span class="koboSpan" id="kobo.644.1"> [</span><span class="hljs-string"><span class="koboSpan" id="kobo.645.1">"get"</span></span><span class="koboSpan" id="kobo.646.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.647.1">"watch"</span></span><span class="koboSpan" id="kobo.648.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.649.1">"list"</span></span><span class="koboSpan" id="kobo.650.1">]
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.651.1">RoleBinding</span></code><span class="koboSpan" id="kobo.652.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.653.1">ClusterRoleBinding</span></code><span class="koboSpan" id="kobo.654.1"> grant permissions defined in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.655.1">Role</span></code><span class="koboSpan" id="kobo.656.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.657.1">ClusterRole</span></code><span class="koboSpan" id="kobo.658.1"> object </span><a id="_idIndexMarker603"/><span class="koboSpan" id="kobo.659.1">to a user or set of users with reference to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.660.1">Role</span></code><span class="koboSpan" id="kobo.661.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.662.1">ClusterRole</span></code><span class="koboSpan" id="kobo.663.1"> object. </span><span class="koboSpan" id="kobo.663.2">The following policy binds the </span><code class="inlineCode"><span class="koboSpan" id="kobo.664.1">joe</span></code><span class="koboSpan" id="kobo.665.1"> user to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.666.1">pod-reader</span></code><span class="koboSpan" id="kobo.667.1"> role:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.668.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.669.1">rbac.authorization.k8s.io/v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.670.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.671.1">RoleBinding</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.672.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.673.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.674.1">read-pods</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.675.1">namespace:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.676.1">default</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.677.1">subjects:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.678.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.679.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.680.1">User</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.681.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.682.1">joe</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.683.1">apiGroup:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.684.1">rbac.authorization.k8s.io</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.685.1">roleRef:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.686.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.687.1">Role</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.688.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.689.1">pod-reader</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.690.1">apiGroup:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.691.1">rbac.authorization.k8s.io</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.692.1">The following </span><code class="inlineCode"><span class="koboSpan" id="kobo.693.1">RoleBinding</span></code><span class="koboSpan" id="kobo.694.1"> object binds a service account, </span><code class="inlineCode"><span class="koboSpan" id="kobo.695.1">SA-name</span></code><span class="koboSpan" id="kobo.696.1">, to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.697.1">ClusterRole</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.698.1">secret-reader</span></code><span class="koboSpan" id="kobo.699.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.700.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.701.1">rbac.authorization.k8s.io/v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.702.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.703.1">ClusterRoleBinding</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.704.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.705.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.706.1">read-secrets-global</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.707.1">subjects:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.708.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.709.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.710.1">ServiceAccount</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.711.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.712.1">SA-name</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.713.1">namespace:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.714.1">default</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.715.1">roleRef:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.716.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.717.1">ClusterRole</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.718.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.719.1">secret-reader</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.720.1">apiGroup:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.721.1">rbac.authorization.k8s.io</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.722.1">Kubernetes has a built-in feature for storing and managing sensitive information such as passwords. </span><span class="koboSpan" id="kobo.722.2">Instead of storing this sensitive information directly in plain text in a Pod, you can store this information as Kubernetes Secrets, and provide specific access to them using Kubernetes RBAC to create and/or read these Secrets. </span><span class="koboSpan" id="kobo.722.3">By default, Secrets are stored as unencrypted plain-text Base64-encoded strings, and data encryption at rest can be enabled for the Secrets. </span><span class="koboSpan" id="kobo.722.4">The following policy shows how to create a secret for storing AWS </span><a id="_idIndexMarker604"/><span class="koboSpan" id="kobo.723.1">access credentials:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.724.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.725.1">v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.726.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.727.1">Secret</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.728.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.729.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.730.1">aws-secret</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.731.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.732.1">Opaque</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.733.1">data:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.734.1">AWS_ACCESS_KEY_ID:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.735.1">XXXX</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.736.1">AWS_SECRET_ACCESS_KEY:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.737.1">XXXX</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.738.1">There are several ways to use a secret in a Pod:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.739.1">As environment variables in the Pod specification template:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.740.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.741.1">v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.742.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.743.1">Pod</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.744.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.745.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.746.1">secret-env-pod</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.747.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.748.1">containers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.749.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.750.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.751.1">mycontainer</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.752.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.753.1">redis</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.754.1">env:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.755.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.756.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.757.1">SECRET_AWS_ACCESS_KEY</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.758.1">valueFrom:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.759.1">secretKeyRef:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.760.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.761.1">aws-secret</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.762.1">key:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.763.1">AWS_ACCESS_KEY_ID</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.764.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.765.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.766.1">SECRET_AWS_SECRET_ACCESS_KEY</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.767.1">valueFrom:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.768.1">secretKeyRef:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.769.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.770.1">aws-secret</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.771.1">key:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.772.1">AWS_SECRET_ACCESS_KEY</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.773.1">restartPolicy:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.774.1">Never</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.775.1">The application code inside the container can access the Secrets just like other environment variables.</span></p></li>
</ul>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.776.1">As a file in a volume mounted on a Pod:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.777.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.778.1">v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.779.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.780.1">Pod</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.781.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.782.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.783.1">pod-ml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.784.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.785.1">containers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.786.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.787.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.788.1">pod-ml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.789.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.790.1">&lt;Docker</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.791.1">image</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.792.1">uri&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.793.1">volumeMounts:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.794.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.795.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.796.1">vol-ml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.797.1">mountPath:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.798.1">"/etc/aws"</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.799.1">readOnly:</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.800.1">true</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.801.1">volumes:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.802.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.803.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.804.1">vol-ml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.805.1">Secret:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.806.1">secretName:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.807.1">aws-secret</span></span>
</code></pre>
</li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.808.1">In the previous examples, you will see files in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.809.1">/etc/aws</span></code><span class="koboSpan" id="kobo.810.1"> folder in a Pod for each corresponding secret name (such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.811.1">SECRET_AWS_ACCESS_KEY</span></code><span class="koboSpan" id="kobo.812.1">) that contains the values for the Secrets.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.813.1">We </span><a id="_idIndexMarker605"/><span class="koboSpan" id="kobo.814.1">now know what containers are and how they can be deployed on a Kubernetes cluster. </span><span class="koboSpan" id="kobo.814.2">We also understand how to configure networking on Kubernetes to allow Pods to communicate with each other and how to expose a Kubernetes container for external access outside of the cluster using different networking options.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.815.1">Kubernetes can serve as the foundational infrastructure for running ML workloads. </span><span class="koboSpan" id="kobo.815.2">For example, you can run</span><a id="_idIndexMarker606"/><span class="koboSpan" id="kobo.816.1"> a </span><strong class="keyWord"><span class="koboSpan" id="kobo.817.1">Jupyter</span></strong> <strong class="keyWord"><span class="koboSpan" id="kobo.818.1">notebook</span></strong><span class="koboSpan" id="kobo.819.1"> as a containerized application on Kubernetes as your data science environment for experimentation and model building. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.820.1">You can also run a model training job as a Kubernetes Job if you need additional resources, and then serve the model as a containerized web service application or run batch inferences on trained models as a Kubernetes Job. </span><span class="koboSpan" id="kobo.820.2">In the following hands-on exercise, you will learn how to use Kubernetes as the foundational infrastructure for running ML workloads.</span></p>
<h1 class="heading-1" id="_idParaDest-178"><span class="koboSpan" id="kobo.821.1">Hands-on – creating a Kubernetes infrastructure on AWS</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.822.1">In this</span><a id="_idIndexMarker607"/><span class="koboSpan" id="kobo.823.1"> section, you will create a Kubernetes environment using Amazon EKS, a managed Kubernetes environment on AWS, which makes it easier to set up a Kubernetes cluster. </span><span class="koboSpan" id="kobo.823.2">Let’s first look at the problem statement.</span></p>
<h2 class="heading-2" id="_idParaDest-179"><span class="koboSpan" id="kobo.824.1">Problem statement</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.825.1">As an ML solutions </span><a id="_idIndexMarker608"/><span class="koboSpan" id="kobo.826.1">architect, you have been tasked with evaluating Kubernetes as a potential infrastructure platform for building an ML platform for one business unit in your bank. </span><span class="koboSpan" id="kobo.826.2">You need to build a sandbox environment on AWS and demonstrate that you can deploy a Jupyter notebook as a containerized application for your data scientists to use.</span></p>
<h2 class="heading-2" id="_idParaDest-180"><span class="koboSpan" id="kobo.827.1">Lab instruction</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.828.1">In this</span><a id="_idIndexMarker609"/><span class="koboSpan" id="kobo.829.1"> hands-on exercise, you are going to create a Kubernetes environment using Amazon EKS, which is a managed service for Kubernetes on AWS that creates and configures a Kubernetes cluster with both master and worker nodes automatically. </span><span class="koboSpan" id="kobo.829.2">EKS provisions and scales the control plane, including the API server and backend persistent layer. </span><span class="koboSpan" id="kobo.829.3">It also runs the open-source Kubernetes and is compatible with all Kubernetes-based applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.830.1">After the EKS cluster is created, you will explore the EKS environment to inspect some of its core components, and then you will learn how to deploy a containerized Jupyter Notebook application and make it accessible from the internet.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.831.1">Let’s complete the following steps to get started:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.832.1">Launch the AWS CloudShell service.
    </span><p class="normal"><span class="koboSpan" id="kobo.833.1">Log on to your AWS account, select the </span><strong class="screenText"><span class="koboSpan" id="kobo.834.1">Oregon</span></strong><span class="koboSpan" id="kobo.835.1"> Region, and launch AWS CloudShell. </span><span class="koboSpan" id="kobo.835.2">CloudShell is an AWS service that provides a browser-based </span><strong class="keyWord"><span class="koboSpan" id="kobo.836.1">Linux</span></strong><span class="koboSpan" id="kobo.837.1"> terminal environment to interact with AWS resources. </span><span class="koboSpan" id="kobo.837.2">With CloudShell, you authenticate using your AWS console credential and can easily run </span><strong class="keyWord"><span class="koboSpan" id="kobo.838.1">AWS</span></strong> <strong class="keyWord"><span class="koboSpan" id="kobo.839.1">CLI</span></strong><span class="koboSpan" id="kobo.840.1">, </span><strong class="keyWord"><span class="koboSpan" id="kobo.841.1">AWS</span></strong> <strong class="keyWord"><span class="koboSpan" id="kobo.842.1">SDK</span></strong><span class="koboSpan" id="kobo.843.1">, and other tools.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.844.1">Install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.845.1">eksctl</span></code><span class="koboSpan" id="kobo.846.1"> utility.
    </span><p class="normal"><span class="koboSpan" id="kobo.847.1">Follow the installation instructions for Unix at </span><a href="https://github.com/weaveworks/eksctl/blob/main/README.md#installation"><span class="url"><span class="koboSpan" id="kobo.848.1">https://github.com/weaveworks/eksctl/blob/main/README.md#installation</span></span></a><span class="koboSpan" id="kobo.849.1"> to install eksctl. </span><span class="koboSpan" id="kobo.849.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.850.1">eksctl</span></code><span class="koboSpan" id="kobo.851.1"> utility is a command-line utility for managing the EKS cluster. </span><span class="koboSpan" id="kobo.851.2">We will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.852.1">eksctl</span></code><span class="koboSpan" id="kobo.853.1"> utility to create a Kubernetes cluster on Amazon EKS in </span><em class="italic"><span class="koboSpan" id="kobo.854.1">Step 3</span></em><span class="koboSpan" id="kobo.855.1">:</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.856.1">Run the following command to start creating an EKS cluster in the </span><strong class="screenText"><span class="koboSpan" id="kobo.857.1">Oregon</span></strong><span class="koboSpan" id="kobo.858.1"> Region inside your AWS account. </span><span class="koboSpan" id="kobo.858.2">It will take about 15 minutes to complete running the setup:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.859.1">eksctl create cluster --name &lt;cluster name&gt; --region us-west-2
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.860.1">The</span><a id="_idIndexMarker610"/><span class="koboSpan" id="kobo.861.1"> command will launch a </span><code class="inlineCode"><span class="koboSpan" id="kobo.862.1">cloudformation</span></code><span class="koboSpan" id="kobo.863.1"> template and this will create the following resources:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.864.1">An Amazon EKS cluster with two worker nodes inside a new Amazon </span><strong class="keyWord"><span class="koboSpan" id="kobo.865.1">virtual private cloud</span></strong><span class="koboSpan" id="kobo.866.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.867.1">VPC</span></strong><span class="koboSpan" id="kobo.868.1">). </span><span class="koboSpan" id="kobo.868.2">Amazon EKS provides fully managed Kubernetes master nodes, so you won’t see the master nodes inside your private VPC.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.869.1">An EKS cluster configuration file saved in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.870.1">/home/cloudshell-user/.kube/config</span></code><span class="koboSpan" id="kobo.871.1"> directory on CloudShell. </span><span class="koboSpan" id="kobo.871.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.872.1">config</span></code><span class="koboSpan" id="kobo.873.1"> file contains details such as the API server </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">url</span></code><span class="koboSpan" id="kobo.875.1"> address, the name of the admin user for managing the cluster, and the client certificate for authenticating to the Kubernetes cluster. </span><span class="koboSpan" id="kobo.875.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.876.1">kubectl</span></code><span class="koboSpan" id="kobo.877.1"> utility uses information in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">config</span></code><span class="koboSpan" id="kobo.879.1"> file to connect and authenticate to the Kubernetes API server.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.880.1">EKS organizes worker nodes into logical groups called </span><code class="inlineCode"><span class="koboSpan" id="kobo.881.1">nodegroup</span></code><span class="koboSpan" id="kobo.882.1">. </span><span class="koboSpan" id="kobo.882.2">Run the following command to look up the </span><code class="inlineCode"><span class="koboSpan" id="kobo.883.1">nodegroup</span></code><span class="koboSpan" id="kobo.884.1"> name. </span><span class="koboSpan" id="kobo.884.2">You can look up the name of the cluster in the EKS management console. </span><span class="koboSpan" id="kobo.884.3">The name of the node group should look something like </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">ng-xxxxxxxx</span></code><span class="koboSpan" id="kobo.886.1">:
        </span><pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.887.1">eksctl get nodegroup --cluster=&lt;cluster name&gt;
</span></code></pre>
</li>
</ul></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.888.1">Install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.889.1">kubectl</span></code><span class="koboSpan" id="kobo.890.1"> utility.
    </span><p class="normal"><span class="koboSpan" id="kobo.891.1">Follow the instructions at </span><a href="https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html"><span class="url"><span class="koboSpan" id="kobo.892.1">https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html</span></span></a><span class="koboSpan" id="kobo.893.1"> to install kubectl for Linux. </span><span class="koboSpan" id="kobo.893.2">You will need to know the version of the Kubernetes server to install the matching kubectl version. </span><span class="koboSpan" id="kobo.893.3">You can find the version of the Kubernetes server using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.894.1">kubectl version --short</span></code><span class="koboSpan" id="kobo.895.1"> command.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.896.1">Explore the cluster.
    </span><p class="normal"><span class="koboSpan" id="kobo.897.1">Now the cluster is up, let’s explore it a bit. </span><span class="koboSpan" id="kobo.897.2">Try running the following commands in the CloudShell terminal and see what is returned:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.898.1"><img alt="Table 6.1 – kubectl commands " src="../Images/B20836_06_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.899.1">Figure 6.12: kubectl commands</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.900.1">Deploy a Jupyter notebook.
    </span><p class="normal"><span class="koboSpan" id="kobo.901.1">Let’s </span><a id="_idIndexMarker611"/><span class="koboSpan" id="kobo.902.1">deploy a Jupyter Notebook server as a containerized application. </span><span class="koboSpan" id="kobo.902.2">Copy and run the following code block. </span><span class="koboSpan" id="kobo.902.3">It should create a file called </span><code class="inlineCode"><span class="koboSpan" id="kobo.903.1">deploy_Jupyter_notebook.yaml</span></code><span class="koboSpan" id="kobo.904.1">. </span><span class="koboSpan" id="kobo.904.2">We will use a container image from the Docker Hub image repository:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-string"><span class="koboSpan" id="kobo.905.1">cat</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.906.1">&lt;&lt;</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.907.1">EOF</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.908.1">&gt;</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.909.1">deploy_Jupyter_notebook.yaml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.910.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.911.1">apps/v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.912.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.913.1">Deployment</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.914.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.915.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.916.1">jupyter-notebook</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.917.1">labels:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.918.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.919.1">jupyter-notebook</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.920.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.921.1">replicas:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.922.1">1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.923.1">selector:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.924.1">matchLabels:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.925.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.926.1">jupyter-notebook</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.927.1">template:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.928.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.929.1">labels:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.930.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.931.1">jupyter-notebook</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.932.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.933.1">containers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.934.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.935.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.936.1">minimal-notebook</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.937.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.938.1">jupyter/minimal-notebook:latest</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.939.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.940.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.941.1">containerPort:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.942.1">8888</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.943.1">EOF</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.944.1">Now, let’s create a Deployment by running the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.945.1">kubectl apply -f deploy_Jupyter_notebook.yaml.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.946.1">Check to make sure the Pod is running by executing </span><code class="inlineCode"><span class="koboSpan" id="kobo.947.1">kubectl get pods</span></code><span class="koboSpan" id="kobo.948.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.949.1">Check the logs of the Jupyter server Pod by running </span><code class="inlineCode"><span class="koboSpan" id="kobo.950.1">kubectl logs &lt;name of notebook pod&gt;</span></code><span class="koboSpan" id="kobo.951.1">. </span><span class="koboSpan" id="kobo.951.2">Find the section in the logs that contains </span><code class="inlineCode"><span class="koboSpan" id="kobo.952.1">http://jupyter-notebook-598f56bf4b-spqn4:8888/?token=XXXXXXX...</span></code><span class="koboSpan" id="kobo.953.1">, and copy the token (</span><code class="inlineCode"><span class="koboSpan" id="kobo.954.1">XXXXXX…</span></code><span class="koboSpan" id="kobo.955.1">) portion. </span><span class="koboSpan" id="kobo.955.2">We will use the token for </span><em class="italic"><span class="koboSpan" id="kobo.956.1">Step 8</span></em><span class="koboSpan" id="kobo.957.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.958.1">You can also access the Pod using an interactive shell by running </span><code class="inlineCode"><span class="koboSpan" id="kobo.959.1">kubectl exec --stdin --tty &lt;name of notebook pod&gt; -- /bin/sh</span></code><span class="koboSpan" id="kobo.960.1">. </span><span class="koboSpan" id="kobo.960.2">Run </span><code class="inlineCode"><span class="koboSpan" id="kobo.961.1">ps aux</span></code><span class="koboSpan" id="kobo.962.1"> to see a list of running processes. </span><span class="koboSpan" id="kobo.962.2">You will see a process related to the Jupyter notebook.</span></p></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.963.1">Expose the Jupyter notebook to the internet.
    </span><p class="normal"><span class="koboSpan" id="kobo.964.1">At </span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.965.1">this point, we have a Jupyter server running in a Docker container in a Kubernetes Pod on top of two EC2 instances in an AWS VPC but we can’t get to it because the Kubernetes cluster doesn’t expose a route to the container. </span><span class="koboSpan" id="kobo.965.2">We will create a Kubernetes Service to expose the Jupyter Notebook server to the internet so it can be accessed from a browser.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.966.1">Run the following code block to create a specification file for a new Service. </span><span class="koboSpan" id="kobo.966.2">It should create a file called </span><code class="inlineCode"><span class="koboSpan" id="kobo.967.1">jupyter_svc.yaml</span></code><span class="koboSpan" id="kobo.968.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-string"><span class="koboSpan" id="kobo.969.1">cat</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.970.1">&lt;&lt;</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.971.1">EOF</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.972.1">&gt;</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.973.1">jupyter_svc.yaml</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.974.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.975.1">v1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.976.1">kind:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.977.1">Service</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.978.1">metadata:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.979.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.980.1">jupyter-service</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.981.1">annotations:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.982.1">service.beta.kubernetes.io/aws-load-balancer-type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.983.1">alb</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.984.1">spec:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.985.1">selector:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.986.1">app:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.987.1">jupyter-notebook</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.988.1">ports:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.989.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.990.1">protocol:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.991.1">TCP</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.992.1">port:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.993.1">80</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.994.1">targetPort:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.995.1">8888</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.996.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.997.1">LoadBalancer</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.998.1">EOF</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.999.1">After the file is created, run </span><code class="inlineCode"><span class="koboSpan" id="kobo.1000.1">kubectl apply -f jupyter_svc.yaml</span></code><span class="koboSpan" id="kobo.1001.1"> to create the service. </span><span class="koboSpan" id="kobo.1001.2">A new Kubernetes Service called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1002.1">jupyter-service</span></code><span class="koboSpan" id="kobo.1003.1">, as well as a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1004.1">LoadBalancer</span></code><span class="koboSpan" id="kobo.1005.1"> object, should be created. </span><span class="koboSpan" id="kobo.1005.2">You can verify the service by running </span><code class="inlineCode"><span class="koboSpan" id="kobo.1006.1">kubectl get service</span></code><span class="koboSpan" id="kobo.1007.1">. </span><span class="koboSpan" id="kobo.1007.2">Note and copy the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1008.1">EXTERNAL-IP</span></code><span class="koboSpan" id="kobo.1009.1"> address associated with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1010.1">jupyter-service</span></code><span class="koboSpan" id="kobo.1011.1"> service.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1012.1">Paste </span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.1013.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1014.1">EXTERNAL-IP</span></code><span class="koboSpan" id="kobo.1015.1"> address into a new browser window and enter the token you copied earlier into the </span><strong class="screenText"><span class="koboSpan" id="kobo.1016.1">Password or token</span></strong><span class="koboSpan" id="kobo.1017.1"> field to log in as shown in the following screenshot. </span><span class="koboSpan" id="kobo.1017.2">You should see a Jupyter Notebook window showing up:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1018.1"><img alt="Figure 6.11 – Jupyter login screen " src="../Images/B20836_06_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1019.1">Figure 6.13: Jupyter login screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1020.1">The following diagram shows the environment that you have created after working through the hands-on exercise.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1021.1"><img alt="Figure 6.12 – Jupyter notebook deployment on the EKS cluster " src="../Images/B20836_06_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1022.1">Figure 6.14: Jupyter Notebook deployment on the EKS cluster</span></p></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1023.1">Congratulations, you</span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.1024.1"> have successfully created a new Amazon EKS cluster on AWS and deployed a Jupyter server instance as a container on the cluster. </span><span class="koboSpan" id="kobo.1024.2">We will reuse this EKS cluster for the next chapter. </span><span class="koboSpan" id="kobo.1024.3">However, if you don’t plan to use this EKS for a period of time, it is recommended to shut down the cluster to avoid unnecessary costs. </span><span class="koboSpan" id="kobo.1024.4">To shut down the cluster, run </span><code class="inlineCode"><span class="koboSpan" id="kobo.1025.1">kubectl delete svc &lt;service name&gt;</span></code><span class="koboSpan" id="kobo.1026.1"> to delete the service first. </span><span class="koboSpan" id="kobo.1026.2">Then run </span><code class="inlineCode"><span class="koboSpan" id="kobo.1027.1">eksctl delete cluster --name &lt;cluster name&gt;</span></code><span class="koboSpan" id="kobo.1028.1"> to delete the cluster.</span></p>
<h1 class="heading-1" id="_idParaDest-181"><span class="koboSpan" id="kobo.1029.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1030.1">In this chapter, we covered Kubernetes, a robust container management platform that forms the infrastructure foundation for constructing open-source ML platforms. </span><span class="koboSpan" id="kobo.1030.2">Throughout this chapter, you gained an understanding of containers and insights into the functioning of Kubernetes. </span><span class="koboSpan" id="kobo.1030.3">Moreover, you acquired hands-on experience in establishing a Kubernetes cluster on AWS by leveraging AWS EKS. </span><span class="koboSpan" id="kobo.1030.4">Additionally, we explored the process of deploying a containerized Jupyter Notebook application onto the cluster, thereby creating a fundamental data science environment. </span><span class="koboSpan" id="kobo.1030.5">In the next chapter, we will shift our focus toward exploring a selection of open-source ML platforms that seamlessly integrate with the Kubernetes infrastructure.</span></p>
<h1 class="heading-1"><span class="koboSpan" id="kobo.1031.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1032.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/mlsah "><span class="url"><span class="koboSpan" id="kobo.1033.1">https://packt.link/mlsah</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.1034.1"><img alt="" role="presentation" src="../Images/QR_Code7020572834663656.png"/></span></p>
</div>
</body></html>