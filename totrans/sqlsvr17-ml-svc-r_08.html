<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying, Managing, and Monitoring Database Solutions containing R Code</h1>
                
            
            <article>
                
<p class="calibre2">Operationalizing R code in a SQL Server database means that data scientists/database developers can also leverage productionizing data science solutions as part of <strong class="calibre1">Database Lifecycle Management</strong> (<strong class="calibre1">DLM</strong>). This includes the following:</p>
<ul class="calibre7">
<li class="calibre8">Checking in R code as part of a SQL Server database project into a version control</li>
<li class="calibre8">Adding the stored procedures for the data science solution as part of SQL Server unit tests</li>
<li class="calibre8">Integrating the data science solution into the <strong class="calibre1">Continuous Integration/Continuous Delivery</strong> (<strong class="calibre1">CI/CD</strong>) process</li>
<li class="calibre8">Monitoring performance of the data science solution in the production on a regular basis</li>
</ul>
<p class="calibre2">In this chapter, we will be using <strong class="calibre1">SQL Server Data Tools</strong> (<strong class="calibre1">SSDT</strong>) in Visual Studio 2017 and Visual Studio Team Services to perform this DLM workflow. However, the underlying concept can be applied to any other CI/CD platform that you or your team might already be using.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Integrating R into the SQL Server Database lifecycle workflow</h1>
                
            
            <article>
                
<p class="calibre2">Earlier in <a target="_blank" href="part0102.html#318PC0-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 7</a>, <em class="calibre12">Operationalizing R Prediction Models</em>, we discussed how to create an R project in Visual Studio 2017. We also talked about integrating R code as part of <kbd class="calibre11">sp_execute_external_script</kbd> in SQL Server. Here, we will revisit Visual Studio 2017, specifically in the context of integrating R code in <kbd class="calibre11">sp_execute_external_script</kbd> as part of a SQL Server Database Project, and holistically as part of the database lifecycle workflow.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Preparing your environment for the database lifecycle workflow</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will discuss the stages of the database lifecycle workflow and the tools that we will be using. For each of the stages in the workflow, there will also be some suggested alternatives for you to explore.</p>
<ol class="calibre14">
<li value="1" class="calibre8"><strong class="calibre1">Coding and managing SQL Server database projects/solutions</strong>: There are a few different ways to manage your SQL Server DML/DDL scripts that form a SQL Server database project. SQL SSDT in Visual Studio 2017 (VS2017) is a mature product that formalizes the creation and modification of Database Schema and Objects. In this section, we will use SSDT in VS2017.</li>
</ol>
<p class="calibre34">You can use VS2017 Community, Professional, or Enterprise editions. Please check <a href="https://www.visualstudio.com/vs/compare/" target="_blank" class="calibre10"><span>https://www.visualstudio.com/vs/compare/</span></a> for more up-to-date information on how these editions compare. In the walkthroughs and examples in this section, we will be using Visual Studio Enterprise Edition, but you can use any of the editions. You can download these from: <span><a href="https://www.visualstudio.com/vs/" class="calibre10">https://www.visualstudio.com/vs/</a>.</span></p>
<p class="calibre34">Other following alternatives worth trying are:</p>
<ul class="calibre7">
<li class="front-matter">
<ul class="calibre17">
<li class="calibre8"><strong class="calibre1">SQL Server Management Studio</strong>: There are a few plugins developed by RedGate that can enrich DevOps/Database Lifecycle Management</li>
<li class="calibre8"><strong class="calibre1">SQL Operations Studio</strong> (in Preview): This tool is built based on VS Code, which means that it has high potential of meeting DevOps workflows too, including source control</li>
</ul>
</li>
</ul>
<ol start="2" class="calibre14">
<li value="2" class="calibre8"><strong class="calibre1">Unit testing</strong>: Just like application development, database development would benefit from a unit testing framework, especially if it can be automated. There are two well-known unit testing frameworks that are available for SQL Server databases, tSQLt, and SQL Server Unit Test integrated in Visual Studio. Here are the links:</li>
</ol>
<ul class="calibre7">
<li class="front-matter">
<ul class="calibre17">
<li class="calibre8"><strong class="calibre1">tSQLt</strong>: <a href="http://tsqlt.org/" target="_blank" class="calibre10"><span>http://tsqlt.org/</span></a></li>
<li class="calibre8"><strong class="calibre1">SQL Server Unit Test in Visual Studio</strong>: <span><a href="https://msdn.microsoft.com/en-us/library/jj851200(v=vs.103).aspx" class="calibre10">https://msdn.microsoft.com/en-us/library/jj851200(v=vs.103).aspx</a></span></li>
</ul>
</li>
</ul>
<p class="calibre34">In this section, we will use SQL Server Unit Test in VS2017.</p>
<p class="calibre34">Another tool worth trying is:</p>
<ul class="calibre7">
<li class="front-matter">
<ul class="calibre17">
<li class="calibre8">RedGate SQL Test that is based on the tSQLt framework, an extension of SSMS</li>
</ul>
</li>
</ul>
<ol start="3" class="calibre14">
<li value="3" class="calibre8"><strong class="calibre1">Version Control</strong>: There are a number of popular choices for Version Control systems out there, for example, Git and <strong class="calibre1">Team Foundation Version Control</strong> (<strong class="calibre1">TFVC</strong>). In this section, we will use TFVC hosted in <strong class="calibre1">Visual Studio Team Services</strong> (<strong class="calibre1">VSTS</strong>). VS2017 can connect to a VSTS repository. You can sign up for a VSTS account online at: <span><a href="https://www.visualstudio.com/team-services/" target="_blank" class="calibre10"><span>https://www.visualstudio.com/team-services/</span></a>.</span></li>
</ol>
<p class="calibre34">Other alternatives worth trying are:</p>
<p class="calibre34">Using Visual Studio, you can connect to online version control hosts, such as GitHub and VSTS, as well as a private on-premises version control servers, such as <strong class="calibre1">Team Foundation Server</strong> (<strong class="calibre1">TFS</strong>):</p>
<ul class="calibre7">
<li class="front-matter">
<ul class="calibre17">
<li class="calibre8"><strong class="calibre1">GitHub Extension for Visual Studio</strong>: <span><a href="https://visualstudio.github.com/" class="calibre10">https://visualstudio.github.com/</a></span></li>
<li class="calibre8"><strong class="calibre1">Team Foundation Server</strong>: <a href="https://www.visualstudio.com/tfs/" target="_blank" class="calibre10"><span>https://www.visualstudio.com/tfs/</span></a></li>
</ul>
</li>
</ul>
<ol start="4" class="calibre14">
<li value="4" class="calibre8"><strong class="calibre1">CI/CD</strong>: VSTS supports both hosted agent and private agent. Hosted agent is a cloud-based agent that performs continuous integration and continuous delivery. Private agent is an on-premises-based agent version, available in Visual Studio 2017. Having CI in place means that as the script is checked in, the agent will automatically build and optionally perform a number of tests. Having CD in place allows us to test the code release and/or the schema changes only against the baseline. In this chapter, we will use VSTS with a private agent to deploy against an on-premises SQL Server database.</li>
</ol>
<p class="calibre34">Other alternatives worth trying are:</p>
<ul class="calibre7">
<li class="front-matter">
<ul class="calibre17">
<li class="calibre8">VSTS supports the hosted agent, which allows you to deploy automatically to Azure VM</li>
<li class="calibre8">VSTS supports the hosted agent, which allows you to deploy to the Azure SQL Database, which since October 2017, also supports R</li>
</ul>
</li>
</ul>
<p class="calibre34"><em class="calibre12">Figure 8.1</em> shows a CI/CD workflow using VSTS, which we will use in this chapter for our sample SQL Server R Services solution:</p>
<div class="packt_figure"><img class="aligncenter65" src="../images/00124.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.1 CI/CD process using VSTS</div>
<p class="calibre2">Source: <a href="https://docs.microsoft.com/en-us/vsts/build-release/actions/ci-cd-part-1" target="_blank" class="calibre10"><span>https://docs.microsoft.com/en-us/vsts/build-release/actions/ci-cd-part-1</span></a></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Prerequisites for this chapter</h1>
                
            
            <article>
                
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Tools</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">URL</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Notes</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Visual Studio 2017</strong></p>
</td>
<td class="calibre22">
<p class="calibre2">To download: <a href="https://www.visualstudio.com/downloads/" target="_blank" class="calibre10">https://www.visualstudio.com/downloads/</a></p>
</td>
<td class="calibre22">
<p class="calibre2">The Community Edition is free.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">VSTS</strong></p>
</td>
<td class="calibre22">
<p class="calibre2">Sign up/sign in: <a href="https://www.visualstudio.com/team-services/" target="_blank" class="calibre10">https://www.visualstudio.com/team-services/</a></p>
</td>
<td class="calibre22">
<p class="calibre2">Sign up for the personal account for free.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Power Shell v2.0 or above</strong></p>
</td>
<td class="calibre22">
<p class="calibre2">Download PowerShell: <a href="https://www.microsoft.com/en-us/download/details.aspx?id=42554" target="_blank" class="calibre10">https://www.microsoft.com/en-us/download/details.aspx?id=42554</a></p>
</td>
<td class="calibre22">
<p class="calibre2">You will need this for setting up the Private Agent locally.</p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating the SQL Server database project</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will walk you through how to create a database project in VS2017.</p>
<ol class="calibre14">
<li value="1" class="calibre8">In VS2017, click on <span>File </span>| <span>New Project</span>.</li>
<li value="2" class="calibre8">Choose <span>SQL Server</span> from Installed on the left pane and click on the <span>SQL Server Database Project</span> template.</li>
<li value="3" class="calibre8">Type <span><kbd class="calibre11">Ch08</kbd> in the <span>Name:</span> field and <kbd class="calibre11">SQL Server R Services Book</kbd> in the <span>Solution name:</span> file, as shown in the </span>following screenshot: </li>
</ol>
<div class="packt_figure"><img class="aligncenter66" src="../images/00125.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.2 New Project in Visual Studio</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Choose the <span>Location</span> to save the solution.</li>
</ol>
<div class="packt_tip">If you already have a local folder for your version control, you can specify the path here.</div>
<p class="calibre34">In this example, my VSTS project is named <span>SQL Server R Services Book</span>, which is associated to my local folder named <kbd class="calibre11">C:\VSTS\SQL Server R Services Book</kbd>.</p>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Ensure that both Create directory for solution and Add to Source Control are checked.</li>
<li value="6" class="calibre8">Click on <span>OK</span> in the <span>New Project</span> dialog box. The <span>Solution Explorer</span> window should show something similar to the following screenshot:</li>
</ol>
<div class="packt_figure"><img class="aligncenter67" src="../images/00126.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.3 Database Project in Solution Explorer</div>
<p class="calibre34">From here, you can add new objects such as a table, a stored procedure, and many other objects.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Importing an existing database into the project</h1>
                
            
            <article>
                
<p class="calibre2">Now that we have a blank database, we can import an existing database that you have created from Chapter 7, <em class="calibre12">Operationalizing R Prediction Models</em>:</p>
<ol class="calibre14">
<li value="1" class="calibre8">On <span>Ch08</span>, right-click and choose <span>Import</span> | <span>Database</span>:</li>
</ol>
<div class="packt_figure"><img class="aligncenter68" src="../images/00127.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.4 Import database into a database project</div>
<ol start="2" class="calibre14">
<li value="2" class="calibre8">In the <span>Import Database</span> dialog box, click on <span>Select Connection</span>. Then, specify the database connection to the database that you previously created in <a target="_blank" href="part0102.html#318PC0-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 7</a>, <em class="calibre12">Operationalizing R Prediction Models</em>.</li>
</ol>
<p class="calibre2"> </p>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">The <span>Import Database</span> dialog box should look like the following. Click on <span>Start</span>:</li>
</ol>
<div class="packt_figure"><img class="aligncenter69" src="../images/00128.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.5 Import Database dialog box</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">The <span>Import Database</span> dialog box then shows <span>Summary</span> of the import progress:</li>
</ol>
<div class="packt_figure"><img class="aligncenter70" src="../images/00129.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.6 Summary of database project import</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">The solution should look something as follows:</li>
</ol>
<div class="packt_figure"><img class="aligncenter71" src="../images/00130.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.7 Solution Explorer displaying a database project after the database is imported</div>
<ol start="6" class="calibre14">
<li value="6" class="calibre8">Before we make any more changes, let's build the solution by right-clicking on the root <span>Solution</span> node and choose <span>Build Solution</span>, or you can also click on <em class="calibre12">Ctrl</em> + <em class="calibre12">Shift</em> + <em class="calibre12">B</em>.</li>
</ol>
<p class="calibre34">Note that the output should contain a number of warnings for each stored procedure referring to the <kbd class="calibre11">sp_execute_external</kbd> script similar to the following:</p>
<pre class="calibre33"><strong class="calibre1">C:\VSTS\SQL Server R Services Book\SQL Server R Services Book\Ch08\dbo\Stored Procedures\uspTrainTipPredictionModelWithRealTimeScoring.sql(27,8): Warning:  SQL71502: Procedure: [dbo].[uspTrainTipPredictionModelWithRealTimeScoring] has an unresolved reference to object [dbo].[sp_execute_external_script].</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding a new stored procedure object</h1>
                
            
            <article>
                
<p class="calibre2">Here's an example of how to add a new object to an existing database project:</p>
<ol class="calibre14">
<li value="1" class="calibre8">To create a new procedure, you can right-click on the <kbd class="calibre11">Stored Procedures</kbd> folder, then click on <span>Add </span>| <span>Stored Procedure...</span></li>
<li value="2" class="calibre8">Type <kbd class="calibre11"><span>uspTrainTipPredictionModelWithRealTimeScoringDTree</span></kbd> in the <span>Name</span>  field as the new stored procedure:</li>
</ol>
<div class="packt_figure"><img class="aligncenter72" src="../images/00131.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.8 Adding a new item to a Database Project</div>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Add the following script to the stored procedure:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">CREATE PROCEDURE [dbo].[uspTrainTipPredictionModelWithRealTimeScoringDTree] 
AS 
BEGIN 
   DECLARE @auc FLOAT; 
   DECLARE @model VARBINARY(MAX); 
 
   -- The data to be used for training 
   DECLARE @inquery NVARCHAR(MAX)= N' 
         SELECT  
               tipped,  
               fare_amount,  
               passenger_count, 
               trip_time_in_secs, 
               trip_distance, 
               pickup_datetime,  
               dropoff_datetime, 
               dbo.fnCalculateDistance(pickup_latitude,  
                     pickup_longitude,   
                     dropoff_latitude,  
                     dropoff_longitude) as direct_distance 
         FROM dbo.nyctaxi_sample 
         TABLESAMPLE (10 PERCENT) REPEATABLE (98052)' 
 
-- Calculate the model based on the trained data and the AUC. 
EXEC sys.sp_execute_external_script @language = N'R', 
                                  @script = N' 
         ## Create model 
         dTreeObj&lt;- rxDTree(tipped ~ passenger_count + 
trip_distance + 
trip_time_in_secs + 
direct_distance, 
                    data = InputDataSet); 
 
treeCp &lt;- rxDTreeBestCp(dTreeObj); 
         dTreeObjChosen&lt;- prune.rxDTree(dTreeObj, cp = treeCp); 
 
         ## Serialize model             
         model &lt;- serialize(dTreeObjChosen, NULL); 
 
         predictTree &lt;- rxPredict(dTreeObjChosen, data = InputDataSet, overwrite = TRUE)               
          
        library('ROCR'); 
predOutput &lt;- cbind(InputDataSet, predictTree); 
 
auc &lt;- rxAuc(rxRoc("tipped", "tipped_Pred", predOutput)); 
print(paste0("AUC of Classification Model:", auc)); 
         ', 
     @input_data_1 = @inquery,    
     @output_data_1_name = N'trained_model', 
     @params= N'@auc FLOAT OUTPUT, @model VARBINARY(MAX) OUTPUT', 
     @auc= @auc OUTPUT, 
     @model = @model OUTPUT; 
    
-- Store the train model output and its AUC  
INSERT INTO [dbo].[NYCTaxiModel] (Model, AUC,IsRealTimeScoring) 
SELECT @model, @auc, 1; 
 
END</strong> </pre>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Press <em class="calibre12">Ctrl</em> + <em class="calibre12">S</em> to save the file.</li>
<li value="5" class="calibre8">You can now rebuild the solution using <em class="calibre12">Ctrl</em> + <em class="calibre12">Shift</em> + <em class="calibre12">B</em>.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Publishing schema changes</h1>
                
            
            <article>
                
<p class="calibre2">There are two options of publishing changes to an environment:</p>
<ul class="calibre7">
<li class="calibre8">Existing database</li>
<li class="calibre8">New database</li>
</ul>
<p class="calibre2">In this example, NYCTaxi already exists in the database. You can identify the schema changes and create an update script:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Right-click on <span>Ch08</span> and choose <span>Schema Compare.</span></li>
<li value="2" class="calibre8">Ensure that the source on the left is pointing to the database project path.</li>
<li value="3" class="calibre8">On the <span>Select Target</span> drop-down list, click on it to set the target database.</li>
<li value="4" class="calibre8">Choose <span>Database</span> and click on <span>Select Connection</span>. Here, you can provide connection to the existing <kbd class="calibre11">NYCTaxi</kbd> database.</li>
</ol>
<p class="calibre2"> </p>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Click on <span>Compare</span>, which should only show one file:</li>
</ol>
<div class="packt_figure"><img class="aligncenter73" src="../images/00132.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.9 Schema Compare in Visual Studio</div>
<ol start="6" class="calibre14">
<li value="6" class="calibre8">Here, you can click on <span>Update</span> to make the changes directly to the database or click on the <span>Generate Script</span> icon to generate the script for the changes.</li>
</ol>
<div class="packt_tip">As a best practice, especially if you have a formal production change management process, you would choose generate script and include it in the change management request.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding a unit test against a stored procedure</h1>
                
            
            <article>
                
<p class="calibre2">Adding a unit test against programmability objects, such as stored procedures or functions, is part of good practice of programming:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Create a unit test suite by right-clicking on one of the stored procedures or functions, such as <kbd class="calibre11">Ch08 </kbd>| <kbd class="calibre11">dbo</kbd> | <kbd class="calibre11">Stored Procedures</kbd> | <kbd class="calibre11">uspTrainTipPredictionModel</kbd>. Then, choose <span>Create Unit Tests...</span>:</li>
</ol>
<div class="packt_figure"><img class="aligncenter74" src="../images/00133.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.10 Creating unit test in Visual Studio</div>
<ol start="2" class="calibre14">
<li value="2" class="calibre8">Choose the connection:</li>
</ol>
<div class="packt_figure"><img class="aligncenter75" src="../images/00134.gif"/></div>
<div class="cdpaligncenter">Figure 8.11 SQL Server test configuration</div>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Once you click on <span>OK</span>, you will see a new unit test project created and an example of a unit test template created:</li>
</ol>
<div class="packt_figure"><img class="aligncenter76" src="../images/00135.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.12 SQL Server unit test template</div>
<p class="calibre34">On the top-right pane, you can curate your unit test cases. As  <kbd class="calibre11">dbo.uspTrianTipPredictionModel</kbd> trains sample data and stores the model as well as the AUC into <kbd class="calibre11">dbo.NYCTaxiModel</kbd>, we are going to create a unit test to ensure that:</p>
<ul class="calibre7">
<li class="front-matter">
<ul class="calibre17">
<li class="calibre8">The new record is inserted, and</li>
<li class="calibre8">The AUC created meets a certain threshold</li>
</ul>
</li>
</ul>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Copy the following code:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">-- database unit test for dbo.uspTrainTipPredictionModel</strong><br class="title-page-name"/><strong class="calibre1">DECLARE @RC AS INT;</strong><br class="title-page-name"/><strong class="calibre1">DECLARE @RowCountBefore AS INT;</strong><br class="title-page-name"/><strong class="calibre1">DECLARE @RowCountAfter AS INT;</strong><br class="title-page-name"/><strong class="calibre1">DECLARE @AUC FLOAT;</strong><br class="title-page-name"/><strong class="calibre1">SELECT @RC = 0;</strong></pre>
<pre class="calibre33"><strong class="calibre1">SELECT @RowCountBefore = IS NULL((SELECT COUNT(1) ROWCOUNT</strong><br class="title-page-name"/><strong class="calibre1">FROM [dbo].[NYCTaxiModel]</strong><br class="title-page-name"/><strong class="calibre1">WHERE [AUC] ISNOTNULL), 0);</strong><br class="title-page-name"/><strong class="calibre1">EXECUTE @RC = [dbo].[uspTrainTipPredictionModel];</strong><br class="title-page-name"/><strong class="calibre1">-- Expected value: there should be a new record added to NYCTaxiModel</strong><br class="title-page-name"/><strong class="calibre1">-- where AUC is known.</strong><br class="title-page-name"/><strong class="calibre1">SELECT @RowCountAfter = ISNULL((SELECTCOUNT(1)ROWCOUNT</strong><br class="title-page-name"/><strong class="calibre1">FROM [dbo].[NYCTaxiModel]</strong><br class="title-page-name"/><strong class="calibre1">WHERE [AUC] ISNOTNULL), 0);</strong><br class="title-page-name"/><strong class="calibre1">SELECT @AUC = (SELECTTOP 1 [AUC]</strong><br class="title-page-name"/><strong class="calibre1">FROM [dbo].[NYCTaxiModel]</strong><br class="title-page-name"/><strong class="calibre1">ORDER BY [CreatedOn] DESC);</strong><br class="title-page-name"/><strong class="calibre1">SELECT</strong><br class="title-page-name"/><strong class="calibre1">@RowCountAfter - @RowCountBeforeRowCountAdded,</strong><br class="title-page-name"/><strong class="calibre1">IIF(@AUC &gt; 0.5, 1, 0) AUCOfModel;</strong></pre>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">In the <span>Test Conditions</span> pane, click on <span>inconclusiveCondition1</span> and click on the red cross to delete it.</li>
<li value="6" class="calibre8">Now, choose <span>Scalar Value</span> from <span>Test Conditions</span> and click on the plus button.</li>
<li value="7" class="calibre8">Then, right-click on the <span>scalarValueCondition1</span> and click on <span>Properties</span>.</li>
<li value="8" class="calibre8">Update the following values in the <span>Properties</span> window:
<ol class="calibre15">
<li value="1" class="calibre8"><strong class="calibre1">Name</strong>: <kbd class="calibre11">TestNYCTaxiModelAdded</kbd></li>
<li value="2" class="calibre8"><strong class="calibre1">Expected value</strong>: <kbd class="calibre11">1</kbd></li>
<li value="3" class="calibre8"><strong class="calibre1">Null Expected</strong>: <kbd class="calibre11">False</kbd></li>
</ol>
</li>
<li value="9" class="calibre8">Repeat steps 6 to 8 and change the following values in the <span>Properties</span> window:
<ol class="calibre15">
<li value="1" class="calibre8"><strong class="calibre1">Name</strong>: <kbd class="calibre11">TestNYCTaxiModelAdded</kbd></li>
<li value="2" class="calibre8"><strong class="calibre1">Expected value</strong>: <kbd class="calibre11">1</kbd></li>
<li value="3" class="calibre8"><strong class="calibre1">Null Expected</strong>: <kbd class="calibre11">False</kbd></li>
</ol>
</li>
</ol>
<p class="calibre34">Once you have set things up, your Visual Studio should look something like this now:</p>
<div class="packt_figure"><img src="../images/00136.jpeg" class="calibre27"/></div>
<div class="cdpaligncenter">Figure 8.13 SQL Server unit test for dbo.uspTrainTipPredictionModel</div>
<ol start="10" class="calibre14">
<li value="10" class="calibre8">Remove <kbd class="calibre11">UnitTest.cs</kbd>.</li>
<li value="11" class="calibre8">Then, right-click on the <span>Ch08_Test</span> project and click on <span>Build</span>.</li>
<li value="12" class="calibre8">Navigate to <span>Test Explorer</span> and click on <span>Run All</span>.</li>
<li value="13" class="calibre8">In a few seconds, <kbd class="calibre11">dbo_uspTrainTipPredictionModelTest</kbd> appears under <span>Passed Test</span>. Click on it to see a summary of the execution.</li>
</ol>
<p class="calibre2"> </p>
<ol start="14" class="calibre14">
<li value="14" class="calibre8">Click on <span>Output</span> to see more details, for example:</li>
</ol>
<div class="packt_figure"><img src="../images/00137.jpeg" class="calibre80"/></div>
<div class="cdpaligncenter">Figure 8.14 Test execution results</div>
<p class="calibre2">You have <span>now</span> learned how to create a unit test against a stored procedure, executed against an existing stored procedure on an existing NYC Taxi Model. Ideally, the unit test is run against a recently published SQL Server.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Using version control</h1>
                
            
            <article>
                
<p class="calibre2">From Visual Studio, we can check in the solution and manage changes in version control. In this specific instance, we are using VSTS to check in. It is assumed that you have created a project in VSTS.</p>
<p class="calibre2">Here are the prerequisites for the rest of this section:</p>
<ol class="calibre14">
<li value="1" class="calibre8"><strong class="calibre1">A VSTS project</strong>: To set up a new VSTS project, simply go to: <a href="https://www.visualstudio.com/team-services/" target="_blank" class="calibre10">https://www.visualstudio.com/team-services/</a>.</li>
</ol>
<p class="calibre34">The URL for a VSTS project should follow this format:<br class="title-page-name"/>
<kbd class="calibre11"><span>https://&lt;your</span> account&gt;.visualstudio.com/&lt;VSTS Project&gt;</kbd></p>
<p class="calibre34">The VSTS project referred to in this chapter is named <kbd class="calibre11">SQL Server R Services Book</kbd>. So, the URL in my case is    <kbd class="calibre11">https://mssqlgirl.visualstudio.com/SQL%20Server%20R%20Services%20Book</kbd></p>
<ol start="2" class="calibre14">
<li value="2" class="calibre8">The VSTS project is mapped to a local folder.</li>
</ol>
<p class="calibre34">The local folder here mapped to the project is <kbd class="calibre11">C:\VSTS\SQL Server R Services Book</kbd>. Earlier in this chapter, we created the SQL Server database solution in this path.</p>
<p class="calibre2"> </p>
<p class="calibre2">Follow these steps to check in your solution from Visual Studio:</p>
<ol class="calibre14">
<li value="1" class="calibre8">On the <span>Solution</span> root node, right-click and choose <span>Check In</span>.</li>
<li value="2" class="calibre8">In the <span>Team Explorer</span> window, under the <span>Pending Changes</span>, type <kbd class="calibre11">Initial check-in</kbd> in the <span>Comment</span> text box.</li>
</ol>
<p class="calibre2"> </p>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Review <span>Related Work Items</span>, <span>Included Changes</span>, and <span>Excluded Changes</span> before you click on <span>Check In</span>:</li>
</ol>
<div class="packt_figure"><img class="aligncenter77" src="../images/00138.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.15 Checking in Pending Changes</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">On the <span>Check-in Confirmation</span> dialog box, click on <span>Yes</span>.</li>
</ol>
<p class="calibre2">Once all the files are checked in successfully, you can also view them on the VSTS site. As an example:</p>
<p class="calibre2"><kbd class="calibre11">https://mssqlgirl.visualstudio.com/SQL%20Server%20R%20Services%20Book/_versionControl</kbd></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Setting up continuous integration</h1>
                
            
            <article>
                
<p class="calibre2">The main idea of <strong class="calibre1">continuous integration</strong> (<strong class="calibre1">CI</strong>) is to perform builds that are automated based on one or more triggers. One of the triggers to perform a build is a check-in event. Another one could be a scheduled build. Choosing which trigger is appropriate depends on various factors, such as the complexity of the project and the culture of the team. In this section, because the project is small, we are going to automate the build triggered by check-ins. We will also add tests as part of the build.</p>
<p class="calibre2">VSTS is a good platform to automate builds, deployments for testing, and monitoring. In this section, we will configure a build definition and schedule a continuous integration in VSTS.</p>
<div class="packt_tip">Ensure that the Visual Studio solution, including the SQL Server database project and the SQL Server Unit Test project, are built successfully.</div>
<p class="calibre2"><em class="calibre12">Figure 8.16</em> shows the SQL Server R Services Book team in VSTS online. In these next few sections, we will be using VSTS on your browser to configure CI:</p>
<div class="packt_figure"><img src="../images/00139.jpeg" class="calibre81"/></div>
<div class="cdpaligncenter">Figure 8.16 Checking in Pending Changes</div>
<p class="calibre2">Here is a prerequisite for the rest of this section:</p>
<ul class="calibre7">
<li class="calibre8">To be able to deploy a SQL Server database project to an on-premises SQL Server instance, you will need to create a private agent hosted locally that is registered with VSTS. This is only available in Visual Studio 2017. To set this up, follow the documentation at: <a href="https://docs.microsoft.com/en-us/vsts/build-release/actions/agents/v2-windows" class="calibre10">https://docs.microsoft.com/en-us/vsts/build-release/actions/agents/v2-windows</a><span>.</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a build definition in VSTS</h1>
                
            
            <article>
                
<p class="calibre2">Follow these steps to create a build definition in VSTS:</p>
<ol class="calibre14">
<li value="1" class="calibre8">On the VSTS project site, click on <span>Build and Release</span> from the top menu, then choose <span>Builds</span>. Choose <span>New Definition</span>.</li>
<li value="2" class="calibre8">Start with Empty Process.</li>
<li value="3" class="calibre8">Under <span>Tasks</span>, go to <span>Process</span> and choose the private agent from the <span>Agent queue</span> drop-down list. In the mssqlgirl account, the private agent is named <span>Default</span>:</li>
</ol>
<div class="packt_figure"><img class="aligncenter78" src="../images/00140.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.17 Selecting Private Agent (Default) for the tasks in the build</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Review the selections in <span>Get sources</span>.</li>
</ol>
<div class="packt_tip">The local path under <kbd class="calibre31">$(build.sourcesdirectory)</kbd> is referring to the private agent's workspace to do builds and perform additional tasks.</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Click on <span>Phase 1</span> and replace the <span>Display name</span> value with <span>Build Phase</span>.</li>
<li value="6" class="calibre8">On the top menu, choose <span>Save</span> from the <span>Save &amp;amp; Queue</span> drop-down list.</li>
<li value="7" class="calibre8">Review <span>Save build definition</span> and place a comment.</li>
</ol>
<p class="calibre2"> </p>
<ol start="8" class="calibre14">
<li value="8" class="calibre8">Add a task to <span>Build Phase</span> by clicking on the plus sign.</li>
<li value="9" class="calibre8">In <span>Add tasks</span>, search for <span>MS Build</span>, then click on <span>Add</span>.</li>
<li value="10" class="calibre8">Change <span>Project</span> to <kbd class="calibre11">$/SQL Server R Services Book/SQL Server R Services Book/SQL Server R Services Book.sln</kbd>.</li>
</ol>
<div class="packt_tip">The default value is <kbd class="calibre31">**/*.sln</kbd>, which refers to all solution files in the VSTS project.</div>
<ol start="11" class="calibre14">
<li value="11" class="calibre8">On <span>Build Phase</span>, add another task, named <span>Publish Build Artifacts</span>. This allows us to get the files that can be important later, such as the DACPAC file.</li>
<li value="12" class="calibre8">On the <span>Publish Build Artifacts</span> task, specify the following details:
<ol class="calibre15">
<li value="1" class="calibre8"><span>Path to publish</span>: <kbd class="calibre11">$(Build.Repository.LocalPath)\SQL Server R Services Book\Ch08\bin\Debug</kbd></li>
<li value="2" class="calibre8"><span>Artifact name</span>: <kbd class="calibre11">DACPAC</kbd></li>
<li value="3" class="calibre8"><span>Artifact publish location</span>: <kbd class="calibre11">Visual Studio Team Services/TFS</kbd></li>
</ol>
</li>
</ol>
<p class="calibre34">In this step, we are only publishing the DACPAC file. Publishing this specific file in the Visual Studio Team Services area allows us to later refer to this DACPAC in the Release process (a Continuous Delivery step).</p>
<ol start="13" class="calibre14">
<li value="13" class="calibre8">Click on <span>Save &amp;amp; Queue</span> to test the build definition.</li>
<li value="14" class="calibre8">Review the options in queue build for SQL Server R Services Book-CI and click on <span>Queue</span>.</li>
</ol>
<p class="calibre2"> </p>
<ol start="15" class="calibre14">
<li value="15" class="calibre8">The page will then show that a build is being queued, similar to the following:</li>
</ol>
<div class="packt_figure"><img src="../images/00141.jpeg" class="calibre82"/></div>
<div class="cdpaligncenter">Figure 8.18 Adding publish artifact task</div>
<p class="calibre34">If the build is successful, you will see something similar to the following. Now would be a good time to get familiar with the Summary page of the build and the artifacts page:</p>
<div class="packt_figure"><img class="aligncenter79" src="../images/00142.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.19 Viewing build results</div>
<p class="calibre34">When you navigate to the <span>Artifacts</span> tab, you should be able to see the <kbd class="calibre11">DACPAC</kbd> folder. By clicking on <span>Explore</span>, you can see the files inside the solution including the build output similar to what a local build via Visual Studio would do:</p>
<div class="packt_figure2"><img class="aligncenter80" src="../images/00143.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.20 Exploring Artifacts published from the previous successful build</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying the build to a local SQL Server instance</h1>
                
            
            <article>
                
<p class="calibre2">Now that the build via VSTS on the private agent is successful, let's try deploying the database to an SQL Server instance. The prerequisite for this is that the private agent must be able to access the SQL Server instance. <em class="calibre12">Figure 8.21</em> shows how VSTS with on-premises (Private) agent(s) can be used for deploying to multiple on-premises servers/environments:</p>
<div class="packt_figure"><img src="../images/00144.jpeg" class="calibre83"/></div>
<div class="cdpaligncenter">Figure 8.21 High level layout of VSTS and On-prem agents/environment</div>
<p class="calibre2">Source: <a href="https://docs.microsoft.com/en-us/vsts/build-release/concepts/agents/agents" target="_blank" class="calibre10"><span>https://docs.microsoft.com/en-us/vsts/build-release/concepts/agents/agents</span></a></p>
<p class="calibre2">When a SQL Server database project is built, it will produce a DACPAC file that can be used to create a new database. So, in the <span>Build Phase</span> of the <span>SQL Server R Services Book-CI</span> build definition, we will add a new task:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Navigate to the <span>SQL Server R Services Book-CI</span> build definition.</li>
<li value="2" class="calibre8">Click on <span>Build Phase</span> and add a new task.</li>
<li value="3" class="calibre8">Search for <kbd class="calibre11">WinRM - SQL Server DB Deployment</kbd>. Then, click on <span>Add</span>.</li>
</ol>
<div class="packt_tip">If it doesn't exist, click on <span class="calibre36">Check out our Marketplace</span>. Search for <kbd class="calibre31">IIS Web App Deployment using WinRM</kbd> and install it against your VSTS account.</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">In <span>Deploy</span> using : DACPAC, type the following details:
<ol class="calibre15">
<li value="1" class="calibre8"><span>Machines</span>: <kbd class="calibre11">$(UATMachine)</kbd></li>
<li value="2" class="calibre8"><span>Admin Login</span>: <kbd class="calibre11">$(UATAdminUser)</kbd></li>
<li value="3" class="calibre8"><span>Password</span>: <kbd class="calibre11">$(UATAdminPwd)</kbd></li>
<li value="4" class="calibre8"><span>DACPAC file</span>: <kbd class="calibre11">$(Build.Repository.LocalPath)\SQL Server R Services Book\Ch08\bin\Debug\Ch08.dacpac</kbd></li>
<li value="5" class="calibre8"><span>Specify SQL Using</span>: <kbd class="calibre11">Publish Profile</kbd></li>
<li value="6" class="calibre8"><span>Publish Profile</span>: <kbd class="calibre11">$(System.DefaultWorkingDirectory)$(UATPublishProfilePath)</kbd></li>
</ol>
</li>
<li value="5" class="calibre8">Add the following new variables:</li>
</ol>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Name</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Value</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Secret</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATMachine</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">{Enter your machine name in FQDN or IP address, for example: <kbd class="calibre11">uatpc.mssqlgirl.com</kbd>}</p>
</td>
<td class="calibre22">
<p class="calibre2">No</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATAdminUser</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">{Enter the admin user that can log in to the UAT Machine}</p>
</td>
<td class="calibre22">
<p class="calibre2">No</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATAdminPwd</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">{Enter the admin password for the admin}</p>
</td>
<td class="calibre22">
<p class="calibre2">Yes</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATPublisProfilePath</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">\SQL Server R Services Book\Ch08\Ch08-UAT.publish.xml</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">No</p>
</td>
</tr>
</tbody>
</table>
<ol start="6" class="calibre14">
<li value="6" class="calibre8">Click on Save and Queue to test the build.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding the test phase to the build definition</h1>
                
            
            <article>
                
<p class="calibre2">In this section, you will learn how to add a test phase to the <span>SQL Server R Services Book-CI</span> build definition. This test phase will perform the unit testing that we have done earlier.</p>
<p class="calibre2">Before we can start unit testing, we need to prepare for the test. This includes populating the <kbd class="calibre11">dbo.nyctaxisample</kbd> table:</p>
<ol class="calibre14">
<li value="1" class="calibre8">To add a new Test Phase, go to <span>Process</span><strong class="calibre1">,</strong> click on <span>...</span><strong class="calibre1">,</strong> and choose <span>Add agent phase</span>.</li>
<li value="2" class="calibre8">In Agent phase, type <kbd class="calibre11">Test Phase</kbd> in <span>Display name</span>.</li>
<li value="3" class="calibre8">On <span>Test Phase</span>, add a new task.</li>
<li value="4" class="calibre8">Search for <kbd class="calibre11">Command Line</kbd>. Then, click on <kbd class="calibre11">Add</kbd>.</li>
<li value="5" class="calibre8">In the Command Line task, type the following details:
<ol class="calibre15">
<li value="1" class="calibre8"><span>Tool</span>: <kbd class="calibre11">bcp</kbd></li>
<li value="2" class="calibre8"><span>Arguments</span>: <kbd class="calibre11">Ch08.dbo.nyctaxi_sample in "$(System.DefaultWorkingDirectory)$(UATSampleFilePath)" -c -t , -r \n -U $(UATDBUser) -P $(UATDBPwd)</kbd></li>
</ol>
</li>
<li value="6" class="calibre8">Click on <span>Save</span>.</li>
</ol>
<p class="calibre2">Now, we can add the step that creates and executes the unit testing:</p>
<ol class="calibre14">
<li value="1" class="calibre8">On <span>Test Phase</span>, add a new task.</li>
<li value="2" class="calibre8">Search for <kbd class="calibre11">Visual Studio Test</kbd>. Then, click on <span>Add</span>.</li>
<li value="3" class="calibre8">In <kbd class="calibre11">Visual Studio Test</kbd>, type the following details:
<ol class="calibre15">
<li value="1" class="calibre8"><span>Display name</span>: <kbd class="calibre11">Unit Test</kbd></li>
<li value="2" class="calibre8"><span>Select tests using</span>: <kbd class="calibre11">Test assemblies</kbd></li>
<li value="3" class="calibre8"><span>Test assemblies</span>: <kbd class="calibre11">**\Ch08_test*.dll</kbd></li>
<li value="4" class="calibre8"><span>Search folder</span>: <kbd class="calibre11">$(System.DefaultWorkingDirectory)</kbd></li>
<li value="5" class="calibre8"><span>Test platform station</span>: <kbd class="calibre11">Visual Studio 2017</kbd></li>
<li value="6" class="calibre8">Test run title: <kbd class="calibre11">Ch08 SQL Server Testing</kbd></li>
</ol>
</li>
<li value="4" class="calibre8">Click on <span>Save &amp;amp; Queue</span>.</li>
</ol>
<p class="calibre2"> </p>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">When you view the build, you should be able to see something like the following:</li>
</ol>
<div class="packt_figure"><img class="aligncenter81" src="../images/00145.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.22 Successful automated testing</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Automating the build for CI</h1>
                
            
            <article>
                
<p class="calibre2">Now that we have defined the SQL Server R Services Book-CI with Build Phase and Test Phase, we are ready to automate it:</p>
<ol class="calibre14">
<li value="1" class="calibre8">In VSTS, edit SQL Server R Services Book-CI.</li>
<li value="2" class="calibre8">Click on the <span>Triggers</span> tab.</li>
<li value="3" class="calibre8">Ensure that <span>Enable continuous integration</span> is checked.</li>
</ol>
<p class="calibre2"> </p>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Optionally, click on <span>+ Add</span> for <span>Scheduled</span>:</li>
</ol>
<div class="packt_figure2"><img class="aligncenter82" src="../images/00146.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.23 Configuring build for CI and specific schedule</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Click on the <span>Options</span> tab.</li>
<li value="6" class="calibre8">In <span>Build Properties</span> | <span>Build number format</span>, type <kbd class="calibre11">Build_$(Date:yyyyMMdd)$(Rev:.r)</kbd>.</li>
<li value="7" class="calibre8">Click on <span>Save</span>.</li>
</ol>
<p class="calibre2">Now, to test if the automation works, let's make a change to the solution, for example:</p>
<ol class="calibre14">
<li value="1" class="calibre8">In Visual Studio, open the <span>SQL Server R Services Book</span> solution.</li>
<li value="2" class="calibre8">Remove the following files from the <span>Ch08</span> project:
<ol class="calibre15">
<li value="1" class="calibre8"><kbd class="calibre11">nyc_taxi_models.sql</kbd></li>
<li value="2" class="calibre8"><kbd class="calibre11">PersistModel.sql</kbd></li>
<li value="3" class="calibre8"><kbd class="calibre11">PredictTipBatchMode.sql</kbd></li>
<li value="4" class="calibre8"><kbd class="calibre11">PredictTipSingleMode.sql</kbd></li>
</ol>
</li>
<li value="3" class="calibre8">Let's check in the pending changes now. Right-click on the <span>Solution</span> node and choose <span>Check In</span>.</li>
<li value="4" class="calibre8">Optionally, add a comment before clicking on the <span>Check In</span> button.</li>
</ol>
<p class="calibre34">After a successful check-in, you should be able to see the <span>Changeset</span> number:</p>
<div class="packt_figure2"><img class="aligncenter83" src="../images/00147.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.24 Checking Changeset information for Visual Studio</div>
<p class="calibre2">In VSTS, you should be able to go to the latest build and see the matching <span>Source version</span>, as shown here:</p>
<div class="packt_figure"><img src="../images/00148.jpeg" class="calibre27"/></div>
<div class="cdpaligncenter">Figure 8.25 Validating automated CI via Changeset information in VSTS</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Setting up continuous delivery</h1>
                
            
            <article>
                
<p class="calibre2">Continuous delivery aims to ensure that we can deploy good builds to the desired environment. This could mean the UAT environment or the Production environment. In this section, we will use VSTS to implement continuous delivery:</p>
<ol start="1" class="calibre14">
<li value="1" class="calibre8">In VSTS, go to the <span>SQL Server R Services Book</span> project.</li>
<li value="2" class="calibre8">Navigate to <span>Build and Release</span> | <span>Release</span> from the top menu.</li>
<li value="3" class="calibre8">Click on <span>+</span> | <span>New Definition</span>.</li>
<li value="4" class="calibre8">Review the <span>Select Template</span> pane. From here, you can choose from many options, including <span>Run Automated Tests from Test Manager</span>. This option is highly recommended for regularly checking the accuracy of your existing model, which will be discussed in the next step of what the manual process entails. For now, let's choose <span>Empty</span> and click on <span>Add</span>.</li>
<li value="5" class="calibre8">On the top title where it says <span>All definitions</span> <strong class="calibre1">|</strong> <span>New Release Definition</span>, click on the pencil icon to edit the name to <kbd class="calibre11">UAT Release</kbd>.</li>
<li value="6" class="calibre8">Let's continue with the <span>Pipeline</span> tab. There are two boxes: Artifacts and <span>Environments</span>.</li>
<li value="7" class="calibre8">In the <span>Artifacts</span> box, click on <span>Add artifact</span>.</li>
<li value="8" class="calibre8">Provide the following details and click on <span>Add</span>:
<ol class="calibre15">
<li value="1" class="calibre8"><strong class="calibre1">Project</strong>: SQL Server R Services Book</li>
<li value="2" class="calibre8"><strong class="calibre1">Source</strong> (build definition): SQL Server R Services Book-CI</li>
</ol>
</li>
<li value="9" class="calibre8">In the <span>Environments</span> box, click on <span>1 phase</span>, <span>0 task</span> in <span>Environment 1</span>.</li>
<li value="10" class="calibre8">In the <span>Tasks</span> tab, click on the first line that says <span>Environment 1</span>. Change the <span>Environment name</span> to <kbd class="calibre11">UAT</kbd>.</li>
<li value="11" class="calibre8">In the <span>Tasks</span> tab, click on the <span>Agent</span> phase and provide the following details:
<ol class="calibre15">
<li value="1" class="calibre8"><span>Display name</span>: <span>Deploy to UAT</span></li>
<li value="2" class="calibre8"><span>Agent queue</span>: <span><span>Default</span></span></li>
</ol>
</li>
</ol>
<ol start="12" class="calibre14">
<li value="12" class="calibre8">Now, add a new task for <span>Deploy to UAT</span>.</li>
<li value="13" class="calibre8">Search for <kbd class="calibre11">WinRM - SQL Server DB Deployment</kbd> and click on <span>Add</span>.</li>
<li value="14" class="calibre8">In <span>Deploy</span> using : Dacpac, fill in the following details:
<ol class="calibre15">
<li value="1" class="calibre8"><span>Machines</span>: <kbd class="calibre11">$(UATMachine)</kbd></li>
<li value="2" class="calibre8"><span>Admin Login</span>: <kbd class="calibre11">$(UATAdminUser)</kbd></li>
<li value="3" class="calibre8"><span>Password</span>: <kbd class="calibre11"><kbd class="calibre84">$(UATAdminPwd)</kbd></kbd></li>
<li value="4" class="calibre8"><span>DACPAC File</span>: <kbd class="calibre11">$(System.ArtifactsDirectory)\$(Build.DefinitionName)\DACPAC\Ch08.dacpac</kbd></li>
<li value="5" class="calibre8"><span>Sever Name</span>: <kbd class="calibre11">{specify the server name, for example: localhost}</kbd></li>
<li value="6" class="calibre8"><span>Database Name</span>: <kbd class="calibre11">NYCTaxiUAT</kbd></li>
</ol>
</li>
<li value="15" class="calibre8">Go to the <span>Variables</span> tab and add the following variables:</li>
</ol>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Name</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Value</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Secret</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATMachine</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">{Enter your machine name in FQDN or IP address, for example: uatpc.mssqlgirl.com}</p>
</td>
<td class="calibre22">
<p class="calibre2">No</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATAdminUser</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">{Enter the admin user that can log in to the UAT Machine}</p>
</td>
<td class="calibre22">
<p class="calibre2">No</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">UATAdminPwd</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">{Enter the admin password for the admin}</p>
</td>
<td class="calibre22">
<p class="calibre2">Yes</p>
</td>
</tr>
</tbody>
</table>
<ol start="16" class="calibre14">
<li value="16" class="calibre8">Then, click on <span>Save</span> and accept the default values.</li>
<li value="17" class="calibre8">To test this release definition, under <span>New Release Definition</span>, click on <span>+ Release</span> and choose <span>Cr</span><span>eate</span> <strong class="calibre1"><span>Release</span></strong>, then choose <span>...</span>.</li>
</ol>
<p class="calibre2"> </p>
<ol start="18" class="calibre14">
<li value="18" class="calibre8">On the <span>Create new release for New Release Definition</span>, type <kbd class="calibre11">Test UAT deployment</kbd> in <span>Release Description</span>. Then, click on <span>Create</span>, as shown here:</li>
</ol>
<div class="packt_figure"><img class="aligncenter84" src="../images/00149.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.26 Creating a new release for the UAT environment based on the latest successful build</div>
<div class="packt_tip">It is possible to deploy to multiple environments with different database connection settings. An extension that will help you achieve this is XDT Transform:<br class="calibre30"/>
<a href="https://marketplace.visualstudio.com/items?itemName=qetza.xdttransform" target="_blank" class="calibre40">https://marketplace.visualstudio.com/items?itemName=qetza.xdttransform</a></div>
<p class="calibre2">Once the release is completed, it will look as follows:</p>
<div class="packt_figure"><img class="aligncenter85" src="../images/00150.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.27 Results of a successful release</div>
<p class="calibre2">To enable Continuous Deliverable on the release, you'll have to edit the definition:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Go to the Releases view, click on <span>...</span> of <span>UAT Release</span>, then choose <span>Edit</span>.</li>
<li value="2" class="calibre8">On the <span>Pipeline</span> view, go to <span>SQL Server R Services Book-CI</span> inside the Artifacts box.</li>
</ol>
<p class="calibre2"> </p>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Click on the <span>Continuous deployment trigger</span>, as shown here:</li>
</ol>
<div class="packt_figure2"><img class="aligncenter86" src="../images/00151.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.28 Changing the Continuous Deployment Trigger</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">In the <span>Continuous deployment trigger</span> window, ensure that the <span>Enabled</span> slider is on.</li>
<li value="5" class="calibre8">Click on <span>Save</span>.</li>
</ol>
<p class="calibre2">To test the UAT Release's Continuous deliverable setup, you can invoke a new build on <span>SQL Server R Services Book-CI</span>. The view should look like this:</p>
<div class="packt_figure"><img class="aligncenter87" src="../images/00152.gif"/></div>
<div class="cdpaligncenter">Figure 8.29 Results of a successful release through Continuous Development</div>
<p class="calibre2">In the summary, the <span>Details</span> should say that the release is <span>Triggered by SQL Server R Services Book-CI Build_20180101.1</span>. Therefore, we successfully created a basic Continuous Delivery process. Advanced steps like setting up integration testing and load testing can now be added to the release using similar steps to the ones shown earlier. For more information about setting this up in VSTS, please refer to the following tutorial from Microsoft: <a href="https://docs.microsoft.com/en-us/vsts/build-release/test/example-continuous-testing#configure-cd" class="calibre10">https://docs.microsoft.com/en-us/vsts/build-release/test/example-continuous-testing#configure-cd</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Monitoring the accuracy of the productionized model</h1>
                
            
            <article>
                
<p class="calibre2">In <a target="_blank" href="part0096.html#2RHM00-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 6</a>, <span><em class="calibre12">Predictive Modeling</em>, </span>we discussed a number of predictive modeling examples. The model(s) created is/are based on trained data. In a real-world scenario, new data keeps coming in, for example, online transactions, taxi cab transactions (remember the earlier NYC taxi example), and air flight delay predictions. Therefore, the data model should be checked regularly to ensure that it is still satisfactory and that there is no other better model that could be generated for it. With the latter, a good data scientist would continuously be asking at least four of these questions:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Is there a different algorithm to consider due to changes of the data?</li>
</ol>
<p class="calibre34">For example, if the current model is using logistic regression (<kbd class="calibre11">rxLogit</kbd>), would the decision tree algorithm more accurate (<kbd class="calibre11">rxDTree</kbd>) either due to the size or due to changes in the expected outcome?</p>
<ol start="2" class="calibre14">
<li value="2" class="calibre8">Are there other features from newer transactions that are becoming more significant?</li>
</ol>
<p class="calibre34">Consider the following scenario: Currently, tipping prediction on taxi rides are using passenger count, trip distance, trip time, and direct distance. Perhaps regularly checking whether other features, such as hour of day, day of week, pick-up zip code and/or drop-off zip code, holiday season, cleanliness of the taxi, or customer rating, would contribute more to the tipping prediction.</p>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Has there been changes in the requirements that can yield to actions to improve the business or customer?</li>
</ol>
<p class="calibre34">In the taxi ride tipping prediction, the current prediction is a binary value, that is, true or false. The business might be interested in understanding more about how cleanliness of the taxi or the customer rating can be correlated to no tips, small tips, medium tips, or large tips. Cleanliness of the taxi cab is an action that the driver can use to drive better improvement.</p>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Is performance slow down caused by the model execution or input data bottleneck?</li>
</ol>
<p class="calibre34">It is possible that as the input dataset/data source grows and is not optimized, the end-to-end predictive modeling would also slow down.</p>
<p class="calibre34">To capture the performance of the model, one should log the performance of the actual prediction or the reasonable representation of actual data. Here is an example of what the log table should look like:</p>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Value</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Data Type</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Comments</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">LogID</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">INT</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">Sequential ID for execution.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">Created On</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">DATETIME</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">Date the model was generated and tested.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">ModelID</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">INT</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">Unique ID for each model.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">Model</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">VARBINARY(MAX)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">This is the serialized representation of the model.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">RxFunction</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">VARCHAR(50)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">This is the rx function used in the model.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">Formula</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">VARCHAR(1000)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The formula for the prediction model.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">Training Input Query</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">VARCHAR(MAX)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The training dataset that is reproducible</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">AUC</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">FLOAT</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The AUC representation of the model. This can be any other metric that you can use to compare quality of the model.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">Training Row Count</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">INT</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The number of row counts.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">CPU Time</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">INT</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The number of seconds to generate the model.</p>
</td>
</tr>
</tbody>
</table>
<p class="calibre2">Once you capture the execution, you can analyze the AUC value and the CPU time, as shown in <em class="calibre12">Figure 8.30</em>:</p>
<div class="packt_figure"><img class="aligncenter88" src="../images/00153.jpeg"/></div>
<div class="cdpaligncenter">Figure 8.30 Monitoring Model comparisons on AUC and CPU Time</div>
<p class="calibre2">These diagrams compare the performance of the following models:</p>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"> </p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Formula B</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Formula C</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">rxDTree</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">Model ID 2</p>
</td>
<td class="calibre22">
<p class="calibre2">Model ID 3</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">rxLogit</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">Model ID 4</p>
</td>
<td class="calibre22">
<p class="calibre2">Model ID 5</p>
</td>
</tr>
</tbody>
</table>
<p class="calibre2"> </p>
<p class="calibre2">The description is as follows:</p>
<ul class="calibre7">
<li class="calibre8">Formula B is <em class="calibre12">tipped ~ passenger_count + trip_distance + trip_time_in_secs + direct_distance + payment_type</em></li>
<li class="calibre8">Formula C is <em class="calibre12">tipped ~ passenger_count + trip_distance + trip_time_in_secs + payment_type</em></li>
</ul>
<p class="calibre2">And each of the models is run against:</p>
<ul class="calibre7">
<li class="calibre8">Last 2 months of data</li>
<li class="calibre8">Random top 5 percent of data</li>
</ul>
<p class="calibre2">Based on the previously mentioned comparisons, we can see that Model ID 4, which is <kbd class="calibre11">rxLogit</kbd> with Formula B, has the highest AUC range and lowest CPU time. So, this model is the best out of the two. Next is to decide if this model should replace the ones in production.</p>
<p class="calibre2">Now that you have learned the technique of comparing models and some of the metrics that are important in prediction modeling, you can schedule this performance testing similar to the one shown earlier. The scheduling can be a SQL Agent job, as shown in <a target="_blank" href="part0102.html#318PC0-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 7</a>, <span><em class="calibre12">Operationalizing R Code</em>,</span> where you can get alerted should new results fall below a certain threshold. Or, you can issue this as part of a separate SQL Server database unit project deployed in VSTS to check against the database with the latest transactions data.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Useful references</h1>
                
            
            <article>
                
<ul class="calibre7">
<li class="calibre8">Integrate SQL Server 2017 into your DevOps pipeline: <a href="https://www.microsoft.com/en-us/sql-server/developer-get-started/sql-devops/" class="calibre10">https://www.microsoft.com/en-us/sql-server/developer-get-started/sql-devops/</a></li>
<li class="calibre8">Visual Studio Team Services (VSTS): <a href="https://www.visualstudio.com/team-services/" class="calibre10">https://www.visualstudio.com/team-services/</a></li>
<li class="calibre8">Compare Visual Studio 2017 IDEs: <a href="https://www.visualstudio.com/vs/compare/" class="calibre10">https://www.visualstudio.com/vs/compare/</a></li>
<li class="calibre8">Configure Hosted Agent in VS 2017: <a href="https://docs.microsoft.com/en-us/vsts/build-release/actions/agents/v2-windows" class="calibre10">https://docs.microsoft.com/en-us/vsts/build-release/actions/agents/v2-windows</a></li>
<li class="calibre8">Continuous Delivery: <a href="https://www.visualstudio.com/learn/what-is-continuous-delivery/" class="calibre10">https://www.visualstudio.com/learn/what-is-continuous-delivery/</a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">Visual Studio 2017 is a powerful IDE for data scientists/developers to manage their code, unit testing, and version control. Combined with Visual Studio Team Services, they form a complete toolkit to execute Database Lifecycle Management, which can also be easily adapted to DevOps practices. This chapter describes in detail how you can integrate SQL Server Machine Learning Services with R in SQL Server Database projects, DevOps practices, and CI/CD workflows. Finally, you have also learned how to monitor a Prediction Model accuracy over time.</p>
<p class="calibre2">In the next chapter, we'll discuss how DBAs can also take advantage of Machine Learning Services with R.</p>


            </article>

            
        </section>
    </body></html>