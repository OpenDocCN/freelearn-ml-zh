<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Implementing Time Series</h1>
                </header>
            
            <article>
                
<p>Time evolving phenomena are fundamental to many disciplines. Understanding what happened and foreseeing how different variables will evolve is key knowledge for making correct, informed decisions.</p>
<p>Time series analysis is a broad field, with many different methods to detect patterns, predict behaviors, and decompose the time evolution into known and previously studied shapes. We are going to discuss some of them, focusing on the ones that are easily solved using Excel. The idea, as usual, is that our machines learn about the details in the data and can extract useful knowledge about the past and the possible future developments.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Modeling and visualizing time series</li>
<li>Forecasting time series automatically in Excel</li>
<li>Studying the stationarity of a time series</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>To complete this chapter, the reader will need to download the <span><kbd>AirPassengers_modified.csv</kbd> </span>file from the GitHub repository at <a href="https://github.com/PacktPublishing/Hands-On-Machine-Learning-with-Microsoft-Excel-2019/tree/master/Chapter07">https://github.com/PacktPublishing/Hands-On-Machine-Learning-with-Microsoft-Excel-2019/tree/master/Chapter07</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Modeling and visualizing time series</h1>
                </header>
            
            <article>
                
<p>We have seen that doing a preliminary data analysis and visualizing the dataset is the first step in any machine learning project. Time series are no exception. So, we will start by exploring time series and learning about its different characteristics. </p>
<p>In the case of a time series, a preliminary analysis implies <em>modeling</em> it; that is, understanding whether it is periodic, whether it shows a given tendency (increasing or decreasing with time), or whether it is stationary (mean and variance of the values don't change over time), among other measures. Visualization plays a fundamental role in this analysis, since many of the time series characteristics can be deduced using a graphical representation of the data points, even if there are numerical methods to calculate them.</p>
<p>Let's use a popular dataset to illustrate the modeling and visualization of a time series. The <kbd>AirPassengers_modified.csv</kbd> file <span>is a simplified version of a very popular dataset, usually shown as an example when teaching time series analysis (source: <em>Box, G. E. P., Jenkins, G. M. and Reinsel, G. C. (1976) Time Series Analysis, Forecasting and Control. Third Edition. Holden-Day. Series G</em>). Our version contains the amount of international passengers (in thousands) that traveled by plane between 1949 and 1961, grouped by month. After loading the file the usual way (<span class="packt_screen">Data</span> | <span class="packt_screen">From Text/CSV</span>), we can visualize the time series in the following diagram, where we can see the number of passengers as a function of time:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/19b36db8-a0d5-494a-a5e8-dcc305bd984f.png" style="width:28.42em;height:17.08em;"/></p>
<p>The first thing that we notice is that the number of passengers increases with time. Then, if we look carefully at the peaks in the series, there is a 12-month pattern that seems to repeat. Let's prove this observation with the data.</p>
<p>The easiest way to get a trend is to use Excel's built-in capability to calculate trends. To use it, follow these steps:</p>
<ol>
<li>Click on the chart area.</li>
<li>Check the box for <span class="packt_screen">Trendline</span>.</li>
<li>Click on <kbd>More Options...</kbd><em>, </em>as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/42bae62a-8491-43bc-bb00-6106d299b054.png" style="width:54.75em;height:24.67em;"/></p>
<p class="mce-root"/>
<p>The first selection will show the line in the chart and then, after selecting <span class="packt_screen">More options...</span>,<em> </em>we can check the box to see the line equation expression on the chart. Notice that <span class="packt_screen">Linear</span> is not the only option for a trend line and that more sophisticated regressions are available, as shown in the following screenshot:</p>
<p> </p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/516e6884-4124-487b-b84e-6f3dbf3a05ca.png" style="width:15.92em;height:31.75em;"/></p>
<p>The resulting equation, as shown on the chart, is as follows:</p>
<p class="CDPAlignCenter CDPAlign"><em>Passengers = 0.0873*TravelDate - 1472</em></p>
<p class="mce-root"/>
<p class="mce-root">Looking at the resulting plot, we see that a straight line does not correctly follow the time evolution of the series. Some parts are mostly above the line and others below, as you can see in the following chart:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a7f7282b-3225-457a-a9ec-0b9b689f1ddb.png" style="width:28.50em;height:17.17em;"/></p>
<p>How can we model the general behavior of the dataset? We can start by realizing that we could think about the series as composed of three parts:</p>
<ul>
<li>A periodic part, which repeats every 12 months (we guess this because of the periodicity of the peaks, and call this 12 month period a <em>season</em>)</li>
<li>An increasing part, which we can obtain by regression or averaging the series</li>
<li>A <em>noise</em> part, which we basically define as the remaining values once we isolate the first two parts</li>
</ul>
<p>This model can then be written as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="fm-editor-equation" src="assets/ef826447-abb0-4fe1-b7c1-928cf3dda60c.png" style="width:56.83em;height:1.75em;"/></p>
<p>Let's improve the calculation of the <em>increasing</em> part by using a moving average. This can be calculated automatically by Excel, but we will do it manually since it is simple and we can understand exactly how it works:</p>
<ol>
<li>Start by calculating the average number of passengers in the first 12 months:</li>
</ol>
<p style="padding-left: 90px" class="CDPAlignLeft CDPAlign"><em>=AVERAGE(B2:B13)</em></p>
<p class="mce-root"/>
<ol start="2">
<li>In the cell to the right, calculate the standard deviation (we will use it in the next section, when we test the stationarity of the series):</li>
</ol>
<p style="padding-left: 90px" class="CDPAlignLeft CDPAlign"><em>=STDEV.S(B2:B13)</em></p>
<ol start="3">
<li>Copy both calculations down to the end of the table.</li>
</ol>
<p style="padding-left: 60px">We then have the mean value and standard deviation of the previous 12 months<span> in each pair of cells</span>. In practice, we are defining a moving 12-month window and sliding it through the data. The resulting table looks similar to the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/22108a4a-5c18-4128-95e9-fb660f5bf21d.png" style="width:16.42em;height:14.75em;"/></p>
<p style="padding-left: 60px">The first 12 places are obviously empty, since we need at least 12 values to start averaging. If we show everything in the same diagram, we will see a graph similar to the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/77ac6e51-775d-46c4-8157-1681769b8294.png" style="width:28.33em;height:16.83em;"/></p>
<p style="padding-left: 60px">The moving average follows the details of the series better, and we are going to use it as a good approximation for <em><span>increasing(TravelDate)</span></em>.<em><span> </span></em><span>Notice that the moving standard deviation also increases with time, we will use this result in the next section.</span></p>
<p style="padding-left: 60px">Going back to our model for the time series, we can write:</p>
<p class="CDPAlignCenter CDPAlign"><img class="fm-editor-equation" src="assets/6cf3a409-3e45-403d-a258-b2294ab742b9.png" style="width:30.25em;height:2.50em;"/></p>
<p style="padding-left: 60px">The ratio is between the column <em>Passengers</em> and the moving average calculated right before. You will be missing the first 12 points, since the average need to start somewhere, but that is fine. For the rest of the rows you can calculate <em>Passengers/Moving Average</em>, which approximates <em>Passengers/increasing(TravelDate)</em>.</p>
<ol start="4">
<li>Add an extra column to calculate this ratio.</li>
<li>Build a new diagram to show the calculation. You will see something like the following graph:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/41c4d0e4-51b0-4cc6-9e1f-58fc1af80414.png" style="width:32.42em;height:19.42em;"/></p>
<p style="padding-left: 60px">We clearly managed to extract the increasing part, but we still have a mixture of oscillations and noise. Let's model <em>periodic(TravelDate) by </em>repeating the first 12 values in sequence.</p>
<p class="mce-root"/>
<ol start="6">
<li>In a new column, copy and paste the first 12 values as many times as you need to fill the same number of cells. These values will give you the following graph:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8bbdbf33-83cd-43bc-992e-7ac2a991185d.png" style="width:29.42em;height:17.67em;"/></p>
<p style="padding-left: 60px">Finally, we will calculate <em>noise(TravelDate)</em>. We will, again, calculate this from our model:</p>
<p class="CDPAlignCenter CDPAlign"><img class="fm-editor-equation" src="assets/72e26bb2-5c75-41c4-b78d-357bcbad2333.png" style="width:30.25em;height:2.42em;"/></p>
<ol start="7">
<li>In another column, use the preceding calculation to create a new diagram:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8d3c1419-fe81-4f79-8ed6-013b3f0359fd.png" style="width:30.42em;height:18.50em;"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>
<p>We now have a full model of the time series and we can use it to predict the future values! Let's do it step by step:</p>
<ol>
<li>Open a new sheet.</li>
<li>Copy the series values and extend the time period up to <kbd>Dec-62</kbd>.</li>
<li>In column <kbd>C</kbd>, copy the <em>periodic(TravelDate)</em> values (24 values in two equal series of 12 values).</li>
<li>In column <kbd>D</kbd>, copy the noise values corresponding to the last two years.</li>
<li>In column <kbd>E</kbd>, cell 146, calculate <em>increasing(TravelDate)</em> using the trendline formula (<em>=0.0873*A146 - 1472</em>).</li>
<li>Copy the formula down to the end of the table. Cell <kbd>B1</kbd> is then as follows:</li>
</ol>
<p style="padding-left: 90px" class="CDPAlignLeft CDPAlign"><em>=C146*D1<span>46</span>*E1<span>46</span></em></p>
<p style="padding-left: 60px">The same calculation is then copied down. The resulting table is as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/01f5b1a4-26c7-4e4b-bbe7-63c7ad0c56bf.png" style="width:20.50em;height:30.25em;"/></p>
<ol start="7">
<li>Insert a new diagram, including the two data series, original and predicted.</li>
</ol>
<ol start="8">
<li>In the following graph, you can see that the prediction is pretty good! (Or, at least it follows the historical data; the only real measure of the prediction quality is to compare it with real data for those dates):</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/bf563981-effb-457c-90f4-9779ab03347d.png" style="width:26.92em;height:17.08em;"/></p>
<p>We have followed the necessary steps to model a time series based on its characteristics and extensively using calculations and visualizations. We will show in the next section that this can also be achieved automatically by using Excel's built-in capabilities.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Forecasting time series automatically in Excel</h1>
                </header>
            
            <article>
                
<p>Now that we have forecast a time series the hard way, understanding every step, we can do it the easy way. We will use Excel's built-in functions to predict the future number of passengers. Perform the following steps:</p>
<ol>
<li>Select both columns, <kbd>TravelDate</kbd> and <kbd>Passengers</kbd>,<em> </em>corresponding to the time and number of passengers.</li>
<li>Navigate to <span class="packt_screen">Data</span><em> </em>in the main menu.</li>
<li>Select <span class="packt_screen">Forecast Sheet</span> (see the following screenshot for reference):</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c11c995a-ec99-4c7c-8d29-805e5afbe65b.png" style="width:15.83em;height:6.42em;"/></p>
<ol start="4">
<li>A window will pop up, showing a preview of the forecast and giving us the chance to change some parameters by clicking in <span class="packt_screen">Options</span>:</li>
</ol>
<ul>
<li style="list-style-type: none">
<ul>
<li><strong>Forecast End</strong>: We can choose the end of the forecast period. By default, Excel forecasts three seasons ahead (more on this to follow). </li>
<li><strong>Forecast Start</strong>: We can do the same with the start of the forecast period. Default is the last point in time of our time series.</li>
<li><strong>Confidence interval</strong>: This<span><em> </em>is defined as the range centered on every predicted value, in which 95% of the predicted points will fall (assuming a normal distribution of the forecast points).<em> </em></span></li>
<li><strong>Seasonality</strong>: A season is the period in which a time series repeats it pattern (if it is periodic, of course). It can be added manually or detected automatically.</li>
</ul>
</li>
</ul>
<p style="padding-left: 60px">The following graph shows the pop-up window containing the available options:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e3706936-75b3-4659-b525-a916133c97ad.png" style="width:32.58em;height:32.58em;"/></p>
<ol start="5">
<li><span class="packt_screen">Timeline Range</span> and <span class="packt_screen">Values Range</span> are the selected columns (in our case <kbd>TravelDate</kbd> and <kbd>Passenger</kbd>).</li>
<li>Clicking on <span class="packt_screen">Create</span><em>, </em>we obtain three new columns: <kbd>Forecast</kbd>, <kbd>Lower Confidence Bounds (Passengers)</kbd>, and <kbd>Upper Confidence Bounds (Passengers)</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/35e7ad5d-8053-4c7d-b050-b2338b1229d6.png" style="width:45.58em;height:23.17em;"/></p>
<p style="padding-left: 60px"><span>We will also see the following diagrams, showing the time series plus the forecasted values:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6d3e7e9a-0e68-4f7e-b558-992eda82f225.png" style="width:39.08em;height:18.50em;"/></p>
<p style="padding-left: 60px">If we select <span class="packt_screen">Include forecast statistics</span> in the pop-up window, we get the following table:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/bb46d482-bf4e-4a89-889a-1e4ec3fe2d4d.png" style="width:6.67em;height:8.08em;"/></p>
<p>This values correspond to Excel's built-in <span><em>FORECAST.ETS.STAT</em> function used internally by the forecast algorithm. The meaning of these values are as follows:</span></p>
<ul>
<li class="mce-root"><strong>Alpha</strong>: This measures the weight given to the data points. A higher value means that we are giving a higher weight to recent data points.</li>
<li class="mce-root"><strong>Beta</strong>: This m<span>easures the weight given to the trend. A</span> higher value means that we are giving a higher weight to the recent trend.</li>
<li class="mce-root"><strong>Gamma</strong>: <span>This measures the weight given to the season. A</span> higher value means that we are giving a higher weight to the recent seasonal period.</li>
<li class="mce-root"><strong>Mean Absolute Scaled Error (MASE)</strong>: This measures the accuracy of the forecasts.</li>
<li class="mce-root"><strong>Symmetric Mean Absolute Percentage Erro</strong><strong>r (SMAPE)</strong>: This measures the accuracy based on percentage errors.</li>
<li class="mce-root"><strong>Mean Absolute Percentage Error</strong> <strong>(AE)</strong><span>: This measures the accuracy based on percentage errors.</span></li>
<li class="mce-root"><strong>Root Mean Squared Error (RMSE)</strong>: This measures the differences between predicted and observed values.</li>
</ul>
<p>We have explained how to use Excel's built-in capabilities to analyze and forecast time series. In the next section, we will focus on the importance of time series stationarity.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Studying the stationarity of a time series</h1>
                </header>
            
            <article>
                
<p>Most methods for a time series forecast rely on the fact that the series is stationary. This makes sense, since this increases the probability of repeating a certain behavior in the future and makes the prediction easier. </p>
<p class="mce-root"/>
<p>How can we know whether a given time series is stationary or not? There are formal, statistical methods to measure this, but we can also look at some properties of the series. There are three main checks of stationarity in practice:</p>
<ul>
<li class="mce-root"><span>The mean value is constant (does not depend on time).</span></li>
<li>The variance is constant.</li>
<li>The covariance of the elements <em>i</em> and <em>i+m</em> is constant.</li>
</ul>
<p>In our previous example, in the <em>Modeling and visualizing time series</em> section, we plotted the moving average (mean) and variance. If you revisit the diagram, you will see that none of them is constant with time, hence the series is non-stationary, and we had to model it to be able to forecast values.</p>
<p>A more formal statistical test is the <em>Dickey-Fuller test</em>, which is out of the scope of this book. This test is not automatically done by Excel, but there are a large number of add-ins that can perform it. Doing it manually makes no sense. </p>
<p>There are two ways of removing seasonality and trend:</p>
<ul>
<li>The technique of decomposing the series into noise, periodic, and increasing terms.</li>
<li>Differencing – that is, creating a new series by taking the difference between the values <em>i</em> and (<em>i+m</em>). The position difference, <em>m</em> is known as <strong>lag</strong>.</li>
</ul>
<p><span>You have now seen different methods for predicting the evolution of a time series, based on a detailed understanding of its characteristics. </span>We will show more advanced forecasting methods, such as ARIMA, when we discuss using Azure machine learning models from Excel in <a href="c4a815b7-95bc-4573-89cf-0399d293e3f6.xhtml">Chapter 10</a>, <em>Azure and Excel – Machine Learning in the Cloud</em>.</p>
<p>Visualization was also a key element throughout the analysis shown in the present chapter. We will see different visualization techniques in the next chapter, focusing in their particular use cases.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>We have seen a step-by-step method to decompose a time series and forecast its future values. This can help us, at least in general terms, to predict the outcome of different processes. Time series can be studied both graphically and numerically, extracting their characteristics and using them to understand how they will behave in the future. We have also seen that this can be done automatically in Excel, with the risk of using it as a black box and not understanding the full forecasting method. More advanced techniques exist, and we will discuss them in future chapters. </p>
<p>The next chapter will show you how to build some basic diagrams in Excel and how to use them to gain insights on your datasets.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>In our forecast, we modeled the increasing part of the time series using the trend function generated by Excel. We could also have used the moving average values. How can that be done? Try it and compare the results.</li>
<li>Change the values of the seasonality and confidence interval and study how the forecast diagram and parameters change.</li>
<li>How can you calculate the covariance between two values in a time series? </li>
<li>A possible way to make the variance independent of time is to take the logarithm of the time series values. Try this in the air passengers series and check the values of the variance.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li><em>Time Series Analysis and Its Applications</em>, by R.H. Shumway and D.S. Stoffer </li>
<li class="mce-root"><em>An Introductory Study on Time Series Modeling and Forecasting</em>, by Ratnadip Adhikari R. K. Agrawal</li>
</ul>


            </article>

            
        </section>
    </body></html>