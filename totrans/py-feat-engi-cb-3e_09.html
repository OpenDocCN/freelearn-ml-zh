<html><head></head><body>
<div id="_idContainer177">
<h1 class="chapter-number" id="_idParaDest-249"><a id="_idTextAnchor1143"/><span class="koboSpan" id="kobo.1.1" xmlns:="http://www.w3.org/1999/xhtml">9</span></h1>
<h1 id="_idParaDest-250"><a id="_idTextAnchor1144"/><a id="_idTextAnchor1145"/><span class="koboSpan" id="kobo.2.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting Features from Relational Data with Featuretools</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns:="http://www.w3.org/1999/xhtml">In previous chapters, we worked with data organized in rows and columns, where the columns are the variables, the rows are the observations, and each observation is independent. </span><span class="koboSpan" id="kobo.3.2" xmlns:="http://www.w3.org/1999/xhtml">In this chapter, we will focus on creating features from relational datasets. </span><span class="koboSpan" id="kobo.3.3" xmlns:="http://www.w3.org/1999/xhtml">In relational datasets, data is structured across various tables, which can be joined together via unique identifiers. </span><span class="koboSpan" id="kobo.3.4" xmlns:="http://www.w3.org/1999/xhtml">These unique identifiers indicate relationships that exist between the </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1" xmlns:="http://www.w3.org/1999/xhtml">different tables.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns:="http://www.w3.org/1999/xhtml">A classic example of relational data is that held by retail companies. </span><span class="koboSpan" id="kobo.5.2" xmlns:="http://www.w3.org/1999/xhtml">One table contains information about customers, such as names and addresses. </span><span class="koboSpan" id="kobo.5.3" xmlns:="http://www.w3.org/1999/xhtml">A second table has information about the purchases made by the customers, such as the type and number of items bought per purchase. </span><span class="koboSpan" id="kobo.5.4" xmlns:="http://www.w3.org/1999/xhtml">A third table contains information about the customers’ interactions with the company’s website, variables such as session duration, the mobile device used, and pages visited. </span><span class="koboSpan" id="kobo.5.5" xmlns:="http://www.w3.org/1999/xhtml">Customers, purchases, and sessions are identified with unique identifiers. </span><span class="koboSpan" id="kobo.5.6" xmlns:="http://www.w3.org/1999/xhtml">These unique identifiers allow us to put these tables together, and in this way, we can get information about customers’ purchases </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1" xmlns:="http://www.w3.org/1999/xhtml">or sessions.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1" xmlns:="http://www.w3.org/1999/xhtml">If we want to know more about the types of customers we have (that is, customer segmentation) or make predictions about whether they would buy a product, we can create features that aggregate or summarize information across different tables at the customer level. </span><span class="koboSpan" id="kobo.7.2" xmlns:="http://www.w3.org/1999/xhtml">For example, we can create features that capture the maximum amount spent by a customer on a purchase, the number of purchases they have made, the time between sessions, or the average session duration. </span><span class="koboSpan" id="kobo.7.3" xmlns:="http://www.w3.org/1999/xhtml">The number of features we can create and the various ways we can aggregate data across tables are abundant. </span><span class="koboSpan" id="kobo.7.4" xmlns:="http://www.w3.org/1999/xhtml">In this chapter, we will discuss some common ways of creating aggregated views of relational data utilizing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.8.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.9.1" xmlns:="http://www.w3.org/1999/xhtml"> Python library. </span><span class="koboSpan" id="kobo.9.2" xmlns:="http://www.w3.org/1999/xhtml">We will begin by setting up various data tables and their relationships and automatically creating features, and next, we will follow up with more detail on the different features we </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1" xmlns:="http://www.w3.org/1999/xhtml">can create.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1" xmlns:="http://www.w3.org/1999/xhtml">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1" xmlns:="http://www.w3.org/1999/xhtml">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.13.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1" xmlns:="http://www.w3.org/1999/xhtml">features automatically</span></span></li>
<li><span class="koboSpan" id="kobo.15.1" xmlns:="http://www.w3.org/1999/xhtml">Creating features with general and </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1" xmlns:="http://www.w3.org/1999/xhtml">cumulative operations</span></span></li>
<li><span class="koboSpan" id="kobo.17.1" xmlns:="http://www.w3.org/1999/xhtml">Combining </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1" xmlns:="http://www.w3.org/1999/xhtml">numerical features</span></span></li>
<li><span class="koboSpan" id="kobo.19.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting features from date </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1" xmlns:="http://www.w3.org/1999/xhtml">and time</span></span></li>
<li><span class="koboSpan" id="kobo.21.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting features </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1" xmlns:="http://www.w3.org/1999/xhtml">from text</span></span></li>
<li><span class="koboSpan" id="kobo.23.1" xmlns:="http://www.w3.org/1999/xhtml">Creating features with </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1" xmlns:="http://www.w3.org/1999/xhtml">aggregation primitives</span></span></li>
</ul>
<h1 id="_idParaDest-251"><a id="_idTextAnchor1146"/><a id="_idTextAnchor1147"/><span class="koboSpan" id="kobo.25.1" xmlns:="http://www.w3.org/1999/xhtml">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.26.1" xmlns:="http://www.w3.org/1999/xhtml">In this chapter, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.27.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.28.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.29.1" xmlns:="http://www.w3.org/1999/xhtml">matplotlib</span></strong><span class="koboSpan" id="kobo.30.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.31.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.32.1" xmlns:="http://www.w3.org/1999/xhtml"> open source Python libraries. </span><span class="koboSpan" id="kobo.32.2" xmlns:="http://www.w3.org/1999/xhtml">You can install </span><strong class="source-inline"><span class="koboSpan" id="kobo.33.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.34.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.35.1" xmlns:="http://www.w3.org/1999/xhtml">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.36.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.37.1" xmlns:="http://www.w3.org/1999/xhtml">
pip install featuretools</span></pre> <p><span class="koboSpan" id="kobo.38.1" xmlns:="http://www.w3.org/1999/xhtml">Additionally, you can do so </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.40.1" xmlns:="http://www.w3.org/1999/xhtml">conda</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.41.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.42.1" xmlns:="http://www.w3.org/1999/xhtml">
conda install -c conda-forge featuretools</span></pre> <p><span class="koboSpan" id="kobo.43.1" xmlns:="http://www.w3.org/1999/xhtml">These commands install the basic </span><strong class="source-inline"><span class="koboSpan" id="kobo.44.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.45.1" xmlns:="http://www.w3.org/1999/xhtml"> functionality, but we can install add-ons for </span><a id="_idIndexMarker657"/><span class="koboSpan" id="kobo.46.1" xmlns:="http://www.w3.org/1999/xhtml">creating features with </span><strong class="bold"><span class="koboSpan" id="kobo.47.1" xmlns:="http://www.w3.org/1999/xhtml">natural language processing</span></strong><span class="koboSpan" id="kobo.48.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span><strong class="bold"><span class="koboSpan" id="kobo.49.1" xmlns:="http://www.w3.org/1999/xhtml">NLP</span></strong><span class="koboSpan" id="kobo.50.1" xmlns:="http://www.w3.org/1999/xhtml">) or for using </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1" xmlns:="http://www.w3.org/1999/xhtml">dask</span></strong><span class="koboSpan" id="kobo.52.1" xmlns:="http://www.w3.org/1999/xhtml"> as the backend instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.54.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.54.2" xmlns:="http://www.w3.org/1999/xhtml">For more information on how to install </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.56.1" xmlns:="http://www.w3.org/1999/xhtml"> add-ons, including </span><strong class="source-inline"><span class="koboSpan" id="kobo.57.1" xmlns:="http://www.w3.org/1999/xhtml">graphviz</span></strong><span class="koboSpan" id="kobo.58.1" xmlns:="http://www.w3.org/1999/xhtml">, check out their documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1" xmlns:="http://www.w3.org/1999/xhtml">here: </span></span><a href="https://docs.featuretools.com/en/v0.16.0/getting_started/install.html"><span class="No-Break"><span class="koboSpan" id="kobo.60.1" xmlns:="http://www.w3.org/1999/xhtml">https://docs.featuretools.com/en/v0.16.0/getting_started/install.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.61.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.62.1" xmlns:="http://www.w3.org/1999/xhtml">We </span><a id="_idIndexMarker658"/><span class="koboSpan" id="kobo.63.1" xmlns:="http://www.w3.org/1999/xhtml">wil</span><a id="_idTextAnchor1148"/><span class="koboSpan" id="kobo.64.1" xmlns:="http://www.w3.org/1999/xhtml">l work with the </span><em class="italic"><span class="koboSpan" id="kobo.65.1" xmlns:="http://www.w3.org/1999/xhtml">Online Retail II</span></em><span class="koboSpan" id="kobo.66.1" xmlns:="http://www.w3.org/1999/xhtml"> dataset from the UCI Machine Learning Repository, which is available at </span><a href="https://archive.ics.uci.edu/ml/datasets/Online+Retail+II"><span class="koboSpan" id="kobo.67.1" xmlns:="http://www.w3.org/1999/xhtml">https://archive.ics.uci.edu/ml/datasets/Online+Retail+II</span></a><span class="koboSpan" id="kobo.68.1" xmlns:="http://www.w3.org/1999/xhtml"> and licensed under a </span><strong class="bold"><span class="koboSpan" id="kobo.69.1" xmlns:="http://www.w3.org/1999/xhtml">Creative Commons Attribution 4.0 International</span></strong><span class="koboSpan" id="kobo.70.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span><strong class="bold"><span class="koboSpan" id="kobo.71.1" xmlns:="http://www.w3.org/1999/xhtml">CC BY 4.0</span></strong><span class="koboSpan" id="kobo.72.1" xmlns:="http://www.w3.org/1999/xhtml">) license: </span><a href="https://creativecommons.org/licenses/by/4.0/legalcode"><span class="koboSpan" id="kobo.73.1" xmlns:="http://www.w3.org/1999/xhtml">https://creativecommons.org/licenses/by/4.0/legalcode</span></a><span class="koboSpan" id="kobo.74.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.74.2" xmlns:="http://www.w3.org/1999/xhtml">The corresponding citation for this data is provided here: </span><em class="italic"><span class="koboSpan" id="kobo.75.1" xmlns:="http://www.w3.org/1999/xhtml">Chen, Daqing</span></em><span class="koboSpan" id="kobo.76.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span><em class="italic"><span class="koboSpan" id="kobo.77.1" xmlns:="http://www.w3.org/1999/xhtml">2019</span></em><span class="koboSpan" id="kobo.78.1" xmlns:="http://www.w3.org/1999/xhtml">). </span><em class="italic"><span class="koboSpan" id="kobo.79.1" xmlns:="http://www.w3.org/1999/xhtml">Online Retail II</span></em><span class="koboSpan" id="kobo.80.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><em class="italic"><span class="koboSpan" id="kobo.81.1" xmlns:="http://www.w3.org/1999/xhtml">UCI Machine Learning </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.82.1" xmlns:="http://www.w3.org/1999/xhtml">Repository</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.83.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span></span><a href="https://doi.org/10.24432/C5CG6D"><span class="No-Break"><span class="koboSpan" id="kobo.84.1" xmlns:="http://www.w3.org/1999/xhtml">https://doi.org/10.24432/C5CG6D</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.85.1" xmlns:="http://www.w3.org/1999/xhtml">)</span><a id="_idTextAnchor1149"/><a id="_idTextAnchor1150"/><span class="koboSpan" id="kobo.86.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.87.1" xmlns:="http://www.w3.org/1999/xhtml">I downloaded and modified the data as shown in this </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1" xmlns:="http://www.w3.org/1999/xhtml">notebook: </span></span><a href="https://github.com/PacktPublishing/Python-Feature-engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/prepare-retail-dataset.ipynb"><span class="No-Break"><span class="koboSpan" id="kobo.89.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/PacktPublishing/Python-Feature-engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/prepare-retail-dataset.ipynb</span></span></a></p>
<p><span class="koboSpan" id="kobo.90.1" xmlns:="http://www.w3.org/1999/xhtml">You’ll find a copy of the modified dataset in the accompanying GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1" xmlns:="http://www.w3.org/1999/xhtml">repository: </span></span><a href="https://github.com/PacktPublishing/Python-Feature-engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/retail.csv"><span class="No-Break"><span class="koboSpan" id="kobo.92.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/PacktPublishing/Python-Feature-engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/retail.csv</span></span></a></p>
<h1 id="_idParaDest-252"><a id="_idTextAnchor1151"/><span class="koboSpan" id="kobo.93.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features automatically</span></h1>
<p><span class="koboSpan" id="kobo.94.1" xmlns:="http://www.w3.org/1999/xhtml">Relationa</span><a id="_idTextAnchor1152"/><span class="koboSpan" id="kobo.95.1" xmlns:="http://www.w3.org/1999/xhtml">l datasets or databases contain data spread across multiple tables</span><a id="_idTextAnchor1153"/><span class="koboSpan" id="kobo.96.1" xmlns:="http://www.w3.org/1999/xhtml">, and the relationships </span><a id="_idIndexMarker659"/><span class="koboSpan" id="kobo.97.1" xmlns:="http://www.w3.org/1999/xhtml">between tables are dictated by a unique identifier </span><a id="_idIndexMarker660"/><span class="koboSpan" id="kobo.98.1" xmlns:="http://www.w3.org/1999/xhtml">that tells us how we can join those tables. </span><span class="koboSpan" id="kobo.98.2" xmlns:="http://www.w3.org/1999/xhtml">To automate feature creation with </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.100.1" xmlns:="http://www.w3.org/1999/xhtml">, we first need to enter the different data tables and establish their relationships within what is called an </span><strong class="bold"><span class="koboSpan" id="kobo.101.1" xmlns:="http://www.w3.org/1999/xhtml">entity set</span></strong><span class="koboSpan" id="kobo.102.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.102.2" xmlns:="http://www.w3.org/1999/xhtml">The entity </span><a id="_idTextAnchor1154"/><span class="koboSpan" id="kobo.103.1" xmlns:="http://www.w3.org/1999/xhtml">set then informs </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.105.1" xmlns:="http://www.w3.org/1999/xhtml"> how these tables are connected so that the library can automatically create features based on </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1" xmlns:="http://www.w3.org/1999/xhtml">those relationships.</span></span></p>
<p><span class="koboSpan" id="kobo.107.1" xmlns:="http://www.w3.org/1999/xhtml">We will w</span><a id="_idTextAnchor1155"/><span class="koboSpan" id="kobo.108.1" xmlns:="http://www.w3.org/1999/xhtml">ork with a dataset containing information about customers, invoices, and products. </span><span class="koboSpan" id="kobo.108.2" xmlns:="http://www.w3.org/1999/xhtml">First, we will set up an entity set highlighting the relationsh</span><a id="_idTextAnchor1156"/><span class="koboSpan" id="kobo.109.1" xmlns:="http://www.w3.org/1999/xhtml">ips between these three items. </span><span class="koboSpan" id="kobo.109.2" xmlns:="http://www.w3.org/1999/xhtml">This entity set will be the starting point for the remaining recipes in this chapter. </span><span class="koboSpan" id="kobo.109.3" xmlns:="http://www.w3.org/1999/xhtml">Next, we will create features automatically by aggregating the data at the customer, invoice, and product levels, utilizing the default parameters </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1" xmlns:="http://www.w3.org/1999/xhtml">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.111.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.112.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.113.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, you will learn how to correctly set up an entity set and extract a bunch of features automatically for each entity. </span><span class="koboSpan" id="kobo.113.2" xmlns:="http://www.w3.org/1999/xhtml">In the upcoming recipes, we will dig deeper into the different types of features that we can create </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.115.1" xmlns:="http://www.w3.org/1999/xhtml">featuretoo</span><a id="_idTextAnchor1157"/><a id="_idTextAnchor1158"/><span class="koboSpan" id="kobo.116.1" xmlns:="http://www.w3.org/1999/xhtml">ls</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.117.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-253"><a id="_idTextAnchor1159"/><span class="koboSpan" id="kobo.118.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.119.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will use the </span><em class="italic"><span class="koboSpan" id="kobo.120.1" xmlns:="http://www.w3.org/1999/xhtml">Online Retail II</span></em><span class="koboSpan" id="kobo.121.1" xmlns:="http://www.w3.org/1999/xhtml"> dataset from the UCI Machine Learning Repository. </span><span class="koboSpan" id="kobo.121.2" xmlns:="http://www.w3.org/1999/xhtml">In this table, there are customers, which are businesses that buy in bulk from the retail company. </span><span class="koboSpan" id="kobo.121.3" xmlns:="http://www.w3.org/1999/xhtml">Customers are identified with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.123.1" xmlns:="http://www.w3.org/1999/xhtml"> unique identifier. </span><span class="koboSpan" id="kobo.123.2" xmlns:="http://www.w3.org/1999/xhtml">Each customer makes one or more purchases, which are flagged by an </span><strong class="source-inline"><span class="koboSpan" id="kobo.124.1" xmlns:="http://www.w3.org/1999/xhtml">invoice</span></strong><span class="koboSpan" id="kobo.125.1" xmlns:="http://www.w3.org/1999/xhtml"> unique identifier, containing the invoice number. </span><span class="koboSpan" id="kobo.125.2" xmlns:="http://www.w3.org/1999/xhtml">In each invoice, there are one or more items that have been bought by the customer. </span><span class="koboSpan" id="kobo.125.3" xmlns:="http://www.w3.org/1999/xhtml">Each item or product sold by the company is also identified with a unique </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1" xmlns:="http://www.w3.org/1999/xhtml">stock code.</span></span></p>
<p><span class="koboSpan" id="kobo.127.1" xmlns:="http://www.w3.org/1999/xhtml">Thus, the data has the </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1" xmlns:="http://www.w3.org/1999/xhtml">following relation</span><a id="_idTextAnchor1160"/><span class="koboSpan" id="kobo.129.1" xmlns:="http://www.w3.org/1999/xhtml">s:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<span class="koboSpan" id="kobo.130.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.1 – Diagram showing the relationships in the data" src="image/B22396_09_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.131.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.1 – Diagram showing the relationships in the data</span></p>
<p><span class="koboSpan" id="kobo.132.1" xmlns:="http://www.w3.org/1999/xhtml">Ea</span><a id="_idTextAnchor1161"/><span class="koboSpan" id="kobo.133.1" xmlns:="http://www.w3.org/1999/xhtml">ch customer made one or more purchases, identified by the invoice number. </span><span class="koboSpan" id="kobo.133.2" xmlns:="http://www.w3.org/1999/xhtml">Each invoice contains one or more items, identifi</span><a id="_idTextAnchor1162"/><span class="koboSpan" id="kobo.134.1" xmlns:="http://www.w3.org/1999/xhtml">ed by the stock code. </span><span class="koboSpan" id="kobo.134.2" xmlns:="http://www.w3.org/1999/xhtml">Each item can be bought by one or more customers and is therefore present in several invoices. </span><span class="koboSpan" id="kobo.134.3" xmlns:="http://www.w3.org/1999/xhtml">With these relationships in mind, let’s proceed to </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1" xmlns:="http://www.w3.org/1999/xhtml">the recip</span><a id="_idTextAnchor1163"/><a id="_idTextAnchor1164"/><span class="koboSpan" id="kobo.136.1" xmlns:="http://www.w3.org/1999/xhtml">e.</span></span></p>
<h2 id="_idParaDest-254"><a id="_idTextAnchor1165"/><span class="koboSpan" id="kobo.137.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.138.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will </span><a id="_idIndexMarker661"/><span class="koboSpan" id="kobo.139.1" xmlns:="http://www.w3.org/1999/xhtml">set up an entity set with the data, and then </span><a id="_idIndexMarker662"/><span class="koboSpan" id="kobo.140.1" xmlns:="http://www.w3.org/1999/xhtml">highlight the different relationships in the dataset. </span><span class="koboSpan" id="kobo.140.2" xmlns:="http://www.w3.org/1999/xhtml">Finally, we will create features by aggregating information in the dataset at the customer, invoice, and </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1" xmlns:="http://www.w3.org/1999/xhtml">product levels:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.142.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s import the </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1" xmlns:="http://www.w3.org/1999/xhtml">required libraries:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.144.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
import featuretools as ft
from woodwork.logical_types import Categorical</span></pre></li> <li><span class="koboSpan" id="kobo.145.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the retail dataset described in the </span><em class="italic"><span class="koboSpan" id="kobo.146.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></em><span class="koboSpan" id="kobo.147.1" xmlns:="http://www.w3.org/1999/xhtml"> section and display its first </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1" xmlns:="http://www.w3.org/1999/xhtml">five rows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.149.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])
df.head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.150.1" xmlns:="http://www.w3.org/1999/xhtml">In the </span><a id="_idIndexMarker663"/><span class="koboSpan" id="kobo.151.1" xmlns:="http://www.w3.org/1999/xhtml">following screenshot, we see the unique identifiers </span><a id="_idIndexMarker664"/><span class="koboSpan" id="kobo.152.1" xmlns:="http://www.w3.org/1999/xhtml">for customers (</span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.154.1" xmlns:="http://www.w3.org/1999/xhtml">) and invoices (</span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1" xmlns:="http://www.w3.org/1999/xhtml">invoice</span></strong><span class="koboSpan" id="kobo.156.1" xmlns:="http://www.w3.org/1999/xhtml">), and additional information about the</span><a id="_idTextAnchor1166"/><span class="koboSpan" id="kobo.157.1" xmlns:="http://www.w3.org/1999/xhtml"> items bought in each invoice, s</span><a id="_idTextAnchor1167"/><span class="koboSpan" id="kobo.158.1" xmlns:="http://www.w3.org/1999/xhtml">uch as the item’s code (</span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1" xmlns:="http://www.w3.org/1999/xhtml">stock_code</span></strong><span class="koboSpan" id="kobo.160.1" xmlns:="http://www.w3.org/1999/xhtml">), description, quantity, and unit price, as well as the date of </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1" xmlns:="http://www.w3.org/1999/xhtml">the inv</span><a id="_idTextAnchor1168"/><span class="koboSpan" id="kobo.162.1" xmlns:="http://www.w3.org/1999/xhtml">oice:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer166">
<span class="koboSpan" id="kobo.163.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.2 – Online Retail II dataset" src="image/B22396_09_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.164.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.2 – Online Retail II dataset</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.165.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.166.1" xmlns:="http://www.w3.org/1999/xhtml">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.168.1" xmlns:="http://www.w3.org/1999/xhtml">’ </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1" xmlns:="http://www.w3.org/1999/xhtml">unique()</span></strong><span class="koboSpan" id="kobo.170.1" xmlns:="http://www.w3.org/1999/xhtml"> function </span><a id="_idIndexMarker665"/><span class="koboSpan" id="kobo.171.1" xmlns:="http://www.w3.org/1999/xhtml">to identify the number of unique items, customers, and invoices – for example, by </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1" xmlns:="http://www.w3.org/1999/xhtml">executing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.173.1" xmlns:="http://www.w3.org/1999/xhtml">df["customer_id"].nunique()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.174.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.175.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s initialize an entity set with an arbitrary name, such </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1" xmlns:="http://www.w3.org/1999/xhtml">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.177.1" xmlns:="http://www.w3.org/1999/xhtml">data</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.178.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.179.1" xmlns:="http://www.w3.org/1999/xhtml">
es = ft.EntitySet(id="data")</span></pre></li> <li><span class="koboSpan" id="kobo.180.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add a DataFrame to the entity set; we give the DataFrame a name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1" xmlns:="http://www.w3.org/1999/xhtml">data</span></strong><span class="koboSpan" id="kobo.182.1" xmlns:="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.182.2" xmlns:="http://www.w3.org/1999/xhtml">We need to add a unique identifier for each row, which we call </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1" xmlns:="http://www.w3.org/1999/xhtml">rows</span></strong><span class="koboSpan" id="kobo.184.1" xmlns:="http://www.w3.org/1999/xhtml">, and since we do not have a unique row identifier in this dataset, we will create it as an additional column by setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1" xmlns:="http://www.w3.org/1999/xhtml">make_index=True</span></strong><span class="koboSpan" id="kobo.186.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.186.2" xmlns:="http://www.w3.org/1999/xhtml">Finally, we indicate that </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1" xmlns:="http://www.w3.org/1999/xhtml">invoice_date</span></strong><span class="koboSpan" id="kobo.188.1" xmlns:="http://www.w3.org/1999/xhtml"> is of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1" xmlns:="http://www.w3.org/1999/xhtml">datetime</span></strong><span class="koboSpan" id="kobo.190.1" xmlns:="http://www.w3.org/1999/xhtml"> type and </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.192.1" xmlns:="http://www.w3.org/1999/xhtml"> should be handled </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1" xmlns:="http://www.w3.org/1999/xhtml">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.194.1" xmlns:="http://www.w3.org/1999/xhtml">Categorical</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.195.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.196.1" xmlns:="http://www.w3.org/1999/xhtml">
es = es.add_dataframe(
    dataframe=df,
    dataframe_name=»data»,
    index="rows",
    make_index=True,
    time_index=»invoice_date»,
    logical_types={ «customer_id»: Categorical},
)</span></pre></li> <li><span class="koboSpan" id="kobo.197.1" xmlns:="http://www.w3.org/1999/xhtml">Ne</span><a id="_idTextAnchor1169"/><span class="koboSpan" id="kobo.198.1" xmlns:="http://www.w3.org/1999/xhtml">xt, we add </span><a id="_idIndexMarker666"/><span class="koboSpan" id="kobo.199.1" xmlns:="http://www.w3.org/1999/xhtml">the relationship between the original </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1" xmlns:="http://www.w3.org/1999/xhtml">data</span></strong><span class="koboSpan" id="kobo.201.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame </span><a id="_idIndexMarker667"/><span class="koboSpan" id="kobo.202.1" xmlns:="http://www.w3.org/1999/xhtml">and </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.204.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.204.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we indicate the original or base DataFram</span><a id="_idTextAnchor1170"/><span class="koboSpan" id="kobo.205.1" xmlns:="http://www.w3.org/1999/xhtml">e, which we called </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1" xmlns:="http://www.w3.org/1999/xhtml">data</span></strong><span class="koboSpan" id="kobo.207.1" xmlns:="http://www.w3.org/1999/xhtml"> in </span><em class="italic"><span class="koboSpan" id="kobo.208.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.209.1" xmlns:="http://www.w3.org/1999/xhtml">, we give the new DataFrame a name, </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.211.1" xmlns:="http://www.w3.org/1999/xhtml">, we add the unique identifier for invoices, and we add the column containing </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.213.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1" xmlns:="http://www.w3.org/1999/xhtml">this DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.215.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»invoices»,
    index="invoice",
    copy_columns=[«customer_id»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.216.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.217.1" xmlns:="http://www.w3.org/1999/xhtml">We copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.219.1" xmlns:="http://www.w3.org/1999/xhtml"> variable to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.221.1" xmlns:="http://www.w3.org/1999/xhtml"> data because we want to create a subsequent relationship between customers </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1" xmlns:="http://www.w3.org/1999/xhtml">and invoices.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.223.1" xmlns:="http://www.w3.org/1999/xhtml">Now, we add a second relationship, which is between customers and invoices. </span><span class="koboSpan" id="kobo.223.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we indicate the base DataFrame, which we named </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.225.1" xmlns:="http://www.w3.org/1999/xhtml"> in </span><em class="italic"><span class="koboSpan" id="kobo.226.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.227.1" xmlns:="http://www.w3.org/1999/xhtml">, then we give the new DataFrame a name, </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.229.1" xmlns:="http://www.w3.org/1999/xhtml">, and add the unique </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1" xmlns:="http://www.w3.org/1999/xhtml">customer identifier:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.231.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»invoices»,
    new_dataframe_name=»customers»,
    index=»customer_id»,
</span><a id="_idTextAnchor1171"/><span class="koboSpan" id="kobo.232.1" xmlns:="http://www.w3.org/1999/xhtml">)</span></pre></li> <li><span class="koboSpan" id="kobo.233.1" xmlns:="http://www.w3.org/1999/xhtml">We can </span><a id="_idIndexMarker668"/><span class="koboSpan" id="kobo.234.1" xmlns:="http://www.w3.org/1999/xhtml">add a third rel</span><a id="_idTextAnchor1172"/><span class="koboSpan" id="kobo.235.1" xmlns:="http://www.w3.org/1999/xhtml">ationship between the original </span><a id="_idIndexMarker669"/><span class="koboSpan" id="kobo.236.1" xmlns:="http://www.w3.org/1999/xhtml">data and </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1" xmlns:="http://www.w3.org/1999/xhtml">the products:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.238.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»items»,
    index=»stock_code»,
)</span></pre></li> <li><span class="koboSpan" id="kobo.239.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the information in the </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.241.1" xmlns:="http://www.w3.org/1999/xhtml">
es</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.242.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see that the entity set contains four DataFrames: the original data, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.244.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.246.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame, and the product or </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1" xmlns:="http://www.w3.org/1999/xhtml">items</span></strong><span class="koboSpan" id="kobo.248.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame. </span><span class="koboSpan" id="kobo.248.2" xmlns:="http://www.w3.org/1999/xhtml">The entity also contains the relationships between invoices or items with the original data, as well as between customers </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1" xmlns:="http://www.w3.org/1999/xhtml">and invoices:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.250.1" xmlns:="http://www.w3.org/1999/xhtml">Entityset: data</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.251.1" xmlns:="http://www.w3.org/1999/xhtml">  DataFrames:</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.252.1" xmlns:="http://www.w3.org/1999/xhtml">    data [Rows: 741301, Columns: 8]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.253.1" xmlns:="http://www.w3.org/1999/xhtml">    invoices [Rows: 40505, Columns: 3]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.254.1" xmlns:="http://www.w3.org/1999/xhtml">    customers [Rows: 5410, Columns: 2]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.255.1" xmlns:="http://www.w3.org/1999/xhtml">    items [Rows: 4631, Columns: 2]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.256.1" xmlns:="http://www.w3.org/1999/xhtml">  Relationships:</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.257.1" xmlns:="http://www.w3.org/1999/xhtml">    data.invoice -&gt; invoices.invoice</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.258.1" xmlns:="http://www.w3.org/1999/xhtml">    invoices.customer_id -&gt; customers.customer_id</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.259.1" xmlns:="http://www.w3.org/1999/xhtml">    data.stock_code -&gt; items.stock_code</span></strong></pre></li> <li><span class="koboSpan" id="kobo.260.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.261.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.262.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.263.1" xmlns:="http://www.w3.org/1999/xhtml">
es["invoices"].hea</span><a id="_idTextAnchor1173"/><span class="koboSpan" id="kobo.264.1" xmlns:="http://www.w3.org/1999/xhtml">d()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.265.1" xmlns:="http://www.w3.org/1999/xhtml">We see in </span><a id="_idIndexMarker670"/><span class="koboSpan" id="kobo.266.1" xmlns:="http://www.w3.org/1999/xhtml">the following output that </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.268.1" xmlns:="http://www.w3.org/1999/xhtml"> au</span><a id="_idTextAnchor1174"/><span class="koboSpan" id="kobo.269.1" xmlns:="http://www.w3.org/1999/xhtml">tomatically created a DataFrame containing the invoice’s unique </span><a id="_idIndexMarker671"/><span class="koboSpan" id="kobo.270.1" xmlns:="http://www.w3.org/1999/xhtml">identifier, followed by the customer’s unique identifier and the first date registered for </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1" xmlns:="http://www.w3.org/1999/xhtml">ea</span><a id="_idTextAnchor1175"/><span class="koboSpan" id="kobo.272.1" xmlns:="http://www.w3.org/1999/xhtml">ch invoice:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer167">
<span class="koboSpan" id="kobo.273.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.3 – DataFrame with information at the invoice level" src="image/B22396_09_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.274.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.3 – DataFrame with information at the invoice level</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.275.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now display the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.276.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.277.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.278.1" xmlns:="http://www.w3.org/1999/xhtml">
es["customers"].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.279.1" xmlns:="http://www.w3.org/1999/xhtml">We can see in the following output that </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.281.1" xmlns:="http://www.w3.org/1999/xhtml"> automatically created a DataFrame containing the customer’s unique identifier, followed by the date of the first invoice for </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1" xmlns:="http://www.w3.org/1999/xhtml">this</span><a id="_idTextAnchor1176"/><span class="koboSpan" id="kobo.283.1" xmlns:="http://www.w3.org/1999/xhtml"> customer:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer168">
<span class="koboSpan" id="kobo.284.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.4 – DataFrame with information at the customer level" src="image/B22396_09_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.285.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.4 – DataFrame with information at the customer level</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.286.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.287.1" xmlns:="http://www.w3.org/1999/xhtml">Go ahead and display the DataFrame containing the products by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1" xmlns:="http://www.w3.org/1999/xhtml">es["items"].head()</span></strong><span class="koboSpan" id="kobo.289.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.289.2" xmlns:="http://www.w3.org/1999/xhtml">You can also evaluate the size of the different DataFrames using </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.291.1" xmlns:="http://www.w3.org/1999/xhtml">’ </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1" xmlns:="http://www.w3.org/1999/xhtml">shape</span></strong><span class="koboSpan" id="kobo.293.1" xmlns:="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.293.2" xmlns:="http://www.w3.org/1999/xhtml">You will notice that the number of rows in each DataFrame coincides with the number of unique invoices, customers, </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1" xmlns:="http://www.w3.org/1999/xhtml">and produc</span><a id="_idTextAnchor1177"/><span class="koboSpan" id="kobo.295.1" xmlns:="http://www.w3.org/1999/xhtml">ts.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.296.1" xmlns:="http://www.w3.org/1999/xhtml">We can </span><a id="_idIndexMarker672"/><span class="koboSpan" id="kobo.297.1" xmlns:="http://www.w3.org/1999/xhtml">also display the re</span><a id="_idTextAnchor1178"/><span class="koboSpan" id="kobo.298.1" xmlns:="http://www.w3.org/1999/xhtml">lationships between these data </span><a id="_idIndexMarker673"/><span class="koboSpan" id="kobo.299.1" xmlns:="http://www.w3.org/1999/xhtml">tables </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1" xmlns:="http://www.w3.org/1999/xhtml">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.301.1" xmlns:="http://www.w3.org/1999/xhtml">
es.plot()</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.302.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><a id="_idTextAnchor1179"/><span class="koboSpan" id="kobo.303.1" xmlns:="http://www.w3.org/1999/xhtml">To visualize the data relationships, you need to have </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1" xmlns:="http://www.w3.org/1999/xhtml">graphviz</span></strong><span class="koboSpan" id="kobo.305.1" xmlns:="http://www.w3.org/1999/xhtml"> installed. </span><span class="koboSpan" id="kobo.305.2" xmlns:="http://www.w3.org/1999/xhtml">If you don’t, follow the </span><a id="_idIndexMarker674"/><span class="koboSpan" id="kobo.306.1" xmlns:="http://www.w3.org/1999/xhtml">instructions in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.308.1" xmlns:="http://www.w3.org/1999/xhtml"> documentation to install </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1" xmlns:="http://www.w3.org/1999/xhtml">it: </span></span><a href="https://featuretools.alteryx.com/en/stable/install.html#installing-graphviz"><span class="No-Break"><span class="koboSpan" id="kobo.310.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/install.html#installing-graphviz</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.311.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.312.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the relational datasets and </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1" xmlns:="http://www.w3.org/1999/xhtml">their re</span><a id="_idTextAnchor1180"/><span class="koboSpan" id="kobo.314.1" xmlns:="http://www.w3.org/1999/xhtml">lationships:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<span class="koboSpan" id="kobo.315.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.5 – Relationships between the tables containing invoices, customers, and products" src="image/B22396_09_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.316.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.5 – Relationships between the tables containing invoices, customers, and products</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.317.1" xmlns:="http://www.w3.org/1999/xhtml">Af</span><a id="_idTextAnchor1181"/><span class="koboSpan" id="kobo.318.1" xmlns:="http://www.w3.org/1999/xhtml">ter entering </span><a id="_idIndexMarker675"/><span class="koboSpan" id="kobo.319.1" xmlns:="http://www.w3.org/1999/xhtml">the data and their relationships,</span><a id="_idTextAnchor1182"/><span class="koboSpan" id="kobo.320.1" xmlns:="http://www.w3.org/1999/xhtml"> we can start </span><a id="_idIndexMarker676"/><span class="koboSpan" id="kobo.321.1" xmlns:="http://www.w3.org/1999/xhtml">automatically creating features for each one of our new DataFrames – that is, customers, invoices, and products – using the default parameters </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1" xmlns:="http://www.w3.org/1999/xhtml">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.323.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span><a id="_idTextAnchor1183"/></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.324.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.325.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create </span><a id="_idIndexMarker677"/><span class="koboSpan" id="kobo.326.1" xmlns:="http://www.w3.org/1999/xhtml">features by aggregating the data at the customer level. </span><span class="koboSpan" id="kobo.326.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we set up the </span><strong class="bold"><span class="koboSpan" id="kobo.327.1" xmlns:="http://www.w3.org/1999/xhtml">deep feature synthesis</span></strong><span class="koboSpan" id="kobo.328.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span><strong class="bold"><span class="koboSpan" id="kobo.329.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.330.1" xmlns:="http://www.w3.org/1999/xhtml">) class from </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.332.1" xmlns:="http://www.w3.org/1999/xhtml">, indicating </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.334.1" xmlns:="http://www.w3.org/1999/xhtml"> as the target DataFrame. </span><span class="koboSpan" id="kobo.334.2" xmlns:="http://www.w3.org/1999/xhtml">When creating features, we want to ignore the two columns with </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1" xmlns:="http://www.w3.org/1999/xhtml">unique identifiers:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.336.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»customers»,
    ignore_columns={
        «invoices»:[«invoice»],
        «invoices»:[«customer_id»],
    }
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.337.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.338.1" xmlns:="http://www.w3.org/1999/xhtml">The command from </span><em class="italic"><span class="koboSpan" id="kobo.339.1" xmlns:="http://www.w3.org/1999/xhtml">step 12</span></em><span class="koboSpan" id="kobo.340.1" xmlns:="http://www.w3.org/1999/xhtml"> triggered the creation of 114 features with different aggregations of data at the customer level. </span><span class="koboSpan" id="kobo.340.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix</span></strong><span class="koboSpan" id="kobo.342.1" xmlns:="http://www.w3.org/1999/xhtml"> variable is a DataFrame with the feature values, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1" xmlns:="http://www.w3.org/1999/xhtml">feature_defs</span></strong><span class="koboSpan" id="kobo.344.1" xmlns:="http://www.w3.org/1999/xhtml"> is a list with the names of the new features. </span><span class="koboSpan" id="kobo.344.2" xmlns:="http://www.w3.org/1999/xhtml">Go ahead and execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1" xmlns:="http://www.w3.org/1999/xhtml">feature_defs</span></strong><span class="koboSpan" id="kobo.346.1" xmlns:="http://www.w3.org/1999/xhtml"> or visit our accompanying GitHub repository (</span><a href="https://github.com/PacktPublishing/Python-Feature-Engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/Recipe1-Setting-up-an-entitity-set.ipynb"><span class="koboSpan" id="kobo.347.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/PacktPublishing/Python-Feature-Engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/Recipe1-Setting-up-an-entitity-set.ipynb</span></a><span class="koboSpan" id="kobo.348.1" xmlns:="http://www.w3.org/1999/xhtml">) to check the names of the created features. </span><span class="koboSpan" id="kobo.348.2" xmlns:="http://www.w3.org/1999/xhtml">You will find more details about these features in the </span><em class="italic"><span class="koboSpan" id="kobo.349.1" xmlns:="http://www.w3.org/1999/xhtml">How it </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.350.1" xmlns:="http://www.w3.org/1999/xhtml">works…</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.351.1" xmlns:="http://www.w3.org/1999/xhtml"> section.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.352.1" xmlns:="http://www.w3.org/1999/xhtml">For reasons </span><a id="_idIndexMarker678"/><span class="koboSpan" id="kobo.353.1" xmlns:="http://www.w3.org/1999/xhtml">of space, we can’t print out all the features </span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.354.1" xmlns:="http://www.w3.org/1999/xhtml">in the </span><a id="_idTextAnchor1184"/><span class="koboSpan" id="kobo.355.1" xmlns:="http://www.w3.org/1999/xhtml">book, so instead, let’s display the nam</span><a id="_idTextAnchor1185"/><span class="koboSpan" id="kobo.356.1" xmlns:="http://www.w3.org/1999/xhtml">es of five of the </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1" xmlns:="http://www.w3.org/1999/xhtml">created features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.358.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_defs[5:10]</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.359.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see 5 of the 114 features created </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1" xmlns:="http://www.w3.org/1999/xhtml">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.361.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.362.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.363.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: MIN(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.364.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.365.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MODE(data.description)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.366.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MODE(data.stock_code)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.367.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: NUM_UNIQUE(data.description)&gt;]</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.368.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.369.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.371.1" xmlns:="http://www.w3.org/1999/xhtml"> library names the new features with the function used to create them, followed by the DataFrame that was used to perform the aggregation, followed by the aggregated variable name. </span><span class="koboSpan" id="kobo.371.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1" xmlns:="http://www.w3.org/1999/xhtml">MIN(data.quantity)</span></strong><span class="koboSpan" id="kobo.373.1" xmlns:="http://www.w3.org/1999/xhtml"> is equivalent to </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1" xmlns:="http://www.w3.org/1999/xhtml">df.groupby(["customer_id"])["quantity"].min()</span></strong><span class="koboSpan" id="kobo.375.1" xmlns:="http://www.w3.org/1999/xhtml">, if you are familiar with </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.377.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.377.2" xmlns:="http://www.w3.org/1999/xhtml">We will give more details in the </span><em class="italic"><span class="koboSpan" id="kobo.378.1" xmlns:="http://www.w3.org/1999/xhtml">How it </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.379.1" xmlns:="http://www.w3.org/1999/xhtml">works…</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.380.1" xmlns:="http://www.w3.org/1999/xhtml"> secti</span><a id="_idTextAnchor1186"/><span class="koboSpan" id="kobo.381.1" xmlns:="http://www.w3.org/1999/xhtml">on.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.382.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the first five rows of the Dat</span><a id="_idTextAnchor1187"/><span class="koboSpan" id="kobo.383.1" xmlns:="http://www.w3.org/1999/xhtml">aFrame containing five of the </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1" xmlns:="http://www.w3.org/1999/xhtml">created features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.385.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix[feature_matrix.columns[5:10]].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.386.1" xmlns:="http://www.w3.org/1999/xhtml">In the </span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.387.1" xmlns:="http://www.w3.org/1999/xhtml">following output, we can see the first five rows </span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.388.1" xmlns:="http://www.w3.org/1999/xhtml">containing the values of the </span><a id="_idTextAnchor1188"/><span class="koboSpan" id="kobo.389.1" xmlns:="http://www.w3.org/1999/xhtml">five </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer170">
<span class="koboSpan" id="kobo.391.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.6 – DataFrame with five features created by aggregating the data at the customer level" src="image/B22396_09_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.392.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.6 – DataFrame with five features created by aggregating the data at the customer level</span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.393.1" xmlns:="http://www.w3.org/1999/xhtml">Similarly, we can create features automatically by aggregating information at the </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1" xmlns:="http://www.w3.org/1999/xhtml">invoice level:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.395.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»invoices»,
    ignore_columns = {«data»: [«customer_id»]},
    max_depth =</span><a id="_idTextAnchor1189"/><span class="koboSpan" id="kobo.396.1" xmlns:="http://www.w3.org/1999/xhtml"> 1,
)</span></pre></li> <li><span class="koboSpan" id="kobo.397.1" xmlns:="http://www.w3.org/1999/xhtml">The previous step returns 24 features – let’s display </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1" xmlns:="http://www.w3.org/1999/xhtml">their names:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.399.1" xmlns:="http://www.w3.org/1999/xhtml">
f</span><a id="_idTextAnchor1190"/><span class="koboSpan" id="kobo.400.1" xmlns:="http://www.w3.org/1999/xhtml">eature_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.401.1" xmlns:="http://www.w3.org/1999/xhtml">We can see the names of the features in the </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1" xmlns:="http://www.w3.org/1999/xhtml">following output:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.403.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: customer_id&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.404.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: COUNT(data)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.405.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.406.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.407.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.408.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.409.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.410.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.411.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MODE(data.description)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.412.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MODE(data.stock_code)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.413.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: NUM_UNIQUE(data.description)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.414.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: NUM_UNIQUE(data.stock_code)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.415.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SKEW(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.416.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SKEW(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.417.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: STD(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.418.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: STD(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.419.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.420.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.421.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: DAY(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.422.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MONTH(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.423.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: WEEKDAY(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.424.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: YEAR(first_data_time)&gt;]</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.425.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.426.1" xmlns:="http://www.w3.org/1999/xhtml">Go ahead and display the DataFrame containing the new features by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix.head()</span></strong><span class="koboSpan" id="kobo.428.1" xmlns:="http://www.w3.org/1999/xhtml"> or check our accompanying GitHub repository for </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1" xmlns:="http://www.w3.org/1999/xhtml">the result.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1" xmlns:="http://www.w3.org/1999/xhtml">To</span><a id="_idTextAnchor1191"/><span class="koboSpan" id="kobo.431.1" xmlns:="http://www.w3.org/1999/xhtml"> wrap up, by using the code from </span><em class="italic"><span class="koboSpan" id="kobo.432.1" xmlns:="http://www.w3.org/1999/xhtml">step 1</span><a id="_idTextAnchor1192"/><span class="koboSpan" id="kobo.433.1" xmlns:="http://www.w3.org/1999/xhtml">6</span></em><span class="koboSpan" id="kobo.434.1" xmlns:="http://www.w3.org/1999/xhtml"> and changing the target DataFrame name from </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.436.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1" xmlns:="http://www.w3.org/1999/xhtml">items</span></strong><span class="koboSpan" id="kobo.438.1" xmlns:="http://www.w3.org/1999/xhtml">, go ahead and create features automatically at </span><a id="_idTextAnchor1193"/><a id="_idTextAnchor1194"/><span class="koboSpan" id="kobo.439.1" xmlns:="http://www.w3.org/1999/xhtml">the </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1" xmlns:="http://www.w3.org/1999/xhtml">product level.</span></span></p>
<h2 id="_idParaDest-255"><a id="_idTextAnchor1195"/><span class="koboSpan" id="kobo.441.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.442.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we set up an entity set containing the data and the relationships between some of </span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.443.1" xmlns:="http://www.w3.org/1999/xhtml">its variables (unique identifiers). </span><span class="koboSpan" id="kobo.443.2" xmlns:="http://www.w3.org/1999/xhtml">After that, we automatically </span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.444.1" xmlns:="http://www.w3.org/1999/xhtml">created features by aggregating the information in the dataset for each of the unique identifiers. </span><span class="koboSpan" id="kobo.444.2" xmlns:="http://www.w3.org/1999/xhtml">We used two main classes from </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.446.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.448.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.449.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.450.1" xmlns:="http://www.w3.org/1999/xhtml">, to create the features. </span><span class="koboSpan" id="kobo.450.2" xmlns:="http://www.w3.org/1999/xhtml">Let’s discuss each of these in </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1" xmlns:="http://www.w3.org/1999/xhtml">more detail.</span></span></p>
<p><span class="koboSpan" id="kobo.452.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.454.1" xmlns:="http://www.w3.org/1999/xhtml"> class stores </span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.455.1" xmlns:="http://www.w3.org/1999/xhtml">the data, the logical types of the variables, and the relationships between the variables. </span><span class="koboSpan" id="kobo.455.2" xmlns:="http://www.w3.org/1999/xhtml">The variable types (whether numeric or categorical) are automatically assigned by </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.457.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.457.2" xmlns:="http://www.w3.org/1999/xhtml">We can also set up specific variable types when adding a DataFrame to the entity set. </span><span class="koboSpan" id="kobo.457.3" xmlns:="http://www.w3.org/1999/xhtml">In </span><em class="italic"><span class="koboSpan" id="kobo.458.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.459.1" xmlns:="http://www.w3.org/1999/xhtml">, we added the data to the entity set and set the logical type of </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.461.1" xmlns:="http://www.w3.org/1999/xhtml">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.462.1" xmlns:="http://www.w3.org/1999/xhtml">Categorical</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.463.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.464.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.465.1" xmlns:="http://www.w3.org/1999/xhtml">To inspect the datatypes inferred by </span><strong class="source-inline"><span class="koboSpan" id="kobo.466.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.467.1" xmlns:="http://www.w3.org/1999/xhtml">, you can execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.468.1" xmlns:="http://www.w3.org/1999/xhtml">es["data"].ww</span></strong><span class="koboSpan" id="kobo.469.1" xmlns:="http://www.w3.org/1999/xhtml">, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1" xmlns:="http://www.w3.org/1999/xhtml">es</span></strong><span class="koboSpan" id="kobo.471.1" xmlns:="http://www.w3.org/1999/xhtml"> is the entity set and </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1" xmlns:="http://www.w3.org/1999/xhtml">data</span></strong><span class="koboSpan" id="kobo.473.1" xmlns:="http://www.w3.org/1999/xhtml"> is the name of </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1" xmlns:="http://www.w3.org/1999/xhtml">the DataFrame.</span></span></p>
<p><span class="koboSpan" id="kobo.475.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.477.1" xmlns:="http://www.w3.org/1999/xhtml"> class has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.478.1" xmlns:="http://www.w3.org/1999/xhtml">add_dataframe</span></strong><span class="koboSpan" id="kobo.479.1" xmlns:="http://www.w3.org/1999/xhtml"> method, which we used in </span><em class="italic"><span class="koboSpan" id="kobo.480.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.481.1" xmlns:="http://www.w3.org/1999/xhtml"> to add a new DataFrame. </span><span class="koboSpan" id="kobo.481.2" xmlns:="http://www.w3.org/1999/xhtml">When using this method, we need to specify the unique identifier, and if there is none, then we need to create one, as we did in </span><em class="italic"><span class="koboSpan" id="kobo.482.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.483.1" xmlns:="http://www.w3.org/1999/xhtml">, by setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1" xmlns:="http://www.w3.org/1999/xhtml">make_index</span></strong><span class="koboSpan" id="kobo.485.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1" xmlns:="http://www.w3.org/1999/xhtml">True</span></strong><span class="koboSpan" id="kobo.487.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.487.2" xmlns:="http://www.w3.org/1999/xhtml">Note that in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1" xmlns:="http://www.w3.org/1999/xhtml">index</span></strong><span class="koboSpan" id="kobo.489.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter from </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1" xmlns:="http://www.w3.org/1999/xhtml">add_dataframe</span></strong><span class="koboSpan" id="kobo.491.1" xmlns:="http://www.w3.org/1999/xhtml">, we passed the </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1" xmlns:="http://www.w3.org/1999/xhtml">"rows"</span></strong><span class="koboSpan" id="kobo.493.1" xmlns:="http://www.w3.org/1999/xhtml"> string. </span><span class="koboSpan" id="kobo.493.2" xmlns:="http://www.w3.org/1999/xhtml">With this configuration, </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.495.1" xmlns:="http://www.w3.org/1999/xhtml"> added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1" xmlns:="http://www.w3.org/1999/xhtml">rows</span></strong><span class="koboSpan" id="kobo.497.1" xmlns:="http://www.w3.org/1999/xhtml"> column containing the unique identifier for each row to the DataFrame, which is a new sequence of integers starting </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1" xmlns:="http://www.w3.org/1999/xhtml">at 0.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.499.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.500.1" xmlns:="http://www.w3.org/1999/xhtml">Instead of using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1" xmlns:="http://www.w3.org/1999/xhtml">add_dataframe</span></strong><span class="koboSpan" id="kobo.502.1" xmlns:="http://www.w3.org/1999/xhtml"> method to add a DataFrame to an entity set, we can add it by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1" xmlns:="http://www.w3.org/1999/xhtml">es["df_name"]=df</span></strong><span class="koboSpan" id="kobo.504.1" xmlns:="http://www.w3.org/1999/xhtml">, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1" xmlns:="http://www.w3.org/1999/xhtml">"df_name"</span></strong><span class="koboSpan" id="kobo.506.1" xmlns:="http://www.w3.org/1999/xhtml"> is the name we want to give to the DataFrame and </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1" xmlns:="http://www.w3.org/1999/xhtml">df</span></strong><span class="koboSpan" id="kobo.508.1" xmlns:="http://www.w3.org/1999/xhtml"> is the DataFrame we want </span><span class="No-Break"><span class="koboSpan" id="kobo.509.1" xmlns:="http://www.w3.org/1999/xhtml">to add.</span></span></p>
<p><span class="koboSpan" id="kobo.510.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.512.1" xmlns:="http://www.w3.org/1999/xhtml"> class has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1" xmlns:="http://www.w3.org/1999/xhtml">normalize_dataframe</span></strong><span class="koboSpan" id="kobo.514.1" xmlns:="http://www.w3.org/1999/xhtml"> method, which is used to create a new DataFrame and relationship from the unique values of an existing column.</span><a id="_idTextAnchor1196"/><span class="koboSpan" id="kobo.515.1" xmlns:="http://www.w3.org/1999/xhtml"> The method takes the name of the DataFrame to which the new DataFrame will be related and </span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.516.1" xmlns:="http://www.w3.org/1999/xhtml">a name for the new DataFrame. </span><span class="koboSpan" id="kobo.516.2" xmlns:="http://www.w3.org/1999/xhtml">We</span><a id="_idTextAnchor1197"/><span class="koboSpan" id="kobo.517.1" xmlns:="http://www.w3.org/1999/xhtml"> also need to indicate the </span><a id="_idIndexMarker686"/><span class="koboSpan" id="kobo.518.1" xmlns:="http://www.w3.org/1999/xhtml">unique identifier for the new DataFrame in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1" xmlns:="http://www.w3.org/1999/xhtml">index</span></strong><span class="koboSpan" id="kobo.520.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter. </span><span class="koboSpan" id="kobo.520.2" xmlns:="http://www.w3.org/1999/xhtml">By default, this method creates a new DataFrame containing the unique identifier, followed by a </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1" xmlns:="http://www.w3.org/1999/xhtml">datetime</span></strong><span class="koboSpan" id="kobo.522.1" xmlns:="http://www.w3.org/1999/xhtml"> column containing the first date each unique identifier was registered. </span><span class="koboSpan" id="kobo.522.2" xmlns:="http://www.w3.org/1999/xhtml">We can add more columns to this DataFrame by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1" xmlns:="http://www.w3.org/1999/xhtml">copy_columns</span></strong><span class="koboSpan" id="kobo.524.1" xmlns:="http://www.w3.org/1999/xhtml"> parameters, as we did in </span><em class="italic"><span class="koboSpan" id="kobo.525.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.526.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.526.2" xmlns:="http://www.w3.org/1999/xhtml">Adding more columns to the new DataFrame is useful if we want to follow up with relationships to this new DataFrame, as we did in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.527.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.528.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.529.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.531.1" xmlns:="http://www.w3.org/1999/xhtml"> class also has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1" xmlns:="http://www.w3.org/1999/xhtml">plot()</span></strong><span class="koboSpan" id="kobo.533.1" xmlns:="http://www.w3.org/1999/xhtml"> method, which displays existing relationships in the entity set. </span><span class="koboSpan" id="kobo.533.2" xmlns:="http://www.w3.org/1999/xhtml">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.534.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.535.1" xmlns:="http://www.w3.org/1999/xhtml">.5</span></em><span class="koboSpan" id="kobo.536.1" xmlns:="http://www.w3.org/1999/xhtml">, we saw the relationships between our data tables; the </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.538.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1" xmlns:="http://www.w3.org/1999/xhtml">items</span></strong><span class="koboSpan" id="kobo.540.1" xmlns:="http://www.w3.org/1999/xhtml"> (products) tables were related to the original data, whereas the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.542.1" xmlns:="http://www.w3.org/1999/xhtml"> table was related to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.544.1" xmlns:="http://www.w3.org/1999/xhtml"> table, which was, in turn, related to the </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1" xmlns:="http://www.w3.org/1999/xhtml">original data.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.546.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.547.1" xmlns:="http://www.w3.org/1999/xhtml">The relationship between the tables dictates how features will be created. </span><span class="koboSpan" id="kobo.547.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.549.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1" xmlns:="http://www.w3.org/1999/xhtml">items</span></strong><span class="koboSpan" id="kobo.551.1" xmlns:="http://www.w3.org/1999/xhtml"> tables are related to the original data. </span><span class="koboSpan" id="kobo.551.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, we can only create features with depth 1. </span><span class="koboSpan" id="kobo.551.3" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.553.1" xmlns:="http://www.w3.org/1999/xhtml"> table is, on the other hand, related to invoices, which is related to data. </span><span class="koboSpan" id="kobo.553.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, we can create features with depth 2. </span><span class="koboSpan" id="kobo.553.3" xmlns:="http://www.w3.org/1999/xhtml">That means that new features will consist of aggregations from the entire dataset or aggregations for invoices first, which will then be subsequently aggregated for customers. </span><span class="koboSpan" id="kobo.553.4" xmlns:="http://www.w3.org/1999/xhtml">We can regulate the features to create with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1" xmlns:="http://www.w3.org/1999/xhtml">max_depth</span></strong><span class="koboSpan" id="kobo.555.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1" xmlns:="http://www.w3.org/1999/xhtml">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.557.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.558.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.559.1" xmlns:="http://www.w3.org/1999/xhtml">After setting up the data and the relationships, we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.561.1" xmlns:="http://www.w3.org/1999/xhtml"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.563.1" xmlns:="http://www.w3.org/1999/xhtml"> to automatically create features. </span><span class="koboSpan" id="kobo.563.2" xmlns:="http://www.w3.org/1999/xhtml">When creating features with </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.565.1" xmlns:="http://www.w3.org/1999/xhtml">, we need to set the target DataFrame – that is, the data table for which the features should be created. </span><span class="koboSpan" id="kobo.565.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.566.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.567.1" xmlns:="http://www.w3.org/1999/xhtml"> class creates features by </span><em class="italic"><span class="koboSpan" id="kobo.568.1" xmlns:="http://www.w3.org/1999/xhtml">transforming</span></em><span class="koboSpan" id="kobo.569.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.570.1" xmlns:="http://www.w3.org/1999/xhtml">aggregating</span></em><span class="koboSpan" id="kobo.571.1" xmlns:="http://www.w3.org/1999/xhtml"> existing variables, through what are called </span><strong class="bold"><span class="koboSpan" id="kobo.572.1" xmlns:="http://www.w3.org/1999/xhtml">transform</span></strong><span class="koboSpan" id="kobo.573.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.574.1" xmlns:="http://www.w3.org/1999/xhtml">aggregate </span><a id="_idTextAnchor1198"/><span class="koboSpan" id="kobo.575.1" xmlns:="http://www.w3.org/1999/xhtml">primitives</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.576.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.577.1" xmlns:="http://www.w3.org/1999/xhtml">A transform </span><a id="_idIndexMarker687"/><span class="koboSpan" id="kobo.578.1" xmlns:="http://www.w3.org/1999/xhtml">primitive transforms variables. </span><span class="koboSpan" id="kobo.578.2" xmlns:="http://www.w3.org/1999/xhtml">For example, from datetime variables, using a transform primitive, </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.580.1" xmlns:="http://www.w3.org/1999/xhtml"> extracts the </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1" xmlns:="http://www.w3.org/1999/xhtml">month</span></strong><span class="koboSpan" id="kobo.582.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1" xmlns:="http://www.w3.org/1999/xhtml">year</span></strong><span class="koboSpan" id="kobo.584.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1" xmlns:="http://www.w3.org/1999/xhtml">day</span></strong><span class="koboSpan" id="kobo.586.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.587.1" xmlns:="http://www.w3.org/1999/xhtml">week</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.588.1" xmlns:="http://www.w3.org/1999/xhtml"> values</span><a id="_idTextAnchor1199"/><span class="koboSpan" id="kobo.589.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.590.1" xmlns:="http://www.w3.org/1999/xhtml">An aggregate </span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.591.1" xmlns:="http://www.w3.org/1999/xhtml">primitive aggregates information for a unique identifier. </span><span class="koboSpan" id="kobo.591.2" xmlns:="http://www.w3.org/1999/xhtml">It uses mathematical operations such as the mean, standard deviation, maximum and minimum values, the sum, and the skew coefficient for numerical variables. </span><span class="koboSpan" id="kobo.591.3" xmlns:="http://www.w3.org/1999/xhtml">For categorical variables, aggregate primitives u</span><a id="_idTextAnchor1200"/><span class="koboSpan" id="kobo.592.1" xmlns:="http://www.w3.org/1999/xhtml">se the mode and the count of</span><a id="_idTextAnchor1201"/><span class="koboSpan" id="kobo.593.1" xmlns:="http://www.w3.org/1999/xhtml"> unique items. </span><span class="koboSpan" id="kobo.593.2" xmlns:="http://www.w3.org/1999/xhtml">For unique identifiers, they count the number </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1" xmlns:="http://www.w3.org/1999/xhtml">of occurrences.</span></span></p>
<p><span class="koboSpan" id="kobo.595.1" xmlns:="http://www.w3.org/1999/xhtml">With the functionality of transform and aggregate primitives in mind, let’s try to understand the features that we created in this recipe. </span><span class="koboSpan" id="kobo.595.2" xmlns:="http://www.w3.org/1999/xhtml">We used the default parameters of </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.597.1" xmlns:="http://www.w3.org/1999/xhtml"> to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1" xmlns:="http://www.w3.org/1999/xhtml">default features.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.599.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.600.1" xmlns:="http://www.w3.org/1999/xhtml">For more details on the default features returned by </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.602.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><span class="No-Break"><span class="koboSpan" id="kobo.603.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://featuretools.alteryx.com/en/stable/generated/featuretools.dfs.html#featuretools.dfs"><span class="No-Break"><span class="koboSpan" id="kobo.604.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/generated/featuretools.dfs.html#featuretools.dfs</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.605.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.606.1" xmlns:="http://www.w3.org/1999/xhtml">We first </span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.607.1" xmlns:="http://www.w3.org/1999/xhtml">created features for each customer. </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.609.1" xmlns:="http://www.w3.org/1999/xhtml"> returned 114 features for each customer. </span><span class="koboSpan" id="kobo.609.2" xmlns:="http://www.w3.org/1999/xhtml">Because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.610.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.611.1" xmlns:="http://www.w3.org/1999/xhtml"> data is related to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.612.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.613.1" xmlns:="http://www.w3.org/1999/xhtml"> data, which is related to the entire dataset, the </span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.614.1" xmlns:="http://www.w3.org/1999/xhtml">features were created by aggregating data at two levels. </span><span class="koboSpan" id="kobo.614.2" xmlns:="http://www.w3.org/1999/xhtml">First, the data was aggregated for each customer using the entire dataset. </span><span class="koboSpan" id="kobo.614.3" xmlns:="http://www.w3.org/1999/xhtml">Next, it was aggregated for each invoice first, and then the pre-aggregated data was aggregated again for </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1" xmlns:="http://www.w3.org/1999/xhtml">each customer.</span></span></p>
<p><span class="koboSpan" id="kobo.616.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.618.1" xmlns:="http://www.w3.org/1999/xhtml"> library names the new features with the function used to aggregate the data – for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1" xmlns:="http://www.w3.org/1999/xhtml">COUNT</span></strong><span class="koboSpan" id="kobo.620.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN</span></strong><span class="koboSpan" id="kobo.622.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.623.1" xmlns:="http://www.w3.org/1999/xhtml">STD</span></strong><span class="koboSpan" id="kobo.624.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1" xmlns:="http://www.w3.org/1999/xhtml">SKEW</span></strong><span class="koboSpan" id="kobo.626.1" xmlns:="http://www.w3.org/1999/xhtml">, among others. </span><span class="koboSpan" id="kobo.626.2" xmlns:="http://www.w3.org/1999/xhtml">Next, it uses the data that was used for the aggregation and follows it with the variable that was aggregated. </span><span class="koboSpan" id="kobo.626.3" xmlns:="http://www.w3.org/1999/xhtml">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(data.quantity)</span></strong><span class="koboSpan" id="kobo.628.1" xmlns:="http://www.w3.org/1999/xhtml"> feature contains the mean quantity of items bought by the customer calculated from the entire dataset, which is the equivalent of </span><strong class="source-inline"><span class="koboSpan" id="kobo.629.1" xmlns:="http://www.w3.org/1999/xhtml">df.groupby("customer_id"])["quantity"].mean()</span></strong><span class="koboSpan" id="kobo.630.1" xmlns:="http://www.w3.org/1999/xhtml">, if you are familiar with </span><strong class="source-inline"><span class="koboSpan" id="kobo.631.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.632.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.632.2" xmlns:="http://www.w3.org/1999/xhtml">On the other hand, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(invoices.MEAN(data.quantity))</span></strong><span class="koboSpan" id="kobo.634.1" xmlns:="http://www.w3.org/1999/xhtml"> feature first takes the mean quantity of items for each invoice – that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.635.1" xmlns:="http://www.w3.org/1999/xhtml">df.groupby("invoice"])["quantity"].mean()</span></strong><span class="koboSpan" id="kobo.636.1" xmlns:="http://www.w3.org/1999/xhtml"> – and from the resulting series, it takes the mean value, considering the invoices for a </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1" xmlns:="http://www.w3.org/1999/xhtml">particular customer.</span></span></p>
<p><span class="koboSpan" id="kobo.638.1" xmlns:="http://www.w3.org/1999/xhtml">For categorical </span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.639.1" xmlns:="http://www.w3.org/1999/xhtml">features, </span><strong class="source-inline"><span class="koboSpan" id="kobo.640.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.641.1" xmlns:="http://www.w3.org/1999/xhtml"> determines the mode and </span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.642.1" xmlns:="http://www.w3.org/1999/xhtml">the unique values. </span><span class="koboSpan" id="kobo.642.2" xmlns:="http://www.w3.org/1999/xhtml">For example, from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1" xmlns:="http://www.w3.org/1999/xhtml">description</span></strong><span class="koboSpan" id="kobo.644.1" xmlns:="http://www.w3.org/1999/xhtml"> variable, we’ve got the </span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1" xmlns:="http://www.w3.org/1999/xhtml">NUM_UNIQUE(data.description)</span></strong><span class="koboSpan" id="kobo.646.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1" xmlns:="http://www.w3.org/1999/xhtml">MODE(data.descripti</span><a id="_idTextAnchor1202"/><span class="koboSpan" id="kobo.648.1" xmlns:="http://www.w3.org/1999/xhtml">on)</span></strong><span class="koboSpan" id="kobo.649.1" xmlns:="http://www.w3.org/1999/xhtml"> features. </span><span class="koboSpan" id="kobo.649.2" xmlns:="http://www.w3.org/1999/xhtml">The description is just the name of the item. </span><span class="koboSpan" id="kobo.649.3" xmlns:="http://www.w3.org/1999/xhtml">Thus, these features highlight the number of unique item</span><a id="_idTextAnchor1203"/><span class="koboSpan" id="kobo.650.1" xmlns:="http://www.w3.org/1999/xhtml">s the customer bought and the item the customer bought the </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1" xmlns:="http://www.w3.org/1999/xhtml">most times.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.652.1" xmlns:="http://www.w3.org/1999/xhtml">Note something interesting</span></p>
<p class="callout"><span class="koboSpan" id="kobo.653.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1" xmlns:="http://www.w3.org/1999/xhtml">NUM_UNIQUE(data.description)</span></strong><span class="koboSpan" id="kobo.655.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.656.1" xmlns:="http://www.w3.org/1999/xhtml">MODE(data.description)</span></strong><span class="koboSpan" id="kobo.657.1" xmlns:="http://www.w3.org/1999/xhtml"> variables are numeric after the aggregation of the categorical features. </span><span class="koboSpan" id="kobo.657.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.658.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.659.1" xmlns:="http://www.w3.org/1999/xhtml"> library creates more features by using numerical aggregations of these newly created variables. </span><span class="koboSpan" id="kobo.659.2" xmlns:="http://www.w3.org/1999/xhtml">In this way, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.660.1" xmlns:="http://www.w3.org/1999/xhtml">MAX(invoices.NUM_UNIQUE(data.description)</span></strong><span class="koboSpan" id="kobo.661.1" xmlns:="http://www.w3.org/1999/xhtml"> feature first finds the number of unique items per invoice and then returns the maximum from those values for a particular customer, considering all the </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1" xmlns:="http://www.w3.org/1999/xhtml">customer’s invoices.</span></span></p>
<p><span class="koboSpan" id="kobo.663.1" xmlns:="http://www.w3.org/1999/xhtml">From datetime features, </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.665.1" xmlns:="http://www.w3.org/1999/xhtml"> extracts date components by default. </span><span class="koboSpan" id="kobo.665.2" xmlns:="http://www.w3.org/1999/xhtml">Remember that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.667.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.668.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.669.1" xmlns:="http://www.w3.org/1999/xhtml"> variable and the date of the first invoice for each customer, as we saw in the output of </span><em class="italic"><span class="koboSpan" id="kobo.670.1" xmlns:="http://www.w3.org/1999/xhtml">step 10</span></em><span class="koboSpan" id="kobo.671.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.671.2" xmlns:="http://www.w3.org/1999/xhtml">From this datetime feature, </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.673.1" xmlns:="http://www.w3.org/1999/xhtml"> created </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1" xmlns:="http://www.w3.org/1999/xhtml">DAY(first_invoices_time)</span></strong><span class="koboSpan" id="kobo.675.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1" xmlns:="http://www.w3.org/1999/xhtml">MONTH(first_invoices_time)</span></strong><span class="koboSpan" id="kobo.677.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1" xmlns:="http://www.w3.org/1999/xhtml">WEEKDAY(first_invoices_time)</span></strong><span class="koboSpan" id="kobo.679.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.680.1" xmlns:="http://www.w3.org/1999/xhtml">YEAR(first_invoices_time)</span></strong><span class="koboSpan" id="kobo.681.1" xmlns:="http://www.w3.org/1999/xhtml"> features containing the different </span><span class="No-Break"><span class="koboSpan" id="kobo.682.1" xmlns:="http://www.w3.org/1999/xhtml">date parts.</span></span></p>
<p><span class="koboSpan" id="kobo.683.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.685.1" xmlns:="http://www.w3.org/1999/xhtml"> also returned the total number of invoices per customer (</span><strong class="source-inline"><span class="koboSpan" id="kobo.686.1" xmlns:="http://www.w3.org/1999/xhtml">COUNT(invoices)</span></strong><span class="koboSpan" id="kobo.687.1" xmlns:="http://www.w3.org/1999/xhtml">) and the total number of row</span><a id="_idTextAnchor1204"/><a id="_idTextAnchor1205"/><span class="koboSpan" id="kobo.688.1" xmlns:="http://www.w3.org/1999/xhtml">s (</span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1" xmlns:="http://www.w3.org/1999/xhtml">COUNT(data)</span></strong><span class="koboSpan" id="kobo.690.1" xmlns:="http://www.w3.org/1999/xhtml">) </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1" xmlns:="http://www.w3.org/1999/xhtml">per customer.</span></span></p>
<h2 id="_idParaDest-256"><a id="_idTextAnchor1206"/><span class="koboSpan" id="kobo.692.1" xmlns:="http://www.w3.org/1999/xhtml">See also</span></h2>
<p><span class="koboSpan" id="kobo.693.1" xmlns:="http://www.w3.org/1999/xhtml">For more details into what inspired </span><strong class="source-inline"><span class="koboSpan" id="kobo.694.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.695.1" xmlns:="http://www.w3.org/1999/xhtml">, check the original article </span><em class="italic"><span class="koboSpan" id="kobo.696.1" xmlns:="http://www.w3.org/1999/xhtml">Deep Feature Synthesis: Towards Automating Data Science Endeavors</span></em><span class="koboSpan" id="kobo.697.1" xmlns:="http://www.w3.org/1999/xhtml"> by Kanter and Veeramachaneni </span><span class="No-Break"><span class="koboSpan" id="kobo.698.1" xmlns:="http://www.w3.org/1999/xhtml">at </span></span><a href="https://www.jmaxkanter.com/papers/DSAA_DSM_2015.pdf"><span class="No-Break"><span class="koboSpan" id="kobo.699.1" xmlns:="http://www.w3.org/1999/xhtml">https://www.jmaxkanter.</span><span id="_idTextAnchor1207"/><span id="_idTextAnchor1208"/><span class="koboSpan" id="kobo.700.1" xmlns:="http://www.w3.org/1999/xhtml">com/papers/DSAA_DSM_2015.pdf</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.701.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h1 id="_idParaDest-257"><a id="_idTextAnchor1209"/><span class="koboSpan" id="kobo.702.1" xmlns:="http://www.w3.org/1999/xhtml">Creating features with general and cumulative operations</span></h1>
<p><span class="koboSpan" id="kobo.703.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.704.1" xmlns:="http://www.w3.org/1999/xhtml">f</span><a id="_idTextAnchor1210"/><span class="koboSpan" id="kobo.705.1" xmlns:="http://www.w3.org/1999/xhtml">eaturetools</span></strong><span class="koboSpan" id="kobo.706.1" xmlns:="http://www.w3.org/1999/xhtml"> library uses </span><a id="_idIndexMarker693"/><span class="koboSpan" id="kobo.707.1" xmlns:="http://www.w3.org/1999/xhtml">what are called </span><strong class="bold"><span class="koboSpan" id="kobo.708.1" xmlns:="http://www.w3.org/1999/xhtml">transform primitives</span></strong><span class="koboSpan" id="kobo.709.1" xmlns:="http://www.w3.org/1999/xhtml"> to create features. </span><span class="koboSpan" id="kobo.709.2" xmlns:="http://www.w3.org/1999/xhtml">Transform primitives take one or more columns </span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.710.1" xmlns:="http://www.w3.org/1999/xhtml">i</span><a id="_idTextAnchor1211"/><span class="koboSpan" id="kobo.711.1" xmlns:="http://www.w3.org/1999/xhtml">n a dataset as input and </span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.712.1" xmlns:="http://www.w3.org/1999/xhtml">return one or more columns as output. </span><span class="koboSpan" id="kobo.712.2" xmlns:="http://www.w3.org/1999/xhtml">They are applied to a </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.713.1" xmlns:="http://www.w3.org/1999/xhtml">single</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.714.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame.</span></span></p>
<p><a id="_idTextAnchor1212"/><span class="koboSpan" id="kobo.715.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.717.1" xmlns:="http://www.w3.org/1999/xhtml"> library divides its transform primitives into various categories de</span><a id="_idTextAnchor1213"/><span class="koboSpan" id="kobo.718.1" xmlns:="http://www.w3.org/1999/xhtml">pending </span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.719.1" xmlns:="http://www.w3.org/1999/xhtml">on the type of operation they perform or the type of variable they modify. </span><span class="koboSpan" id="kobo.719.2" xmlns:="http://www.w3.org/1999/xhtml">For example, </span><strong class="bold"><span class="koboSpan" id="kobo.720.1" xmlns:="http://www.w3.org/1999/xhtml">general transform primitives</span></strong><span class="koboSpan" id="kobo.721.1" xmlns:="http://www.w3.org/1999/xhtml"> apply mathematical operations, such as the square root, the sine, and the cosine. </span><strong class="bold"><span class="koboSpan" id="kobo.722.1" xmlns:="http://www.w3.org/1999/xhtml">Cumul</span><a id="_idTextAnchor1214"/><span class="koboSpan" id="kobo.723.1" xmlns:="http://www.w3.org/1999/xhtml">ative transform primitives</span></strong><span class="koboSpan" id="kobo.724.1" xmlns:="http://www.w3.org/1999/xhtml"> create new features by comparing a row’s value to the </span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.725.1" xmlns:="http://www.w3.org/1999/xhtml">previous row’s value. </span><span class="koboSpan" id="kobo.725.2" xmlns:="http://www.w3.org/1999/xhtml">For example, the cumulative sum, cumulative mean, and cumulative minimum and maximum values belong to this category, as well as the difference between row v</span><a id="_idTextAnchor1215"/><span class="koboSpan" id="kobo.726.1" xmlns:="http://www.w3.org/1999/xhtml">alues. </span><span class="koboSpan" id="kobo.726.2" xmlns:="http://www.w3.org/1999/xhtml">There is another cumulative transformation that can be applied to datetime variables, which is the </span><strong class="bold"><span class="koboSpan" id="kobo.727.1" xmlns:="http://www.w3.org/1999/xhtml">time since previous</span></strong><span class="koboSpan" id="kobo.728.1" xmlns:="http://www.w3.org/1999/xhtml"> transformation, which determines the time passed between two </span><span class="No-Break"><span class="koboSpan" id="kobo.729.1" xmlns:="http://www.w3.org/1999/xhtml">consecutive timestamps.</span></span></p>
<p><span class="koboSpan" id="kobo.730.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will create features using the general and cumulative trans</span><a id="_idTextAnchor1216"/><a id="_idTextAnchor1217"/><span class="koboSpan" id="kobo.731.1" xmlns:="http://www.w3.org/1999/xhtml">form primitives </span><span class="No-Break"><span class="koboSpan" id="kobo.732.1" xmlns:="http://www.w3.org/1999/xhtml">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.733.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.734.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-258"><a id="_idTextAnchor1218"/><span class="koboSpan" id="kobo.735.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.736.1" xmlns:="http://www.w3.org/1999/xhtml">Variable transformations such as the square root or the logarithm are useful when we want to change the distribution of a variable, as we saw in </span><a href="B22396_03.xhtml#_idTextAnchor351"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.737.1" xmlns:="http://www.w3.org/1999/xhtml">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.738.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.739.1" xmlns:="http://www.w3.org/1999/xhtml">Transforming Numerical Variables</span></em><span class="koboSpan" id="kobo.740.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.740.2" xmlns:="http://www.w3.org/1999/xhtml">Other mathematical derivations such as the sine and cosine help to capture underlying data patterns, as we described in the </span><em class="italic"><span class="koboSpan" id="kobo.741.1" xmlns:="http://www.w3.org/1999/xhtml">Creating periodic features from cyclical variables</span></em><span class="koboSpan" id="kobo.742.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe in </span><a href="B22396_08.xhtml#_idTextAnchor987"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.743.1" xmlns:="http://www.w3.org/1999/xhtml">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.744.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.745.1" xmlns:="http://www.w3.org/1999/xhtml">Creating New Features</span></em><span class="koboSpan" id="kobo.746.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.746.2" xmlns:="http://www.w3.org/1999/xhtml">From the transformations described in those chapters, </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.748.1" xmlns:="http://www.w3.org/1999/xhtml"> supports the square root and the logarithm transformation and the sine and cosine (but without the normalization between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1" xmlns:="http://www.w3.org/1999/xhtml">and 2π).</span></span></p>
<p><span class="koboSpan" id="kobo.750.1" xmlns:="http://www.w3.org/1999/xhtml">With a cumulative transformation, we can, for example, get the total number of items bought per invoice by adding up the item’s quantity on each row at the invoice level. </span><span class="koboSpan" id="kobo.750.2" xmlns:="http://www.w3.org/1999/xhtml">To understand the features that we will create in this recipe, let’s create them with </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.751.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.752.1" xmlns:="http://www.w3.org/1999/xhtml"> first:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.753.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s import </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.755.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.756.1" xmlns:="http://www.w3.org/1999/xhtml">numpy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.757.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.758.1" xmlns:="http://www.w3.org/1999/xhtml">
import numpy as np
import pandas as pd</span></pre></li> <li><span class="koboSpan" id="kobo.759.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the retail dataset described in the </span><em class="italic"><span class="koboSpan" id="kobo.760.1" xmlns:="http://www.w3.org/1999/xhtml">Technical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.761.1" xmlns:="http://www.w3.org/1999/xhtml">requirements</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.762.1" xmlns:="http://www.w3.org/1999/xhtml"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.763.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])</span></pre></li> <li><span class="koboSpan" id="kobo.764.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s </span><a id="_idIndexMarker698"/><span class="koboSpan" id="kobo.765.1" xmlns:="http://www.w3.org/1999/xhtml">capture the two numerical variables, </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1" xmlns:="http://www.w3.org/1999/xhtml">price</span></strong><span class="koboSpan" id="kobo.767.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1" xmlns:="http://www.w3.org/1999/xhtml">quantity</span></strong><span class="koboSpan" id="kobo.769.1" xmlns:="http://www.w3.org/1999/xhtml">, in </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1" xmlns:="http://www.w3.org/1999/xhtml">a list:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.771.1" xmlns:="http://www.w3.org/1999/xhtml">
numeric_vars = ["quantity", "price"]</span></pre></li> <li><span class="koboSpan" id="kobo.772.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s </span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.773.1" xmlns:="http://www.w3.org/1999/xhtml">capture the names of the cumulative functions in </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1" xmlns:="http://www.w3.org/1999/xhtml">a list:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.775.1" xmlns:="http://www.w3.org/1999/xhtml">
func = ["cum</span><a id="_idTextAnchor1219"/><span class="koboSpan" id="kobo.776.1" xmlns:="http://www.w3.org/1999/xhtml">sum", "cummax", "diff"]</span></pre></li> <li><span class="koboSpan" id="kobo.777.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a list with new names for the variables that we </span><span class="No-Break"><span class="koboSpan" id="kobo.778.1" xmlns:="http://www.w3.org/1999/xhtml">will create:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.779.1" xmlns:="http://www.w3.org/1999/xhtml">
new_names = [f"{var}_{function}"
    for function in func f</span><a id="_idTextAnchor1220"/><span class="koboSpan" id="kobo.780.1" xmlns:="http://www.w3.org/1999/xhtml">or var in numeric_vars]</span></pre></li> <li><span class="koboSpan" id="kobo.781.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create new variables using the cumulative functions from </span><em class="italic"><span class="koboSpan" id="kobo.782.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.783.1" xmlns:="http://www.w3.org/1999/xhtml">, applied to the variables from </span><em class="italic"><span class="koboSpan" id="kobo.784.1" xmlns:="http://www.w3.org/1999/xhtml">step 3</span></em><span class="koboSpan" id="kobo.785.1" xmlns:="http://www.w3.org/1999/xhtml">, and add them to </span><span class="No-Break"><span class="koboSpan" id="kobo.786.1" xmlns:="http://www.w3.org/1999/xhtml">the DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.787.1" xmlns:="http://www.w3.org/1999/xhtml">
df[new_names] = df.groupby(
    "invoice")[numeric_vars].agg(func)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.788.1" xmlns:="http://www.w3.org/1999/xhtml">The previous step returns the cumulative sum, cumulative maximum value, and the difference between rows, within each invoice. </span><span class="koboSpan" id="kobo.788.2" xmlns:="http://www.w3.org/1999/xhtml">As soon as it encounters a new invoice number, it </span><span class="No-Break"><span class="koboSpan" id="kobo.789.1" xmlns:="http://www.w3.org/1999/xhtml">starts afresh.</span></span></p></li> <li><span class="koboSpan" id="kobo.790.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the original and new features for one </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1" xmlns:="http://www.w3.org/1999/xhtml">particular invoice:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.792.1" xmlns:="http://www.w3.org/1999/xhtml">
df[df["invoice"] == "489434" ][
    numeric_vars + new_names]</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.793.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1" xmlns:="http://www.w3.org/1999/xhtml">quantity_cumsum</span></strong><span class="koboSpan" id="kobo.795.1" xmlns:="http://www.w3.org/1999/xhtml"> is the cumulative sum for the variable quantity and </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1" xmlns:="http://www.w3.org/1999/xhtml">price_diff</span></strong><span class="koboSpan" id="kobo.797.1" xmlns:="http://www.w3.org/1999/xhtml"> is the price difference row </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1" xmlns:="http://www.w3.org/1999/xhtml">after row:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer171">
<span class="koboSpan" id="kobo.799.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.7 – DataFrame showing cumulative functions applied to numerical features in a single entity (invoice)" src="image/B22396_09_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.800.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.7 – DataFrame showing cumulative functions applied to numerical features in a single entity (invoice)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.801.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.802.1" xmlns:="http://www.w3.org/1999/xhtml">apply the sine </span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.803.1" xmlns:="http://www.w3.org/1999/xhtml">and cosine transformation to the </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1" xmlns:="http://www.w3.org/1999/xhtml">entire DataFrame.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.805.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a list with names for the </span><span class="No-Break"><span class="koboSpan" id="kobo.806.1" xmlns:="http://www.w3.org/1999/xhtml">new variables:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.807.1" xmlns:="http://www.w3.org/1999/xhtml">
new_names = [
    f"{var}_{function}"
    for function in ["sin", "cos"]
    for var in numeric_vars]</span></pre></li> <li><span class="koboSpan" id="kobo.808.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s transform the price and quantity with the sine </span><span class="No-Break"><span class="koboSpan" id="kobo.809.1" xmlns:="http://www.w3.org/1999/xhtml">and cosine:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.810.1" xmlns:="http://www.w3.org/1999/xhtml">
df[new_names] = df[numeric_vars].agg(
    [np.sin, np.cos])</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.811.1" xmlns:="http://www.w3.org/1999/xhtml">The transformation in </span><em class="italic"><span class="koboSpan" id="kobo.812.1" xmlns:="http://www.w3.org/1999/xhtml">step 9</span></em><span class="koboSpan" id="kobo.813.1" xmlns:="http://www.w3.org/1999/xhtml"> was applied to the entire dataset, irrespective of the invoice number, which is fine because it maps from o</span><a id="_idTextAnchor1221"/><span class="koboSpan" id="kobo.814.1" xmlns:="http://www.w3.org/1999/xhtml">ne row to the same row, as opposed to from one row to the next, as with cumulative functions. </span><span class="koboSpan" id="kobo.814.2" xmlns:="http://www.w3.org/1999/xhtml">You can inspect the result by </span><span class="No-Break"><span class="koboSpan" id="kobo.815.1" xmlns:="http://www.w3.org/1999/xhtml">executing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.816.1" xmlns:="http://www.w3.org/1999/xhtml">df[new_names].head()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.817.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.818.1" xmlns:="http://www.w3.org/1999/xhtml">Now that we understand the types of features we want to create, let’s au</span><a id="_idTextAnchor1222"/><a id="_idTextAnchor1223"/><span class="koboSpan" id="kobo.819.1" xmlns:="http://www.w3.org/1999/xhtml">tomate the process </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1" xmlns:="http://www.w3.org/1999/xhtml">with </span><a id="_idTextAnchor1224"/></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.821.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.822.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-259"><a id="_idTextAnchor1225"/><span class="koboSpan" id="kobo.823.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.824.1" xmlns:="http://www.w3.org/1999/xhtml">We </span><a id="_idTextAnchor1226"/><span class="koboSpan" id="kobo.825.1" xmlns:="http://www.w3.org/1999/xhtml">will </span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.826.1" xmlns:="http://www.w3.org/1999/xhtml">apply cumulative transformations </span><a id="_idIndexMarker703"/><span class="koboSpan" id="kobo.827.1" xmlns:="http://www.w3.org/1999/xhtml">for each invoice and general transformations to the </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1" xmlns:="http://www.w3.org/1999/xhtml">entire dataset:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.829.1" xmlns:="http://www.w3.org/1999/xhtml">First, we’ll import </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.831.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.833.1" xmlns:="http://www.w3.org/1999/xhtml">, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1" xmlns:="http://www.w3.org/1999/xhtml">Categorical</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.835.1" xmlns:="http://www.w3.org/1999/xhtml">logical type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.836.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
import featuretools as ft
from woodwork.logical_types import Categorical</span></pre></li> <li><span class="koboSpan" id="kobo.837.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the dataset described in the </span><em class="italic"><span class="koboSpan" id="kobo.838.1" xmlns:="http://www.w3.org/1999/xhtml">Technical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.839.1" xmlns:="http://www.w3.org/1999/xhtml">requirements</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.840.1" xmlns:="http://www.w3.org/1999/xhtml"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.841.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])</span></pre></li> <li><span class="koboSpan" id="kobo.842.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set up an </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.844.1" xmlns:="http://www.w3.org/1999/xhtml">
es = ft.EntitySet(id="data")</span></pre></li> <li><span class="koboSpan" id="kobo.845.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add the DataFrame to the </span><span class="No-Break"><span class="koboSpan" id="kobo.846.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.847.1" xmlns:="http://www.w3.org/1999/xhtml">
es = es.add_dataframe(
    dataframe=df,
    dataframe_name=»data»,
    index="rows",
    make_index=True,
    time_index=»invoice_date»,
    logical_types={
        "customer_id": Categorical,
        "invoice": Categorical,
    }
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.848.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.849.1" xmlns:="http://www.w3.org/1999/xhtml">By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.850.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.851.1" xmlns:="http://www.w3.org/1999/xhtml"> only retains categorical, numeric, and Boolean features in the feature matrix that is generated </span><em class="italic"><span class="koboSpan" id="kobo.852.1" xmlns:="http://www.w3.org/1999/xhtml">after</span></em><span class="koboSpan" id="kobo.853.1" xmlns:="http://www.w3.org/1999/xhtml"> creating new features. </span><span class="koboSpan" id="kobo.853.2" xmlns:="http://www.w3.org/1999/xhtml">The type of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.854.1" xmlns:="http://www.w3.org/1999/xhtml">invoice</span></strong><span class="koboSpan" id="kobo.855.1" xmlns:="http://www.w3.org/1999/xhtml"> variable is not accurately inferred, so we need to enforce it as categorical by setting its logical type as we do in </span><em class="italic"><span class="koboSpan" id="kobo.856.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.857.1" xmlns:="http://www.w3.org/1999/xhtml">, if we want </span><strong class="source-inline"><span class="koboSpan" id="kobo.858.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.859.1" xmlns:="http://www.w3.org/1999/xhtml"> to retain it in the dataset containing the new features. </span><span class="koboSpan" id="kobo.859.2" xmlns:="http://www.w3.org/1999/xhtml">To learn the datatypes inferred by </span><strong class="source-inline"><span class="koboSpan" id="kobo.860.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.861.1" xmlns:="http://www.w3.org/1999/xhtml">, you </span><a id="_idTextAnchor1227"/><span class="koboSpan" id="kobo.862.1" xmlns:="http://www.w3.org/1999/xhtml">can </span><span class="No-Break"><span class="koboSpan" id="kobo.863.1" xmlns:="http://www.w3.org/1999/xhtml">execute </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.864.1" xmlns:="http://www.w3.org/1999/xhtml">es["data"].</span><a id="_idTextAnchor1228"/><span class="koboSpan" id="kobo.865.1" xmlns:="http://www.w3.org/1999/xhtml">ww</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.866.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.867.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create </span><a id="_idIndexMarker704"/><span class="koboSpan" id="kobo.868.1" xmlns:="http://www.w3.org/1999/xhtml">a new DataFrame with </span><a id="_idIndexMarker705"/><span class="koboSpan" id="kobo.869.1" xmlns:="http://www.w3.org/1999/xhtml">a relationship to the DataFrame from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.870.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.871.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.872.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»invoices»,
    index="invoice",
    copy_columns=[«customer_id»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.873.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.874.1" xmlns:="http://www.w3.org/1999/xhtml">For more details about </span><em class="italic"><span class="koboSpan" id="kobo.875.1" xmlns:="http://www.w3.org/1999/xhtml">steps 4</span></em><span class="koboSpan" id="kobo.876.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.877.1" xmlns:="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.878.1" xmlns:="http://www.w3.org/1999/xhtml">, visit the </span><em class="italic"><span class="koboSpan" id="kobo.879.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.880.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.881.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.882.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make a list with the cumulative transformations that we’ll use to </span><span class="No-Break"><span class="koboSpan" id="kobo.883.1" xmlns:="http://www.w3.org/1999/xhtml">create features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.884.1" xmlns:="http://www.w3.org/1999/xhtml">
cum_primitives = [
    "cum_sum",
    "cum_max",
    "diff",</span><a id="_idTextAnchor1229"/><span class="koboSpan" id="kobo.885.1" xmlns:="http://www.w3.org/1999/xhtml">
    "time_since_previous"]</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.886.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.887.1" xmlns:="http://www.w3.org/1999/xhtml">You can find </span><strong class="source-inline"><span class="koboSpan" id="kobo.888.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.889.1" xmlns:="http://www.w3.org/1999/xhtml">-supported cumulative transformations at this </span><span class="No-Break"><span class="koboSpan" id="kobo.890.1" xmlns:="http://www.w3.org/1999/xhtml">link: </span></span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#cumulative-transform-primitives"><span class="No-Break"><span class="koboSpan" id="kobo.891.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#cumulative-transform-primitives</span></span></a></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.892.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make </span><a id="_idIndexMarker706"/><span class="koboSpan" id="kobo.893.1" xmlns:="http://www.w3.org/1999/xhtml">a list of the general transformations to </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1" xmlns:="http://www.w3.org/1999/xhtml">carry out:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.895.1" xmlns:="http://www.w3.org/1999/xhtml">
general_prim</span><a id="_idTextAnchor1230"/><span class="koboSpan" id="kobo.896.1" xmlns:="http://www.w3.org/1999/xhtml">itives = ["sine", " cosine "]</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.897.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.898.1" xmlns:="http://www.w3.org/1999/xhtml">You can find </span><strong class="source-inline"><span class="koboSpan" id="kobo.899.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.900.1" xmlns:="http://www.w3.org/1999/xhtml">-supported general transformations at this </span><span class="No-Break"><span class="koboSpan" id="kobo.901.1" xmlns:="http://www.w3.org/1999/xhtml">link: </span></span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#general-transform-primitives"><span class="No-Break"><span class="koboSpan" id="kobo.902.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#g</span><span id="_idTextAnchor1231"/><span class="koboSpan" id="kobo.903.1" xmlns:="http://www.w3.org/1999/xhtml">eneral-transform-primiti</span><span id="_idTextAnchor1232"/><span class="koboSpan" id="kobo.904.1" xmlns:="http://www.w3.org/1999/xhtml">ves</span></span></a></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.905.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, let’s </span><a id="_idIndexMarker707"/><span class="koboSpan" id="kobo.906.1" xmlns:="http://www.w3.org/1999/xhtml">create the features. </span><span class="koboSpan" id="kobo.906.2" xmlns:="http://www.w3.org/1999/xhtml">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.907.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.908.1" xmlns:="http://www.w3.org/1999/xhtml"> class, setting the original DataFrame as the target DataFrame – that is, the one whose variables we’ll use as a template for the new features. </span><span class="koboSpan" id="kobo.908.2" xmlns:="http://www.w3.org/1999/xhtml">Note that we pass an empty list to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.909.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.910.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter; this is to avoid returning the default aggregation primitives. </span><span class="koboSpan" id="kobo.910.2" xmlns:="http://www.w3.org/1999/xhtml">We pass the general primitives from </span><em class="italic"><span class="koboSpan" id="kobo.911.1" xmlns:="http://www.w3.org/1999/xhtml">step 7</span></em><span class="koboSpan" id="kobo.912.1" xmlns:="http://www.w3.org/1999/xhtml"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong><span class="koboSpan" id="kobo.914.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter and the cumulative primitives from </span><em class="italic"><span class="koboSpan" id="kobo.915.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.916.1" xmlns:="http://www.w3.org/1999/xhtml"> to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.917.1" xmlns:="http://www.w3.org/1999/xhtml">groupby_trans_primitives</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.918.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.919.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»data»,
    agg_primitives=[],
    trans_primitives=general_primitives,
    groupby_trans_primitives = cum_primitives,
    ignore_dataframes = [«invoices»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.920.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><em class="italic"><span class="koboSpan" id="kobo.921.1" xmlns:="http://www.w3.org/1999/xhtml">Step 8</span></em><span class="koboSpan" id="kobo.922.1" xmlns:="http://www.w3.org/1999/xhtml"> triggers the creation of features, which may take some time depending on how big the data is, how many aggregation levels it has, and the number of features to create. </span><span class="koboSpan" id="kobo.922.2" xmlns:="http://www.w3.org/1999/xhtml">You can check out the output features </span><em class="italic"><span class="koboSpan" id="kobo.923.1" xmlns:="http://www.w3.org/1999/xhtml">before</span></em><span class="koboSpan" id="kobo.924.1" xmlns:="http://www.w3.org/1999/xhtml"> creating them, by setting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1" xmlns:="http://www.w3.org/1999/xhtml">features_only</span></strong><span class="koboSpan" id="kobo.926.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter to </span><strong class="source-inline"><span class="koboSpan" id="kobo.927.1" xmlns:="http://www.w3.org/1999/xhtml">True</span></strong><span class="koboSpan" id="kobo.928.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.928.2" xmlns:="http://www.w3.org/1999/xhtml">This will return just the feature names; you can check them out, make sure they show what you need, and only then trigger the feature synthesis by setting that parameter back </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1" xmlns:="http://www.w3.org/1999/xhtml">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.930.1" xmlns:="http://www.w3.org/1999/xhtml">False</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.931.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.932.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker708"/><span class="koboSpan" id="kobo.933.1" xmlns:="http://www.w3.org/1999/xhtml">display the names </span><a id="_idTextAnchor1233"/><a id="_idIndexMarker709"/><span class="koboSpan" id="kobo.934.1" xmlns:="http://www.w3.org/1999/xhtml">of the </span><span class="No-Break"><span class="koboSpan" id="kobo.935.1" xmlns:="http://www.w3.org/1999/xhtml">created features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.936.1" xmlns:="http://www.w3.org/1999/xhtml">
fea</span><a id="_idTextAnchor1234"/><span class="koboSpan" id="kobo.937.1" xmlns:="http://www.w3.org/1999/xhtml">ture_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.938.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see the names of the features that we created, including the sine and cosine of the price and quantity, and the cumulative transformations of these variables after grouping them by </span><span class="No-Break"><span class="koboSpan" id="kobo.939.1" xmlns:="http://www.w3.org/1999/xhtml">invoice number:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.940.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: customer_id&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.941.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.942.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: stock_code&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.943.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: description&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.944.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: quantity&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.945.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: price&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.946.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: COSINE(price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.947.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: COSINE(quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.948.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SINE(price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.949.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SINE(quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.950.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: CUM_MAX(price) by invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.951.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: CUM_MAX(quantity) by invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.952.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: CUM_SUM(price) by invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.953.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: CUM_SUM(quantity) by invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.954.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: DIFF(price) by invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.955.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: DIFF(quantity) by invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.956.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: TIME_SINCE_PREVIOUS(invoice_date) by invoice&gt;]</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.957.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.958.1" xmlns:="http://www.w3.org/1999/xhtml">The sine </span><a id="_idIndexMarker710"/><span class="koboSpan" id="kobo.959.1" xmlns:="http://www.w3.org/1999/xhtml">and cosine transformation of price and quantity will probably </span><a id="_idIndexMarker711"/><span class="koboSpan" id="kobo.960.1" xmlns:="http://www.w3.org/1999/xhtml">not add much value because these are not cyclical features. </span><span class="koboSpan" id="kobo.960.2" xmlns:="http://www.w3.org/1999/xhtml">I kept these transformations in the recipe to show you how to apply transformation primitives in general, if you ever </span><span class="No-Break"><span class="koboSpan" id="kobo.961.1" xmlns:="http://www.w3.org/1999/xhtml">need them.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.962.1" xmlns:="http://www.w3.org/1999/xhtml">As you </span><a id="_idIndexMarker712"/><span class="koboSpan" id="kobo.963.1" xmlns:="http://www.w3.org/1999/xhtml">can see from the </span><a id="_idIndexMarker713"/><span class="koboSpan" id="kobo.964.1" xmlns:="http://www.w3.org/1999/xhtml">previous list, the new features were appended as new colum</span><a id="_idTextAnchor1235"/><span class="koboSpan" id="kobo.965.1" xmlns:="http://www.w3.org/1999/xhtml">ns to the original DataFrame. </span><span class="koboSpan" id="kobo.965.2" xmlns:="http://www.w3.org/1999/xhtml">You can display the fin</span><a id="_idTextAnchor1236"/><span class="koboSpan" id="kobo.966.1" xmlns:="http://www.w3.org/1999/xhtml">al DataFrame by </span><span class="No-Break"><span class="koboSpan" id="kobo.967.1" xmlns:="http://www.w3.org/1999/xhtml">executing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.968.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix.head()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.969.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.970.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.8 – DataFrame resulting from the deep feature synthesis, containing the ﻿original variables and the new features" src="image/B22396_09_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.971.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.8 – DataFrame resulting from the deep feature synthesis, containing the </span><a id="_idTextAnchor1237"/><span class="koboSpan" id="kobo.972.1" xmlns:="http://www.w3.org/1999/xhtml">original variables and the new features</span></p>
<p><span class="koboSpan" id="kobo.973.1" xmlns:="http://www.w3.org/1999/xhtml">For more details about the cr</span><a id="_idTextAnchor1238"/><a id="_idTextAnchor1239"/><span class="koboSpan" id="kobo.974.1" xmlns:="http://www.w3.org/1999/xhtml">eated features, check the </span><em class="italic"><span class="koboSpan" id="kobo.975.1" xmlns:="http://www.w3.org/1999/xhtml">How it </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.976.1" xmlns:="http://www.w3.org/1999/xhtml">works…</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.977.1" xmlns:="http://www.w3.org/1999/xhtml"> section.</span></span></p>
<h2 id="_idParaDest-260"><a id="_idTextAnchor1240"/><span class="koboSpan" id="kobo.978.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.979.1" xmlns:="http://www.w3.org/1999/xhtml">To create </span><a id="_idIndexMarker714"/><span class="koboSpan" id="kobo.980.1" xmlns:="http://www.w3.org/1999/xhtml">features using general and </span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.981.1" xmlns:="http://www.w3.org/1999/xhtml">cumulative transformations with </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.983.1" xmlns:="http://www.w3.org/1999/xhtml">, we first need to set up an entity set with the data and define the relationships between its variables. </span><span class="koboSpan" id="kobo.983.2" xmlns:="http://www.w3.org/1999/xhtml">We described how to set up an entity set in the </span><em class="italic"><span class="koboSpan" id="kobo.984.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.985.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.986.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.987.1" xmlns:="http://www.w3.org/1999/xhtml">To apply cumulative and general transforms, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.988.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.989.1" xmlns:="http://www.w3.org/1999/xhtml"> class from </span><strong class="source-inline"><span class="koboSpan" id="kobo.990.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.991.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.991.2" xmlns:="http://www.w3.org/1999/xhtml">General transformations are applied to the entire DataFrame without grouping by a specific variable. </span><span class="koboSpan" id="kobo.991.3" xmlns:="http://www.w3.org/1999/xhtml">To perform general transformations, we passed a list of strings with the transformation names to t</span><a id="_idTextAnchor1241"/><span class="koboSpan" id="kobo.992.1" xmlns:="http://www.w3.org/1999/xhtml">he </span><strong class="source-inline"><span class="koboSpan" id="kobo.993.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong><span class="koboSpan" id="kobo.994.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.995.1" xmlns:="http://www.w3.org/1999/xhtml">fr</span><a id="_idTextAnchor1242"/><span class="koboSpan" id="kobo.996.1" xmlns:="http://www.w3.org/1999/xhtml">om </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.997.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.998.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.999.1" xmlns:="http://www.w3.org/1999/xhtml">We applied cumulative transformation after grouping by </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1" xmlns:="http://www.w3.org/1999/xhtml">invoice</span></strong><span class="koboSpan" id="kobo.1001.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1001.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we passed a list of strings with the names of the cumulative transformation to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1" xmlns:="http://www.w3.org/1999/xhtml">groupby_trans_primitives</span></strong><span class="koboSpan" id="kobo.1003.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1004.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1005.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1005.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1007.1" xmlns:="http://www.w3.org/1999/xhtml"> library knows it should group by invoice because we established this unique identifier by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1008.1" xmlns:="http://www.w3.org/1999/xhtml">normalize_dataframe</span></strong><span class="koboSpan" id="kobo.1009.1" xmlns:="http://www.w3.org/1999/xhtml"> method from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1" xmlns:="http://www.w3.org/1999/xhtml">EntitySet</span></strong><span class="koboSpan" id="kobo.1011.1" xmlns:="http://www.w3.org/1999/xhtml"> in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1012.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1014.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, we did not want features created from the variables in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1015.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.1016.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame; thus, we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1017.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1018.1" xmlns:="http://www.w3.org/1999/xhtml"> to ignore this DataFrame by setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1" xmlns:="http://www.w3.org/1999/xhtml">ignore_dataframes = ["</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1" xmlns:="http://www.w3.org/1999/xhtml">invoices"]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1021.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1022.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1024.1" xmlns:="http://www.w3.org/1999/xhtml"> class returned two variables, the DataFrame with the original and new features, and the name of the features in a list. </span><span class="koboSpan" id="kobo.1024.2" xmlns:="http://www.w3.org/1999/xhtml">The new features are named with the operations </span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.1025.1" xmlns:="http://www.w3.org/1999/xhtml">applied to create them, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1" xmlns:="http://www.w3.org/1999/xhtml">SINE</span></strong><span class="koboSpan" id="kobo.1027.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1" xmlns:="http://www.w3.org/1999/xhtml">COSINE</span></strong><span class="koboSpan" id="kobo.1029.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1030.1" xmlns:="http://www.w3.org/1999/xhtml">CUM_MAX</span></strong><span class="koboSpan" id="kobo.1031.1" xmlns:="http://www.w3.org/1999/xhtml">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1032.1" xmlns:="http://www.w3.org/1999/xhtml">DIFF</span></strong><span class="koboSpan" id="kobo.1033.1" xmlns:="http://www.w3.org/1999/xhtml">, followed by the variable to which the </span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.1034.1" xmlns:="http://www.w3.org/1999/xhtml">transformation was applied and, when corresponding, the variable that was used </span><span class="No-Break"><span class="koboSpan" id="kobo.1035.1" xmlns:="http://www.w3.org/1999/xhtml">for grouping.</span></span></p>
<p><span class="koboSpan" id="kobo.1036.1" xmlns:="http://www.w3.org/1999/xhtml">Note that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1037.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1038.1" xmlns:="http://www.w3.org/1999/xhtml"> automatically recognizes and selects the variables over which the transformations should be applied. </span><span class="koboSpan" id="kobo.1038.2" xmlns:="http://www.w3.org/1999/xhtml">The sine, cosine, cumulative sum, maximum, and difference were applied to numerical variables, whereas the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1" xmlns:="http://www.w3.org/1999/xhtml">time_since_previous</span></strong> <a id="_idTextAnchor1243"/><a id="_idTextAnchor1244"/><span class="koboSpan" id="kobo.1040.1" xmlns:="http://www.w3.org/1999/xhtml">transformation was applied to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1041.1" xmlns:="http://www.w3.org/1999/xhtml">datetime variable.</span></span></p>
<h1 id="_idParaDest-261"><a id="_idTextAnchor1245"/><span class="koboSpan" id="kobo.1042.1" xmlns:="http://www.w3.org/1999/xhtml">Combining numerical features</span></h1>
<p><span class="koboSpan" id="kobo.1043.1" xmlns:="http://www.w3.org/1999/xhtml">In </span><a href="B22396_08.xhtml#_idTextAnchor987"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1044.1" xmlns:="http://www.w3.org/1999/xhtml">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.1045.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.1046.1" xmlns:="http://www.w3.org/1999/xhtml">Creating New Features</span></em><span class="koboSpan" id="kobo.1047.1" xmlns:="http://www.w3.org/1999/xhtml">, we saw th</span><a id="_idTextAnchor1246"/><span class="koboSpan" id="kobo.1048.1" xmlns:="http://www.w3.org/1999/xhtml">at we can create new features by combining </span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.1049.1" xmlns:="http://www.w3.org/1999/xhtml">variables with mathematical operations. </span><span class="koboSpan" id="kobo.1049.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1051.1" xmlns:="http://www.w3.org/1999/xhtml"> library supports several operations for combining variables, including addition, division, modulo, and multiplication. </span><span class="koboSpan" id="kobo.1051.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will l</span><a id="_idTextAnchor1247"/><a id="_idTextAnchor1248"/><span class="koboSpan" id="kobo.1052.1" xmlns:="http://www.w3.org/1999/xhtml">earn how to combine these features </span><span class="No-Break"><span class="koboSpan" id="kobo.1053.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1055.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-262"><a id="_idTextAnchor1249"/><span class="koboSpan" id="kobo.1056.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.1057.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by importing the libraries and getting the </span><span class="No-Break"><span class="koboSpan" id="kobo.1058.1" xmlns:="http://www.w3.org/1999/xhtml">dataset ready:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1059.1" xmlns:="http://www.w3.org/1999/xhtml">First, we’ll import </span><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1061.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1063.1" xmlns:="http://www.w3.org/1999/xhtml">, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1" xmlns:="http://www.w3.org/1999/xhtml">Categorical</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1065.1" xmlns:="http://www.w3.org/1999/xhtml">logical type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1066.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
import featuretools as ft
from</span><a id="_idTextAnchor1250"/><span class="koboSpan" id="kobo.1067.1" xmlns:="http://www.w3.org/1999/xhtml"> woodwork.logical_types import Categorical</span></pre></li> <li><span class="koboSpan" id="kobo.1068.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the dataset that described in the </span><em class="italic"><span class="koboSpan" id="kobo.1069.1" xmlns:="http://www.w3.org/1999/xhtml">Technical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1070.1" xmlns:="http://www.w3.org/1999/xhtml">requirements</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1071.1" xmlns:="http://www.w3.org/1999/xhtml"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1072.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])</span></pre></li> <li><span class="koboSpan" id="kobo.1073.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set up an </span><span class="No-Break"><span class="koboSpan" id="kobo.1074.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1075.1" xmlns:="http://www.w3.org/1999/xhtml">
es = ft.EntitySet(id="data")</span></pre></li> <li><span class="koboSpan" id="kobo.1076.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add </span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.1077.1" xmlns:="http://www.w3.org/1999/xhtml">the DataFrame to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1078.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1079.1" xmlns:="http://www.w3.org/1999/xhtml">
es = es.add_dataframe(
    dataframe=df,
    dataframe_name=»data»,
    index="rows",
    make_index=True,
    time_index=»invoice_date»,
    logical_types={«customer_id»: Categorical},
)</span></pre></li> <li><span class="koboSpan" id="kobo.1080.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a new DataFrame with a relationship to the DataFrame from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1081.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1082.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1083.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»invoices»,
    index="invoice",
    copy_columns=[«customer_id»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1084.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1085.1" xmlns:="http://www.w3.org/1999/xhtml">For more details about </span><em class="italic"><span class="koboSpan" id="kobo.1086.1" xmlns:="http://www.w3.org/1999/xhtml">steps 4</span></em><span class="koboSpan" id="kobo.1087.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.1088.1" xmlns:="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.1089.1" xmlns:="http://www.w3.org/1999/xhtml">, visit the </span><em class="italic"><span class="koboSpan" id="kobo.1090.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1091.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1092.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1093.1" xmlns:="http://www.w3.org/1999/xhtml">We will multiply the </span><a id="_idTextAnchor1251"/><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1" xmlns:="http://www.w3.org/1999/xhtml">quantity</span></strong><span class="koboSpan" id="kobo.1095.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1" xmlns:="http://www.w3.org/1999/xhtml">price</span></strong><span class="koboSpan" id="kobo.1097.1" xmlns:="http://www.w3.org/1999/xhtml"> variables, which reflect the number of items bought and the unit price, respectively, to obtain the total </span><span class="No-Break"><span class="koboSpan" id="kobo.1098.1" xmlns:="http://www.w3.org/1999/xhtml">amount paid:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1099.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»data»,
    agg_primitives=[],
    trans_primitives=[«multiply_numeric»],
    primitive_options={
        («multiply_numeric»): {
            ‹include_columns›: {
                'data': ["quantity", "price"]
            }
        }
    },
    ignore_dataframes=[«invoices»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1100.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1101.1" xmlns:="http://www.w3.org/1999/xhtml">We set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1102.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.1103.1" xmlns:="http://www.w3.org/1999/xhtml"> to an empty list to avoid the creation of </span><span class="No-Break"><span class="koboSpan" id="kobo.1104.1" xmlns:="http://www.w3.org/1999/xhtml">default primitives.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1105.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.1106.1" xmlns:="http://www.w3.org/1999/xhtml">display the name of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1107.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1108.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1109.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see the feature names, the last one of which corresponds to the combination of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1" xmlns:="http://www.w3.org/1999/xhtml">price</span></strong><span class="koboSpan" id="kobo.1111.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1" xmlns:="http://www.w3.org/1999/xhtml">quantity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1" xmlns:="http://www.w3.org/1999/xhtml"> variables:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1114.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: customer_id&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1115.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: stock_code&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1116.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: description&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1117.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: quantity&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1118.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: price&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1119.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: price * quantity&gt;]</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1120.1" xmlns:="http://www.w3.org/1999/xhtml">To finish off, let’s inspect the new Da</span><a id="_idTextAnchor1252"/><span class="koboSpan" id="kobo.1121.1" xmlns:="http://www.w3.org/1999/xhtml">taFrame created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1122.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1124.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix.head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1125.1" xmlns:="http://www.w3.org/1999/xhtml">In the </span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.1126.1" xmlns:="http://www.w3.org/1999/xhtml">following output, we can see that the new featu</span><a id="_idTextAnchor1253"/><span class="koboSpan" id="kobo.1127.1" xmlns:="http://www.w3.org/1999/xhtml">re was appended to the right of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1128.1" xmlns:="http://www.w3.org/1999/xhtml">original DataFrame:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.1129.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.9 – DataFrame with the new feature resulting from the product of price with quantity" src="image/B22396_09_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1130.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.9 – DataFrame with the new feature resulting from the product of price with quantity</span></p>
<p><span class="koboSpan" id="kobo.1131.1" xmlns:="http://www.w3.org/1999/xhtml">Combining features with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1132.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1133.1" xmlns:="http://www.w3.org/1999/xhtml"> may seem like a lot of work compared to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1" xmlns:="http://www.w3.org/1999/xhtml">df["price"].mul(df["quantity"])</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1135.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1136.1" xmlns:="http://www.w3.org/1999/xhtml"> functionality. </span><span class="koboSpan" id="kobo.1136.2" xmlns:="http://www.w3.org/1999/xhtml">The real power comes in when we create new features in this way and follow it up with aggregations at the invoice or customer level. </span><span class="koboSpan" id="kobo.1136.3" xmlns:="http://www.w3.org/1999/xhtml">We will discuss aggregation functions in th</span><a id="_idTextAnchor1254"/><a id="_idTextAnchor1255"/><span class="koboSpan" id="kobo.1137.1" xmlns:="http://www.w3.org/1999/xhtml">e </span><em class="italic"><span class="koboSpan" id="kobo.1138.1" xmlns:="http://www.w3.org/1999/xhtml">Creating features with aggregation </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1139.1" xmlns:="http://www.w3.org/1999/xhtml">primitives</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1140.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<h2 id="_idParaDest-263"><a id="_idTextAnchor1256"/><span class="koboSpan" id="kobo.1141.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.1142.1" xmlns:="http://www.w3.org/1999/xhtml">To multiply features, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1143.1" xmlns:="http://www.w3.org/1999/xhtml">MultiplyNumeric</span></strong><span class="koboSpan" id="kobo.1144.1" xmlns:="http://www.w3.org/1999/xhtml"> primitive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1146.1" xmlns:="http://www.w3.org/1999/xhtml">, which can be accessed from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1147.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1148.1" xmlns:="http://www.w3.org/1999/xhtml"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1" xmlns:="http://www.w3.org/1999/xhtml">multiply_numeric</span></strong><span class="koboSpan" id="kobo.1150.1" xmlns:="http://www.w3.org/1999/xhtml"> string. </span><span class="koboSpan" id="kobo.1150.2" xmlns:="http://www.w3.org/1999/xhtml">We passed the former string to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitive</span></strong> <a id="_idTextAnchor1257"/><span class="koboSpan" id="kobo.1152.1" xmlns:="http://www.w3.org/1999/xhtml">parameter and then used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1153.1" xmlns:="http://www.w3.org/1999/xhtml">primitive_options</span></strong><span class="koboSpan" id="kobo.1154.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter to specify which variables to multiply. </span><span class="koboSpan" id="kobo.1154.2" xmlns:="http://www.w3.org/1999/xhtml">Note that in addition, we passed an empty list to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1155.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.1156.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter to avoid returning the default aggregation primitives, and we ignored the features coming from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1157.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1158.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame.</span></span></p>
<p><span class="koboSpan" id="kobo.1159.1" xmlns:="http://www.w3.org/1999/xhtml">To check out other functions that allow you to combine variables, visit </span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#binary-transform-primitives"><span class="koboSpan" id="kobo.1160.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#binary-transform-primitives</span></a><span class="koboSpan" id="kobo.1161.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1161.2" xmlns:="http://www.w3.org/1999/xhtml">At the time of writing, I noticed that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1162.1" xmlns:="http://www.w3.org/1999/xhtml">MultiplyNumeric</span></strong><span class="koboSpan" id="kobo.1163.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1" xmlns:="http://www.w3.org/1999/xhtml">DivideNumeric</span></strong><span class="koboSpan" id="kobo.1165.1" xmlns:="http://www.w3.org/1999/xhtml"> are not in the documentation. </span><span class="koboSpan" id="kobo.1165.2" xmlns:="http://www.w3.org/1999/xhtml">You can always double-check which functions are supported by inspecting the source code: </span><a href="https://github.com/alteryx/featuretools/tree/main/featuretools/primitives/standard/transform/binary"><span class="koboSpan" id="kobo.1166.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/alteryx/featuretools/tree/main/featuretools/primitives/standard/transform/binary</span></a><span class="koboSpan" id="kobo.1167.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1167.2" xmlns:="http://www.w3.org/1999/xhtml">You can </span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.1168.1" xmlns:="http://www.w3.org/1999/xhtml">also check out which operations you can perform on your data by running the following command after you set up the entity set and its relationships: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1169.1" xmlns:="http://www.w3.org/1999/xhtml">ft.get_valid_primitives(es, target_dataframe_name="data", max_dep</span><a id="_idTextAnchor1258"/><a id="_idTextAnchor1259"/><span class="koboSpan" id="kobo.1170.1" xmlns:="http://www.w3.org/1999/xhtml">th=2)</span></strong><span class="koboSpan" id="kobo.1171.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1171.2" xmlns:="http://www.w3.org/1999/xhtml">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1172.1" xmlns:="http://www.w3.org/1999/xhtml">es</span></strong><span class="koboSpan" id="kobo.1173.1" xmlns:="http://www.w3.org/1999/xhtml"> is the entity set resulting from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1174.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1175.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h1 id="_idParaDest-264"><a id="_idTextAnchor1260"/><span class="koboSpan" id="kobo.1176.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting features from date and time</span></h1>
<p><span class="koboSpan" id="kobo.1177.1" xmlns:="http://www.w3.org/1999/xhtml">In </span><a href="B22396_06.xhtml#_idTextAnchor748"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1178.1" xmlns:="http://www.w3.org/1999/xhtml">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.1179.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.1180.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting Features from Date and Time</span></em><em class="italic"><span class="koboSpan" id="kobo.1181.1" xmlns:="http://www.w3.org/1999/xhtml"> Variables</span></em><span class="koboSpan" id="kobo.1182.1" xmlns:="http://www.w3.org/1999/xhtml">, we discussed how we</span><a id="_idTextAnchor1261"/><span class="koboSpan" id="kobo.1183.1" xmlns:="http://www.w3.org/1999/xhtml"> can enrich our </span><a id="_idIndexMarker723"/><span class="koboSpan" id="kobo.1184.1" xmlns:="http://www.w3.org/1999/xhtml">datasets by extracting features from the date and time parts of datetime variables, such as the year, the month, the day of the week, the hour, and much more. </span><span class="koboSpan" id="kobo.1184.2" xmlns:="http://www.w3.org/1999/xhtml">We can extract those features automatically </span><span class="No-Break"><span class="koboSpan" id="kobo.1185.1" xmlns:="http://www.w3.org/1999/xhtml">u</span><a id="_idTextAnchor1262"/><span class="koboSpan" id="kobo.1186.1" xmlns:="http://www.w3.org/1999/xhtml">tilizing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1187.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1188.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1189.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1190.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1191.1" xmlns:="http://www.w3.org/1999/xhtml"> library supports the creation of various features from datetime variables </span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.1192.1" xmlns:="http://www.w3.org/1999/xhtml">using its </span><strong class="bold"><span class="koboSpan" id="kobo.1193.1" xmlns:="http://www.w3.org/1999/xhtml">datetime transform primitives</span></strong><span class="koboSpan" id="kobo.1194.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1194.2" xmlns:="http://www.w3.org/1999/xhtml">These primitives include common variables such as year, month, and day, and other features such as </span><em class="italic"><span class="koboSpan" id="kobo.1195.1" xmlns:="http://www.w3.org/1999/xhtml">is it lunch time</span></em><span class="koboSpan" id="kobo.1196.1" xmlns:="http://www.w3.org/1999/xhtml"> or </span><em class="italic"><span class="koboSpan" id="kobo.1197.1" xmlns:="http://www.w3.org/1999/xhtml">is it weekday</span></em><span class="koboSpan" id="kobo.1198.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1198.2" xmlns:="http://www.w3.org/1999/xhtml">In addition, we can extract features indicating if the date was a federal or bank holiday (as they call it in the UK) or features that determine the distance in time to a certain date. </span><span class="koboSpan" id="kobo.1198.3" xmlns:="http://www.w3.org/1999/xhtml">For a retail company, the proximity to dates such as Boxing Day, Black Fridays, or Christmas normally signals an increase in sales, and if they are forecasting demand, these will make </span><span class="No-Break"><span class="koboSpan" id="kobo.1199.1" xmlns:="http://www.w3.org/1999/xhtml">useful variables.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1200.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1201.1" xmlns:="http://www.w3.org/1999/xhtml">For more details on the features that can be created from datetime variables, </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#datetime-transform-primitives"><span class="No-Break"><span class="koboSpan" id="kobo.1203.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#datetime-transform-primitives</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1204.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1205.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will automatically create mul</span><a id="_idTextAnchor1263"/><a id="_idTextAnchor1264"/><span class="koboSpan" id="kobo.1206.1" xmlns:="http://www.w3.org/1999/xhtml">tiple features from a datetime variable </span><span class="No-Break"><span class="koboSpan" id="kobo.1207.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1209.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-265"><a id="_idTextAnchor1265"/><span class="koboSpan" id="kobo.1210.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.1211.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin </span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.1212.1" xmlns:="http://www.w3.org/1999/xhtml">by importing the libraries and getting the </span><span class="No-Break"><span class="koboSpan" id="kobo.1213.1" xmlns:="http://www.w3.org/1999/xhtml">dataset ready:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1214.1" xmlns:="http://www.w3.org/1999/xhtml">First, we’ll import </span><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1216.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1217.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1218.1" xmlns:="http://www.w3.org/1999/xhtml">, and some special </span><span class="No-Break"><span class="koboSpan" id="kobo.1219.1" xmlns:="http://www.w3.org/1999/xhtml">datetime primitives:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1220.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
import featuretools as ft
from featuretools.primitives import (
    IsFederalHoliday, DistanceToHoliday)
from woodwork.logical_types import Categorical</span></pre></li> <li><span class="koboSpan" id="kobo.1221.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the dataset described in the </span><em class="italic"><span class="koboSpan" id="kobo.1222.1" xmlns:="http://www.w3.org/1999/xhtml">Technical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1223.1" xmlns:="http://www.w3.org/1999/xhtml">requirements</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1224.1" xmlns:="http://www.w3.org/1999/xhtml"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1225.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])</span></pre></li> <li><span class="koboSpan" id="kobo.1226.1" xmlns:="http://www.w3.org/1999/xhtml">Let</span><a id="_idTextAnchor1266"/><span class="koboSpan" id="kobo.1227.1" xmlns:="http://www.w3.org/1999/xhtml">’s set up an </span><span class="No-Break"><span class="koboSpan" id="kobo.1228.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1229.1" xmlns:="http://www.w3.org/1999/xhtml">
es = ft.EntitySet(id="data")</span></pre></li> <li><span class="koboSpan" id="kobo.1230.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add the DataFrame to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1231.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1232.1" xmlns:="http://www.w3.org/1999/xhtml">
es = es.add_dataframe(
    dataframe=df,
    dataframe_name=»data»,
    index="rows",
    make_index=True,
    time_index=»invoice_date»,
    logical_types={«customer_id»: Categorical},
)</span></pre></li> <li><span class="koboSpan" id="kobo.1233.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a new DataFrame with a relationship to the DataFrame from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1234.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1235.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1236.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»invoices»,
    index="invoice",
    copy_columns=[«customer_id»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1237.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1238.1" xmlns:="http://www.w3.org/1999/xhtml">For more details about </span><em class="italic"><span class="koboSpan" id="kobo.1239.1" xmlns:="http://www.w3.org/1999/xhtml">steps 4</span></em><span class="koboSpan" id="kobo.1240.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.1241.1" xmlns:="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.1242.1" xmlns:="http://www.w3.org/1999/xhtml">, visit the </span><em class="italic"><span class="koboSpan" id="kobo.1243.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1244.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1245.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1246.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create </span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.1247.1" xmlns:="http://www.w3.org/1999/xhtml">a primitive that returns a Boolean vector indicating if the date coincides with a UK bank holiday (that is, a </span><span class="No-Break"><span class="koboSpan" id="kobo.1248.1" xmlns:="http://www.w3.org/1999/xhtml">non-working day):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1249.1" xmlns:="http://www.w3.org/1999/xhtml">
is_bank_hol = IsFederalHoliday(country="UK")</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1250.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1251.1" xmlns:="http://www.w3.org/1999/xhtml">When setting up the primitive to determine bank holidays, it is important to choose the right country. </span><span class="koboSpan" id="kobo.1251.2" xmlns:="http://www.w3.org/1999/xhtml">For a list of supported countries, </span><span class="No-Break"><span class="koboSpan" id="kobo.1252.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://github.com/dr-prodigy/python-holidays#available-countries"><span class="No-Break"><span class="koboSpan" id="kobo.1253.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/dr-prodigy/python-holidays#available-countries</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1254.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1255.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s check out which bank holidays are included in </span><span class="No-Break"><span class="koboSpan" id="kobo.1256.1" xmlns:="http://www.w3.org/1999/xhtml">this primitive:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1257.1" xmlns:="http://www.w3.org/1999/xhtml">
hols = is_bank_hol.holidayUtil.federal_holidays.values()
available_hols = list(set(hols))</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1258.1" xmlns:="http://www.w3.org/1999/xhtml">If we </span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.1259.1" xmlns:="http://www.w3.org/1999/xhtml">execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1" xmlns:="http://www.w3.org/1999/xhtml">available_hols</span></strong><span class="koboSpan" id="kobo.1261.1" xmlns:="http://www.w3.org/1999/xhtml">, we’ll see a list of bank holidays supported for </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1" xmlns:="http://www.w3.org/1999/xhtml">the UK:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1263.1" xmlns:="http://www.w3.org/1999/xhtml">['May Day',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1264.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Good Friday',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1265.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Wedding of William and Catherine',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1266.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Coronation of Charles III',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1267.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Christmas Day',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1268.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Wedding of Charles and Diana',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1269.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Christmas Day (observed)',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1270.1" xmlns:="http://www.w3.org/1999/xhtml"> 'State Funeral of Queen Elizabeth II',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1271.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Silver Jubilee of Elizabeth II',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1272.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Spring Bank Holiday',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1273.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Diamond Jubilee of Elizabeth II',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1274.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Boxing Day (observed)',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1275.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Platinum Jubilee of Elizabeth II',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1276.1" xmlns:="http://www.w3.org/1999/xhtml"> "New Year's Day (observed)",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1277.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Boxing Day',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1278.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Golden Jubilee of Elizabeth II',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1279.1" xmlns:="http://www.w3.org/1999/xhtml"> 'Millennium Celebrations',</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1280.1" xmlns:="http://www.w3.org/1999/xhtml"> "New Year's Day"]</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1281.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create another primitive that determines the days to a certain date – in this case, the distance to </span><span class="No-Break"><span class="koboSpan" id="kobo.1282.1" xmlns:="http://www.w3.org/1999/xhtml">Boxing Day:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1283.1" xmlns:="http://www.w3.org/1999/xhtml">
days_to_boxing = DistanceToHoliday(
    holiday="Boxing Day", country="UK")</span></pre></li> <li><span class="koboSpan" id="kobo.1284.1" xmlns:="http://www.w3.org/1999/xhtml">Now, let’s make a list containing strings that identify common features that we can get from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1" xmlns:="http://www.w3.org/1999/xhtml">datetime</span></strong><span class="koboSpan" id="kobo.1286.1" xmlns:="http://www.w3.org/1999/xhtml"> and include the primitives from </span><em class="italic"><span class="koboSpan" id="kobo.1287.1" xmlns:="http://www.w3.org/1999/xhtml">steps 6</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.1288.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1289.1" xmlns:="http://www.w3.org/1999/xhtml">8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1290.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1291.1" xmlns:="http://www.w3.org/1999/xhtml">
date_primitives = [
    "day", "year", "month", "weekday",
    "days_in_month", "part_of_day",
    "hour</span><a id="_idTextAnchor1267"/><span class="koboSpan" id="kobo.1292.1" xmlns:="http://www.w3.org/1999/xhtml">", "minute",
    is_bank_hol,
    days_to_boxing
]</span></pre></li> <li><span class="koboSpan" id="kobo.1293.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.1294.1" xmlns:="http://www.w3.org/1999/xhtml">create date and time features from </span><em class="italic"><span class="koboSpan" id="kobo.1295.1" xmlns:="http://www.w3.org/1999/xhtml">step 9</span></em><span class="koboSpan" id="kobo.1296.1" xmlns:="http://www.w3.org/1999/xhtml"> based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1297.1" xmlns:="http://www.w3.org/1999/xhtml">invoice_date</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1298.1" xmlns:="http://www.w3.org/1999/xhtml">date variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1299.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»invoices»,
    agg_primitives=[],
    trans_primitives=date_primitives,
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1300.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1301.1" xmlns:="http://www.w3.org/1999/xhtml">In </span><em class="italic"><span class="koboSpan" id="kobo.1302.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.1303.1" xmlns:="http://www.w3.org/1999/xhtml">, we entered the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1" xmlns:="http://www.w3.org/1999/xhtml">invoice_date</span></strong><span class="koboSpan" id="kobo.1305.1" xmlns:="http://www.w3.org/1999/xhtml"> variable as a time variable. </span><span class="koboSpan" id="kobo.1305.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1307.1" xmlns:="http://www.w3.org/1999/xhtml"> will use this variable to create date- and </span><span class="No-Break"><span class="koboSpan" id="kobo.1308.1" xmlns:="http://www.w3.org/1999/xhtml">time-related features.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1309.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1310.1" xmlns:="http://www.w3.org/1999/xhtml">created features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1311.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1312.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see the names of the original and </span><span class="No-Break"><span class="koboSpan" id="kobo.1313.1" xmlns:="http://www.w3.org/1999/xhtml">time features:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1314.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: customer_id&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1315.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: DAY(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1316.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: DAYS_IN_MONTH(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1317.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: DISTANCE_TO_HOLIDAY(</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1318.1" xmlns:="http://www.w3.org/1999/xhtml">     first_data_time, holiday=Boxing Day, country=UK)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1319.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: HOUR(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1320.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: IS_FEDERAL_HOLIDAY(</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1321.1" xmlns:="http://www.w3.org/1999/xhtml">     first_data_time, , country=UK)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1322.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MINUTE(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1323.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MONTH(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1324.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: PART_OF_DAY(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1325.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: WEEKDAY(first_data_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1326.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: YEAR(first_data_time)&gt;]</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1327.1" xmlns:="http://www.w3.org/1999/xhtml">Go ahead and execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.1328.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix.head()</span></strong><span class="koboSpan" id="kobo.1329.1" xmlns:="http://www.w3.org/1999/xhtml"> to take a look at the resulting DataFrame with the features created from the invoice date. </span><span class="koboSpan" id="kobo.1329.2" xmlns:="http://www.w3.org/1999/xhtml">The DataFrame </span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.1330.1" xmlns:="http://www.w3.org/1999/xhtml">is quite big, so for reasons</span><a id="_idTextAnchor1268"/><span class="koboSpan" id="kobo.1331.1" xmlns:="http://www.w3.org/1999/xhtml"> of space, we’ll only display a few columns in </span><span class="No-Break"><span class="koboSpan" id="kobo.1332.1" xmlns:="http://www.w3.org/1999/xhtml">the book.</span></span></p></li> <li><span class="koboSpan" id="kobo.1333.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the resulting DataFrame containing three of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1335.1" xmlns:="http://www.w3.org/1999/xhtml">
columns = [
    "DISTANCE_TO_HOLIDAY(first_data_time,
        holiday=Boxing Day, country=UK)",
    "HOUR(first_data_time)",
    "IS_FEDERAL_HOLIDAY(first_data_time,
        country=UK)",
]
feature_matrix[columns].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1336.1" xmlns:="http://www.w3.org/1999/xhtml">In the</span><a id="_idTextAnchor1269"/><span class="koboSpan" id="kobo.1337.1" xmlns:="http://www.w3.org/1999/xhtml"> following output, we see the DataFrame with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1338.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.1339.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.10 – DataF﻿rame with some of the features derived from datetime" src="image/B22396_09_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1340.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.10 – DataF</span><a id="_idTextAnchor1270"/><span class="koboSpan" id="kobo.1341.1" xmlns:="http://www.w3.org/1999/xhtml">rame with some of the features derived from datetime</span></p>
<p><span class="koboSpan" id="kobo.1342.1" xmlns:="http://www.w3.org/1999/xhtml">Note that </span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.1343.1" xmlns:="http://www.w3.org/1999/xhtml">some of the created features are numeric, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1" xmlns:="http://www.w3.org/1999/xhtml">HOUR</span></strong><span class="koboSpan" id="kobo.1345.1" xmlns:="http://www.w3.org/1999/xhtml"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1346.1" xmlns:="http://www.w3.org/1999/xhtml">DAY</span></strong><span class="koboSpan" id="kobo.1347.1" xmlns:="http://www.w3.org/1999/xhtml">, some are Booleans, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1348.1" xmlns:="http://www.w3.org/1999/xhtml">IS_FEDERAL_HOLIDAY</span></strong><span class="koboSpan" id="kobo.1349.1" xmlns:="http://www.w3.org/1999/xhtml">, and some are categorical, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1" xmlns:="http://www.w3.org/1999/xhtml">PART_OF_DAY</span></strong><span class="koboSpan" id="kobo.1351.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1351.2" xmlns:="http://www.w3.org/1999/xhtml">To take a look at the values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1352.1" xmlns:="http://www.w3.org/1999/xhtml">PART_OF_DAY</span></strong><span class="koboSpan" id="kobo.1353.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1354.1" xmlns:="http://www.w3.org/1999/xhtml">e</span><a id="_idTextAnchor1271"/><a id="_idTextAnchor1272"/><span class="koboSpan" id="kobo.1355.1" xmlns:="http://www.w3.org/1999/xhtml">xecute </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1356.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix["PAR</span><a id="_idTextAnchor1273"/><span class="koboSpan" id="kobo.1357.1" xmlns:="http://www.w3.org/1999/xhtml">T_OF_DAY(first_data_time)"].unique()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1358.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor1274"/><span class="koboSpan" id="kobo.1359.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.1360.1" xmlns:="http://www.w3.org/1999/xhtml">To create features from datetime variables, we used datetime transform primitives from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1361.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools </span></strong><span class="koboSpan" id="kobo.1362.1" xmlns:="http://www.w3.org/1999/xhtml">(</span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#datetime-transform-primitives"><span class="koboSpan" id="kobo.1363.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#datetime-transform-primitives</span></a><span class="koboSpan" id="kobo.1364.1" xmlns:="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.1364.2" xmlns:="http://www.w3.org/1999/xhtml">These primitives can be accessed from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1366.1" xmlns:="http://www.w3.org/1999/xhtml"> using the strings and functions we specified in </span><em class="italic"><span class="koboSpan" id="kobo.1367.1" xmlns:="http://www.w3.org/1999/xhtml">steps 6</span></em><span class="koboSpan" id="kobo.1368.1" xmlns:="http://www.w3.org/1999/xhtml"> to</span><em class="italic"><span class="koboSpan" id="kobo.1369.1" xmlns:="http://www.w3.org/1999/xhtml"> 9</span></em><span class="koboSpan" id="kobo.1370.1" xmlns:="http://www.w3.org/1999/xhtml"> through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1371.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitive</span></strong><span class="koboSpan" id="kobo.1372.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter. </span><span class="koboSpan" id="kobo.1372.2" xmlns:="http://www.w3.org/1999/xhtml">Note that in addition, we passed an empty list to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1373.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.1374.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter not to return the default aggregation primitives that would have been otherwise applied to our datetime features. </span><span class="koboSpan" id="kobo.1374.2" xmlns:="http://www.w3.org/1999/xhtml">We also ignored the features coming from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1375.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1376.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1377.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1378.1" xmlns:="http://www.w3.org/1999/xhtml">We set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1379.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.1380.1" xmlns:="http://www.w3.org/1999/xhtml"> to an empty list and ignored the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1381.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.1382.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame to keep the outputs simple and be able to focus on datetime features. </span><span class="koboSpan" id="kobo.1382.2" xmlns:="http://www.w3.org/1999/xhtml">However, note that the real power of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1384.1" xmlns:="http://www.w3.org/1999/xhtml"> consists in creating primitives from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1" xmlns:="http://www.w3.org/1999/xhtml">datetim</span><a id="_idTextAnchor1275"/><a id="_idTextAnchor1276"/><a id="_idTextAnchor1277"/><span class="koboSpan" id="kobo.1386.1" xmlns:="http://www.w3.org/1999/xhtml">e</span></strong><span class="koboSpan" id="kobo.1387.1" xmlns:="http://www.w3.org/1999/xhtml"> and then aggregating them further at different </span><span class="No-Break"><span class="koboSpan" id="kobo.1388.1" xmlns:="http://www.w3.org/1999/xhtml">entity levels.</span></span></p>
<h1 id="_idParaDest-267"><a id="_idTextAnchor1278"/><span class="koboSpan" id="kobo.1389.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting features from text</span></h1>
<p><span class="koboSpan" id="kobo.1390.1" xmlns:="http://www.w3.org/1999/xhtml">In </span><a href="B22396_11.xhtml#_idTextAnchor1459"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1391.1" xmlns:="http://www.w3.org/1999/xhtml">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.1392.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.1393.1" xmlns:="http://www.w3.org/1999/xhtml">Extracting Feat</span><a id="_idTextAnchor1279"/><span class="koboSpan" id="kobo.1394.1" xmlns:="http://www.w3.org/1999/xhtml">ures from Text Variables</span></em><span class="koboSpan" id="kobo.1395.1" xmlns:="http://www.w3.org/1999/xhtml">, we will discuss various features that </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.1396.1" xmlns:="http://www.w3.org/1999/xhtml">we can extract from text pieces utilizing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1397.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1398.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1399.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.1400.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1400.2" xmlns:="http://www.w3.org/1999/xhtml">We can also extract multiple features from text automatically by </span><span class="No-Break"><span class="koboSpan" id="kobo.1401.1" xmlns:="http://www.w3.org/1999/xhtml">utilizing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1402.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1404.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1405.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1406.1" xmlns:="http://www.w3.org/1999/xhtml"> library supports the creation of several basic features from text as part of its default functionality, such as the number of characters, the number of words, the mean character count per word, and the median word length in a piece of text, </span><span class="No-Break"><span class="koboSpan" id="kobo.1407.1" xmlns:="http://www.w3.org/1999/xhtml">among others.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1408.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1409.1" xmlns:="http://www.w3.org/1999/xhtml">For a full list </span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.1410.1" xmlns:="http://www.w3.org/1999/xhtml">of the default text primitives, </span><span class="No-Break"><span class="koboSpan" id="kobo.1411.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#naturallanguage-transform-primitives"><span class="No-Break"><span class="koboSpan" id="kobo.1412.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#naturallanguage-transform-primitives</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1413.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1414.1" xmlns:="http://www.w3.org/1999/xhtml">In addition, there is an accompanying Python library, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1415.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong><span class="koboSpan" id="kobo.1416.1" xmlns:="http://www.w3.org/1999/xhtml">, which contains additional primitives to create more advanced features based on NLP. </span><span class="koboSpan" id="kobo.1416.2" xmlns:="http://www.w3.org/1999/xhtml">Among these functions, we find primitives for determining the diversity score, the polarity score, or the count of </span><span class="No-Break"><span class="koboSpan" id="kobo.1417.1" xmlns:="http://www.w3.org/1999/xhtml">stop words.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1418.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1419.1" xmlns:="http://www.w3.org/1999/xhtml">There is no documentation at the time of writing to learn more about the primitives supported </span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.1420.1" xmlns:="http://www.w3.org/1999/xhtml">by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1421.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong><span class="koboSpan" id="kobo.1422.1" xmlns:="http://www.w3.org/1999/xhtml"> library, so to find out more, you need to check the source </span><span class="No-Break"><span class="koboSpan" id="kobo.1423.1" xmlns:="http://www.w3.org/1999/xhtml">code: </span></span><a href="https://github.com/alteryx/nlp_primitives/tree/6243ef2379501bfec2c3f19e35a30b5954605e57/nlp_primitives"><span class="No-Break"><span class="koboSpan" id="kobo.1424.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/alteryx/nlp_primitives/tree/6243ef2379501bfec2c3f19e35a30b5954605e57/nlp_primitives</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1425.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1426.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will first create multiple features from a text variable utilizing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1427.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1428.1" xmlns:="http://www.w3.org/1999/xhtml">’ default functionality and the</span><a id="_idTextAnchor1280"/><a id="_idTextAnchor1281"/><span class="koboSpan" id="kobo.1429.1" xmlns:="http://www.w3.org/1999/xhtml">n highlight how to use p</span><a id="_idTextAnchor1282"/><span class="koboSpan" id="kobo.1430.1" xmlns:="http://www.w3.org/1999/xhtml">rimitives from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1431.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1432.1" xmlns:="http://www.w3.org/1999/xhtml"> library.</span></span></p>
<h2 id="_idParaDest-268"><a id="_idTextAnchor1283"/><span class="koboSpan" id="kobo.1433.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1434.1" xmlns:="http://www.w3.org/1999/xhtml">To follow along with this recipe, you need to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1435.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong><span class="koboSpan" id="kobo.1436.1" xmlns:="http://www.w3.org/1999/xhtml"> library, which you can do </span><span class="No-Break"><span class="koboSpan" id="kobo.1437.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1438.1" xmlns:="http://www.w3.org/1999/xhtml">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1439.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1440.1" xmlns:="http://www.w3.org/1999/xhtml">
pip install nlp_primitives</span></pre> <p><span class="koboSpan" id="kobo.1441.1" xmlns:="http://www.w3.org/1999/xhtml">Otherwise, you can </span><span class="No-Break"><span class="koboSpan" id="kobo.1442.1" xmlns:="http://www.w3.org/1999/xhtml">use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1443.1" xmlns:="http://www.w3.org/1999/xhtml">conda</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1444.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1445.1" xmlns:="http://www.w3.org/1999/xhtml">
conda install -c conda-forge nlp-primitives</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.1446.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1447.1" xmlns:="http://www.w3.org/1999/xhtml">For more details, visit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1448.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primi</span><a id="_idTextAnchor1284"/><a id="_idTextAnchor1285"/><span class="koboSpan" id="kobo.1449.1" xmlns:="http://www.w3.org/1999/xhtml">tives</span></strong><span class="koboSpan" id="kobo.1450.1" xmlns:="http://www.w3.org/1999/xhtml"> GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.1451.1" xmlns:="http://www.w3.org/1999/xhtml">repository: </span></span><a href="https://github.com/alteryx/nlp_primitives"><span class="No-Break"><span class="koboSpan" id="kobo.1452.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/alteryx/nlp_primitives</span></span></a></p>
<h2 id="_idParaDest-269"><a id="_idTextAnchor1286"/><span class="koboSpan" id="kobo.1453.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.1454.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin </span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.1455.1" xmlns:="http://www.w3.org/1999/xhtml">by importing the libraries and getting the </span><span class="No-Break"><span class="koboSpan" id="kobo.1456.1" xmlns:="http://www.w3.org/1999/xhtml">dataset ready:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1457.1" xmlns:="http://www.w3.org/1999/xhtml">First, we’ll import </span><strong class="source-inline"><span class="koboSpan" id="kobo.1458.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1459.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1460.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1461.1" xmlns:="http://www.w3.org/1999/xhtml">, and the </span><span class="No-Break"><span class="koboSpan" id="kobo.1462.1" xmlns:="http://www.w3.org/1999/xhtml">logical types:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1463.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
import featuretools as ft
from woodwork.logical_types import (
   Categorical, NaturalLanguage)</span></pre></li> <li><span class="koboSpan" id="kobo.1464.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the dataset described in the </span><em class="italic"><span class="koboSpan" id="kobo.1465.1" xmlns:="http://www.w3.org/1999/xhtml">Technical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1466.1" xmlns:="http://www.w3.org/1999/xhtml">requirements</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1467.1" xmlns:="http://www.w3.org/1999/xhtml"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1468.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])</span><a id="_idTextAnchor1287"/></pre></li> <li><span class="koboSpan" id="kobo.1469.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set up an </span><span class="No-Break"><span class="koboSpan" id="kobo.1470.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1471.1" xmlns:="http://www.w3.org/1999/xhtml">
es = ft.EntitySet(id="data")</span></pre></li> <li><span class="koboSpan" id="kobo.1472.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add the DataFrame to the entity set, highlighting that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1473.1" xmlns:="http://www.w3.org/1999/xhtml">description</span></strong><span class="koboSpan" id="kobo.1474.1" xmlns:="http://www.w3.org/1999/xhtml"> variable is a </span><span class="No-Break"><span class="koboSpan" id="kobo.1475.1" xmlns:="http://www.w3.org/1999/xhtml">text variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1476.1" xmlns:="http://www.w3.org/1999/xhtml">
es = es.add_dataframe(
    dataframe=df,
    dataframe_name=»data»,
    index="rows",
    make_index=True,
    time_index=»invoice_date»,
    logical_types={
        «customer_id»: Categorical,
        "invoice": Categorical,
        «description»: NaturalLanguage,
    }
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1477.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1478.1" xmlns:="http://www.w3.org/1999/xhtml">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1479.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1480.1" xmlns:="http://www.w3.org/1999/xhtml"> library‘s text primitives to work, we need to indicate which variables are text by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1481.1" xmlns:="http://www.w3.org/1999/xhtml">NaturalLanguage</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1482.1" xmlns:="http://www.w3.org/1999/xhtml">logical type.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1483.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create </span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.1484.1" xmlns:="http://www.w3.org/1999/xhtml">a new DataFrame with a relationship to the DataFrame from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1485.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1486.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1487.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»invoices»,
    index="invoice",
    copy_columns=[«customer_id»],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1488.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1489.1" xmlns:="http://www.w3.org/1999/xhtml">For more details about </span><em class="italic"><span class="koboSpan" id="kobo.1490.1" xmlns:="http://www.w3.org/1999/xhtml">steps 4</span></em><span class="koboSpan" id="kobo.1491.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.1492.1" xmlns:="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.1493.1" xmlns:="http://www.w3.org/1999/xhtml">, visit the </span><em class="italic"><span class="koboSpan" id="kobo.1494.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up </span><a id="_idTextAnchor1288"/><span class="koboSpan" id="kobo.1495.1" xmlns:="http://www.w3.org/1999/xhtml">an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1496.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1497.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1498.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make a list with strings corresponding to the text features we want </span><span class="No-Break"><span class="koboSpan" id="kobo.1499.1" xmlns:="http://www.w3.org/1999/xhtml">to create:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1500.1" xmlns:="http://www.w3.org/1999/xhtml">
text_primitives = [
    "num_words",
    "num_characters",
    "MeanCharactersPerWord" ,
    "PunctuationCount"]</span></pre></li> <li><span class="koboSpan" id="kobo.1501.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.1502.1" xmlns:="http://www.w3.org/1999/xhtml">extract the text features from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1" xmlns:="http://www.w3.org/1999/xhtml">description</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1504.1" xmlns:="http://www.w3.org/1999/xhtml"> variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1505.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»data»,
    agg_primitives=[],
    trans_primitives=text_primitives,
    ignore_dataframes=[«invoices»],
)</span></pre></li> <li><span class="koboSpan" id="kobo.1506.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1507.1" xmlns:="http://www.w3.org/1999/xhtml">created features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1508.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1509.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see the names of the original features, followed by those created from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1510.1" xmlns:="http://www.w3.org/1999/xhtml">description</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1511.1" xmlns:="http://www.w3.org/1999/xhtml"> variable:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1512.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: customer_id&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1513.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: invoice&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1514.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: stock_code&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1515.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: quantity&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1516.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: price&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1517.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN_CHARACTERS_PER_WORD(description)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1518.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: NUM_CHARACTERS(description)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1519.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: NUM_WORDS(description)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1520.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: PUNCTUATION_COUNT(description)&gt;]</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1521.1" xmlns:="http://www.w3.org/1999/xhtml">Go ahead and inspect the result by </span><span class="No-Break"><span class="koboSpan" id="kobo.1522.1" xmlns:="http://www.w3.org/1999/xhtml">executing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1523.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix.head()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1524.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1525.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.1526.1" xmlns:="http://www.w3.org/1999/xhtml">a slice of the DataFrame containing the </span><span class="No-Break"><span class="koboSpan" id="kobo.1527.1" xmlns:="http://www.w3.org/1999/xhtml">text-derived features:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1528.1" xmlns:="http://www.w3.org/1999/xhtml">text_f = [</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1529.1" xmlns:="http://www.w3.org/1999/xhtml">     "NUM_CHARACTERS(description)",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1530.1" xmlns:="http://www.w3.org/1999/xhtml">     "NUM_WORDS(description)",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1531.1" xmlns:="http://www.w3.org/1999/xhtml">     "PUNCTUATION_COUNT(description)",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1532.1" xmlns:="http://www.w3.org/1999/xhtml">]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1533.1" xmlns:="http://www.w3.org/1999/xhtml">feature_matrix[text_f].head()</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1534.1" xmlns:="http://www.w3.org/1999/xhtml">In the followin</span><a id="_idTextAnchor1289"/><span class="koboSpan" id="kobo.1535.1" xmlns:="http://www.w3.org/1999/xhtml">g output, we see a DataFrame with the features created from </span><span class="No-Break"><span class="koboSpan" id="kobo.1536.1" xmlns:="http://www.w3.org/1999/xhtml">the text:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.1537.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.11 – DataFrame with the features created from text" src="image/B22396_09_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1538.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.11 – DataFrame with the features created from text</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1539.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1540.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1542.1" xmlns:="http://www.w3.org/1999/xhtml"> library removes the original text variable, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1543.1" xmlns:="http://www.w3.org/1999/xhtml">description</span></strong><span class="koboSpan" id="kobo.1544.1" xmlns:="http://www.w3.org/1999/xhtml">, and in its place, it returns the </span><span class="No-Break"><span class="koboSpan" id="kobo.1545.1" xmlns:="http://www.w3.org/1999/xhtml">new features.</span></span></p>
<p><span class="koboSpan" id="kobo.1546.1" xmlns:="http://www.w3.org/1999/xhtml">To create features using the primitives from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1547.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong><span class="koboSpan" id="kobo.1548.1" xmlns:="http://www.w3.org/1999/xhtml"> package, you need to import them first – for example, by executing from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives import DiversityScore</span></strong><span class="koboSpan" id="kobo.1550.1" xmlns:="http://www.w3.org/1999/xhtml"> – and then add the primitives to the text primitive list that we created in </span><em class="italic"><span class="koboSpan" id="kobo.1551.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.1552.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1552.2" xmlns:="http://www.w3.org/1999/xhtml">Note that these are</span><a id="_idTextAnchor1290"/><a id="_idTextAnchor1291"/> <a id="_idTextAnchor1292"/><a id="_idTextAnchor1293"/><span class="koboSpan" id="kobo.1553.1" xmlns:="http://www.w3.org/1999/xhtml">complex functions, so they</span><a id="_idTextAnchor1294"/><span class="koboSpan" id="kobo.1554.1" xmlns:="http://www.w3.org/1999/xhtml"> may take some time to create </span><span class="No-Break"><span class="koboSpan" id="kobo.1555.1" xmlns:="http://www.w3.org/1999/xhtml">the features.</span></span></p>
<h2 id="_idParaDest-270"><a id="_idTextAnchor1295"/><span class="koboSpan" id="kobo.1556.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.1557.1" xmlns:="http://www.w3.org/1999/xhtml">To create </span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.1558.1" xmlns:="http://www.w3.org/1999/xhtml">features from text variables, we used the default text primitives from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1559.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1560.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1560.2" xmlns:="http://www.w3.org/1999/xhtml">These primitives can be accessed from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1562.1" xmlns:="http://www.w3.org/1999/xhtml"> by passing a list with strings corresponding to the primitive names, such as those from </span><em class="italic"><span class="koboSpan" id="kobo.1563.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.1564.1" xmlns:="http://www.w3.org/1999/xhtml">, to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1566.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.1567.1" xmlns:="http://www.w3.org/1999/xhtml">For more advanced primitives, you need to import the primitive functions from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1568.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong><span class="koboSpan" id="kobo.1569.1" xmlns:="http://www.w3.org/1999/xhtml"> library and then pass them on to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1570.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong><span class="koboSpan" id="kobo.1571.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1572.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1573.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1573.2" xmlns:="http://www.w3.org/1999/xhtml">With this, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1574.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1575.1" xmlns:="http://www.w3.org/1999/xhtml"> can tap into the functionality of these primitives to create new features from the text. </span><span class="koboSpan" id="kobo.1575.2" xmlns:="http://www.w3.org/1999/xhtml">T</span><a id="_idTextAnchor1296"/><a id="_idTextAnchor1297"/><span class="koboSpan" id="kobo.1576.1" xmlns:="http://www.w3.org/1999/xhtml">he </span><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1" xmlns:="http://www.w3.org/1999/xhtml">nlp_primitives</span></strong><span class="koboSpan" id="kobo.1578.1" xmlns:="http://www.w3.org/1999/xhtml"> library uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1579.1" xmlns:="http://www.w3.org/1999/xhtml">nltk</span></strong><span class="koboSpan" id="kobo.1580.1" xmlns:="http://www.w3.org/1999/xhtml"> Python library un</span><a id="_idTextAnchor1298"/><span class="koboSpan" id="kobo.1581.1" xmlns:="http://www.w3.org/1999/xhtml">der </span><span class="No-Break"><span class="koboSpan" id="kobo.1582.1" xmlns:="http://www.w3.org/1999/xhtml">the hood.</span></span></p>
<h1 id="_idParaDest-271"><a id="_idTextAnchor1299"/><span class="koboSpan" id="kobo.1583.1" xmlns:="http://www.w3.org/1999/xhtml">Creating features with aggregation primitives</span></h1>
<p><span class="koboSpan" id="kobo.1584.1" xmlns:="http://www.w3.org/1999/xhtml">Throughout this chapter, we’ve created features automatically by mapping existing variables into </span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.1585.1" xmlns:="http://www.w3.org/1999/xhtml">new features through various functions. </span><span class="koboSpan" id="kobo.1585.2" xmlns:="http://www.w3.org/1999/xhtml">For example, we extracted date and time parts from datetime variables, counted the number of words,</span><a id="_idTextAnchor1300"/><span class="koboSpan" id="kobo.1586.1" xmlns:="http://www.w3.org/1999/xhtml"> characters, and punctuation in texts, combined numerical features into new variables, and transformed features with functions such as sine and cosine. </span><span class="koboSpan" id="kobo.1586.2" xmlns:="http://www.w3.org/1999/xhtml">To create these features, we worked with </span><span class="No-Break"><span class="koboSpan" id="kobo.1587.1" xmlns:="http://www.w3.org/1999/xhtml">transform primitives.</span></span></p>
<p><span class="koboSpan" id="kobo.1588.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1589.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1590.1" xmlns:="http://www.w3.org/1999/xhtml"> library also </span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.1591.1" xmlns:="http://www.w3.org/1999/xhtml">supports </span><strong class="bold"><span class="koboSpan" id="kobo.1592.1" xmlns:="http://www.w3.org/1999/xhtml">aggregation primitives</span></strong><span class="koboSpan" id="kobo.1593.1" xmlns:="http://www.w3.org/1999/xhtml">, and here is where it gets interesting. </span><span class="koboSpan" id="kobo.1593.2" xmlns:="http://www.w3.org/1999/xhtml">These primitives take related observations as input and return a single value as output. </span><span class="koboSpan" id="kobo.1593.3" xmlns:="http://www.w3.org/1999/xhtml">For example, if we have a numerical variable, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1" xmlns:="http://www.w3.org/1999/xhtml">price</span></strong><span class="koboSpan" id="kobo.1595.1" xmlns:="http://www.w3.org/1999/xhtml">, related to an invoice, an aggregation primitive would take all the price observations for a single invoice and return a single value, such as the mean price or the sum (that is, the total amount paid), for </span><span class="No-Break"><span class="koboSpan" id="kobo.1596.1" xmlns:="http://www.w3.org/1999/xhtml">that invoice.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1597.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1598.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1599.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1600.1" xmlns:="http://www.w3.org/1999/xhtml"> aggregation functionality is the equivalent of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1601.1" xmlns:="http://www.w3.org/1999/xhtml">groupby</span></strong><span class="koboSpan" id="kobo.1602.1" xmlns:="http://www.w3.org/1999/xhtml"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1603.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1604.1" xmlns:="http://www.w3.org/1999/xhtml">, followed by </span><strong class="source-inline"><span class="koboSpan" id="kobo.1605.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1606.1" xmlns:="http://www.w3.org/1999/xhtml"> fun</span><a id="_idTextAnchor1301"/><span class="koboSpan" id="kobo.1607.1" xmlns:="http://www.w3.org/1999/xhtml">ctions such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1608.1" xmlns:="http://www.w3.org/1999/xhtml">mean</span></strong><span class="koboSpan" id="kobo.1609.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1610.1" xmlns:="http://www.w3.org/1999/xhtml">sum</span></strong><span class="koboSpan" id="kobo.1611.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1612.1" xmlns:="http://www.w3.org/1999/xhtml">std</span></strong><span class="koboSpan" id="kobo.1613.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1614.1" xmlns:="http://www.w3.org/1999/xhtml">count</span></strong><span class="koboSpan" id="kobo.1615.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1616.1" xmlns:="http://www.w3.org/1999/xhtml">among others.</span></span></p>
<p><span class="koboSpan" id="kobo.1617.1" xmlns:="http://www.w3.org/1999/xhtml">Some aggregation primitives work with numerical variables, such as the mean, sum, or maximum </span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.1618.1" xmlns:="http://www.w3.org/1999/xhtml">and minimum values. </span><span class="koboSpan" id="kobo.1618.2" xmlns:="http://www.w3.org/1999/xhtml">Other aggregation primitives are specific to categorical variables, such as the number</span><a id="_idTextAnchor1302"/><span class="koboSpan" id="kobo.1619.1" xmlns:="http://www.w3.org/1999/xhtml"> of unique values and the most frequent </span><span class="No-Break"><span class="koboSpan" id="kobo.1620.1" xmlns:="http://www.w3.org/1999/xhtml">value (mode).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1621.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1622.1" xmlns:="http://www.w3.org/1999/xhtml">For a </span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.1623.1" xmlns:="http://www.w3.org/1999/xhtml">complete list of supported aggregation primitives, </span><span class="No-Break"><span class="koboSpan" id="kobo.1624.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://featuretools.alteryx.com/en/stable/api_reference.html#aggregation-primitives"><span class="No-Break"><span class="koboSpan" id="kobo.1625.1" xmlns:="http://www.w3.org/1999/xhtml">https://featuretools.alteryx.com/en/stable/api_reference.html#aggregation-primitives</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1626.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1627.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will first create multiple features by aggregating existing variables. </span><span class="koboSpan" id="kobo.1627.2" xmlns:="http://www.w3.org/1999/xhtml">After that, we will combine the use of transfo</span><a id="_idTextAnchor1303"/><a id="_idTextAnchor1304"/><span class="koboSpan" id="kobo.1628.1" xmlns:="http://www.w3.org/1999/xhtml">rm and aggregation primitives to highlight the true power </span><span class="No-Break"><span class="koboSpan" id="kobo.1629.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1630.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1631.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-272"><a id="_idTextAnchor1305"/><span class="koboSpan" id="kobo.1632.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1633.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will use the </span><em class="italic"><span class="koboSpan" id="kobo.1634.1" xmlns:="http://www.w3.org/1999/xhtml">Online Retail II</span></em><span class="koboSpan" id="kobo.1635.1" xmlns:="http://www.w3.org/1999/xhtml"> dataset from the UCI Machine Learning Repository. </span><span class="koboSpan" id="kobo.1635.2" xmlns:="http://www.w3.org/1999/xhtml">This dataset has information about products (items), invoices, and customers. </span><span class="koboSpan" id="kobo.1635.3" xmlns:="http://www.w3.org/1999/xhtml">To follow along with this recipe, it is important to understand the nature of and the relationships between these entities and how to correctly set up an entity set with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1636.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1637.1" xmlns:="http://www.w3.org/1999/xhtml">, which we described in the </span><em class="italic"><span class="koboSpan" id="kobo.1638.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features automatically</span></em><span class="koboSpan" id="kobo.1639.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe. </span><span class="koboSpan" id="kobo.1639.2" xmlns:="http://www.w3.org/1999/xhtml">Make</span><a id="_idTextAnchor1306"/><a id="_idTextAnchor1307"/><span class="koboSpan" id="kobo.1640.1" xmlns:="http://www.w3.org/1999/xhtml"> sure you checked that recip</span><a id="_idTextAnchor1308"/><span class="koboSpan" id="kobo.1641.1" xmlns:="http://www.w3.org/1999/xhtml">e out before proceeding with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1642.1" xmlns:="http://www.w3.org/1999/xhtml">next section.</span></span></p>
<h2 id="_idParaDest-273"><a id="_idTextAnchor1309"/><span class="koboSpan" id="kobo.1643.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.1644.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by importing the libraries and getting the </span><span class="No-Break"><span class="koboSpan" id="kobo.1645.1" xmlns:="http://www.w3.org/1999/xhtml">dataset ready:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1646.1" xmlns:="http://www.w3.org/1999/xhtml">First, we’ll import </span><strong class="source-inline"><span class="koboSpan" id="kobo.1647.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1648.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1649.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1650.1" xmlns:="http://www.w3.org/1999/xhtml">, and the </span><span class="No-Break"><span class="koboSpan" id="kobo.1651.1" xmlns:="http://www.w3.org/1999/xhtml">logical types:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1652.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
import featuretools as ft
from woodwork.logical_types import (
    Categorical, NaturalLanguage)</span></pre></li> <li><span class="koboSpan" id="kobo.1653.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load </span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.1654.1" xmlns:="http://www.w3.org/1999/xhtml">the dataset described in the </span><em class="italic"><span class="koboSpan" id="kobo.1655.1" xmlns:="http://www.w3.org/1999/xhtml">Technical </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1656.1" xmlns:="http://www.w3.org/1999/xhtml">requirements</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1657.1" xmlns:="http://www.w3.org/1999/xhtml"> section:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1658.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.read_csv(
    «retail.csv», parse_dates=[«invoice_date»])</span></pre></li> <li><span class="koboSpan" id="kobo.1659.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set up an </span><span class="No-Break"><span class="koboSpan" id="kobo.1660.1" xmlns:="http://www.w3.org/1999/xhtml">entity set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1661.1" xmlns:="http://www.w3.org/1999/xhtml">
es = ft.EntitySet(id="data")</span></pre></li> <li><span class="koboSpan" id="kobo.1662.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add the DataFrame to the entity set, highlighting that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1663.1" xmlns:="http://www.w3.org/1999/xhtml">description</span></strong><span class="koboSpan" id="kobo.1664.1" xmlns:="http://www.w3.org/1999/xhtml"> variable is a text variable, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1665.1" xmlns:="http://www.w3.org/1999/xhtml">customer_id</span></strong><span class="koboSpan" id="kobo.1666.1" xmlns:="http://www.w3.org/1999/xhtml"> is categorical, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1667.1" xmlns:="http://www.w3.org/1999/xhtml">invoice_date</span></strong><span class="koboSpan" id="kobo.1668.1" xmlns:="http://www.w3.org/1999/xhtml"> is a </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1" xmlns:="http://www.w3.org/1999/xhtml">datetime feature:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1670.1" xmlns:="http://www.w3.org/1999/xhtml">
es = es.add_dataframe(
    dataframe=df,
    dataframe_name=»data»,
    index="rows",
    make_index=True,
    time_index=»invoice_date»,
    logical_types={
        «customer_id»: Categorical,
        «description»: NaturalLanguage,
    }
)</span></pre></li> <li><span class="koboSpan" id="kobo.1671.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a new DataFrame with a relationship to the DataFrame from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1672.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1673.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1674.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»data»,
    new_dataframe_name=»invo</span><a id="_idTextAnchor1310"/><span class="koboSpan" id="kobo.1675.1" xmlns:="http://www.w3.org/1999/xhtml">ices»,
    index="invoice",
    copy_columns=[«customer_id»],
)</span></pre></li> <li><span class="koboSpan" id="kobo.1676.1" xmlns:="http://www.w3.org/1999/xhtml">Now, we add </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.1677.1" xmlns:="http://www.w3.org/1999/xhtml">the second relationship, which is between customers and invoices. </span><span class="koboSpan" id="kobo.1677.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we indicate the base DataFrame, which we called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1678.1" xmlns:="http://www.w3.org/1999/xhtml">invoices</span></strong><span class="koboSpan" id="kobo.1679.1" xmlns:="http://www.w3.org/1999/xhtml"> in </span><em class="italic"><span class="koboSpan" id="kobo.1680.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.1681.1" xmlns:="http://www.w3.org/1999/xhtml">, we give the new DataFrame a name, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1682.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.1683.1" xmlns:="http://www.w3.org/1999/xhtml">, and we add a unique </span><span class="No-Break"><span class="koboSpan" id="kobo.1684.1" xmlns:="http://www.w3.org/1999/xhtml">customer identifier:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1685.1" xmlns:="http://www.w3.org/1999/xhtml">
es.normalize_dataframe(
    base_dataframe_name=»invoices»,
    new_dataframe_name=»customers»,
    index=»customer_id»,
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1686.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1687.1" xmlns:="http://www.w3.org/1999/xhtml">For more details about </span><em class="italic"><span class="koboSpan" id="kobo.1688.1" xmlns:="http://www.w3.org/1999/xhtml">steps 4</span></em><span class="koboSpan" id="kobo.1689.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><em class="italic"><span class="koboSpan" id="kobo.1690.1" xmlns:="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.1691.1" xmlns:="http://www.w3.org/1999/xhtml">, visit the </span><em class="italic"><span class="koboSpan" id="kobo.1692.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1693.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1694.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1695.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make a list with string names that identify the aggregation primitives we want </span><span class="No-Break"><span class="koboSpan" id="kobo.1696.1" xmlns:="http://www.w3.org/1999/xhtml">to use:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1697.1" xmlns:="http://www.w3.org/1999/xhtml">
agg_primitives = ["mean", "max", "min", "sum"]</span></pre></li> <li><span class="koboSpan" id="kobo.1698.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create features by aggregating the data at the customer level. </span><span class="koboSpan" id="kobo.1698.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we set up the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1699.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1700.1" xmlns:="http://www.w3.org/1999/xhtml"> class from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1701.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1702.1" xmlns:="http://www.w3.org/1999/xhtml">, indicating </span><strong class="source-inline"><span class="koboSpan" id="kobo.1703.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.1704.1" xmlns:="http://www.w3.org/1999/xhtml"> as the target DataFrame and passing the aggregation primitives from </span><em class="italic"><span class="koboSpan" id="kobo.1705.1" xmlns:="http://www.w3.org/1999/xhtml">step 7</span></em><span class="koboSpan" id="kobo.1706.1" xmlns:="http://www.w3.org/1999/xhtml"> and an empty list to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1707.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong><span class="koboSpan" id="kobo.1708.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter to prevent </span><strong class="source-inline"><span class="koboSpan" id="kobo.1709.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1710.1" xmlns:="http://www.w3.org/1999/xhtml"> from returning the </span><span class="No-Break"><span class="koboSpan" id="kobo.1711.1" xmlns:="http://www.w3.org/1999/xhtml">default transformations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1712.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»cus</span><a id="_idTextAnchor1311"/><span class="koboSpan" id="kobo.1713.1" xmlns:="http://www.w3.org/1999/xhtml">tomers»,
    agg_primitives=agg_primitives,
    trans_primitives=[],
)</span></pre></li> <li><span class="koboSpan" id="kobo.1714.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display </span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.1715.1" xmlns:="http://www.w3.org/1999/xhtml">the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1716.1" xmlns:="http://www.w3.org/1999/xhtml">created features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1717.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1718.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see the name features that were aggregated at the </span><span class="No-Break"><span class="koboSpan" id="kobo.1719.1" xmlns:="http://www.w3.org/1999/xhtml">customer level:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1720.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: MAX(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1721.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1722.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1723.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1724.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1725.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1726.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1727.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1728.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(invoices.MEAN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1729.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(invoices.MEAN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1730.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(invoices.MIN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1731.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(invoices.MIN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1732.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(invoices.SUM(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1733.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MAX(invoices.SUM(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1734.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MAX(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1735.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MAX(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1736.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MEAN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1737.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MEAN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1738.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MIN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1739.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MIN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1740.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.SUM(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1741.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.SUM(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1742.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(invoices.MAX(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1743.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(invoices.MAX(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1744.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(invoices.MEAN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1745.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(invoices.MEAN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1746.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(invoices.SUM(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1747.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MIN(invoices.SUM(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1748.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(invoices.MAX(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1749.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(invoices.MAX(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1750.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(invoices.MEAN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1751.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(invoices.MEAN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1752.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(invoices.MIN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1753.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: SUM(invoices.MIN(data.quantity))&gt;]</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1754.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1755.1" xmlns:="http://www.w3.org/1999/xhtml">Remember that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1756.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1757.1" xmlns:="http://www.w3.org/1999/xhtml"> names features with the function used to create them, followed by the DataFrame that was used in the computation, followed by the variable that was used in the computation. </span><span class="koboSpan" id="kobo.1757.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1758.1" xmlns:="http://www.w3.org/1999/xhtml">MAX(data.price)</span></strong><span class="koboSpan" id="kobo.1759.1" xmlns:="http://www.w3.org/1999/xhtml"> is the maximum price seen in the dataset for each customer. </span><span class="koboSpan" id="kobo.1759.2" xmlns:="http://www.w3.org/1999/xhtml">On the other hand, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1760.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(invoices.MAX(data.price))</span></strong><span class="koboSpan" id="kobo.1761.1" xmlns:="http://www.w3.org/1999/xhtml"> is the mean value of all maximum prices observed in each invoice for a particular customer. </span><span class="koboSpan" id="kobo.1761.2" xmlns:="http://www.w3.org/1999/xhtml">That is, if a customer has six invoices, we first find the maximum price for </span><a id="_idTextAnchor1312"/><span class="koboSpan" id="kobo.1762.1" xmlns:="http://www.w3.org/1999/xhtml">each of the six invoices and then take the average of </span><span class="No-Break"><span class="koboSpan" id="kobo.1763.1" xmlns:="http://www.w3.org/1999/xhtml">those values.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1764.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.1765.1" xmlns:="http://www.w3.org/1999/xhtml">display the resulting DataFrame containing the original data and </span><span class="No-Break"><span class="koboSpan" id="kobo.1766.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1767.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix.head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1768.1" xmlns:="http://www.w3.org/1999/xhtml">In the fol</span><a id="_idTextAnchor1313"/><span class="koboSpan" id="kobo.1769.1" xmlns:="http://www.w3.org/1999/xhtml">lowing output, we see </span><em class="italic"><span class="koboSpan" id="kobo.1770.1" xmlns:="http://www.w3.org/1999/xhtml">some</span></em><span class="koboSpan" id="kobo.1771.1" xmlns:="http://www.w3.org/1999/xhtml"> of the variables in the DataFrame returned </span><span class="No-Break"><span class="koboSpan" id="kobo.1772.1" xmlns:="http://www.w3.org/1999/xhtml">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1773.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1774.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.1775.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 9.12 – DataFrame with some of the features resulting from aggregations at the customer level" src="image/B22396_09_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1776.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 9.12 – DataFrame with some of the features resulting from aggregations at the customer level</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1777.1" xmlns:="http://www.w3.org/1999/xhtml">Due to space limitations, we can’t display the entire output of </span><em class="italic"><span class="koboSpan" id="kobo.1778.1" xmlns:="http://www.w3.org/1999/xhtml">step 10</span></em><span class="koboSpan" id="kobo.1779.1" xmlns:="http://www.w3.org/1999/xhtml">, so make sure you execute it on your computer or visit our accompanying GitHub repository for more </span><span class="No-Break"><span class="koboSpan" id="kobo.1780.1" xmlns:="http://www.w3.org/1999/xhtml">details: </span></span><a href="https://github.com/PacktPublishing/Python-Feature-Engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/Recipe6-Creating-features-with-aggregation-primitives.ipynb"><span class="No-Break"><span class="koboSpan" id="kobo.1781.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/PacktPublishing/Python-Feature-Engineering-Cookbook-Third-Edition/blob/main/ch09-featuretools/Recipe6-Creating-features-with-aggregation-primitives.ipynb</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1782.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1783.1" xmlns:="http://www.w3.org/1999/xhtml">To follow up, let’s combine what we learned from the recipes using transform primitives with the aggregation</span><a id="_idTextAnchor1314"/><span class="koboSpan" id="kobo.1784.1" xmlns:="http://www.w3.org/1999/xhtml"> functions from this recipe. </span><span class="koboSpan" id="kobo.1784.2" xmlns:="http://www.w3.org/1999/xhtml">First, we will create new features from existing datetime and text variables; then, we will aggregate those features along with the numerical variables, at the </span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1" xmlns:="http://www.w3.org/1999/xhtml">customer level.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1786.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make lists with date and </span><span class="No-Break"><span class="koboSpan" id="kobo.1787.1" xmlns:="http://www.w3.org/1999/xhtml">text primitives:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1788.1" xmlns:="http://www.w3.org/1999/xhtml">
trans_primitives = ["month", "weekday", "num_words"]</span></pre></li> <li><span class="koboSpan" id="kobo.1789.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make a list with an </span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1" xmlns:="http://www.w3.org/1999/xhtml">aggregation primitive:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1791.1" xmlns:="http://www.w3.org/1999/xhtml">
agg_primitives = ["mean"]</span></pre></li> <li><span class="koboSpan" id="kobo.1792.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s now </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.1793.1" xmlns:="http://www.w3.org/1999/xhtml">automatically create features by transforming and then </span><span class="No-Break"><span class="koboSpan" id="kobo.1794.1" xmlns:="http://www.w3.org/1999/xhtml">aggregating variables:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1795.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_matrix, feature_defs = ft.dfs(
    entityset=es,
    target_dataframe_name=»customers»,
    agg_primitives=agg_primitives,
    trans_primitives=trans_primitives,
    max_depth=3,
)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1796.1" xmlns:="http://www.w3.org/1999/xhtml">The code from </span><em class="italic"><span class="koboSpan" id="kobo.1797.1" xmlns:="http://www.w3.org/1999/xhtml">step 13</span></em><span class="koboSpan" id="kobo.1798.1" xmlns:="http://www.w3.org/1999/xhtml"> triggers the creation of the features and their subsequent aggregation at the </span><span class="No-Break"><span class="koboSpan" id="kobo.1799.1" xmlns:="http://www.w3.org/1999/xhtml">customer level.</span></span></p></li> <li><span class="koboSpan" id="kobo.1800.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s display the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1801.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1802.1" xmlns:="http://www.w3.org/1999/xhtml">
feature_defs</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1803.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we see the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1" xmlns:="http://www.w3.org/1999/xhtml">created variables:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1805.1" xmlns:="http://www.w3.org/1999/xhtml">[&lt;Feature: MEAN(data.price)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1806.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(data.quantity)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1807.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MONTH(first_invoices_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1808.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: WEEKDAY(first_invoices_time)&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1809.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MEAN(data.price))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1810.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoices.MEAN(data.quantity))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1811.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(data.NUM_WORDS(description))&gt;,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1812.1" xmlns:="http://www.w3.org/1999/xhtml">&lt;Feature: MEAN(invoi</span><a id="_idTextAnchor1315"/><span class="koboSpan" id="kobo.1813.1" xmlns:="http://www.w3.org/1999/xhtml">ces.MEAN(data.NUM_</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1814.1" xmlns:="http://www.w3.org/1999/xhtml">    WORDS(description)))&gt;] WORDS(description)))&gt;]</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1815.1" xmlns:="http://www.w3.org/1999/xhtml">Note that in our recipes, we keep the creation of features to a minimum due to space limitations, but you can create as many features as you want and enr</span><a id="_idTextAnchor1316"/><a id="_idTextAnchor1317"/><span class="koboSpan" id="kobo.1816.1" xmlns:="http://www.w3.org/1999/xhtml">ich your datasets dramatically with the functionality built </span><span class="No-Break"><span class="koboSpan" id="kobo.1817.1" xmlns:="http://www.w3.org/1999/xhtml">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1818.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1819.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-274"><a id="_idTextAnchor1318"/><span class="koboSpan" id="kobo.1820.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.1821.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we brought together the creation of features using transform primitives, which we </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.1822.1" xmlns:="http://www.w3.org/1999/xhtml">discussed throughout the chapter, with the creation of features using </span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1" xmlns:="http://www.w3.org/1999/xhtml">aggregation primitives.</span></span></p>
<p><span class="koboSpan" id="kobo.1824.1" xmlns:="http://www.w3.org/1999/xhtml">To create features with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1825.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1826.1" xmlns:="http://www.w3.org/1999/xhtml"> automatically, we first need to enter the data into an entity set and establish the relationships between the data. </span><span class="koboSpan" id="kobo.1826.2" xmlns:="http://www.w3.org/1999/xhtml">We discussed how to set up an entity set in the </span><em class="italic"><span class="koboSpan" id="kobo.1827.1" xmlns:="http://www.w3.org/1999/xhtml">Setting up an entity set and creating features </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1828.1" xmlns:="http://www.w3.org/1999/xhtml">automatically</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1829.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.1830.1" xmlns:="http://www.w3.org/1999/xhtml">To aggregate existing features, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1831.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1832.1" xmlns:="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.1832.2" xmlns:="http://www.w3.org/1999/xhtml">We created a list with a string corresponding to the aggregation primitives and passed it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1833.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.1834.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1835.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1836.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1836.2" xmlns:="http://www.w3.org/1999/xhtml">To aggregate existing variables without creating new features, we passed an empty list to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1837.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong><span class="koboSpan" id="kobo.1838.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.1839.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1840.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1841.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1842.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1843.1" xmlns:="http://www.w3.org/1999/xhtml">customers</span></strong><span class="koboSpan" id="kobo.1844.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame is the child of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1845.1" xmlns:="http://www.w3.org/1999/xhtml">invoice</span></strong><span class="koboSpan" id="kobo.1846.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame, which is, in turn, the child of the original data. </span><span class="koboSpan" id="kobo.1846.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1847.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong><span class="koboSpan" id="kobo.1848.1" xmlns:="http://www.w3.org/1999/xhtml"> created aggregations from the original data and the pre-aggregated data for each invoice. </span><span class="koboSpan" id="kobo.1848.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1849.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(data.price)</span></strong><span class="koboSpan" id="kobo.1850.1" xmlns:="http://www.w3.org/1999/xhtml"> feature consists of the mean price for an item bought by a customer calculated from the entire data, whereas </span><strong class="source-inline"><span class="koboSpan" id="kobo.1851.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(invoices.MEAN(data.price))</span></strong><span class="koboSpan" id="kobo.1852.1" xmlns:="http://www.w3.org/1999/xhtml"> calculates the mean price per invoice first and then takes the mean of those values for a customer. </span><span class="koboSpan" id="kobo.1852.2" xmlns:="http://www.w3.org/1999/xhtml">Thus, if a customer has five invoices, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1853.1" xmlns:="http://www.w3.org/1999/xhtml">featuretools</span></strong><span class="koboSpan" id="kobo.1854.1" xmlns:="http://www.w3.org/1999/xhtml"> first calculates the mean price paid for each of those invoices and then takes the mean of those values. </span><span class="koboSpan" id="kobo.1854.2" xmlns:="http://www.w3.org/1999/xhtml">As such, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1855.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(data.price)</span></strong><span class="koboSpan" id="kobo.1856.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1857.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(invoices.MEAN(data.price))</span></strong><span class="koboSpan" id="kobo.1858.1" xmlns:="http://www.w3.org/1999/xhtml"> are not the </span><span class="No-Break"><span class="koboSpan" id="kobo.1859.1" xmlns:="http://www.w3.org/1999/xhtml">same feature.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1860.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1861.1" xmlns:="http://www.w3.org/1999/xhtml">An aggregate primitive aggregates information for a unique identifier. </span><span class="koboSpan" id="kobo.1861.2" xmlns:="http://www.w3.org/1999/xhtml">Aggregate primitives use mathematical operations such as the mean, standard deviation, maximum and minimum values, the sum, and the skew coefficient for numerical variables. </span><span class="koboSpan" id="kobo.1861.3" xmlns:="http://www.w3.org/1999/xhtml">For categorical variables, aggregate primitives use the mode and the count of unique items. </span><span class="koboSpan" id="kobo.1861.4" xmlns:="http://www.w3.org/1999/xhtml">For unique ident</span><a id="_idTextAnchor1319"/><span class="koboSpan" id="kobo.1862.1" xmlns:="http://www.w3.org/1999/xhtml">ifiers, aggregate primitives count the number </span><span class="No-Break"><span class="koboSpan" id="kobo.1863.1" xmlns:="http://www.w3.org/1999/xhtml">of occurrences.</span></span></p>
<p><span class="koboSpan" id="kobo.1864.1" xmlns:="http://www.w3.org/1999/xhtml">Next, we combined </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.1865.1" xmlns:="http://www.w3.org/1999/xhtml">the creation of new features from date and text variables with aggregation. </span><span class="koboSpan" id="kobo.1865.2" xmlns:="http://www.w3.org/1999/xhtml">To do this, we passed a list of strings corresponding to the transform primitives to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1866.1" xmlns:="http://www.w3.org/1999/xhtml">trans_primitives</span></strong><span class="koboSpan" id="kobo.1867.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter, and another list of strings corresponding to the aggregation primitives to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1868.1" xmlns:="http://www.w3.org/1999/xhtml">agg_primitives</span></strong><span class="koboSpan" id="kobo.1869.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.1870.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1871.1" xmlns:="http://www.w3.org/1999/xhtml">dfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1872.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1873.1" xmlns:="http://www.w3.org/1999/xhtml">One of the outputs of </span><em class="italic"><span class="koboSpan" id="kobo.1874.1" xmlns:="http://www.w3.org/1999/xhtml">step 13</span></em><span class="koboSpan" id="kobo.1875.1" xmlns:="http://www.w3.org/1999/xhtml"> is a list of the new features. </span><span class="koboSpan" id="kobo.1875.2" xmlns:="http://www.w3.org/1999/xhtml">From these, we can identify features created from the first invoice date for each customer, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1876.1" xmlns:="http://www.w3.org/1999/xhtml">MONTH(first_invoices_time)</span></strong><span class="koboSpan" id="kobo.1877.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1878.1" xmlns:="http://www.w3.org/1999/xhtml">WEEKDAY(first_invoices_time)</span></strong><span class="koboSpan" id="kobo.1879.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1879.2" xmlns:="http://www.w3.org/1999/xhtml">We can also see features that were aggregated from features created from text, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1880.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(data.NUM_WORDS(description))</span></strong><span class="koboSpan" id="kobo.1881.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1882.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(invoices.MEAN(data.NUM_WORDS(description)))</span></strong><span class="koboSpan" id="kobo.1883.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1883.2" xmlns:="http://www.w3.org/1999/xhtml">Finally, we can see the aggregations of existing n</span><a id="_idTextAnchor1320"/><a id="_idTextAnchor1321"/><a id="_idTextAnchor1322"/><span class="koboSpan" id="kobo.1884.1" xmlns:="http://www.w3.org/1999/xhtml">umerical variables, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1885.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(data.price)</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1886.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1887.1" xmlns:="http://www.w3.org/1999/xhtml">MEAN(invoices.MEAN(data.price))</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1888.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1889.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1890.1" xmlns:="http://www.w3.org/1999/xhtml">If you want to apply transform and aggregation primitives to specific variables, you can do so by specifying the primitive options as discussed </span><span class="No-Break"><span class="koboSpan" id="kobo.1891.1" xmlns:="http://www.w3.org/1999/xhtml">here: </span></span><a href="https://docs.featuretools.com/en/stable/guides/specifying_primitive_options.html"><span class="No-Break"><span class="koboSpan" id="kobo.1892.1" xmlns:="http://www.w3.org/1999/xhtml">https://docs.featuretools.com/en/stable/guides/specifying_primitive_options.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1893.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
</div>
</body></html>