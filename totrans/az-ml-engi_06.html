<html><head></head><body>
<div id="_idContainer257">
<h1 class="chapter-number" id="_idParaDest-81"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-82"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.2.1">Deploying ML Models for Real-Time Inferencing</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will look at how data scientists and ML professionals can make predictions available through a REST service hosted in Azure to support real-time predictions. </span><span class="koboSpan" id="kobo.3.2">Data is sent to a REST API, and the predicted result is provided in the response. </span><span class="koboSpan" id="kobo.3.3">This allows for a variety of applications to consume and leverage a model created with AMLS. </span><span class="koboSpan" id="kobo.3.4">We will explore a variety of options for making your models available in real time </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">with AML.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">So far, we have leveraged AMLS to handle feature engineering and built and registered models. </span><span class="koboSpan" id="kobo.5.2">In this chapter, we will focus on providing solutions that leverage your model to provide predictions on datasets in </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">real time.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">Azure Machine Learning provides several options for providing inferencing to business users to support batch and real-time inferencing </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">use cases.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Understanding real-time inferencing and </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">batch scoring</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Deploying an MLflow model with managed online endpoints through </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">AML Studio</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Deploying an MLflow model with managed online endpoints through the Python </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">SDK v2</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Deploying a model with managed online endpoints through the Python </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">SDK v2</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Deploying a model with managed online endpoints through the Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">CLI v2</span></span></li>
</ul>
<h1 id="_idParaDest-83"><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.21.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.22.1">In order to access your workspace, repeat the steps from the </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">previous chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.24.1">Go </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">to </span></span><a href="https://ml.azure.com"><span class="No-Break"><span class="koboSpan" id="kobo.26.1">https://ml.azure.com</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.27.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.28.1">Select your </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">workspace name.</span></span></li>
<li><span class="koboSpan" id="kobo.30.1">On the workspace user interface on the left-hand side, </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.32.1">Compute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.34.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.35.1">Compute</span></strong><span class="koboSpan" id="kobo.36.1"> screen, select your compute instance and </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.38.1">Start</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer220">
<span class="koboSpan" id="kobo.40.1"><img alt="Figure 6.1 – Start compute" src="image/B18003_06_001.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.41.1">Figure 6.1 – Start compute</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.42.1">Your compute instance will change from </span><strong class="bold"><span class="koboSpan" id="kobo.43.1">Stopped</span></strong><span class="koboSpan" id="kobo.44.1"> to </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.45.1">Starting</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.46.1"> status.</span></span></li>
<li><span class="koboSpan" id="kobo.47.1">In the previous chapter, we cloned the Git repository; if you have not already done so, continue to follow these steps. </span><span class="koboSpan" id="kobo.47.2">If you have already cloned the repository, skip to </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.48.1">step 9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.50.1">Open the terminal on your compute instance. </span><span class="koboSpan" id="kobo.50.2">Note the path will include your user in the directory. </span><span class="koboSpan" id="kobo.50.3">Type the following into the terminal to clone the sample notebooks into your </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">working directory:</span></span><pre class="console"><span class="koboSpan" id="kobo.52.1">
git clone </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">https://github.com/PacktPublishing/Azure-Machine-Learning-Engineering.git</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.54.1">Clicking on the refresh icon shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.55.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.56.1">.2</span></em><span class="koboSpan" id="kobo.57.1"> will update and refresh the notebooks displayed on </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">your screen.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer221">
<span class="koboSpan" id="kobo.59.1"><img alt="Figure 6.2 – The refresh icon" src="image/B18003_06_002.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.60.1">Figure 6.2 – The refresh icon</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.61.1">Review the notebooks in your </span><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">Azure-Machine-Learning-Engineering</span></strong><span class="koboSpan" id="kobo.63.1"> directory. </span><span class="koboSpan" id="kobo.63.2">This will display the files cloned into your working directory, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.64.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.65.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer222">
<span class="koboSpan" id="kobo.67.1"><img alt="Figure 6.3 – Azure-Machine-Learning-Engineering" src="image/B18003_06_003.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.68.1">Figure 6.3 – Azure-Machine-Learning-Engineering</span></p>
<h1 id="_idParaDest-84"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.69.1">Understanding real-time inferencing and batch scoring</span></h1>
<p><span class="koboSpan" id="kobo.70.1">Models can be deployed to support different use cases and different business requirements. </span><span class="koboSpan" id="kobo.70.2">When deploying a model in production, how you choose to deploy your model should be based on your user requirements. </span><span class="koboSpan" id="kobo.70.3">If you need to have a prediction available in real time to support streaming or interaction with your prediction in other applications, then real-time inferencing</span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.71.1"> will be required. </span><span class="koboSpan" id="kobo.71.2">Real-time inferencing requires compute resources to be active and available for your model to provide a response. </span><span class="koboSpan" id="kobo.71.3">If your application requires less responsive predictions that are stored in a file or perhaps a database, then batch inferencing</span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.72.1"> would be the correct selection. </span><span class="koboSpan" id="kobo.72.2">Batch inferencing allows you to spin up and down </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">compute resources.</span></span></p>
<p><span class="koboSpan" id="kobo.74.1">Before model deployment, the compute for hosting a real-time web service will need to be selected. </span><span class="koboSpan" id="kobo.74.2">For real-time inferencing, </span><strong class="bold"><span class="koboSpan" id="kobo.75.1">Azure Kubernetes Service</span></strong><span class="koboSpan" id="kobo.76.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.77.1">AKS</span></strong><span class="koboSpan" id="kobo.78.1">), </span><strong class="bold"><span class="koboSpan" id="kobo.79.1">Azure Container Instances</span></strong><span class="koboSpan" id="kobo.80.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.81.1">ACI</span></strong><span class="koboSpan" id="kobo.82.1">), and </span><a id="_idIndexMarker397"/><strong class="bold"><span class="koboSpan" id="kobo.83.1">Azure</span></strong><strong class="bold"><a id="_idIndexMarker398"/></strong><strong class="bold"><span class="koboSpan" id="kobo.84.1"> Arc-enabled</span></strong><strong class="bold"><span class="koboSpan" id="kobo.85.1"> Kubernetes</span></strong><span class="koboSpan" id="kobo.86.1"> are compute resources supported through your AML workspace. </span><span class="koboSpan" id="kobo.86.2">AKS is </span><a id="_idIndexMarker399"/><span class="koboSpan" id="kobo.87.1">typically used to support production workloads, and ACI is typically leveraged to support lower environments with CPU-based workloads. </span><span class="koboSpan" id="kobo.87.2">Azure Arc-enabled Kubernetes is typically used to run inferencing with on-premises resources where clusters are managed in Azure Arc. </span><span class="koboSpan" id="kobo.87.3">In this chapter, we will also explore the option of leveraging a </span><strong class="bold"><span class="koboSpan" id="kobo.88.1">managed online endpoint</span></strong><span class="koboSpan" id="kobo.89.1">, which </span><a id="_idIndexMarker400"/><span class="koboSpan" id="kobo.90.1">will provide a level of abstraction over the compute resources required for </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">model deployment.</span></span></p>
<p><span class="koboSpan" id="kobo.92.1">Note that there are actually two different types of compute that can be leveraged for an online endpoint. </span><span class="koboSpan" id="kobo.92.2">One type is the aforementioned managed online endpoints, and the other is </span><strong class="bold"><span class="koboSpan" id="kobo.93.1">Kubernetes online endpoints</span></strong><span class="koboSpan" id="kobo.94.1">. </span><span class="koboSpan" id="kobo.94.2">Managed </span><a id="_idIndexMarker401"/><span class="koboSpan" id="kobo.95.1">online endpoints provide fully managed compute provisioning, scaling, and also host OS image updates. </span><span class="koboSpan" id="kobo.95.2">Kubernetes online endpoints are designed for teams that want to manage those items through their own Azure Kubernetes cluster. </span><span class="koboSpan" id="kobo.95.3">Managed online endpoints automate the provisioning of the compute, automatically update the host OS image, and provide automatic recovery in the event of a system failure. </span><span class="koboSpan" id="kobo.95.4">Due to these advantages, we will focus our efforts on managed </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">online endpoints.</span></span></p>
<p><span class="koboSpan" id="kobo.97.1">Managed online endpoints </span><a id="_idIndexMarker402"/><span class="koboSpan" id="kobo.98.1">not only provide a level of abstraction around the compute resources required to deploy a REST endpoint; they also support multiple deployments to a single endpoint, often referred </span><a id="_idIndexMarker403"/><span class="koboSpan" id="kobo.99.1">to as </span><strong class="bold"><span class="koboSpan" id="kobo.100.1">blue/green deployment</span></strong><span class="koboSpan" id="kobo.101.1">. </span><span class="koboSpan" id="kobo.101.2">Blue/green deployment is the practice of moving traffic from one release to another. </span><span class="koboSpan" id="kobo.101.3">So, when we deploy a managed online endpoint, we can have an initial model that is deployed and then deploy a new model to the same endpoint. </span><span class="koboSpan" id="kobo.101.4">After the new model is available on the managed online endpoint, we can move users to the new deployment with the new model. </span><span class="koboSpan" id="kobo.101.5">This means for each managed online endpoint, we will not only be deploying the managed online endpoint but also the </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">endpoint deployments.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.103.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.104.1">Managed online endpoints are required to have a unique name within an Azure region. </span><span class="koboSpan" id="kobo.104.2">Not providing a unique name will result in a </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">failed deployment.</span></span></p>
<p><span class="koboSpan" id="kobo.106.1">We will be exploring options to make your model available to support real-time use cases leveraging managed online endpoints and deployments in this chapter. </span><span class="koboSpan" id="kobo.106.2">In the next section, we will explore deploying your model with AMLS Studio for a </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">low-code experience.</span></span></p>
<h1 id="_idParaDest-85"><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.108.1">Deploying an MLflow model with managed online endpoints through AML Studio</span></h1>
<p><span class="koboSpan" id="kobo.109.1">In order to</span><a id="_idIndexMarker404"/><span class="koboSpan" id="kobo.110.1"> deploy a model to a web service, we will be required to define the environment, which</span><a id="_idIndexMarker405"/><span class="koboSpan" id="kobo.111.1"> includes the Conda and </span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">pip</span></strong><span class="koboSpan" id="kobo.113.1"> dependencies, our compute resources, and a </span><a id="_idIndexMarker406"/><span class="koboSpan" id="kobo.114.1">scoring script. </span><span class="koboSpan" id="kobo.114.2">The </span><strong class="bold"><span class="koboSpan" id="kobo.115.1">scoring script</span></strong><span class="koboSpan" id="kobo.116.1">, also called an </span><strong class="bold"><span class="koboSpan" id="kobo.117.1">entry script</span></strong><span class="koboSpan" id="kobo.118.1">, will load</span><a id="_idIndexMarker407"/><span class="koboSpan" id="kobo.119.1"> the model in an initialization function, as well as handle running predictions with the incoming data to the web service. </span></p>
<p><span class="koboSpan" id="kobo.120.1">With MLflow models, not only is the model packaged but AML also understands how to consume the model, so there is no need to configure an environment or entry script for the model deployment with managed online endpoints; AML understands these models natively. </span><span class="koboSpan" id="kobo.120.2">This makes deploying the model very easy from the UI and </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">through code.</span></span></p>
<p><span class="koboSpan" id="kobo.122.1">In previous chapters, we leveraged MLflow to create and register models. </span><span class="koboSpan" id="kobo.122.2">Proceed to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">Chapter 6</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.124.1">, Prep-Model Creation &amp; Registration.ipynb</span></strong><span class="koboSpan" id="kobo.125.1"> notebook to create and register a model to leverage MLflow, as we did in </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">previous chapters.</span></span></p>
<p><span class="koboSpan" id="kobo.127.1">This notebook will take you through the process of creating a model and registering it to the workspace, as discussed in previous chapters. </span><span class="koboSpan" id="kobo.127.2">However, there are a few points to review before creating </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">the model.</span></span></p>
<p><span class="koboSpan" id="kobo.129.1">When leveraging MLflow, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">autolog</span></strong><span class="koboSpan" id="kobo.131.1"> to generate the model and environment information for us, but in the notebook, we actually set </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">log_models=False</span></strong><span class="koboSpan" id="kobo.133.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer223">
<span class="koboSpan" id="kobo.135.1"><img alt="Figure 6.4 – Disable the logging of the model" src="image/B18003_06_004.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.136.1">Figure 6.4 – Disable the logging of the model</span></p>
<p><span class="koboSpan" id="kobo.137.1">We set</span><a id="_idIndexMarker408"/><span class="koboSpan" id="kobo.138.1"> logging the model to </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">false</span></strong><span class="koboSpan" id="kobo.140.1">, but in the training script, we explicitly package up the model and log it, as </span><a id="_idIndexMarker409"/><span class="No-Break"><span class="koboSpan" id="kobo.141.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer224">
<span class="koboSpan" id="kobo.142.1"><img alt="Figure 6.5 – MLflow modeling logging" src="image/B18003_06_005.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.143.1">Figure 6.5 – MLflow modeling logging</span></p>
<p><span class="koboSpan" id="kobo.144.1">This provides us with control over the packages used for deployment. </span><span class="koboSpan" id="kobo.144.2">When MLflow releases a new version, there may be issues between the latest version of MLflow and Azure Machine Learning managed online endpoints. </span><span class="koboSpan" id="kobo.144.3">Ideally, this will not happen; however, as open source continues to progress, it is a good practice to include versions when packaging up your model to ensure you are in total control of the </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">model deployment.</span></span></p>
<p><span class="koboSpan" id="kobo.146.1">After you run your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">Chapter 6</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1"> Model Creation Prep &amp; Registration.ipynb</span></strong><span class="koboSpan" id="kobo.149.1"> notebook, the model will be registered in the workspace. </span><span class="koboSpan" id="kobo.149.2">Once we have an MLflow model registered to the workspace, we can leverage AMLS Studio to deploy the model. </span><span class="koboSpan" id="kobo.149.3">For this process, proceed with the </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">following steps:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.151.1">Select the model from </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.152.1">Model List</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer225">
<span class="koboSpan" id="kobo.154.1"><img alt="Figure 6.6 – Select the model from Model List" src="image/B18003_06_006.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.155.1">Figure 6.6 – Select the model from Model List</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.156.1">After </span><a id="_idIndexMarker410"/><span class="koboSpan" id="kobo.157.1">clicking on</span><a id="_idIndexMarker411"/><span class="koboSpan" id="kobo.158.1"> an MLflow model, select the </span><strong class="bold"><span class="koboSpan" id="kobo.159.1">Deploy</span></strong><span class="koboSpan" id="kobo.160.1"> option and then the first option, </span><strong class="bold"><span class="koboSpan" id="kobo.161.1">Deploy to real-time endpoint</span></strong><span class="koboSpan" id="kobo.162.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">following figure.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer226">
<span class="koboSpan" id="kobo.164.1"><img alt="Figure 6.7 – Deploy an MLflow model" src="image/B18003_06_007.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.165.1">Figure 6.7 – Deploy an MLflow model</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.166.1">Since the model is selected and was created with MLflow, AMLS Studio understands this is an MLflow model. </span><span class="koboSpan" id="kobo.166.2">After clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.167.1">Deploy to real-time endpoint</span></strong><span class="koboSpan" id="kobo.168.1"> option, you will be guided through creating a deployment for </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">your model.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer227">
<span class="koboSpan" id="kobo.170.1"><img alt="Figure 6.8 – Configure an endpoint" src="image/B18003_06_008.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.171.1">Figure 6.8 – Configure an endpoint</span></p>
<p><span class="koboSpan" id="kobo.172.1">To create a </span><a id="_idIndexMarker412"/><span class="koboSpan" id="kobo.173.1">deployment for </span><a id="_idIndexMarker413"/><span class="koboSpan" id="kobo.174.1">your model, follow the options in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.175.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.176.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.177.1">:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.178.1">For </span><strong class="bold"><span class="koboSpan" id="kobo.179.1">Endpoint name</span></strong><span class="koboSpan" id="kobo.180.1">, enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">azure-ui-endpoint</span></strong><span class="koboSpan" id="kobo.182.1">, adding a prefix or suffix to the name to make it unique in </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">your region.</span></span></li>
<li><span class="koboSpan" id="kobo.184.1">For </span><strong class="bold"><span class="koboSpan" id="kobo.185.1">Description</span></strong><span class="koboSpan" id="kobo.186.1">, enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">UI </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">created endpoint</span></strong></span></li>
<li><span class="koboSpan" id="kobo.189.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.190.1">Managed</span></strong><span class="koboSpan" id="kobo.191.1"> for </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.192.1">Compute type</span></strong></span></li>
<li><span class="koboSpan" id="kobo.193.1">Select </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.194.1">Key-based authentication</span></strong></span></li>
</ul>
<ol>
<li value="4"><span class="koboSpan" id="kobo.195.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.196.1">Next</span></strong><span class="koboSpan" id="kobo.197.1"> and review the selected model, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">following figure:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer228">
<span class="koboSpan" id="kobo.199.1"><img alt="Figure 6.9 – Model selection" src="image/B18003_06_009.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.200.1">Figure 6.9 – Model selection</span></p>
<p><span class="koboSpan" id="kobo.201.1">Since you started the deployment by selecting the model, there is no additional selection that needs to occur. </span><span class="koboSpan" id="kobo.201.2">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.202.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.203.1">.9</span></em><span class="koboSpan" id="kobo.204.1">, you have configured the endpoint as well as the model </span><a id="_idIndexMarker414"/><span class="koboSpan" id="kobo.205.1">selection, so the next step is to move on to </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">deployment </span></span><span class="No-Break"><a id="_idIndexMarker415"/></span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">configuration.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.208.1">By clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.209.1">Next</span></strong><span class="koboSpan" id="kobo.210.1"> icon on the </span><strong class="bold"><span class="koboSpan" id="kobo.211.1">Model</span></strong><span class="koboSpan" id="kobo.212.1"> screen, you are brought to a screen to configure </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">the deployment:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer229">
<span class="koboSpan" id="kobo.214.1"><img alt="Figure 6.10 – Configure deployment" src="image/B18003_06_010.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.215.1">Figure 6.10 – Configure deployment</span></p>
<p><span class="koboSpan" id="kobo.216.1">As part of the</span><a id="_idIndexMarker416"/><span class="koboSpan" id="kobo.217.1"> deployment </span><a id="_idIndexMarker417"/><span class="koboSpan" id="kobo.218.1">configuration, a deployment name is provided. </span><span class="koboSpan" id="kobo.218.2">For a given endpoint, as mentioned in the </span><em class="italic"><span class="koboSpan" id="kobo.219.1">Understanding Real-Time Inferencing and Batch Scoring</span></em><span class="koboSpan" id="kobo.220.1"> section, multiple deployments can be created. </span><span class="koboSpan" id="kobo.220.2">This allows you to configure the traffic pattern to test out a </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">deployed model.</span></span></p>
<p><span class="koboSpan" id="kobo.222.1">In addition to the deployment name, you can configure the scoring timeout. </span><span class="koboSpan" id="kobo.222.2">This is the timeout to enforce scoring calls. </span><span class="koboSpan" id="kobo.222.3">You can also enable application insights diagnostics and data collection for the deployment. </span><span class="koboSpan" id="kobo.222.4">This will enable you to use the </span><strong class="bold"><span class="koboSpan" id="kobo.223.1">Monitoring</span></strong><span class="koboSpan" id="kobo.224.1"> tab to view activity for the managed </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">online endpoint.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.226.1">Once the deployment has been configured, you will be brought to the environment selection tab by again clicking </span><strong class="bold"><span class="koboSpan" id="kobo.227.1">Next</span></strong><span class="koboSpan" id="kobo.228.1">. </span><span class="koboSpan" id="kobo.228.2">Given this model was created with MLflow, no environment selection </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">is required.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.230.1">The environment was already created for the model, as </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer230">
<span class="koboSpan" id="kobo.232.1"><img alt="Figure 6.11 – Environment selection" src="image/B18003_06_011.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.233.1">Figure 6.11 – Environment selection</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.234.1">Now that the </span><a id="_idIndexMarker418"/><span class="koboSpan" id="kobo.235.1">environment </span><a id="_idIndexMarker419"/><span class="koboSpan" id="kobo.236.1">has been established, the compute resources should be selected for the model. </span><span class="koboSpan" id="kobo.236.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.237.1">Virtual machine size</span></strong><span class="koboSpan" id="kobo.238.1"> dropdown, select </span><strong class="bold"><span class="koboSpan" id="kobo.239.1">Standard_DS3_v2</span></strong><span class="koboSpan" id="kobo.240.1">, and under </span><strong class="bold"><span class="koboSpan" id="kobo.241.1">Instance count</span></strong><span class="koboSpan" id="kobo.242.1">, enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">1</span></strong><span class="koboSpan" id="kobo.244.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">following figure:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer231">
<span class="koboSpan" id="kobo.246.1"><img alt="Figure 6.12 – Compute selection" src="image/B18003_06_012.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.247.1">Figure 6.12 – Compute selection</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.248.1">Now that the </span><a id="_idIndexMarker420"/><span class="koboSpan" id="kobo.249.1">compute has been selected, the traffic allocation for this deployment should be configured. </span><span class="koboSpan" id="kobo.249.2">If you have updated your model, deploy it initially with traffic set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">0</span></strong><span class="koboSpan" id="kobo.251.1">, confirm it is </span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.252.1">working correctly, and then, as shown in the following figure, update the traffic to </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">100</span></strong><span class="koboSpan" id="kobo.254.1">% on the new model, given this is our first model deployment. </span><span class="koboSpan" id="kobo.254.2">This should provide a seamless experience for consumers of the REST API from the old model to the </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">new model.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer232">
<span class="koboSpan" id="kobo.256.1"><img alt="Figure 6.13 – Configure deployment traffic" src="image/B18003_06_013.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.257.1">Figure 6.13 – Configure deployment traffic</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.258.1">After configuring</span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.259.1"> the traffic, we can review the deployment that is about to occur. </span><span class="koboSpan" id="kobo.259.2">By </span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.260.1">clicking </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">Next</span></strong><span class="koboSpan" id="kobo.262.1">, AMLS Studio will bring you to the </span><strong class="bold"><span class="koboSpan" id="kobo.263.1">Review</span></strong><span class="koboSpan" id="kobo.264.1"> stage of the guided </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">model deployment.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer233">
<span class="koboSpan" id="kobo.266.1"><img alt="Figure 6.14 – Review the model deployment" src="image/B18003_06_014.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.267.1">Figure 6.14 – Review the model deployment</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.268.1">The information </span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.269.1">shown on the screen will reflect the input you provided during the guided online managed</span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.270.1"> deployment. </span><span class="koboSpan" id="kobo.270.2">After you have confirmed the settings displayed in the previous screenshot, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.271.1">Create</span></strong><span class="koboSpan" id="kobo.272.1"> button to create the endpoint as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">the deployment.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.274.1">The following figure shows the deployment progress. </span><span class="koboSpan" id="kobo.274.2">The managed online endpoint is being provisioned, given that the status of </span><strong class="bold"><span class="koboSpan" id="kobo.275.1">Provisioning state</span></strong><span class="koboSpan" id="kobo.276.1"> is </span><strong class="bold"><span class="koboSpan" id="kobo.277.1">Creating</span></strong><span class="koboSpan" id="kobo.278.1">, and the blue deployment is being provisioned as well. </span><span class="koboSpan" id="kobo.278.2">Currently, the traffic is set to </span><strong class="bold"><span class="koboSpan" id="kobo.279.1">0</span></strong><span class="koboSpan" id="kobo.280.1"> for the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.281.1">blue</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.282.1"> deployment.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer234">
<span class="koboSpan" id="kobo.283.1"><img alt="Figure 6.15 – Managed online endpoint deployment in progress" src="image/B18003_06_015.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.284.1">Figure 6.15 – Managed online endpoint deployment in progress</span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.285.1">Once the </span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.286.1">deployment has</span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.287.1"> been completed, the endpoint will show that the status of </span><strong class="bold"><span class="koboSpan" id="kobo.288.1">Provisioning state</span></strong><span class="koboSpan" id="kobo.289.1"> is </span><strong class="bold"><span class="koboSpan" id="kobo.290.1">Succeeded</span></strong><span class="koboSpan" id="kobo.291.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.292.1">Traffic allocation</span></strong><span class="koboSpan" id="kobo.293.1"> will be </span><strong class="bold"><span class="koboSpan" id="kobo.294.1">100%</span></strong><span class="koboSpan" id="kobo.295.1"> of the deployment, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">following figure.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer235">
<span class="koboSpan" id="kobo.297.1"><img alt="Figure 6.16 – AMLS Studio deployment completed" src="image/B18003_06_016.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.298.1">Figure 6.16 – AMLS Studio deployment completed</span></p>
<p><span class="koboSpan" id="kobo.299.1">Congratulations! </span><span class="koboSpan" id="kobo.299.2">You </span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.300.1">have successfully deployed a managed online endpoint for </span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.301.1">consumption. </span><span class="koboSpan" id="kobo.301.2">Recall that the model has columns – </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">Embarked</span></strong><span class="koboSpan" id="kobo.303.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">Loc</span></strong><span class="koboSpan" id="kobo.305.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">Sex</span></strong><span class="koboSpan" id="kobo.307.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">Pclass</span></strong><span class="koboSpan" id="kobo.309.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">Age</span></strong><span class="koboSpan" id="kobo.311.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">Fare</span></strong><span class="koboSpan" id="kobo.313.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">GroupSize</span></strong><span class="koboSpan" id="kobo.315.1"> – as input parameters. </span><span class="koboSpan" id="kobo.315.2">We can send JSON to the REST endpoint, specifying the input data columns and the data we would like to receive predictions to leverage the JSON schema leveraged </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">by AMLS.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer236">
<span class="koboSpan" id="kobo.317.1"><img alt="Figure 6.17 – Test the managed online endpoint" src="image/B18003_06_017.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.318.1">Figure 6.17 – Test the managed online endpoint</span></p>
<p><span class="koboSpan" id="kobo.319.1">A sample of this request file is located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">prepped_data</span></strong><span class="koboSpan" id="kobo.321.1"> folder under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">chapter 6</span></strong><span class="koboSpan" id="kobo.323.1"> folder in the Git repository. </span><span class="koboSpan" id="kobo.323.2">You can copy and paste this text into the studio test screen </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.324.1">shown </span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.325.1">in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.326.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.327.1">.17</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.329.1">Now that the managed online endpoint has been tested from the AMLS Studio experience, we will next deploy a managed online endpoint through the </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">Python SDK.</span></span></p>
<h1 id="_idParaDest-86"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.331.1">Deploying an MLflow model with managed online endpoints through the Python SDK V2</span></h1>
<p><span class="koboSpan" id="kobo.332.1">In the </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.333.1">previous section, we</span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.334.1"> leveraged AMLS Studio to deploy our MLflow model. </span><span class="koboSpan" id="kobo.334.2">In this section, we will explore code to deploy an MLflow model to a managed online endpoint through the </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">SDK v2.</span></span></p>
<p><span class="koboSpan" id="kobo.336.1">In order to leverage the SDK v2 for model deployment, we will leverage the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">Chapter 6</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1"> MLFlow Model Deployment SDK V2.ipynb </span></strong><span class="koboSpan" id="kobo.339.1">notebook. </span></p>
<p><span class="koboSpan" id="kobo.340.1">To deploy a managed online endpoint through the SDK V2, follow the next steps: </span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.341.1">To </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.342.1">deploy the </span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.343.1">model, we will create </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">ManagedOnlineEndpoint</span></strong><span class="koboSpan" id="kobo.345.1"> with the appropriate configuration. </span><span class="koboSpan" id="kobo.345.2">In the case of an MLflow model, we will need to specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">name</span></strong><span class="koboSpan" id="kobo.347.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">auth_mode</span></strong><span class="koboSpan" id="kobo.349.1">. </span><span class="koboSpan" id="kobo.349.2">In addition, we will provide </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">description</span></strong><span class="koboSpan" id="kobo.351.1"> as well </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">tags</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer237">
<span class="koboSpan" id="kobo.355.1"><img alt="Figure 6.18 – Configure ManagedOnlineEndpoint" src="image/B18003_06_018.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.356.1">Figure 6.18 – Configure ManagedOnlineEndpoint</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.357.1">After the endpoint has been configured, we are able to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">create</span></strong><span class="koboSpan" id="kobo.359.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">update</span></strong><span class="koboSpan" id="kobo.361.1"> method, passing in the endpoint to create the endpoint in the workspace with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">create_or_update</span></strong><span class="koboSpan" id="kobo.363.1"> command, as </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">shown here.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer238">
<span class="koboSpan" id="kobo.365.1"><img alt="Figure 6.19 – Leveraging ml_client to create a managed online endpoint" src="image/B18003_06_019.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.366.1">Figure 6.19 – Leveraging ml_client to create a managed online endpoint</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.367.1">Once the endpoint has been created, you are ready to create a deployment. </span><span class="koboSpan" id="kobo.367.2">For the deployment, we will pass a name, the endpoint name, which was created in the previous figure, the model to deploy, the instance type of the VM to leverage for compute resources, as well as the </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">instance count.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.369.1">The model can be retrieved directly from the workspace by its name and version, as </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer239">
<span class="koboSpan" id="kobo.371.1"><img alt="Figure 6.20 – Getting the model from the registry based on name and version" src="image/B18003_06_020.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.372.1">Figure 6.20 – Getting the model from the registry based on name and version</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.373.1">The model is required for the managed online deployment. </span><span class="koboSpan" id="kobo.373.2">Now that the model has been retrieved from the workspace, it can be passed into </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">ManagedOnlineDeployment</span></strong><span class="koboSpan" id="kobo.375.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">shown here:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer240">
<span class="koboSpan" id="kobo.377.1"><img alt="Figure 6.21 – Configure deployment" src="image/B18003_06_021.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.378.1">Figure 6.21 – Configure deployment</span></p>
<p><span class="koboSpan" id="kobo.379.1">Note </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">instance_type</span></strong><span class="koboSpan" id="kobo.381.1">, which is the compute being leveraged by our managed</span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.382.1"> online </span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.383.1">endpoint. </span><span class="koboSpan" id="kobo.383.2">We specified here the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">Standard_F4s_v2</span></strong><span class="koboSpan" id="kobo.385.1">, as we have great flexi</span><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.386.1">bility i</span><a id="_idTextAnchor093"/><a id="_idTextAnchor094"/><span class="koboSpan" id="kobo.387.1">n the type of compute resources we can use to serve up our real-time </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">prediction requests.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.389.1">Once the deployment has been configured, leveraging </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">ml_client</span></strong><span class="koboSpan" id="kobo.391.1">, the managed online endpoint can be deployed with initial traffic set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">0</span></strong><span class="koboSpan" id="kobo.393.1"> through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">begin_create_or_update</span></strong><span class="koboSpan" id="kobo.395.1"> method, as </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">shown here:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer241">
<span class="koboSpan" id="kobo.397.1"><img alt="Figure 6.22 – Create a deployment" src="image/B18003_06_022.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.398.1">Figure 6.22 – Create a deployment</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.399.1">After the deployment has succeeded, the traffic for the endpoint can be set to 100% using the </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">deployment name.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer242">
<span class="koboSpan" id="kobo.401.1"><img alt="Figure 6.23 – Update deployment traffic" src="image/B18003_06_023.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.402.1">Figure 6.23 – Update deployment traffic</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.403.1">Now</span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.404.1"> that the</span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.405.1"> endpoint has been deployed, the URI for the endpoint and the primary key can be retrieved to make a REST API call to retrieve a prediction. </span><span class="koboSpan" id="kobo.405.2">For the online endpoint, we can easily retrieve both the scoring URI as well as the primary key, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">following code.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer243">
<span class="koboSpan" id="kobo.407.1"><img alt="Figure 6.24 – Retrieve the URI and primary key" src="image/B18003_06_024.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.408.1">Figure 6.24 – Retrieve the URI and primary key</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.409.1">Finally, a call can be made to the REST endpoint to retrieve predictions. </span><span class="koboSpan" id="kobo.409.2">The following code below takes a dataframe into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">make_predictions</span></strong><span class="koboSpan" id="kobo.411.1"> function, prepares the request, and returns the results from the managed </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">online endpoint.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer244">
<span class="koboSpan" id="kobo.413.1"><img alt="Figure 6.25 – Making predictions" src="image/B18003_06_025.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.414.1">Figure 6.25 – Making predictions</span></p>
<p><span class="koboSpan" id="kobo.415.1">Running the preceding code allows a dataframe to be passed and prediction results to be returned. </span><span class="koboSpan" id="kobo.415.2">This model can be tested to leverage the sample input provided in the file located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">prepped_data</span></strong><span class="koboSpan" id="kobo.417.1"> folder under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">chapter 6</span></strong><span class="koboSpan" id="kobo.419.1"> folder in the Git repository. </span><span class="koboSpan" id="kobo.419.2">Regardless of whether the managed online endpoint was deployed through the SDK or AMLS Studio, the functionality is </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">the same.</span></span></p>
<p><span class="koboSpan" id="kobo.421.1">You have </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.422.1">been able to deploy a </span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.423.1">model through AMLS Studio and the SDK, as it was created as an MLflow model. </span><span class="koboSpan" id="kobo.423.2">In the event that MLflow is not leveraged to create a model, one can easily be deployed, but additional configuration is required to deploy it. </span><span class="koboSpan" id="kobo.423.3">In the next section, we will continue to deploy a model, specifying the environment and the script required </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">for inferencing.</span></span></p>
<h1 id="_idParaDest-87"><a id="_idTextAnchor095"/><span class="koboSpan" id="kobo.425.1">Deploying a model with managed online endpoints through the Python SDK v2</span></h1>
<p><span class="koboSpan" id="kobo.426.1">In the previous section, we </span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.427.1">deployed an </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.428.1">MLflow model, but when you create a model that does not leverage MLflow, you need to provide two additional details for a successful managed online endpoint deployment. </span><span class="koboSpan" id="kobo.428.2">In this section, we will focus on adding functionality so that we can deploy our model without relying on MLflow to provide the environment and </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">scoring script.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1">In order to deploy a managed online endpoint leveraging the SDK v2 and not relying on MLflow to provide the environment and scoring script, we will create those in this section as you leverage the notebook: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">Chapter 6</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1"> Model Deployment </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">SDK V2.ipynb</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.435.1">Our first step is to create our </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">score.py</span></strong><span class="koboSpan" id="kobo.437.1"> file. </span><span class="koboSpan" id="kobo.437.2">This is the file that will be used to load the model and serve a request to </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">the endpoint.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.439.1">The following code snippet provides the information required for the </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">entry script:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer245">
<span class="koboSpan" id="kobo.441.1"><img alt="Figure 6.26 – The score.py script" src="image/B18003_06_026.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.442.1">Figure 6.26 – The score.py script</span></p>
<p><span class="koboSpan" id="kobo.443.1">In the</span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.444.1"> score script shown </span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.445.1">in the previous figure, there are two required functions, </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">init</span></strong><span class="koboSpan" id="kobo.447.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">run</span></strong><span class="koboSpan" id="kobo.449.1">. </span><span class="koboSpan" id="kobo.449.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">init</span></strong><span class="koboSpan" id="kobo.451.1"> function tells AML how to load a model. </span><span class="koboSpan" id="kobo.451.2">The model will be provided as part of the deployment configuration, the model path is set, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">joblib</span></strong><span class="koboSpan" id="kobo.453.1"> is leveraged to load the model. </span><span class="koboSpan" id="kobo.453.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">model</span></strong><span class="koboSpan" id="kobo.455.1"> global variable is leveraged to hold the model. </span><span class="koboSpan" id="kobo.455.2">When the REST endpoint is called, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">run</span></strong><span class="koboSpan" id="kobo.457.1"> function will be called. </span><span class="koboSpan" id="kobo.457.2">The data from the API call will be passed into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">run</span></strong><span class="koboSpan" id="kobo.459.1"> function. </span><span class="koboSpan" id="kobo.459.2">Here, a dictionary is set to retrieve the information, which is transformed into a dataframe that is then passed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">model.predict</span></strong><span class="koboSpan" id="kobo.461.1"> function. </span><span class="koboSpan" id="kobo.461.2">The results of </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">model.predict</span></strong><span class="koboSpan" id="kobo.463.1"> are passed to a list and returned from </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">the function.</span></span></p>
<p><span class="koboSpan" id="kobo.465.1">In addition to the score script, we will need to have the model. </span><span class="koboSpan" id="kobo.465.2">In the previous section, we retrieved the registered model leveraging the SDK v2 based on its name and version, but we can also search across the experiments and retrieve the model from them. </span><span class="koboSpan" id="kobo.465.3">The sample code provided here shows searching for the model from the experiment and </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">downloading it.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer246">
<span class="koboSpan" id="kobo.467.1"><img alt="Figure 6.27 – Find and download the model" src="image/B18003_06_027.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.468.1">Figure 6.27 – Find and download the model</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.469.1">In </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.470.1">addition to the scoring</span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.471.1"> script, we will need to provide an environment to use </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">for deployment.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer247">
<span class="koboSpan" id="kobo.473.1"><img alt="Figure 6.28 – A deployment environment" src="image/B18003_06_028.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.474.1">Figure 6.28 – A deployment environment</span></p>
<p><span class="koboSpan" id="kobo.475.1">In the </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.476.1">previous Jupyter </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.477.1">notebook when we created the mo</span><a id="_idTextAnchor096"/><span class="koboSpan" id="kobo.478.1">del, we already created an environment, but we need to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">azureml-defaults</span></strong><span class="koboSpan" id="kobo.480.1"> package for successful deployment to a managed online endpoint. </span><span class="koboSpan" id="kobo.480.2">Therefore, instead of using the already registered environment, we are creating a new environment to pass to </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">the deployment.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.482.1">In order to deploy a managed online endpoint that was not created with MLflow, the key difference is in the deployment configuration. </span><span class="koboSpan" id="kobo.482.2">Note that </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.483.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.484.1">.21</span></em><span class="koboSpan" id="kobo.485.1"> provided the code snippet required to deploy a model created with MLflow. </span><span class="koboSpan" id="kobo.485.2">Compare that code to the code found in the </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">following snippet:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer248">
<span class="koboSpan" id="kobo.487.1"><img alt="Figure 6.29 – Managed online endpoint deployment with score script and environment" src="image/B18003_06_029.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.488.1">Figure 6.29 – Managed online endpoint deployment with score script and environment</span></p>
<p><span class="koboSpan" id="kobo.489.1">Note that </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.490.1">in the previous </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.491.1">code block, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">score.py</span></strong><span class="koboSpan" id="kobo.493.1"> file is specified as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">the environment.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.495.1">This managed online endpoint can again be tested. </span><span class="koboSpan" id="kobo.495.2">As the </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">score.py</span></strong><span class="koboSpan" id="kobo.497.1"> file highlighted, this REST API will be expecting a different schema for </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">its input:</span></span><pre class="console"><span class="koboSpan" id="kobo.499.1">
{"raw_data": [{"Pclass":3,"Sex":"male","Age":22.0,"Fare":7.25,"Embarked":"S","Loc":"X","GroupSize":2},{"Pclass":1,"Sex":"female","Age":38.0,"Fare":71.2833,"Embarked":"C","Loc":"C","GroupSize":2},{"Pclass":3,"Sex":"female","Age":26.0,"Fare":7.925,"Embarked":"S","Loc":"X","GroupSize":1},{"Pclass":1,"Sex":"female","Age":35.0,"Fare":53.1,"Embarked":"S","Loc":"C","GroupSize":2},{"Pclass":3,"Sex":"male","Age":35.0,"Fare":8.05,"Embarked":"S","Loc":"X","GroupSize":1}]}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.500.1">You now have an </span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.501.1">understanding of how </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.502.1">powerful tool-managed online endpoints are for model deployment. </span><span class="koboSpan" id="kobo.502.2">In addition to a guided AMLS Studio experience as well as full capabilities within the SDK, we can also leverage the Azure CLI v2 to manage the deployment process. </span><span class="koboSpan" id="kobo.502.3">In the next section, we will explore leveraging the Azure CLI v2 for </span><span class="No-Break"><span class="koboSpan" id="kobo.503.1">this capability.</span></span></p>
<h1 id="_idParaDest-88"><a id="_idTextAnchor097"/><span class="koboSpan" id="kobo.504.1">Deploying a model for real-time inferencing with managed online endpoints through the Azure CLI v2</span></h1>
<p><span class="koboSpan" id="kobo.505.1">In this section, we </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.506.1">will leverage a managed online endpoint and deploy it with the Azure Machine Learning CLI v2. </span><span class="koboSpan" id="kobo.506.2">The CLI v2 will </span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.507.1">leverage YAML files holding the configuration required for our deployment in the commands we call. </span><span class="koboSpan" id="kobo.507.2">Remember the requirement for a unique managed online endpoint name, so when running the code, be sure to update your managed online endpoint name in both the YAML files and the </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">CLI command.</span></span></p>
<p><span class="koboSpan" id="kobo.509.1">To use the new Azure CLI v2 extension, we are required to have an Azure CLI version greater than 2.15.0. </span><span class="koboSpan" id="kobo.509.2">This can easily be checked by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">az version</span></strong><span class="koboSpan" id="kobo.511.1"> command to check your Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">CLI version:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.513.1">On your compute instance, navigate to the terminal and type the following command: </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">az version</span></strong><span class="koboSpan" id="kobo.515.1">. </span><span class="koboSpan" id="kobo.515.2">After typing that command, you should see that the Azure CLI v2 is installed on your compute instance, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">following figure.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer249">
<span class="koboSpan" id="kobo.517.1"><img alt="Figure 6.30 – The Azure CLI v2 with the ml extension installed" src="image/B18003_06_030.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.518.1">Figure 6.30 – The Azure CLI v2 with the ml extension installed</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.519.1">You can update your </span><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">ml</span></strong><span class="koboSpan" id="kobo.521.1"> extension through the </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">following command:</span></span><pre class="console"><span class="koboSpan" id="kobo.523.1">
az extension update -n ml</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.524.1">After installing the new extensions, we can again run </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">az version</span></strong><span class="koboSpan" id="kobo.526.1"> to confirm that the extension is installed and up to date so that we can proceed to </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">log in.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.528.1">You will need to log in with the Azure CLI to handle your deployment by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">az login</span></strong><span class="koboSpan" id="kobo.530.1">. </span><span class="koboSpan" id="kobo.530.2">You will be prompted to open a browser and type a device login </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">to authenticate.</span></span></li>
<li><span class="koboSpan" id="kobo.532.1">After</span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.533.1"> authenticating, you should set your default Azure subscription. </span><span class="koboSpan" id="kobo.533.2">Your Azure subscription ID can be easily retrieved by finding an Azure Machine Learning</span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.534.1"> workspace within the portal and copying the guide displayed in the </span><strong class="bold"><span class="koboSpan" id="kobo.535.1">Subscription ID</span></strong><span class="koboSpan" id="kobo.536.1"> section of the </span><strong class="bold"><span class="koboSpan" id="kobo.537.1">Overview</span></strong><span class="koboSpan" id="kobo.538.1"> tab, as </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">shown here.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer250">
<span class="koboSpan" id="kobo.540.1"><img alt="Figure 6.31 – Azure Subscription ID" src="image/B18003_06_031.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.541.1">Figure 6.31 – Azure Subscription ID</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.542.1">Back in the terminal on your compute instance, set the account for the Azure CLI to leverage by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">az account set -s XXXX- XXXX - XXXX - XXXX – XXXX</span></strong><span class="koboSpan" id="kobo.544.1">, replacing </span><strong class="source-inline"><span class="koboSpan" id="kobo.545.1">XXXX- XXXX - XXXX - XXXX – XXXX</span></strong><span class="koboSpan" id="kobo.546.1"> with your subscription ID. </span><span class="koboSpan" id="kobo.546.2">Then, set variables to hold your resource group name, the location of your AML workspace, and your </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">workspace name:</span></span><pre class="console"><span class="koboSpan" id="kobo.548.1">
GROUP=amlworkspace-rg</span></pre><pre class="console"><span class="koboSpan" id="kobo.549.1">
LOCATION=westus</span></pre><pre class="console"><span class="koboSpan" id="kobo.550.1">
WORKSPACE=amworkspace</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.551.1">Based on where your AMLS workspace is deployed, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">LOCATION</span></strong><span class="koboSpan" id="kobo.553.1"> value can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">here: </span></span><a href="https://github.com/microsoft/azure-pipelines-extensions/blob/master/docs/authoring/endpoints/workspace-locations"><span class="No-Break"><span class="koboSpan" id="kobo.555.1">https://github.com/microsoft/azure-pipelines-extensions/blob/master/docs/authoring/endpoints/workspace-locations</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.556.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.557.1">Once the</span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.558.1"> variables have been set, you can run </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">the following:</span></span><pre class="console"><span class="koboSpan" id="kobo.560.1">
az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION</span></pre></li>
<li><span class="koboSpan" id="kobo.561.1">Navigate to the </span><a href="B18003_06.xhtml#_idTextAnchor086"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.562.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.563.1"> directory in your </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">AML workspace.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.565.1">To create the </span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.566.1">required files, run the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">Chapter 6</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.568.1"> Model Deployment CLI v2  - Create Scripts.ipynb</span></strong><span class="koboSpan" id="kobo.569.1"> notebook, which will create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">endpoint.yml</span></strong><span class="koboSpan" id="kobo.571.1"> file, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">deployment.yml</span></strong><span class="koboSpan" id="kobo.573.1"> file, and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">score.py</span></strong><span class="koboSpan" id="kobo.575.1"> file for inferencing. </span><span class="koboSpan" id="kobo.575.2">The files will be generated in a folder </span><span class="No-Break"><span class="koboSpan" id="kobo.576.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">CLI_v2_ManagedOnlineEndpoint</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.579.1">In the notebook, we will create the directory by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">following code:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer251">
<span class="koboSpan" id="kobo.581.1"><img alt="Figure 6.32 – Directory creation" src="image/B18003_06_032.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.582.1">Figure 6.32 – Directory creation</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.583.1">For the managed online endpoint, we will also create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">score.py</span></strong><span class="koboSpan" id="kobo.585.1"> file. </span><span class="koboSpan" id="kobo.585.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">score</span></strong><span class="koboSpan" id="kobo.587.1"> script will leverage our model and provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">init</span></strong><span class="koboSpan" id="kobo.589.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">run</span></strong><span class="koboSpan" id="kobo.591.1"> functions that our previous </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">score.py</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.593.1">file provided.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer252">
<span class="koboSpan" id="kobo.594.1"><img alt="Figure 6.33 – The score.py file" src="image/B18003_06_033.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.595.1">Figure 6.33 – The score.py file</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.596.1">Next, we </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.597.1">will create the endpoint .</span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">yml</span></strong><span class="koboSpan" id="kobo.599.1"> file. </span><span class="koboSpan" id="kobo.599.2">We can create a basic file that contains the required attributes of the name and the authorization mode. </span><span class="koboSpan" id="kobo.599.3">The</span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.600.1"> authorization mode can be specified as a key or </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">aml_token</span></strong><span class="koboSpan" id="kobo.602.1">. </span><span class="koboSpan" id="kobo.602.2">Key-based authentication will not expire, but the Azure ML token-based authentication will. </span><span class="koboSpan" id="kobo.602.3">We will proceed with </span><span class="No-Break"><span class="koboSpan" id="kobo.603.1">key-based authentication.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.604.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.605.1">When using </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">aml_token</span></strong><span class="koboSpan" id="kobo.607.1">, you can get a new token by running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">az ml online-endpoint </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">get-credentials</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.610.1"> command.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.611.1">Run the command to generate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.612.1">endpoint.yml</span></strong><span class="koboSpan" id="kobo.613.1"> file with the same key value as </span><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">auth_mode</span></strong><span class="koboSpan" id="kobo.615.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">shown here:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer253">
<span class="koboSpan" id="kobo.617.1"><img alt="Figure 6.34 – Managed online endpoint configuration" src="image/B18003_06_034.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.618.1">Figure 6.34 – Managed online endpoint configuration</span></p>
<p><span class="koboSpan" id="kobo.619.1">Remember to update your name to be something unique; if </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">titanic-managed-online-endpoint</span></strong><span class="koboSpan" id="kobo.621.1"> is already deployed in your </span><a id="_idTextAnchor098"/><span class="koboSpan" id="kobo.622.1">region, your deployment </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">will fail.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.624.1">For the managed online endpoint deployment, we will also generate a </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">deployment.yml</span></strong><span class="koboSpan" id="kobo.626.1"> file. </span><span class="koboSpan" id="kobo.626.2">In this file, we need to specify the model, the scoring script, the environment, and the instance type used for </span><span class="No-Break"><span class="koboSpan" id="kobo.627.1">model deployment.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.628.1">Creation</span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.629.1"> of </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.630.1">the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.631.1">deployment.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.632.1"> file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer254">
<span class="koboSpan" id="kobo.633.1"><img alt="Figure 6.35 – Creation of the deployment.yml file" src="image/B18003_06_035.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.634.1">Figure 6.35 – Creation of the deployment.yml file</span></p>
<p><span class="koboSpan" id="kobo.635.1">In this file, you will specify the registered model name and version, the registered environment name and version, the type of compute resources leveraged for the deployed model, and where the scoring script is located. </span><span class="koboSpan" id="kobo.635.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">deployment.yml</span></strong><span class="koboSpan" id="kobo.637.1"> file, you should update </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">endpoint_name</span></strong><span class="koboSpan" id="kobo.639.1"> to reflect the name you chose in your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">endpoint.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.641.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.642.1">After running the notebook and selecting a unique endpoint name, we can leverage CLI v2 to deploy </span><span class="No-Break"><span class="koboSpan" id="kobo.643.1">our model.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.644.1">In the command line, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">CLI_v2_ManagedOnlineEndpoint</span></strong><span class="koboSpan" id="kobo.646.1"> directory, and from that directory, create your </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">online-endpoint</span></strong><span class="koboSpan" id="kobo.648.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">following command:</span></span><pre class="console"><span class="koboSpan" id="kobo.650.1">
az ml online-endpoint create --name titanic-online-endpoint -f endpoint.yml</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.651.1">Note that </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">titanic-online-endpoint</span></strong><span class="koboSpan" id="kobo.653.1"> should be replaced with your managed online </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">endpoint name.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.655.1">After the endpoint is created, you can now create </span><strong class="source-inline"><span class="koboSpan" id="kobo.656.1">online-deployment</span></strong><span class="koboSpan" id="kobo.657.1">, leveraging the </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">following command:</span></span><pre class="console"><span class="koboSpan" id="kobo.659.1">
az ml online-deployment create --name deploytitaniconline --endpoint titanic-online-endpoint -f deployment.yml --all-traffic</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.660.1">Once again, note</span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.661.1"> that </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">titanic-online-endpoint</span></strong><span class="koboSpan" id="kobo.663.1"> should be replaced with your managed</span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.664.1"> online </span><span class="No-Break"><span class="koboSpan" id="kobo.665.1">endpoint name.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.666.1">Once the deployment is complete, the endpoint will be available for testing. </span><span class="koboSpan" id="kobo.666.2">The endpoint is available from the </span><strong class="bold"><span class="koboSpan" id="kobo.667.1">Endpoints</span></strong><span class="koboSpan" id="kobo.668.1"> section in your AML workspace, as </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">shown here.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer255">
<span class="koboSpan" id="kobo.670.1"><img alt="Figure 6.36 – An online endpoint" src="image/B18003_06_036.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.671.1">Figure 6.36 – An online endpoint</span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.672.1">We can</span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.673.1"> test the endpoint by clicking on its name and selecting the </span><strong class="bold"><span class="koboSpan" id="kobo.674.1">Test</span></strong><span class="koboSpan" id="kobo.675.1"> tab on </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">the </span></span><span class="No-Break"><a id="_idIndexMarker467"/></span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">endpoint.</span></span></li>
<li><span class="koboSpan" id="kobo.678.1">In the test section, we can provide data for inferencing after typing into the </span><strong class="bold"><span class="koboSpan" id="kobo.679.1">Test</span></strong><span class="koboSpan" id="kobo.680.1"> box to retrieve results from the web service, as </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">shown here:</span></span><pre class="console"><span class="koboSpan" id="kobo.682.1">
{"raw_data": [{"Embarked":"S","Loc":"X","Sex":"m","Pclass":3,"Age":22.0,"Fare":7.25,"GroupSize":2},{"Embarked":"C","Loc":"C","Sex":"f","Pclass":1,"Age":38.0,"Fare":71.2833,"GroupSize":2},{"Embarked":"S","Loc":"X","Sex":"f","Pclass":3,"Age":26.0,"Fare":7.925,"GroupSize":1},{"Embarked":"S","Loc":"C","Sex":"f","Pclass":1,"Age":35.0,"Fare":53.1,"GroupSize":2},{"Embarked":"S","Loc":"X","Sex":"m","Pclass":3,"Age":35.0,"Fare":8.05,"GroupSize":1}]}</span></pre></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer256">
<span class="koboSpan" id="kobo.683.1"><img alt="Figure 6.37 – Testing an online endpoint" src="image/B18003_06_037.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.684.1">Figure 6.37 – Testing an online endpoint</span></p>
<p><span class="koboSpan" id="kobo.685.1">This sample request can be found in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">chapter 6</span></strong><span class="koboSpan" id="kobo.687.1"> folder under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.688.1">prepped_data</span></strong><span class="koboSpan" id="kobo.689.1"> folder in a file </span><span class="No-Break"><span class="koboSpan" id="kobo.690.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">sample_request_cli.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.693.1">In this section, you were able to deploy a web service utilizing a managed online endpoint in AMLS through the Azure CLI v2. </span><span class="koboSpan" id="kobo.693.2">This feature takes advantage of schema files to provide the deployment definitions in configuration files to enable deployment. </span><span class="koboSpan" id="kobo.693.3">Managed online endpoints prevent data scientists or citizen data scientists from having to be concerned about the infrastructure required to support hosting a web service, to provide real-time</span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.694.1"> in</span><a id="_idTextAnchor099"/><span class="koboSpan" id="kobo.695.1">ferencing to</span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.696.1"> support your </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">use cases.</span></span></p>
<p><span class="koboSpan" id="kobo.698.1">Congratulations on deploying a managed online e</span><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.699.1">ndpoint through the CLI! </span><span class="koboSpan" id="kobo.699.2">This will be especially useful in </span><a href="B18003_09.xhtml#_idTextAnchor119"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.700.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.701.1">, </span><em class="italic"><span class="koboSpan" id="kobo.702.1">Productionizing Your Workload with MLOps</span></em><span class="koboSpan" id="kobo.703.1">. </span><span class="koboSpan" id="kobo.703.2">After testing out your managed online endpoints, be sure to delete them, as they use up </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">compute resources.</span></span></p>
<h1 id="_idParaDest-89"><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.705.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.706.1">In this chapter, the focus was on deploying your model as a REST endpoint to support real-time inferencing use cases. </span><span class="koboSpan" id="kobo.706.2">We saw that we are able to leverage AMLS Studio for a low-code deployment experience. </span><span class="koboSpan" id="kobo.706.3">We also leveraged SDK v2 to deploy models to managed online endpoints. </span><span class="koboSpan" id="kobo.706.4">We continued by deploying models through CLI v2 to support model deployment for real-time inferencing. </span><span class="koboSpan" id="kobo.706.5">These sections demonstrated deploying real-time web services through low-code, code-first, and configuration-driven approaches. </span><span class="koboSpan" id="kobo.706.6">These capabilities empower you to deploy in a variety </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">of ways.</span></span></p>
<p><span class="koboSpan" id="kobo.708.1">In the next chapter, we will learn how to leverage batch-inferencing to support our </span><span class="No-Break"><span class="koboSpan" id="kobo.709.1">use cases.</span></span></p>
</div>
</body></html>