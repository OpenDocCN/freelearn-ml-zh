- en: Implementing Time Series
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Time evolving phenomena are fundamental to many disciplines. Understanding what
    happened and foreseeing how different variables will evolve is key knowledge for
    making correct, informed decisions.
  prefs: []
  type: TYPE_NORMAL
- en: Time series analysis is a broad field, with many different methods to detect
    patterns, predict behaviors, and decompose the time evolution into known and previously
    studied shapes. We are going to discuss some of them, focusing on the ones that
    are easily solved using Excel. The idea, as usual, is that our machines learn
    about the details in the data and can extract useful knowledge about the past
    and the possible future developments.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Modeling and visualizing time series
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Forecasting time series automatically in Excel
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Studying the stationarity of a time series
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To complete this chapter, the reader will need to download the `AirPassengers_modified.csv` file
    from the GitHub repository at [https://github.com/PacktPublishing/Hands-On-Machine-Learning-with-Microsoft-Excel-2019/tree/master/Chapter07](https://github.com/PacktPublishing/Hands-On-Machine-Learning-with-Microsoft-Excel-2019/tree/master/Chapter07).
  prefs: []
  type: TYPE_NORMAL
- en: Modeling and visualizing time series
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have seen that doing a preliminary data analysis and visualizing the dataset
    is the first step in any machine learning project. Time series are no exception.
    So, we will start by exploring time series and learning about its different characteristics.
  prefs: []
  type: TYPE_NORMAL
- en: In the case of a time series, a preliminary analysis implies *modeling* it;
    that is, understanding whether it is periodic, whether it shows a given tendency
    (increasing or decreasing with time), or whether it is stationary (mean and variance
    of the values don't change over time), among other measures. Visualization plays
    a fundamental role in this analysis, since many of the time series characteristics
    can be deduced using a graphical representation of the data points, even if there
    are numerical methods to calculate them.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s use a popular dataset to illustrate the modeling and visualization of
    a time series. The `AirPassengers_modified.csv` file is a simplified version of
    a very popular dataset, usually shown as an example when teaching time series
    analysis (source: *Box, G. E. P., Jenkins, G. M. and Reinsel, G. C. (1976) Time
    Series Analysis, Forecasting and Control. Third Edition. Holden-Day. Series G*).
    Our version contains the amount of international passengers (in thousands) that
    traveled by plane between 1949 and 1961, grouped by month. After loading the file
    the usual way (Data | From Text/CSV), we can visualize the time series in the
    following diagram, where we can see the number of passengers as a function of
    time:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/19b36db8-a0d5-494a-a5e8-dcc305bd984f.png)'
  prefs: []
  type: TYPE_IMG
- en: The first thing that we notice is that the number of passengers increases with
    time. Then, if we look carefully at the peaks in the series, there is a 12-month
    pattern that seems to repeat. Let's prove this observation with the data.
  prefs: []
  type: TYPE_NORMAL
- en: 'The easiest way to get a trend is to use Excel''s built-in capability to calculate
    trends. To use it, follow these steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Click on the chart area.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Check the box for Trendline.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Click on `More Options...`*, *as shown in the following screenshot:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/42bae62a-8491-43bc-bb00-6106d299b054.png)'
  prefs: []
  type: TYPE_IMG
- en: 'The first selection will show the line in the chart and then, after selecting
    More options...,we can check the box to see the line equation expression on the
    chart. Notice that Linear is not the only option for a trend line and that more
    sophisticated regressions are available, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/516e6884-4124-487b-b84e-6f3dbf3a05ca.png)'
  prefs: []
  type: TYPE_IMG
- en: 'The resulting equation, as shown on the chart, is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Passengers = 0.0873*TravelDate - 1472*'
  prefs: []
  type: TYPE_NORMAL
- en: 'Looking at the resulting plot, we see that a straight line does not correctly
    follow the time evolution of the series. Some parts are mostly above the line
    and others below, as you can see in the following chart:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/a7f7282b-3225-457a-a9ec-0b9b689f1ddb.png)'
  prefs: []
  type: TYPE_IMG
- en: 'How can we model the general behavior of the dataset? We can start by realizing
    that we could think about the series as composed of three parts:'
  prefs: []
  type: TYPE_NORMAL
- en: A periodic part, which repeats every 12 months (we guess this because of the
    periodicity of the peaks, and call this 12 month period a *season*)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An increasing part, which we can obtain by regression or averaging the series
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A *noise* part, which we basically define as the remaining values once we isolate
    the first two parts
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This model can then be written as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ef826447-abb0-4fe1-b7c1-928cf3dda60c.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Let''s improve the calculation of the *increasing* part by using a moving average.
    This can be calculated automatically by Excel, but we will do it manually since
    it is simple and we can understand exactly how it works:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Start by calculating the average number of passengers in the first 12 months:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '*=AVERAGE(B2:B13)*'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the cell to the right, calculate the standard deviation (we will use it
    in the next section, when we test the stationarity of the series):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '*=STDEV.S(B2:B13)*'
  prefs: []
  type: TYPE_NORMAL
- en: Copy both calculations down to the end of the table.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'We then have the mean value and standard deviation of the previous 12 months in
    each pair of cells. In practice, we are defining a moving 12-month window and
    sliding it through the data. The resulting table looks similar to the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/22108a4a-5c18-4128-95e9-fb660f5bf21d.png)'
  prefs: []
  type: TYPE_IMG
- en: 'The first 12 places are obviously empty, since we need at least 12 values to
    start averaging. If we show everything in the same diagram, we will see a graph
    similar to the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/77ac6e51-775d-46c4-8157-1681769b8294.png)'
  prefs: []
  type: TYPE_IMG
- en: The moving average follows the details of the series better, and we are going
    to use it as a good approximation for *increasing(TravelDate)*.Notice that the
    moving standard deviation also increases with time, we will use this result in
    the next section.
  prefs: []
  type: TYPE_NORMAL
- en: 'Going back to our model for the time series, we can write:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/6cf3a409-3e45-403d-a258-b2294ab742b9.png)'
  prefs: []
  type: TYPE_IMG
- en: The ratio is between the column *Passengers* and the moving average calculated
    right before. You will be missing the first 12 points, since the average need
    to start somewhere, but that is fine. For the rest of the rows you can calculate
    *Passengers/Moving Average*, which approximates *Passengers/increasing(TravelDate)*.
  prefs: []
  type: TYPE_NORMAL
- en: Add an extra column to calculate this ratio.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Build a new diagram to show the calculation. You will see something like the
    following graph:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/41c4d0e4-51b0-4cc6-9e1f-58fc1af80414.png)'
  prefs: []
  type: TYPE_IMG
- en: We clearly managed to extract the increasing part, but we still have a mixture
    of oscillations and noise. Let's model *periodic(TravelDate) by *repeating the
    first 12 values in sequence.
  prefs: []
  type: TYPE_NORMAL
- en: 'In a new column, copy and paste the first 12 values as many times as you need
    to fill the same number of cells. These values will give you the following graph:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/8bbdbf33-83cd-43bc-992e-7ac2a991185d.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Finally, we will calculate *noise(TravelDate)*. We will, again, calculate this
    from our model:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/72e26bb2-5c75-41c4-b78d-357bcbad2333.png)'
  prefs: []
  type: TYPE_IMG
- en: 'In another column, use the preceding calculation to create a new diagram:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/8d3c1419-fe81-4f79-8ed6-013b3f0359fd.png)'
  prefs: []
  type: TYPE_IMG
- en: 'We now have a full model of the time series and we can use it to predict the
    future values! Let''s do it step by step:'
  prefs: []
  type: TYPE_NORMAL
- en: Open a new sheet.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Copy the series values and extend the time period up to `Dec-62`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In column `C`, copy the *periodic(TravelDate)* values (24 values in two equal
    series of 12 values).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In column `D`, copy the noise values corresponding to the last two years.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In column `E`, cell 146, calculate *increasing(TravelDate)* using the trendline
    formula (*=0.0873*A146 - 1472*).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Copy the formula down to the end of the table. Cell `B1` is then as follows:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '*=C146*D146*E146*'
  prefs: []
  type: TYPE_NORMAL
- en: 'The same calculation is then copied down. The resulting table is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/01f5b1a4-26c7-4e4b-bbe7-63c7ad0c56bf.png)'
  prefs: []
  type: TYPE_IMG
- en: Insert a new diagram, including the two data series, original and predicted.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the following graph, you can see that the prediction is pretty good! (Or,
    at least it follows the historical data; the only real measure of the prediction
    quality is to compare it with real data for those dates):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/bf563981-effb-457c-90f4-9779ab03347d.png)'
  prefs: []
  type: TYPE_IMG
- en: We have followed the necessary steps to model a time series based on its characteristics
    and extensively using calculations and visualizations. We will show in the next
    section that this can also be achieved automatically by using Excel's built-in
    capabilities.
  prefs: []
  type: TYPE_NORMAL
- en: Forecasting time series automatically in Excel
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now that we have forecast a time series the hard way, understanding every step,
    we can do it the easy way. We will use Excel''s built-in functions to predict
    the future number of passengers. Perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Select both columns, `TravelDate` and `Passengers`,corresponding to the time
    and number of passengers.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Navigate to Datain the main menu.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Select Forecast Sheet (see the following screenshot for reference):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c11c995a-ec99-4c7c-8d29-805e5afbe65b.png)'
  prefs: []
  type: TYPE_IMG
- en: 'A window will pop up, showing a preview of the forecast and giving us the chance
    to change some parameters by clicking in Options:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Forecast End**: We can choose the end of the forecast period. By default,
    Excel forecasts three seasons ahead (more on this to follow).'
  prefs:
  - PREF_UL
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Forecast Start**: We can do the same with the start of the forecast period.
    Default is the last point in time of our time series.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Confidence interval**: Thisis defined as the range centered on every predicted
    value, in which 95% of the predicted points will fall (assuming a normal distribution
    of the forecast points).'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Seasonality**: A season is the period in which a time series repeats it pattern
    (if it is periodic, of course). It can be added manually or detected automatically.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following graph shows the pop-up window containing the available options:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/e3706936-75b3-4659-b525-a916133c97ad.png)'
  prefs: []
  type: TYPE_IMG
- en: Timeline Range and Values Range are the selected columns (in our case `TravelDate`
    and `Passenger`).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Clicking on Create*, *we obtain three new columns: `Forecast`, `Lower Confidence
    Bounds (Passengers)`, and `Upper Confidence Bounds (Passengers)`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/35e7ad5d-8053-4c7d-b050-b2338b1229d6.png)'
  prefs: []
  type: TYPE_IMG
- en: 'We will also see the following diagrams, showing the time series plus the forecasted
    values:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/6d3e7e9a-0e68-4f7e-b558-992eda82f225.png)'
  prefs: []
  type: TYPE_IMG
- en: 'If we select Include forecast statistics in the pop-up window, we get the following
    table:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/bb46d482-bf4e-4a89-889a-1e4ec3fe2d4d.png)'
  prefs: []
  type: TYPE_IMG
- en: 'This values correspond to Excel''s built-in *FORECAST.ETS.STAT* function used
    internally by the forecast algorithm. The meaning of these values are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Alpha**: This measures the weight given to the data points. A higher value
    means that we are giving a higher weight to recent data points.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Beta**: This measures the weight given to the trend. A higher value means
    that we are giving a higher weight to the recent trend.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Gamma**: This measures the weight given to the season. A higher value means
    that we are giving a higher weight to the recent seasonal period.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Mean Absolute Scaled Error (MASE)**: This measures the accuracy of the forecasts.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Symmetric Mean Absolute Percentage Erro****r (SMAPE)**: This measures the
    accuracy based on percentage errors.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Mean Absolute Percentage Error** **(AE)**: This measures the accuracy based
    on percentage errors.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Root Mean Squared Error (RMSE)**: This measures the differences between predicted
    and observed values.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We have explained how to use Excel's built-in capabilities to analyze and forecast
    time series. In the next section, we will focus on the importance of time series
    stationarity.
  prefs: []
  type: TYPE_NORMAL
- en: Studying the stationarity of a time series
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Most methods for a time series forecast rely on the fact that the series is
    stationary. This makes sense, since this increases the probability of repeating
    a certain behavior in the future and makes the prediction easier.
  prefs: []
  type: TYPE_NORMAL
- en: 'How can we know whether a given time series is stationary or not? There are
    formal, statistical methods to measure this, but we can also look at some properties
    of the series. There are three main checks of stationarity in practice:'
  prefs: []
  type: TYPE_NORMAL
- en: The mean value is constant (does not depend on time).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The variance is constant.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The covariance of the elements *i* and *i+m* is constant.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: In our previous example, in the *Modeling and visualizing time series* section,
    we plotted the moving average (mean) and variance. If you revisit the diagram,
    you will see that none of them is constant with time, hence the series is non-stationary,
    and we had to model it to be able to forecast values.
  prefs: []
  type: TYPE_NORMAL
- en: A more formal statistical test is the *Dickey-Fuller test*, which is out of
    the scope of this book. This test is not automatically done by Excel, but there
    are a large number of add-ins that can perform it. Doing it manually makes no
    sense.
  prefs: []
  type: TYPE_NORMAL
- en: 'There are two ways of removing seasonality and trend:'
  prefs: []
  type: TYPE_NORMAL
- en: The technique of decomposing the series into noise, periodic, and increasing
    terms.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Differencing – that is, creating a new series by taking the difference between
    the values *i* and (*i+m*). The position difference, *m* is known as **lag**.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You have now seen different methods for predicting the evolution of a time series,
    based on a detailed understanding of its characteristics. We will show more advanced
    forecasting methods, such as ARIMA, when we discuss using Azure machine learning
    models from Excel in [Chapter 10](c4a815b7-95bc-4573-89cf-0399d293e3f6.xhtml),
    *Azure and Excel – Machine Learning in the Cloud*.
  prefs: []
  type: TYPE_NORMAL
- en: Visualization was also a key element throughout the analysis shown in the present
    chapter. We will see different visualization techniques in the next chapter, focusing
    in their particular use cases.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have seen a step-by-step method to decompose a time series and forecast its
    future values. This can help us, at least in general terms, to predict the outcome
    of different processes. Time series can be studied both graphically and numerically,
    extracting their characteristics and using them to understand how they will behave
    in the future. We have also seen that this can be done automatically in Excel,
    with the risk of using it as a black box and not understanding the full forecasting
    method. More advanced techniques exist, and we will discuss them in future chapters.
  prefs: []
  type: TYPE_NORMAL
- en: The next chapter will show you how to build some basic diagrams in Excel and
    how to use them to gain insights on your datasets.
  prefs: []
  type: TYPE_NORMAL
- en: Questions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In our forecast, we modeled the increasing part of the time series using the
    trend function generated by Excel. We could also have used the moving average
    values. How can that be done? Try it and compare the results.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Change the values of the seasonality and confidence interval and study how the
    forecast diagram and parameters change.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How can you calculate the covariance between two values in a time series?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: A possible way to make the variance independent of time is to take the logarithm
    of the time series values. Try this in the air passengers series and check the
    values of the variance.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Further reading
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '*Time Series Analysis and Its Applications*, by R.H. Shumway and D.S. Stoffer'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*An Introductory Study on Time Series Modeling and Forecasting*, by Ratnadip
    Adhikari R. K. Agrawal'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
