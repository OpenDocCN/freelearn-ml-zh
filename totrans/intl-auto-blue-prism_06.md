# 6

# 可重用IA组件

在本章中，我们将讨论四个**可重用IA组件**。这些可重用逻辑片段很短，因此很容易添加到现有的IA流程中。它们通过结合核心BP功能（如环境变量、会话变量和凭证）构建，因此易于实现。它们的目的在于提供对每个IA解决方案都很有用的功能，而无需进行重大修改。

更具体地说，我们将查看四个组件的实现：

+   IA会话控制

+   ML预测关闭开关

+   ML模型版本控制

+   新的ML模型评估

# 技术要求

从GitHub上的`ch6`文件夹下载并导入两个`.bprelease`文件：[https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/tree/main/ch6](https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/tree/main/ch6)。

# IA会话控制

**会话变量**在控制器需要更改活动会话期间执行行为时使用。在IA的上下文中，想要更改执行行为最常见的原因是执行以下操作：

+   强制项进行HITL审查

+   暂时禁用HITL审查

+   强制重新创建用于审查的共享数据

## 强制HITL审查

可能需要强制运行会话中的所有项进行HITL审查，完全禁用HITL，并恢复默认行为。强制会话中的所有项进行审查对于调试和模型验证可能很有用。在审阅人员短缺或需要满足服务级别协议（SLA）的需求高于审查需求时，暂时禁用HITL可能是有用的。

在我们之前章节中看到的示例设计中，用于指定阈值或随机抽样率的用于存储的数据存储在环境变量中。更改环境变量**不会**影响已经运行的会话。然而，它们将影响**所有**未来的会话，这可能不是所希望的。

实现一种强制在当前运行的会话中发生HITL审查的方法很简单。创建一个数据项，将**曝光**设置为**会话**。将**数据类型**设置为**标志**，将**初始值**设置为**False**。如果值为**False**，我们继续使用随机抽样或阈值逻辑。如果值为**True**，我们将该项标记为需要HITL审查。检查此标志的最佳位置是在我们标记或更新项的状态以指示需要手动审查之前：

![图6.1 – 强制HITL审查的会话变量](img/B18416_06_1.jpg)

图6.1 – 强制HITL审查的会话变量

## 禁用HITL审查

同样，我们可以创建一个新的会话变量来禁用HITL。创建一个数据项，将**数据类型**设置为**标志**，**暴露**设置为**会话**，**初始值**设置为**False**。当值为**False**时，尊重原始审查逻辑。当值为**True**时，跳过HITL审查，并使用原始预测值继续自动化处理。这个标志应该在更新项目标签或状态以指示HITL审查完成之前进行检查：

![图6.2 – 一个用于禁用HITL审查的会话变量](img/B18416_06_2.jpg)

图6.2 – 一个用于禁用HITL审查的会话变量

如果**强制HITL审查**和**禁用HITL审查**会话变量的值都设置为**True**会发生什么？**禁用HITL审查**“覆盖”**强制HITL审查**，因为它是在后面检查的。以下表格总结了两个标志的不同组合会发生什么：

| **强制** **HITL审查** | **禁用** **HITL审查** | **行为** |
| --- | --- | --- |
| 否 | 否 | 使用流程的原始逻辑（这是默认行为） |
| 否 | 是 | 会话中的所有项目将继续自动化处理 *而不* 进行HITL审查 |
| 是 | 否 | 会话中的所有项目 *都将* 需要审查 |
| 是 | 是 | 会话中的所有项目将继续自动化处理 *而不* 进行HITL审查 |

表6.1 – 强制HITL审查和禁用HITL审查会话变量行为

## 强制审查数据重建

IA解决方案的一个可能脆弱的部分在于BP和审查员之间的数据共享接口。存在许多可能的情况，记录可能会丢失，导致无法审查的预测。除非控制器手动从`标记`会话变量编辑其状态，否则此项目将陷入停滞，类似于**强制HITL审查**和**禁用HITL审查**。

我们已经讨论了三个仅属于IA的会话变量以及它们如何设置。接下来，让我们通过一个例子来看看三个会话变量，包括对流程逻辑的修改，是如何实现的。

## 示例1 – 三个IA会话变量

在这个例子中，我们将查看三个流程的修改版本，三个工作队列设计来自[*第五章*](B18416_05.xhtml#_idTextAnchor075)，并确切地看到三个会话变量在流程图中的添加位置。然后我们将测试会话变量以确保它们按预期工作。我们的目标是了解我们如何在流程中检查会话变量。这个例子有七个高级步骤：

1.  验证发布内容。

1.  检查`强制HITL审查`会话变量的逻辑。

1.  从控制室测试 `强制HITL审查`。

1.  检查`强制创建审查数据`会话变量的逻辑。

1.  从控制室测试 `强制创建审查数据`。

1.  检查`禁用HITL审查`会话变量的逻辑。

1.  从控制室测试 `禁用HITL审查`。

### 验证发布内容

首先，让我们熟悉一下本示例的发布文件内容。验证是否已导入*三个*流程、*三个*工作队列和*三个*环境变量：

![图6.3 – 示例1的发布内容](img/B18416_06_3.jpg)

图6.3 – 示例1的发布内容

第一个流程，命名为**示例1A – 三个IA会话变量**，仅执行标准业务逻辑，不受本节中描述的三个会话变量的影响。流程2，**示例1B – 强制HITL审查**，包含一个会话变量。让我们接下来看看它。

### 检查强制HITL审查会话变量逻辑

**强制HITL审查**会话变量控制我们是否希望所有ML预测都经过人工审查。这属于流程2，即ML预测制作和阈值或随机抽样逻辑检查的地方。让我们在流程2中找到检查我们会话变量的决策阶段逻辑：

1.  在流程工作室的*Ch6*组中打开**示例1B – 三个IA会话变量**流程。

1.  请查看是否在`主页面`中添加了一个全局会话变量：

![图6.4 – 会话变量已保存在流程2的主页上](img/B18416_06_4.jpg)

图6.4 – 会话变量已保存在流程2的主页上

1.  打开`02 检查手动` `审查`页面。

1.  打开*是否需要手动审查？*决策阶段。查看我们是否已将检查会话变量作为表达式中的`OR`条件添加：

![图6.5 – 会话变量已添加到决策阶段](img/B18416_06_5.jpg)

图6.5 – 会话变量已添加到决策阶段

### 测试强制HITL审查会话变量

既然我们已经知道了如何检查会话变量，让我们在控制室中测试它。此流程向[*第6章*](B18416_06.xhtml#_idTextAnchor093) *示例1* *队列1*添加了10个项目：

1.  在控制室中运行**示例1A – 三个IA会话变量**。等待会话完成。

1.  打开**控制** | **会话管理**。点击**显示会话变量**以确保**会话变量**面板已打开：

![图6.6 – 确保会话变量面板已打开](img/B18416_06_6.jpg)

图6.6 – 确保会话变量面板已打开

保持面板打开将允许我们在*步骤4*中快速更改`强制HITL审查`会话变量的值。

1.  在控制室中运行**示例1B – 强制HITL审查**。**不要**等待会话完成。

1.  在**会话变量**面板中将**强制HITL审查**会话变量设置为**True**。从现在起，所有做出的ML预测都将标记为需要HITL审查：

![图6.7 – 将强制HITL审查会话变量设置为True](img/B18416_06_7.jpg)

图6.7 – 将强制HITL审查会话变量设置为True

1.  一旦会话完成，查看[*第6章*](B18416_06.xhtml#_idTextAnchor093) *示例1 队列1*的内容。根据你更改会话变量的速度，你应该看到所有或几乎所有队列项都需要人工审查：

![图6.8 – 工作队列1中的几乎所有项目都应该需要人工审查](img/B18416_06_8.jpg)

图6.8 – 工作队列1中的几乎所有项目都应该需要人工审查

我们已确认`强制HITL审查`会话变量正在工作。现在，让我们看看强制重新创建评论数据的会话变量。

### 检查强制创建评论数据会话变量逻辑

回想一下，第三个流程包含将评论数据写入磁盘的逻辑，并检查评论是否已完成。在这里，我们将检查流程3，看看文件重建会话变量逻辑是如何实现的：

1.  在流程工作室的*Ch6*组中打开**示例1C - 禁用HITL审查和强制创建评论数据**流程。

1.  看到两个全局会话变量在`主页`上。`强制创建评论数据`会话变量是我们这里感兴趣的：

![图6.9 – 两个会话变量保存在流程3的主页上](img/B18416_06_9.jpg)

图6.9 – 两个会话变量保存在流程3的主页上

1.  打开`01 编写共享评论` `数据`页面。

1.  找到名为**会话变量逻辑**的块。与上一章中的原始示例相比，这个块是新添加到这个页面上的。

1.  打开*强制创建评论数据？*决策阶段。我们将检查**强制创建评论数据**是否为**真**。如果是，我们将尝试删除现有文件并从我们的项目数据中移除对其的引用。然后我们将继续创建一个新评论文件，就像它从未存在过一样。

![图6.10 – 允许强制创建评论文件的逻辑](img/B18416_06_10.jpg)

图6.10 – 允许强制创建评论文件的逻辑

### 测试强制创建评论数据会话变量

现在，让我们测试会话变量是否工作。我们将总共运行流程3三次。第一次运行创建所有评论文件一次。第二次运行确认默认情况下不会重新创建评论文件。对于第三次运行，我们将更改会话变量，并看到之前的评论文件正在被删除，同时以新的文件替换它们。

1.  在控制室中运行**示例1C - 禁用HITL审查和强制创建评论数据**。此流程在项目之间也有一个睡眠阶段，以便更容易编辑会话变量。等待会话完成。

1.  在Windows资源管理器中访问由`Ch6 Example 1 To Review Folder Path`环境变量定义的文件夹。验证文件夹中文件的数量是否与等待人工审查的项目数量相等。注意这些文件创建的时间戳。

1.  等待[*第6章*](B18416_06.xhtml#_idTextAnchor093) *示例 1 队列 3*中项目的延迟时间通过。

1.  在控制室中第二次运行**Example 1C - Disable HITL Review and Force Create Review Data**。等待会话完成。

1.  返回由`Ch6 Example 1 To Review Folder Path`环境变量定义的文件夹。验证文件的日期时间戳没有更改。这表明审查文件尚未被重新创建。

1.  等待[*第6章*](B18416_06.xhtml#_idTextAnchor093) *示例 1 队列 3*中项目的延迟时间通过。

1.  在控制室中第三次运行**Example 1C - Disable HITL Review and Force Create Review Data**。不要等待会话完成。

1.  在**会话变量**面板中将**Force Create Review Data**会话变量设置为**True**。从这一点开始，每个项目都将重新创建其审查数据。等待会话完成：

![图6.11 – 将Force Create Review Data会话变量设置为True](img/B18416_06_11.jpg)

图6.11 – 将Force Create Review Data会话变量设置为True

1.  返回由**Ch6 Example 1 To Review Folder Path**环境变量定义的文件夹。验证文件的修改日期时间戳已更改，表明它们已被重新创建。

到目前为止，我们已经测试了我们的两个会话变量。让我们继续并查看第三个，它用于禁用HITL审查检查。

### 检查Disable HITL Review会话变量逻辑

我们最后的会话变量也在第三个流程中。让我们看看它是如何实现的：

1.  打开此流程的`Main Page`。

1.  打开`02 Check for Reviewed` `Predictions`页面。

1.  确认已添加名为**Disable HITL Review**的决策阶段，该阶段跳过后审查项目后应运行的阶段：

![图6.12 – 已添加决策阶段以禁用HITL Review](img/B18416_06_12.jpg)

图6.12 – 已添加决策阶段以禁用HITL Review

### 测试Disable HITL Review会话变量

在本例的最后部分，我们将再次运行第三个流程，将**Disable HITL Review**会话变量设置为**True**，并验证[*第6章*](B18416_06.xhtml#_idTextAnchor093) *示例 1* *队列 1*中的项目是否已移除其状态和标签：

1.  在控制室中再次运行**Example 1C – Disable HITL Review and Force Create Review Data**。不要等待会话完成。

1.  在**会话变量**面板中将**Disable HITL Review**会话变量设置为**True**。从这一点开始，每个项目将不再需要HITL审查。等待会话完成。

1.  查看[*第6章*](B18416_06.xhtml#_idTextAnchor093) *示例 1 队列 1*工作队列的内容。之前需要**手动审查**的项目现在应显示为**手动审查完成**，并移除了其标签。队列1中的项目准备继续其自动化处理：

![图6.13 – 队列1中的项目已跳过HITL审查](img/B18416_06_13.jpg)

图6.13 – 队列1中的项目已跳过HITL审查

我们已经完成了包含三个会话变量的可重用设计片段的实现示例。这些会话变量使我们能够在会话仍在运行时控制IA特定的行为。现在，让我们从查看特定于会话的设计控制转向一个可以在多个会话中工作的设计组件。

# 机器学习预测终止开关

想象一下，在机器学习算法已经在生产环境中运行后，发现了一个重大的缺陷。我们希望停止所有正在进行的会话，使其不再使用该模型进行预测。一个选项是从源头上禁用机器学习模型——例如，通过关闭云服务或内部Web服务器。然而，IA团队成员在短时间内完成这一操作的可能性相当低。

IA控制器团队可用的最明显选项是使用*请求停止*，但根据标准的BP流程模板，只有在项目执行完成后才会进行*停止*的检查。如果并发运行的会话数量足够低，添加*会话变量*来停止机器学习预测也是一个选项。但如果我们有数十个，甚至数百个会话在进行中呢？

可以用来防止机器学习预测在所有会话中运行的组件设计是一个**终止开关**。终止开关的目的是允许IA控制器以可控的方式停止所有当前正在运行的会话，以停止机器学习预测。实现终止开关很简单；然而，它使用了一个BP功能——*凭证*，以一种非预期的方式。

## 示例2 – 终止开关

由于实现终止开关很简单，让我们从头开始构建一个，看看它是如何工作的。终止开关使用凭证及其*标记为无效*属性。从高层次来看，我们将进行七个步骤：

1.  创建凭证并授予其权限。

1.  创建一个使用凭证的流程。

1.  在流程中添加异常处理。

1.  确定终止开关的逻辑。

1.  使用*非活动*的终止开关测试流程。

1.  激活终止开关。

1.  使用*活动*的终止开关测试流程。

### 创建凭证并授予权限

实现终止开关的第一步是创建一个新的凭证：

1.  从BP的**系统**|**安全**|**凭证**区域创建一个新的凭证。

1.  将凭证命名为**终止开关**：

![图6.14 – 将凭证命名为“终止开关”](img/B18416_06_14.jpg)

图6.14 – 将凭证命名为“终止开关”

1.  点击**访问****权限**标签。

1.  点击**安全角色**子标签，并勾选**所有角色**复选框。请注意，这不是最佳实践，但我们这样做是为了简化示例。

1.  点击**流程（旧版）**子标签，并勾选**所有****流程**复选框。

1.  点击**资源（旧版）**子标签，并勾选**所有****资源**复选框。

1.  保存凭证。

### 创建流程和杀死开关

接下来，让我们创建一个使用此凭证的 BP 流程：

1.  在*Ch6*组中创建一个名为**示例2 – 测试杀死开关**的流程。

1.  在流程工作室中打开**示例2 – 测试杀死开关**流程。

1.  在流程图中添加一个操作阶段。

1.  打开操作阶段，然后设置`"杀死开关"`为**凭证名称**：

![图6.15 – 将凭证::Get操作添加到流程图中](img/B18416_06_15.jpg)

图6.15 – 将凭证::Get操作添加到流程图中

1.  点击**输出**选项卡。创建一个名为**状态**的数据项以存储状态输出：

![图6.16 – 存储凭证::Get操作的输出状态](img/B18416_06_16.jpg)

图6.16 – 存储凭证::Get操作的输出状态

1.  保存操作。

1.  **链接****开始**到操作。

### 添加异常处理

杀死开关的下一部分是添加一些简单的异常处理。此IA组件需要处理如果凭证意外删除的异常：

1.  在`杀死开关`周围添加一个块。

1.  在块内添加一个恢复阶段。

1.  **链接**恢复阶段到一个恢复阶段。恢复阶段应该位于**阻塞**之外。

1.  添加一个异常阶段。填写以下详细信息：

![图6.17 – 创建异常](img/B18416_06_17.jpg)

图6.17 – 创建异常

1.  **链接**恢复阶段到异常阶段。到目前为止的流程图应该看起来如下：

![图6.18 – 到目前为止的杀死开关流程图](img/B18416_06_18.jpg)

图6.18 – 到目前为止的杀死开关流程图

杀死开关结构几乎完成。接下来，我们需要添加逻辑来检查凭证的状态。

### 完成杀死开关

杀死开关利用凭证的*标记为无效*属性。让我们添加一个决策阶段来检查它：

1.  在*杀死***开关**块内添加一个决策阶段到流程图中。

1.  将决策阶段的名称设置为`状态 = 无效？`并将表达式设置为以下：

    [PRE0]

![图6.19 – 决策阶段设置](img/B18416_06_19.jpg)

图6.19 – 决策阶段设置

1.  将名为*SE – 杀死开关触发*的异常阶段复制并粘贴到流程图中，使其出现两次。确保这个新的异常位于*杀死***开关**块内。

1.  **链接****凭证::Get**操作到**状态 = 无效？**决策阶段。

1.  **链接**决策阶段的**是**路径到新粘贴的异常和**否**路径到**结束**。

1.  保存流程。

1.  确认流程图看起来类似于以下：

![图6.20 – 最终的杀死开关测试流程](img/B18416_06_20.jpg)

图6.20 – 最终的杀死开关测试流程

我们现在已经完成了终止开关。它会检查凭据是否被 **标记为无效**。如果是，则抛出异常。如果不是，我们可以继续到后续的阶段。当在真实的 IA 流程中使用此终止开关时，决策阶段应直接链接到调用机器学习预测的阶段，而不是链接到 **结束**。

### 使用未激活的终止开关从流程工作室运行流程

让我们以当前状态运行流程，使用休眠的终止开关。这是默认行为，或者当我们想要我们的 IA 流程进行机器学习预测时会发生的情况：

1.  从流程工作室运行 **示例 2 – 测试终止开关**。

1.  看到它只是从 **开始** 到 **结束**。

我们已经看到了终止开关未激活的无事案例。接下来，我们将激活机器学习终止开关。

### 通过将凭据标记为无效来激活终止开关

要激活终止开关，我们标记凭据为无效。当终止开关激活时，执行将被阻止继续通过 **终止开关** 块。在正常情况下，我们会在会话仍在运行时激活终止开关。然而，我们在这里触发它是为了方便使用 BP 的试用版和学习版的读者。

1.  导航到 **系统** | **安全** | **凭据**，并打开名为 **终止开关** 的凭据。

1.  选择 **标记为无效** 复选框并保存凭据：

![图 6.21 – 检查标记为无效的凭据框](img/B18416_06_21.jpg)

图 6.21 – 检查标记为无效的凭据框

当凭据被标记为无效时，我们的终止开关是 **激活** 的，并且所有当前和未来的 *Test Kill Switch* 流程的会话运行在执行达到 *状态 = 无效？* 决策阶段时都会抛出异常。

### 使用激活的终止开关从流程工作室运行流程

在终止开关激活的情况下，让我们再次运行我们的流程。这应该会抛出异常，阻止我们到达流程中终止开关块之后的区域：

1.  从流程工作室运行 **示例 2 – 测试终止开关**。

1.  看到抛出了异常。

当流程尝试获取已作废的凭据时，会抛出异常。当前项目的工作停止，并且使用此特定凭据的所有会话中的后续项目工作也会停止。这会持续到凭据再次被标记为有效。此终止开关最好与项目状态和允许在调用终止开关逻辑之前跳过执行的决策阶段一起使用。

重要提示

想要将凭据标记为无效的用户可能在 BP 中需要额外的权限。在生产环境中使用终止开关可能需要审查逻辑访问模型，该模型定义了哪些用户应该拥有哪些用户角色，以及哪些用户角色应该在 BP 中拥有哪些权限。

删除凭证（不推荐）也可以用来触发关闭开关，但您必须记得使用完全相同的名称重新创建凭证。创建和删除加密方案和环境变量也可以用来实现关闭开关，但使用凭证是一种更简洁的实现方式。勾选**标记为无效**的复选框操作起来更简单，也更易于撤销。

通常，您会为生产中的每个机器学习模型设置一个关闭开关。如果多个进程使用相同的机器学习模型，则可以使用相同的关闭开关凭证。

我们已经讨论了关闭开关。让我们继续讨论本章的第三个IA组件，该组件讨论了为了审计目的需要对机器学习模型进行版本化的需求。

# 机器学习模型版本化

机器学习程序，就像所有软件一样，应该定期更新。更新可能出于许多原因——可能有新数据、机器学习框架的变化、模型调优的改进、安全修复等。无论更新发生的原因是什么，当它们发生时，IA团队都应该被告知，因为它们可能会影响预测的准确性。

理想情况下，面向生产的机器学习模型将由供应商进行版本化。模型的更新应导致新的文档和新的URL端点。拥有新的端点允许IA团队有意识地选择何时使用更新的模型，并在必要时回滚到旧模型。然而，在现实中，机器学习供应商可能会简单地重用相同的端点并使用更新的模型，而不会主动通知客户变化。

如果IA团队没有主动被告知机器学习模型的变化，它应该**手动**跟踪更新发生的时间，以进行调试和审计。否则，当我们查看会话日志时，我们不会知道实际使用了哪个版本的模型！我们的目标是仅通过查看会话日志就能知道**哪个版本的机器学习模型被使用**。但由于触发机器学习预测有多种方式，这并不立即明显如何实现。

重要注意事项

版本化的目的不是为了确保确定性。确定性模型是指相同的输入集总是导致相同的预测。许多模型引入了随机性；例如，生成式AI即使在多次提供相同提示的情况下也会给出不同的输出。对于版本化，我们不是在寻找确定性，但我们希望有信心模型是使用相同的数据、底层算法、库、超参数等创建的。

## 调用Web API的两种不同方式

Web API是目前部署ML模型最常见的方式。在BP中，我们通过*对象*或*Web API服务*（可能从DX下载）连接到Web API。API的URL将作为数据项嵌入，在对象的情况下，或者直接保存在Web API服务的配置中。这导致我们需要考虑*四种*不同的情况，当我们思考如何在BP中为ML模型进行版本控制时。对象的情况也适用于代码阶段和CLI脚本。

| **BP调用方法** | **新模型是否有** **独立的端点**？ | **要做什么** |
| --- | --- | --- |
| 对象 | 是 | 在对象阶段启用日志记录以显示正在使用的URL |
| 对象 | 否 | 手动跟踪版本 |
| Web API服务 | 是 | 手动跟踪版本 |
| Web API服务 | 否 | 手动跟踪版本 |

表6.2 – 调试和审计ML模型的四种版本控制方式

在接下来的章节中，我们将逐一介绍*表6.2*中概述的四个Web API调用场景。

## 当提供新端点时使用对象调用Web API

假设ML供应商已更新其模型，并已为我们提供了新的URL端点。如果我们使用对象调用此URL，我们可以通过记录URL将会话运行与正在使用的模型关联起来。在对象中，URL将作为数据项、环境变量存储，或者直接作为动作的输入输入。无论URL如何输入到对象中，我们所需做的就是启用适当的阶段的日志记录。请注意，对象的**阶段日志记录**默认是禁用的，因此我们必须明确打开日志记录：

![图6.22 – 在对象中启用阶段日志记录以记录URL端点](img/B18416_06_22.jpg)

图6.22 – 在对象中启用阶段日志记录以记录URL端点

## 当供应商重用现有端点时使用对象调用Web API

如果供应商在更新模型时没有提供新的端点，我们需要创建自己的版本控制方案，并在API调用之前在会话日志中明确记录。我建议使用`日期时间`，它存储了我们确定模型已更新的日期作为版本控制方案。让我们通过一个示例一起实现这个IA组件。

## 示例3 – 手动版本控制ML端点

*环境变量*是我们存储API版本的最佳位置，因为我们希望在流程和对象图之外更新其值。然而，环境变量的更改会在*审计日志*中显示，而不是在*会话日志*中。因此，仅通过查看会话日志，我们无法知道特定会话运行使用了哪个ML模型版本。您需要将*会话日志的日期*与*审计日志*交叉引用，以找出何时修改了该环境变量以及更改了什么值。需要查看两种不同类型的日志并不是理想的情况。

![图 6.23 – 环境变量更改出现在审计日志中](img/B18416_06_23.jpg)

图 6.23 – 环境变量更改出现在审计日志中

一个更好的解决方案是在我们的 API 调用之前，在会话日志中始终记录环境变量的值。这使得找出用于进行预测的 API 版本变得容易。为了实现这一点，我们在 API 调用之前添加了一个带有日志记录功能的“虚拟”计算阶段。

在本例中，我们将演示如何实现导致 ML 版本出现在会话日志中的 ML 版本控制。我们将通过五个高级步骤来完成：

1.  创建一个环境变量。

1.  创建一个测试流程。

1.  在控制室中运行流程并查看会话日志。

1.  使用新的 API 模型版本更新环境变量。

1.  再次在控制室中运行流程并查看会话日志。

#### 创建一个环境变量。

首先，我们需要创建一个环境变量，并用一个 `DateTime` 值填充它——这将是我们当前正在使用的 API 的“版本”：

1.  导航到**系统** | **流程** | **环境变量**。

1.  添加一个名为 `DateTime` 的新环境变量，并将值设置为当前的 DateTime。

1.  点击**应用**。

#### 创建一个测试流程。

接下来，让我们创建一个测试流程，该流程调用一个虚拟 API 对象。虚拟对象取代了真实的 ML API 调用：

1.  在 *Ch6* 组中创建一个名为**示例 3 – ML 版本控制**的流程。

1.  在流程工作室中打开**示例 3 – ML 版本控制**。

1.  将 `Ch6 Example 3 ML API Version` 环境变量作为数据项添加到图中。

1.  在 `Temp` 数据项下添加一个计算阶段，并将**阶段日志记录**设置为**启用**：

![图 6.24 – 创建一个用于记录环境变量值的计算阶段](img/B18416_06_24.jpg)

图 6.24 – 创建一个用于记录环境变量值的计算阶段

我们所做的是通过将值保存到一个名为 `Temp` 的废弃数据项中，将环境变量的值记录到会话日志中。

1.  添加一个 `"www.testapi.com"`。将**阶段日志记录**设置为**启用**。我们将使用这个**设置剪贴板**动作作为实际调用 API 的替代品。

1.  **链接** **开始**到计算阶段，计算阶段到动作，动作到**结束**。完成的图应如下所示：

![图 6.25 – 一个简单的测试流程](img/B18416_06_25.jpg)

图 6.25 – 一个简单的测试流程

1.  发布并保存流程。

#### 运行测试流程并查看会话日志。

让我们在控制室中运行一次流程，看看会话日志显示了什么：

1.  在控制室中运行**示例 3 – ML 版本控制**并等待会话完成。

1.  打开该会话运行的会话日志。记录**日志 API 版本**计算阶段的值和我们的“假 API 调用”的 URL，**设置剪贴板**：

![图 6.26 – 查看会话日志并记录 ML API 版本和 URL](img/B18416_06_26.jpg)

图 6.26 – 查看会话日志并注意机器学习 API 版本和 URL

现在，假设机器学习供应商在保持 URL 端点不变的情况下更新了机器学习模型。在 **设置剪贴板** 中记录“URL”的值不会让我们根据会话日志知道模型已更改。我们需要将我们的环境变量更新到新的模型版本值。

#### 更新环境变量

由于我们不需要更新 URL，让我们更新环境变量到一个新的 `DateTime` 值。这将与我们的计算阶段一起记录下底层机器学习模型已更新的事实，尽管 URL 保持不变：

1.  导航到 **系统** | **流程** | **环境变量**。

1.  将 `Ch6 Example 3 ML API Version` 更新为当前的 DateTime。

1.  点击 **应用**。

#### 运行测试流程并再次查看会话日志

让我们再次运行流程并验证更改环境变量是否反映在会话日志中：

1.  在控制室中运行 **示例 3 – 机器学习版本控制**。

1.  打开最新会话运行的会话日志。查看更新的环境值是否已反映在我们的日志中：

![图 6.27 – 更新的环境变量反映在会话日志中](img/B18416_06_27.jpg)

图 6.27 – 更新的环境变量反映在会话日志中

在这个第三个例子中，我们讨论了一个包含环境变量和计算阶段的组件。这个组件的目的是为了手动对机器学习模型进行版本控制，以便进行调试和审计。

完全没有必要使用计算阶段，因为环境变量的更改会反映在审计日志中。这可以与会话日志进行交叉引用，以确定在会话运行期间使用了哪个版本的机器学习模型。然而，将机器学习模型版本直接保存到会话日志中会更简单，从而避免获取审计日志时可能遇到的问题，例如用户访问限制。

## 调用 Web API 服务

如果使用 Web API 而不是对象，基本端点将直接保存在配置中的某个地方。在下面的图中，它保存在每个单独的操作中：

![图 6.28 – URL 保存到 Web API 服务配置中](img/B18416_06_28.jpg)

图 6.28 – URL 保存到 Web API 服务配置中

假设 API 版本从前面图中的 *v1* 变更为 *v2*。*审计日志* 将显示 Web API 服务已被修改，但新的和之前的 URL *无法看到*。这使我们无法确切知道在会话运行期间使用了哪个 URL（以及因此模型）：

![图 6.29 – 之前和新的 URL 在审计日志中找不到](img/B18416_06_29.jpg)

图 6.29 – 之前和新的 URL 在审计日志中找不到

因此，如果我们使用 Web API 服务来制作我们的 ML 预测，是否提供了新的端点并不重要——*历史更改的 URL 在任何 BP 日志中都无法找到。* 如果我们想了解正在使用哪个端点进行 Web API 服务，我们必须使用在 *示例 3* 中制定的相同方案，包括一个计算阶段和一个环境变量。

我们已经讨论了如何在会话日志中记录 ML 模型版本。接下来，让我们看看最终的可重用 IA 组件，该组件用于按顺序评估新的 ML 模型，与当前在生产中运行的模型一起。

# 新的 ML 模型评估

预测模型可能会因多种原因而改变，包括训练数据的更新、超参数调整或切换到全新的算法。当一个 ML 模型发生变化时，它需要与一个 *验证* 数据集进行评估——但这可能还不够。该组件的目的是允许我们对一个提议的模型与 *生产* 数据进行评估。目标是收集有关提议的模型如何与生产数据交互的数据，以便数据科学或 IA 团队可以确定它是否可接受。

本节所述的 IA 组件是通过一个流程模板实现的。当在 IA 流程中使用时，此模板允许我们使用实时数据对第二个 ML 模型进行预测。该组件设计背后的原则包括以下内容：

+   足够简单，可以集成到现有的 IA 流程中。

+   将日志限制在单个阶段，以方便提取会话日志信息供数据科学家使用。

+   在模板中恢复任何发生的异常，以免影响主生产流程。

+   使用简短且简单的逻辑来避免过多增加项目的总工作时间。

让我们通过一个例子来看看如何实现这一点。

## 示例 4 – 新的 ML 模型评估流程模板

在这个例子中，我们将通过一个已经开发的流程模板，并解释它是如何工作的。我们还将讨论将模板纳入现有 IA 流程所需的步骤。我们的例子包含三个高级步骤：

1.  验证发布内容。

1.  理解模板逻辑。

1.  理解如何将其集成到现有的 IA 流程中。

### 验证发布内容

发布内容应在 *技术要求* 部分中导入。验证是否已导入 *一个* 流程、*一个* 工作队列和 *两个* 环境变量：

![图 6.30 – 发布文件内容](img/B18416_06_30.jpg)

图 6.30 – 发布文件内容

`Ch6 Example 4 Enable Model Evaluation` 环境变量确定此模板是否激活。`Ch6 Example 4 Evaluation Model ID` 环境变量是我们想要测试的 ML 模型的自定义 ID。这是为了帮助我们跟踪在生产中正在测试哪个模型。接下来，让我们打开流程并了解模板内容。

### 理解模板逻辑

流程模板逻辑很简单，只有两个页面。有一个占位符页面，你需要在其中提供使机器学习预测的逻辑。完成以下步骤：

1.  在流程工作室的*Ch6*组中打开**示例4 – 新模型评估流程模板**。

1.  双击`主页面`。你会看到我们需要传递两个集合。`输入数据`集合存储了我们想要评估的机器学习模型所需的预测输入数据。`原始预测结果`集合（可选）可以在我们想要将实际生产预测的结果与正在评估的模型的预测结果一起记录时传递。这使得比较两个结果变得更容易：

![图6.31 – 启动阶段的输入参数](img/B18416_06_31.jpg)

图6.31 – 启动阶段的输入参数

1.  查看连接到`Ch6 Example 4 Enable Model Evaluation`环境变量的**启用模型评估？**决策阶段，以确定是否使用此模板。

1.  查看输入到新队列（由`队列名称`指定）的`输入数据`，并立即使用`队列名称`锁定该项以进行处理，应与调用进程的工作队列不同：

![图6.32 – 将项添加到新队列](img/B18416_06_32.jpg)

图6.32 – 将项添加到新队列

在新队列中创建项的原因是为了使从控制室中找到单个项的评估预测变得容易。

1.  查看环境变量`Ch6 Example 4 Evaluation Model ID`。这为你提供了一个版本或识别正在评估的模型的方法。这将记录在会话日志中供参考。

1.  查看**Recover1**阶段。添加了异常处理以确保异常不会向上冒泡到调用进程。

1.  打开`调用预测`页面。这个页面主要是为了让你插入使用评估机器学习模型进行预测所需的实际阶段。预测输出必须添加到**输出数据**集合中，以便写入会话日志。在添加你的逻辑时，确保只为想要记录开始和结束时间的阶段开启阶段日志：

![图6.33 – 调用预测页面](img/B18416_06_33.jpg)

图6.33 – 调用预测页面

1.  查看多计算阶段`记录新模型评估结果`。这记录了与数据科学家相关的所有相关信息，以便在单个会话日志条目中轻松检索：`Ch6 Example 4 Evaluation Model ID`、`输入数据`、`原始预测结果`和`输出数据`。

### 与现有流程的集成

既然我们已经看到了模板的逻辑，我们将讨论将其实施到现有IA流程中所需的步骤：

1.  在流程工作室中打开模板，并使用**另存为**创建一个新的流程。

1.  在`主页面`下创建一个新的工作队列以匹配它。工作队列的**键名**字段应根据ML调用的输入数据设置，或者可以留空。

1.  创建两个新的环境变量来替换`Ch6 Example 4 评估模型ID`和`Ch6 Example 4 启用模型评估`。设置它们的值，并将`主页面`上的两个环境变量替换为新创建的变量。这也导致需要更改`主页面`上的*启用模型评估？*决策阶段，以及`调用``预测`页面上的*记录新模型评估结果*计算阶段。

1.  打开`调用预测`页面。插入逻辑以使用`输入数据`集合中的数据对评估ML模型进行预测。预测输出应格式化为`输出``数据`集合。

1.  在特定操作或Web API上启用阶段日志记录以进行ML预测。否则，将已添加的阶段日志设置为仅记录*错误*。

1.  保存模板。

1.  在现有的IA流程中，在获得实时预测结果后添加一个*流程*阶段。配置此阶段使用刚刚保存的流程模板。在评估模型进行预测所需的`输入数据`上，以及可选的，如果您想将其与评估模型一起记录，则`原始预测结果`。

使用此组件，我们可以在对现有IA流程进行很少的更改的情况下，对评估ML模型进行实时预测。对原始流程的唯一修改是调用子流程。

由于所有会话日志记录都在单个阶段中发生，因此访问这些评估预测的结果变得简单。可以按*多计算*阶段的名称导出和过滤会话日志。这为数据科学家提供了他们进一步评估模型所需的所有信息，包括模型ID、输入数据、生产预测结果和评估预测结果。

# 可重用IA组件审查

我们已经介绍了四个不同的可重用组件，这些组件可以在许多不同的IA流程中使用。以下表格显示了每个组件的目的以及创建它们所使用的BP功能摘要：

| **姓名** | **使用的BP主要功能** | **目的** |
| --- | --- | --- |
| IA会话控制 | 会话变量和决策阶段 | 基于会话控制是否：项目必须强制进行HITL审查。审查检查被禁用。用于审查的共享数据应重新创建。 |
| ML预测终止开关 | 凭证（标记为无效）、决策阶段和异常处理 | 允许防止使用特定模型的所有当前和未来的会话进行ML预测 |
| ML模型版本控制 | 计算阶段（启用日志记录）和环境变量 | 创建指定使用哪个ML模型版本进行预测的会话日志，即使API端点保持不变 |
| 新机器学习模型评估 | 工作队列、环境变量、异常处理和多计算阶段（用于日志记录） | 以一种使预测结果提取简单的方式进行，在主机器学习模型旁边运行一个评估机器学习模型 |

表6.3 – 四个可重用IA组件的总结

# 摘要

在本章中，我们开发了四个可重用的IA组件，它们提供了与机器学习操作特别相关的附加功能。这些组件可以轻松集成到现有的IA流程中。

我们的第一个组件是一组三个会话变量。这些会话变量允许控制室操作员根据实时需求对HITL预测验证行使更多的控制权。

接下来，我们讨论了一个可以轻松使用的“关闭开关”，它可以用来在整个现有和未来的会话中禁用和重新启用机器学习预测。如果需要紧急停止某个模型在IA中使用的所有机器学习预测，这可以派上用场。

第三个组件，机器学习模型版本控制，解决了BP中不完善的审计日志（截至版本7.1.2）引起的问题。在Web API服务中更新URL不会显示在审计日志中更改的具体URL。这意味着即使我们查看会话日志和审计日志，我们也不知道确切使用了哪个API URL或版本来进行预测。这个第三个组件通过手动版本控制机器学习模型来解决这个问题。这使我们能够通过仅查看会话日志来了解模型使用了哪个版本。

最后，我们的第四个组件是一个可以用来扩展现有IA流程的流程模板。这个组件允许我们在生产机器学习预测的同时运行额外的机器学习预测，以便对实时数据进行评估。

创建可重用模板的概念对于RPA和IA开发都极其重要。它允许标准化、简化维护和加快开发时间。在下一章中，我们将从[*第一章*](B18416_01.xhtml#_idTextAnchor015)开始，结合所有已涵盖的内容，形成一个标准化的、可重用的IA流程和对象模板。这些模板可以用来启动IA解决方案设计，并作为在您的组织中创建IA模板的基础。
