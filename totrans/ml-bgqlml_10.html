<html><head></head><body>
		<div id="_idContainer112">
			<h1 id="_idParaDest-103"><em class="italic"><a id="_idTextAnchor103"/>Chapter 7</em>: Clustering Using the K-Means Algorithm</h1>
			<p>In this chapter, we'll introduce unsupervised machine learning, and you'll learn how to use BigQuery ML to build K-Means algorithms to cluster similar data into multiple categories.</p>
			<p>Unsupervised machine learning is particularly useful when we have datasets without any labels, and we need to infer the structure of the data without any initial knowledge.</p>
			<p>In different industries, it can be very valuable to identify similar events, objects, and people according to a specific set of features. K-Means clustering is typically used to identify similar customers, documents, products, events, or items according to a specific set of characteristics.</p>
			<p>In this chapter, we'll focus our attention on the K-Means clustering algorithm, which is widely used to reveal similarities in structured and unstructured data. We'll go through all the steps required to build a K-Means clustering model, leveraging BigQuery ML.</p>
			<p>With an incremental approach, we'll go through the following topics:</p>
			<ul>
				<li>Introducing the business scenario</li>
				<li>Discovering K-Means clustering</li>
				<li>Exploring and understanding the dataset</li>
				<li>Training a K-Means clustering model</li>
				<li>Evaluating a K-Means clustering model</li>
				<li>Using a K-Means clustering model</li>
				<li>Drawing business conclusions</li>
			</ul>
			<h1 id="_idParaDest-104"><a id="_idTextAnchor104"/>Technical requirements</h1>
			<p>This chapter requires you to have access to a web browser and to be able to leverage the following:</p>
			<ul>
				<li>A <strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>) account to access the <strong class="bold">GCP</strong> console</li>
				<li>A GCP project to host the BigQuery datasets</li>
			</ul>
			<p>Now that we're ready with the technical requirements, let's dive into the analysis and development of our BigQuery ML clustering model.</p>
			<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/2Rx2Uk5">https://bit.ly/2Rx2Uk5</a></p>
			<h1 id="_idParaDest-105"><a id="_idTextAnchor105"/>Introducing the business scenario</h1>
			<p>Imagine that you are a business <a id="_idIndexMarker361"/>analyst who works for large taxi companies in Chicago. These taxi companies make thousands of trips every day to satisfy the public transport needs of the entire city. The work and the behavior of the taxi drivers are fundamental in generating revenues for companies and delivering an effective service for all customers, every day.</p>
			<p>For our business <a id="_idIndexMarker362"/>scenario, let's imagine that all the taxi companies want to give an additional reward to drivers who perform the best. The goal of the companies is to segment the drivers into three distinct categories, according to generated revenue and driving speed. The three groups can be described as follows:</p>
			<ul>
				<li>The <strong class="bold">Top Drivers</strong> are the employees with the best revenue and efficiency throughout the year. This group will receive a huge additional reward.</li>
				<li>The <strong class="bold">Good Drivers</strong> are drivers who performed well but aren't excelling. This group will not receive any reward.</li>
				<li>The <strong class="bold">Neutral Drivers</strong> are drivers with neutral or negative results in terms of revenue and efficiency.</li>
			</ul>
			<p>The parameters to identify the clusters are not known <em class="italic">a priori</em> because they can change according to different factors, such as profitability, speed, and traffic conditions. Some years are more profitable than others, and it can happen that the driving speed could be impacted by particular traffic conditions.</p>
			<p>As a business analyst, your <a id="_idIndexMarker363"/>job is to find the best algorithm to cluster the Chicago taxi drivers according to the described categories in order to classify the drivers into three clusters, according to their performance.</p>
			<p>Now that we've explained and understood the problem statement, let's take a look at the machine learning technique that we can use to predict a numerical value such as the duration of a trip.</p>
			<h1 id="_idParaDest-106"><a id="_idTextAnchor106"/>Discovering K-Means clustering</h1>
			<p>In this <a id="_idIndexMarker364"/>section, we'll understand what <strong class="bold">unsupervised learning</strong> is and we'll learn the basics of the <strong class="bold">K-Means</strong> clustering technique.</p>
			<p><strong class="bold">K-Means</strong> is an <strong class="bold">unsupervised learning</strong> algorithm <a id="_idIndexMarker365"/>that solves clustering problems. This technique is used to classify data into a set of classes. The letter <em class="italic">k</em> represents the number of clusters that are fixed <em class="italic">a priori</em>. For our business scenario, we'll use three different clusters.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">While supervised learning is based on <a id="_idIndexMarker366"/>a prior knowledge of what the output values of labels should be in a training dataset, unsupervised learning does <a id="_idIndexMarker367"/>not leverage labeled datasets. Its goal is to infer the structure of data within a training dataset, without any prior knowledge of it.</p>
			<p>Each cluster of data is <a id="_idIndexMarker368"/>characterized by a <strong class="bold">centroid</strong>. The centroid represents the midpoint of the cluster and is identified during the training stage and according to the features of the model.</p>
			<p>After the training of the K-Means clustering model, each entity can be associated with the nearest centroid and included in one of the <em class="italic">k</em> clusters.</p>
			<p>In the following diagram, you can take a look at the graphical representation of a simple clustering model based on two features and a value of <em class="italic">k</em> equals to <strong class="source-inline">3</strong>:</p>
			<div>
				<div id="_idContainer104" class="IMG---Figure">
					<img src="image/B16722_07_002.jpg" alt="Figure 7.1 – Graphical representation of K-Means clustering&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.1 – Graphical representation of K-Means clustering</p>
			<p>In the preceding <a id="_idIndexMarker369"/>Cartesian diagram, you can see some observations represented by dots. The diagram is composed of two axes that correspond to the features used to train the K-Means clustering machine learning model.</p>
			<p>According to the values of the two features, some observations are closer than others. Assuming that we need to cluster the observations into three different clusters, the K-Means model is trained to find the three areas that divide the observations into different classes.</p>
			<p>We'll not go through all the details of the K-Means clustering algorithm in this book, but we can mention some examples of use cases where this kind of algorithm is applicable. In real life, we can find a lot of scenarios that can be addressed with a clustering model, such as the following:</p>
			<ul>
				<li><strong class="bold">Customer segmentation</strong>: Finding similar customers in the customer base of a company to improve the <a id="_idIndexMarker370"/>effectiveness of marketing campaigns and promotions</li>
				<li><strong class="bold">Employee segmentation</strong>: Identifying employees <a id="_idIndexMarker371"/>with the best performance</li>
				<li><strong class="bold">Document classification</strong>: Clustering documents <a id="_idIndexMarker372"/>into multiple categories according to tags, topics, authors, and publishing dates</li>
			</ul>
			<p>In our business scenario, we'll train a K-Means clustering model based on three different clusters: <strong class="bold">top</strong>, <strong class="bold">good</strong>, and <strong class="bold">neutral</strong> drivers. To achieve our goal, we'll use information regarding the revenues <a id="_idIndexMarker373"/>generated by each taxi driver and the driving speed, calculated as the ratio between miles driven and the time spent on each ride.</p>
			<p>We've learned the basics of K-Means clustering, so now it's time to take a look at the dataset that we'll use to build our machine learning model.</p>
			<h1 id="_idParaDest-107"><a id="_idTextAnchor107"/>Exploring and understanding the dataset</h1>
			<p>Before <a id="_idIndexMarker374"/>diving into the machine learning implementation, we'll <a id="_idIndexMarker375"/>start analyzing the dataset that will be used to train our machine learning model.</p>
			<p>For this use case, we'll use the BigQuery public dataset we've already used in <a href="B16722_05_Final_ASB_ePub.xhtml#_idTextAnchor075"><em class="italic">Chapter 5</em></a>, <em class="italic">Predicting Boolean Values Using Binary Logistic Regression</em>. This dataset contains information on taxi rides collected by the <em class="italic">City of Chicago</em>, which can be found at the following link: <a href="https://console.cloud.google.com/marketplace/details/city-of-chicago-public-data/chicago-taxi-trips">https://console.cloud.google.com/marketplace/details/city-of-chicago-public-data/chicago-taxi-trips</a>.</p>
			<p>Let's start by getting a clear understanding of the information that we have in our dataset to build our K-Means clustering model.</p>
			<h2 id="_idParaDest-108"><a id="_idTextAnchor108"/>Understanding the data</h2>
			<p>In this section, we'll <a id="_idIndexMarker376"/>explore the structure of the data we'll use to develop our BigQuery ML model.</p>
			<p>To start exploring the data, we need to do the following:</p>
			<ol>
				<li value="1">Log in to GCP and access the <strong class="bold">BigQuery</strong> user interface from the navigation menu.</li>
				<li>Create a new dataset under the project that we created in <a href="B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039"><em class="italic">Chapter 2</em></a>, <em class="italic">Setting Up Your GCP and BigQuery Environment</em>. For this use case, we'll create a <strong class="source-inline">07_chicago_taxi_drivers</strong> dataset with default options.</li>
				<li>Open the <strong class="source-inline">bigquery-public-data</strong> GCP project that hosts all the BigQuery public datasets and browse the items until we find the <strong class="source-inline">chicago_taxi_trips</strong> dataset. In this public dataset, we <a id="_idIndexMarker377"/>can see only one BigQuery table: <strong class="source-inline">taxi_trips</strong>. This table contains all the information about taxi rides happening in the city of Chicago, and we'll use it to train and test our K-Means clustering model.</li>
			</ol>
			<p>We've already used the same data in <a href="B16722_05_Final_ASB_ePub.xhtml#_idTextAnchor075"><em class="italic">Chapter 5</em></a>, <em class="italic">Predicting Boolean Values Using Binary Logistic Regression</em>. For this reason, we already know the overall schema of the <strong class="source-inline">taxi_trips</strong> table and its fields.</p>
			<p>In the following screenshot, you can see the full list of fields belonging to the <strong class="source-inline">taxi_trips</strong> table:</p>
			<div>
				<div id="_idContainer105" class="IMG---Figure">
					<img src="image/B16722_07_003.jpg" alt="Figure 7.2 – The list of fields belonging to the taxi_trips table&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.2 – The list of fields belonging to the taxi_trips table</p>
			<p>For this use case, we focus <a id="_idIndexMarker378"/>our attention on the following fields that will be used in the creation of our machine learning model:</p>
			<ul>
				<li><strong class="source-inline">trip_miles</strong>: Contains the number of miles traveled by the taxi driver during a specific ride.</li>
				<li><strong class="source-inline">trip_seconds</strong>: Represents the duration of each taxi ride, expressed in seconds.</li>
				<li><strong class="source-inline">fare</strong>: This is the fee paid by the customer to the taxi driver and represents the income of the driver.</li>
				<li><strong class="source-inline">tips</strong>: This column contains the value of the tip that the taxi driver received from the customer.</li>
			</ul>
			<p>We deliberately ignore other columns related to the cost of the taxi ride, such as <strong class="source-inline">tolls</strong> and <strong class="source-inline">extras</strong>, because these <a id="_idIndexMarker379"/>values are not directly impacted by the taxi driver's activity.</p>
			<p>In this section, we've selected the table and columns that will be used to train our machine learning model. Now, it's time to look at the data so that we can understand how to use it.</p>
			<h2 id="_idParaDest-109"><a id="_idTextAnchor109"/>Checking the data quality</h2>
			<p>In this section, we'll apply <a id="_idIndexMarker380"/>some data quality checks before developing our machine learning model.</p>
			<p>The quality of data is fundamental to building effective K-Means clustering models. Since the goal is to cluster observations into multiple categories, outliers in the data can create unbalanced clusters, based on incorrect values in the data.</p>
			<p>Let's start analyzing the dataset that will be used to build our machine learning model, as follows:</p>
			<ol>
				<li value="1">In order to identify the time frame of our dataset, let's extract the minimum and maximum value of the <strong class="source-inline">trip_start_timestamp</strong> field, like this:<p class="source-code">SELECT MAX(trip_start_timestamp),</p><p class="source-code">       MIN(trip_start_timestamp)</p><p class="source-code">FROM</p><p class="source-code">`bigquery-public-data.chicago_taxi_trips.taxi_trips`;</p><p>On <a id="_idIndexMarker381"/>executing this <strong class="bold">Structured Query Language</strong> (<strong class="bold">SQL</strong>) statement, we can notice that the data ranges from <strong class="source-inline">2013</strong> to <strong class="source-inline">2020</strong>.</p><p>The result of the query is presented in the following screenshot:</p><div id="_idContainer106" class="IMG---Figure"><img src="image/B16722_07_004.jpg" alt="Figure 7.3 – The result of the query shows the time frame of the dataset&#13;&#10;"/></div><p class="figure-caption">Figure 7.3 – The result of the query shows the time frame of the dataset</p><p>To address our business scenario, we can focus our attention on the taxi rides that occurred in <strong class="source-inline">2020</strong>.</p></li>
				<li>In the second step, we'll inspect the maximum values of the speed (expressed in miles <a id="_idIndexMarker382"/>per hour) and of a taxi driver's income. Let's execute the follow<a id="_idTextAnchor110"/>ing query:<p class="source-code">SELECT MAX (speed_mph), MAX (tot_income)</p><p class="source-code">FROM (</p><p class="source-code">      SELECT taxi_id,</p><p class="source-code">             AVG(trip_miles/(trip_seconds/60/60)) AS speed_mph,</p><p class="source-code">             SUM (fare+tips) AS tot_income</p><p class="source-code">      FROM `bigquery-public-data.chicago_taxi_trips.taxi_trips` </p><p class="source-code">      WHERE </p><p class="source-code">            EXTRACT(YEAR from trip_start_timestamp) = 2020</p><p class="source-code">            AND trip_seconds &gt; 0</p><p class="source-code">            AND trip_miles &gt;0</p><p class="source-code">            AND fare &gt; 0</p><p class="source-code">      GROUP BY taxi_id);</p><p>The internal <strong class="source-inline">SELECT</strong> statement calculates the average speed, dividing the value of the <strong class="source-inline">trip_miles</strong> field and the duration of the ride expressed in hours <strong class="source-inline">(trip_seconds/60/60)</strong>. The calculated value is stored in the <strong class="source-inline">speed_mph</strong> column. It also creates the <strong class="source-inline">tot_income</strong> field, which sums up the <strong class="source-inline">fare</strong> and <strong class="source-inline">tips</strong> values for each <strong class="source-inline">taxi_id</strong> field. With the <strong class="source-inline">EXTRACT(YEAR from trip_start_timestamp) = 2020</strong> filter, we're selecting only the taxi rides that occurred in <strong class="source-inline">2020</strong>. Adding filters on the <strong class="source-inline">trip_seconds</strong>, <strong class="source-inline">trip_miles</strong>, and <strong class="source-inline">fare</strong> fields, we're also excluding all the empty and <strong class="source-inline">NULL</strong> values that <a id="_idIndexMarker383"/>can occur in the dataset. The most external <strong class="source-inline">SELECT</strong> statement identifies the maximum values of the average speed and of the income, using the <strong class="source-inline">MAX (speed_mph), MAX (tot_income)</strong> keywords.</p><p>The result of the query is presented in the following screenshot:</p></li>
			</ol>
			<div>
				<div id="_idContainer107" class="IMG---Figure">
					<img src="image/B16722_07_005.jpg" alt="Figure 7.4 – The result of the query shows outliers in terms of speed and income&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.4 – The result of the query shows outliers in terms of speed and income</p>
			<p>From the results, it's quite clear that the dataset contains some outliers that are not compatible with the actual use case. In fact, the maximum average speed is about 667 miles per hour, and the maximum income for a taxi driver is more than 1 million <strong class="bold">US dollars</strong> (<strong class="bold">USD</strong>).</p>
			<p>The query that we've just executed points out that there are some unrealistic values in our dataset that need to be filtered out in the next steps.</p>
			<p>Now that <a id="_idIndexMarker384"/>we've performed some quality checks on our dataset, let's focus on creating our training datasets.</p>
			<h2 id="_idParaDest-110"><a id="_idTextAnchor111"/>Creating the training datasets</h2>
			<p>For <a id="_idIndexMarker385"/>K-Means clustering, we only need to create a dataset that will be used to train and test the machine learning model. </p>
			<p>Let's start creating our datasets that will be used to train two different K-Means clustering models, as follows:</p>
			<ol>
				<li value="1">First of all, let's create a table that contains only the <strong class="source-inline">speed_mph</strong> field as an input feature for our K-Means clustering model, by running the following code:<p class="source-code">CREATE OR REPLACE TABLE `07_chicago_taxi_drivers.taxi_miles_per_minute` AS </p><p class="source-code">SELECT *</p><p class="source-code">FROM (</p><p class="source-code">                SELECT taxi_id,</p><p class="source-code">                         AVG(trip_miles/(trip_seconds/60/60)) AS speed_mph</p><p class="source-code">                FROM `bigquery-public-data.chicago_taxi_trips.taxi_trips` </p><p class="source-code">                WHERE </p><p class="source-code">                      EXTRACT(YEAR from trip_start_timestamp) = 2020</p><p class="source-code">                       AND trip_seconds &gt; 0</p><p class="source-code">                       AND trip_miles &gt;0</p><p class="source-code">                GROUP BY taxi_id</p><p class="source-code">      )</p><p class="source-code">WHERE </p><p class="source-code">      speed_mph BETWEEN 0 AND 50;</p><p>The query creates the <strong class="source-inline">taxi_miles_per_minute</strong> table in the <strong class="source-inline">07_chicago_taxi_drivers</strong> dataset.</p><p>The table contains two different fields: the identifier of the taxi in the <strong class="source-inline">taxi_id</strong> column, and the average speed (expressed in miles per hour) in the <strong class="source-inline">speed_mph</strong> field. The average speed is calculated for each <strong class="source-inline">taxi_id</strong> field present in the <strong class="source-inline">taxi_trips</strong> table, using the <strong class="source-inline">GROUP BY taxi_id</strong> clause. The new table includes only the taxi rides that occurred in 2020.</p><p>The last two <a id="_idIndexMarker386"/>lines of the query contain the <strong class="source-inline">WHERE</strong> clause that is used to filter out outliers. We're assuming that the maximum realistic average speed is <strong class="source-inline">50</strong> miles per hour.</p></li>
				<li>In the second step, we'll create another table to host the additional feature (namely, <strong class="source-inline">tot_income</strong>), as follows:<p class="source-code">CREATE OR REPLACE TABLE `07_chicago_taxi_drivers.taxi_speed_and_income` AS</p><p class="source-code">SELECT *</p><p class="source-code">FROM (</p><p class="source-code">        SELECT taxi_id,</p><p class="source-code">                AVG(trip_miles/(trip_seconds/60/60)) AS speed_mph,</p><p class="source-code">               SUM (fare+tips) AS tot_income</p><p class="source-code">        FROM `bigquery-public-data.chicago_taxi_trips.taxi_trips` </p><p class="source-code">        WHERE </p><p class="source-code">              EXTRACT(YEAR from trip_start_timestamp) = 2020</p><p class="source-code">              AND trip_seconds &gt; 0</p><p class="source-code">              AND trip_miles &gt;0</p><p class="source-code">              AND fare &gt; 0</p><p class="source-code">        GROUP BY taxi_id</p><p class="source-code">      )</p><p class="source-code">WHERE </p><p class="source-code">      speed_mph BETWEEN 0 AND 50</p><p class="source-code">      AND tot_income BETWEEN 0 AND 150000;</p><p>The execution of the query generates a <strong class="source-inline">taxi_speed_and_income</strong> table. This table includes the <strong class="source-inline">speed_mph</strong> field calculated with the same rules of <em class="italic">Step 1</em>. The table also includes the <strong class="source-inline">tot_income</strong> field. This value is calculated as the <strong class="source-inline">SUM</strong> of the <strong class="source-inline">fare</strong> and the <strong class="source-inline">tips</strong> for each <strong class="source-inline">taxi_id</strong> field and for the entire duration of 2020.</p><p>Compared to <a id="_idIndexMarker387"/>the table created in <em class="italic">Step 1</em>, we've added another filter that limits the annual <strong class="source-inline">tot_income</strong> value to 150,000.</p><p>This second table will be used to create another K-Means clustering machine learning model based on the two <strong class="source-inline">speed_mph</strong> and <strong class="source-inline">tot_income</strong> features.</p></li>
			</ol>
			<p>Now that we've created the tables on which our BigQuery ML model will be trained, let's dive into the creation of the machine learning model.</p>
			<h1 id="_idParaDest-111"><a id="_idTextAnchor112"/>Training the K-Means clustering model</h1>
			<p>In this section, we'll <a id="_idIndexMarker388"/>create two different K-Means machine learning models. The first model will be created using <strong class="source-inline">taxi_miles_per_minute</strong> as a training dataset, while the second will include also <strong class="source-inline">tot_income</strong> as a feature and will leverage <strong class="source-inline">taxi_speed_and_income</strong>. Let's proceed as follows:</p>
			<ol>
				<li value="1">As a first step, let's start training a machine learning model named <strong class="source-inline">clustering_by_speed</strong> by running the following code:<p class="source-code">CREATE OR REPLACE MODEL `07_chicago_taxi_drivers.clustering_by_speed`</p><p class="source-code">OPTIONS(model_type='kmeans', num_clusters=3, kmeans_init_method = 'KMEANS++') AS</p><p class="source-code">  SELECT * EXCEPT (taxi_id)</p><p class="source-code">  FROM `07_chicago_taxi_drivers.taxi_miles_per_minute`;</p><p>The first lines of the SQL statement are composed of the <strong class="source-inline">CREATE OR REPLACE MODEL</strong> keywords, followed by the identifier of the  <strong class="source-inline">`07_chicago_taxi_drivers.clustering_by_speed`</strong> machine learning model and the <strong class="source-inline">OPTIONS</strong> clause.</p><p>Now, let's take a look at the options that we've used to train the machine learning model. The selected model type is <strong class="source-inline">'kmeans'</strong>. This option describes the technique that we're using to train the model. The <strong class="source-inline">num_clusters</strong> option is valued at <strong class="source-inline">3</strong> because we're trying to classify observations into three different clusters: <em class="italic">Top</em>, <em class="italic">Good</em>, and <em class="italic">Neutral</em>.</p><p>By default, BigQuery <a id="_idIndexMarker389"/>ML starts the training of the K-Means clustering algorithm with a random starting point. The quality of the machine learning model also depends on this point, which is randomly chosen by BigQuery. By using the <strong class="source-inline">kmeans_init_method = 'KMEANS++'</strong> option, the point is <a id="_idIndexMarker390"/>initialized leveraging the <strong class="bold">K-Means++</strong> algorithm. This type of algorithm is able to produce better and repeatable results by selecting the starting points for the training stage. It's always recommended to use 'KMEANS++' as the initialization method.</p><p>The training of the model is based on all the columns of the <strong class="source-inline">taxi_miles_per_minute</strong> table except for the <strong class="source-inline">taxi_id</strong> column, which will only be used during the prediction phase.</p></li>
				<li>After the training of the first machine learning model, let's train a second one, which also includes the <strong class="source-inline">tot_income</strong> value of the taxi driver during the year, as illustrated in the following code snippet:<p class="source-code">CREATE OR REPLACE MODEL `07_chicago_taxi_drivers.clustering_by_speed_and_income`</p><p class="source-code">OPTIONS(model_type='kmeans', num_clusters=3, standardize_features = true, kmeans_init_method = 'KMEANS++') AS</p><p class="source-code">  SELECT * EXCEPT (taxi_id)</p><p class="source-code">  FROM `07_chicago_taxi_drivers.taxi_speed_and_income`;</p><p>This query is very similar to the SQL statement executed for the creation of the previous K-Means clustering model, but we can immediately notice a relevant difference. The <strong class="source-inline">clustering_by_speed_and_income</strong> model is trained using an <a id="_idIndexMarker391"/>additional option, <strong class="source-inline">standardize_features = true</strong>. This option is particularly useful when you have numeric features with different orders of magnitude. In this case, the model is using the <strong class="source-inline">speed_mph</strong> field (which goes from 0 to 50) and the <strong class="source-inline">tot_income</strong> field, which can reach a value of 150,000.</p></li>
			</ol>
			<p>Now that we've trained two different machine learning models based on the K-Means clustering algorithm, let's take a look at how we can evaluate them leveraging BigQuery ML SQL syntax <a id="_idIndexMarker392"/>and the BigQuery <strong class="bold">user interface</strong> (<strong class="bold">UI</strong>).</p>
			<h1 id="_idParaDest-112"><a id="_idTextAnchor113"/>Evaluating the K-Means clustering model</h1>
			<p>In this section, we'll learn <a id="_idIndexMarker393"/>how to evaluate the performance of our K-Means clustering model.</p>
			<p>The evaluation stage of a K-Means clustering model is different from the supervised machine learning models that we've performed in the previous chapters. Let's take a look at the steps we need to take to evaluate our machine learning model, as follows:</p>
			<ol>
				<li value="1">Let's extract the centroids from the first machine learning model that we trained in the previous section, by running the following code:<p class="source-code">SELECT *</p><p class="source-code">FROM ML.CENTROIDS</p><p class="source-code">        (MODEL `07_chicago_taxi_drivers.clustering_by_speed`)</p><p class="source-code">ORDER BY centroid_id;</p><p>The <strong class="source-inline">ML.CENTROIDS</strong> function returns information about the centroids of the K-Means model. It accepts <a id="_idIndexMarker394"/>the model name as input in the round brackets, preceded by the <strong class="source-inline">MODEL</strong> keyword.</p><p class="callout-heading">Important note</p><p class="callout">A centroid represents the center of a cluster in a K-Means clustering model. During the training phase of the machine learning model, the centroids are iteratively optimized to minimize the distance between centroids and observations in the training dataset. When the training stage ends, the centroids are stabilized. BigQuery ML stops iterating when the relative loss improvement is less than the value specified for the <strong class="source-inline">MIN_REL_PROGRESS</strong> parameter.</p><p>The execution of the query returns three centroids, as shown in the following screenshot:</p><div id="_idContainer108" class="IMG---Figure"><img src="image/B16722_07_006.jpg" alt="Figure 7.5 – The result of the query shows the centroids identified by the machine learning model&#13;&#10;"/></div><p class="figure-caption">Figure 7.5 – The result of the query shows the centroids identified by the machine learning model</p><p>In this case, each <a id="_idIndexMarker395"/>centroid is represented only by the numerical value of the <strong class="source-inline">speed_mph</strong> feature that represents the average speed of the taxi driver.</p></li>
				<li>The same information can be achieved leveraging the BigQuery UI. Selecting the <strong class="source-inline">clustering_by_speed</strong> model from the BigQuery navigation menu and accessing the <strong class="bold">Evaluation</strong> tab, we can see the three different centroids, as illustrated in the following screenshot:<div id="_idContainer109" class="IMG---Figure"><img src="image/B16722_07_007.jpg" alt="Figure 7.6 – The Evaluation tab of the clustering_by_speed BigQuery ML model&#13;&#10;"/></div><p class="figure-caption">Figure 7.6 – The Evaluation tab of the clustering_by_speed BigQuery ML model</p><p>The <a id="_idIndexMarker396"/>centroid with <strong class="bold">Centroid Id</strong> equals to <strong class="source-inline">1</strong> belongs to the first cluster and represents the taxi drivers with the best average speed: the <em class="italic">Top Drivers</em>. From the BigQuery UI, we can also notice that 869 taxi drivers belong to this cluster.</p><p>The second centroid includes most of the population, with a <strong class="source-inline">speed_mph</strong> value of 14.3222. This centroid is the center of the <em class="italic">Good Drivers</em> cluster.</p><p>The last centroid is the center of the cluster with the slowest drivers and includes 425 observations in the <em class="italic">Neutral Drivers</em> cluster.</p></li>
				<li>If we choose to analyze the <strong class="source-inline">clustering_by_speed_and_income</strong> model from the <strong class="bold">Evaluation</strong> tab in the BigQuery UI, we'll see the following information:<div id="_idContainer110" class="IMG---Figure"><img src="image/B16722_07_008.jpg" alt="Figure 7.7 – The Evaluation tab of the clustering_by_speed_and_income BigQuery ML model&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption"> </p>
			<p class="figure-caption">Figure 7.7 – The Evaluation tab of the clustering_by_speed_and_income BigQuery ML model</p>
			<p>Looking at the <a id="_idIndexMarker397"/>clusters and centroids identified by this second model, we can immediately notice that the clusters are based on two different features: <strong class="source-inline">speed_mph</strong> and <strong class="source-inline">tot_income</strong>.</p>
			<p>The first cluster, with <strong class="bold">Centroid Id</strong> equal to <strong class="source-inline">1</strong>, includes the best 466 drivers in terms of speed and annual income: <em class="italic">Top Drivers</em>. The second one contains the 417 <em class="italic">Neutral Drivers</em> with the poorest performance. The last centroid includes the majority of the drivers and is the <em class="italic">Good Drivers</em> cluster.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">The result of training different iterations of K-Means clustering can generate different values, according to the initialization seeds that are used by BigQuery ML. It could happen that the positions of the centroids are different from the values shown in this section.</p>
			<p>Now that we've taken a <a id="_idIndexMarker398"/>look at the results created by the training of the K-Means clustering models, let's start using them to classify taxi drivers into different clusters.</p>
			<h1 id="_idParaDest-113"><a id="_idTextAnchor114"/>Using the K-Means clustering model</h1>
			<p>In this section, we'll <a id="_idIndexMarker399"/>understand how to use our K-Means clustering model on new data.</p>
			<p>To use our BigQuery ML model, we'll use the <strong class="source-inline">ML.PREDICT</strong> function on the same table that we've created to train the machine learning model.</p>
			<p>In this case, we'll also include the <strong class="source-inline">taxi_id</strong> column, which identifies each taxi driver. The following query will classify each <strong class="source-inline">taxi_id</strong> field to the nearest cluster, according to the values of the <strong class="source-inline">speed_mph</strong> and <strong class="source-inline">tot_income</strong> fields:</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">  * EXCEPT(nearest_centroids_distance)</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.PREDICT( MODEL `07_chicago_taxi_drivers.clustering_by_speed_and_income`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">      SELECT *</p>
			<p class="source-code">      FROM</p>
			<p class="source-code">        `07_chicago_taxi_drivers.taxi_speed_and_income`</p>
			<p class="source-code">    ));</p>
			<p>The query statement is composed of a <strong class="source-inline">SELECT</strong> keyword that extracts all the columns returned by the <strong class="source-inline">ML.PREDICT</strong> function, except for the <strong class="source-inline">nearest_centroids_distance</strong> field.</p>
			<p>The execution <a id="_idIndexMarker400"/>of the query generates the result shown in the following screenshot:</p>
			<div>
				<div id="_idContainer111" class="IMG---Figure">
					<img src="image/B16722_07_009.jpg" alt="Figure 7.8 – The result of the query shows the application of the K-Means clustering model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.8 – The result of the query shows the application of the K-Means clustering model</p>
			<p>Each <strong class="source-inline">taxi_id</strong> field is assigned to a specific centroid and to the corresponding cluster. The assignment is visible from the first column, <strong class="source-inline">CENTROID_ID</strong>.</p>
			<p>Now that we've applied our model, let's formulate some final considerations and provide a list of taxi drivers that can be rewarded because they're in the <em class="italic">Top Drivers</em> cluster.</p>
			<h1 id="_idParaDest-114"><a id="_idTextAnchor115"/>Drawing business conclusions</h1>
			<p>In this section, we'll <a id="_idIndexMarker401"/>formulate some final considerations using the results that we got from the application of our machine learning model.</p>
			<p>Using the query executed in the <em class="italic">Using the K-Means clustering model</em> section, we can create a table that contains the <em class="italic">Top Drivers</em> identified by the <strong class="source-inline">clustering_by_speed_and_income</strong> K-Means machine learning model, as follows:</p>
			<p class="source-code">CREATE OR REPLACE TABLE `07_chicago_taxi_drivers.top_taxi_drivers_by_speed_and_income` AS</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">  * EXCEPT(nearest_centroids_distance)</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.PREDICT( MODEL `07_chicago_taxi_drivers.clustering_by_speed_and_income`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">      SELECT *</p>
			<p class="source-code">      FROM</p>
			<p class="source-code">        `07_chicago_taxi_drivers.taxi_speed_and_income`</p>
			<p class="source-code">    ))</p>
			<p class="source-code">WHERE CENTROID_ID=1; </p>
			<p>The execution <a id="_idIndexMarker402"/>of the query generates a <strong class="source-inline">top_taxi_drivers_by_speed_and_income</strong> table that contains all the drivers classified in the cluster with <strong class="source-inline">CENTRO<a id="_idTextAnchor116"/>ID_ID=1</strong> and corresponding to the <em class="italic">Top Drivers</em> cluster. Keep in mind that the K-Means clustering algorithm doesn't always return the same segmentations. For this reason, the clause <strong class="source-inline">CENTROID_ID=1</strong> can vary according to the results generated by each training stage.</p>
			<p>This result set includes the identifiers of the taxi drivers that should be rewarded for their performances.</p>
			<h1 id="_idParaDest-115"><a id="_idTextAnchor117"/>Summary</h1>
			<p>In this chapter, we've built our unsupervised machine learning model. After a brief introduction of the business scenario, we've discovered what unsupervised machine learning is and used the K-Means clustering algorithm to group similar observations within the same clusters.</p>
			<p>Before diving into the development of the machine learning models, we applied some data quality checks to our dataset and selected the fields to use as features of our machine learning models.</p>
			<p>During the training stage, we trained two different machine learning models to learn how to create a K-Means clustering model.</p>
			<p>Then, we evaluated the two models, leveraging BigQuery ML SQL syntax and the functionalities available in the BigQuery UI.</p>
			<p>In the last step, we tested our machine learning model to cluster the taxi drivers available in the dataset according to their features and into the clusters generated by the K-Means model.</p>
			<p>Finally, we've also created a list of drivers belonging to the <em class="italic">Top Drivers</em> cluster that can be rewarded because they can be considered top performers against the average of the other drivers.</p>
			<p>In the next chapter, we'll introduce forecasting, using time series data.</p>
			<h1 id="_idParaDest-116"><a id="_idTextAnchor118"/>Further resources</h1>
			<ul>
				<li><strong class="bold">Chicago Taxi Trips public dataset</strong>: <a href="https://console.cloud.google.com/marketplace/details/city-of-chicago-public-data/chicago-taxi-trips">https://console.cloud.google.com/marketplace/details/city-of-chicago-public-data/chicago-taxi-trips</a></li>
				<li><strong class="bold">Chicago Open Data</strong>: <a href="https://data.cityofchicago.org/">https://data.cityofchicago.org/</a></li>
				<li><strong class="bold">BigQuery ML</strong> <strong class="source-inline">CREATE MODEL</strong> <strong class="bold">statement</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create</a></li>
				<li><strong class="bold">BigQuery</strong> <strong class="source-inline">ML.EVALUATE</strong> <strong class="bold">function</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery</strong>  <strong class="source-inline">ML.PREDICT</strong> <strong class="bold">function</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict</a></li>
				<li><strong class="bold">BigQuery ML K-Means clustering example</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/kmeans-tutorial">https://cloud.google.com/bigquery-ml/docs/kmeans-tutorial</a></li>
			</ul>
		</div>
	</body></html>