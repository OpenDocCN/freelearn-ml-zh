<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><div id="_idContainer093">
			<h1 id="_idParaDest-48" class="chapter-number"><a id="_idTextAnchor048"/>3</h1>
			<h1 id="_idParaDest-49"><a id="_idTextAnchor049"/>Code Stages</h1>
			<p>While Python is the dominant language used for ML, Microsoft is making heavy investments in AI, and not just through its investments in OpenAI and ChatGPT. Microsoft is actively expanding support for ML development in VB.NET and C# through the open source <strong class="bold">ML.NET</strong> framework. In this chapter, we’ll be looking at how to set up BP to use ML.NET through <span class="No-Break"><strong class="bold">Code Stages</strong></span><span class="No-Break">.</span></p>
			<p>In my research, random forests were the most commonly cited family of algorithms used in IA, followed by deep learning and gradient boosting. All of these algorithms have implementations in ML.NET. Random forests and gradient-boosting algorithms can realistically be used on digital workers to produce timely predictions. Deep learning may not be a good candidate for training and predicting the Digital Worker itself due to computation and <span class="No-Break">GPU requirements.</span></p>
			<p>This chapter features three examples that build on one another. They are modeled after a real-life scenario. Imagine that an ML model (binary classification for sentiment analysis) has been built by data scientists using ML.NET. The model has been reviewed and accepted for an IA use case and an IA team needs to take ownership of the model maintenance and source code going forward. In our examples, we will be going over the steps to successfully get the ML code running <span class="No-Break">in BP.</span></p>
			<p>We will cover the following topics in <span class="No-Break">this chapter:</span></p>
			<ul>
				<li>Setting up ML.NET <span class="No-Break">in BP</span></li>
				<li>Importing the <span class="No-Break">C# code</span></li>
				<li>Improving <span class="No-Break">BP integration</span></li>
			</ul>
			<h1 id="_idParaDest-50"><a id="_idTextAnchor050"/>Technical requirements</h1>
			<p>Download and import the three files in the <strong class="source-inline">ch3</strong> folder on GitHub at <a href="https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/tree/main/ch3">https://github.com/PacktPublishing/Intelligent-Automation-with-Blue-Prism/tree/main/ch3</a>. Note that two of the files have the file extension <strong class="source-inline">.bpobject</strong>, and they need importing as <strong class="source-inline">Process / Object</strong>. Additional setup steps will be performed as part of <span class="No-Break">the examples.</span></p>
			<h1 id="_idParaDest-51"><a id="_idTextAnchor051"/>Setting up ML.NET in BP</h1>
			<p>ML.NET can be used <a id="_idIndexMarker234"/>natively inside of BP code stages. While you have a choice between C# and VB.net in BP, almost all of the documentation on the Internet is written for C#. The examples in this chapter will also <span class="No-Break">use C#.</span></p>
			<p>Possibly the biggest challenge that developers face when trying to use ML.NET is getting all of the <strong class="bold">assemblies</strong> (or <strong class="source-inline">.dll</strong> files) imported and <strong class="bold">namespaces</strong> correct. Most of the time, you’ll receive code that was developed in Visual Studio or<a id="_idIndexMarker235"/> another <strong class="bold">integrated development environment</strong> (<strong class="bold">IDE</strong>). These IDEs automatically download and manage the <strong class="source-inline">.dll</strong> dependencies in the project for the developer. BP unfortunately doesn’t have a feature to do the same. In BP, getting the assembly imports and namespaces working is largely through trial and error and checking documentation. We iteratively add new <strong class="source-inline">.dll</strong> files or namespaces and check for changes in the errors displayed <span class="No-Break">in BP.</span></p>
			<p>Since only Business Objects (not Processes) can have Code Stages, the contents of this chapter only apply <span class="No-Break">to objects.</span></p>
			<h2 id="_idParaDest-52"><a id="_idTextAnchor052"/>Adding references and namespaces to BP</h2>
			<p>The area to add <strong class="source-inline">.dll</strong> files and <a id="_idIndexMarker236"/>namespaces<a id="_idIndexMarker237"/> is in the Object’s Properties in the <strong class="bold">Code Options</strong> tab. To access an Object’s properties, visit the <strong class="bold">Initialise</strong> Page. By default, to the left of the <strong class="bold">Start</strong> Stage, there’s a rectangle containing the Object’s name, the creation date, and the last changed date. Right-click this rectangle and <span class="No-Break">choose </span><span class="No-Break"><strong class="bold">Properties</strong></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/B18416_03_1.jpg" alt="Figure 3.1 – Accessing an Object’s properties from the Initialise Page" width="1219" height="1094"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1 – Accessing an Object’s properties from the Initialise Page</p>
			<p>An alternate way of <a id="_idIndexMarker238"/>opening<a id="_idIndexMarker239"/> the Object’s Properties is to double-click the white rectangle. With the <strong class="bold">Properties</strong> window open, you’ll see a <strong class="bold">Code Options</strong> tab. The <strong class="bold">Code Options</strong> tab is where external assemblies and namespaces can be added. The code language (<strong class="bold">C#</strong>, <strong class="bold">Visual Basic</strong>, or <strong class="bold">Visual J#</strong>) can also be <span class="No-Break">selected here.</span></p>
			<div>
				<div id="_idContainer068" class="IMG---Figure">
					<img src="image/B18416_03_2.jpg" alt="Figure 3.2 – The Code Options tab of an Object’s Properties" width="1327" height="1126"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2 – The Code Options tab of an Object’s Properties</p>
			<p>While <span class="No-Break"><em class="italic">Figure 3</em></span><em class="italic">.2</em> shows <strong class="bold">External References</strong> as just the name of the <strong class="source-inline">.dll</strong> file, you can also specify them by providing the full <a id="_idIndexMarker240"/>path. If you<a id="_idIndexMarker241"/> don’t see the full path to the <strong class="source-inline">.dll</strong>, this means that the assembly is either stored in the BP installation folder or somewhere on the Windows path. The <strong class="bold">Namespace Imports</strong> section is what’s used to replace <strong class="source-inline">using</strong> statements in C#, typically after adding the <span class="No-Break">corresponding assembly.</span></p>
			<p>Next, let’s look at our first example, where we will add <strong class="bold">External References</strong> and <strong class="bold">Namespace Imports</strong> to an Object. We will be doing five <span class="No-Break">high-level steps:</span></p>
			<ol>
				<li>Examining existing <strong class="source-inline">using</strong> statements in the <span class="No-Break">source code</span></li>
				<li>Downloading the ML.NET package <span class="No-Break">from NuGet</span></li>
				<li>Extracting the <strong class="source-inline">.dll</strong> files from the <span class="No-Break">NuGet package</span></li>
				<li>Copying the <strong class="source-inline">.dll</strong> files to the BP <span class="No-Break">installation folder</span></li>
				<li>Adding references and namespaces to the <strong class="bold">Code </strong><span class="No-Break"><strong class="bold">Options</strong></span><span class="No-Break"> tab</span></li>
			</ol>
			<p>The overall goal for<a id="_idIndexMarker242"/> this example <a id="_idIndexMarker243"/>is to get BP working with ML.NET as much as we can before adding in the actual C# code in <span class="No-Break">Code Stages.</span></p>
			<h2 id="_idParaDest-53"><a id="_idTextAnchor053"/>Example 1 – preparation work before BP</h2>
			<p>Recall the scenario introduced at the <a id="_idIndexMarker244"/>beginning of the chapter. We’re tasked with moving C# ML code into BP. There are two ways to <a id="_idIndexMarker245"/>approach determining which <strong class="source-inline">.dll</strong> libraries need to be imported. The first way is to copy all of the source code into a Code Stage and see what error messages appear. The other (and probably smarter) way is to examine the project’s source code first. This gets us familiar with the code base and gives us an idea of what <strong class="source-inline">.dll</strong> files and namespaces need to be added. We will be doing the <span class="No-Break">latter here.</span></p>
			<p>Our starting source code comes from <span class="No-Break">Microsoft’s GitHub:</span></p>
			<p><a href="https://github.com/dotnet/machinelearning-samples/tree/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis"><span class="No-Break">https://github.com/dotnet/machinelearning-samples/tree/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis</span></a></p>
			<h3>Examining the C# source files for using statements</h3>
			<p>In the Microsoft GitHub project, there <a id="_idIndexMarker246"/>are only three C# source files. Let’s examine each one and note any <strong class="source-inline">.dll</strong> files that might need to <span class="No-Break">be imported:</span></p>
			<ol>
				<li>Open the first source file at <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/Program.cs">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/Program.cs</a>. The <strong class="source-inline">using</strong> statements are in the first six lines of <span class="No-Break">the file:</span><pre class="source-code">
using System;
using System.IO;
using Microsoft.ML;
using SentimentAnalysisConsoleApp.DataStructures;
using Common;
using static Microsoft.ML.DataOperationsCatalog;</pre></li>			</ol>
			<p>Of not are <strong class="source-inline">Microsoft.ML</strong> and <strong class="source-inline">Microsoft.ML.DataOperationsCatalog</strong>. <strong class="source-inline">SentimentAnalysisConsoleApp.DataStructures</strong> is a self-reference to the current project as opposed to an <span class="No-Break">external library.</span></p>
			<ol>
				<li>Open the second source file at <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentIssue.cs">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentIssue.cs</a>. There’s only one <strong class="source-inline">using</strong> statement <span class="No-Break">for </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.Data</strong></span><span class="No-Break">.</span></li>
				<li>Open the final source file at <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentPrediction.cs">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentPrediction.cs</a>. Again, we only <span class="No-Break">see </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.Data</strong></span><span class="No-Break">.</span></li>
			</ol>
			<p>We’ve found three<a id="_idIndexMarker247"/> notable <strong class="source-inline">using</strong> statements by examining the source files: <strong class="source-inline">Microsoft.ML</strong>, <strong class="source-inline">Microsoft.ML.Data</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.DataOperationsCatalog</strong></span><span class="No-Break">.</span></p>
			<h3>Examining the .csproj file for PackageReferences</h3>
			<p>The <strong class="source-inline">.csproj</strong> file can also contain <a id="_idIndexMarker248"/>references to external libraries that need importing. Open <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/SentimentAnalysisConsoleApp.csproj">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/SentimentAnalysisConsoleApp.csproj</a> and search for the term <strong class="source-inline">PackageReference</strong>. See that there’s only one line <span class="No-Break">containing </span><span class="No-Break"><strong class="source-inline">Microsoft.ML</strong></span><span class="No-Break">.</span></p>
			<p>At this point, we’ve finished examining the C# project code for <strong class="source-inline">using</strong> statements. This revealed the need to add <strong class="source-inline">Microsoft.ML</strong>, <strong class="source-inline">Microsoft.ML.Data</strong>, and <strong class="source-inline">Microsoft.ML.DataOperationsCatalog</strong>. The <strong class="source-inline">.csproj</strong> file reconfirmed the need to add <strong class="source-inline">Microsoft.ML</strong>. Now that we have an idea of which libraries we need to add, let’s download them <span class="No-Break">from NuGet.</span></p>
			<h3>Downloading ML.NET from NuGet</h3>
			<p>NuGet is the package manager <a id="_idIndexMarker249"/>for .NET. In traditional software development, <strong class="source-inline">.dll</strong> management and dependencies are usually handled by your IDE. This functionality is unfortunately missing from BP, so we’ll need to manually download packages from the <span class="No-Break">NuGet website:</span></p>
			<ol>
				<li>Open <a href="https://www.nuget.org/">https://www.nuget.org/</a> in your web browser. Search for <strong class="source-inline">ML.NET</strong>. Click on the result <span class="No-Break">named </span><span class="No-Break"><strong class="bold">Microsoft.ML</strong></span><span class="No-Break">.</span></li>
				<li>Click on version <strong class="bold">2.0.1</strong>. After version 2.0.1 is selected, click on the <strong class="bold">Download package</strong> link on the right sidebar. This downloads a <strong class="source-inline">.nupkg</strong> file. This file can be opened with a <strong class="source-inline">.zip</strong> extraction program, including the default <span class="No-Break">Windows one.</span></li>
			</ol>
			<div>
				<div id="_idContainer069" class="IMG---Figure">
					<img src="image/B18416_03_3.jpg" alt="Figure 3.3 – Downloading Microsoft.ML version 2.0.1 from NuGet" width="1549" height="793"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3 – Downloading Microsoft.ML version 2.0.1 from NuGet</p>
			<ol>
				<li value="3">Open the <strong class="source-inline">.nupkg</strong> file using a zip extraction tool. Navigate into the <strong class="source-inline">lib\netstandard2.0</strong> folder. Extract all <a id="_idIndexMarker250"/>seven of the <strong class="source-inline">.dll</strong> files somewhere convenient, such as your desktop. We will be using these <span class="No-Break">files later.</span></li>
			</ol>
			<div>
				<div id="_idContainer070" class="IMG---Figure">
					<img src="image/B18416_03_4.jpg" alt="Figure 3.4 – Seven .dll files to extract from lib\netstandard2.0" width="307" height="214"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4 – Seven .dll files to extract from lib\netstandard2.0</p>
			<p>Of the three libraries that we need to import, two are present in the <strong class="source-inline">Microsoft.ML</strong> package: <strong class="source-inline">Microsoft.ML</strong> is in <strong class="source-inline">Microsoft.ML.dll</strong> and <strong class="source-inline">Microsoft.ML.Data</strong> is <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.Data.dll</strong></span><span class="No-Break">.</span></p>
			<p>It isn’t clear where we can find <strong class="source-inline">Microsoft.ML.DataOperationsCatalog</strong>. From the API documentation, found at <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.dataoperationscatalog?view=ml-dotnet">https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.dataoperationscatalog?view=ml-dotnet</a>, we see that it belongs to the <strong class="source-inline">Microsoft.ML.Data.dll</strong> assembly, meaning that the <strong class="source-inline">Microsoft.ML</strong> <strong class="source-inline">.dll</strong> files cover all of the <strong class="source-inline">using</strong> statements that we know of <span class="No-Break">so far.</span></p>
			<div>
				<div id="_idContainer071" class="IMG---Figure">
					<img src="image/B18416_03_5.jpg" alt="Figure 3.5 – DataOperationsCatalog found in Microsoft.ML.Data.dll" width="1283" height="710"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5 – DataOperationsCatalog found in Microsoft.ML.Data.dll</p>
			<p>Now that we’ve extracted <a id="_idIndexMarker251"/>some of the necessary <strong class="source-inline">.dll</strong> files from the NuGet package, let’s move them to a location that BP <span class="No-Break">can access.</span></p>
			<h3>Copying the .dll files to the BP installation folder</h3>
			<p>By default, BP is installed at <strong class="source-inline">C:\Program Files\Blue Prism Limited\Blue Prism Automate</strong>. We need to <a id="_idIndexMarker252"/>copy the <strong class="source-inline">.dll</strong> files to the installation folder. If this isn’t your installation path, please substitute your <span class="No-Break">own instead:</span></p>
			<ol>
				<li>Copy the seven <strong class="source-inline">.dll</strong> files extracted from the NuGet package into the BP <span class="No-Break">installation folder.</span></li>
				<li>Restart the BP application if you have it open. BP needs to be restarted in order to load the <span class="No-Break">new assemblies.</span></li>
			</ol>
			<p class="callout-heading">Important note</p>
			<p class="callout">There are multiple locations you can copy assemblies to so that they work with BP. This includes the Windows directory, the Windows system directory, and any folder on the system’s path environment variable. To make this example less error-prone, we’re copying it into the BP installation folder. In a production environment, a more maintainable solution would be to copy the <strong class="source-inline">.dll</strong> files into a custom folder and to include that folder in the Windows environment <span class="No-Break">path variable.</span></p>
			<p>Now that the libraries have been copied into a folder that’s accessible to BP, let’s create a sample Object and <span class="No-Break">import them.</span></p>
			<h3>Creating a BP object and adding external references and namespace imports</h3>
			<p>In this final section of the first <a id="_idIndexMarker253"/>example, we’ll <a id="_idIndexMarker254"/>create a BP Object, add the <strong class="source-inline">.dll</strong> files that are needed as references, add <a id="_idIndexMarker255"/>namespaces, and set the language <span class="No-Break">to C#:</span></p>
			<ol>
				<li>Create a new Group named <strong class="source-inline">Ch3</strong> inside of <strong class="bold">Studi<a id="_idTextAnchor054"/>o</strong> | <span class="No-Break"><strong class="bold">Objects</strong></span><span class="No-Break">.</span></li>
				<li>Create a new Object named <strong class="source-inline">Example 1 – Sentiment Analysis for User Reviews</strong> inside of the <span class="No-Break"><strong class="source-inline">Ch3</strong></span><span class="No-Break"> Group.</span></li>
				<li>On the <strong class="bold">Initialise</strong> Page, double-click on the white box with the Object’s name. This opens the Business <span class="No-Break">Object’s Properties.</span></li>
			</ol>
			<p class="IMG---Figure"> </p>
			<div>
				<div id="_idContainer072" class="IMG---Figure">
					<img src="image/B18416_03_6.jpg" alt="Figure 3.6 – Double-clicking to open the Properties of the Business Object" width="393" height="263"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6 – Double-clicking to open the Properties of the Business Object</p>
			<ol>
				<li value="4">Click on the <strong class="bold">Code Options</strong> tab. In the <strong class="bold">External References</strong> section, click <strong class="bold">Add</strong>. Input <strong class="source-inline">Microsoft.ML.dll</strong>. Click <strong class="bold">Add</strong> again and <span class="No-Break">input </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.Data.dll</strong></span><span class="No-Break">.</span></li>
				<li>Click <strong class="bold">Add</strong> in the <strong class="bold">Namespace imports</strong> section. Input <strong class="source-inline">Microsoft.ML</strong>. Click <strong class="bold">Add</strong> again and <span class="No-Break">input </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.Data</strong></span><span class="No-Break">.</span></li>
				<li>Choose <strong class="bold">C#</strong> in the <strong class="bold">Language</strong> <span class="No-Break">drop-down menu.</span></li>
			</ol>
			<ol>
				<li value="7">Verify that the <strong class="bold">Code Options</strong> tab looks like <span class="No-Break">the following:</span></li>
			</ol>
			<div>
				<div id="_idContainer073" class="IMG---Figure">
					<img src="image/B18416_03_7.jpg" alt="Figure 3.7 – The Code Options tab at the end of the first example" width="797" height="698"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7 – The Code Options tab at the end of the first example</p>
			<ol>
				<li value="8"><strong class="bold">Save</strong> <span class="No-Break">the object.</span></li>
			</ol>
			<p>In this example, we did the preparation work needed before moving the C# code into a Code Stage. First, we examined the project’s code to figure out <em class="italic">some</em> of the needed assembly imports. The assemblies themselves and the further code <a id="_idIndexMarker256"/>that we<a id="_idIndexMarker257"/> need to<a id="_idIndexMarker258"/> add to code stages might have additional dependencies that haven’t been imported yet. Next, we downloaded the ML.NET package from NuGet, and extracted the <strong class="source-inline">.dll</strong> files. Finally, we copied the ML.NET assemblies into the BP installation folder and added them as references in the Object’s Properties. In the next section, we’ll focus on porting the source code <span class="No-Break">into BP.</span></p>
			<h1 id="_idParaDest-54"><a id="_idTextAnchor055"/>Porting ML.NET C# into a Code Stage</h1>
			<p>Porting code into BP is <a id="_idIndexMarker259"/>more of an art than a science. It requires knowledge of how C# works and digging into the ML.NET API documentation when necessary. We’ve already discussed the <strong class="bold">Code Options</strong> section of the Object’s Properties. The Object’s Properties also have a <strong class="bold">Global Code</strong> tab, which will be used in the <span class="No-Break">next example.</span></p>
			<h2 id="_idParaDest-55"><a id="_idTextAnchor056"/>Global Code</h2>
			<p>The <strong class="bold">Global Code</strong> tab is accessed <a id="_idIndexMarker260"/>through the Object’s Properties, similarly to the <strong class="bold">Code </strong><span class="No-Break"><strong class="bold">Options</strong></span><span class="No-Break"> tab:</span></p>
			<div>
				<div id="_idContainer074" class="IMG---Figure">
					<img src="image/B18416_03_8.jpg" alt="Figure 3.8 – The Global Code tab is accessed through the Object’s Properties" width="1320" height="853"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8 – The Global Code tab is accessed through the Object’s Properties</p>
			<p>The <strong class="bold">Global Code</strong> section is used to place <em class="italic">common code</em> that’s needed across multiple Code Stages. This is similar in concept to a global Data Item (unticking Hide from other pages in the process checkbox) that’s needed across different Actions or Pages. Common code can include <em class="italic">variables</em>, <em class="italic">classes</em>, <span class="No-Break">and </span><span class="No-Break"><em class="italic">functions</em></span><span class="No-Break">.</span></p>
			<p>You’ll also notice a <strong class="bold">Check Code</strong> button. This button validates the code from the perspective of the compiler in the <strong class="bold">Global Code</strong> section, as well as any other Code Stage in the Object. We will be using this button frequently to help us figure out which assemblies <span class="No-Break">are missing.</span></p>
			<p>In the next example, we will use both the <strong class="bold">Global Code</strong> section and the <strong class="bold">Check Code</strong> button to help in porting the C# code into BP. The example will go through five <span class="No-Break">high-level steps:</span></p>
			<ol>
				<li>Moving two C# classes into the <strong class="bold">Global Code</strong> section of <span class="No-Break">the Object</span></li>
				<li>Copying the main source code into a <span class="No-Break">Code Stage</span></li>
				<li>Iteratively fixing compiler errors through the use of the <strong class="bold">Check </strong><span class="No-Break"><strong class="bold">Code</strong></span><span class="No-Break"> button</span></li>
				<li>Changing C# console<a id="_idIndexMarker261"/> print commands so that they output to <span class="No-Break">a file</span></li>
				<li>Testing the ported <span class="No-Break">ML program</span></li>
			</ol>
			<h2 id="_idParaDest-56"><a id="_idTextAnchor057"/>Example 2 - porting the source code into BP</h2>
			<p>In this example, we will be <a id="_idIndexMarker262"/>moving all of the source code into a Code Stage, and fixing more assembly and namespace errors. Our goal is to reach a point where we can receive a prediction from the C# <span class="No-Break">Code Stage.</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">This example was created and tested on BP versions 7.1.1 and 7.1.2. However, if you’re using a different version of BP, there may be additional steps needed to get this example working. This is because different versions of BP come bundled with different versions of Microsoft’s .dll libraries. If you look into your BP installation folder, many of these .dll files are prefixed with <strong class="source-inline">System.*</strong> or <strong class="source-inline">Microsoft.*</strong>. The steps shown in this example should in the worst case get you very close to making a prediction through a Code Stage. You can get to a working solution by applying the techniques that we’ll <span class="No-Break">see below.</span></p>
			<h3>Moving class definitions into BP</h3>
			<p>In the first example, we saw<a id="_idIndexMarker263"/> that there were only three <strong class="source-inline">.cs</strong> source files. Two of the source files, <strong class="source-inline">SentimentIssue.cs</strong> and <strong class="source-inline">SentimentPrediction.cs</strong>, are class definitions. Let’s move them into the <strong class="bold">Global Code</strong> section of <span class="No-Break">the Object:</span></p>
			<ol>
				<li>Open the Object created in the first example. If needed, a completed version of the Object, named <strong class="source-inline">Example 1 - Sentiment Analysis for User Reviews (Completed)</strong>, should have already been imported to the <span class="No-Break"><strong class="source-inline">Ch3</strong></span><span class="No-Break"> Group.</span></li>
				<li>Open the Object’s Properties by double-clicking on the white box with the Object’s name on the <span class="No-Break"><strong class="bold">Initialise</strong></span><span class="No-Break"> Page.</span></li>
				<li>Click on the <strong class="bold">Global </strong><span class="No-Break"><strong class="bold">Code</strong></span><span class="No-Break"> tab.</span></li>
				<li>Copy the class definition code from  <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentIssue.cs"><span class="No-Break">https://github.com/dotnet/machine</span>
learning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentIssue.cs</a> into the <strong class="bold">Global Code</strong> text window. This includes everything between <strong class="source-inline">public class SentimentIssue { … }</strong>.</li>
				<li>Repeat this for the file at <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentPrediction.cs">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/DataStructures/SentimentPrediction.cs</a>. This includes everything between <strong class="source-inline">public class SentimentPrediction { … }</strong>.</li>
				<li>Confirm that the <strong class="bold">Global Code</strong> section contains two class definitions like in the <span class="No-Break">figure below:</span></li>
			</ol>
			<div>
				<div id="_idContainer075" class="IMG---Figure">
					<img src="image/B18416_03_9.jpg" alt="Figure 3.9 – The Global Code section contains the two class definitions" width="930" height="587"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.9 – The Global Code section contains the two class definitions</p>
			<ol>
				<li value="7">Click on the <strong class="bold">Check Code</strong> button<a id="_idIndexMarker264"/> on the <strong class="bold">Global Code</strong> tab. This checks to see if there are any compiler errors with our newly introduced code. You’ll find that there’s an error similar to <strong class="source-inline">The type 'Attribute' is defined in an assembly that is not referenced. You must add a reference to assembly 'netstandard, </strong><span class="No-Break"><strong class="source-inline">Version=2.0.0.0, Culture=neutral</strong></span><span class="No-Break">.</span></li>
				<li>Click on the <strong class="bold">Code Options</strong> tab. In the <strong class="bold">External References</strong> section, click <strong class="bold">Add</strong>, and <span class="No-Break">enter </span><span class="No-Break"><strong class="source-inline">netstandard.dll</strong></span><span class="No-Break">.</span></li>
				<li>Return to the <strong class="bold">Global Code</strong> tab and click <strong class="bold">Check Code</strong> again. Ensure that no compiler <span class="No-Break">errors remain.</span></li>
				<li>Click <strong class="bold">OK</strong> to save the business <span class="No-Break">object’s properties.</span></li>
				<li>Save <span class="No-Break">the object.</span></li>
			</ol>
			<p>So far, we’ve successfully added <a id="_idIndexMarker265"/>two classes to the <strong class="bold">Global Code</strong> section of the Object. Next, let’s import the main program code into a <span class="No-Break">Code Stage.</span></p>
			<h3>Porting the machine learning program code into a Code Stage</h3>
			<p>The main code for the<a id="_idIndexMarker266"/> ML program is in this <span class="No-Break">file: </span><a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/Program.cs"><span class="No-Break">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/SentimentAnalysisConsoleApp/Program.cs</span></a><span class="No-Break">.</span></p>
			<p>Let’s move it into a <span class="No-Break">Code Stage:</span></p>
			<ol>
				<li>Navigate to the <strong class="source-inline">Action 1</strong> Page and add a <span class="No-Break">Code Stage.</span></li>
				<li><strong class="bold">Link</strong> it between <strong class="bold">Start </strong><span class="No-Break">and </span><span class="No-Break"><strong class="bold">End</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer076" class="IMG---Figure">
					<img src="image/B18416_03_10.jpg" alt="Figure 3.10 – Adding a Code Stage to Action 1" width="186" height="333"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10 – Adding a Code Stage to Action 1</p>
			<ol>
				<li value="3">Look at lines 12–20 of <strong class="source-inline">Program.cs</strong>. See that it has a number of <strong class="source-inline">private static readonly string</strong> statements. These statements define the paths to the training data file (line 15) and the model output file (line 20). Add two <strong class="bold">Data Items</strong> with the Data Type <strong class="source-inline">Text</strong> to the Object diagram to represent these. Name one Data Item <strong class="source-inline">DataPath</strong> and the <span class="No-Break">other </span><span class="No-Break"><strong class="source-inline">ModelPath</strong></span><span class="No-Break">.</span></li>
				<li>Set the <strong class="bold">Initial Value</strong> of <strong class="source-inline">DataPath</strong> to <strong class="source-inline">C:/Users/Public/wikiDetoxAnnotated40kRows.tsv</strong>. Set the <strong class="bold">Initial Value</strong> of <strong class="source-inline">ModelPath</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">C:/Users/Public/ch3_SentimentModel.zip</strong></span><span class="No-Break">:</span></li>
			</ol>
			<div>
				<div id="_idContainer077" class="IMG---Figure">
					<img src="image/B18416_03_11.jpg" alt=" Figure 3.11 – Set the Initial Values of DataPath and ModelPath" width="595" height="293"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 3.11 – Set the Initial Values of DataPath and ModelPath</p>
			<ol>
				<li value="5">Double-click <strong class="source-inline">Code1</strong>. Add two<a id="_idIndexMarker267"/> Inputs corresponding to the Data Items <strong class="source-inline">DataPath</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">ModelPath</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer078" class="IMG---Figure">
					<img src="image/B18416_03_12.jpg" alt="Figure 3.12 – Adding the two Data Items as inputs to the Code Stage" width="1058" height="259"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12 – Adding the two Data Items as inputs to the Code Stage</p>
			<ol>
				<li value="6">Click on the <strong class="bold">Code</strong> tab. Copy everything inside static void <strong class="source-inline">Main(string[] args) { [Copy the text here] }</strong> into the code window. These are lines 24 to 68 of <strong class="source-inline">Program.cs</strong>. Your code window should have 45 lines of code <span class="No-Break">in it.</span></li>
			</ol>
			<div>
				<div id="_idContainer079" class="IMG---Figure">
					<img src="image/B18416_03_13.jpg" alt="Figure 3.13 – The 45 lines of code that should be in your window" width="1074" height="259"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13 – The 45 lines of code that should be in your window</p>
			<ol>
				<li value="7">Click on the <strong class="bold">Check Code</strong> button. There<a id="_idIndexMarker268"/> should be numerous errors. Some of the errors are very direct in stating which <strong class="source-inline">.dll</strong> is missing. For example, you might encounter <strong class="source-inline">You must add a reference to assembly 'Microsoft.ML.Core</strong> or <strong class="source-inline">You must add a reference to assembly 'Microsoft.ML.DataView</strong>. Close the <strong class="bold">Check Code</strong> window and press <strong class="bold">OK</strong> to save the <span class="No-Break">Code Stage.</span></li>
				<li>Find the <strong class="source-inline">Microsoft.ML.DataView.dll</strong> file from the NuGet website by searching for <strong class="bold">Microsoft.ML.DataView</strong>. Ensure that you download version 2.0.1. Extract the <strong class="source-inline">lib\netstandard2.0\Microsoft.ML.DataView.dll</strong> file from the NuGet package into the BP installation folder location. Close and <span class="No-Break">relaunch BP.</span></li>
				<li>Open the Object’s Properties on the <strong class="bold">Initialise</strong> Page and click on the <strong class="bold">Code Options</strong> tab. Add <strong class="source-inline">Microsoft.ML.Core.dll</strong> and <strong class="source-inline">Microsoft.ML.DataView.dll</strong> as <strong class="bold">External References</strong>. Press <strong class="bold">OK</strong> to close the <span class="No-Break">Object’s Properties.</span></li>
			</ol>
			<div>
				<div id="_idContainer080" class="IMG---Figure">
					<img src="image/B18416_03_14.jpg" alt="Figure 3.14 – Adding two new External References to the Object’s Properties" width="708" height="572"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14 – Adding two new External References to the Object’s Properties</p>
			<ol>
				<li value="10">Go back to the <strong class="source-inline">Code1</strong> Stage and click <strong class="bold">Check Code</strong> again. There should still be four compiler errors that don’t give a clear indication of what assembly or namespace needs to <span class="No-Break">be imported.</span></li>
			</ol>
			<div>
				<div id="_idContainer081" class="IMG---Figure">
					<img src="image/B18416_03_15.jpg" alt="Figure 3.15 – The remaining four compiler errors" width="1646" height="264"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.15 – The remaining four compiler errors</p>
			<p>At this point, we don’t have a <a id="_idIndexMarker269"/>working Code Stage yet, but we’re getting close! Let’s investigate and resolve each of the remaining compiler <span class="No-Break">errors individually.</span></p>
			<h3>Fixing individual compiler errors</h3>
			<p>None<a id="_idIndexMarker270"/> of the compiler errors have obvious solutions. We’ll need to rely on the API documentation to find out which namespaces or assemblies need to be added. Let’s tackle them in the order of which line the <span class="No-Break">error occurs:</span></p>
			<ol>
				<li>Look at the compiler error for line 8. It says <strong class="source-inline">The type or namespace name 'TrainTestData' could not be found</strong>. Let’s refer to the API to find out what <strong class="source-inline">TrainTestData</strong> is. The documentation at <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.dataoperationscatalog.traintestdata?view=ml-dotnet">https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.dataoperationscatalog.traintestdata?view=ml-dotnet</a> shows that it belongs to <strong class="source-inline">DataOperationsCatalog</strong>. Recall that <strong class="source-inline">DataOperationsCatalog</strong> was one of the <strong class="source-inline">using</strong> statements at the beginning of the <span class="No-Break"><strong class="source-inline">Project.cs</strong></span><span class="No-Break"> file:</span><pre class="source-code">
using static Microsoft.ML.DataOperationsCatalog;</pre><p class="list-inset"><strong class="source-inline">using</strong> statements are normally ported to BP by adding them into the <strong class="bold">Namespace Imports</strong> section of the Object’s Properties. However, <strong class="source-inline">using static</strong> statements cannot be added in that manner. Instead, we need to provide the whole namespace in the source <span class="No-Break">code itself.</span></p></li>				<li>Open <a id="_idIndexMarker271"/>the <strong class="bold">Code</strong> tab of the <strong class="source-inline">Code1</strong> stage on line 8 and prefix <strong class="source-inline">TrainTestSplit</strong> with <strong class="source-inline">Microsoft.ML.DataOperationsCatalog</strong>. Line 8 should now be <span class="No-Break">as follows:</span><pre class="source-code">
<strong class="bold">Microsoft.ML.DataOperationsCatalog.TrainTestData trainTestSplit = mlContext.Data.TrainTestSplit(dataView, testFraction: 0.2);</strong></pre></li>				<li>Click on <strong class="bold">Check Code</strong>. See that the compiler error on line 8 <span class="No-Break">is gone.</span></li>
				<li>Look at the compiler error for line 13. It says: <strong class="source-inline">'TransformsCatalog.TextTransforms' does not contain a definition for 'FeaturizeText'</strong>. Look up <strong class="source-inline">FeaturizeText</strong> in the API reference at <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.textcatalog.featurizetext?view=ml-dotnet">https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.textcatalog.featurizetext?view=ml-dotnet</a>. It shows that the assembly <strong class="source-inline">Microsoft.ML.Transforms.dll</strong> <span class="No-Break">is needed:</span></li>
			</ol>
			<div>
				<div id="_idContainer082" class="IMG---Figure">
					<img src="image/B18416_03_16.jpg" alt="Figure 3.16 – FeaturizeText in Microsoft.ML.Transforms.dll" width="1576" height="753"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.16 – FeaturizeText in Microsoft.ML.Transforms.dll</p>
			<ol>
				<li value="5">Add <strong class="source-inline">Microsoft.ML.Transforms.dll</strong> as an <strong class="bold">External Reference</strong> in the Object’s <a id="_idIndexMarker272"/>Properties and close the Object’s Properties window by <span class="No-Break">pressing </span><span class="No-Break"><strong class="bold">OK</strong></span><span class="No-Break">.</span></li>
			</ol>
			<p class="IMG---Figure"> </p>
			<div>
				<div id="_idContainer083" class="IMG---Figure">
					<img src="image/B18416_03_17.jpg" alt="Figure 3.17 – Adding Microsoft.ML.Transforms.dll as an External Reference" width="420" height="347"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.17 – Adding Microsoft.ML.Transforms.dll as an External Reference</p>
			<ol>
				<li value="6">Verify that the compiler error for line 13 <span class="No-Break">is gone.</span></li>
				<li>Look at the compiler error for line 16. It says <strong class="source-inline">'BinaryClassificationCatalog.BinaryClassificationTrainers' does not contain a definition for 'SdcaLogisticRegression'</strong>. The API page at <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.trainers.sdcalogisticregressionbinarytrainer?view=ml-dotnet">https://learn.microsoft.com/en-us/dotnet/api/microsoft.ml.trainers.sdcalogisticregressionbinarytrainer?view=ml-dotnet</a> shows that SdcaLogisticRegression is <span class="No-Break">in </span><span class="No-Break">Microsoft.ML.StandardTrainers.dll</span><span class="No-Break">:</span></li>
			</ol>
			<div>
				<div id="_idContainer084" class="IMG---Figure">
					<img src="image/B18416_03_18.jpg" alt="Figure 3.18 – SdcaLogisticRegression in Microsoft.ML.StandardTrainers.dll" width="1541" height="745"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.18 – SdcaLogisticRegression in Microsoft.ML.StandardTrainers.dll</p>
			<ol>
				<li value="8">Add <strong class="source-inline">Microsoft.ML.StandardTrainers.dll</strong> as an <strong class="bold">External Reference</strong> in the Object’s Properties. Press <strong class="bold">OK</strong> to close the <span class="No-Break">Properties window.</span></li>
				<li>Verify <a id="_idIndexMarker273"/>that the compiler error for line 16 <span class="No-Break">is gone.</span></li>
			</ol>
			<p>The last compiler error that remains on line 26 is about a utility that helps to print results to the console window (<strong class="source-inline">ConsoleHelper.PrintBinaryClassificationMetrics</strong>). Since our goal is to get this running from BP, we won’t see any console window. Let’s change the C# code to write the output to <span class="No-Break">a file.</span></p>
			<h3>Changing console output to a file</h3>
			<p>The <strong class="source-inline">ConsoleHelper.cs</strong> file is located at <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/common/ConsoleHelper.cs">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/common/ConsoleHelper.cs</a>. We can copy the code of that <a id="_idIndexMarker274"/>function into the <strong class="bold">Global Code</strong> section of our Object’s Properties and change line 26 to call that function from our Code Stage. Then, we will change printing to the console window to writing <span class="No-Break">a file:</span></p>
			<ol>
				<li>Open <strong class="source-inline">ConsoleHelper.cs</strong> on GitHub and copy <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">PrintBinary</strong></span><strong class="source-inline">
ClassificationMetrics(…)</strong> function from lines 41–57 into the <strong class="bold">Global Code</strong> section of your <span class="No-Break">Object’s Properties:</span></li>
			</ol>
			<div>
				<div id="_idContainer085" class="IMG---Figure">
					<img src="image/B18416_03_19.jpg" alt="Figure 3.19 – Copying PrintBinaryClassificationMetrics() into Global Code" width="1637" height="565"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.19 – Copying PrintBinaryClassificationMetrics() into Global Code</p>
			<ol>
				<li value="2">Open <a id="_idIndexMarker275"/>the <strong class="source-inline">Code1</strong> Stage and on line 26, delete the <strong class="source-inline">Console.Helper.</strong> prefix. Line 26 should show <span class="No-Break"><strong class="source-inline">PrintBinaryClassificationMetrics(trainer.ToString(), metrics);</strong></span><span class="No-Break">.</span></li>
				<li>Click <strong class="bold">Check Code</strong> and confirm that there are no more <span class="No-Break">compiler errors.</span></li>
				<li>Open the Object’s Properties and add <strong class="source-inline">System.IO</strong>. to <strong class="bold">Namespace Imports</strong>. This is needed to write to <span class="No-Break">a file.</span></li>
			</ol>
			<div>
				<div id="_idContainer086" class="IMG---Figure">
					<img src="image/B18416_03_20.jpg" alt="Figure 3.20 – Adding System.IO to the Namespace Imports" width="949" height="512"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.20 – Adding System.IO to the Namespace Imports</p>
			<ol>
				<li value="5">Go back to the <strong class="source-inline">Code1</strong> Stage <a id="_idIndexMarker276"/>and add the following lines to the beginning of the <span class="No-Break">code window:</span><pre class="source-code">
FileStream ostrm;
StreamWriter writer;
TextWriter oldOut = Console.Out;
try {
    ostrm = new FileStream("C:/Users/Public/ch3_output.txt",     FileMode.OpenOrCreate, FileAccess.Write);
    writer = new StreamWriter(ostrm);
}
catch (Exception e) {
    return;
}
Console.SetOut(writer);</pre></li>				<li>Delete the<a id="_idIndexMarker277"/> last two lines at the bottom of the code window. They are <span class="No-Break">as follows:</span><pre class="source-code">
Console.WriteLine($"================End of Process.Hit any key to exit==================================");</pre><p class="list-inset"><span class="No-Break">and</span></p><pre class="source-code">Console.ReadLine();</pre><p class="list-inset">It’s safe to delete them, as their purpose is to pause the console window so that you can review the printed text, which is no <span class="No-Break">longer necessary.</span></p></li>				<li>Paste the following three lines at the very bottom of the <span class="No-Break">code window:</span><pre class="source-code">
Console.SetOut(oldOut);
writer.Close();
ostrm.Close();</pre></li>				<li>Press <strong class="bold">OK</strong> to save the <span class="No-Break">code window.</span></li>
			</ol>
			<p>Now that all of the<a id="_idIndexMarker278"/> compiler errors are resolved, we’re ready to download the training data and test the ML.NET <span class="No-Break">code stage.</span></p>
			<h3>Running the ML.NET program</h3>
			<p>We’re close <a id="_idIndexMarker279"/>to the finish line! We need to download the training data, copy it to the correct location, and run <span class="No-Break">our model:</span></p>
			<ol>
				<li>Download the training data from <a href="https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/Data/wikiDetoxAnnotated40kRows.tsv">https://github.com/dotnet/machinelearning-samples/blob/main/samples/csharp/getting-started/BinaryClassification_SentimentAnalysis/SentimentAnalysis/Data/wikiDetoxAnnotated40kRows.tsv</a>. Ensure that the file is downloaded as a <strong class="source-inline">.tsv</strong> file and <em class="italic">not</em> a <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">txt</strong></span><span class="No-Break"> file.</span></li>
				<li>Copy the <strong class="source-inline">.tsv</strong> file to the location specified by the <strong class="source-inline">DataPath</strong> Data <span class="No-Break">Item, </span><span class="No-Break"><strong class="source-inline">C:/Users/Public/wikiDetoxAnnotated40kRows.tsv</strong></span><span class="No-Break">.</span></li>
				<li>Click on the <strong class="source-inline">Action 1</strong> Page and run it in the <span class="No-Break">Object Studio.</span></li>
				<li>See that there’s an error: <strong class="source-inline">Internal : Could not execute code stage because exception thrown by code stage: Could not load file or assembly ‘</strong><span class="No-Break"><strong class="source-inline">System.Collections.Immutable, Version=1.2.3.0</strong></span><span class="No-Break">.</span></li>
				<li>Find the <strong class="source-inline">Systems.Collections.Immutable.dll</strong> file from the NuGet website by searching for <strong class="bold">System.Collections.Immutable</strong>. Choose the official repository by <em class="italic">dotnetframework Microsoft</em>. Ensure that you download version 1.5.0. Extract the <strong class="source-inline">lib\netstandard2.0\Systems.Collections.Immutable.dll</strong> file from the NuGet package into the BP installation folder location. Close and relaunch BP. </li>
				<li>Run <strong class="source-inline">Action 1</strong> Page from the Object Studio again. See that there’s an error: <strong class="source-inline">Shuffle input cursor reader failed with an exception</strong>. This error is not very useful, but we can enclose the Code Stage into a try / catch statement to obtain the full stack trace. The full stack trace reveals another missing <span class="No-Break">dependency, </span><span class="No-Break"><strong class="source-inline">Microsoft.ML.CpuMath</strong></span><span class="No-Break">.</span></li>
				<li>Find the <strong class="source-inline">Microsoft.ML.CpuMath.dll</strong> file from the NuGet website by searching for <strong class="bold">Microsoft.ML.CpuMath</strong>. Choose the official repository by <em class="italic">dotnetframework Microsoft MLNET</em>. Ensure that you download version 2.0.1. Extract the <strong class="source-inline">lib\netstandard2.0\ Microsoft.ML.CpuMath.dll</strong> file from the NuGet package into the BP installation folder location. This assembly actually has a further dependency on a file named CpuMathNative.dll. This file would normally be provided to you from the ML engineers as it will be built as a part of their <span class="No-Break">code project.</span></li>
				<li>Download <strong class="source-inline">CpuMathNative.dll</strong> from GitHub (assume that this is provided by the ML team): <a href="https://github.com/PacktPublishing/Intelligent-Process-Automation-with-Blue-Prism/blob/main/ch3/CpuMathNative.dll">https://github.com/PacktPublishing/Intelligent-Process-Automation-with-Blue-Prism/blob/main/ch3/CpuMathNative.dll</a>, and copy it to the BP installation folder. Close and <span class="No-Break">relaunch BP.</span></li>
				<li>Run <strong class="source-inline">Action 1</strong> Page from the Object <span class="No-Break">Studio again.</span></li>
				<li>Open <strong class="source-inline">C:\Users\Public\ch3_output.txt</strong> and confirm that it looks similar to the <span class="No-Break">following figure:</span></li>
			</ol>
			<div>
				<div id="_idContainer087" class="IMG---Figure">
					<img src="image/B18416_03_21.jpg" alt="Figure 3.21 – The redirected console out contained in ch3_output.txt" width="1060" height="429"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.21 – The redirected console out contained in ch3_output.txt</p>
			<p class="list-inset">This file shows the training accuracy and the results of a sample prediction for the sentence <strong class="source-inline">I love </strong><span class="No-Break"><strong class="source-inline">this movie!</strong></span><span class="No-Break">.</span></p>
			<ol>
				<li value="11">Confirm that the file, <strong class="source-inline">C:/Users/Public/ch3_SentimentModel.zip</strong>, stored in the <strong class="source-inline">ModelPath</strong> data item was created. The file size should be around 13 MB. This file can be loaded to make predictions without training the <span class="No-Break">model again.</span></li>
			</ol>
			<p>We’ve <a id="_idIndexMarker280"/>completed porting the ML code into BP. The biggest difficulty to overcome was knowing which assemblies and namespace imports to include.  We were able to find this information in the compiler errors and the ML.NET <span class="No-Break">API documentation.</span></p>
			<p>For reference, a completed object for the second example should have been imported as <strong class="source-inline">Example 2 - Sentiment Analysis for User Reviews (Completed)</strong> in the <strong class="source-inline">Ch3</strong> Group. Now that we have the model trained and the prediction working, let’s refactor the example so that it follows BP <span class="No-Break">best practices.</span></p>
			<h1 id="_idParaDest-57"><a id="_idTextAnchor058"/>Improving BP integration</h1>
			<p>While the <a id="_idIndexMarker281"/>code in the second example works from a functional standpoint, it isn’t well integrated into BP. It’s housed in a single Code Stage, which isn’t maintainable or reusable. Data scientists don’t necessarily have experience in software design, so you may very well receive an entire ML program in a single source file or ML notebook to port <span class="No-Break">into BP.</span></p>
			<p>Some issues that are<a id="_idIndexMarker282"/> present in the second example include <span class="No-Break">the following:</span></p>
			<ul>
				<li>There’s low logging fidelity. One of the biggest concerns when adding Code Stages is that you could be completing numerous important steps and not have any logs sent back to the BP database for <span class="No-Break">record keeping.</span></li>
				<li>We need to retrain the entire model each time we want to make a prediction, which is time-consuming and <span class="No-Break">repetitive work.</span></li>
				<li>There’s a single Action, which doesn’t <span class="No-Break">promote reuse.</span></li>
				<li>There’s a lack of exception handling in the <span class="No-Break">C# code.</span></li>
			</ul>
			<p>Let’s look at how we<a id="_idIndexMarker283"/> can improve the four points listed in our <span class="No-Break">next example.</span></p>
			<h2 id="_idParaDest-58"><a id="_idTextAnchor059"/>Example 3 - refactoring</h2>
			<p>In the final <a id="_idIndexMarker284"/>example of this chapter, we’ll look at a refactored version of the object from the second example, which improves the functionality, reusability, <span class="No-Break">and logging:</span></p>
			<ol>
				<li>Open the <strong class="source-inline">Example 3 – Sentiment Analysis for User Reviews (Refactored)</strong> Object in the <strong class="source-inline">Ch3</strong> Group in the <span class="No-Break">Object Studio.</span></li>
				<li>Visit the <strong class="bold">Initialise</strong> Page and see that the Data Items for the training data file path and the saved model path have been changed into Environment Variables. This allows you to change the training data and the location of the saved model <strong class="source-inline">.zip</strong> file without needing to edit the <span class="No-Break">Object diagram.</span></li>
			</ol>
			<p class="IMG---Figure"> </p>
			<div>
				<div id="_idContainer088" class="IMG---Figure">
					<img src="image/B18416_03_22.jpg" alt="Figure 3.22 – The training data path and saved model path are stored as Environment Variables" width="503" height="421"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.22 – The training data path and saved model path are stored as Environment Variables</p>
			<ol>
				<li value="3">See that the <a id="_idIndexMarker285"/>trained model path is now separate from the prediction model path. By keeping these separate, you can retrain a model while continuing to predict using the previous model. This is crucial because a newly trained model needs to be vetted before being used <span class="No-Break">in production.</span></li>
			</ol>
			<div>
				<div id="_idContainer089" class="IMG---Figure">
					<img src="image/B18416_03_22.jpg" alt="Figure 3.23 – The trained model path and prediction model path are different" width="503" height="421"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.23 – The trained model path and prediction model path are different</p>
			<ol>
				<li value="4">See that the fraction of training to testing data is exposed as an Environment Variable if it needs to be changed without editing the Object diagram. Part of building a model is heavy amounts of experimentation surrounding training parameters. It’s desirable to not have the training/test split hard-coded inside the Object’s Code Stages, in case it needs to be changed. Another valid design would be to pass this in as an Input to <span class="No-Break">the Action.</span></li>
				<li>See that<a id="_idIndexMarker286"/> the training, scoring, model saving, and prediction making have all been split into separate Actions. Most importantly, we can now predict without needing to train the model every time. This also improves the fidelity of the <span class="No-Break">Session Logs.</span></li>
			</ol>
			<div>
				<div id="_idContainer090" class="IMG---Figure">
					<img src="image/B18416_03_24.jpg" alt="Figure 3.24 – Each ML stage with its own Action to improve logging and reusability" width="1512" height="72"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.24 – Each ML stage with its own Action to improve logging and reusability</p>
			<ol>
				<li value="6">Open the <strong class="bold">Train Model</strong> Page. Open the Code Stage and look at the <strong class="bold">Code</strong> tab. <strong class="source-inline">try…catch</strong> blocks have been added to each Code Stage, with error messages and a Success flag output back <span class="No-Break">to BP.</span></li>
			</ol>
			<div>
				<div id="_idContainer091" class="IMG---Figure">
					<img src="image/B18416_03_25.jpg" alt="Figure 3.25 – Adding try…catch blocks to improve error handling" width="1618" height="931"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.25 – Adding try…catch blocks to improve error handling</p>
			<p class="list-inset">Each Page also returns these to the caller as Outputs in the End stage instead of writing text <span class="No-Break">into files.</span></p>
			<ol>
				<li value="7">Visit the <strong class="bold">Initialise</strong> Page, open<a id="_idIndexMarker287"/> the Object’s Properties, and look at the <strong class="bold">Global Code</strong>. See that a number of new <em class="italic">static variables</em> have been added to accommodate all of <span class="No-Break">the changes:</span></li>
			</ol>
			<div>
				<div id="_idContainer092" class="IMG---Figure">
					<img src="image/B18416_03_26.jpg" alt="Figure 3.26 – Static variables added to the Global Code, usable from other Code Stages" width="1654" height="347"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.26 – Static variables added to the Global Code, usable from other Code Stages</p>
			<p>This concludes<a id="_idIndexMarker288"/> the third example. This was a refactored version of the second example, where readability, reusability, and maintainability have all been improved. It’s extremely common for an ML program to be contained entirely in just one or a few source files. Porting a C# program into a <em class="italic">single</em> Code Stage results in something that’s far from a BP best practice. We need to go that extra step and improve what’s provided so that it meets the standards of the IA Center <span class="No-Break">of Excellence.</span></p>
			<h1 id="_idParaDest-59"><a id="_idTextAnchor060"/>Summary</h1>
			<p>ML.NET is Microsoft’s open source, cross-platform ML framework. It’s built on .NET and can be used natively in BP through Code Stages. In this chapter, we were faced with a common IA scenario. We were provided with a working ML project built in ML.NET, and our task was to get the source code working <span class="No-Break">in BP.</span></p>
			<p>In the first example, we examined the source code to understand which <strong class="source-inline">.dll</strong> libraries needed to be imported. We downloaded the ML.NET package from NuGet and copied the assemblies into the BP <span class="No-Break">installation folder.</span></p>
			<p>In the second example, we started to move the code into a BP Code Stage. Some code, including class definitions, belong in the <strong class="bold">Global Code</strong> section of the Object’s Properties. Using the <strong class="bold">Check Code</strong> button, we were able to see which lines of code had unresolved <strong class="source-inline">.dll</strong> or namespace errors. We tackled each error by reading the compiler error message and looking up key terms in the API as necessary. A key point to understand is that you don’t need to be an ML expert, nor do you need to have experience with the ML framework you’re working with to successfully port it into BP! We can successfully port the code by using <strong class="bold">Check Code</strong> and <span class="No-Break">the documentation.</span></p>
			<p>Finally, it’s common for ML code to be provided as a single source code program. In the third example, we split up a single Code Stage into multiple Actions that more closely matched the ML life cycle. The main goal was to make our Object more reusable and maintainable <span class="No-Break">going forward.</span></p>
			<p>This concludes <em class="italic">Part 1</em> of this book, where we focused on how BP can trigger ML predictions. The main ways of doing so are through web APIs, the command line interface, and Code Stages. Up next is <em class="italic">Part 2</em> of the book, where we shift our focus to IA <span class="No-Break">solution design.</span></p>
		</div>
	</div>
</div>


<div id="book-content">
<div id="sbo-rt-content"><div id="_idContainer094" class="Content">
			<h1 id="_idParaDest-60" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor061"/>Part 2:Designing IA Solutions</h1>
			<p>In <em class="italic">Part 1</em> of this book, we learned three different ways to connect BP to ML models to make predictions: Web APIs, the command-line interface, and <span class="No-Break">code stages.</span></p>
			<p><em class="italic">Part 2</em> describes the BP solution design elements that surround the ML prediction. Although the design concepts here are generic in that they could be used with any RPA tool, they are illustrated in BP. In <a href="B18416_04.xhtml#_idTextAnchor062"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, we’ll introduce the idea of reviewing ML predictions as a way to manage IA risk. We’ll discuss and design two different ways to trigger manual review: random sampling <span class="No-Break">and thresholding.</span></p>
			<p><a href="B18416_05.xhtml#_idTextAnchor075"><span class="No-Break"><em class="italic">Chapter 5</em></span></a> examines different ways to design an IA solution by varying the number of BP processes and work queues. Changing the number of processes and work queues affects the auditability and scalability of an IA solution. With this larger solution structure in place, <a href="B18416_06.xhtml#_idTextAnchor093"><span class="No-Break"><em class="italic">Chapter 6</em></span></a> discusses some smaller, reusable elements that can be used across all of the <span class="No-Break">different designs.</span></p>
			<p>Finally, <a href="B18416_07.xhtml#_idTextAnchor114"><span class="No-Break"><em class="italic">Chapter 7</em></span></a> consolidates the work in this part of the book into reusable IA process templates and an IA VBO that can be used as a starting point for your IA solution designs <span class="No-Break">and development.</span></p>
			<p>This part contains the <span class="No-Break">following chapters:</span></p>
			<ul>
				<li><a href="B18416_04.xhtml#_idTextAnchor062"><em class="italic">Chapter 4</em></a>, <em class="italic">Reviewing Predictions and Human in the Loop</em></li>
				<li><a href="B18416_05.xhtml#_idTextAnchor075"><em class="italic">Chapter 5</em></a>, <em class="italic">IA Process and Work Queue Designs for HITL</em></li>
				<li><a href="B18416_06.xhtml#_idTextAnchor093"><em class="italic">Chapter 6</em></a>, <em class="italic">Reusable IA Components</em></li>
				<li><a href="B18416_07.xhtml#_idTextAnchor114"><em class="italic">Chapter 7</em></a>, <em class="italic">IA Templates and Utility – IA Object</em></li>
			</ul>
		</div>
		<div>
			<div id="_idContainer095">
			</div>
		</div>
		<div>
			<div id="_idContainer096" class="Basic-Graphics-Frame">
			</div>
		</div>
	</div>
</div>
</body></html>