<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using OpenVINO with OpenCV</h1>
                </header>
            
            <article>
                
<p>In the first chapter, we discussed various new additions in the OpenCV 4.0 release. One of the key releases to note is the OpenVINO toolkit. It's also interesting to note that the OpenVINO toolkit was selected as the 2019 Developer Tool of the Year by Embedded Vision Alliance.</p>
<p>In this chapter, we will focus only on how to use the OpenVINO toolkit with OpenCV. We will begin by installing the OpenVINO toolkit and then proceed to an interactive face detection demo with it. We will also learn to use OpenVINO Model Zoo with OpenCV and the OpenVINO <strong>Inference Engine</strong> (<strong>IE</strong>) with OpenCV. At the end of this chapter, we will also learn how to carry out image classification using OpenCV with OpenVINO IE.</p>
<p><span>In this chapter, w</span>e will cover the following topics:</p>
<ul>
<li>OpenVINO toolkit installation</li>
<li>Interactive face detection demo</li>
<li>Using OpenVINO Model Zoo with OpenCV</li>
<li>Using OpenVINO IE with OpenCV</li>
<li>Image classification using OpenCV with OpenVINO IE</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>You can refer the code for this chapter at the following link: <a href="https://github.com/PacktPublishing/Machine-Learning-for-OpenCV-Second-Edition/tree/master/Chapter12">https://github.com/PacktPublishing/Machine-Learning-for-OpenCV-Second-Edition/tree/master/Chapter12</a>.</p>
<p>Here is a summary of the software and hardware requirements:</p>
<ul>
<li>You will need OpenCV version 4.1.x (4.1.0 or 4.1.1 will both work just fine).</li>
<li>You will need Python version 3.6 (any Python version 3.x will be fine).</li>
<li>You will need Anaconda Python 3 to install Python and the required modules.</li>
<li>You can use any OS—macOS, Windows, and Linux-based OSes—with this book. We recommend you have at least 4 GB RAM in your system.</li>
<li>You don't need to have a GPU to run the code provided with this book.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Introduction to OpenVINO</h1>
                </header>
            
            <article>
                
<p><strong>OpenVINO</strong> (short for <strong>Open Visual Inferencing and Neural Network Optimization</strong>). It is designed to optimize various neural networks to speed up the inference stage. Inference, as we have discussed in previous chapters, is the process in which a trained neural network is used to generate results with unseen input data. For example, if a network is trained to classify a dog or cat, then if we feed the image of Tuffy (our neighbor's dog), it should be able to infer that the image is of a dog.</p>
<p>Considering that images and videos have become so common in today's world, there are a lot of deep neural networks trained to perform various operations, such as, multilabel classification, and motion tracking. <span>Most of the inference performed in the world occurs on CPUs since GPUs are very expensive and usually do not suit the budget of individual AI engineers. </span><span>In these cases, the speedup provided by OpenVINO toolkit is very crucial.</span></p>
<div class="packt_infobox">The speedup provided by OpenVINO toolkit consists of two steps. The first step focuses on the hardware specifications; it optimizes the network in a hardware-agnostic way using a Model Optimizer, which ships along with OpenVINO toolkit. The next step involves hardware-specific acceleration using OpenVINO IE.</div>
<p>The OpenVINO toolkit was developed by Intel, which is known for its optimized tools as well as hardware, and is focused on deep learning and artificial intelligence. It's not surprising to know that VPUs, GPUs, and FPGAs are also manufactured by Intel.</p>
<p>OpenVINO also provides optimized calls for the OpenCV and OpenVX libraries—the two most well-known computer vision libraries.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">OpenVINO toolkit installation</h1>
                </header>
            
            <article>
                
<p>In this section, we will use Intel's official instructions to install OpenVINO toolkit:</p>
<ol>
<li>To start, first visit the OpenVINO toolkit download page (<a href="https://software.intel.com/en-us/openvino-toolkit/choose-download">https://software.intel.com/en-us/openvino-toolkit/choose-download</a>) and, depending on your system specifications, select and download the installer. You will have to first register your copy of the toolkit.</li>
<li>Use the installation instructions (<a href="https://docs.openvinotoolkit.org/latest/index.html">https://docs.openvinotoolkit.org/latest/index.html</a>) to install OpenVINO toolkit on your system.</li>
</ol>
<div class="packt_tip">OpenVINO toolkit will also install its own Intel-optimized version of OpenCV. If you already have OpenCV installed on your system, the installer will show that another version of OpenCV is already installed. It's better to install the ...</div></article></section></div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">OpenVINO components</h1>
                </header>
            
            <article>
                
<p>OpenVINO toolkit consists of the following main components:</p>
<ul>
<li>The <strong>Deep Learning Deployment Toolkit</strong> (<strong>DLDT</strong>) consists of Model Optimizer, the IE, pre-trained models and some tools to help you measure accuracy for your models.</li>
<li>There's an optimized version of OpenCV compiled for Intel libraries (which are also optimized).</li>
<li>There are OpenCL libraries.</li>
<li>You get Intel's media SDK to speed up video processing.</li>
<li>There's an optimized version of OpenVX.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Interactive face detection demo</h1>
                </header>
            
            <article>
                
<p>The OpenVINO toolkit installation also provides various demo and sample applications. Just to test the installation, let's see whether we can run the interactive face detection demo.</p>
<p>First, we will move to the <kbd>samples</kbd> directory in the <kbd>deployment_tools/inference_engine</kbd> folder. You will find the various demo applications here, such as image classification and inference pipeline.</p>
<p>The interactive face detection demo takes in video as input and performs face detection coupled with age, gender, head-pose, emotion, and facial landmark detection. Depending on the kind of detection you want to perform, you can use a model from the list of the following pre-trained models:</p>
<ul>
<li class="mce-root">You can perform face detection only with </li></ul></article></section></div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using OpenVINO Inference Engine with OpenCV</h1>
                </header>
            
            <article>
                
<p>In the previous section, we discussed how to run the interactive face detection demo. That's all good, but the question that still remains is how to harness the power of OpenVINO with your already existing OpenCV codes. Note that, here, we are emphasizing the utilization of the strength of OpenVINO with minimal changes in the code. This is very important because OpenVINO was not present in the earlier versions of OpenCV, including the more commonly used version 3.4.3. As a good developer, it's your job to make sure that your program supports the maximum number of systems and libraries. </p>
<p>Luckily for us, all it takes is just one line of code to start using OpenVINO Inference Engine for your OpenCV model's inference code, as shown in the following snippet:</p>
<pre>cv::dnn::setPreferableBackend(DNN_BACKEND_INFERENCE_ENGINE); // C++<br/><span>setPreferableBackend(cv2.dnn.DNN_BACKEND_INFERENCE_ENGINE) # Python</span><strong><span><br/></span></strong></pre>
<p><span>And that's it! In a complete working example, this is how you will be using it:</span></p>
<pre>net = cv2.dnn.readNetFromCaffe(prototxt,model)<br/>net.setPreferableBackend(cv2.dnn.DNN_BACKEND_INFERENCE_ENGINE)</pre>
<p>Here, you can use any other method of reading your neural network. In this case, we are reading a Caffe model from the <kbd>.prototxt</kbd> and <kbd>.caffemodel</kbd> files.</p>
<p>Similarly, in the case of C++, this is how we can use it:</p>
<pre>Net net = readNetFromCaffe(prototxt, model);<br/>net.setPreferableBackend(DNN_BACKEND_INFERENCE_ENGINE);</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using OpenVINO Model Zoo with OpenCV</h1>
                </header>
            
            <article>
                
<p>In the previous sections, we briefly discussed OpenVINO Model Zoo and how we can use OpenVINO IE with OpenCV. In this section, we will learn more about Model Zoo and what it offers.</p>
<p>OpenVINO Model Zoo is a collection of optimized pre-trained models that can be directly imported into OpenVINO for inference. The importance of this feature lies in the fact that one of the major reasons behind OpenVINO's speedup is the optimized model file that it takes for inference. The underlying inference principle is still the same as most deep learning inference toolkits and languages, such as OpenCV. OpenCV's <kbd>dnn</kbd> module uses this speedup principle of OpenVINO by using it as the default backend for all inference tasks. ...</p></article></section></div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Image classification using OpenCV with OpenVINO Inference Engine</h1>
                </header>
            
            <article>
                
<p>The final topic that we will discuss in this chapter is how to carry out image classification using OpenCV with OpenVINO Inference Engine.</p>
<p><span>Before we jump into the details, let's have a brief look at an image classification problem. Image classification, also known as <strong>image recognition</strong>, is a part of the deep learning set of tasks and is perhaps one of the most common ones. In this task, a set of images are provided as input to the model and the model outputs the class or the label of the input images.</span></p>
<p>A common example of this is the dog and cat classification problem where a model is trained on a large number of images of cats and dogs and then, during the testing phase, the model predicts whether the input image is an image of a cat or a dog.</p>
<p>While this might look like a very naive problem, image classification carries a lot of importance in industrial applications. For example, if your camera boasts of having AI powers, what it means is that it can recognize the objects present in the image and change the image settings accordingly—whether it is an image of natural scenery or an Instagram-worthy snap of some food. The following image shows the output of an AI mobile phone camera:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-839 image-border" src="Images/edbc92b5-3e6b-485b-8cc4-db57df905b74.png" style="width:185.50em;height:90.00em;" width="2226" height="1080"/></p>
<p>Consider the preceding image I took of the roof of my house. Note that the camera, when switched to AI mode, was able to detect that I was taking a picture of plants and automatically changed the settings to match that. All of this is possible only because of image classification. Now, consider that you, as a computer vision engineer, are trying to train a model that can recognize whether the image is of a plant, waterfall, or human. </p>
<p>All of the efforts that you put in training the model will be wasted if your model cannot infer the class or the label of the image within a few milliseconds. No user wants to wait for even a couple of seconds for the camera to detect the object and change the settings.</p>
<p>This brings us back to the importance of OpenVINO's Inference Engine. OpenVINO has its own version of an image classification toolkit that can be used as follows.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Image classification using OpenVINO</h1>
                </header>
            
            <article>
                
<p>Let's see how we can use the image classification demo present in OpenVINO's installation directory:</p>
<ol>
<li>First, move to the <kbd>deployment_tools/demo</kbd> directory in your OpenVINO installation directory.</li>
<li>Next, let's run image classification on a demo image that's already present in the directory:</li>
</ol>
<pre style="padding-left: 60px">./demo_squeezenet_download_convert_run.sh</pre>
<p>Here's the result that I obtained:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-840 image-border" src="Images/4f84a37b-53c0-40a9-8673-18c9ee7c79c5.png" style="width:78.75em;height:30.50em;" width="945" height="366"/></p>
<p>Let's also run another demo that uses the same image, the inference pipeline demo, which shows the speed of OpenVINO's Inference Engine quite well:</p>
<pre>./demo_security_barrier_camera.sh</pre>
<p>Here's the output image:</p>

<p>Since we are using the same image in ...</p></article></section></div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Image classification using OpenCV with OpenVINO</h1>
                </header>
            
            <article>
                
<p>Let's first create an image classification inference code using OpenCV. Since we are only concerned with inference, we will use a pre-trained model:</p>
<ol>
<li>First, let's download the Caffe model files, <kbd>deploy.prototxt</kbd> and <kbd>bvlc_reference_caffenet.caffemodel</kbd>, which can be obtained from Berkley Visions' repository (<a href="https://github.com/BVLC/caffe/tree/master/models/bvlc_reference_caffenet">https://github.com/BVLC/caffe/tree/master/models/bvlc_reference_caffenet</a>). Make sure that you download both files in your current working directory. We will also need a text file with the class labels mentioned. You can get it from <a href="https://github.com/torch/tutorials/blob/master/7_imagenet_classification/synset_words.txt">https://github.com/torch/tutorials/blob/master/7_imagenet_classification/synset_words.txt</a>.<a href="https://github.com/BVLC/caffe/tree/master/models/bvlc_reference_caffenet"/></li>
<li>Let's also use a sample image of a giraffe for image classification:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1056 image-border" src="Images/004ca3f3-bb76-4e72-a203-e1765a2ef6d3.jpg" style="width:17.42em;height:26.17em;" width="1632" height="2448"/></p>
<p style="padding-left: 60px">Next, let's start writing some code for image classification using OpenCV with OpenVINO.</p>
<ol start="3">
<li>Let's start off by importing some modules:</li>
</ol>
<pre style="padding-left: 60px">import numpy as np<br/>import cv2</pre>
<ol start="4">
<li>Next, let's specify the model files:</li>
</ol>
<pre style="padding-left: 60px">image = cv2.imread("animal-barbaric-brown-1319515.jpg")<br/>labels_file = "<span>synset_words.txt"<br/>prototxt = "deploy.prototxt"<br/>caffemodel = "bvlc_reference_caffenet.caffemodel"<br/></span></pre>
<ol start="5">
<li>Now, let's read the labels from the labels text file:</li>
</ol>
<pre style="padding-left: 60px">rows = open(labels_file).read().strip().split("\n")<br/>classes = [r[r.find(" ") + 1:].split(",")[0] for r in rows]</pre>
<ol start="6">
<li>Let's specify the backend that we will use for inference:</li>
</ol>
<pre style="padding-left: 60px">net = cv2.dnn.readNetFromCaffe(prototxt,caffemodel)<br/>net.setPreferableBackend(cv2.dnn.DNN_BACKEND_INFERENCE_ENGINE)<br/>net.setPreferableTarget(cv2.dnn.DNN_TARGET_CPU)</pre>
<ol start="7">
<li>Let's carry out some basic image processing on the input image:</li>
</ol>
<pre style="padding-left: 60px">blob = cv2.dnn.blobFromImage(image,1,(224,224),(104,117,123))</pre>
<ol start="8">
<li>Finally, let's pass this image to the model and get the output:</li>
</ol>
<pre style="padding-left: 60px">net.setInput(blob)<br/>predictions = net.forward()</pre>
<ol start="9">
<li>Let's obtain the top 10 predictions for the image of a giraffe we passed to the model:</li>
</ol>
<pre style="padding-left: 60px">indices = np.argsort(predictions[0])[::-1][:5]</pre>
<ol start="10">
<li>Finally, let's display the top 10 predictions:</li>
</ol>
<pre style="padding-left: 60px">for index in indices:<br/> print("label: {}, prob.: {:.5}".format(classes[index], predictions[0][index]))<strong><br/></strong></pre>
<p>And, surprisingly, here is the result we obtain:</p>
<pre>label: cheetah, prob.: 0.98357<br/>label: leopard, prob.: 0.016108<br/>label: snow leopard, prob.: 7.2455e-05<br/>label: jaguar, prob.: 4.5286e-05<br/>label: prairie chicken, prob.: 3.8205e-05</pre>
<p>Notice that our model thought that the <kbd>giraffe</kbd> image we passed as input was actually a <kbd>cheetah</kbd> image. Why do you think that's the case? That's because <kbd>giraffe</kbd> was not present in the list of classes we had. So, the model came up with the closest match, which was because of the similar colored spots present on cheetahs and giraffes. So, the next time you carry out image classification, make sure the class is actually present in the label list.</p>
<p>We can also carry out a comparison between various backends to see the speedup obtained using OpenVINO's Inference Engine as the backend. Here's how it can be done. We need to change just one line in the preceding code:</p>
<pre>net.setPreferableBackend(cv2.dnn.DNN_BACKEND_INFERENCE_ENGINE)<strong><br/></strong></pre>
<p>We can choose between the following backends:</p>
<ul>
<li><kbd>cv2.dnn.DNN_BACKEND_DEFAULT</kbd>: This is if you have OpenVINO installed and will use it as the default backend.</li>
<li><kbd>cv2.dnn.DNN_BACKEND_HALIDE</kbd>: This requires OpenCV to be built with Halide. You can find detailed documentation for this at <a href="https://docs.opencv.org/4.1.0/de/d37/tutorial_dnn_halide.html">https://docs.opencv.org/4.1.0/de/d37/tutorial_dnn_halide.html</a>.</li>
<li><kbd>cv2.dnn.DNN_BACKEND_OPENCV</kbd>: This is the best choice for carrying out a comparison between both the backends. </li>
</ul>
<p>So, all you need to do is run the same code but replace the preceding line of code with the following:</p>
<pre>net.setPreferableBackend(cv2.dnn.DNN_BACKEND_OPENCV)</pre>
<p>And that's it! You can now carry out a comparison to see the speedup you obtain by using OpenVINO's Inference Engine as the backend.</p>
<div class="packt_tip packt_infobox">You won't be able to see much difference in speed. To get a noticeable difference, use a <kbd>for</kbd> loop to carry out the inference 100 times, add up the total time taken during each step, and then divide it by 100 to obtain an average.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we briefly looked at the OpenVINO toolkit—what it is, what it's used for, and how we can install it. We also looked at how to run the demos and samples provided with the toolkit to understand and witness the power of OpenVINO. Finally, we saw how to harness this power in our pre-existing OpenCV codes by just adding one line specifying the backend to be used for model inference.</p>
<p>You might have also noticed that we didn't cover much hands-on content in this chapter. That's because OpenVINO is more suited for deep learning applications, which are not in the scope of this book. If you are a deep learning enthusiast, you should definitely go through the documentation provided by Intel on the OpenVINO toolkit and get started. ...</p></article></section></div>



  </body></html>