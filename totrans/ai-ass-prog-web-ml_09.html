<html><head></head><body>
  <div class="calibre1" id="_idContainer087">
    <h1 class="chapternumber">9</h1>
    <h1 class="chaptertitle" id="_idParaDest-173">Augment Web Apps with AI Services</h1>
    <h1 class="heading" id="_idParaDest-174">Introduction</h1>
    <p class="normal">There are several ways that a web app can be augmented with AI services: you could leverage an existing Web API exposing a model, or build it yourself and have it call a model.</p>
    <p class="normal1">The reason you would want to add AI to your app in the first place is to make it smarter. Not smarter for its own sake, but to make it more useful to the user. For example, if you have a web app that allows users to search for products, you could add a feature that suggests products based on the user’s previous purchases. In fact, why limit yourself to previous purchases? Why not suggest products based on the user’s previous searches? Or, what if the user could take a picture of a product and the app would suggest similar products?</p>
    <p class="normal1">As you can see, there are a lot of possibilities for augmenting your web app with AI that would improve the user experience.</p>
    <p class="normal1">In this chapter, we will:</p>
    <ul class="calibre15">
      <li class="bulletlist">Discuss different model formats like Pickle and ONNX</li>
      <li class="bulletlist1">Learn how to use both Pickle and ONNX to persist your model as a file using Python</li>
      <li class="bulletlist1">Consume a model stored in ONNX format and expose it via a REST API using JavaScript</li>
    </ul>
    <h1 class="heading" id="_idParaDest-175">Business domain, e-commerce</h1>
    <p class="normal">We keep working on our e-commerce domain, but our business focus is on ratings. A good or bad rating can influence how many units are sold of a specific product. The logical domain consists of the following:</p>
    <ul class="calibre15">
      <li class="bulletlist"><strong class="screentext">Products</strong>: the products to be rated</li>
      <li class="bulletlist1"><strong class="screentext">Ratings</strong>: the actual ratings and meta information like comments, dates and more</li>
    </ul>
    <h1 class="heading" id="_idParaDest-176">Problem and data domain</h1>
    <p class="normal">The problem to figure out is how we use this rating data and learn from it. </p>
    <ul class="calibre15">
      <li class="bulletlist"><strong class="screentext">Insights</strong>: We could, for example, get the insights that we should start/stop selling a certain product. There might be other insights as certain products sell well in certain parts of the world.</li>
      <li class="bulletlist1"><strong class="screentext">Technical</strong> <strong class="screentext">problem</strong>: The technical aspect of this is figuring out how to ingest the data, train a model from it, and then figure out how a web application can leverage said model.</li>
    </ul>
    <h1 class="heading" id="_idParaDest-177">Feature breakdown</h1>
    <p class="normal">Looking at this from a feature standpoint, we need to see this as consisting of three major parts.</p>
    <ul class="calibre15">
      <li class="bulletlist"><strong class="screentext">Data ingestion and training</strong>: this needs a separate interface, maybe it’s done without a user interface and it’s just static data being fed into code capable of training a model from it. With that understanding, we can outline the steps like so:<ul class="calibre17">
          <li class="bulletlist2">Load data</li>
          <li class="bulletlist3">Clean data</li>
          <li class="bulletlist3">Create features</li>
          <li class="bulletlist3">Train model</li>
          <li class="bulletlist3">Evaluate model</li>
          <li class="bulletlist3">Run predictions</li>
        </ul>
      </li>
      <li class="bulletlist1"><strong class="screentext">Consuming the model</strong>: Once the model is trained, it needs to be exposed, preferably through a web endpoint. To get there, we think we need these set of steps:<ul class="calibre17">
          <li class="bulletlist2">Convert the model to suitable format if needed</li>
          <li class="bulletlist3">Build a Web API</li>
          <li class="bulletlist3">Expose model through Web API</li>
          <li class="bulletlist3">Deploy model, there’s a step here where we need to bring the API online</li>
        </ul>
      </li>
      <li class="bulletlist1"><strong class="screentext">Prediction</strong>: For the prediction part, this is a functionality that’s meant for “back office” and not customer facing.<ul class="calibre17">
          <li class="bulletlist2">Build user interface to run predictions</li>
          <li class="bulletlist3">Build underlying code that talks to the Web API to make predictions possible</li>
        </ul>
      </li>
    </ul>
    <h1 class="heading" id="_idParaDest-178">Prompt strategy</h1>
    <p class="normal">You could go with either prompt approach here, either get suggestions from a prompt comment or use the chat interface.</p>
    <p class="normal1">For prompt pattern, we’ll use the “Exploratory pattern” as described in <em class="italic">Chapter 2</em>.</p>
    <h1 class="heading" id="_idParaDest-179">Creating a model</h1>
    <p class="normal">Imagine we<a id="_idIndexMarker204" class="calibre3"/> are dealing with the following data in the <code class="inlinecode">sales_rating.csv</code> file that is the result of merging two datasets, one containing sales data and the other containing rating data. The data looks like this:</p>
    <pre class="programlisting"><code class="hljs-code">product_id,avg_rating,sold 
1,2.5,100
2,3.7,200
3,4.2,300
4,1.3,50
5,4.9,800
6,3.2,150
7,2.1,80
8,4.8,500
9,3.9,400
10,2.4,200
11,4.1,300
12,3.2,100
13,2.9,150
14,4.5,500
15,3.8,400
16,2.7,200
17,4.3,300
18,3.4,100
19,2.3,150
20,4.7,500
</code></pre>
    <p class="normal1">The preceding data shows a dataset with <code class="inlinecode">product_id</code>, <code class="inlinecode">avg_rating</code>, and <code class="inlinecode">sold</code> columns. Our theory is that the average rating of a product is correlated with the number of sales. It seems like a fair assumption that a product with a high rating will sell more than a product with a low rating. By creating a model, we can come closer to determining whether it’s likely that our assumption is true or not.</p>
    <h1 class="heading" id="_idParaDest-180">Coming up with a plan</h1>
    <p class="normal">We can ask Copilot about the steps we need to take to create a model. We type these prompts as comments:</p>
    <div class="packt_tip">
      <p class="normal1">If you want to ask Copilot to come up with text answers about something else other than code, you can type the text as a comment in a code file or inside of a Markdown file. It also helps to place yourself on the next row after the comment and start the row with “a:” for answer. You can also ask questions using Copilot Chat:</p>
    </div>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Tell me the answer of life, the universe and everything.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">a: 42
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">The above reference is<a id="_idIndexMarker205" class="calibre3"/> from the book <em class="italic">Hitchhikers guide to the Galaxy</em> by Douglas Adams.</p>
    <p class="normal1">Next, let’s ask Copilot to help us with the steps to create a model.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">What are the steps to create a model in Python given a CSV file?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1">Output:</p>
    <ul class="calibre15">
      <li class="bulletlist">import pandas and scikit-learn</li>
      <li class="bulletlist1">read the CSV file</li>
      <li class="bulletlist1">create a test and training dataset</li>
      <li class="bulletlist1">create a model</li>
      <li class="bulletlist1">how good is the model?</li>
      <li class="bulletlist1">predict</li>
      <li class="bulletlist1">save the model to pkl </li>
    </ul>
    <p class="normal1">OK, we have a plan, so let’s execute it and use Copilot to help us with the code.</p>
    <h2 class="heading1" id="_idParaDest-181">Importing libraries</h2>
    <p class="normal">First, let’s start <a id="_idIndexMarker206" class="calibre3"/>by creating a new notebook in VS Code. Let’s call it <code class="inlinecode">sales.ipynb</code>.</p>
    <div class="note">
      <p class="normal1"><code class="inlinecode">.ipynb</code> is the file format for Jupyter Notebook that you as a data science practitioner are most likely familiar with. The idea is that you work on a file with cells, where some cells are text cells and others are code cells you can run.</p>
    </div>
    <p class="normal1">To use certain libraries, we need to install them. We can use Copilot to help us with that. We can leverage the fact that we are data science practitioners and therefore have an understanding of<a id="_idIndexMarker207" class="calibre3"/> what libraries we need. Therefore, we will suggest the pandas and scikit-learn libraries below to help us with our task.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Install pandas and scikit-learn in a notebook.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting2"><code class="hljs-con">! pip install pandas scikit-learn
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Next, let’s import the libraries we need.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Import pandas and scikit-learn in a notebook.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Import pandas and scikit-learn in a notebook.</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> sklearn.linear_model
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <h2 class="heading1" id="_idParaDest-182">Reading the CSV file</h2>
    <p class="normal">Now that<a id="_idIndexMarker208" class="calibre3"/> we have the libraries we need, let’s read the CSV file.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Read a CSV file in a notebook.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Read a CSV file in a notebook. </span>
df = pd.read_csv(<span class="hljs-string">"sales_rating.csv"</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">The CSV file is now loaded into a pandas DataFrame, a structure holding columns and rows. Let’s take a look at the first few rows.</p>
    <pre class="programlisting"><code class="hljs-code">df.head()
</code></pre>
    <p class="normal1">This will produce the following output:</p>
    <pre class="programlisting2"><code class="hljs-con">    product_id  avg_rating  sold
0            1         2.5   100
1            2         3.7   200
2            3         4.2   300
3            4         1.3    50
4            5         4.9   800
</code></pre>
    <p class="normal1">Great, we have the data loaded into a DataFrame. Next, we need to split the data into test and training datasets.</p>
    <h2 class="heading1" id="_idParaDest-183">Creating test and training datasets</h2>
    <p class="normal">In<a id="_idIndexMarker209" class="calibre3"/> machine learning, we typically split the data into test and training datasets. The training dataset is used to train the model and the test dataset is used to test the model. We can use Copilot to help us with this.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Create test and training dataset in a notebook, suggested test size of 0.2.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Create a test and training dataset in a notebook, suggested test size of 0.2</span>
test_size = <span class="hljs-attr">0.2</span>
test = df.sample(frac=test_size)
training = df.drop(test.index)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">0.2 is a good test size. It means that 20% of the data will be used for testing and 80% will be used for training.</p>
    <div class="packt_tip">
      <p class="normal1">You may need to start typing “test_size” and “training” on the respective rows, then press <em class="italic">TAB</em> to accept the suggestion.</p>
    </div>
    <p class="normal1">Now we have things set up, let’s create a model next.</p>
    <h2 class="heading1" id="_idParaDest-184">Creating a model</h2>
    <p class="normal">Creating a <a id="_idIndexMarker210" class="calibre3"/>model involves selecting the algorithm we want to use and then training the model. Let’s suggest a prompt:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Create a model in a notebook using the <code class="inlinecode">LinearRegression</code> algorithm.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Create a model in a notebook using the LinearRegression algorithm.</span>
model = sklearn.linear_model.LinearRegression()
model.fit(training[[<span class="hljs-string">"avg_rating"</span>]], training[[<span class="hljs-string">"sold"</span>]])
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">In the preceding code, we created a model using the <code class="inlinecode">LinearRegression</code> algorithm and then trained the model using the training dataset with the <code class="inlinecode">fit</code> method. Also, note how we are using the <code class="inlinecode">avg_rating</code> column as the input and the <code class="inlinecode">sold</code> column as the output. This is because we<a id="_idIndexMarker211" class="calibre3"/> want to predict the number of sales based on the average rating.</p>
    <h2 class="heading1" id="_idParaDest-185">How good is the model?</h2>
    <p class="normal">At this point, we want to find out how good the model is. To find this out, let’s ask Copilot to help us.</p>
    <div class="note">
      <p class="normal1">You can either use a comment style and get suggestions inline, or use Copilot Chat. In both cases, Copilot will understand from the context.</p>
    </div>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How good is the model in a notebook? Show the code.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># How good is the model in a notebook? Show the code.</span>
score = model.score(test[[<span class="hljs-string">"avg_rating"</span>]], test[[<span class="hljs-string">"sold"</span>]])
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">It seems that calling <code class="inlinecode">score</code> on the model and passing in the <code class="inlinecode">test</code> dataset is how we find out how good a model is. We can even ask Copilot about this:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">What does score do?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">score returns the coefficient of determination R^2 of the prediction.
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">If you want, you keep querying and have things explained in more detail, like with the below prompt:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong> </p>
    <p class="normal1">What does that mean in simpler terms?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">it returns a number between 0 and 1, where 1 is perfect prediction and 0 is no prediction.
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <h2 class="heading1" id="_idParaDest-186">Predict</h2>
    <p class="normal">We won’t know <a id="_idIndexMarker212" class="calibre3"/>how good the model is until we try to predict something, even if we could refer to the score value. Let’s craft a prompt for this task:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Predict in a notebook. Show the code.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Predict in a notebook. Show the code.</span>
predictions = model.predict(test[[<span class="hljs-string">"avg_rating"</span>]])
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">OK, we got a<a id="_idIndexMarker213" class="calibre3"/> variable called <code class="inlinecode">predictions</code> that contains the predictions, but it is hard to understand if the predictions are reasonable. Let’s try asking Copilot and see what it suggests.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How do you suggest we show the predictions in a notebook?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">print the predictions
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Any other ways you suggest we show the predictions in a notebook except for printing?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">plot the predictions
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Now that we’ve gotten more information on our various options, let’s use that knowledge in a prompt:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Show me how to print and plot predictions vs the actual data in a notebook.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Show me how to print and plot predictions vs actual data in a notebook.</span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
plt.scatter(test[[<span class="hljs-string">"avg_rating"</span>]], test[[<span class="hljs-string">"sold"</span>]],  color=<span class="hljs-string">'black'</span>)
plt.plot(test[[<span class="hljs-string">"avg_rating"</span>]], predictions, color=<span class="hljs-string">'blue'</span>, linewidth=<span class="hljs-attr">3</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Running this code in a notebook will produce the following plot:</p>
    <figure class="mediaobject"><img alt="plot" src="../Images/B21232_09_01.png" class="calibre19"/></figure>
    <p class="packt_figref">Figure 9.1: Plot showing predictions vs actual data</p>
    <p class="normal1">In the plot, it looks<a id="_idIndexMarker214" class="calibre3"/> like the line is a good fit for the data. We can also print predictions to see the actual values:</p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-built_in">print</span>(predictions)
</code></pre>
    <h2 class="heading1" id="_idParaDest-187">Saving the model to a .pkl file</h2>
    <p class="normal">We have <a id="_idIndexMarker215" class="calibre3"/>one step left: we need to save the model to a file. We have a few different choices for how to save the model. We can save it as a pickle file or an ONNX file, for example. Let’s start with saving it as a pickle file.</p>
    <p class="normal1">As usual, let’s craft a prompt for this task:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Save the model to a pkl in the notebook.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Save the model to pkl in a notebook.</span>
<span class="hljs-keyword">import</span> pickle
pickle.dump(model, <span class="hljs-built_in">open</span>(<span class="hljs-string">"model.pkl"</span>, <span class="hljs-string">"wb"</span>))
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <div class="packt_tip">
      <p class="normal1">For the completion of the above, you may need to start typing “import” to get the suggestion. Additionally, it’s a good bet it’s going to use the pickle library, so on the next line you can start typing “pickle” and press <em class="italic">TAB</em> to accept the suggestion.</p>
    </div>
    <h2 class="heading1" id="_idParaDest-188">Creating a REST API in Python</h2>
    <p class="normal">At this<a id="_idIndexMarker216" class="calibre3"/> point, we have a <code class="inlinecode">model.pkl</code> file that <a id="_idIndexMarker217" class="calibre3"/>contains our model. We can expose the model using this file via a REST API. Let’s ask Copilot to help us with this.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Create a REST API in Python that exposes the model in a pkl file.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># Create a REST API in Python that exposes the model in a pkl file.</span>
<span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">import</span> flask
<span class="hljs-comment"># load the model</span>
model = pickle.load(<span class="hljs-built_in">open</span>(<span class="hljs-string">"model.pkl"</span>, <span class="hljs-string">"rb"</span>))
<span class="hljs-comment"># app</span>
app = flask.Flask(__name__)
<span class="hljs-comment"># routes</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/'</span><span>, methods=[</span><span class="hljs-string">'GET'</span><span>, </span><span class="hljs-string">'POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">predict</span>():
    <span class="hljs-keyword">if</span> flask.request.method == <span class="hljs-string">'GET'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Please POST a JSON object to this endpoint to get a prediction."</span>
    <span class="hljs-keyword">else</span>:
        data = flask.request.json
        prediction = model.predict([[data[<span class="hljs-string">"avg_rating"</span>]]])
        <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">"prediction"</span>: prediction[<span class="hljs-attr">0</span>][<span class="hljs-attr">0</span>]})
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <div class="note">
      <p class="normal1">Note how we use several prompts above. First, we set the context by adding the prompt “Create a REST API in Python that exposes the model in a pkl file” at the top of the file. Then we use various helper prompts like “load the model”, “app”, and “routes” to help us with the code. We end up with an API that exposes the model via a REST API.</p>
    </div>
    <h1 class="heading" id="_idParaDest-189">Converting the model to ONNX</h1>
    <p class="normal">So far, you’ve seen <a id="_idIndexMarker218" class="calibre3"/>how we can use Pickle to save a model and then load it in Python. However, Pickle has drawbacks, including being Python-specific. ONNX, on the other hand, is a format that is not Python-specific and can be used in other languages. Let’s see how we can use the ONNX format to work with our model.</p>
    <p class="normal1">We need to solve our task in two steps:</p>
    <ul class="calibre15">
      <li class="bulletlist">Convert the model to ONNX format.</li>
      <li class="bulletlist1">Load the model and create a REST API in JavaScript.</li>
    </ul>
    <h2 class="heading1" id="_idParaDest-190">Creating a model in ONNX format</h2>
    <p class="normal">Because we’re using a<a id="_idIndexMarker219" class="calibre3"/> notebook, we need to install the dependencies, import the libraries we need, and then convert the model to ONNX format.</p>
    <p class="normal1"><strong class="screentext">[Prompt] </strong></p>
    <p class="normal1">What dependencies do I need for ONNX? Show me the Python code for installing those dependencies. </p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting2"><code class="hljs-con">! pip install skl2onnx
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Show me how to import the libraries I need for ONNX and show me how to convert the model to ONNX format.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">import</span> skl2onnx
<span class="hljs-comment"># convert the model to ONNX</span>
skl2onnx.to_onnx(model, train[[<span class="hljs-string">"avg_rating"</span>]].astype(<span class="hljs-string">"float32"</span>), <span class="hljs-string">"model.onnx"</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Now I should have a <code class="inlinecode">model.onnx</code> file that contains the model in ONNX format. Let’s see if we can load it in<a id="_idIndexMarker220" class="calibre3"/> JavaScript next.</p>
    <h1 class="heading" id="_idParaDest-191">Loading the ONNX model in JavaScript</h1>
    <p class="normal">Next, we <a id="_idIndexMarker221" class="calibre3"/>need to load the ONNX model in JavaScript and specifically Node.js, as we’re doing this on the backend. We can use the <code class="inlinecode">onnxruntime</code> library to do this. Let’s ask Copilot to help us with this.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Show me a step-by-step guide to load the ONNX model in JavaScript.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <ul class="calibre15">
      <li class="bulletlist">install onnxruntime in JavaScript</li>
      <li class="bulletlist1">load the ONNX model in JavaScript </li>
      <li class="bulletlist1">predict using ONNX model in JavaScript</li>
    </ul>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Now that we have a plan, let’s execute it.</p>
    <h2 class="heading1" id="_idParaDest-192">Installing onnxruntime in JavaScript</h2>
    <p class="normal">Because<a id="_idIndexMarker222" class="calibre3"/> we’re building a Node.js project, let’s first, in a new folder, create an <code class="inlinecode">app.js</code> file and run the <code class="inlinecode">npm init -y</code> terminal command to create a new Node.js project.</p>
    <p class="normal1">The first step in our <a id="_idIndexMarker223" class="calibre3"/>plan is to install <code class="inlinecode">onnxruntime</code> in JavaScript. We can use npm to perform this task.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Install onnxruntime in JavaScript.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting2"><code class="hljs-con">npm install onnxruntime
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Great, this installs the <code class="inlinecode">onnxruntime</code> library in our project. Next, we need to load the ONNX model.</p>
    <h2 class="heading1" id="_idParaDest-193">Loading the ONNX model in JavaScript</h2>
    <p class="normal">Now that<a id="_idIndexMarker224" class="calibre3"/> we <a id="_idIndexMarker225" class="calibre3"/>have <code class="inlinecode">onnxruntime</code> installed, we can load the ONNX model.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Load the ONNX model in JavaScript.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">const rt = require(<span class="hljs-string">"onnxruntime"</span>);
<span class="hljs-comment"># load model from ONNX</span>
model rt.InferenceSession(<span class="hljs-string">"model.onnx"</span>);
<span class="hljs-comment"># predict</span>
model.run(null, {model.get_inputs()[<span class="hljs-attr">0</span>].name: [[<span class="hljs-attr">4.5</span>]]});
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">In the<a id="_idIndexMarker226" class="calibre3"/> preceding code, we load the model from the<a id="_idIndexMarker227" class="calibre3"/> ONNX file and then we make predictions using the model with the input <code class="inlinecode">4.5</code> to represent the average rating to see what sales we can expect.</p>
    <h1 class="heading" id="_idParaDest-194">Assignment: Build a REST API in JavaScript that consumes the model</h1>
    <ol class="calibre20">
      <li class="bulletlist1" value="1">Take the model we created in the previous section and add the code to the notebook to turn it into an ONNX file.</li>
      <li class="bulletlist1">Create a new folder in the repo called and create a new file called <code class="inlinecode">app.js</code> in that folder.</li>
      <li class="bulletlist1">Add the POST /predict route to the <code class="inlinecode">server.js</code> file and ensure it returns a prediction given the input.</li>
    </ol>
    <p class="normal1">Here’s some<a id="_idIndexMarker228" class="calibre3"/> starter prompts you can try to help you with this assignment:</p>
    <ul class="calibre15">
      <li class="bulletlist"><strong class="screentext">Prompt</strong>: Create a REST API in JavaScript using Express</li>
      <li class="bulletlist1"><strong class="screentext">Prompt</strong>: Create a POST /predict route in a REST API in JavaScript using Express</li>
      <li class="bulletlist1"><strong class="screentext">Prompt</strong>: Load the model from ONNX in a REST API in JavaScript using Express </li>
      <li class="bulletlist1"><strong class="screentext">Prompt</strong>: Predict using the ONNX model in a REST API in JavaScript using Express</li>
    </ul>
    <h1 class="heading" id="_idParaDest-195">Solution</h1>
    <p class="normal">See repo [<a href="https://github.com/PacktPublishing/AI-Assisted-Software-Development-with-GitHub-Copilot-and-ChatGPT/tree/main/09" class="calibre3"><span class="calibre3">https://github.com/PacktPublishing/AI-Assisted-Software-Development-with-GitHub-Copilot-and-ChatGPT/tree/main/09</span></a>] and the <em class="italic">09</em> folder for the solution.</p>
    <h1 class="heading" id="_idParaDest-196">Quiz</h1>
    <p class="normal">What’s the difference between Pickle and ONNX?</p>
    <ol class="calibre16">
      <li class="bulletlist1" value="1">Pickle is Python-specific and ONNX is not.</li>
      <li class="bulletlist1">Pickle can be used in JavaScript and ONNX can’t.</li>
      <li class="bulletlist1">ONNX is less efficient than Pickle.</li>
    </ol>
    <h1 class="heading" id="_idParaDest-197">Summary</h1>
    <p class="normal">In this chapter, we covered various model formats like Pickle and ONNX and how to persist your model as a file using Python. Storing a model as a file is useful because it allows you to integrate it with other applications.</p>
    <p class="normal1">Then we discussed the pros and cons of different formats for storing models like Pickle and ONNX. We came to the conclusion that ONNX is probably the better choice because it’s not Python-specific and can be used in other languages.</p>
    <p class="normal1">Then we covered how to load a model stored in ONNX format using JavaScript and create a REST API to make the model available to other applications.</p>
    <p class="normal1">In the next chapter, we’ll go into more detail of how we can use GitHub Copilot and get the most out of it. We’ll cover both tips and tricks and features that help make you faster and more productive.</p>
    <h1 class="heading" id="_idParaDest-198">Join our community on Discord </h1>
    <p class="normal">Join our community’s Discord space for discussions with the author and other readers: </p>
    <p class="normal1"><a href="https://packt.link/aicode" class="calibre3"><span class="calibre3">https://packt.link/aicode</span></a></p>
    <p class="normal1"><span class="calibre3"><img alt="" src="../Images/QR_Code510410532445718281.png" class="calibre4"/></span></p>
  </div>
</body></html>