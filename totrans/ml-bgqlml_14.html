<html><head></head><body>
		<div id="_idContainer160">
			<h1 id="_idParaDest-158"><em class="italic"><a id="_idTextAnchor160"/>Chapter 11</em>: Implementing Deep Neural Networks </h1>
			<p><strong class="bold">Deep Neural Networks</strong> (<strong class="bold">DNNs</strong>) are<a id="_idIndexMarker506"/> one of the most advanced techniques to implement machine learning algorithms. They're widely used for different use cases and can be considered pervasive in everyday life.</p>
			<p>When we interact with a virtual assistant, or we use mobile applications for automatic translation and image recognition, we're leveraging the capabilities of DNNs trained with large datasets of audio and images.</p>
			<p>After reading this chapter, you'll be able to develop, evaluate, and test a DNN using BigQuery ML. In this chapter, we'll see all the stages necessary to implement a DNN by using BigQuery ML to predict the duration of rentals related to the New York City bike-sharing service. </p>
			<p>Using BigQuery ML, we'll go through the following topics:</p>
			<ul>
				<li>Introducing the business scenario</li>
				<li>Discovering DNNs</li>
				<li>Preparing the dataset</li>
				<li>Training the DNN models</li>
				<li>Evaluating the DNN models</li>
				<li>Using the DNN models</li>
				<li>Drawing business conclusions</li>
			</ul>
			<h1 id="_idParaDest-159"><a id="_idTextAnchor161"/>Technical requirements</h1>
			<p>This chapter requires you to have access to a web browser and to be able to leverage the following:</p>
			<ul>
				<li>A GCP account to access Google Cloud Console</li>
				<li>A GCP project to host the BigQuery datasets</li>
			</ul>
			<p>Now that we're ready with the technical requirements, let's dive into the analysis and development of our BigQuery ML DNN models.</p>
			<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/33lbq8A">https://bit.ly/33lbq8A</a></p>
			<h1 id="_idParaDest-160"><a id="_idTextAnchor162"/>Introducing the business scenario</h1>
			<p>In this section, you'll be<a id="_idIndexMarker507"/> introduced to the business scenario that will be handled with the DNNs technique.</p>
			<p>The business scenario is very similar to the use case presented and used in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>. In this chapter, we'll use the same dataset related to the New York City bike-sharing service, but we'll apply more advanced machine learning algorithms.</p>
			<p>We can remember that the hypothetical goal of the ML model is to predict the trip time of a bike rental. The predicted value could be used to provide a better experience to the customers of the bike-sharing service through the new mobile application. Leveraging the predicted ride duration, the customer will get a clear indication of the time it will take to reach a specific destination and also an estimation of the ride cost.</p>
			<p>Now that we've explained and understood the business scenario, let's take a look at the machine learning technique that we can use to automatically classify trees according to their features.</p>
			<h1 id="_idParaDest-161"><a id="_idTextAnchor163"/>Discovering DNNs</h1>
			<p>In this section, we'll<a id="_idIndexMarker508"/> learn what <strong class="bold">DNNs</strong> are, and we'll understand which regression and classification use cases can be managed with advanced machine learning algorithms.</p>
			<p><strong class="bold">Artificial Neural Networks</strong> (<strong class="bold">ANNs</strong>) are <a id="_idIndexMarker509"/>artificial systems that try to reproduce the human brain. They're inspired by biological neural networks and are composed of neurons and synapses that connect the neurons. Each neuron of the artificial network is a component that applies a specific mathematical activation function to the input and returns an output that is passed through a synapse to the next neuron. In ANNs, the neurons are usually organized in layers between the input and the output.</p>
			<p>Different from linear models, ANNs are designed to model non-linear relationships between the input and the output variables.</p>
			<p><strong class="bold">DNNs</strong> are <a id="_idIndexMarker510"/>ANNs composed of multiple layers between the input and the output, usually two or more. Each layer of neurons is <a id="_idIndexMarker511"/>called a <strong class="bold">hidden layer</strong> and its function is to accept a series of input signals and return to the next layer a series of output signals.</p>
			<p>In the following diagram, we can see that a DNN is composed of three input variables, two hidden layers, and an output variable:</p>
			<div>
				<div id="_idContainer153" class="IMG---Figure">
					<img src="image/B16722_11_001.jpg" alt="Figure 11.1 – Diagram of a DNN&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.1 – Diagram of a DNN</p>
			<p>Each neuron in the network applies a specific function to the input signal and returns the output of the function as the output of the neuron. Training a DNN is an activity focused on finding the right weights of each synapse between each neuron in the network. </p>
			<p>Although, to achieve the potential of DNNs we need important hardware resources, the machine learning models implemented with this technique can achieve optimal results in important tasks that are typical of the human brain. Some examples are as follows:</p>
			<ul>
				<li><strong class="bold">Speech recognition</strong>: The<a id="_idIndexMarker512"/> ability to process an audio file to identify the words of a speech, making them readable. This capability is widely used in the virtual assistants of our smartphones or in contact center applications.</li>
				<li><strong class="bold">Image and face recognition</strong>: The possibility to recognize different entities, animals, or persons in <a id="_idIndexMarker513"/>pictures and videos. This technique is particularly useful to automatically extract insights from images and videos avoiding any manual effort.</li>
				<li><strong class="bold">Natural language processing</strong>: Widely used to analyze and retrieve information from free <a id="_idIndexMarker514"/>texts and to analyze the sentiment of the messages. For example, these kinds of algorithms are used to automatically identify the policy violations in the social networks or to evaluate the sentiment in the product reviews.</li>
			</ul>
			<p>Now that we've discovered what DNNs are, let's focus on how BigQuery ML offers these powerful algorithms.</p>
			<h2 id="_idParaDest-162"><a id="_idTextAnchor164"/>DNNs in BigQuery ML</h2>
			<p>In this section, we'll learn<a id="_idIndexMarker515"/> the model type options <a id="_idIndexMarker516"/>provided by BigQuery ML to create a DNN model.</p>
			<p>BigQuery ML allows you to create two different types of DNNs:</p>
			<ul>
				<li><strong class="bold">DNNClassifier</strong>: This <a id="_idIndexMarker517"/>algorithm can be used to classify events, objects, or entities into a finite number of discrete classes.</li>
				<li><strong class="bold">DNNRegressor</strong>: This <a id="_idIndexMarker518"/>kind of model is similar to the previous one with the difference that it returns a continuous result. For this reason, it can be used to predict numerical values.</li>
			</ul>
			<p>For our business scenario, we'll use <strong class="bold">DNNRegressor</strong> because<a id="_idIndexMarker519"/> our goal is to predict a continuous value: <em class="italic">the ride time of the bike rental</em>.</p>
			<p>When we've chosen which type of <a id="_idIndexMarker520"/>DNN to use according to our use<a id="_idIndexMarker521"/> case, the next choice will be focused on the function that each neuron will apply to the input signal. BigQuery ML allows us to choose one of the following functions:</p>
			<ul>
				<li><strong class="bold">Rectified Linear Function</strong> (<strong class="bold">ReLU</strong>): This is a linear function that returns the input value itself if it's <a id="_idIndexMarker522"/>positive, otherwise zero.</li>
				<li><strong class="bold">ReLU6</strong>: This is <a id="_idIndexMarker523"/>similar to the previous function with a capped maximum output value of 6. This is just an arbitrary value that derives from empirical tests of the different functions.</li>
				<li><strong class="bold">Concatenated Rectified Linear Units</strong> (<strong class="bold">CReLU</strong>): Different from the previous functions, it preserves the <a id="_idIndexMarker524"/>negative values.</li>
				<li><strong class="bold">Exponential Linear Unit</strong> (<strong class="bold">ELU</strong>): This is<a id="_idIndexMarker525"/> an exponential function that tends to converge to the result faster and produce outputs with more accuracy.</li>
				<li><strong class="bold">Scaled Exponential Linear Unit</strong> (<strong class="bold">SELU</strong>): This is an evolution of ELU that adds the self-normalization of <a id="_idIndexMarker526"/>the math function.</li>
				<li><strong class="bold">SIGMOID</strong>: This is similar to<a id="_idIndexMarker527"/> a step function and always outputs a value between 0 and 1. This function introduces non-linearity into the DNN.</li>
				<li><strong class="bold">TANH</strong>: This is <a id="_idIndexMarker528"/>similar to the sigmoid function but returns a value between -1 and 1.</li>
			</ul>
			<p>Each function has some pros and cons, and they should be chosen according to the use case and to the training dataset to achieve the best results. For our business scenario, we'll experiment with the training of DNNs using some of these functions and choose the function that produces the best results.</p>
			<p>Now that we've learned the basics of DNNs and the main options that BigQuery ML offers through its SQL interface, let's start preparing the data for the creation of our machine learning models.</p>
			<h1 id="_idParaDest-163"><a id="_idTextAnchor165"/>Preparing the dataset</h1>
			<p>Before starting the ML<a id="_idIndexMarker529"/> implementation, it's necessary to analyze and prepare the data for our use case. Since the dataset has been already used in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>, we will not start the analysis from the beginning, but we will focus exclusively on the queries relevant for our use case.</p>
			<p>To start the preparation of our data, we need to do the following:</p>
			<ol>
				<li>Log into Google Cloud Console and access the <strong class="bold">BigQuery</strong> user interface from the navigation menu.</li>
				<li>Create a new dataset under the project that we created in <a href="B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039"><em class="italic">Chapter 2</em></a>,<em class="italic"> Setting Up Your GCP and BigQuery Environment</em>. For this use case, we'll create the dataset <strong class="source-inline">11_nyc_bike_sharing_dnn</strong> with the default options.</li>
				<li>Now we're ready to create the table that will contain the training dataset. Let's execute the following SQL statement:<p class="source-code">CREATE OR REPLACE TABLE `11_nyc_bike_sharing_dnn.training_table` AS</p><p class="source-code">              SELECT </p><p class="source-code">                   tripduration/60 tripduration,</p><p class="source-code">                   start_station_name,</p><p class="source-code">                   end_station_name,</p><p class="source-code">                   IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">                   EXTRACT(YEAR FROM starttime)-birth_year as age</p><p class="source-code">              FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE </p><p class="source-code">                    (</p><p class="source-code">                        (EXTRACT (YEAR FROM starttime)=2017 AND</p><p class="source-code">                          (EXTRACT (MONTH FROM starttime)&gt;=04 OR EXTRACT (MONTH FROM starttime)&lt;=10))</p><p class="source-code">                        OR (EXTRACT (YEAR FROM starttime)=2018 AND</p><p class="source-code">                          (EXTRACT (MONTH FROM starttime)&gt;=01 OR EXTRACT (MONTH FROM starttime)&lt;=02))</p><p class="source-code">                    )</p><p class="source-code">                    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007; </p><p>The result of the query is stored in the new table, <strong class="source-inline">`11_nyc_bike_sharing_dnn.training_table`</strong>, which we've created to support the following steps of our use case.</p><p>The <strong class="source-inline">SELECT</strong> statement extracts the fields from the table <strong class="source-inline">citibike_trips</strong> and applies some transformations. <strong class="source-inline">tripduration</strong> is converted from seconds to minutes. The <a id="_idIndexMarker530"/>fields <strong class="source-inline">start_station_name</strong> and <strong class="source-inline">end_station_name</strong> are extracted as is. Using <strong class="source-inline">starttime</strong>, the query calculates whether the rental is happening during the week or at the weekend. Finally, the age of the customer at the time of the ride is calculated using the difference between <strong class="source-inline">starttime</strong> and <strong class="source-inline">birth_year</strong>.</p><p>As we've already done in the <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>, the <strong class="source-inline">WHERE</strong> clause allows us to consider only the months that we want to use for the training stage. The time frame goes from April 2017 to February 2018 for the training dataset. In the same <strong class="source-inline">WHERE</strong> clause, we've also applied the filters that come from the data quality checks.</p></li>
				<li>After the <a id="_idIndexMarker531"/>creation of the training table, we can create the second table dedicated to the records that will be used to evaluate our machine learning model:<p class="source-code">CREATE OR REPLACE TABLE  `11_nyc_bike_sharing_dnn.evaluation_table` AS</p><p class="source-code">SELECT </p><p class="source-code">                   tripduration/60 tripduration,</p><p class="source-code">                   start_station_name,</p><p class="source-code">                   end_station_name,</p><p class="source-code">                   IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">                   EXTRACT(YEAR FROM starttime)-birth_year as age</p><p class="source-code">               FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">               WHERE </p><p class="source-code">                    (EXTRACT (YEAR FROM starttime)=2018 AND (EXTRACT (MONTH FROM starttime)=03 OR EXTRACT (MONTH FROM starttime)=04))</p><p class="source-code">                    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007;</p><p>The query is very similar to the statement used to create the training table. The only difference is related to the period selected in the <strong class="source-inline">WHERE</strong> clause. For the table <strong class="source-inline">`11_nyc_bike_sharing_dnn.evaluation_table`</strong>, we've focused our <strong class="source-inline">SELECT</strong> statement on the records related to the months of March and April of 2018 that were previously excluded from the training table.</p></li>
				<li>Adopting<a id="_idIndexMarker532"/> the same approach, we can also create the table that will be used to test our machine learning model:<p class="source-code">CREATE OR REPLACE TABLE  `11_nyc_bike_sharing_dnn.prediction_table` AS</p><p class="source-code">              SELECT </p><p class="source-code">                   tripduration/60 tripduration,</p><p class="source-code">                  start_station_name,</p><p class="source-code">                   end_station_name,</p><p class="source-code">                   IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">                   EXTRACT(YEAR FROM starttime)-birth_year as age</p><p class="source-code">              FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE </p><p class="source-code">                    EXTRACT (YEAR FROM starttime)=2018</p><p class="source-code">                    AND EXTRACT (MONTH FROM starttime)=05</p><p class="source-code">                     AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007;</p><p>The query <a id="_idIndexMarker533"/>applies the same logic used to create the training and the evaluation table but takes into consideration only the month of May 2018.</p></li>
			</ol>
			<p>Now that we've segmented our dataset and are clear on which records to use for the training, evaluation, and test phase, let's train our DNN models with BigQuery ML.</p>
			<h1 id="_idParaDest-164"><a id="_idTextAnchor166"/>Training the DNN models</h1>
			<p>Now that we've<a id="_idIndexMarker534"/> segmented the dataset into multiple tables to support the different stages of the ML model life cycle, let's train our DNN regression models using different activation functions:</p>
			<ol>
				<li value="1">First of all, we can start with the training of a DNN model by using the <strong class="source-inline">RELU</strong> function. Let's execute the following SQL statement to create the machine learning model <strong class="source-inline">`11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`</strong>:<p class="source-code">CREATE OR REPLACE MODEL `11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='DNN_REGRESSOR',</p><p class="source-code">        ACTIVATION_FN = 'RELU') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">  is_weekend,</p><p class="source-code">  age,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `11_nyc_bike_sharing_dnn.training_table`;</p><p>In the SQL statement, we can notice the keywords <strong class="source-inline">CREATE OR REPLACE MODEL</strong> used to create a new model. These keywords are followed by the identifier of the model represented by the concatenation of the dataset and ML model name.</p><p>After these first lines, we find the <strong class="source-inline">OPTIONS</strong> keyword where the type of machine learning model is specified. Since we're trying to predict the continuous field <strong class="source-inline">tripduration</strong>, we've chosen to use <strong class="source-inline">DNN_REGRESSOR</strong> as <strong class="source-inline">model_type</strong>.</p><p>The other <a id="_idIndexMarker535"/>important option during the training of a DNN is the activation function that will be applied to the neurons of the network. For this first attempt, we're using one of the most common functions: <strong class="source-inline">RELU</strong>. This choice is specified with the clause <strong class="source-inline">ACTIVATION_FN = 'RELU'</strong>.</p><p>After <strong class="source-inline">OPTIONS</strong>, we need to specify the set of records on which the ML model will be trained. Since we've already identified the relevant fields in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>, the query uses the fields <strong class="source-inline">start_station_name</strong>, <strong class="source-inline">end_station_name</strong>, <strong class="source-inline">is_weekend</strong>, and <strong class="source-inline">age</strong> as features of the DNN model.</p><p>With the keywords <strong class="source-inline">as label</strong>, we are instructing BigQuery ML to use <strong class="source-inline">tripduration</strong> as the label of our machine learning model. As an alternative, it is possible to include the label among the list of <strong class="source-inline">OPTIONS</strong> with the keyword <strong class="source-inline">INPUT_LABEL_COLS</strong>.</p><p>Since DNNs are advanced and complex models, it can take several minutes before converging to the solution and generating the machine learning model.</p></li>
				<li>At the end of the execution of the SQL query, we can select the DNN model <strong class="source-inline">trip_duration_by_stations_day_age_relu</strong> in the BigQuery navigation menu and click on the <strong class="bold">Evaluation</strong> tab. This tab shows important key performance indicators of the model that we've just built. In this case, we'll focus our attention on the <strong class="bold">Mean absolute error</strong>. This value represents the average distance between the actual and the predicted value of the label <strong class="source-inline">tripduration</strong>.<p>As you can see in the<a id="_idIndexMarker536"/> following screenshot, the <strong class="bold">Mean absolute error</strong> is very close to 4 minutes:</p><div id="_idContainer154" class="IMG---Figure"><img src="image/B16722_11_002.jpg" alt="Figure 11.2 – The Evaluation tab shows some key performance indicators of the DNN model&#13;&#10;"/></div><p class="figure-caption">Figure 11.2 – The Evaluation tab shows some key performance indicators of the DNN model</p></li>
				<li>As a second attempt, we can try to change the activation function in the neurons of our neural network to see if the performance of the first model can be further improved. Let's run the following SQL statement using the <strong class="source-inline">CRELU</strong> activation function:<p class="source-code">CREATE OR REPLACE MODEL `11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_crelu`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='DNN_REGRESSOR',</p><p class="source-code">        ACTIVATION_FN = 'CRELU') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">  is_weekend,</p><p class="source-code">  age,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `11_nyc_bike_sharing_dnn.training_table`;</p><p>The query to train the DNN <strong class="source-inline">`11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_crelu`</strong> is very similar to the SQL statement that we used in our first attempt. The only difference is represented by the different activation function specified in <strong class="source-inline">OPTIONS</strong>. Using the clause <strong class="source-inline">ACTIVATION_FN = 'CRELU'</strong>, we're using the <strong class="source-inline">CRELU</strong> function in the neurons of the network.</p><p>The execution<a id="_idIndexMarker537"/> of the training query will take several minutes to complete.</p></li>
				<li>At the end of the execution of the SQL query, we can select the DNN model <strong class="source-inline">trip_duration_by_stations_day_age_crelu</strong> in the BigQuery navigation menu and visualize the performance in the <strong class="bold">Evaluation</strong> tab.<p>As you can see in the following screenshot, the <strong class="bold">Mean absolute error</strong> is almost close to 4 minutes:</p></li>
			</ol>
			<div>
				<div id="_idContainer155" class="IMG---Figure">
					<img src="image/B16722_11_003.jpg" alt="Figure 11.3 – The Evaluation tab shows some key performance indicators of the DNN model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.3 – The Evaluation tab shows some key performance indicators of the DNN model</p>
			<p>Now, let's start the evaluation of the DNNs that we've trained in this section.</p>
			<h1 id="_idParaDest-165"><a id="_idTextAnchor167"/>Evaluating the DNN models</h1>
			<p>To evaluate our <a id="_idIndexMarker538"/>BigQuery ML DNNs, we'll use the <strong class="source-inline">ML.EVALUATE</strong> function and the table that we've expressly created as an evaluation dataset:</p>
			<ol>
				<li value="1">First of all, we can start evaluating the model <strong class="source-inline">`11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`</strong>. Let's run the following query:<p class="source-code">SELECT</p><p class="source-code">  *</p><p class="source-code">FROM</p><p class="source-code">  ML.EVALUATE(MODEL `11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`,</p><p class="source-code">    (</p><p class="source-code">    SELECT</p><p class="source-code">          start_station_name,</p><p class="source-code">          end_station_name,</p><p class="source-code">          is_weekend,</p><p class="source-code">          age,</p><p class="source-code">          tripduration as label</p><p class="source-code">    FROM</p><p class="source-code">           `11_nyc_bike_sharing_dnn.evaluation_table` ));</p><p>In the SQL statement, we can notice the keyword <strong class="source-inline">ML.EVALUATE</strong> is used to evaluate the DNN. The evaluation function is followed by the identifier of the BigQuery ML model: <strong class="source-inline">`11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`</strong>.</p><p>The evaluation<a id="_idIndexMarker539"/> function is applied on the <strong class="source-inline">SELECT</strong> statement that extracts all the fields from the table: <strong class="source-inline">`11_nyc_bike_sharing_dnn.evaluation_table`</strong>.</p><p>After some seconds, we can see the results of the evaluation stage as shown in the following screenshot:</p><div id="_idContainer156" class="IMG---Figure"><img src="image/B16722_11_004.jpg" alt="Figure 11.4 – The results of the evaluation SQL statement&#13;&#10;"/></div><p class="figure-caption">Figure 11.4 – The results of the evaluation SQL statement</p><p>We can notice that the <strong class="bold">mean_absolute_error</strong> value is not so different from the value that we've achieved during the training phase. We can say that our model is not affected by overfitting and works well on the new records of the evaluation dataset.</p></li>
				<li>Let's apply the same evaluation logic on the second model, <strong class="source-inline">`11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_crelu`</strong>. To evaluate the performance of this BigQuery ML model, we run the following SQL statement:<p class="source-code">SELECT</p><p class="source-code">  *</p><p class="source-code">FROM</p><p class="source-code">  ML.EVALUATE(MODEL `11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_crelu`,</p><p class="source-code">    (</p><p class="source-code">    SELECT</p><p class="source-code">          start_station_name,</p><p class="source-code">          end_station_name,</p><p class="source-code">          is_weekend,</p><p class="source-code">          age,</p><p class="source-code">          tripduration as label</p><p class="source-code">    FROM</p><p class="source-code">           `11_nyc_bike_sharing_dnn.evaluation_table` ));</p><p>The only<a id="_idIndexMarker540"/> difference between the last query and the previous one is in the name of the DNN that is subject to the evaluation: <strong class="source-inline">`11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_crelu`</strong>.</p><p>After some seconds, we'll see the results of the evaluation as presented in the following screenshot:</p></li>
			</ol>
			<div>
				<div id="_idContainer157" class="IMG---Figure">
					<img src="image/B16722_11_005.jpg" alt="Figure 11.5 – The results of the evaluation SQL statement&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.5 – The results of the evaluation SQL statement</p>
			<p>Also, in this case, the <strong class="bold">mean_absolute_error</strong> value is not far from the value of 4 minutes that we achieved during the training stage. This model is not affected by <a id="_idIndexMarker541"/>overfitting and works similar to the previous one.</p>
			<p>Now that we've evaluated our BigQuery ML models, let's see how we can use the DNN based on the <strong class="source-inline">ReLU</strong> activation function to get predictions about the duration of the bike rentals.</p>
			<h1 id="_idParaDest-166"><a id="_idTextAnchor168"/>Using the DNN models</h1>
			<p>In this section, we'll <a id="_idIndexMarker542"/>use the DNN model based on the <strong class="source-inline">ReLU</strong> function and trained to leverage the BigQuery ML capabilities to predict the duration of the bike rides for the New York City bike-sharing company.</p>
			<p>To test our DNN, we'll use the <strong class="source-inline">ML.PREDICT</strong> function on the table <strong class="source-inline">prediction_table</strong>. Let's run the following SQL statement:</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">   tripduration as actual_duration,</p>
			<p class="source-code">   predicted_label as predicted_duration,</p>
			<p class="source-code">   ABS(tripduration - predicted_label) difference_in_min</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.PREDICT(MODEL `11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">         start_station_name,</p>
			<p class="source-code">          end_station_name,</p>
			<p class="source-code">          is_weekend,</p>
			<p class="source-code">          age,</p>
			<p class="source-code">          tripduration</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">           `11_nyc_bike_sharing_dnn.prediction_table`</p>
			<p class="source-code">    ))</p>
			<p class="source-code">    order by  difference_in_min asc;</p>
			<p>The query statement is<a id="_idIndexMarker543"/> composed of a <strong class="source-inline">SELECT</strong> keyword that extracts the actual and the predicted duration of the rental. It calculates the difference in minutes and orders the results from the minimum to the maximum difference of minutes. To calculate the difference, we've used the <strong class="source-inline">ABS</strong> function that extracts the absolute value of a numeric.</p>
			<p>The <strong class="source-inline">ML.PREDICT</strong> function is applied to the <strong class="source-inline">SELECT</strong> statement, which extracts the features and the actual duration from <strong class="source-inline">prediction_table</strong>. This last field is used only for comparison with the predicted value and is not used by the DNN to return the prediction.</p>
			<p>In the following screenshot, you can see the results of the query execution:</p>
			<div>
				<div id="_idContainer158" class="IMG---Figure">
					<img src="image/B16722_11_006.jpg" alt="Figure 11.6 – The output of the query shows the actual and the predicted label &#13;&#10;with the difference expressed in minutes&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.6 – The output of the query shows the actual and the predicted label with the difference expressed in minutes</p>
			<p>Now that we've<a id="_idIndexMarker544"/> tested our BigQuery ML model, let's look at some final considerations comparing the results of the DNN based on the <strong class="source-inline">CReLU</strong> activation function with the results that we achieved using linear regression in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>.</p>
			<h1 id="_idParaDest-167"><a id="_idTextAnchor169"/>Drawing business conclusions</h1>
			<p>In this<a id="_idIndexMarker545"/> section, we'll apply our DNN model and understand how many times the BigQuery ML model is able to predict a rental duration close to the actual one.</p>
			<p>We'll add a parent <strong class="source-inline">SELECT COUNT</strong> statement to the previous query to count how many times the difference between the actual duration and the predicted one is less than <strong class="source-inline">15</strong> minutes.</p>
			<p>Let's execute the following query to calculate how often the trip duration predictions are far from the actual values:</p>
			<p class="source-code">SELECT COUNT (*)</p>
			<p class="source-code">FROM (</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">   tripduration as actual_duration,</p>
			<p class="source-code">   predicted_label as predicted_duration,</p>
			<p class="source-code">   ABS(tripduration - predicted_label) difference_in_min</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.PREDICT(MODEL  `11_nyc_bike_sharing_dnn.trip_duration_by_stations_day_age_relu`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">          start_station_name,</p>
			<p class="source-code">          end_station_name,</p>
			<p class="source-code">          is_weekend,</p>
			<p class="source-code">          age,</p>
			<p class="source-code">          tripduration</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">           `11_nyc_bike_sharing_dnn.prediction_table`</p>
			<p class="source-code">    ))</p>
			<p class="source-code">    order by  difference_in_min asc) where difference_in_min&lt;=15 ;  </p>
			<p>The result of the <strong class="source-inline">SELECT COUNT</strong> query returns a value of 1,640,446 predictions with a difference between the predicted and the actual value of less than <strong class="source-inline">15</strong> minutes.</p>
			<p>Considering <a id="_idIndexMarker546"/>that the total size of the table <strong class="source-inline">prediction_table</strong> is 1,728,078, we can say that in 94.92% of the cases our DNN is able to predict the trip duration with a difference less than 15 minutes.</p>
			<p>Now we can compare the best results that we've achieved with the DNN with the performance that we've reached using the linear regression model in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>.</p>
			<h2 id="_idParaDest-168"><a id="_idTextAnchor170"/>Deep neural networks versus linear models</h2>
			<p>In the following table, the<a id="_idIndexMarker547"/> results of the DNN<a id="_idIndexMarker548"/> model based on the <strong class="source-inline">CReLU</strong> activation function are compared to the linear regression model:</p>
			<div>
				<div id="_idContainer159" class="IMG---Figure">
					<img src="image/B16722_11_007.jpg" alt="Figure 11.7 – Comparison between the DNN model and the linear regression model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.7 – Comparison between the DNN model and the linear regression model</p>
			<p>Looking at the preceding table, we can say that to predict the trip duration of the New York City bike-sharing service, the best results can be achieved using a DNN model. For this reason, we can suggest using a DNN model to suggest the trip duration to the customers of the company. Using the DNN we can decrease the mean absolute error by more than 43%. In some industries, such an improvement could be a great competitive advantage for the company.</p>
			<h1 id="_idParaDest-169"><a id="_idTextAnchor171"/>Summary</h1>
			<p>In this chapter, we've implemented two DNNs. We remembered the business scenario that was already introduced in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>. The use case was based on the need to predict the rental time for the New York City bike-sharing service. After that, we learned the basics of DNNs and the different activation functions that can be used to implement the neurons in a network.</p>
			<p>We segmented the BigQuery public dataset into three different tables: one to host training data, the second one for the evaluation stage, and the last one to test our DNN model.</p>
			<p>During the training phase of the BigQuery ML model, we tested two different activation functions, <strong class="source-inline">ReLU</strong> and <strong class="source-inline">CReLU</strong>, comparing the mean absolute error to find the best one.</p>
			<p>After that, we evaluated our DNN models on a new set of records to prevent any overfitting and get more confident about the good quality of our BigQuery ML models.</p>
			<p>Finally, we applied the model, based on the <strong class="source-inline">ReLU</strong> function, to the last subset of records to predict the trip duration of each bike rental. We discovered that our BigQuery ML model is able to predict a trip duration within a range of 15 minutes of the actual one for more than 94% of the rentals.</p>
			<p>Finally, we also compared the performance of the DNN model with the linear regression outcomes achieved in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>. We noticed that the DNN outperforms linear regression, decreasing the mean absolute error by 43%, and can achieve better results for our business scenario.</p>
			<p>In the next chapter, we'll learn how to use BigQuery ML with GCP AI notebooks.</p>
			<h1 id="_idParaDest-170"><a id="_idTextAnchor172"/>Further resources</h1>
			<ul>
				<li><strong class="bold">NYC Bike-Sharing Public Dataset</strong>: <a href="https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike">https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike</a></li>
				<li><strong class="bold">BigQuery ML Create Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-dnn-models">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-dnn-models</a></li>
				<li><strong class="bold">BigQuery ML Evaluate Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery ML Predict</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict</a></li>
			</ul>
		</div>
	</body></html>