<html><head></head><body>
		<div id="_idContainer182">
			<h1 id="_idParaDest-198" class="chapter-number"><a id="_idTextAnchor197"/>11</h1>
			<h1 id="_idParaDest-199"><a id="_idTextAnchor198"/>Computational Fluid Dynamics</h1>
			<p><strong class="bold">Computational Fluid Dynamics</strong> (<strong class="bold">CFD</strong>) is a technique used to analyze how fluid (air, water, and other fluids) flow over or inside objects of interest. CFD is a mature field that originated several decades ago and is used in fields of study related to manufacturing, healthcare, the environment, and aerospace and automotive industries that involve fluid flow, chemical reactions, or thermodynamic reactions and simulations. Given the field’s progress and long history, it is beyond the scope of this book to discuss many aspects of this field. However, these video links may be a great way for readers to get up to speed on what CFD is and some CFD tools, and best practices <span class="No-Break">on AWS:</span></p>
			<ul>
				<li><a href="https://www.youtube.com/watch?v=__7_aHrNUF4&amp;ab_channel=AWSPublicSector"><span class="No-Break">https://www.youtube.com/watch?v=__7_aHrNUF4&amp;ab_channel=AWSPublicSector</span></a></li>
				<li><a href="https://www.youtube.com/watch?v=8rAvNbCJ7M0&amp;ab_channel=AWSOnlineTechTalks"><span class="No-Break">https://www.youtube.com/watch?v=8rAvNbCJ7M0&amp;ab_channel=AWSOnlineTechTalks</span></a></li>
			</ul>
			<p>In this chapter, we are going to review the field of CFD and provide insights into how <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>) is being used today with CFD. Additionally, we will examine some of the ways you can run CFD tools <span class="No-Break">on AWS.</span></p>
			<p>We will cover the following topics in <span class="No-Break">this chapter:</span></p>
			<ul>
				<li><span class="No-Break">Introducing CFD</span></li>
				<li>Reviewing best practices for running CFD <span class="No-Break">on AWS</span></li>
				<li>Discussing how ML can be applied <span class="No-Break">to CFD</span></li>
			</ul>
			<h1 id="_idParaDest-200"><a id="_idTextAnchor199"/>Technical requirements</h1>
			<p>You should have the following prerequisites before getting started with <span class="No-Break">this chapter:</span></p>
			<ul>
				<li>Familiarity with AWS and its <span class="No-Break">basic usage.</span></li>
				<li>A web browser (for the best experience, it is recommended that you use a Chrome or <span class="No-Break">Firefox browser).</span></li>
				<li>An AWS account (if you are unfamiliar with how to get started with an AWS account, you can go to this <span class="No-Break">link: </span><a href="https://aws.amazon.com/getting-started/"><span class="No-Break">https://aws.amazon.com/getting-started/</span></a><span class="No-Break">).</span></li>
				<li>Some familiarity with CFD. Although we will provide a brief overview of CFD, this chapter is best suited for readers that are at least aware of some of the typical use cases that can be solved <span class="No-Break">using CFD.</span></li>
			</ul>
			<p>In the following section, we will introduce CFD through an example application problem – designing a <span class="No-Break">race car!</span></p>
			<h1 id="_idParaDest-201"><a id="_idTextAnchor200"/>Introducing CFD</h1>
			<p><strong class="bold">CFD</strong> is the prediction of fluid flow using<a id="_idIndexMarker764"/> numerical analysis. Let’s break <span class="No-Break">that down:</span></p>
			<ul>
				<li><strong class="bold">Prediction</strong>: Just as with other physical phenomena, fluid flow can be modeled mathematically, and simulated. For<a id="_idIndexMarker765"/> readers from the field of ML, this is different from an ML model’s <em class="italic">prediction</em>. Here, we solve a set of equations iteratively to construct the flow inside or around a body. Mainly, we use <span class="No-Break"><strong class="bold">Navier-Stokes</strong></span><span class="No-Break"> equations.</span></li>
				<li><strong class="bold">Numerical analysis</strong>: Several tools have been created to help actually solve these equations – not <a id="_idIndexMarker766"/>surprisingly, these<a id="_idIndexMarker767"/> tools are called <strong class="bold">solvers</strong>. As with any set of tools, there are commercial and <strong class="bold">open source</strong> varieties of these solvers. It is uncommon nowadays to write any code related to the actual solving of equations – similar to how you don’t write your own ML framework before you start solving your ML problems. Numerical or mathematical methods that have been studied for decades are implemented through code in these solvers that help with the analysis of <span class="No-Break">fluid flow.</span></li>
			</ul>
			<p>Now, imagine you are the team principal for a new <strong class="bold">Formula 1</strong> (<strong class="bold">F1</strong>) team who is responsible for managing the design of a new car for the upcoming race season. The design of this car has to satisfy many new F1 regulations that define constraints of how the car can be designed. Fortunately, you have a large engineering team that can manage the design and manufacturing of a new car that is proposed. The largest teams spend millions of dollars on just the conceptual design of the car before even manufacturing a single part. It is typical for teams to start with a baseline design and improve this design iteratively. This iterative improvement of design is not unique to racing car development; think of the latest version of the iPhone in your pocket or purse, or how generations <a id="_idIndexMarker768"/>of commercial passenger aircraft designs look similar but are very different. You task your engineers with designing modifications to the existing car using <strong class="bold">Computer-Aided Design</strong> (<strong class="bold">CAD</strong>) tools, and <a id="_idIndexMarker769"/>after a month of working on potential design changes, they show you the design of your team’s latest car (see <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.1</em>). This <span class="No-Break">looks great!</span></p>
			<div>
				<div id="_idContainer158" class="IMG---Figure">
					<img src="image/B18493_11_001.jpg" alt="Figure 11.1 – F1 car design"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.1 – F1 car design</p>
			<p>However, how do you know whether this car will perform better on track? Two key metrics that you can track are <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="bold">Drag</strong>: The resistance caused by an object in fluid flow. The <strong class="bold">coefficient of drag</strong> is a dimensionless quantity that is used to quantify drag. For your F1 car, a higher coefficient of drag is worse since your car will move slower, considering all the other factors <span class="No-Break">remain constant.</span></li>
				<li><strong class="bold">Downforce</strong>: Aerodynamic forces that push the car onto the track; the higher the downforce, the better it is since it provides greater grip when traveling or turning at <span class="No-Break">high speeds.</span></li>
			</ul>
			<p><span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.2</em> shows the direction of these two forces applied to the <span class="No-Break">F1 car:</span></p>
			<div>
				<div id="_idContainer159" class="IMG---Figure">
					<img src="image/B18493_11_002.jpg" alt="Figure 11.2 – Drag and downforce directions on the F1 car"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.2 – Drag and downforce directions on the F1 car</p>
			<p>Now, one way to measure drag and downforce is to manufacture the entire car, drive around a track with force sensors, and report this back to the team – but what if you had a different design in mind? Or a variation in one of the components of your car? You would have rebuilt these <a id="_idIndexMarker770"/>components, or the entire car, and then perform the same tests, or run a scale model in a wind tunnel – these options can be very time-consuming and very expensive. This is where numerical analysis codes such as CFD tools become useful. With CFD tools, you can simulate different flow conditions over the car and calculate the drag <span class="No-Break">and downforce.</span></p>
			<p>It is typical in CFD to create a <strong class="bold">flow domain</strong> with the object <a id="_idIndexMarker771"/>of interest inside it. This<a id="_idIndexMarker772"/> can look similar to <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.3</em> for <strong class="bold">external flows</strong> (for example, the flow around the vehicle). On the other hand, you could have <strong class="bold">internal flows</strong> where the domain is <a id="_idIndexMarker773"/>defined in the object itself (such as the flow inside a bent pipe). In <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.3</em>, the green and blue surfaces represent the <strong class="bold">inlet</strong> and <strong class="bold">outlet</strong> in this domain. Air flows <a id="_idIndexMarker774"/>from the <strong class="bold">inlet</strong>, over and around the car, and <a id="_idIndexMarker775"/>out through <span class="No-Break">the </span><span class="No-Break"><strong class="bold">outlet</strong></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer160" class="IMG---Figure">
					<img src="image/B18493_11_003.jpg" alt="Figure 11.3 – CFD domain defined around the F1 car"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.3 – CFD domain defined around the F1 car</p>
			<p>The car and the domain so far are conceptual ideas and need to be represented as objects or files that CFD code can ingest and use. A typical file format used to represent objects is the <strong class="bold">Stereolithography</strong> (<strong class="bold">STL</strong>) file<a id="_idIndexMarker776"/> format. Each object is represented as a set of triangles, and each<a id="_idIndexMarker777"/> triangle is represented by a set of 3D points. The same car in an STL format is shown in <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.4</em> – the car is now a collection of tens of thousands <span class="No-Break">of triangles.</span></p>
			<div>
				<div id="_idContainer161" class="IMG---Figure">
					<img src="image/B18493_11_004.jpg" alt="Figure 11.4 – F1 car in an STL format"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.4 – F1 car in an STL format</p>
			<p>We can now use this car object and <strong class="bold">mesh</strong> the CFD domain. Creating a <strong class="bold">mesh</strong>, or <strong class="bold">meshing</strong>, is the process of creating grid points<a id="_idIndexMarker778"/> in the CFD domain where numerical equations related to fluid flow are to be solved. Meshing is a very important process, as this can directly influence<a id="_idIndexMarker779"/> results, and also sometimes cause the numerical simulation to diverge or <span class="No-Break">not solve.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Meshing techniques and details about the algorithms used are beyond the scope of this book. Each solver tool implements different meshing techniques with various configurations. Teams spend a significant amount of time getting high-quality meshes while balancing the complexity of the mesh to ensure faster <span class="No-Break">solving times.</span></p>
			<p>Once the mesh is built out, it may look similar to <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.5</em>. We see that there is a concentration of grid cells closer to the body. Note that this is a slice of the mesh, and the actual mesh is a 3D volume with the bounds that were defined in <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.3</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer162" class="IMG---Figure">
					<img src="image/B18493_11_005.jpg" alt="Figure 11.5 – CFD mesh built for the F1 car case"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.5 – CFD mesh built for the F1 car case</p>
			<p>Once the mesh is built out, we can use CFD solvers to calculate the flow around this F1 car, and then post-process these results to provide us with predictions for drag and downforce. <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.6</em> and <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.7</em> show typical post-processed images involving streamlines (the white lines in the images representing how fluid flows around the body), a velocity slice (the magnitude of the velocity on a plane or cross-section of interest), pressure on the car body (redder regions are higher pressure), and the original car geometry <span class="No-Break">for context.</span></p>
			<div>
				<div id="_idContainer163" class="IMG---Figure">
					<img src="image/B18493_11_006.jpg" alt="Figure 11.6 – Post-processed results for the F1 car case showing streamlines and velocity slice"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.6 – Post-processed results for the F1 car case showing streamlines and velocity slice</p>
			<p><span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.7</em> shows a different<a id="_idIndexMarker780"/> output visualization of pressure on the surface of the car, along with the streamlines in a <span class="No-Break">perspective view.</span></p>
			<div>
				<div id="_idContainer164" class="IMG---Figure">
					<img src="image/B18493_11_007.jpg" alt="Figure 11.7 – Post-processed results for the F1 car case showing pressure on the car body with streamlines"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.7 – Post-processed results for the F1 car case showing pressure on the car body with streamlines</p>
			<p>In summary, running a CFD case<a id="_idIndexMarker781"/> involves <span class="No-Break">the following:</span></p>
			<ol>
				<li>Loading and manipulating <span class="No-Break">the geometry</span></li>
				<li>Meshing the <span class="No-Break">CFD domain</span></li>
				<li>Using a solver to solve for the flow in <span class="No-Break">the domain</span></li>
				<li>Using post-processing tools to visualize <span class="No-Break">the results</span></li>
			</ol>
			<p>In the next section, we will discuss a few ways of running CFD analyses on AWS according to our documented <span class="No-Break">best practices.</span></p>
			<h1 id="_idParaDest-202"><a id="_idTextAnchor201"/>Reviewing best practices for running CFD on AWS</h1>
			<p>CFD, being very compute-intensive, needs to be scaled massively to be practical for companies that depend on <a id="_idIndexMarker782"/>analysis results to make decisions about their product designs. AWS allows customers to run CFD simulations at a massive scale (thousands of cores), on-demand, with multiple <a id="_idIndexMarker783"/>commercial and <strong class="bold">open source</strong> tools, and without any capacity planning or up-front capital investment. You can find many useful links related to CFD on AWS <span class="No-Break">here: </span><a href="https://aws.amazon.com/hpc/cfd/"><span class="No-Break">https://aws.amazon.com/hpc/cfd/</span></a><span class="No-Break">.</span></p>
			<p>As highlighted at the outset of this chapter, there are several commercial and open source tools available to solve your CFD problems that run at scale on AWS. Some of these tools are <span class="No-Break">as follows:</span></p>
			<ul>
				<li>Siemens <span class="No-Break">SimCenter STAR-CCM+</span></li>
				<li><span class="No-Break">Ansys Fluent</span></li>
				<li>OpenFOAM (<span class="No-Break">open source)</span></li>
			</ul>
			<p>In this chapter, we will be providing you with examples of how to set up and use <em class="italic">OpenFOAM</em>. For other tools, please take a look at this workshop provided by <span class="No-Break">AWS: </span><a href="https://cfd-on-pcluster.workshop.aws/"><span class="No-Break">https://cfd-on-pcluster.workshop.aws/</span></a><span class="No-Break">.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Note that the AWS <strong class="bold">Well-Architected</strong> pillar defines best practices for running any kind of workload on AWS. It includes the best practices for designing architectures on AWS with the following pillars: <strong class="bold">Operational Excellence</strong>, <strong class="bold">Security</strong>, <strong class="bold">Reliability</strong>, <strong class="bold">Performance Efficiency</strong>, <strong class="bold">Cost Optimization</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="bold">Sustainability</strong></span><span class="No-Break">.</span></p>
			<p class="callout">If you are unfamiliar with the Well-Architected Framework, you can read about it in detail <span class="No-Break">here: </span><a href="https://docs.aws.amazon.com/wellarchitected/latest/framework/welcome.html/"><span class="No-Break">https://docs.aws.amazon.com/wellarchitected/latest/framework/welcome.html/</span></a><span class="No-Break">.</span></p>
			<p>We will now discuss<a id="_idIndexMarker784"/> two different ways of running CFD simulations on AWS: using ParallelCluster and using <span class="No-Break">CFD Direct.</span></p>
			<h2 id="_idParaDest-203"><a id="_idTextAnchor202"/>Using AWS ParallelCluster</h2>
			<p>On AWS, these Well-Architected<a id="_idIndexMarker785"/> best practices are encapsulated in a solution called AWS ParallelCluster that you can launch in your AWS account. ParallelCluster lets you configure and launch an entire HPC cluster with a simple <strong class="bold">Command-Line Interface </strong>(<strong class="bold">CLI</strong>). The CLI also allows you to <a id="_idIndexMarker786"/>dynamically scale resources needed for your CFD (and other HPC) applications as needed, in a secure manner. Popular schedulers <a id="_idIndexMarker787"/>such as <strong class="bold">AWS Batch</strong> or <strong class="bold">Slurm</strong> can be used to submit and monitor jobs on ParallelCluster. Here<a id="_idIndexMarker788"/> are some steps to follow for installing ParallelCluster (note that a complete set of steps can be found on the official AWS documentation page for ParallelCluster <span class="No-Break">here: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/install-v3-pip.html"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/install-v3-pip.html</span></a><span class="No-Break">).</span></p>
			<h3>Step 1 – creating an AWS Cloud9 IDE</h3>
			<p>This helps us have access to a <a id="_idIndexMarker789"/>full IDE on the cloud on a specified instance type, with temporary, managed credentials that can be used to launch ParallelCluster. Follow the instructions here to launch an AWS Cloud9 <span class="No-Break">IDE: </span><a href="https://docs.aws.amazon.com/cloud9/latest/user-guide/setup-express.html"><span class="No-Break">https://docs.aws.amazon.com/cloud9/latest/user-guide/setup-express.html</span></a><span class="No-Break">.</span></p>
			<p>Once you have created your Cloud9 IDE, navigate to the terminal as shown in the instructions <span class="No-Break">here: </span><a href="https://docs.aws.amazon.com/cloud9/latest/user-guide/tour-ide.html#tour-ide-terminal"><span class="No-Break">https://docs.aws.amazon.com/cloud9/latest/user-guide/tour-ide.html#tour-ide-terminal</span></a><span class="No-Break">.</span></p>
			<h3>Step 2 – installing the ParallelCluster CLI</h3>
			<p>Once you are inside the<a id="_idIndexMarker790"/> terminal, do <span class="No-Break">the following:</span></p>
			<ol>
				<li value="1">Use <strong class="source-inline">pip</strong> to <span class="No-Break">install </span><span class="No-Break"><strong class="source-inline">ParallelCluster</strong></span><span class="No-Break">:</span><pre class="source-code">
...</pre><pre class="source-code">
<strong class="bold">python3 -m pip install "aws-parallelcluster" --upgrade –-user</strong></pre><pre class="source-code">
...</pre></li>
				<li>Next, make sure that <a id="_idIndexMarker791"/>you have <strong class="bold">Node Version Manager</strong> (<span class="No-Break"><strong class="bold">NVM</strong></span><span class="No-Break">) installed:</span><pre class="source-code">
...</pre><pre class="source-code">
<strong class="bold">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash</strong></pre><pre class="source-code">
<strong class="bold">chmod ug+x ~/.nvm/nvm.sh</strong></pre><pre class="source-code">
<strong class="bold">source ~/.nvm/nvm.sh</strong></pre><pre class="source-code">
<strong class="bold">nvm install --lts</strong></pre><pre class="source-code">
<strong class="bold">node –version</strong></pre><pre class="source-code">
...</pre></li>
				<li>Lastly, verify that <strong class="source-inline">ParallelCluster</strong> has been <span class="No-Break">installed successfully:</span><pre class="source-code">
<strong class="bold">pcluster version</strong></pre><pre class="source-code">
<strong class="bold">{</strong></pre><pre class="source-code">
<strong class="bold">    "version": "3.1.3"</strong></pre><pre class="source-code">
<strong class="bold">}</strong></pre></li>
			</ol>
			<p>Let’s move on to <span class="No-Break"><em class="italic">step 3</em></span><span class="No-Break">.</span></p>
			<h3>Step 3 – configuring your ParallelCluster</h3>
			<p>Before you launch <a id="_idIndexMarker792"/>ParallelCluster, you need to define parameters using the <span class="No-Break"><strong class="source-inline">configure</strong></span><span class="No-Break"> command:</span></p>
			<pre class="console">
...
pcluster configure
...</pre>
			<p>The command-line tool will ask you the following questions for creating a configuration (or config, for <span class="No-Break">short) file:</span></p>
			<ul>
				<li>Region in which to set up ParallelCluster (for <span class="No-Break">example, US-East-1)</span></li>
				<li><strong class="bold">EC2 Key Pair</strong> to use (learn more about <strong class="bold">Key Pairs</strong> <span class="No-Break">here: </span><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html"><span class="No-Break">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html</span></a></li>
				<li>Operating system (for example, Amazon Linux 2, CentOS 7, <span class="No-Break">or Ubuntu)</span></li>
				<li>Head node instance type (for <span class="No-Break">example, </span><span class="No-Break"><strong class="bold">c5n.18xlarge</strong></span><span class="No-Break">)</span></li>
				<li>Whether to automate <span class="No-Break">VPC creation</span></li>
				<li>Subnet configuration (for example, head or main node placed in a public subnet with the rest of the compute fleet in a private subnet <span class="No-Break">or subnets)</span></li>
				<li>Additional shared storage volume (for example, <span class="No-Break">FSx configuration)</span></li>
			</ul>
			<p>This creates a config file that can be found in <strong class="source-inline">~/.parallelcluster</strong> and modified before the creation of the cluster. Here is an example of a ParallelCluster <span class="No-Break">config file:</span></p>
			<pre class="source-code">
...
Region: us-east-2
Image:
  Os: alinux2
HeadNode:
  InstanceType: c5.4xlarge
  Networking:
    SubnetId: subnet-0e6e79abb7ed2452c
  Ssh:
    KeyName: pcluster
Scheduling:
  Scheduler: slurm
  SlurmQueues:
  - Name: queue1
    ComputeResources:
    - Name: c54xlarge
      InstanceType: c5.4xlarge
      MinCount: 0
      MaxCount: 4
    - Name: m516xlarge
      InstanceType: m5.16xlarge
      MinCount: 0
      MaxCount: 2
    Networking:
      SubnetIds:
      - subnet-09299f6d9ecfb8122
...</pre>
			<p>A deeper dive into the intricacies <a id="_idIndexMarker793"/>of the ParallelCluster config file can be found <span class="No-Break">here: </span><a href="https://aws.amazon.com/blogs/hpc/deep-dive-into-the-aws-parallelcluster-3-configuration-file/"><span class="No-Break">https://aws.amazon.com/blogs/hpc/deep-dive-into-the-aws-parallelcluster-3-configuration-file/</span></a><span class="No-Break">.</span></p>
			<h3>Step 4 – launching your ParallelCluster</h3>
			<p>Once you have verified the <a id="_idIndexMarker794"/>config file, use the following command to create and <span class="No-Break">launch </span><span class="No-Break"><strong class="source-inline">ParallelCluster</strong></span><span class="No-Break">:</span></p>
			<pre class="source-code">
...
pcluster create-cluster --cluster-name mycluster --cluster-configuration config
{
  "cluster": {
    "clusterName": "mycluster",
    "cloudformationStackStatus": "CREATE_IN_PROGRESS",
    "cloudformationStackArn": "arn:aws:cloudformation:us-east-2:989279443319:stack/mycluster/c6fdb600-d49e-11ec-9c26-069b96033f9a",
    "region": "us-east-2",
    "version": "3.1.3",
    "clusterStatus": "CREATE_IN_PROGRESS"
  }
}...</pre>
			<p>Here, our cluster has been named <strong class="source-inline">mycluster</strong>. This will launch a CloudFormation template with the required resources to work with ParallelCluster, based on the config file you previously defined. The following services are used by <span class="No-Break">AWS ParallelCluster:</span></p>
			<ul>
				<li><span class="No-Break">AWS Batch</span></li>
				<li><span class="No-Break">AWS CloudFormation</span></li>
				<li><span class="No-Break">Amazon CloudWatch</span></li>
				<li>Amazon <span class="No-Break">CloudWatch Logs</span></li>
				<li><span class="No-Break">AWS CodeBuild</span></li>
				<li><span class="No-Break">Amazon DynamoDB</span></li>
				<li>Amazon Elastic <span class="No-Break">Block Store</span></li>
				<li>Amazon <strong class="bold">Elastic Compute </strong><span class="No-Break"><strong class="bold">Cloud</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">EC2</strong></span><span class="No-Break">)</span></li>
				<li>Amazon Elastic <span class="No-Break">Container Registry</span></li>
				<li>Amazon <strong class="bold">Elastic File </strong><span class="No-Break"><strong class="bold">System</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">EFS</strong></span><span class="No-Break">)</span></li>
				<li>Amazon FSx <span class="No-Break">for Lustre</span></li>
				<li>AWS Identity and <span class="No-Break">Access Management</span></li>
				<li><span class="No-Break">AWS Lambda</span></li>
				<li><span class="No-Break">NICE DCV</span></li>
				<li>Amazon <span class="No-Break">Route 53</span></li>
				<li>Amazon Simple <span class="No-Break">Storage Service</span></li>
				<li><span class="No-Break">Amazon VPC</span></li>
			</ul>
			<p>For more details on the <a id="_idIndexMarker795"/>services used, please refer to the links provided in the <em class="italic">References</em> section of this chapter. A simplified architecture diagram of AWS ParallelCluster is shown in <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.8</em> – more details can be found on the following blog: <a href="https://aws.amazon.com/blogs/compute/running-simcenter-star-ccm-on-aws/">https://aws.amazon.com/blogs/compute/running-simcenter-star-ccm-on-aws/</a>. Otherwise, see the documentation page for <span class="No-Break">ParallelCluster (</span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/what-is-aws-parallelcluster.html"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/what-is-aws-parallelcluster.html</span></a><span class="No-Break">).</span></p>
			<div>
				<div id="_idContainer165" class="IMG---Figure">
					<img src="image/B18493_11_008.jpg" alt="Figure 11.8 – AWS ParallelCluster architecture"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.8 – AWS ParallelCluster architecture</p>
			<p>The launch will typically take about 10 minutes and can be tracked both on the console as well as on the CloudFormation page on the AWS Management Console. On the console, the following<a id="_idIndexMarker796"/> message will confirm that your launch is <span class="No-Break">in progress:</span></p>
			<pre class="source-code">
pcluster list-clusters --query 'clusters[?clusterName==`mycluster`]'
[
  {
    "clusterName": "mycluster",
    "cloudformationStackStatus": "CREATE_IN_PROGRESS",
    "cloudformationStackArn": "arn:aws:cloudformation:us-east-2:&lt;account_number&gt;:stack/mycluster/c6fdb600-d49e-11ec-9c26-069b96033f9a",
    "region": "us-east-2",
    "version": "3.1.3",
    "clusterStatus": "CREATE_IN_PROGRESS"
  }
]</pre>
			<p>Wait for the status to say <strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">clusterStatus": "CREATE_COMPLETE"</strong></span></p>
			<h3>Step 5 – installing OpenFOAM on the cluster</h3>
			<p>To install OpenFOAM on your cluster, see <span class="No-Break">the following:</span></p>
			<ol>
				<li value="1"> First, add <strong class="bold">Secure Shell</strong> (<strong class="bold">SSH</strong>) into the head<a id="_idIndexMarker797"/> node of your newly <span class="No-Break">created ParallelCluster:</span><pre class="source-code">
<strong class="bold">pcluster ssh -n mycluster -i pcluster.pem</strong></pre><pre class="source-code">
<strong class="bold">The authenticity of host '3.135.195.149 (3.135.195.149)' can't be established.</strong></pre><pre class="source-code">
<strong class="bold">ECDSA key fingerprint is SHA256:DZPeIcVRpZDg3VMYhA+2zAvEoLnD3gI6mLVkMPkyg90.</strong></pre><pre class="source-code">
<strong class="bold">ECDSA key fingerprint is MD5:87:16:df:e7:26:f5:a0:da:a8:3a:7c:c4:c8:92:60:34.</strong></pre><pre class="source-code">
<strong class="bold">Are you sure you want to continue connecting (yes/no)? yes</strong></pre><pre class="source-code">
<strong class="bold">Warning: Permanently added '3.135.195.149' (ECDSA) to the list of known hosts.</strong></pre><pre class="source-code">
<strong class="bold">Last login: Sun May 15 22:36:41 2022</strong></pre><pre class="source-code">
<strong class="bold">       </strong><strong class="bold">__|  __|_  )</strong></pre><pre class="source-code">
<strong class="bold">       _|  (     /   Amazon Linux 2 AMI</strong></pre><pre class="source-code">
<strong class="bold">      ___|\___|___|</strong></pre></li>
				<li>You are now in the head node of the ParallelCluster. Next, download the OpenFOAM files <span class="No-Break">as follows:</span><pre class="source-code">
...</pre><pre class="source-code">
<strong class="bold">wget https://sourceforge.net/projects/openfoam/files/v2012/OpenFOAM-v2012.tgz</strong></pre><pre class="source-code">
<strong class="bold">wget https://sourceforge.net/projects/openfoam/files/v2012/ThirdParty-v2012.tgz</strong></pre><pre class="source-code">
...</pre></li>
				<li>Next, untar the two<a id="_idIndexMarker798"/> files you <span class="No-Break">just downloaded:</span><pre class="source-code">
...</pre><pre class="source-code">
<strong class="bold">tar -xf OpenFOAM-v2012.tgz</strong></pre><pre class="source-code">
<strong class="bold">tar -xf ThirdParty-v2012.tgz</strong></pre><pre class="source-code">
...</pre></li>
				<li>Change the directory to the newly extracted OpenFOAM folder and <span class="No-Break">compile OpenFOAM:</span><pre class="source-code">
...</pre><pre class="source-code">
<strong class="bold">cd OpenFOAM-v2012</strong></pre><pre class="source-code">
<strong class="bold">export WM_NCOMPPROCS=36</strong></pre><pre class="source-code">
<strong class="bold">./Allwmake</strong></pre><pre class="source-code">
...</pre></li>
			</ol>
			<p>To install OpenFOAM on all nodes, you can use the <strong class="source-inline">sbatch</strong> command, and submit the preceding commands as a file named <strong class="source-inline">compile.sh</strong>: for example, <span class="No-Break"><strong class="source-inline">sbatch compile.sh</strong></span><span class="No-Break">.</span></p>
			<p>Once installation completes, you can run a sample CFD application as shown in <span class="No-Break"><em class="italic">step 6</em></span><span class="No-Break">.</span></p>
			<h3>Step 6 – running a sample CFD application</h3>
			<p>Here, we will run a sample CFD application using ParallelCluster. First, we access the head node of the cluster we just created <a id="_idIndexMarker799"/><span class="No-Break">using SSH:</span></p>
			<pre class="console">
...
pcluster ssh --cluster-name mycluster -i /path/to/keyfile.pem
...</pre>
			<p>Make sure you use the same <strong class="source-inline">.pem</strong> file that you created in <span class="No-Break"><em class="italic">step 3</em></span><span class="No-Break">!</span></p>
			<p>In this case, we will be running an example from OpenFOAM – incompressible flow over a motorbike. The case files for this case can be found <span class="No-Break">here: </span><a href="https://static.us-east-1.prod.workshops.aws/public/a536ee90-eecd-4851-9b43-e7977e3a5929/static/motorBikeDemo.tgz"><span class="No-Break">https://static.us-east-1.prod.workshops.aws/public/a536ee90-eecd-4851-9b43-e7977e3a5929/static/motorBikeDemo.tgz</span></a><span class="No-Break">.</span></p>
			<p>The geometry corresponding to this case is shown in <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.9</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer166" class="IMG---Figure">
					<img src="image/B18493_11_009.jpg" alt="Figure 11.9 – Geometry for the motorbike case in OpenFOAM"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.9 – Geometry for the motorbike case in OpenFOAM</p>
			<p>To run the case in just the head node, you can run the <span class="No-Break">following commands:</span></p>
			<pre class="console">
cp $FOAM_TUTORIALS/resources/geometry/motorBike.obj.gz constant/triSurface/
surfaceFeatureExtract
blockMesh
snappyHexMesh
checkMesh
potentialFoam
simpleFoam</pre>
			<p>We will go into detail about what these commands do in later sections. For now, our aim is just to run the example <span class="No-Break">motorbike case.</span></p>
			<p>To run the same case in<a id="_idIndexMarker800"/> parallel with all your compute nodes, you can use <strong class="source-inline">sbatch</strong> to submit the following shell script (similar to submitting the installation shell script). We can define some input arguments to the script, followed by loading <strong class="bold">OpenMPI</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="bold">OpenFOAM</strong></span><span class="No-Break">:</span></p>
			<pre class="console">
...
#!/bin/bash
#SBATCH --job-name=foam
#SBATCH --ntasks=108
#SBATCH --output=%x_%j.out
#SBATCH --partition=compute
#SBATCH --constraint=c5.4xlarge
module load openmpi
source OpenFOAM-v2012/etc/bashrc
cp $FOAM_TUTORIALS/resources/geometry/motorBike.obj.gz constant/triSurface/</pre>
			<p>First, we mesh the geometry using the <strong class="source-inline">blockMesh</strong> and <strong class="source-inline">snappyHexMesh</strong> tools (see the <span class="No-Break">following code):</span></p>
			<pre class="console">
surfaceFeatureExtract  &gt; ./log/surfaceFeatureExtract.log 2&gt;&amp;1
blockMesh  &gt; ./log/blockMesh.log 2&gt;&amp;1
decomposePar -decomposeParDict system/decomposeParDict.hierarchical  &gt; ./log/decomposePar.log 2&gt;&amp;1
mpirun -np $SLURM_NTASKS snappyHexMesh -parallel -overwrite -decomposeParDict system/decomposeParDict.hierarchical   &gt; ./log/snappyHexMesh.log 2&gt;&amp;1</pre>
			<p>We then check the<a id="_idIndexMarker801"/> quality of the mesh using <strong class="source-inline">checkMesh</strong>, and renumber and print out a summary of the mesh (<span class="No-Break">see code):</span></p>
			<pre class="console">
mpirun -np $SLURM_NTASKS checkMesh -parallel -allGeometry -constant -allTopology -decomposeParDict system/decomposeParDict.hierarchical &gt; ./log/checkMesh.log 2&gt;&amp;1
mpirun -np $SLURM_NTASKS redistributePar -parallel -overwrite -decomposeParDict system/decomposeParDict.ptscotch &gt; ./log/decomposePar2.log 2&gt;&amp;1
mpirun -np $SLURM_NTASKS renumberMesh -parallel -overwrite -constant -decomposeParDict system/decomposeParDict.ptscotch &gt; ./log/renumberMesh.log 2&gt;&amp;1
mpirun -np $SLURM_NTASKS patchSummary -parallel -decomposeParDict system/decomposeParDict.ptscotch &gt; ./log/patchSummary.log 2&gt;&amp;1
ls -d processor* | xargs -i rm -rf ./{}/0
ls -d processor* | xargs -i cp -r 0.orig ./{}/0</pre>
			<p>Finally, we run OpenFOAM through the <strong class="source-inline">potentialFoam</strong> and <strong class="source-inline">simpleFoam</strong> binaries as <span class="No-Break">shown here:</span></p>
			<pre class="console">
mpirun -np $SLURM_NTASKS potentialFoam -parallel -noFunctionObjects -initialiseUBCs -decomposeParDict system/decomposeParDict.ptscotch &gt; ./log/potentialFoam.log 2&gt;&amp;1s
mpirun -np $SLURM_NTASKS simpleFoam -parallel  -decomposeParDict system/decomposeParDict.ptscotch &gt; ./log/simpleFoam.log 2&gt;&amp;1
...</pre>
			<p>You can follow instructions in the following AWS workshop to visualize results from the CFD <span class="No-Break">case: </span><a href="https://catalog.us-east-1.prod.workshops.aws/workshops/21c996a7-8ec9-42a5-9fd6-00949d151bc2/en-US/openfoam/openfoam-visualization"><span class="No-Break">https://catalog.us-east-1.prod.workshops.aws/workshops/21c996a7-8ec9-42a5-9fd6-00949d151bc2/en-US/openfoam/openfoam-visualization</span></a><span class="No-Break">.</span></p>
			<p>Let’s discuss CFD <a id="_idIndexMarker802"/><span class="No-Break">Direct next.</span></p>
			<h2 id="_idParaDest-204"><a id="_idTextAnchor203"/>Using CFD Direct</h2>
			<p>In the previous section, we saw <a id="_idIndexMarker803"/>how you can run a CFD simulation using ParallelCluster on AWS. Now, we will look at how to run CFD using the CFD Direct offering on AWS Marketplace: <a href="https://aws.amazon.com/marketplace/pp/prodview-ojxm4wfrodtj4">https://aws.amazon.com/marketplace/pp/prodview-ojxm4wfrodtj4</a>. CFD Direct provides an Amazon EC2 image built on top of Ubuntu with all the typical tools you need to run CFD <span class="No-Break">with OpenFOAM.</span></p>
			<p>Perform the following <a id="_idIndexMarker804"/>steps to <span class="No-Break">get started:</span></p>
			<ol>
				<li value="1">Follow the link above to CFD Direct’s Marketplace offering, and click <strong class="bold">Continue </strong><span class="No-Break"><strong class="bold">to Subscribe</strong></span><span class="No-Break">.</span></li>
				<li>Then, follow the instructions provided and click <strong class="bold">Continue to Configure</strong> (leave all options as the default), and then <strong class="bold">Continue to Launch</strong>. Similar to ParallelCluster, remember to use the right EC2 key pair so you can SSH into the instance that is launched <span class="No-Break">for you.</span></li>
			</ol>
			<div>
				<div id="_idContainer167" class="IMG---Figure">
					<img src="image/B18493_11_010.jpg" alt="Figure 11.10 – CFD Direct AWS Marketplace offering (screenshot taken as of August 5, 2022)"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.10 – CFD Direct AWS Marketplace offering (screenshot taken as of August 5, 2022)</p>
			<p>Follow the instructions and get more help on using CFD Direct’s image <span class="No-Break">here: </span><a href="https://cfd.direct/cloud/aws/"><span class="No-Break">https://cfd.direct/cloud/aws/</span></a><span class="No-Break">.</span></p>
			<p>To connect to the instance for the first time, use the instructions given <span class="No-Break">here: </span><a href="https://cfd.direct/cloud/aws/connect/"><span class="No-Break">https://cfd.direct/cloud/aws/connect/</span></a><span class="No-Break">.</span></p>
			<p>In the following tutorial, we will use the NICE DCV client as a remote desktop to interact with the <span class="No-Break">EC2 instance.</span></p>
			<p>To install NICE DCV, perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li value="1">First, SSH into the instance you just launched, and then download and install the server. For example, with Ubuntu 20.04, use the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">wget https://d1uj6qtbmh3dt5.cloudfront.net/nice-dcv-ubuntu2004-x86_64.tgz</strong></pre></li>
				<li>Then, execute the following command to extract the <span class="No-Break"><strong class="source-inline">tar</strong></span><span class="No-Break"> file:</span><pre class="source-code">
<strong class="bold">tar -xvzf nice-dcv-2022.0-12123-ubuntu2004-x86_64.tgz &amp;&amp; cd nice-dcv-2022.0-12123-ubuntu2004-x86_64</strong></pre></li>
				<li>Install NICE DCV <a id="_idIndexMarker805"/>by executing <span class="No-Break">the following:</span><pre class="source-code">
<strong class="bold">sudo apt install ./nice-dcv-server_2022.0.12123-1_amd64.ubuntu2004.deb</strong></pre></li>
				<li>To start the NICE DCV server, use the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">sudo systemctl start dcvserver</strong></pre></li>
				<li>Finally, start a session using <span class="No-Break">the following:</span><pre class="source-code">
<strong class="bold">dcv create-session cfd</strong></pre></li>
				<li>Find the public IP of your launched EC2 instance and use any NICE DCV client to connect to the instance (see <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.11</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer168" class="IMG---Figure">
					<img src="image/B18493_11_011.jpg" alt="Figure 11.11 – Connecting to the EC2 instance using a public IP"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.11 – Connecting to the EC2 instance using a public IP</p>
			<ol>
				<li value="7">Next, use the username and password for Ubuntu (see <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.12</em>). If you haven’t set a password, use the <strong class="source-inline">passwd</strong> command on a terminal <span class="No-Break">using SSH.</span></li>
			</ol>
			<div>
				<div id="_idContainer169" class="IMG---Figure">
					<img src="image/B18493_11_012.jpg" alt="Figure 11.12 – Entering a username and password for Ubuntu"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.12 – Entering a username and password for Ubuntu</p>
			<ol>
				<li value="8">If prompted, select the session you want to connect to. Here, we started a session called <strong class="source-inline">cfd</strong>. You<a id="_idIndexMarker806"/> should now be looking at your Ubuntu desktop with OpenFOAM <span class="No-Break">9 preinstalled.</span></li>
			</ol>
			<div>
				<div id="_idContainer170" class="IMG---Figure">
					<img src="image/B18493_11_013.jpg" alt="Figure 11.13 – Ubuntu desktop provided by CFD Direct"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.13 – Ubuntu desktop provided by CFD Direct</p>
			<ol>
				<li value="9">To locate all the OpenFOAM tutorials to try out, use the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">echo $FOAM_TUTORIALS</strong></pre><pre class="source-code">
<strong class="bold">/opt/openfoam9/tutorials</strong></pre></li>
				<li>We will run a basic airfoil tutorial that is located in the <span class="No-Break">following directory:</span><pre class="source-code">
<strong class="bold">/opt/openfoam9/tutorials/incompressible/simpleFoam/airFoil2D/</strong></pre></li>
			</ol>
			<p>The directory is set up like <a id="_idIndexMarker807"/>a typical OpenFOAM case and has the following contents (explore using the <strong class="source-inline">tree</strong> command <span class="No-Break">on Ubuntu):</span></p>
			<pre class="source-code">
<strong class="bold">/opt/openfoam9/tutorials/incompressible/simpleFoam/airFoil2D/</strong>
<strong class="bold">|-- 0</strong>
<strong class="bold">|   |-- U</strong>
<strong class="bold">|   |-- nuTilda</strong>
<strong class="bold">|   |-- nut</strong>
<strong class="bold">|   `-- p</strong>
<strong class="bold">|-- Allclean</strong>
<strong class="bold">|-- Allrun</strong>
<strong class="bold">|-- constant</strong>
<strong class="bold">|   </strong><strong class="bold">|-- momentumTransport</strong>
<strong class="bold">|   |-- polyMesh</strong>
<strong class="bold">|   |   |-- boundary</strong>
<strong class="bold">|   |   |-- cells</strong>
<strong class="bold">|   |   |-- faces</strong>
<strong class="bold">|   |   |-- neighbour</strong>
<strong class="bold">|   </strong><strong class="bold">|   |-- owner</strong>
<strong class="bold">|   |   `-- points</strong>
<strong class="bold">|   `-- transportProperties</strong>
<strong class="bold">`-- system</strong>
<strong class="bold">    |-- controlDict</strong>
<strong class="bold">    |-- fvSchemes</strong>
<strong class="bold">    `-- fvSolution</strong></pre>
			<p>Let us explore some of these files, as this will give you an understanding of any OpenFOAM case. The folder<a id="_idIndexMarker808"/> called <strong class="source-inline">0</strong> represents the initial conditions (as in, time step 0) for these key quantities we will be <span class="No-Break">solving for:</span></p>
			<ul>
				<li><span class="No-Break"><strong class="bold">Velocity</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">U</strong></span><span class="No-Break">)</span></li>
				<li><span class="No-Break"><strong class="bold">Pressure</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">p</strong></span><span class="No-Break">)</span></li>
			</ul>
			<p>What do these files look like? Let’s take a look at the <strong class="source-inline">U</strong> (<span class="No-Break">velocity) file:</span></p>
			<pre class="source-code">
FoamFile
{
    format      ascii;
    class       volVectorField;
    object      U;
}
dimensions      [0 1 -1 0 0 0 0];
internalField   uniform (25.75 3.62 0);
boundaryField
{
    inlet
    {
        type            freestreamVelocity;
        freestreamValue $internalField;
    }
    outlet
    {
        type            freestreamVelocity;
        freestreamValue $internalField;
    }
    walls
    {
        type            noSlip;
    }
    frontAndBack
    {
        type            empty;
    }
}</pre>
			<p>As we can see here, the file defines the dimensions of the CFD domain and the free stream velocity, along with the inlet, outlet, and wall <span class="No-Break">boundary conditions.</span></p>
			<p>The <strong class="source-inline">Airfoil2D</strong> folder also contains a folder called <strong class="source-inline">constant</strong>; this folder contains files specific to the CFD mesh<a id="_idIndexMarker809"/> that we will be creating. The <strong class="source-inline">momentumTransport</strong> file defines the kind of models to be used to solve <span class="No-Break">this problem:</span></p>
			<pre class="source-code">
simulationType RAS;
RAS
{
    model           SpalartAllmaras;
    turbulence      on;
    printCoeffs     on;
}</pre>
			<p>Here, we use the <strong class="source-inline">SpalartAllmaras</strong> turbulence model under the <strong class="bold">Reynolds-Averaged Flow</strong> (<strong class="bold">RAF</strong>) type. For more information about this, please <span class="No-Break">visit </span><a href="https://www.openfoam.com/documentation/guides/latest/doc/guide-turbulence-ras-spalart-allmaras.html"><span class="No-Break">https://www.openfoam.com/documentation/guides/latest/doc/guide-turbulence-ras-spalart-allmaras.html</span></a><span class="No-Break">.</span></p>
			<p>The <strong class="source-inline">boundary</strong> file inside the <strong class="source-inline">polyMesh</strong> folder contains definitions of the walls themselves; this is to let the simulation know what a surface <em class="italic">inlet</em> or <em class="italic">wall</em> represents. There are several other <a id="_idIndexMarker810"/>files in the <strong class="source-inline">polyMesh</strong> folder that we will not explore in <span class="No-Break">this section.</span></p>
			<p>Inside the <strong class="source-inline">System</strong> folder, the <strong class="source-inline">controlDict</strong> file defines what applications to run for this case. OpenFOAM contains over 200 compiled applications; many of these are solvers and preprocessing and post-processing for <span class="No-Break">the code.</span></p>
			<p>Finally, we get to one of the most important files you will find in any OpenFOAM case: the <strong class="source-inline">Allrun</strong> executable. The <strong class="source-inline">Allrun</strong> file is a shell script that runs the steps we defined earlier for every typical CFD application in order – to import the geometry, create a mesh, solve the CFD problem, and <span class="No-Break">post-process results.</span></p>
			<p>Depending on the output intervals defined in your <strong class="source-inline">ControlDict</strong> file, several output folders will be output in the same directory that correspond to different time stamps in the simulation. The CFD solvers will solve the problem until they converge, or until a maximum number of time steps is reached. The output folders will look similar to the timestep <strong class="source-inline">0</strong> folder that we created earlier. To visualize these results, we use a tool <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">ParaView</strong></span><span class="No-Break">:</span></p>
			<ol>
				<li value="1">First, let us look at the mesh we have created (see <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.14</em>). The executables included within OpenFOAM that are responsible for creating this mesh are <strong class="source-inline">blockmesh</strong> and <strong class="source-inline">snappyhexmesh</strong>. You can also run these commands manually instead of running the <span class="No-Break"><strong class="source-inline">Allrun</strong></span><span class="No-Break"> file.</span></li>
			</ol>
			<div>
				<div id="_idContainer171" class="IMG---Figure">
					<img src="image/B18493_11_014.jpg" alt="Figure 11.14 – Mesh for the Airfoil 2D case in OpenFOAM"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.14 – Mesh for the Airfoil 2D case in OpenFOAM</p>
			<ol>
				<li value="2">Great – after solving<a id="_idIndexMarker811"/> the problem using the <strong class="source-inline">SimpleFoam</strong> executable, let us take a look at the pressure distribution around the airfoil (see <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.15</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer172" class="IMG---Figure">
					<img src="image/B18493_11_015.jpg" alt="Figure 11.15 – Pressure distribution for the Airfoil 2D case in OpenFOAM"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.15 – Pressure distribution for the Airfoil 2D case in OpenFOAM</p>
			<ol>
				<li value="3">Lastly, we can use <strong class="source-inline">ParaView</strong> to visualize <a id="_idIndexMarker812"/>the velocity distribution, along with streamlines (see <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.16</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer173" class="IMG---Figure">
					<img src="image/B18493_11_016.jpg" alt="Figure 11.16 – Velocity distribution for the Airfoil 2D case in OpenFOAM"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.16 – Velocity distribution for the Airfoil 2D case in OpenFOAM</p>
			<p>Note that these plots are post-processed by initializing <strong class="source-inline">ParaView</strong> with the <strong class="source-inline">paraFoam</strong> executable, which automatically understands output formatted by <span class="No-Break">OpenFOAM cases.</span></p>
			<p>Let us now look at a slightly more <a id="_idIndexMarker813"/>complicated case – the flow around <span class="No-Break">a car:</span></p>
			<ol>
				<li value="1">First, let us look at the geometry of the car (<span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.17</em> and <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.18</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer174" class="IMG---Figure">
					<img src="image/B18493_11_017.jpg" alt="Figure 11.17 – Car geometry (perspective view)"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.17 – Car geometry (perspective view)</p>
			<div>
				<div id="_idContainer175" class="IMG---Figure">
					<img src="image/B18493_11_018.jpg" alt="Figure 11.18 – Car geometry (side view)"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.18 – Car geometry (side view)</p>
			<ol>
				<li value="2">Next, we can use the <strong class="source-inline">blockmesh</strong> and <strong class="source-inline">snappyhexmesh</strong> commands to create the CFD mesh around this car (see <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.19</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer176" class="IMG---Figure">
					<img src="image/B18493_11_019.jpg" alt="Figure 11.19 – Mesh created for the car case"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.19 – Mesh created for the car case</p>
			<ol>
				<li value="3">We can then<a id="_idIndexMarker814"/> run the <strong class="source-inline">Allrun</strong> file to solve the problem. Finally, we will visualize the output (<em class="italic">Figures 11.20</em> and <span class="No-Break"><em class="italic">Figure 11</em></span><span class="No-Break"><em class="italic">.21</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer177" class="IMG---Figure">
					<img src="image/B18493_11_020.jpg" alt="Figure 11.20 – Streamlines (black) and pressure distribution (perspective view) created for the car case"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.20 – Streamlines (black) and pressure distribution (perspective view) created for the car case</p>
			<div>
				<div id="_idContainer178" class="IMG---Figure">
					<img src="image/B18493_11_021.jpg" alt="Figure 11.21 – Streamlines (black) and pressure distribution (side view) created for the car case"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.21 – Streamlines (black) and pressure distribution (side view) created for the car case</p>
			<p>The files needed for the following<a id="_idIndexMarker815"/> cases can be found in the ZIP files provided in the GitHub repository <span class="No-Break">here: </span><a href="https://github.com/PacktPublishing/Applied-Machine-Learning-and-High-Performance-Computing-on-AWS/tree/main/Chapter11/runs"><span class="No-Break">https://github.com/PacktPublishing/Applied-Machine-Learning-and-High-Performance-Computing-on-AWS/tree/main/Chapter11/runs</span></a><span class="No-Break">.</span></p>
			<p>In the next section, we will discuss some advancements in the CFD field related to using ML and deep learning with <span class="No-Break">CFD tools.</span></p>
			<h1 id="_idParaDest-205"><a id="_idTextAnchor204"/>Discussing how ML can be applied to CFD</h1>
			<p>CFD, being a field that has been around for decades, has matured to be very useful to companies in various domains and has also been implemented at scale using cloud providers. Recent advances<a id="_idIndexMarker816"/> in ML have been applied to CFD, and in this section, we will provide readers with pointers to articles written about <span class="No-Break">this domain.</span></p>
			<p>Overall, we see deep learning techniques being applied in two <span class="No-Break">primary ways:</span></p>
			<ul>
				<li>Using deep learning to map inputs to outputs. We explored the flow over an airfoil in this chapter and visualized these results. If we had enough input variation and saved the outputs as images, we <a id="_idIndexMarker817"/>could use <strong class="bold">autoencoders</strong> or <strong class="bold">Generative Adversarial Networks</strong> (<strong class="bold">GANs</strong>) to generate these images. As an example, the following paper <a id="_idIndexMarker818"/>uses GANs to predict flows over airfoils using sparse data: <a href="https://www.sciencedirect.com/science/article/pii/S1000936121000728">https://www.sciencedirect.com/science/article/pii/S1000936121000728</a>. As we can see in <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.22</em>, the flow fields predicted by CFD and the GAN are visually <span class="No-Break">very similar:</span></li>
			</ul>
			<div>
				<div id="_idContainer179" class="IMG---Figure">
					<img src="image/B18493_11_022.jpg" alt="Figure 11.22 – Pressure distribution generated by a trained GAN (left) and CFD (right)"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.22 – Pressure distribution generated by a trained GAN (left) and CFD (right)</p>
			<p>Similarly, Autodesk trained <a id="_idIndexMarker819"/>a network with over 800 examples of cars and can instantaneously predict the flow and drag of a new car body: <a href="https://dl.acm.org/doi/10.1145/3197517.3201325">https://dl.acm.org/doi/10.1145/3197517.3201325</a> (see <span class="No-Break"><em class="italic">figure 11.23</em></span><span class="No-Break">).</span></p>
			<div>
				<div id="_idContainer180" class="IMG---Figure">
					<img src="image/B18493_11_023.jpg" alt="Figure 11.23 – Flow field and drag coefficient being predicted instantaneously for various car shapes"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.23 – Flow field and drag coefficient being predicted instantaneously for various car shapes</p>
			<ul>
				<li>The second general type of innovation is not just mapping inputs to outputs, but actually using ML techniques as part of the CFD solver itself. For example, NVIDIA’s SIMNET (<a href="https://arxiv.org/abs/2012.07938">https://arxiv.org/abs/2012.07938</a><span class="hidden">)</span> paper describes how deep learning can be used to model the actual <strong class="bold">Partial Differential Equations</strong> (<strong class="bold">PDEs</strong>) that define the fluid flow and <a id="_idIndexMarker820"/>other physical phenomena. See <span class="No-Break"><em class="italic">Figure 11</em></span><em class="italic">.24</em> for example results from SIMNET for flow over a heat sink. Parameterized training runs are faster<a id="_idIndexMarker821"/> than commercial and open source solvers, and inference for new geometries <span class="No-Break">are instantaneous.</span></li>
			</ul>
			<div>
				<div id="_idContainer181" class="IMG---Figure">
					<img src="image/B18493_11_024.jpg" alt="Figure 11.24 – Velocity (top row) and temperature (bottom row) comparisons of OpenFOAM ﻿versus SIMNET from NVIDIA"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.24 – Velocity (top row) and temperature (bottom row) comparisons of OpenFOAM versus SIMNET from NVIDIA</p>
			<p>Let’s summarize what you have learned in this <span class="No-Break">chapter next.</span></p>
			<h1 id="_idParaDest-206"><a id="_idTextAnchor205"/>Summary</h1>
			<p>In this chapter, we provided a high-level introduction to the world of CFD, and then explored multiple ways to use AWS to solve CFD problems (using ParallelCluster and CFD Direct on EC2). Finally, we discussed some recent advancements connecting the field of CFD to ML. While it is out of the scope of this book to go into much more detail regarding CFD, we hope that the readers are inspired to dive deeper into the topics <span class="No-Break">explored here.</span></p>
			<p>In the next chapter, we will focus on genomics applications using HPC. Specifically, we will talk about drug discovery and do a detailed walk-through of a protein structure <span class="No-Break">prediction problem.</span></p>
			<h1 id="_idParaDest-207"><a id="_idTextAnchor206"/>References</h1>
			<ul>
				<li><em class="italic">AWS </em><span class="No-Break"><em class="italic">Batch</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#aws-batch-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#aws-batch-v3</span></a></li>
				<li><em class="italic">AWS </em><span class="No-Break"><em class="italic">CloudFormation</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#aws-services-cloudformation-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#aws-services-cloudformation-v3</span></a></li>
				<li><em class="italic">Amazon </em><span class="No-Break"><em class="italic">CloudWatch</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-cloudwatch-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-cloudwatch-v3</span></a></li>
				<li><em class="italic">Amazon CloudWatch </em><span class="No-Break"><em class="italic">Logs</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-cloudwatch-logs-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-cloudwatch-logs-v3</span></a></li>
				<li><em class="italic">AWS </em><span class="No-Break"><em class="italic">CodeBuild</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#aws-codebuild-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#aws-codebuild-v3</span></a></li>
				<li><em class="italic">Amazon </em><span class="No-Break"><em class="italic">DynamoDB</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-dynamodb-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-dynamodb-v3</span></a></li>
				<li><em class="italic">Amazon Elastic Block </em><span class="No-Break"><em class="italic">Store</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-elastic-block-store-ebs-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-elastic-block-store-ebs-v3</span></a></li>
				<li><em class="italic">Amazon Elastic Container </em><span class="No-Break"><em class="italic">Registry</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-elastic-container-registry-ecr-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-elastic-container-registry-ecr-v3</span></a></li>
				<li><em class="italic">Amazon </em><span class="No-Break"><em class="italic">EFS</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-efs-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-efs-v3</span></a></li>
				<li><em class="italic">Amazon FSx for </em><span class="No-Break"><em class="italic">Lustre</em></span><span class="No-Break">: </span><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-fsx-for-lustre-v3"><span class="No-Break">https://docs.aws.amazon.com/parallelcluster/latest/ug/aws-services-v3.html#amazon-fsx-for-lustre-v3</span></a></li>
			</ul>
		</div>
		<div>
			<div id="_idContainer183" class="IMG---Figure">
			</div>
		</div>
	</body></html>