<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;4.&#xA0;Traffic Stops &#x2013; Barking Up the Wrong Tree?" id="UGI01-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04" class="calibre1"/>Chapter 4. Traffic Stops – Barking Up the Wrong Tree?</h1></div></div></div><p class="calibre6">In the prior two chapters, you were a software developer who was injecting machine learning into their existing line of business application. In this chapter, we are going to put on our research analyst hat and see if we can discover some hidden insights from an existing dataset.</p></div>

<div class="book" title="Chapter&#xA0;4.&#xA0;Traffic Stops &#x2013; Barking Up the Wrong Tree?" id="UGI01-a18db0be6c20485ba81f22e43ca13055">
<div class="book" title="The scientific process"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch04lvl1sec25" class="calibre1"/>The scientific process</h1></div></div></div><p class="calibre6">The research analyst historically<a id="id177" class="calibre1"/> followed this pattern of discovery and analysis:</p><div class="mediaobject"><img src="../images/00060.jpeg" alt="The scientific process" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">With the rise of the data scientist, that workflow has changed to something like this:</p><div class="mediaobject"><img src="../images/00061.jpeg" alt="The scientific process" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Notice how the work does not end after reporting the results of a model. Rather, the data scientist is often responsible for moving the working models from their desktop and into a production application. With this new responsibility, comes new power, to reverse-paraphrase Spider-Man. The data scientist's skillset becomes broader because they have to understand software <a id="id178" class="calibre1"/>engineering techniques to go along with their traditional skill set.</p><p class="calibre6">One thing that the data <a id="id179" class="calibre1"/>scientist knows by heart is this following workflow. Inside the Test With Experiment block, there is this:</p><div class="mediaobject"><img src="../images/00062.jpeg" alt="The scientific process" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In terms of time spent, the<a id="id180" class="calibre1"/> <span class="strong"><strong class="calibre7">clean data</strong></span> block is very large compared to the other blocks. This is because most of the work effort is spent with data acquisition and preparation. Historically, much of this<a id="id181" class="calibre1"/> <span class="strong"><strong class="calibre7">data munging</strong></span> was dealing with missing, malformed, and illogical data. The traditional way to try to minimize the work effort on this step was to create data warehouses and clean the data as it transferred from the source system into the warehouse (sometimes called the Extract, Transform, Load, or ETL process). While this had some limited success, it was a fairly expensive endeavor and a fixed schema meant that changes became particularly difficult. More recent efforts in this space have surrounded gathering data in its native format, dumping it into<a id="id182" class="calibre1"/> <span class="strong"><strong class="calibre7">data lakes</strong></span> and then building jobs on top of the lake that are specific to the data's native format and structure. Sometimes, this is called <span class="strong"><em class="calibre11">putting the data in a rectangle</em></span> because you may be taking unstructured data, cleaning and aggregating it, and then outputting it in a two-dimensional data frame. The power of this data frame is that you can then combine it with other data frames to do some more interesting analysis.</p></div></div>
<div class="book" title="Open data" id="VF2I1-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec26" class="calibre1"/>Open data</h1></div></div></div><p class="calibre6">One of the most exciting civic movements that align with Big Data and Machine Learning is <span class="strong"><strong class="calibre7">Open Data</strong></span>. Although there<a id="id183" class="calibre1"/> is not as much buzz around it, it's a very exciting and important transformation in data science. The premise of open data is that local, state, and national governments will become much more accountable and efficient if they expose the public data that they currently maintain in a RESTful format. Currently, most government agencies might have paper records, charge a significant sum to output an ad-hoc query, or occasionally have an FTP site with some <code class="literal">.xls</code> or <code class="literal">.pdf</code> files that get refreshed from time to time. Open Data is a movement that takes the same, if not more, data and places it on a web service that can be consumed by applications and/or research analysts. The key thing is security and privacy of the data. Historically, some government agencies have practised security by obscurity (we have the records online but the only way to get to it is by our custom web frontend) and open data makes that kind of defense<a id="id184" class="calibre1"/> obsolete. Truth be told, security by obscurity has never really worked (how hard is it to write a screen scraper?) and all it has really done is made it harder for well-intentioned people to accomplish their goals.</p><p class="calibre6">The rise of open data also coincides with the formulation of groups of people who are hacking for civic good. Sometimes these are ad hoc meetup groups that center on a single technology stack and other groups are<a id="id185" class="calibre1"/> much more formal. For example, Code for America has <span class="strong"><em class="calibre11">brigades</em></span> in many cities across the world. If you are interested in helping a local chapter, you can find information on their website <a class="calibre1" href="http://www.codeforamerica.org/">http://www.codeforamerica.org/</a>.</p></div>

<div id="page" style="height:0pt"/><div class="book" title="Hack-4-Good"><div class="book" id="10DJ42-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec27" class="calibre1"/>Hack-4-Good</h1></div></div></div><p class="calibre6">Let's pretend we are a member of a local chapter of a fictional organization civic hacking called "Hack-4-Good". At the latest meeting, the leader announces, "Through a public record request, we have <a id="id186" class="calibre1"/>obtained all of the traffic stop information in our town. Does anyone know what to do with this dataset?" You immediately throw your hand in the air and say, "Heck yeah, Baby!" Okay, maybe you don't use those exact words but your enthusiasm is undeniable.</p><p class="calibre6">Since you are a research analyst by training, the first thing you want to do is load the data into your IDE and start exploring the data.</p><p class="calibre6">Open up Visual Studio and create a new Solution called <code class="literal">Hack4Good.TrafficStop.Solution</code>:</p><div class="mediaobject"><img src="../images/00063.jpeg" alt="Hack-4-Good" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Add a new F# Library <a id="id187" class="calibre1"/>project to the solution:</p><div class="mediaobject"><img src="../images/00064.jpeg" alt="Hack-4-Good" class="calibre8"/></div><p class="calibre9"> </p></div>

<div class="book" title="Hack-4-Good">
<div class="book" title="FsLab and type providers"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec38" class="calibre1"/>FsLab and type providers</h2></div></div></div><p class="calibre6">Now that the project skeleton<a id="id188" class="calibre1"/> has been set up, open up the <code class="literal">Script.fsx</code> file and<a id="id189" class="calibre1"/> remove all of its contents. Next, let's take a look at a<a id="id190" class="calibre1"/> really neat library called FsLab (<a class="calibre1" href="http://fslab.org/">http://fslab.org/</a>). Go to the NuGet package manager console and enter this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; Install-Package fslab</strong></span>
</pre></div><p class="calibre6">Next, we will install SqlClient, so <a id="id191" class="calibre1"/>we can access our data. Go to the NuGet package manager and enter:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; Install-Package FSharp.Data.SqlClient</strong></span>
</pre></div><p class="calibre6">With the ceremony out of the way, let's get to coding. Let's first bring the traffic ticket dataset into our script. Go into <code class="literal">Script.fsx</code> and enter this at the top:</p><div class="informalexample"><pre class="programlisting">#load "../packages/FsLab.0.3.11/FsLab.fsx"</pre></div><p class="calibre6">You should get a series of dialog boxes from Visual Studio that looks like this:</p><div class="mediaobject"><img src="../images/00065.jpeg" alt="FsLab and type providers" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Click on <span class="strong"><strong class="calibre7">Enable</strong></span>. As a <a id="id192" class="calibre1"/>general point, whenever you get a dialog box from Visual Studio like this, click on <span class="strong"><strong class="calibre7">Enable</strong></span>. For example, depending on our machine's configuration, you <a id="id193" class="calibre1"/>might get these dialog boxes when you run the following <a id="id194" class="calibre1"/>
<code class="literal">open</code> statements.</p><p class="calibre6">Back in our script, enter this:</p><div class="informalexample"><pre class="programlisting">#r "System.Data.Entity.dll"
#r "FSharp.Data.TypeProviders.dll"
#r "System.Data.Linq.dll"

open System
open Foogle
open Deedle
open FSharp.Data
open FSharp.Charting
open System.Data.Linq
open System.Data.Entity
open Microsoft.FSharp.Data.TypeProviders</pre></div><p class="calibre6">Next, enter this into the script:</p><div class="informalexample"><pre class="programlisting">[&lt;Literal&gt;]
let connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=Traffic;user id=chickenskills@nc54a9m5kk;password=sk1lzm@tter;"

type EntityConnection = SqlEntityConnection&lt;connectionString,Pluralize = true&gt;
let context = EntityConnection.GetDataContext()
context.dbo_TrafficStops |&gt; Seq.iter(fun ts -&gt; printfn "%s" ts.StreetAddress)</pre></div><p class="calibre6">The first line should look familiar; it's a connection string just like we used in the last chapter. The only difference is the database. But what's with the next line of code?</p><div class="informalexample"><pre class="programlisting">type EntityConnection = SqlEntityConnection&lt;connectionString,Pluralize = true&gt;</pre></div><p class="calibre6">This is an example of a type provider. Type providers are one of the best features of F# and it is unique to the language. I like to think of type providers <a id="id195" class="calibre1"/>as <span class="strong"><strong class="calibre7">object relational mapping</strong></span> (<span class="strong"><strong class="calibre7">ORM</strong></span>) on <a id="id196" class="calibre1"/>steroids. This type provider is inspecting the database and generating F# types for me to use in the REPL—which we will see in action in a second. In fact, the type provider is sitting on top of <a id="id197" class="calibre1"/>
<span class="strong"><strong class="calibre7">Entity Framework</strong></span> (<span class="strong"><strong class="calibre7">EF</strong></span>), which is sitting on top of ADO.NET. If you got excited about how much more productive you were when <a id="id198" class="calibre1"/>you went from hand-rolling ADO.NET code to EF, you should be equally excited about how much more productive you can be working with type providers; it is really<a id="id199" class="calibre1"/> the next generation of data access. Another cool thing is that type providers are not just for relational database management systems—there is a JSON type provider, a <code class="literal">.csv</code> type provider, and others. You can read more about <a id="id200" class="calibre1"/>type providers at <a class="calibre1" href="https://msdn.microsoft.com/en-us/library/hh156509.aspx">https://msdn.microsoft.com/en-us/library/hh156509.aspx</a> and once you see them in action, you will find them indispensable in your coding tasks.</p><p class="calibre6">Back to the code. The next line is:</p><div class="informalexample"><pre class="programlisting">let context = EntityConnection.GetDataContext()</pre></div><p class="calibre6">It creates the actual instance of the type to be used. The next line is where the rubber meets the road:</p><div class="informalexample"><pre class="programlisting">context.dbo_TrafficStops |&gt; Seq.iter(fun ts -&gt; printfn "%s" ts.StreetAddress)</pre></div><p class="calibre6">In this line, we are traversing the <code class="literal">TrafficStop</code> table and printing out the street address. If you highlight all of the code in the script so far and send it to the REPL, you will see the last part of 30,000 addresses:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">128 SW MAYNARD RD/KILMAYNE DR</strong></span>
<span class="strong"><strong class="calibre7">1 WALNUT ST TO US 1 RAMP NB/US 1 EXIT 101 RAMP NB</strong></span>
<span class="strong"><strong class="calibre7">2333 WALNUT ST</strong></span>
<span class="strong"><strong class="calibre7">1199 NW MAYNARD RD/HIGH HOUSE RD</strong></span>
<span class="strong"><strong class="calibre7">3430 TEN TEN RD</strong></span>

<span class="strong"><strong class="calibre7">val connectionString : string =</strong></span>
<span class="strong"><strong class="calibre7">  "data source=nc54a9m5kk.database.windows.net;initial catalog=T"+[61 chars]</strong></span>
<span class="strong"><strong class="calibre7">type EntityConnection =</strong></span>
<span class="strong"><strong class="calibre7">  class</strong></span>
<span class="strong"><strong class="calibre7">    static member GetDataContext : unit -&gt; EntityConnection.ServiceTypes.SimpleDataContextTypes.EntityContainer</strong></span>
<span class="strong"><strong class="calibre7">     + 1 overload</strong></span>
<span class="strong"><strong class="calibre7">    nested type ServiceTypes</strong></span>
<span class="strong"><strong class="calibre7">  end</strong></span>
<span class="strong"><strong class="calibre7">val context :</strong></span>
<span class="strong"><strong class="calibre7">  EntityConnection.ServiceTypes.SimpleDataContextTypes.EntityContainer</strong></span>
<span class="strong"><strong class="calibre7">val it : unit = ()</strong></span>
</pre></div><p class="calibre6">Before we press on, I want<a id="id201" class="calibre1"/> to mention how cool type providers are. With three<a id="id202" class="calibre1"/> lines of code, I defined a database schema, connected to it, and then pulled down records. Not only that, but the result set from the database is <code class="literal">IEnumerable</code>. So everything I have done with <code class="literal">Seq</code> in prior chapters to transform and shape the data, I can do here.</p></div></div>

<div class="book" title="Hack-4-Good">
<div class="book" title="Data exploration"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec39" class="calibre1"/>Data exploration</h2></div></div></div><p class="calibre6">With this new found power, let's<a id="id203" class="calibre1"/> start exploring. Enter this into the script:</p><div class="informalexample"><pre class="programlisting">context.dbo_TrafficStops |&gt; Seq.head</pre></div><p class="calibre6">Sending to the REPL, we will see the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val it : EntityConnection.ServiceTypes.dbo_TrafficStops =</strong></span>
<span class="strong"><strong class="calibre7">  SqlEntityConnection1.dbo_TrafficStops</strong></span>
<span class="strong"><strong class="calibre7">    {CadCallId = 120630019.0;</strong></span>
<span class="strong"><strong class="calibre7">     DispositionDesc = "VERBAL WARNING";</strong></span>
<span class="strong"><strong class="calibre7">     DispositionId = 7;</strong></span>
<span class="strong"><strong class="calibre7">     EntityKey = System.Data.EntityKey;</strong></span>
<span class="strong"><strong class="calibre7">     EntityState = Unchanged;</strong></span>
<span class="strong"><strong class="calibre7">     Id = 13890;</strong></span>
<span class="strong"><strong class="calibre7">     Latitude = 35.7891;</strong></span>
<span class="strong"><strong class="calibre7">     Longitude = -78.8289;</strong></span>
<span class="strong"><strong class="calibre7">     StopDateTime = 6/30/2012 12:36:38 AM;</strong></span>
<span class="strong"><strong class="calibre7">     StreetAddress = "4348 NW CARY PKWY/HIGH HOUSE RD";}</strong></span>
<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">We see our data frame has some interesting elements we can analyze: the date and time of the traffic stop, the geocoordinate of the traffic stop, and the final disposition of the stop. We also have some data that does not seem useful for analysis: the <code class="literal">CadCallId</code> which is probably the primary key of the source system. This might be useful for later auditing. We also have <code class="literal">StreetAddress</code>, which is the same as the geocoordinate, but in a less analyzable form. Finally, we have some fields thrown in by Entity Framework (<code class="literal">EntityKey</code>, <code class="literal">EntityState</code>, and <code class="literal">Id</code>).</p><p class="calibre6">Let's make a data frame with only the fields we care about. Enter this into the script:</p><div class="informalexample"><pre class="programlisting">let trafficStops = 
    context.dbo_TrafficStops 
    |&gt; Seq.map(fun ts -&gt; ts.StopDateTime, ts.Latitude, ts.Longitude, ts.DispositionId)</pre></div><p class="calibre6">And sending it to the REPL, we get this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val trafficStops :</strong></span>
<span class="strong"><strong class="calibre7">  seq&lt;System.Nullable&lt;System.DateTime&gt; * System.Nullable&lt;float&gt; *</strong></span>
<span class="strong"><strong class="calibre7">      System.Nullable&lt;float&gt; * System.Nullable&lt;int&gt;&gt;</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">It is interesting that although F# really, really tries to prevent you from using null, it does support it. In fact, all four of our<a id="id204" class="calibre1"/> fields are nullable. I'll show you how to deal with nulls a bit further on in the chapter as they are often a major headache when coding.</p><p class="calibre6">There is one more data frame we should create before getting too far down the analysis. As a general rule, the machine learning models that we use, prefer primitive types such as ints, floats, and bools. They have a much harder time with strings, especially strings that represent categorical data. You probably noticed that I brought in <code class="literal">DispositionId</code> into the <code class="literal">trafficStops</code> data frame and not <code class="literal">DispositionDesc</code>. However, we still don't want to lose that description because we might want to refer to it later. Let's create a separate data frame for this lookup data. In the script, enter this:</p><div class="informalexample"><pre class="programlisting">let dispoistions =
    context.dbo_TrafficStops 
    |&gt; Seq.distinctBy(fun ts -&gt; ts.DispositionId, ts.DispositionDesc)   
    |&gt; Seq.map (fun d -&gt; d.DispositionId, d.DispositionDesc)
    |&gt; Seq.toArray</pre></div><p class="calibre6">And then send it to the REPL to get this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val dispoistions : (System.Nullable&lt;int&gt; * string) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(7, "VERBAL WARNING"); (15, "CITATION"); (12, "COMPLETED AS REQUESTED");</strong></span>
<span class="strong"><strong class="calibre7">    (4, "WRITTEN WARNING"); (13, "INCIDENT REPORT"); (9, "ARREST");</strong></span>
<span class="strong"><strong class="calibre7">    (14, "UNFOUNDED"); (19, "None Provided");</strong></span>
<span class="strong"><strong class="calibre7">    (10, "NO FURTHER ACTION NECESSARY"); (5, "OTHER    SEE NOTES");</strong></span>
<span class="strong"><strong class="calibre7">    (2, "UNABLE TO LOCATE"); (16, "FIELD CONTACT");</strong></span>
<span class="strong"><strong class="calibre7">    (6, "REFERRED TO PROPER AGENCY"); (17, "BACK UP UNIT");</strong></span>
<span class="strong"><strong class="calibre7">    (11, "CIVIL PROBLEM"); (1, "FURTHER ACTION NECESSARY"); (3, "FALSE ALARM");</strong></span>
<span class="strong"><strong class="calibre7">    (18, "CITY ORDINANCE VIOLATION")|]</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">Looking at the code, we have a couple of new things. First, we are using the high order function <code class="literal">Seq.distinctBy</code>, which you can probably guess return records with the distinct values specified in the argument. Interestingly, the entire traffic stop record is being returned, not just the values in the lambda. If you are wondering which record gets picked by F# to represent the distinct disposition, you have to chalk it up to magic. Okay, maybe not. As it was traversing the data frame, F# picked the first record where there was a new unique value for <code class="literal">DispositionID</code> and <code class="literal">DispositionDesc</code>. In any event, since we only care about the <code class="literal">DispositionId</code> and <code class="literal">DispositionDesc</code>, we then mapped the traffic stop record into a tuple on<a id="id205" class="calibre1"/> this line of code: <code class="literal">Seq.map (fun d -&gt; d.DispositionId, d.DispositionDesc</code>. That should look familiar to you by now.</p><p class="calibre6">With our data frames set up, let's start digging into the data. One of the nice things about having a <code class="literal">DateTime</code> value is that it represents many different factors that might be worth exploring. For example, how many traffic stops are performed by month? What about the day of the week? Is there a time factor in the stops? Does more happen at night or in the day? Let's start writing some code. Go to the script and enter this code block:</p><div class="informalexample"><pre class="programlisting">let months = 
    context.dbo_TrafficStops
    |&gt; Seq.groupBy (fun ts -&gt; ts.StopDateTime.Value.Month)
    |&gt; Seq.map (fun (m, ts) -&gt; m, Seq.length ts)
    |&gt; Seq.sortBy (fun (m, ts) -&gt; m)
    |&gt; Seq.toArray</pre></div><p class="calibre6">And sending it to the REPL, you should see this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val months : (int * int) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(1, 2236); (2, 2087); (3, 2630); (4, 2053); (5, 2439); (6, 2499);</strong></span>
<span class="strong"><strong class="calibre7">    (7, 2265); (8, 2416); (9, 3365); (10, 1983); (11, 2067); (12, 1738)|]</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">Just a quick glance tells you that there are a whole lot of traffic stops being performed in September, and December looks like a light month. Digging into the code, there is a new high-order function that I used:</p><div class="informalexample"><pre class="programlisting">|&gt; Seq.groupBy (fun ts -&gt; ts.StopDateTime.Value.Month)</pre></div><p class="calibre6"><code class="literal">groupBy</code> is a very powerful function, but it can be a bit confusing the first time you use it (it was for me, at least). I came to a better understanding of <code class="literal">groupBy</code> by working backwards and looking at the output of a simple array. Go into the script file and enter this:</p><div class="informalexample"><pre class="programlisting">let testArray = [|1;1;2;3;4;5;3;4;5;5;2;1;5|]
testArray |&gt; Array.groupBy (id)</pre></div><p class="calibre6">Sending that to the REPL gives this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val testArray : int [] = [|1; 1; 2; 3; 4; 5; 3; 4; 5; 5; 2; 1; 5|]</strong></span>
<span class="strong"><strong class="calibre7">val it : (int * int []) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(1, [|1; 1; 1|]); (2, [|2; 2|]); (3, [|3; 3|]); (4, [|4; 4|]);</strong></span>
<span class="strong"><strong class="calibre7">    (5, [|5; 5; 5; 5|])|]</strong></span>
</pre></div><p class="calibre6">You will notice that the output is a tuple. The first item of the tuple is the value on which the <code class="literal">groupBy</code> grouped the data. The next item is a subarray with only the values from the original array that match the tuple's first item. Diving into the ones, <code class="literal">(1, [|1; 1; 1|])</code>, we can see that the<a id="id206" class="calibre1"/> number 1 was the <code class="literal">groupBy</code> value and that there were three 1s in the original array. <code class="literal">groupBy</code> can be applied to record types too. Consider this data frame. From left to right, the columns are <code class="literal">USState</code>, <code class="literal">Gender</code>, <code class="literal">YearOfBirth</code>, <code class="literal">NameGiven</code>, and <code class="literal">NumberOfInstances</code>:</p><div class="informalexample"><table border="1" class="calibre19"><colgroup class="calibre20"><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/></colgroup><thead class="calibre22"><tr class="calibre23"><th valign="bottom" class="calibre24">
<p class="calibre25">USState</p>
</th><th valign="bottom" class="calibre24">
<p class="calibre25">Gender</p>
</th><th valign="bottom" class="calibre24">
<p class="calibre25">YearOfBirth</p>
</th><th valign="bottom" class="calibre24">
<p class="calibre25">NameGiven</p>
</th><th valign="bottom" class="calibre24">
<p class="calibre25">NumberOfInstances</p>
</th></tr></thead><tbody class="calibre26"><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AK</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">12</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AK</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">10</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AK</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">8</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AL</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">90</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AL</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">88</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AL</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">86</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AZ</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">46</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AZ</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">34</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">AZ</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">12</p>
</td></tr></tbody></table></div><p class="calibre6">Applying a <code class="literal">groupBy</code> on <code class="literal">NameGiven</code> to this data frame gives the following output:</p><div class="informalexample"><table border="1" class="calibre19"><colgroup class="calibre20"><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/><col class="calibre21"/></colgroup><thead class="calibre22"><tr class="calibre23"><th valign="bottom" class="calibre24">
<p class="calibre25">fst</p>
</th><th colspan="5" valign="bottom" class="calibre28">
<p class="calibre25">snd</p>
</th></tr></thead><tbody class="calibre26"><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">AK</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">12</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27"> </td><td valign="top" class="calibre27">
<p class="calibre25">AL</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">90</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27"> </td><td valign="top" class="calibre27">
<p class="calibre25">AZ</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Annie</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">46</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">AK</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">10</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27"> </td><td valign="top" class="calibre27">
<p class="calibre25">AL</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">88</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27"> </td><td valign="top" class="calibre27">
<p class="calibre25">AZ</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Anna</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">34</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">AK</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">8</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27"> </td><td valign="top" class="calibre27">
<p class="calibre25">AL</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">86</p>
</td></tr><tr class="calibre23"><td valign="top" class="calibre27"> </td><td valign="top" class="calibre27">
<p class="calibre25">AZ</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">F</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">1910</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">Margaret</p>
</td><td valign="top" class="calibre27">
<p class="calibre25">12</p>
</td></tr></tbody></table></div><p class="calibre6">With the <code class="literal">fst</code> of the tuple the <code class="literal">NameGiven</code>, and the <code class="literal">snd</code> being a data frame with only the records that match the <code class="literal">fst</code>.</p><p class="calibre6">Let's continue with the next line of code <code class="literal">|&gt; Seq.map (fun (m, ts) -&gt; m, ts |&gt; Seq.length)</code>.</p><p class="calibre6">We can see that we are mapping the original tuple of month and <code class="literal">trafficStops</code> to a new tuple of month and the length of the array that was <code class="literal">snd</code> of the original tuple. This effectively reduces<a id="id207" class="calibre1"/> our data into a sequence of length 12 (one for each month). The <code class="literal">fst</code> is the month and the <code class="literal">snd</code> is the number of stops that occurred. Next we sort it by month and then push it to an array.</p><p class="calibre6">With this pattern set, let's do a couple of more <code class="literal">groupBy</code>. Let's do <code class="literal">Day</code> and <code class="literal">DayOfWeek</code>. Go into the script and enter this:</p><div class="informalexample"><pre class="programlisting">let dayOfMonth = 
    context.dbo_TrafficStops
    |&gt; Seq.groupBy (fun ts -&gt; ts.StopDateTime.Value.Day)
    |&gt; Seq.map (fun (d, ts) -&gt; d, Seq.length ts)
    |&gt; Seq.sortBy (fun (d, ts) -&gt; d)
    |&gt; Seq.toArray

let weekDay = 
    context.dbo_TrafficStops
    |&gt; Seq.groupBy (fun ts -&gt; ts.StopDateTime.Value.DayOfWeek)
    |&gt; Seq.map (fun (dow, ts) -&gt; dow, Seq.length ts)
    |&gt; Seq.sortBy (fun (dow, ts) -&gt; dow)
    |&gt; Seq.toArray</pre></div><p class="calibre6">You will notice one subtle change from the month analysis that we just did—<code class="literal">|&gt; Seq.map (fun (dow, ts) -&gt; dow, Seq.length ts)</code> has a different syntax for getting the length of the <code class="literal">snd</code>. Instead of writing <code class="literal">ts |&gt; Seq.length</code>, I wrote <code class="literal">Seq.length ts</code>. Both styles are perfectly valid F#, but the latter is considered more idiomatic. I will begin using this style more frequently in the book.</p><p class="calibre6">So once we send this to the REPL, we can see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val dayOfMonth : (int * int) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(1, 918); (2, 911); (3, 910); (4, 941); (5, 927); (6, 840); (7, 940);</strong></span>
<span class="strong"><strong class="calibre7">    (8, 785); (9, 757); (10, 805); (11, 766); (12, 851); (13, 825); (14, 911);</strong></span>
<span class="strong"><strong class="calibre7">    (15, 977); (16, 824); (17, 941); (18, 956); (19, 916); (20, 977);</strong></span>
<span class="strong"><strong class="calibre7">    (21, 988); (22, 906); (23, 1003); (24, 829); (25, 1036); (26, 1031);</strong></span>
<span class="strong"><strong class="calibre7">    (27, 890); (28, 983); (29, 897); (30, 878); (31, 659)|]</strong></span>

<span class="strong"><strong class="calibre7">val weekDay : (System.DayOfWeek * int) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(Sunday, 3162); (Monday, 3277); (Tuesday, 3678); (Wednesday, 4901);</strong></span>
<span class="strong"><strong class="calibre7">    (Thursday, 5097); (Friday, 4185); (Saturday, 3478)|]</strong></span>
</pre></div><p class="calibre6">Looking at the results, it should be pretty obvious what we are doing. The 25th of every month looks like the day where most of the traffic stops occur and Thursday sure has a lot of stops. I wonder what would happen if the 25th fell on a Thursday for a given month?</p><p class="calibre6">Before we dive deeper<a id="id208" class="calibre1"/> into the data, I want to point out that the last three blocks of code are very similar. They all follow this pattern:</p><div class="informalexample"><pre class="programlisting">let weekDay = 
   context.dbo_TrafficStops
    |&gt; Seq.groupBy (fun ts -&gt; ts.StopDateTime.Value.XXXXX)
    |&gt; Seq.map (fun (fst, snd) -&gt; fst, Seq.length snd)
    |&gt; Seq.sortBy (fun (fst, snd) -&gt; fst)
    |&gt; Seq.toArray</pre></div><p class="calibre6">Instead of having three chunks of code that are almost identical, is there a way we can consolidate them into a single function? Yes there is. What if we wrote a function like this:</p><div class="informalexample"><pre class="programlisting">let transform grouper mapper =
    context.dbo_TrafficStops 
    |&gt; Seq.groupBy grouper
             |&gt; Seq.map mapper
                             |&gt; Seq.sortBy fst 
                             |&gt; Seq.toArray</pre></div><p class="calibre6">And then we called it like this:</p><div class="informalexample"><pre class="programlisting">transform (fun ts -&gt; ts.StopDateTime.Value.Month) (fun (m, ts) -&gt; m, Seq.length ts)
transform (fun ts -&gt; ts.StopDateTime.Value.Day) (fun (d, ts) -&gt; d, Seq.length ts)
transform (fun ts -&gt; ts.StopDateTime.Value.DayOfWeek) (fun (dow, ts) -&gt; dow, Seq.length ts)</pre></div><p class="calibre6">Would that work? You bet your bippy. Sending it to the REPL, we can see we are getting the same results:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val transform :</strong></span>
<span class="strong"><strong class="calibre7">  grouper:(EntityConnection.ServiceTypes.dbo_TrafficStops -&gt; 'a) -&gt;</strong></span>
<span class="strong"><strong class="calibre7">    mapper:('a * seq&lt;EntityConnection.ServiceTypes.dbo_TrafficStops&gt; -&gt;</strong></span>
<span class="strong"><strong class="calibre7">              'b * 'c) -&gt; ('b * 'c) [] when 'a : equality and 'b : comparison</strong></span>
<span class="strong"><strong class="calibre7">val it : (System.DayOfWeek * int) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(Sunday, 3162); (Monday, 3277); (Tuesday, 3678); (Wednesday, 4901);</strong></span>
<span class="strong"><strong class="calibre7">    (Thursday, 5097); (Friday, 4185); (Saturday, 3478)|]</strong></span>
</pre></div><p class="calibre6">Those of you coming from C# and VB.NET might have gotten very uncomfortable with the transform's interface. You probably would have been much more comfortable with this syntax:</p><div class="informalexample"><pre class="programlisting">let transform (grouper, mapper) =</pre></div><p class="calibre6">The <code class="literal">()</code> and the commas<a id="id209" class="calibre1"/> make it look much more like C# and VB.NET. Although both are perfectly valid F#, this is another place where it is considered more idiomatic to remove the parenthesis and the commas. I will begin using this style more frequently in this book.</p><p class="calibre6">Also, notice that I am passing two functions into the transform function. This is very different from imperative C#/VB.NET where we usually pass data into a method. I have noticed that functional programming is more about bringing the operations to the data than bringing the data to the operations, which has profound implications once we start applying machine learning to big data.</p><p class="calibre6">Going back to our transform function, we can see that the <code class="literal">mapper</code> function is pretty the same in the three times we invoked it: <code class="literal">(fun (dow, ts) -&gt; dow, Seq.length ts)</code>. The only difference is the name we gave the first part of the tuple. This seems like another great place where we can consolidate some code. Let's rewrite transform like this:</p><div class="informalexample"><pre class="programlisting">let transform grouper  =
    context.dbo_TrafficStops 
    |&gt; Seq.groupBy grouper
    |&gt; Seq.map (fun (fst, snd) -&gt; fst, Seq.length snd)	
    |&gt; Seq.sortBy fst 
    |&gt; Seq.toArray

transform (fun ts -&gt; ts.StopDateTime.Value.Month) 
transform (fun ts -&gt; ts.StopDateTime.Value.Day) 
transform (fun ts -&gt; ts.StopDateTime.Value.DayOfWeek)</pre></div><p class="calibre6">And sending that to the REPL, we get this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val transform :</strong></span>
<span class="strong"><strong class="calibre7">  grouper:(EntityConnection.ServiceTypes.dbo_TrafficStops -&gt; 'a) -&gt;</strong></span>
<span class="strong"><strong class="calibre7">    ('a * int) [] when 'a : comparison</strong></span>

<span class="strong"><strong class="calibre7">&gt; </strong></span>

<span class="strong"><strong class="calibre7">val it : (System.DayOfWeek * int) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(Sunday, 3162); (Monday, 3277); (Tuesday, 3678); (Wednesday, 4901);</strong></span>
<span class="strong"><strong class="calibre7">    (Thursday, 5097); (Friday, 4185); (Saturday, 3478)|]</strong></span>
</pre></div><p class="calibre6">Pretty cool, huh? We will be doing this kind of programming more and more in this book. Once you get the hang<a id="id210" class="calibre1"/> of it, you will start seeing patterns in your code that you never had seen before, and you have yet another powerful arrow in your toolbox (as I mix metaphors).</p><p class="calibre6">Since you are now up to speed on <code class="literal">groupBy</code>, I want to rewrite our transform function to ditch it. Instead of using the <code class="literal">groupBy</code> and <code class="literal">map</code> functions, let's rewrite it using the <code class="literal">countBy</code> high order function. While we are at it, let's rename our function to something that is a bit more intention revealing. Type this into the script:</p><div class="informalexample"><pre class="programlisting">let getCounts counter =
    context.dbo_TrafficStops 
    |&gt; Seq.countBy counter
    |&gt; Seq.sortBy fst 
    |&gt; Seq.toArray

getCounts (fun ts -&gt; ts.StopDateTime.Value.DayOfWeek)</pre></div><p class="calibre6">Sending this to the REPL, we get the same values:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val getCounts :</strong></span>
<span class="strong"><strong class="calibre7">  counter:(EntityConnection.ServiceTypes.dbo_TrafficStops -&gt; 'a) -&gt;</strong></span>
<span class="strong"><strong class="calibre7">    ('a * int) [] when 'a : comparison</strong></span>
<span class="strong"><strong class="calibre7">val it : (System.DayOfWeek * int) [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|(Sunday, 3162); (Monday, 3277); (Tuesday, 3678); (Wednesday, 4901);</strong></span>
<span class="strong"><strong class="calibre7">    (Thursday, 5097); (Friday, 4185); (Saturday, 3478)|]</strong></span>
</pre></div></div></div>

<div class="book" title="Hack-4-Good">
<div class="book" title="Visualization"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec40" class="calibre1"/>Visualization</h2></div></div></div><p class="calibre6">Looking at the data in the REPL is a good start, but pictures are a much more powerful and effective way to <a id="id211" class="calibre1"/>communicate information. For example, is there some kind of monthly seasonality for traffic stops? Let's put the data into a chart to find out. In your script, enter this:</p><div class="informalexample"><pre class="programlisting">let months' = Seq.map (fun (m,c) -&gt; string m,c) months
Chart.LineChart months'</pre></div><p class="calibre6">Your REPL should look like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val months' : seq&lt;string * int&gt;</strong></span>
<span class="strong"><strong class="calibre7">val it : FoogleChart = (Foogle Chart)</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">Your default browser should be trying to open and should show you this:</p><div class="mediaobject"><img src="../images/00066.jpeg" alt="Visualization" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">So we see the spike in September and the drop off in December that had already caught our eye. If the date/time<a id="id212" class="calibre1"/> has some curious patterns, what about the geolocation? Enter this into the script file:</p><div class="informalexample"><pre class="programlisting">let locations = 
    context.dbo_TrafficStops 
    |&gt; Seq.filter (fun ts -&gt; ts.Latitude.HasValue &amp;&amp; ts.Longitude.HasValue )
    |&gt; Seq.map (fun ts -&gt; ts.StreetAddress, ts.Latitude.Value, ts.Longitude.Value)
    |&gt; Seq.map (fun (sa,lat,lon) -&gt; sa, lat.ToString(), lon.ToString())
    |&gt; Seq.map (fun (sa,lat,lon) -&gt; sa, lat + "," + lon)
    |&gt; Seq.take 2
    |&gt; Seq.toArray

Chart.GeoChart(locations,DisplayMode=GeoChart.DisplayMode.Markers,Region="US")</pre></div><div class="mediaobject"><img src="../images/00067.jpeg" alt="Visualization" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Not very helpful. The problem is that the FsLab geomap covers Google's <code class="literal">geoMap</code> API, and that API only<a id="id213" class="calibre1"/> goes to the country level. Instead of using Fslab then, we can roll our own. This is a fairly complex process using Bing maps, WPF dependency properties, and the like, so I will not explain it in this book. The code is available for you to review on the download section of our site. So, close your eyes and pretend the last 3 hours I spent working on this went by in 2 seconds and we have this map:</p><div class="mediaobject"><img src="../images/00068.jpeg" alt="Visualization" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">So what can we tell <a id="id214" class="calibre1"/>off the bat? There are traffic stops everywhere, though they seem to concentrate on main streets. Based on the initial analysis, the term "speed trap" might be less about location and more about month, day, and time. Also, we can't draw too much from this map because we don't know the traffic patterns—more stops might be on more traveled streets or might be an indicator of key areas where there are traffic stops. To help us dig into the data more, let's move away from simple descriptive statistics and apply a common machine learning technique called a decision tree.</p></div></div>

<div class="book" title="Hack-4-Good">
<div class="book" title="Decision trees"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec001" class="calibre1"/>Decision trees</h2></div></div></div><p class="calibre6">The principle of decision<a id="id215" class="calibre1"/> tree is this: you can use a tree-like structure to make predictions. Here is a cantonal example of whether we will play tennis today:</p><div class="mediaobject"><img src="../images/00069.jpeg" alt="Decision trees" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Each decision is called a node and the final result (in our case, the <span class="strong"><strong class="calibre7">Yes</strong></span>/<span class="strong"><strong class="calibre7">No</strong></span> boxes) is called the leaf. The analogy to a tree is somewhat appropriate. In fact, I would call it a decision branch with each decision called a crook and the final results being called leaves. However, J.R. Quinlan didn't ask me in 1986 when he invented this methodology. In any event, the number of levels of the tree is called the height of the tree. In our prior example, the tree has<a id="id216" class="calibre1"/> a maximum height of two. The nodes that are possible for a given point is called the features. In our prior example, Outlook has three features (sunny, overcast, and rain) and Strong Wind has two features (yes and no).</p><p class="calibre6">One of the real benefits of the <a id="id217" class="calibre1"/>decision tree is its simplicity of conveying information. Humans often do mental decision trees as long as the number of nodes are small and the calculation to move to the next node is simple. (Should I order decaf or regular? Do I need to study tonight?) Computers come in handy when there are many nodes and the calculations are complex. For example, we can hand the computer a whole bunch of historical data from people who decide to play tennis and it can determine that, for sunny days, the actual decision point is not 30°, but 31.2°. Something to keep in mind though is that decision trees often become less meaningful as the number of features increase and the depth gets too large. We'll look at ways to handle this a little bit later.</p></div></div>

<div class="book" title="Hack-4-Good">
<div class="book" title="Accord"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch04lvl2sec41" class="calibre1"/>Accord</h2></div></div></div><p class="calibre6">Let's make a decision tree with our traffic stop data. Go back to Visual Studio, open up <span class="strong"><strong class="calibre7">Solution Explorer</strong></span>, and add <a id="id218" class="calibre1"/>a new script called <code class="literal">Accord.fsx</code>. Enter this into<a id="id219" class="calibre1"/> the script:</p><div class="informalexample"><pre class="programlisting">#r "System.Data.Entity.dll"
#r "FSharp.Data.TypeProviders.dll"
#r "System.Data.Linq.dll"

open System
open System.Data.Linq
open System.Data.Entity
open Microsoft.FSharp.Data.TypeProviders

[&lt;Literal&gt;]
let connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=Traffic;user id=chickenskills@nc54a9m5kk;password=sk1lzm@tter;"

type EntityConnection = SqlEntityConnection&lt;connectionString,Pluralize = true&gt;
let context = EntityConnection.GetDataContext()</pre></div><p class="calibre6">This code is the same that you used in <code class="literal">Script.fsx</code> . Send it to the REPL to make sure you copy-pasted it correctly:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val connectionString : string =</strong></span>
<span class="strong"><strong class="calibre7">  "data source=nc54a9m5kk.database.windows.net;initial catalog=T"+[61 chars]</strong></span>
<span class="strong"><strong class="calibre7">type EntityConnection =</strong></span>
<span class="strong"><strong class="calibre7">  class</strong></span>
<span class="strong"><strong class="calibre7">    static member GetDataContext : unit -&gt; EntityConnection.ServiceTypes.SimpleDataContextTypes.EntityContainer</strong></span>
<span class="strong"><strong class="calibre7">     + 1 overload</strong></span>
<span class="strong"><strong class="calibre7">    nested type ServiceTypes</strong></span>
<span class="strong"><strong class="calibre7">  end</strong></span>
<span class="strong"><strong class="calibre7">val context :</strong></span>
<span class="strong"><strong class="calibre7">  EntityConnection.ServiceTypes.SimpleDataContextTypes.EntityContainer</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">Next, open up the NuGet package manager and enter in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; Install-Package Accord.MachineLearning</strong></span>
</pre></div><p class="calibre6">Go back to the script and enter in this:</p><div class="informalexample"><pre class="programlisting">#r "../packages/Accord.3.0.2/lib/net40/Accord.dll"
#r "../packages/Accord.MachineLearning.3.0.2/lib/net40/Accord.MachineLearning.dll"
#r "../packages/Accord.Statistics.3.0.2/lib/net40/Accord.Statistics.dll"
open Accord
open Accord.MachineLearning
open Accord.MachineLearning.DecisionTrees
open Accord.MachineLearning.DecisionTrees.Learning</pre></div><p class="calibre6">With that out of the way, let's create a data structure that we can pass to Accord. As I mentioned earlier, decision trees often have a problem with a large number of features. A common technique to mitigate<a id="id220" class="calibre1"/> this is to bin the data. When you bin the data, you take your original data and put them into large groups. For example, we can take all of the times for the traffic stops and bin them into AM or PM, depending on whether they occurred before or after<a id="id221" class="calibre1"/> noon. Binning is a commonly used technique in data science—sometimes justifiably and sometimes just as a way to make the model conform to a desired output.</p><p class="calibre6">Going back to our script, create the following record type for our decision tree:</p><div class="informalexample"><pre class="programlisting">type TrafficStop = {Month:int; DayOfWeek:DayOfWeek; AMPM: string; ReceviedTicket: bool option }</pre></div><p class="calibre6">You will see that I created two bins of data. The first is called <code class="literal">AMPM</code> and it is for the time of the stop. The second is called <code class="literal">ReceviedTicket</code> as a Boolean. If you remember, there are 18 different values for the disposition. We only care whether the person received a ticket (called citation), so we are binning citations to true and noncitations to false. There is one more thing that you probably noticed—<code class="literal">ReceivedTicket</code> isn't simply a bool, it is a bool option. As you might remember, F# really doesn't like nulls. Although it can support null, F# instead encourages you to use something called an option type in its place.</p><p class="calibre6">An option type can have two values: <code class="literal">Some&lt;T&gt;</code> or <code class="literal">None</code>. If you are not familiar with the syntax of <code class="literal">Some&lt;T&gt;</code>, it means that <code class="literal">Some</code> is limited to only one type. Therefore, you can write <code class="literal">Some&lt;bool&gt;</code>, <code class="literal">Some&lt;int&gt;</code>, or <code class="literal">Some&lt;string&gt;</code>. With an option type, you can verify if a field has a value that you care about: <code class="literal">Some</code> or <code class="literal">None</code>. Not only that, the compiler forces you to be explicit with the choice. This compiler checking forces you to be explicit with the value and is an extremely powerful construct. Indeed, it is one of the reasons that F# code often has fewer bugs than other languages because it forces the developer to confront problems sooner and prevents them from sweeping them under the rug into a null where they can be accidentally ignored.</p><p class="calibre6">Going back to our code, let's write two functions that will bin our original data:</p><div class="informalexample"><pre class="programlisting">let getAMPM (stopDateTime:System.DateTime) =
    match stopDateTime.Hour &lt; 12 with
    | true -&gt; "AM"
    | false -&gt; "PM"

let receviedTicket (disposition:string) =
    match disposition.ToUpper() with
    | "CITATION" -&gt; Some true
    | "VERBAL WARNING" | "WRITTEN WARNING" -&gt; Some false
    | _ -&gt; None</pre></div><p class="calibre6">Sending that to the REPL, we see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val getAMPM : stopDateTime:DateTime -&gt; string</strong></span>
<span class="strong"><strong class="calibre7">val receviedTicket : disposition:string -&gt; bool option</strong></span>
</pre></div><p class="calibre6">Notice that <code class="literal">ReceivedTicket</code> returns three possibilities with the option type: <code class="literal">Some true</code>, <code class="literal">Some false</code>, and <code class="literal">None</code>. The reason I did not include the other disposition values into <code class="literal">Some false</code> versus <code class="literal">None</code> was because we are only concentrating on traffic violations, not all of the reasons why an officer might stop a car. This kind of filtering is often used in data science<a id="id222" class="calibre1"/> to help make the dataset align with what we are trying to prove. We are not getting into more detail here about filtering as there are entire books <a id="id223" class="calibre1"/>written about the best way to deal with outliers and non-conforming data.</p><p class="calibre6">Back to our code. Let's take the data out of the database and put it into our <code class="literal">TrafficStop</code> record type. Go into the script and enter this:</p><div class="informalexample"><pre class="programlisting">let dataFrame = context.dbo_TrafficStops
                |&gt; Seq.map (fun ts -&gt; {Month=ts.StopDateTime.Value.Month;DayOfWeek=ts.StopDateTime.Value.DayOfWeek;
                                      AMPM=getAMPM(ts.StopDateTime.Value); ReceviedTicket= receviedTicket(ts.DispositionDesc) })
                |&gt; Seq.filter (fun ts -&gt; ts.ReceviedTicket.IsSome)
                |&gt; Seq.toArray</pre></div><p class="calibre6">Sending this to the REPL, we see the last bit of all of our records in the data frame:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">    {Month = 7;</strong></span>
<span class="strong"><strong class="calibre7">     DayOfWeek = Sunday;</strong></span>
<span class="strong"><strong class="calibre7">     AMPM = "PM";</strong></span>
<span class="strong"><strong class="calibre7">     ReceviedTicket = Some false;}; {Month = 7;</strong></span>
<span class="strong"><strong class="calibre7">                                     DayOfWeek = Sunday;</strong></span>
<span class="strong"><strong class="calibre7">                                     AMPM = "PM";</strong></span>
<span class="strong"><strong class="calibre7">                                     ReceviedTicket = Some false;}; ...|]</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">With the data shaped somewhat, let's get it ready for Accord. As I mentioned earlier, Accord wants the input data for the decision tree to be in a <code class="literal">int[][]</code> and the output to be in a <code class="literal">int[]</code>. However, it also needs the inputs to be tagged to make the model work. We achieve that by passing in an array of attributes. Back in the script file, add this code block:</p><div class="informalexample"><pre class="programlisting">let month = DecisionVariable("Month",13)
let dayOfWeek = DecisionVariable("DayOfWeek",7)
let ampm = DecisionVariable("AMPM",2)

let attributes =[|month;dayOfWeek;ampm|]
let classCount = 2 </pre></div><p class="calibre6">Sending this to the <a id="id224" class="calibre1"/>REPL, we see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val month : Accord.MachineLearning.DecisionTrees.DecisionVariable</strong></span>
<span class="strong"><strong class="calibre7">val dayOfWeek : Accord.MachineLearning.DecisionTrees.DecisionVariable</strong></span>
<span class="strong"><strong class="calibre7">val ampm : Accord.MachineLearning.DecisionTrees.DecisionVariable</strong></span>
<span class="strong"><strong class="calibre7">val attributes : Accord.MachineLearning.DecisionTrees.DecisionVariable [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|Accord.MachineLearning.DecisionTrees.DecisionVariable;</strong></span>
<span class="strong"><strong class="calibre7">    Accord.MachineLearning.DecisionTrees.DecisionVariable;</strong></span>
<span class="strong"><strong class="calibre7">    Accord.MachineLearning.DecisionTrees.DecisionVariable|]</strong></span>
<span class="strong"><strong class="calibre7">val classCount : int = 2</strong></span>
</pre></div><p class="calibre6">Some of the sharp-eyed <a id="id225" class="calibre1"/>people reading this book might have noticed that the month decision variable has a range of 13 and not 12. This is because the values for month are 1-12 and Accord needs 13 to account for the possibility of any feature value up to 13 (like 12.99—we know that won't exist but Accord does not). Day of week is 0 to 6, so it gets a <code class="literal">7</code>.</p><p class="calibre6">So going back to our script, add in the following blocks:</p><div class="informalexample"><pre class="programlisting">let getAMPM' (ampm: string) =
    match ampm with
    | "AM" -&gt; 0
    | _ -&gt; 1

let receivedTicket' value =
    match value with
    | true -&gt; 1
    | false -&gt; 0

let inputs = 
    dataFrame 
    |&gt; Seq.map (fun ts -&gt; [|(ts.Month); int ts.DayOfWeek; getAMPM'(ts.AMPM)|])
    |&gt; Seq.toArray

let outputs = 
    dataFrame 
    |&gt; Seq.map (fun ts -&gt; receivedTicket'(ts.ReceviedTicket.Value))
    |&gt; Seq.toArray</pre></div><p class="calibre6">Sending this to the REPL, we get the<a id="id226" class="calibre1"/> end of our data frame being converted into <code class="literal">int</code> arrays:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">    [|7; 0; 0|]; [|7; 0; 0|]; [|7; 0; 0|]; [|7; 0; 0|]; [|7; 0; 0|];</strong></span>
<span class="strong"><strong class="calibre7">    [|7; 0; 0|]; [|7; 0; 0|]; [|7; 0; 0|]; [|7; 0; 0|]; [|7; 0; 0|];</strong></span>
<span class="strong"><strong class="calibre7">    [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|];</strong></span>
<span class="strong"><strong class="calibre7">    [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|];</strong></span>
<span class="strong"><strong class="calibre7">    [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|];</strong></span>
<span class="strong"><strong class="calibre7">    [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; [|7; 0; 1|]; ...|]</strong></span>
<span class="strong"><strong class="calibre7">val outputs : int [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|0; 1; 0; 1; 0; 0; 1; 0; 0; 0; 0; 0; 0; 1; 0; 0; 0; 0; 0; 0; 1; 1; 1; 0; 1;</strong></span>
<span class="strong"><strong class="calibre7">    0; 0; 0; 0; 0; 1; 0; 0; 0; 0; 0; 1; 1; 1; 0; 1; 1; 0; 1; 0; 0; 1; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    0; 0; 0; 1; 0; 1; 0; 0; 0; 0; 1; 0; 0; 0; 0; 0; 0; 0; 0; 0; 1; 1; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    1; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 1; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    ...|]</strong></span>

<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">With everything <a id="id227" class="calibre1"/>setup, let's go ahead and run our tree. Enter this to the script:</p><div class="informalexample"><pre class="programlisting">let tree = DecisionTree(attributes, classCount)
let id3learning = ID3Learning(tree)
let error = id3learning.Run(inputs, outputs)</pre></div><p class="calibre6">Sending this to the REPL gives us:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val error : float = 0.2843236362</strong></span>
</pre></div><p class="calibre6">Just like all the other models we have seen so far, we need both an output from the model and some information about how good our model is at predicting based on the data that we provided. In this case, the model is off by 28%, which is pretty high for a decision tree. With the model created, we can now ask the tree to predict if we will get a ticket or a warning on a Saturday in October in the evening.</p><p class="calibre6">Enter this script:</p><div class="informalexample"><pre class="programlisting">let query = ([|10;6;1|])
let output = tree.Compute(query) </pre></div><p class="calibre6">Sending it to the REPL, we see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val query : int [] = [|10; 6; 1|]</strong></span>
<span class="strong"><strong class="calibre7">val output : int = 0</strong></span>
</pre></div><p class="calibre6">It looks like we will get a warning and not a ticket.</p><p class="calibre6">As I mentioned, 28% is high for<a id="id228" class="calibre1"/> a decision tree. Is there a way to get that number down? Perhaps binning <a id="id229" class="calibre1"/>will help. Go back to the REPL and type in this:</p><div class="informalexample"><pre class="programlisting">dataFrame 
    |&gt; Seq.countBy (fun ts -&gt; ts.Month) 
    |&gt; Seq.sort
    |&gt; Seq.iter (fun t -&gt;  printfn "%A" t)

dataFrame 
    |&gt; Seq.countBy (fun ts -&gt; ts.DayOfWeek) 
    |&gt; Seq.sort
    |&gt; Seq.iter (fun t -&gt;  printfn "%A" t)

dataFrame 
    |&gt; Seq.countBy (fun ts -&gt; ts.AMPM) 
    |&gt; Seq.sort
    |&gt; Seq.iter (fun t -&gt;  printfn "%A" t)

dataFrame 
    |&gt; Seq.countBy (fun ts -&gt; ts.ReceviedTicket) 
    |&gt; Seq.sort
    |&gt; Seq.iter (fun t -&gt;  printfn "%A" t)</pre></div><p class="calibre6">Sending this to the REPL, we see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">(1, 2125)</strong></span>
<span class="strong"><strong class="calibre7">(2, 1992)</strong></span>
<span class="strong"><strong class="calibre7">(3, 2529)</strong></span>
<span class="strong"><strong class="calibre7">(4, 1972)</strong></span>
<span class="strong"><strong class="calibre7">(5, 2342)</strong></span>
<span class="strong"><strong class="calibre7">(6, 2407)</strong></span>
<span class="strong"><strong class="calibre7">(7, 2198)</strong></span>
<span class="strong"><strong class="calibre7">(8, 2336)</strong></span>
<span class="strong"><strong class="calibre7">(9, 3245)</strong></span>
<span class="strong"><strong class="calibre7">(10, 1910)</strong></span>
<span class="strong"><strong class="calibre7">(11, 1989)</strong></span>
<span class="strong"><strong class="calibre7">(12, 1664)</strong></span>
<span class="strong"><strong class="calibre7">(Sunday, 3019)</strong></span>
<span class="strong"><strong class="calibre7">(Monday, 3169)</strong></span>
<span class="strong"><strong class="calibre7">(Tuesday, 3549)</strong></span>
<span class="strong"><strong class="calibre7">(Wednesday, 4732)</strong></span>
<span class="strong"><strong class="calibre7">(Thursday, 4911)</strong></span>
<span class="strong"><strong class="calibre7">(Friday, 4012)</strong></span>
<span class="strong"><strong class="calibre7">(Saturday, 3317)</strong></span>
<span class="strong"><strong class="calibre7">("AM", 9282)</strong></span>
<span class="strong"><strong class="calibre7">("PM", 17427)</strong></span>
<span class="strong"><strong class="calibre7">(Some false, 19081)</strong></span>
<span class="strong"><strong class="calibre7">(Some true, 7628)</strong></span>

<span class="strong"><strong class="calibre7">val it : unit = ()</strong></span>
</pre></div><p class="calibre6">Perhaps we can bin the <a id="id230" class="calibre1"/>months of the year in quarters? Let's create a function that does that. Go into the<a id="id231" class="calibre1"/> script file and enter this:</p><div class="informalexample"><pre class="programlisting">let getQuarter(month:int) =
    match month with
    | 1 | 2 | 3 -&gt; 1
    | 4 | 5 | 6 -&gt; 2
    | 7 | 8 | 9 -&gt; 3
    | _ -&gt; 4

let inputs' = 
    dataFrame 
    |&gt; Seq.map (fun ts -&gt; [|getQuarter((ts.Month)); int ts.DayOfWeek; getAMPM'(ts.AMPM)|])
    |&gt; Seq.toArray

let outputs' = 
    dataFrame 
    |&gt; Seq.map (fun ts -&gt; receivedTicket'(ts.ReceviedTicket.Value))
    |&gt; Seq.toArray
 
let error' = id3learning.Run(inputs', outputs')</pre></div><p class="calibre6">Sending this to the REPL, we see this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val error' : float = 0.2851473286</strong></span>
</pre></div><p class="calibre6">This did not improve our model. Perhaps we can keep working with the data, or perhaps there is not a correlation between a ticket/warning based on the data that we have. Walking away from a model is often one of the hardest things you have to do in data science, especially if you have spent a considerable amount of time on it, but it is often the right thing to do.</p></div></div>

<div class="book" title="Hack-4-Good">
<div class="book" title="numl"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch04lvl2sec42" class="calibre1"/>numl</h2></div></div></div><p class="calibre6">Before we leave decision trees, I want to look at another way of calculating them. Instead of using Accord.Net, I want to introduce another .Net machine learning library called <span class="strong"><strong class="calibre7">numl</strong></span>. numl is a new kid<a id="id232" class="calibre1"/> on the block and can offer a lower barrier entry to machine learning. Although not as expansive<a id="id233" class="calibre1"/> as Accord, it does offer many common models, including a decision tree.</p><p class="calibre6">Go to <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add another script called <code class="literal">numl.fsx</code>. Then go into the NuGet package manager and pull down numl:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; Install-Package numl</strong></span>
</pre></div><p class="calibre6">Go back to the numl script and enter in the following code:</p><div class="informalexample"><pre class="programlisting">#r "System.Data.Entity.dll"
#r "FSharp.Data.TypeProviders.dll"
#r "System.Data.Linq.dll"

open System
open System.Data.Linq
open System.Data.Entity
open Microsoft.FSharp.Data.TypeProviders

[&lt;Literal&gt;]
let connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=Traffic;user id=chickenskills@nc54a9m5kk;password=sk1lzm@tter;"

type EntityConnection = SqlEntityConnection&lt;connectionString,Pluralize = true&gt;
let context = EntityConnection.GetDataContext()

type TrafficStop = {Month:int; DayOfWeek:DayOfWeek; AMPM: string; ReceivedTicket: option&lt;bool&gt;}

let getAMPM (stopDateTime:System.DateTime) =
    match stopDateTime.Hour &lt; 12 with
    | true -&gt; "AM"
    | false -&gt; "PM"

let receviedTicket (disposition:string) =
    match disposition.ToUpper() with
    | "CITATION" -&gt; Some true
    | "VERBAL WARNING" | "WRITTEN WARNING" -&gt; Some false
    | _ -&gt; None


let dataFrame = 
    context.dbo_TrafficStops
    |&gt; Seq.map (fun ts -&gt; {Month=ts.StopDateTime.Value.Month;DayOfWeek=ts.StopDateTime.Value.DayOfWeek;
       AMPM=getAMPM(ts.StopDateTime.Value); ReceivedTicket= receviedTicket(ts.DispositionDesc) })
    |&gt; Seq.filter (fun ts -&gt; ts.ReceivedTicket.IsSome)
    |&gt; Seq.toArray</pre></div><p class="calibre6">This is the same code as the <code class="literal">Accord.fsx</code> script, so you can copy and paste it from there. Send it to the REPL to<a id="id234" class="calibre1"/> make sure you copy-pasted it correctly. Next, add in this block to reference numl.</p><div class="informalexample"><pre class="programlisting">#r "../packages/numl.0.8.26.0/lib/net40/numl.dll"
open numl
open numl.Model
open numl.Supervised.DecisionTree</pre></div><p class="calibre6">Next, enter this block of code:</p><div class="informalexample"><pre class="programlisting">type TrafficStop' = {[&lt;Feature&gt;] Month:int; [&lt;Feature&gt;] DayOfWeek:int; 
    [&lt;Feature&gt;] AMPM: string; [&lt;Label&gt;] ReceivedTicket: bool}

let dataFrame' = 
    dataFrame 
    |&gt; Seq.map (fun ts -&gt; {TrafficStop'.Month = ts.Month; DayOfWeek = int ts.DayOfWeek; AMPM=ts.AMPM; ReceivedTicket=ts.ReceivedTicket.Value})
    |&gt; Seq.map box

let descriptor = Descriptor.Create&lt;TrafficStop'&gt;()</pre></div><p class="calibre6">Sending that to the<a id="id235" class="calibre1"/> REPL, returns this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">type TrafficStop' =</strong></span>
<span class="strong"><strong class="calibre7">  {Month: int;</strong></span>
<span class="strong"><strong class="calibre7">   DayOfWeek: int;</strong></span>
<span class="strong"><strong class="calibre7">   AMPM: string;</strong></span>
<span class="strong"><strong class="calibre7">   ReceivedTicket: bool;}</strong></span>
<span class="strong"><strong class="calibre7">val dataFrame' : seq&lt;obj&gt;</strong></span>
<span class="strong"><strong class="calibre7">val descriptor : Descriptor =</strong></span>
<span class="strong"><strong class="calibre7">  Descriptor (TrafficStop') {</strong></span>
<span class="strong"><strong class="calibre7">   [Month, -1, 1]</strong></span>
<span class="strong"><strong class="calibre7">   [DayOfWeek, -1, 1]</strong></span>
<span class="strong"><strong class="calibre7">   [AMPM, -1, 0]</strong></span>
<span class="strong"><strong class="calibre7">  *[ReceivedTicket, -1, 1]</strong></span>
<span class="strong"><strong class="calibre7">}</strong></span>
</pre></div><p class="calibre6">There are two things to notice here. First, just like Accord, numl wants the input to its modeling engine to be in a certain format. In this case, it is not arrays of ints. Rather, it wants object types (as of the time of writing). In order to know what to make of each object, it needs to have attributes<a id="id236" class="calibre1"/> associated with each element, hence the <code class="literal">TrafficStop'</code> type that has either <code class="literal">[Feature]</code> or <code class="literal">[Label]</code> added. As you can guess, features are for input and labels <a id="id237" class="calibre1"/>are for outputs. The second thing to notice is that we call <code class="literal">|&gt; Seq.map box</code>. This converts our types such as int, string, and bool to object, which is what numl wants.</p><p class="calibre6">With that out of the way, we can see what numl comes up with. Enter this into the script window:</p><div class="informalexample"><pre class="programlisting">let generator = DecisionTreeGenerator(descriptor)
generator.SetHint(false)
let model = Learner.Learn(dataFrame', 0.80, 25, generator)</pre></div><p class="calibre6">Sending that to the REPL, we get:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val generator : DecisionTreeGenerator</strong></span>
<span class="strong"><strong class="calibre7">val model : LearningModel =</strong></span>
<span class="strong"><strong class="calibre7">  Learning Model:</strong></span>
<span class="strong"><strong class="calibre7">  Generator numl.Supervised.DecisionTree.DecisionTreeGenerator</strong></span>
<span class="strong"><strong class="calibre7">  Model:</strong></span>
<span class="strong"><strong class="calibre7">  [AM, 0.0021]</strong></span>
<span class="strong"><strong class="calibre7">   |- 0</strong></span>
<span class="strong"><strong class="calibre7">   |  [Month, 0.0021]</strong></span>
<span class="strong"><strong class="calibre7">   |   |- 1 ≤ x &lt; 6.5</strong></span>
<span class="strong"><strong class="calibre7">   |   |  [DayOfWeek, 0.0001]</strong></span>
<span class="strong"><strong class="calibre7">   |   |   |- 0 ≤ x &lt; 3</strong></span>
<span class="strong"><strong class="calibre7">   |   |   |   +(False, -1)</strong></span>
<span class="strong"><strong class="calibre7">   |   |   |- 3 ≤ x &lt; 6.01</strong></span>
<span class="strong"><strong class="calibre7">   |   |   |   +(False, -1)</strong></span>
<span class="strong"><strong class="calibre7">   |   |- 6.5 ≤ x &lt; 12.01</strong></span>
<span class="strong"><strong class="calibre7">   |   |   +(False, -1)</strong></span>
<span class="strong"><strong class="calibre7">   |- 1</strong></span>
<span class="strong"><strong class="calibre7">   |   +(False, -1)</strong></span>

<span class="strong"><strong class="calibre7">  Accuracy: 71.98 %</strong></span>


<span class="strong"><strong class="calibre7">&gt;</strong></span>
</pre></div><p class="calibre6">One of the nice things about numl is that the <code class="literal">ToString()</code> overload prints out a graphical representation of our tree. This is a great way to quickly visually inspect to see what we have. You can also see that the accuracy of the model is pretty much the same as Accord. If you run this script several times, you will get slightly different answers because of the way numl splits the data. Taking another look at the tree, let's see if we can interpret it in more detail.</p><p class="calibre6">The modeling engine found that the best feature to start splitting on was AM/PM. If the traffic stop was in the afternoon, you will get a warning and not a ticket. If it was in the morning, we moved down<a id="id238" class="calibre1"/> to the next decision point on the tree. What we can see is that, if the traffic stop occurred in the AM between July and December, we would not get a ticket. If the AM traffic stop was between Jan and June, we would have to go to the next level, which is the day <a id="id239" class="calibre1"/>of the week. In this case, the model split between Sunday-Tuesday and Wednesday-Saturday. You will notice that both terminal nodes are false too. Where is the true? Can the model predict that I will get a ticket? No, this model cannot reasonably predict when you will get a ticket. As before, we will have to leave this model behind. However, this exercise was not a waste because we will use this data with some more data and a different model to create something that has some practical value.</p><p class="calibre6">One last question before we leave this chapter, "What machine learning is going on here?" We can say that numl is using machine learning because it is doing several iterations with the data. But what does that mean? If you look at the last line of code we wrote, <code class="literal">let model = Learner.Learn(dataFrame', 0.80, 25, generator)</code>, you can see that the third argument is 25. This is the number of times the model is run and then numl picks the best model. In effect, then, the machine is "learning" but evaluating several possible models and selecting one for us. I don't really consider this machine learning because we are not introducing new data to the learning to make it smarter.</p><p class="calibre6">In the next chapter, we will look at using testing and training sets to accomplish some of that, but we still have the problem that this is a point-in-time analysis. How would you make this model self-teaching? Point of fact, I would not bother with the model in its current state because the model has been demonstrated to be useless. However, if the model was useful, I can imagine a scenario where we constantly update the dataset and run the model based on more datasets that our open data friends can get their hands on. With that, we can have an application running that might remind drivers before they leave the house in the morning that based on the date/time/weather/other factors, they should be taking it easier than normal. Perhaps a simple text or tweet to the driver? In any event, once we have a real model, we can see an application like this in action.</p></div></div>
<div class="book" title="Summary" id="11C3M1-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec28" class="calibre1"/>Summary</h1></div></div></div><p class="calibre6">In this chapter, we put on our data scientist hat and took a look at using F# to do data exploration and analysis. We were exposed to open data and the awesomeness of type providers. We then implemented a decision tree, though ultimately we concluded that the data did not show a significant relationship.</p><p class="calibre6">In the next chapter, we will address some of the issues that we have been glossing over so far and take a deep dive into obtaining, cleaning, and organizing our data.</p></div></body></html>