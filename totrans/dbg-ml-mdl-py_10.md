# 10

# 版本控制和可重复性机器学习建模

可重复性是一个重要的主题，有助于机器学习开发者回到机器学习生命周期的不同阶段，并识别模型改进的机会。通过访问通过机器学习生命周期生成的不同版本的数据和模型，可以帮助我们提高项目的可重复性。

在本章中，你将了解机器学习建模中可重复性的意义和重要性。你将学习如何在机器学习管道中集成数据版本控制，以帮助你在项目中实现更有效的协作，并在模型中实现可重复性。你还将了解模型版本化的不同方面以及将其集成到管道中的工具。

我们将涵盖以下主题：

+   机器学习中的可重复性

+   数据版本控制

+   模型版本控制

到本章结束时，你将学会如何在Python中利用数据和模型版本控制来为你的建模项目实现可重复性。

# 技术要求

以下为本章的要求，将帮助你更好地理解概念，在项目中使用它们，并使用提供的代码进行实践：

+   Python库要求：

    +   `pandas` >= 1.4.4

    +   `sklearn` >= 1.2.2

+   `DVC` >= 1.10.0

+   你还应该对机器学习生命周期有基本了解

你可以在GitHub上找到本章的代码文件，网址为[https://github.com/PacktPublishing/Debugging-Machine-Learning-Models-with-Python/tree/main/Chapter10](https://github.com/PacktPublishing/Debugging-Machine-Learning-Models-with-Python/tree/main/Chapter10)。

# 机器学习中的可重复性

机器学习项目中缺乏*可重复性*可能会导致资源浪费，并降低你在研究项目中模型和发现的可信度。*可重复性*在这个上下文中并不是唯一的术语；还有两个其他的关键术语：*可重复性*和*可复制性*。我们不想深入探讨这些差异的细节。相反，我们想要在这个书中使用可重复性的定义。我们将机器学习中的可重复性定义为不同个人或科学家和开发者团队使用与原始报告或研究中报告的相同数据集、方法和开发环境获得相同结果的能力。我们可以通过适当共享代码、数据、模型参数和超参数以及其他相关信息来确保可重复性，这允许其他人验证并基于我们的发现进行构建。让我们通过两个例子来更好地理解可重复性的重要性。

一家生物技术公司的科学家们试图重现53项癌症研究的发现（Begley et al., 2012）。但他们只能重现其中6项研究的成果。这些研究并不一定是在机器学习可重复性的背景下进行的，但它突出了科学研究中可重复性的重要性以及基于不可重复发现做出决策或进一步研究和开发的潜在后果。

另一个在数据分析和数据驱动发现背景下强调可重复性重要性的例子是所谓的*Reinhart-Rogoff Excel错误*（Reinhart, C.，and Rogoff, K.，2010）。2010年，经济学家Carmen Reinhart和Kenneth Rogoff发表了一篇论文，提出高公共债务与经济增长之间存在负相关关系。这篇论文影响了全球的经济政策。然而，2013年，其他研究人员发现他们在Excel计算中存在错误，这显著影响了结果。但后来，有人认为错误不是结论背后的驱动因素（Maziarz, 2017）。在这里，我们不想关注他们的发现，而是想强调分析的可重复性可以消除任何进一步的争论，无论原始分析中是否存在错误。

以下三个概念可以帮助您在机器学习建模项目中实现可重复性：

+   **代码版本控制**：能够访问机器学习生命周期任何阶段的代码版本对于重复分析或训练和评估过程至关重要

+   **数据版本控制**：为了实现可重复性，我们需要访问机器学习生命周期任何阶段使用的版本数据，例如训练和测试

+   **模型版本控制**：拥有一个具有冻结参数且在初始化、评估或其他建模过程中的随机性为零的模型版本，有助于您消除不可重复性的风险

我们在[*第一章*](B16369_01.xhtml#_idTextAnchor015)“超越代码调试”中简要介绍了代码版本控制。在这里，我们将专注于数据和模型版本控制，以帮助您设计可重复的机器学习模型。

# 数据版本控制

机器学习生命周期中，我们有不同的阶段，从数据收集和选择到数据整理和转换，数据在这些过程中逐步准备以供模型训练和评估。数据版本控制有助于我们在这些过程中保持数据完整性和可重复性。数据版本控制是跟踪和管理数据集变化的过程。它涉及记录数据的不同版本或迭代，使我们能够在需要时访问和比较先前状态或恢复早期版本。通过确保更改得到适当记录和版本控制，我们可以降低数据丢失或不一致的风险。

有一些数据版本控制工具可以帮助我们管理和跟踪我们想要用于机器学习建模或评估模型可靠性和公平性的数据变化。以下是一些流行的数据版本控制工具：

+   **MLflow**：我们在前面的章节中介绍了MLflow用于实验跟踪和模型监控，但你也可以用它来进行数据版本控制（[https://mlflow.org/](https://mlflow.org/））

+   **数据版本控制**（**DVC**）：这是一个开源的数据版本控制系统，用于管理数据、代码和机器学习模型。它旨在处理大型数据集，并与Git集成（[https://dvc.org/](https://dvc.org/））

+   **Pachyderm**：这是一个提供机器学习工作流程中可重复性、来源和可扩展性的数据版本控制平台（[https://www.pachyderm.com/](https://www.pachyderm.com/））

+   **Delta Lake**：这是一个为Apache Spark和大数据工作负载提供数据版本控制的开源存储层（[https://delta.io/](https://delta.io/））

+   **Git Large File Storage**（**Git-LFS**）：这是Git的一个扩展，允许对大型文件进行版本控制，如数据文件或模型，同时与代码一起版本控制（[https://git-lfs.github.com/](https://git-lfs.github.com/））

这些工具中的每一个都为你提供了不同的数据版本控制能力。你可以根据数据的大小、项目的性质以及与其他工具集成的期望水平来选择满足你需求的工具。

这里是一个使用DVC进行数据版本控制的Python示例。在安装DVC后，你可以在终端中写入以下命令来初始化它：

[PRE0]

这将创建一个`.dvc`目录并设置必要的配置。现在，让我们创建一个小的DataFrame并将其保存为Python中的CSV文件：

[PRE1]

现在，我们可以将`dataset.csv`文件添加到DVC中并提交更改，类似于使用Git提交代码更改：

[PRE2]

这将创建一个`data.csv.dvc`文件来跟踪数据集的版本，并将`data.csv`添加到`.gitignore`中，以便Git不跟踪实际的数据文件。现在，我们可以按如下方式修改数据集并使用相同的名称保存它：

[PRE3]

我们也可以提交更改并将其保存为不同的版本：

[PRE4]

现在我们有了`dataset.csv`文件的两个版本，我们可以在需要时使用以下命令在终端切换到之前的版本或最新版本的数据集：

[PRE5]

但如果你有很多相同文件或数据的版本，你可以使用DVC（Data Version Control）作为其一部分的其他简单命令。

除了对数据进行版本控制外，我们还需要在整个开发周期中跟踪和管理模型的不同版本。我们将在下一章中介绍这一点。

# 模型版本控制

生产的模型是经过一系列实验和模型修改的最终结果，包括不同版本的训练和测试数据，以及不同的机器学习方法和相应的超参数。模型版本化帮助我们确保对模型所做的更改是可追溯的，有助于在机器学习项目中建立可重复性。它确保了在特定时间点可以轻松地重现每个模型的版本，通过提供模型参数、超参数和训练数据的完整快照。它允许我们在新部署的模型出现问题时轻松回滚到先前的版本，或者恢复可能被无意中修改或删除的旧版本。

让我们通过一个非常简单的例子来更好地理解模型版本化的必要性。*图10.1*展示了具有五个估计器或决策树的随机森林模型的不同最大深度。如果我们简单地改变用于将数据分割成训练集和测试集的随机状态，使用`scikit-learn`中的`train_test_split()`，并对`RandomForestClassifier()`模型进行模型初始化，我们得到不同的对数损失值和随机森林模型中树的最大深度的依赖性：

![图10.1 – 使用不同的随机状态进行建模和数据分割，从乳腺癌数据集中分离出的训练集和验证集的对数损失](img/B16369_10_01.jpg)

图10.1 – 使用不同的随机状态进行建模和数据分割，从乳腺癌数据集中分离出的训练集和验证集的对数损失

这是一个小例子，用以展示如果我们的模型没有进行版本控制，这样的简单变化可能会对我们的机器学习建模产生极大的影响。当我们使用实验跟踪工具，如MLflow时，我们可以访问所选模型的全部跟踪信息。

为了对模型进行版本控制，我们需要确保以下几点：

+   我们可以访问相应模型的参数的保存版本

+   其他必要信息，如模型超参数，已记录或保存以供模型重新训练

+   需要与模型参数一起用于推理或甚至重新训练和测试的代码已进行版本控制

+   具有随机性的过程，如模型初始化和训练及测试数据分割，有指定的随机状态或种子

存储模型及其相关文档的方式有很多种。例如，您可以使用序列化库如`pickle`单独存储模型，或者与DVC ([https://dvc.org/doc/api-reference/open](https://dvc.org/doc/api-reference/open)) 结合使用，如下所示：

[PRE6]

为了此目的，您需要指定一个用于保存模型的本地路径，使用`pickle.dump`，以及使用DVC进行模型版本化的远程路径。

# 摘要

在本章中，你学习了机器学习建模中可重现性的意义和重要性。你还学习了数据版本化和模型版本化，这些有助于我们开发更可靠和可重现的模型和数据分析结果。接下来，你学习了可用于版本化数据和模型的不同的工具和Python库。通过本章介绍的概念和实践，你已准备好确保你的机器学习项目中的可重现性。

在下一章中，你将学习如何使用技术来避免和消除数据漂移和概念漂移，这两者构成了模型在部署前后行为差异的两个方面。

# 问题

1.  请列举三个可用于数据版本化的工具的例子？

1.  当你使用DVC等工具生成相同数据的不同版本时，你是否需要用不同的名称保存它们？

1.  你能提供一个例子，说明你使用相同的方法、训练和评估数据，但得到不同的训练和评估性能吗？

# 参考文献

+   Reinhart, C.，& Rogoff, K. (2010b). *债务与增长的回顾*. VOX. CEPRs政策门户。检索日期：2015年9月18日。

+   Reinhart, C.，& Rogoff, K. (2010a). *债务时期的增长*.美国经济评论，100，573–578.10.1257/aer.100.2.573。

+   Maziarz, Mariusz. *Reinhart-Rogoff争议作为“新兴相反结果”现象的一个实例*.经济方法论杂志，24.3 (2017)：213-225。

+   Begley, C. G.，& Ellis, L. M. (2012). *药物开发：提高临床前癌症研究标准*.自然，483(7391)，531-533。

+   计算机协会（2016年）.*工件审查和徽章*.可在[https://www.acm.org/publications/policies/artifact-review-badging](https://www.acm.org/publications/policies/artifact-review-badging)在线获取（访问日期：2017年11月24日）。

+   Plesser, Hans E. *可重现性 vs. 可复制性：一个混乱术语的简要历史*.神经信息学前沿，11 (2018)：76。

+   Pineau, J.，Vincent, M.，Larochelle, H.，& Bengio, Y. (2020). *提高机器学习研究可重现性（来自NeurIPS 2019可重现性计划的一份报告）*. arXiv预印本arXiv:2003.12206。

+   Raff, E.，Lemire, D.，& Nicholas, C. (2019). *机器学习中算法稳定性的新度量*.机器学习研究杂志，20(168)，1-32。

+   Gundersen, O. E.，& Kjensmo, S. (2018). *人工智能中的最新技术：可重现性*.在第三十二届AAAI人工智能会议。

+   Jo, T.，& Bengio, Y. (2017). *测量CNN学习表面统计规律的趋势*. arXiv预印本arXiv:1711.11561。

+   Haibe-Kains, B.，Adam, G. A.，Hosny, A.，Khodakarami, F.，& Waldron, L. (2020). *人工智能中的透明度和可重现性*.自然，586(7829)，E14-E16。
