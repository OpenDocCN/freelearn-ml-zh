<html><head></head><body>
<div id="_idContainer101">
<h1 class="chapter-number" id="_idParaDest-163"><a id="_idTextAnchor261"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-164"><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.2.1">Testing and Debugging for Production</span></h1>
<p><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.3.1">You might have gotten excited about training and testing a machine learning model without thinking about the unexpected behavior of your model in production and how your model fits into a bigger technology. </span><span class="koboSpan" id="kobo.3.2">Most academic courses don’t go through details of strategies to test models, assess their qualities, and monitor their performance pre-deployment and in production. </span><span class="koboSpan" id="kobo.3.3">There are important concepts and techniques in testing and debugging models for production that we will review in </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.7.1">Infrastructure testing</span></span></li>
<li><span class="koboSpan" id="kobo.8.1">Integration testing of machine </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">learning pipelines</span></span></li>
<li><span class="koboSpan" id="kobo.10.1">Monitoring and validating </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">live performance</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Model assertion</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.13.1">By the end of this chapter, you will have learned about the importance of infrastructure and integration testing, as well as model monitoring and assertion. </span><span class="koboSpan" id="kobo.13.2">You will have also learned how to use Python libraries so that you can benefit from them in </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">your projects.</span></span></p>
<h1 id="_idParaDest-165"><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.15.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.16.1">The following requirements should be considered for this chapter as they will help you better understand the concepts, use them in your projects, and practice with the </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">provided code:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.18.1">Python </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">library requirements:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.20.1">sklearn</span></strong><span class="koboSpan" id="kobo.21.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">1.2.2</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.23.1">numpy</span></strong><span class="koboSpan" id="kobo.24.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">1.22.4</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.26.1">pytest</span></strong><span class="koboSpan" id="kobo.27.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">7.2.2</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.29.1">You must also have basic knowledge of the machine learning </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">life cycle</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.31.1">You can find the code files for this chapter on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">at </span></span><a href="https://github.com/PacktPublishing/Debugging-Machine-Learning-Models-with-Python/tree/main/Chapter09"><span class="No-Break"><span class="koboSpan" id="kobo.33.1">https://github.com/PacktPublishing/Debugging-Machine-Learning-Models-with-Python/tree/main/Chapter09</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.34.1">.</span></span></p>
<h1 id="_idParaDest-166"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.35.1">Infrastructure testing</span></h1>
<p><span class="koboSpan" id="kobo.36.1">Infrastructure testing</span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.37.1"> refers to the process of verifying and validating the various components and systems involved in deploying, managing, and scaling machine learning models. </span><span class="koboSpan" id="kobo.37.2">This includes testing software, hardware, and other resources that make up the infrastructure that supports machine learning workflows. </span><span class="koboSpan" id="kobo.37.3">Infrastructure testing in machine learning helps you ensure that models are trained, deployed, and maintained effectively. </span><span class="koboSpan" id="kobo.37.4">It provides you with reliable models in a production environment. </span><span class="koboSpan" id="kobo.37.5">Regular infrastructure testing can help you detect and fix issues early and reduce the risk of failures during deployment and in the </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">production stage.</span></span></p>
<p><span class="koboSpan" id="kobo.39.1">Here are some of the</span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.40.1"> important aspects of infrastructure testing </span><a id="_idIndexMarker513"/><span class="koboSpan" id="kobo.41.1">in </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">machine learning:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.43.1">Data pipeline testing</span></strong><span class="koboSpan" id="kobo.44.1">: This ensures that the data pipelines responsible for data collection, selection, and wrangling are working correctly and efficiently. </span><span class="koboSpan" id="kobo.44.2">This helps maintain data quality and consistency for training, testing, and deploying your machine </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">learning models.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.46.1">Model training and evaluation</span></strong><span class="koboSpan" id="kobo.47.1">: This validates the functionality of the model training process, such as hyperparameter tuning and model evaluation. </span><span class="koboSpan" id="kobo.47.2">This process eliminates unexpected issues in training and evaluation to achieve a reliable and </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">responsible model.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.49.1">Model deployment and serving</span></strong><span class="koboSpan" id="kobo.50.1">: This tests the process of deploying the trained model in a production environment, ensuring that the serving infrastructure, such as API endpoints, is working correctly and can handle the expected </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">request load.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.52.1">Monitoring and observability</span></strong><span class="koboSpan" id="kobo.53.1">: This tests the monitoring and logging systems that provide insights into the performance and behavior of the machine </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">learning infrastructure.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.55.1">Integration testing</span></strong><span class="koboSpan" id="kobo.56.1">: This verifies that all components of the machine learning infrastructure, such as data pipelines, model training systems, and deployment platforms, are working together seamlessly and </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">without conflicts.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.58.1">Scalability testing</span></strong><span class="koboSpan" id="kobo.59.1">: This evaluates </span><a id="_idIndexMarker514"/><span class="koboSpan" id="kobo.60.1">the ability of the infrastructure to scale up or down in response to changing requirements, such as increased data volume, higher user traffic, or more </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">complex models.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.62.1">Security and compliance testing</span></strong><span class="koboSpan" id="kobo.63.1">: This ensures that the machine learning infrastructure</span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.64.1"> meets necessary security requirements, data protection regulations, and </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">privacy standards.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.66.1">Now that you understand the importance and benefits of infrastructure testing, you are ready to learn about the related tools that can help you in model deployment and </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">infrastructure managem</span><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.68.1">ent.</span></span></p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.69.1">Infrastructure as Code tools</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.70.1">Infrastructure as Code</span></strong><span class="koboSpan" id="kobo.71.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.72.1">IaC</span></strong><span class="koboSpan" id="kobo.73.1">) and</span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.74.1"> configuration </span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.75.1">management tools such as </span><strong class="bold"><span class="koboSpan" id="kobo.76.1">Chef</span></strong><span class="koboSpan" id="kobo.77.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.78.1">Puppet</span></strong><span class="koboSpan" id="kobo.79.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.80.1">Ansible</span></strong><span class="koboSpan" id="kobo.81.1"> can be used to automate the deployment, configuration, and management of software and hardware infrastructures. </span><span class="koboSpan" id="kobo.81.2">These tools could help us ensure consistency and reliability across different environments. </span><span class="koboSpan" id="kobo.81.3">Let’s understand how Chef, Puppet, and Ansible work, and how they can help you in </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">your projects:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.83.1">Chef</span></strong><span class="koboSpan" id="kobo.84.1"> (</span><a href="https://www.chef.io/products/chef-infrastructure-management"><span class="koboSpan" id="kobo.85.1">https://www.chef.io/products/chef-infrastructure-management</span></a><span class="koboSpan" id="kobo.86.1">): Chef is an </span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.87.1">open </span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.88.1">source configuration</span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.89.1"> management tool that relies on a client-server model, where the Chef server stores the desired configuration, and the Chef client applies it to </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">the nodes.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.91.1">Puppet</span></strong><span class="koboSpan" id="kobo.92.1"> (</span><a href="https://www.puppet.com/"><span class="koboSpan" id="kobo.93.1">https://www.puppet.com/</span></a><span class="koboSpan" id="kobo.94.1">): Puppet is </span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.95.1">another </span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.96.1">open source configuration management tool that </span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.97.1">works in a client-server model or as a standalone application. </span><span class="koboSpan" id="kobo.97.2">Puppet enforces desired configurations</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.98.1"> across nodes by periodically pulling them from the Puppet </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">master server.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.100.1">Ansible</span></strong><span class="koboSpan" id="kobo.101.1"> (</span><a href="https://www.ansible.com/"><span class="koboSpan" id="kobo.102.1">https://www.ansible.com/</span></a><span class="koboSpan" id="kobo.103.1">): Ansible </span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.104.1">is an open source and easy-to-use </span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.105.1">configuration</span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.106.1"> management, orchestration, and automation tool that communicates and applies configurations </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">to nodes.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.108.1">These tools</span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.109.1"> primarily focus on infrastructure management and automation, but they also have modules or plugins to perform basic testing and validation of </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">th</span><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.111.1">e infrastructure.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.112.1">Infrastructure testing tools</span></h2>
<p><span class="koboSpan" id="kobo.113.1">Test Kitchen, ServerSpec, and InSpec are infrastructure testing tools we can use to verify and validate the desired configuration and behavior of </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">our infrastructures:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.115.1">Test Kitchen</span></strong><span class="koboSpan" id="kobo.116.1"> (</span><a href="https://github.com/test-kitchen/test-kitchen"><span class="koboSpan" id="kobo.117.1">https://github.com/test-kitchen/test-kitchen</span></a><span class="koboSpan" id="kobo.118.1">): Test Kitchen is an</span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.119.1"> integration testing framework</span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.120.1"> mainly used with Chef but can also work with other</span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.121.1"> IaC tools such as Ansible and Puppet. </span><span class="koboSpan" id="kobo.121.2">It allows you to test your infrastructure code on different platforms and configurations. </span><span class="koboSpan" id="kobo.121.3">Test Kitchen creates temporary instances on various platforms (using drivers such as Docker or cloud providers), converges your infrastructure code, and runs tests against the configured instances. </span><span class="koboSpan" id="kobo.121.4">You can use Test Kitchen with different testing frameworks, such as ServerSpec or InSpec, to define </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">your tests.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.123.1">ServerSpec</span></strong><span class="koboSpan" id="kobo.124.1"> (</span><a href="https://serverspec.org/"><span class="koboSpan" id="kobo.125.1">https://serverspec.org/</span></a><span class="koboSpan" id="kobo.126.1">): ServerSpec</span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.127.1"> is a </span><strong class="bold"><span class="koboSpan" id="kobo.128.1">behavior-driven development</span></strong><span class="koboSpan" id="kobo.129.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.130.1">BDD</span></strong><span class="koboSpan" id="kobo.131.1">) testing</span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.132.1"> framework </span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.133.1">for </span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.134.1">infrastructure. </span><span class="koboSpan" id="kobo.134.2">It allows you to write tests in a human-readable language. </span><span class="koboSpan" id="kobo.134.3">ServerSpec tests the desired state of your infrastructure by executing commands on the target system and checking the output against </span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.135.1">the expected results. </span><span class="koboSpan" id="kobo.135.2">You can use ServerSpec with </span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.136.1">Test Kitchen or other IaC tools to ensure that your infrastructure is </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">configured correctly.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.138.1">InSpec</span></strong><span class="koboSpan" id="kobo.139.1"> (</span><a href="https://github.com/inspec/inspec"><span class="koboSpan" id="kobo.140.1">https://github.com/inspec/inspec</span></a><span class="koboSpan" id="kobo.141.1">): InSpec, developed by Chef, is an open </span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.142.1">source</span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.143.1"> infrastructure testing framework. </span><span class="koboSpan" id="kobo.143.2">It </span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.144.1">defines tests and compliance rules in a human-readable language. </span><span class="koboSpan" id="kobo.144.2">You can run InSpec tests independently or in conjunction with tools such as Test Kitchen, Chef, or other </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">IaC platforms.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.146.1">These tools ensure </span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.147.1">that our IaC and configuration management setups work as expected before deployment to achieve consistency and reliability </span><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.148.1">across </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">different environments.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.150.1">Infrastructure testing using Pytest</span></h2>
<p><span class="koboSpan" id="kobo.151.1">We can </span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.152.1">also </span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.153.1">use Pytest, which we used for unit testing in the previous chapter for infrastructure testing. </span><span class="koboSpan" id="kobo.153.2">Let’s assume we write test functions that </span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.154.1">should start with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">test_</span></strong><span class="koboSpan" id="kobo.156.1"> prefix in a Python file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">test_infrastructure.py</span></strong><span class="koboSpan" id="kobo.158.1">. </span><span class="koboSpan" id="kobo.158.2">We can use Python libraries such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">paramiko</span></strong><span class="koboSpan" id="kobo.160.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">requests</span></strong><span class="koboSpan" id="kobo.162.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">socket</span></strong><span class="koboSpan" id="kobo.164.1"> to interact with our infrastructure (for example, making API calls, connecting to servers, and so on). </span><span class="koboSpan" id="kobo.164.2">For example, we can test whether a web server is responding with status </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">code 200:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.166.1">
import requestsdef test_web_server_response():
    url = "http://your-web-server-url.com"
    response = requests.get(url)
    assert response.status_code == 200,
        f"Expected status code 200,
        but got {response.status_code}"</span></pre>
<p><span class="koboSpan" id="kobo.167.1">Then, we can run the tests that we explained in the </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">previous chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.169.1">Other techniques </span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.170.1">besides infrastructure testing can help </span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.171.1">you in preparing your models for a successful deployment, such as integration</span><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.172.1"> testing, which we will </span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">cover next.</span></span></p>
<h1 id="_idParaDest-170"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.174.1">Integration testing of machine learning pipelines</span></h1>
<p><span class="koboSpan" id="kobo.175.1">When we train a machine learning model, we need to evaluate how well it interacts with the other</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.176.1"> components of a larger system it belongs to. </span><span class="koboSpan" id="kobo.176.2">Integration testing helps us in validating that the model works correctly within the overall application or infrastructure and meets the desired performance criteria. </span><span class="koboSpan" id="kobo.176.3">Some of the important components of </span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.177.1">integration testing to rely on in our machine learning projects are </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.179.1">Testing data pipelines</span></strong><span class="koboSpan" id="kobo.180.1">: We</span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.181.1"> need to evaluate that the data preprocessing components before model training, such as data wrangling, are consistent between the training and </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">deployment stages.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.183.1">Testing APIs</span></strong><span class="koboSpan" id="kobo.184.1">: If our</span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.185.1"> machine learning model is exposed through an API, we can test the API endpoints to ensure it handles requests and </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">responses correctly.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.187.1">Testing model deployment</span></strong><span class="koboSpan" id="kobo.188.1">: We can</span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.189.1"> use integration testing to assess the model’s deployment process, whether it’s deployed as a standalone service, within a container, or embedded in an application. </span><span class="koboSpan" id="kobo.189.2">This process helps us ensure that the deployment environment provides the necessary resources, such as CPU, memory, and storage, and that the model can be updated </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">if needed.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.191.1">Testing interactions with other components</span></strong><span class="koboSpan" id="kobo.192.1">: We need to verify that our machine</span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.193.1"> learning model works seamlessly with databases, user interfaces, or third-party services. </span><span class="koboSpan" id="kobo.193.2">This may include testing how the model’s predictions are stored, displayed, or used within </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">the application.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.195.1">Testing end-to-end functionality</span></strong><span class="koboSpan" id="kobo.196.1">: We can use end-to-end tests that simulate real-world </span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.197.1">scenarios and user interactions to validate that the model’s predictions are accurate, reliable, and useful in the context of the </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">overall application.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.199.1">We can benefit from integration testing to ensure a smooth deployment and reliable operation in real-world applications. </span><span class="koboSpan" id="kobo.199.2">There are several tools and libraries we can use to create</span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.200.1"> robust integration tests for our machine learning models in Python. </span><em class="italic"><span class="koboSpan" id="kobo.201.1">Table 9.1</span></em><span class="koboSpan" id="kobo.202.1"> shows some of the popular tools for </span><a id="_idIndexMarker555"/><span class="No-Break"><span class="koboSpan" id="kobo.203.1">integration testing:</span></span></p>
<table class="No-Table-Style" id="table001-8">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.204.1">Tool</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.205.1">Brief Description</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.206.1">URL</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.207.1">Pytest</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.208.1">A framework widely used for unit and integration testing </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">in Python</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://docs.pytest.org/en/7.2.x/"><span class="No-Break"><span class="koboSpan" id="kobo.210.1">https://docs.pytest.org/en/7.2.x/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.211.1">Postman</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.212.1">An API testing tool that’s used for testing the interaction between machine learning models and </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">RESTful APIs</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.postman.com/"><span class="No-Break"><span class="koboSpan" id="kobo.214.1">https://www.postman.com/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.215.1">Requests</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.216.1">A Python library that tests APIs and services by sending </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">HTTP requests</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://requests.readthedocs.io/en/latest/"><span class="No-Break"><span class="koboSpan" id="kobo.218.1">https://requests.readthedocs.io/en/latest/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.219.1">Locust</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.220.1">A load testing tool that allows you to simulate user behavior and test the performance and scalability of your machine learning models under various </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">load conditions</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://locust.io/"><span class="No-Break"><span class="koboSpan" id="kobo.222.1">https://locust.io/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.223.1">Selenium</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.224.1">A browser automation tool you can use to test the end-to-end functionality of web applications that utilize machine </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">learning models</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.selenium.dev/"><span class="No-Break"><span class="koboSpan" id="kobo.226.1">https://www.selenium.dev/</span></span></a></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.227.1">Table 9.1 – Popular tools for integration testing</span></p>
<h2 id="_idParaDest-171"><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.228.1">Integration testing using pytest</span></h2>
<p><span class="koboSpan" id="kobo.229.1">Here, we </span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.230.1">want to practice integration testing using </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">pytest</span></strong><span class="koboSpan" id="kobo.232.1"> for a simple Python application with two components: a database and a service, both of which retrieve data from the database. </span><span class="koboSpan" id="kobo.232.2">Let’s assume we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">database.py</span></strong><span class="koboSpan" id="kobo.234.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">service.py</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.236.1">script files:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.237.1">database.py:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.238.1">
class Database:    def __init__(self):
        self.data = {"users": [{"id": 1,
            "name": "John Doe"},
            {"id": 2, "name": "Jane Doe"}]}
    def get_user(self, user_id):
        for user in self.data["users"]:
            if user["id"] == user_id:
                return user
            return None</span></pre>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.239.1">service.py:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.240.1">
from database import Databaseclass UserService:
    def __init__(self, db):
        self.db = db
    def get_user_name(self, user_id):
        user = self.db.get_user(user_id)
        if user:
            return user["name"]
        return None</span></pre>
<p><span class="koboSpan" id="kobo.241.1">Now, we </span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.242.1">will write an integration test using </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">pytest</span></strong><span class="koboSpan" id="kobo.244.1"> to ensure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">UserService</span></strong><span class="koboSpan" id="kobo.246.1"> component works correctly with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">Database</span></strong><span class="koboSpan" id="kobo.248.1"> component. </span><span class="koboSpan" id="kobo.248.2">First, we need to write our tests in a test script file, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">test_integration.py</span></strong><span class="koboSpan" id="kobo.250.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.252.1">
import pytestfrom database import Database
from service import UserService
@pytest.fixture
def db():
    return Database()
@pytest.fixture
def user_service(db):
    return UserService(db)
def test_get_user_name(user_service):
    assert user_service.get_user_name(1) == "John Doe"
    assert user_service.get_user_name(2) == "Jane Doe"
    assert user_service.get_user_name(3) is None</span></pre>
<p><span class="koboSpan" id="kobo.253.1">The </span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.254.1">defined </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">test_get_user_name</span></strong><span class="koboSpan" id="kobo.256.1"> function tests the interaction between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">UserService</span></strong><span class="koboSpan" id="kobo.258.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">Database</span></strong><span class="koboSpan" id="kobo.260.1"> components by checking whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">get_user_name</span></strong><span class="koboSpan" id="kobo.262.1"> method returns the correct usernames for different </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">user IDs.</span></span></p>
<p><span class="koboSpan" id="kobo.264.1">To run the test, we can execute the following command in </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">the Terminal:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.266.1">
pytest test_integration.</span><a id="_idTextAnchor275"/><span class="koboSpan" id="kobo.267.1">py</span></pre> <h3><span class="koboSpan" id="kobo.268.1">Integration testing using pytest and requests</span></h3>
<p><span class="koboSpan" id="kobo.269.1">We can </span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.270.1">combine the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">requests</span></strong><span class="koboSpan" id="kobo.272.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">pytest</span></strong><span class="koboSpan" id="kobo.274.1"> Python libraries to perform integration testing on our machine learning APIs. </span><span class="koboSpan" id="kobo.274.2">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">requests</span></strong><span class="koboSpan" id="kobo.276.1"> library to send HTTP requests and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">pytest</span></strong><span class="koboSpan" id="kobo.278.1"> library to write test cases. </span><span class="koboSpan" id="kobo.278.2">Let’s suppose we have a machine learning API with the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">following endpoint:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.280.1">
POST http://mldebugging.com/api/v1/predict</span></pre> <p><span class="koboSpan" id="kobo.281.1">Here, the API accepts a JSON payload with </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">input data:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.283.1">
{    "rooms": 3,
    "square_footage": 1500,
    "location": "suburban"
}</span></pre>
<p><span class="koboSpan" id="kobo.284.1">This returns a JSON response with the </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">predicted price:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.286.1">
{    "predicted_price": 700000
}</span></pre>
<p><span class="koboSpan" id="kobo.287.1">Now, we need to create a test script file </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">test_integration.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.291.1">
import requestsimport pytest
API_URL = "http://mldebugging.com/api/v1/predict"
def test_predict_house_price():
    payload = {
        "rooms": 3,
        "square_footage": 1500,
        "location": "suburban"
    }
    response = requests.post(API_URL, json=payload)
    assert response.status_code == 200
    assert response.headers["Content-Type"] == "application/json"
    json_data = response.json()
    assert "predicted_price" in json_data
    assert isinstance(json_data["predicted_price"],
        (int, float))</span></pre>
<p><span class="koboSpan" id="kobo.292.1">To run the test, we can execute the following command in </span><span class="No-Break"><span class="koboSpan" id="kobo.293.1">the Terminal:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.294.1">
pytest test_integration.py</span></pre> <p><span class="koboSpan" id="kobo.295.1">In this example, we defined a test function called </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">test_predict_house_price</span></strong><span class="koboSpan" id="kobo.297.1"> that sends a POST request (that is, an HTTP method used to submit data to a server to create or update a resource) to the API with the input data as a JSON payload. </span><span class="koboSpan" id="kobo.297.2">The test function then checks the API response’s status code, content type, and predicted price value. </span><span class="koboSpan" id="kobo.297.3">If you want to try this with a real API you have, replace the example URL with the actual </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">API endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.299.1">In addition to the testing strategies we covered in this chapter, you can benefit from model monitoring and assertion to have successful deployments and reliable models in </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">production environm</span><a id="_idTextAnchor276"/><span class="koboSpan" id="kobo.301.1">ents.</span></span></p>
<h1 id="_idParaDest-172"><a id="_idTextAnchor277"/><span class="koboSpan" id="kobo.302.1">Monitoring and validating live performance</span></h1>
<p><span class="koboSpan" id="kobo.303.1">We can use</span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.304.1"> monitoring and logging mechanisms during deployment to track the model’s performance and detect potential issues. </span><span class="koboSpan" id="kobo.304.2">We can regularly evaluate the deployed model to ensure it continues to meet performance criteria, or other criteria, such as being unbiased, that we defined for it. </span><span class="koboSpan" id="kobo.304.3">We can also benefit from </span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.305.1">the information coming from model monitoring to update or retrain the model as needed. </span><span class="koboSpan" id="kobo.305.2">Here are three important concepts in this subject regarding differences between modeling before deployment and </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">in production:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.307.1">Data variance</span></strong><span class="koboSpan" id="kobo.308.1">: The</span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.309.1"> data that is used in model training and testing goes through the steps of data wrangling and all the cleaning and reformatting needed. </span><span class="koboSpan" id="kobo.309.2">However, the data that is given to the deployed model – that is, the data coming from the user to the model – might not go through the same data processes, which then causes variations in the model results </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">in production.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.311.1">Data drift</span></strong><span class="koboSpan" id="kobo.312.1">: Data drift </span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.313.1">happens if the characteristics and meaning of features or independent variables in production differ from those in the modeling stage. </span><span class="koboSpan" id="kobo.313.2">Imagine you used a third-party tool to generate a score for the health or financial situation of people. </span><span class="koboSpan" id="kobo.313.3">The algorithm behind that tool could change over time, and its range and meaning will not be the same when your model gets used in production. </span><span class="koboSpan" id="kobo.313.4">If you have not updated your model accordingly, then your model will not work as expected as the meaning of the value of the features will not be the same between the data used for training and the user data </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">after deployment.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.315.1">Concept drift</span></strong><span class="koboSpan" id="kobo.316.1">: Concept drift is</span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.317.1"> about any change in the definition of output variables. </span><span class="koboSpan" id="kobo.317.2">For example, real decision boundaries between training data and production could be different because of concept drift, meaning the effort made in training might result in a decision boundary far from reality </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">in production.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.319.1">In addition to MLflow, which </span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.320.1">was introduced in the </span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.321.1">previous chapter, there are Python and libraries tools (as listed in </span><em class="italic"><span class="koboSpan" id="kobo.322.1">Table 9.2</span></em><span class="koboSpan" id="kobo.323.1">) that you can use to monitor the performance, I/O data, and infrastructure of machine learning models, helping you maintain model quality and reliability in </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">production environments:</span></span></p>
<table class="No-Table-Style" id="table002-5">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.325.1">Tool</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.326.1">Brief Description</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.327.1">URL</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.328.1">Alibi Detect</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.329.1">An open source Python library that focuses on outlier, adversarial, and </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">drift detection</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://github.com/SeldonIO/alibi-detect"><span class="No-Break"><span class="koboSpan" id="kobo.331.1">https://github.com/SeldonIO/alibi-detect</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.332.1">Evidently</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.333.1">An open source Python library for analyzing and monitoring machine learning models that offers various model evaluation techniques, such as data drift detection and model </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">performance monitoring</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://github.com/evidentlyai/evidently"><span class="No-Break"><span class="koboSpan" id="kobo.335.1">https://github.com/evidentlyai/evidently</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.336.1">ELK Stack</span></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.337.1">Elasticsearch</span></strong><span class="koboSpan" id="kobo.338.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.339.1"> Logstash</span></strong><span class="koboSpan" id="kobo.340.1">,</span><strong class="bold"><span class="koboSpan" id="kobo.341.1"> and Kibana</span></strong><span class="koboSpan" id="kobo.342.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.343.1">ELK</span></strong><span class="koboSpan" id="kobo.344.1">) is a popular stack for collecting, processing, and visualizing logs and metrics from various sources, including machine </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">learning models</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.elastic.co/elk-stack"><span class="No-Break"><span class="koboSpan" id="kobo.346.1">https://www.elastic.co/elk-stack</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.347.1">WhyLabs</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.348.1">A platform that provides observability and monitoring for machine </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">learning models</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://whylabs.ai/"><span class="No-Break"><span class="koboSpan" id="kobo.350.1">https://whylabs.ai/</span></span></a></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.351.1">Table 9.2 – Popular tools for machine learning model monitoring and drift detection</span></p>
<p><span class="koboSpan" id="kobo.352.1">We can also benefit from some statistical and visualization techniques for detecting and addressing </span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.353.1">data and concept drifts. </span><span class="koboSpan" id="kobo.353.2">Here are some examples </span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.354.1">of such methods for data </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">drift evaluation:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.356.1">Statistical tests</span></strong><span class="koboSpan" id="kobo.357.1">: We</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.358.1"> can use hypothesis tests, such as the </span><em class="italic"><span class="koboSpan" id="kobo.359.1">Kolmogorov-Smirnov test</span></em><span class="koboSpan" id="kobo.360.1">, </span><em class="italic"><span class="koboSpan" id="kobo.361.1">Chi-squared test</span></em><span class="koboSpan" id="kobo.362.1">, or </span><em class="italic"><span class="koboSpan" id="kobo.363.1">Mann-Whitney U test</span></em><span class="koboSpan" id="kobo.364.1">, to determine whether the distribution of input data has changed significantly </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">over time.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.366.1">Distribution metrics</span></strong><span class="koboSpan" id="kobo.367.1">: We can </span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.368.1">use distribution metrics, such as mean, standard deviation, quantiles, and other summary statistics, to compare training data and the new data in production. </span><span class="koboSpan" id="kobo.368.2">Significant differences in these metrics may indicate </span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">data drift.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.370.1">Visualization</span></strong><span class="koboSpan" id="kobo.371.1">: We can </span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.372.1">use visualization techniques such as histograms, boxplots, or scatter plots for the input features of the training data and the new data in production to help identify changes in the </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">data distributions.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.374.1">Feature importance</span></strong><span class="koboSpan" id="kobo.375.1">: We </span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.376.1">can monitor changes in feature importance values. </span><span class="koboSpan" id="kobo.376.2">If feature importance in the new data differs significantly from those in the training data, it may indicate </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">data drift.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.378.1">Distance metrics</span></strong><span class="koboSpan" id="kobo.379.1">: We can</span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.380.1"> measure the difference between the training data and the new data distributions using distance metrics such as </span><em class="italic"><span class="koboSpan" id="kobo.381.1">Kullback-Leibler divergence</span></em><span class="koboSpan" id="kobo.382.1"> or </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.383.1">Jensen-Shannon divergence</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.385.1">Model assertion is another technique, as you will learn next, that helps you in building and deploying reliable machine </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">learning m</span><a id="_idTextAnchor278"/><span class="koboSpan" id="kobo.387.1">odels.</span></span></p>
<h1 id="_idParaDest-173"><a id="_idTextAnchor279"/><span class="koboSpan" id="kobo.388.1">Model assertion</span></h1>
<p><span class="koboSpan" id="kobo.389.1">We can use</span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.390.1"> traditional programming assertion in machine learning modeling to ensure that the model is behaving as expected. </span><span class="koboSpan" id="kobo.390.2">Model assertions can help us detect issues early on, such as input data drift or other unexpected behaviors that might affect the model’s performance. </span><span class="koboSpan" id="kobo.390.3">We can consider model assertions as a set of rules that get checked during the model’s training, validation, or even during deployment to ensure that the model’s predictions meet the predefined conditions. </span><span class="koboSpan" id="kobo.390.4">Model assertions can help us in many ways, such as detecting issues with the model or input data, allowing us to address them before they impact the model’s performance. </span><span class="koboSpan" id="kobo.390.5">They can also help us maintain the model’s performance. </span><span class="koboSpan" id="kobo.390.6">Here are two examples of </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">model assertions:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.392.1">Input data assertions</span></strong><span class="koboSpan" id="kobo.393.1">: These</span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.394.1"> can check that the </span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.395.1">input features fall within an expected range or have the correct data type. </span><span class="koboSpan" id="kobo.395.2">For example, if a model predicts house prices based on the number of rooms, you might assert that the number of rooms is always a </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">positive integer.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.397.1">Output data assertions</span></strong><span class="koboSpan" id="kobo.398.1">: These</span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.399.1"> can check that the </span><a id="_idIndexMarker578"/><span class="koboSpan" id="kobo.400.1">model’s predictions meet certain conditions or constraints. </span><span class="koboSpan" id="kobo.400.2">For example, in a binary classification problem, you might assert that the predicted probability is between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">and 1.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.402.1">Let’s go through a </span><a id="_idIndexMarker579"/><span class="koboSpan" id="kobo.403.1">simple example of model assertion in Python. </span><span class="koboSpan" id="kobo.403.2">In this example, we will use a simple linear regression model from </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">scikit-learn</span></strong><span class="koboSpan" id="kobo.405.1"> to predict house prices based on the number of rooms, using a toy dataset. </span><span class="koboSpan" id="kobo.405.2">First, let’s create a toy dataset and train the linear </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">regression model:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.407.1">
import numpy as npfrom sklearn.linear_model import LinearRegression
# Toy dataset with number of rooms and corresponding house prices
X = np.array([1, 2, 3, 4, 5]).reshape(-1, 1)
y = np.array([100000, 150000, 200000, 250000, 300000])
# Train the linear regression model
model = LinearRegression()
model.fit(X, y)</span></pre>
<p><span class="koboSpan" id="kobo.408.1">Now, let’s define our model assertions so that they do </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">the following:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.410.1">Check that the input (number of rooms) is a </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">positive integer.</span></span></li>
<li><span class="koboSpan" id="kobo.412.1">Check that the predicted house price is within the </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">expected range.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.414.1">Here’s the code that does </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">these things:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.416.1">
def assert_input(input_data):    assert isinstance(input_data, int),
        "Input data must be an integer"
    assert input_data &gt; 0, "Number of rooms must be positive"
def assert_output(predicted_price, min_price, max_price):
    assert min_price &lt;= predicted_price &lt;= max_price,
        f"Predicted price should be between {min_price} and 
        {max_price}"</span></pre>
<p><span class="koboSpan" id="kobo.417.1">Now, we can</span><a id="_idIndexMarker580"/><span class="koboSpan" id="kobo.418.1"> use the defined model assertion functions, </span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.420.1">
# Test the assertions with example input and output datainput_data = 3
assert_input(input_data)
predicted_price = model.predict([[input_data]])[0]
assert_output(predicted_price, 50000, 350000)</span></pre>
<p><span class="koboSpan" id="kobo.421.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">assert_input</span></strong><span class="koboSpan" id="kobo.423.1"> function checks whether the input data (that is, the number of rooms) is an integer and is positive. </span><span class="koboSpan" id="kobo.423.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">assert_output</span></strong><span class="koboSpan" id="kobo.425.1"> function checks whether the predicted house price is within a specified range (for example, between 50,000 and 350,000 in this example). </span><span class="koboSpan" id="kobo.425.2">The previous code doesn’t give any </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">AssertionError</span></strong><span class="koboSpan" id="kobo.427.1"> assertion as it meets the criteria defined in the model assertion functions. </span><span class="koboSpan" id="kobo.427.2">Let’s say that, instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">3</span></strong><span class="koboSpan" id="kobo.429.1">, which is an integer, we use a string, </span><span class="No-Break"><span class="koboSpan" id="kobo.430.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.431.1">
input_data = '3'assert_input(input_data)</span></pre>
<p><span class="koboSpan" id="kobo.432.1">Here, we get the </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">following </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">AssertionError</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.436.1">
AssertionError: Input data must be an integer</span></pre> <p><span class="koboSpan" id="kobo.437.1">Let’s say we define the output range for </span><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">assert_output</span></strong><span class="koboSpan" id="kobo.439.1"> so that it’s between </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">50000</span></strong><span class="koboSpan" id="kobo.441.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">150000</span></strong><span class="koboSpan" id="kobo.443.1"> and use the model predictions for a house with </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">3</span></strong><span class="koboSpan" id="kobo.445.1"> bedrooms, </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.447.1">
input_data = 3predicted_price = model.predict([[input_data]])[0]
assert_output(predicted_price, 50000, 150000)</span></pre>
<p><span class="koboSpan" id="kobo.448.1">We will get the </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">following </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">AssertionError</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.452.1">
AssertionError: Predicted price should be between 50000 and 150000</span></pre> <p><span class="koboSpan" id="kobo.453.1">Model assertion</span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.454.1"> is another technique, side by side with model monitoring, that helps ensure the reliability of </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">our models.</span></span></p>
<p><span class="koboSpan" id="kobo.456.1">With this, we have come to the end of</span><a id="_idTextAnchor280"/> <span class="No-Break"><span class="koboSpan" id="kobo.457.1">this chapter.</span></span></p>
<h1 id="_idParaDest-174"><a id="_idTextAnchor281"/><span class="koboSpan" id="kobo.458.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.459.1">In this chapter, you learned about important concepts for test-driven development, including infrastructure and integration testing. </span><span class="koboSpan" id="kobo.459.2">You learned about the available tools and libraries to implement these two types of testing. </span><span class="koboSpan" id="kobo.459.3">We also went through examples in which you learned how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">pytest</span></strong><span class="koboSpan" id="kobo.461.1"> library for both infrastructure and integration testing. </span><span class="koboSpan" id="kobo.461.2">You also learned about model monitoring and model assertion as two other important topics for assessing the behavior of our models before and in production. </span><span class="koboSpan" id="kobo.461.3">These techniques and tools help you in designing strategies so that you have a successful deployment and reliable models in </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">production environments.</span></span></p>
<p><span class="koboSpan" id="kobo.463.1">In the next chapter, you will learn about reproducibility, an important concept in proper machine learning modeling, and how you can use data and model versioning to </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">achieve re</span><a id="_idTextAnchor282"/><span class="koboSpan" id="kobo.465.1">producibility.</span></span></p>
<h1 id="_idParaDest-175"><a id="_idTextAnchor283"/><span class="koboSpan" id="kobo.466.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.467.1">Can you explain the difference between data and </span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">concept drifts?</span></span></li>
<li><span class="koboSpan" id="kobo.469.1">How can model assertions help you in developing reliable machine </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">learning models?</span></span></li>
<li><span class="koboSpan" id="kobo.471.1">What are some examples of components of </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">integration testing?</span></span></li>
<li><span class="koboSpan" id="kobo.473.1">How can we use Chef, Puppet</span><a id="_idTextAnchor284"/><span class="koboSpan" id="kobo.474.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">and Ansible?</span></span></li>
</ol>
<h1 id="_idParaDest-176"><a id="_idTextAnchor285"/><span class="koboSpan" id="kobo.476.1">References</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.477.1">Kang, Daniel, et al. </span><em class="italic"><span class="koboSpan" id="kobo.478.1">Model assertions for monitoring and improving ML models</span></em><span class="koboSpan" id="kobo.479.1">. </span><span class="koboSpan" id="kobo.479.2">Proceedings of Machine Learning and Systems 2 (</span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">2020): 481-496.</span></span></li>
</ul>
</div>
</body></html>