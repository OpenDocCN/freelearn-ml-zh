<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Setting Up OpenCV for Java</h1></div></div></div><p>I'm sure you want to start developing astonishing computer vision applications. You must have heard of a nice C/C++ computer vision library called OpenCV to help you do so. But in case you would like to develop the applications using your knowledge of Java programming, we have good news for you. Since the release of OpenCV 2.4.4 in January 2013, Java bindings have been officially developed. So you can use them not only for desktop Java, but also for Scala development.</p><p>This chapter will set you up for OpenCV development right away. As Java developers are mostly used to working with tools such as <strong>Eclipse</strong>, <strong>NetBeans</strong>, <strong>Apache</strong> <strong>Ant</strong>, and <strong>Maven</strong>, we will cover the details of creating a simple OpenCV application using the environment that the Java developers are more used to.</p><p>In this chapter, we will do the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Get OpenCV with desktop Java support</li><li class="listitem" style="list-style-type: disc">Discuss <strong>Java Native Interface</strong> (<strong>JNI</strong>) details</li><li class="listitem" style="list-style-type: disc">Configure Eclipse and NetBeans for OpenCV</li><li class="listitem" style="list-style-type: disc">Create Apache Ant and Maven OpenCV projects</li></ul></div><p>By the end of this chapter, the user should have an OpenCV for Java installation running on his OS which can easily be linked to Eclipse, NetBeans, Apache Ant, or Maven, the most used tools and building systems for Java.</p><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Getting OpenCV for Java development</h1></div></div></div><p>The first <a id="id0" class="indexterm"/>thing to notice when working with OpenCV <a id="id1" class="indexterm"/>for Java development is that OpenCV is a C++ library that should be compiled with operating system- specific compilers. The native code that would be generated is platform-dependent. So, the native Linux code won't run in Windows, neither will the Android native code run in OSX. This sounds very different from the bytecode generated for Java, which is executed by an interpreter in any platform. In <a id="id2" class="indexterm"/>order to get the native code running in a <strong>Java Virtual Machine</strong> (<strong>JVM</strong>), one needs the so called <strong>Java Native Interface</strong> (<strong>JNI</strong>). This way, the native code will be required for each platform that your application is <a id="id3" class="indexterm"/>going to be run on.</p><p>It is important to understand that JNI is a native programming interface. It allows the  Java code that runs inside a JVM to interoperate with the applications and libraries written in programming languages such as C, C++, and assembly. Since it bridges the gap between Java and other languages, it needs to convert datatypes from these languages, as well as to create some boilerplate code. Curious readers should refer to the <code class="literal">gen_java.py</code> script, located in the <code class="literal">modules/java/generator</code> folder, which automates most of this work. Lucky Windows users get compiled binaries, which means source C++ OpenCV code, compiled with <a id="id4" class="indexterm"/>Windows compilers into native code that <a id="id5" class="indexterm"/>runs only on Windows, from OpenCV packages. Users from other operating systems will need to build binaries from the source code, although one can make that in Windows as well. In order to download compiled binaries, we should get version 2.4.4 or higher of the OpenCV Windows package <a id="id6" class="indexterm"/>from the OpenCV SourceForge repository, which is located at <a class="ulink" href="http://sourceforge.net/projects/opencvlibrary/files/">http://sourceforge.net/projects/opencvlibrary/files/</a>.</p><div><div><h3 class="title"><a id="note02"/>Note</h3><p>Notice that the prebuilt files needed for Java development are located at <code class="literal">opencv/build/java/</code>. For instance, if you are working with version 3.0.0 OpenCV, you should see files containing the Java interface in <code class="literal">opencv-300.jar</code> and in the x86 and x64 native dynamic libraries, which contains the Java bindings in <code class="literal">x86/opencv_java300.dll</code> and <code class="literal">x64/opencv_java300.dll</code>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Building OpenCV from the source code</h1></div></div></div><p>In this section, we <a id="id7" class="indexterm"/>are mostly interested in generating all the OpenCV Java class files contained in a JAR file as well as the native dynamic library for Java OpenCV. This is a self-contained library that works with JNI and is required to run a Java OpenCV application.</p><p>In case you are working with Linux or OSX, or if you want to build from the source in Windows, then to get the latest features committed in OpenCV, you should use the source code. You <a id="id8" class="indexterm"/>can visit the OpenCV download page at <a class="ulink" href="http://opencv.org/downloads.html">http://opencv.org/downloads.html</a> and choose the appropriate link for your distribution.</p><p>Another way to get the source code is by using the <code class="literal">git</code> tool. Appropriate instructions for installing it can be found at <a class="ulink" href="http://git-scm.com/downloads">http://git-scm.com/downloads</a>. When using <code class="literal">git</code>, use the following commands:</p><div><pre class="programlisting">
<strong>git clone git://github.com/Itseez/opencv.git</strong>
<strong>cd opencv</strong>
<strong>git checkout 3.0.0-rc1</strong>
<strong>mkdir build</strong>
<strong>cd build</strong>
</pre></div><p>These commands will access the OpenCV developers' repository and download the most updated code from <code class="literal">branch 3.0.0-rc1</code>, which is the release candidate for version 3.0.0.</p><p>In either method of obtaining the source code, you will need building tools in order to make binaries. The <a id="id9" class="indexterm"/>required packages are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>CMake 2.6 or higher</strong>: This is a cross-platform and an open source building system. You <a id="id10" class="indexterm"/>can download it from <a class="ulink" href="http://www.cmake.org/cmake/resources/software.html">http://www.cmake.org/cmake/resources/software.html</a>.</li><li class="listitem" style="list-style-type: disc"><strong>Python 2.6 or later with python-dev and python-numpy</strong>: This is the Python language <a id="id11" class="indexterm"/>that is used to run Java building scripts. You can download Python from <a class="ulink" href="http://www.python.org/getit/">http://www.python.org/getit/</a> and download the packages from <a class="ulink" href="http://sourceforge.net/projects/numpy/files/NumPy">http://sourceforge.net/projects/numpy/files/NumPy</a>.</li><li class="listitem" style="list-style-type: disc"><strong>C/C++ compilers</strong>: These compilers are required to generate the native code. In Windows, you <a id="id12" class="indexterm"/>can install Microsoft Visual Studio Community or Express, which are free, from <a class="ulink" href="http://www.visualstudio.com/downloads/">http://www.visualstudio.com/downloads/</a>. Also, these compilers work with the Visual Studio Professional edition and the versions above 2010 should work fine. You can also make it work with MinGW, which can be downloaded from <a class="ulink" href="http://sourceforge.net/projects/mingw/files/Installer/">http://sourceforge.net/projects/mingw/files/Installer/</a>. In Linux, you are <a id="id13" class="indexterm"/>advised to use the <strong>Gnu C Compiler</strong> (<strong>GCC</strong>) with a simple <code class="literal">sudo apt-get install build-essential</code> command in Ubuntu or Debian, for instance. In case you work with the Mac, you should use XCode.</li><li class="listitem" style="list-style-type: disc"><strong>Java Developer Kit (JDK)</strong>: JDK is required to generate the JAR files, which will be required for <a id="id14" class="indexterm"/>every Java OpenCV program. Recommended versions begin from Oracle, JDK 6, 7, or 8, which can be downloaded from <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/downloads/index-jsp-138363.html">http://www.oracle.com/technetwork/java/javase/downloads/index-jsp-138363.html</a>. Please follow the operating system-specific instructions in the link in order to install it.</li><li class="listitem" style="list-style-type: disc"><strong>Apache Ant</strong>: This <a id="id15" class="indexterm"/>is a pure Java build tool. Look for binary distributions at <a class="ulink" href="http://ant.apache.org/bindownload.cgi">http://ant.apache.org/bindownload.cgi</a>. Make sure you set the <code class="literal">ANT_HOME</code> variable correctly as pointed out in the installation instructions at <a class="ulink" href="http://ant.apache.org/manual/index.html">http://ant.apache.org/manual/index.html</a>.</li></ul></div><p>In order to install these software in a Linux distribution such as Ubuntu or Debian, the user should issue the following command:</p><div><pre class="programlisting">
<strong>sudo apt-get install build-essential cmake git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev ant</strong>
</pre></div><p>Once you have installed all these packages, you will be ready to build the library. Make sure you are in the <code class="literal">build</code> directory, as you should be, if you have followed the preceding Git instructions. In case you downloaded the source file from OpenCV downloads, the parent folder of your build should have <code class="literal">CMakeLists.txt</code> as well as the <code class="literal">3rdparty</code>, <code class="literal">apps</code>, <code class="literal">cmake</code>, <code class="literal">data</code>, <code class="literal">doc</code>, <code class="literal">include</code>, <code class="literal">modules</code>, <code class="literal">platforms</code>, <code class="literal">samples</code>, and <code class="literal">test</code> folders.</p><p>CMake is a build tool and it will generate your compiler-specific solution files. You should then use your compiler to generate the binary files. Make sure you are in the <code class="literal">build</code> directory, as this should follow the last <code class="literal">cd build</code> command. If you are using Linux, run the <a id="id16" class="indexterm"/>following commands:</p><div><pre class="programlisting">
<strong>cmake -DBUILD_SHARED_LIBS=OFF</strong>
</pre></div><p>If you are using Windows, run the following command:</p><div><pre class="programlisting">
<strong>cmake -DBUILD_SHARED_LIBS=OFF -G "Visual Studio 10"</strong>
</pre></div><p>Notice that it is important to use the <code class="literal">DBUILD_SHARED_LIBS=OFF</code> flag, because it will instruct CMake to build OpenCV on a set of static libraries. This way, it will compile a single dynamic link library for Java without dependencies on other libraries. This makes it easier to deploy your Java projects.</p><div><div><h3 class="title"><a id="note03"/>Note</h3><p>If you are using other compilers in Windows, type <code class="literal">cmake –help</code> and it will show all the generators available.</p></div></div><p>In case you want to use MinGW makefiles, just change the CMake command to the following command:</p><div><pre class="programlisting">
<strong>cmake -DBUILD_SHARED_LIBS=OFF -G "MinGW Makefiles"</strong>
</pre></div><p>One of the key points to watch for when generating project files through CMake is that <code class="literal">java</code> is one of the modules that is going to be built. You should see a screen as shown in the following screenshot:</p><div><img src="img/3972OS_01_01.jpg" alt="Building OpenCV from the source code"/></div><p>In case you can't see <code class="literal">java</code> as one of the to-be-built modules, like in the following screenshot, you should look for a couple of things, such as whether Ant is correctly configured. Also make sure that you have set the <code class="literal">ANT_HOME</code> environment variable and that Python is correctly configured. Check if NumPy is installed by simply typing <code class="literal">numpy import *</code> in a <a id="id17" class="indexterm"/>Python shell and check for any errors:</p><div><img src="img/3972OS_01_02.jpg" alt="Building OpenCV from the source code"/></div><p>In case you are in doubt about the Python and Java installations, slide down to check their configurations. They should be similar to the next screenshot:</p><div><img src="img/3972OS_01_03.jpg" alt="Building OpenCV from the source code"/></div><p>Once everything has been correctly configured, it is time to start compiling the sources. In order to do so in Windows, type the following:</p><div><pre class="programlisting">
<strong>msbuild /m OpenCV.sln /t:Build /p:Configuration=Release /v:m</strong>
</pre></div><p>Notice that you might get an error saying, <code class="literal">'msbuild' is not recognized as an internal or external command, operable program or batch file</code>. This occurs when you haven't set the <code class="literal">msbuild</code> path. In order to set it right, open Visual Studio and in the <strong>Tools</strong> menu, click <strong>Visual Studio Command Prompt</strong>. This will yield a fully working command prompt with access to <code class="literal">msbuild</code>. Refer to the following screenshot for clearer directions:</p><div><img src="img/3972OS_01_04.jpg" alt="Building OpenCV from the source code"/></div><p>In case you are using newer Visual Studio versions, press the Windows key and type <strong>VS2012 Command </strong><a id="id18" class="indexterm"/>
<strong>Prompt</strong>. This should set up your environment variables.</p><p>In order to start building in Linux, simply type the following command:</p><div><pre class="programlisting">
<strong>make -j8</strong>
</pre></div><p>The preceding command will compile the OpenCV library with Java support. Notice that the <code class="literal">-j8</code> flag tells <code class="literal">make</code> to run in parallel with eight job threads, which makes the build theoretically faster.</p><div><div><h3 class="title"><a id="tip02"/>Tip</h3><p><strong>Downloading the example code</strong></p><p>You can download the example code files from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><p>The entire process will last for some minutes before generating a JAR file that contains the Java interfaces, which is located at <code class="literal">bin/opencv-300.jar</code>. The native dynamic link library containing Java bindings is generated at <code class="literal">lib/libopencv_java300.so</code> or <code class="literal">bin/Release/opencv_java300.dll</code>, depending on your operating system. These files will be used when we create our first OpenCV application.</p><div><div><h3 class="title"><a id="note04"/>Note</h3><p>For more details <a id="id19" class="indexterm"/>on how to compile OpenCV for your platform, look for <a class="ulink" href="http://docs.opencv.org/doc/tutorials/introduction/table_of_content_introduction/table_of_content_introduction.html">http://docs.opencv.org/doc/tutorials/introduction/table_of_content_introduction/table_of_content_introduction.html</a>.</p></div></div><p>Congratulations! You are now halfway to becoming a great developer using OpenCV!</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>The Java OpenCV project in Eclipse</h1></div></div></div><p>Using <a id="id20" class="indexterm"/>OpenCV in any IDE is pretty simple. It is as simple as <a id="id21" class="indexterm"/>adding OpenCV JAR, that is, <code class="literal">opencv-300.jar</code> to your classpath. But, as it relies on the native code, you need to point out the dynamic link libraries—<code class="literal">so</code> for Linux, <code class="literal">.dll</code> for Windows, and <code class="literal">dylib</code> for MacOsX.</p><div><ol class="orderedlist arabic"><li class="listitem">In Eclipse, go to <strong>File</strong> | <strong>New</strong> | <strong>Java Project</strong>.<div><img src="img/3972OS_01_05.jpg" alt="The Java OpenCV project in Eclipse"/></div></li><li class="listitem">Give the new project a descriptive <a id="id22" class="indexterm"/>name, such as <code class="literal">SimpleSample</code>. Select the project in the <strong>Package Explorer</strong>, go to the <strong>Project</strong> menu and click on <strong>Properties</strong>. On the <strong>Java Build Path</strong> tab, go to the <strong>Libraries</strong> <a id="id23" class="indexterm"/>tab, and click on the <strong>Add Library…</strong> button on the right-hand side, as shown in the following screenshot:<div><img src="img/3972OS_01_06.jpg" alt="The Java OpenCV project in Eclipse"/></div></li><li class="listitem">Select <strong>User Library</strong> in the <strong>Add Library</strong> dialog, and then click <strong>Next</strong>.</li><li class="listitem">Now, click on the <strong>User Libraries…</strong> button.</li><li class="listitem">Click on <strong>New…</strong>. Name your library appropriately, for example, <code class="literal">opencv-3.0.0</code>. It's time to reference the JAR files.</li><li class="listitem">Click on <strong>Add JARs…</strong>.</li><li class="listitem">Select the <a id="id24" class="indexterm"/><code class="literal">opencv-300.jar</code> file in your filesystem; it should be in the <code class="literal">opencv\build\java</code> folder. Then, point to the native library <a id="id25" class="indexterm"/>location expanding your JAR as in the following screenshot:<div><img src="img/3972OS_01_07.jpg" alt="The Java OpenCV project in Eclipse"/></div></li><li class="listitem">Now, select <a id="id26" class="indexterm"/><strong>Native library location</strong> by <a id="id27" class="indexterm"/>clicking on the <strong>Edit…</strong> button on the right-hand side of the window and set your native libraries' location folder, for example, <code class="literal">opencv\build\java\x64\</code>.</li><li class="listitem">Now that OpenCV is properly configured, just select it in your <strong>Add library</strong> dialog by pressing <strong>Finish</strong>.</li></ol></div><p>Notice that your project now points to the OpenCV JAR. You can also browse the main classes from the <strong>Package Explorer</strong>, as seen in the following screenshot:</p><div><img src="img/3972OS_01_08.jpg" alt="The Java OpenCV project in Eclipse"/></div><p>After the The <a id="id28" class="indexterm"/>
<em>NetBeans configuration</em> section, a source code to <a id="id29" class="indexterm"/>create a simple OpenCV application can be found.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec11"/>The NetBeans configuration</h1></div></div></div><p>In case you are more <a id="id30" class="indexterm"/>comfortable working with NetBeans, the configuration process is pretty much like Eclipse:</p><div><ol class="orderedlist arabic"><li class="listitem">Select <strong>File</strong> | <strong>New Project...</strong>. On the <strong>Projects</strong> tab, select <strong>Java Application</strong> and click on <strong>Next</strong>. Give the new project an appropriate name and click on <strong>Finish</strong>.<div><img src="img/3972OS_01_09.jpg" alt="The NetBeans configuration"/></div></li><li class="listitem">Now, right-click on your <strong>Libraries</strong> folder and click on <strong>Add Library...</strong>, as shown <a id="id31" class="indexterm"/>in the following screenshot:<div><img src="img/3972OS_01_10.jpg" alt="The NetBeans configuration"/></div></li><li class="listitem">As we haven't <a id="id32" class="indexterm"/>gone through this process before, a library for OpenCV won't exist. Click on the <strong>Create...</strong> button on the right-hand side of the pane. It will open a dialog asking for the library name—name it as <code class="literal">OpenCV</code>—and the <strong>Library type</strong>, for which you should leave the default option <strong>Class Libraries</strong>. In the next screen, on the <strong>Classpath</strong> tab, click <strong>Add JAR/Folder...</strong> like in the next screenshot:<div><img src="img/3972OS_01_11.jpg" alt="The NetBeans configuration"/></div></li><li class="listitem">Now point to your library, which is where the <code class="literal">opencv-300.jar</code> file is present—usually in <code class="literal">opencv/build/java/</code>. As your library is properly configured, select it in the <strong>Add Library</strong> dialog.</li><li class="listitem">The last detail to provide is the path for the libraries' native files. Right-click on your project <a id="id33" class="indexterm"/>name in the <strong>Projects</strong> tab and select<strong> Properties</strong>. Go to the <strong>Run</strong> item on the tree and under <strong>VM Options</strong>, set the library path by typing <code class="literal">-Djava.library.path=C:\Users\baggio\Downloads\opencv\build\java\x64</code> in the text box.<div><img src="img/3972OS_01_12.jpg" alt="The NetBeans configuration"/></div></li></ol></div><p>Make sure you change the given path to the one where your OpenCV installation is, and that it points to the folder <a id="id34" class="indexterm"/>where the native libraries are, that is, <code class="literal">opencv_java300.dll</code> in Windows, or <code class="literal">libopencv_java300.so</code> in Linux. Now, add the <code class="literal">SimpleSample</code> class code in your project, as pointed. Run the sample and make sure that you don't get any errors.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec12"/>A Java OpenCV simple application</h1></div></div></div><p>It's time to <a id="id35" class="indexterm"/>create a simple application that will show that we can now compile and execute Java code with OpenCV. Create a new Java class containing a <code class="literal">Main</code> method and paste the code given as follows. It simply creates a 5 x 10 OpenCV matrix, sets some of its rows and columns, and prints the result to the standard output.</p><p>Make sure you load the correct dynamic link libraries through a call to <code class="literal">System.loadlibrary("opencv_java300")</code>. Since, you might want to change the library version later, a better approach would be to use the <code class="literal">Core.NATIVE_LIBARAY_NAME</code> constant, which will output the correct library name. You can also find this file in the code repository for <code class="literal">chapter1</code> of this book, under <code class="literal">ant/src</code>.</p><div><pre class="programlisting">import org.opencv.core.Core;
import org.opencv.core.Mat;
import org.opencv.core.CvType;
import org.opencv.core.Scalar;

class SimpleSample {

  static{ System.loadLibrary(Core.NATIVE_LIBRARY_NAME); }

  public static void main(String[] args) {
    System.out.println("Welcome to OpenCV " + Core.VERSION);
    Mat m = new Mat(5, 10, CvType.CV_8UC1, new Scalar(0));
    System.out.println("OpenCV Mat: " + m);
    Mat mr1 = m.row(1);
    mr1.setTo(new Scalar(1));
    Mat mc5 = m.col(5);
    mc5.setTo(new Scalar(5));
    System.out.println("OpenCV Mat data:\n" + m.dump());
  }

}</pre></div><p>According to Oracle's documentation, it states that, <em>class can have any number of static initialization blocks. And they can appear anywhere in the class body. The runtime system guarantees that static initialization blocks are called in the order that they appear in the source code</em>.</p><p>You should make sure that any calls to the OpenCV library are preceded by a single <code class="literal">System.loadLibrary</code> call, in order to load the dynamic libraries. Otherwise, you will receive an <code class="literal">java.lang.UnsatisfiedLinkError: org.opencv.core.Mat.n_Mat(IIIDDDD)J</code> error. This generally occurs in a static block.</p><p>If everything goes <a id="id36" class="indexterm"/>well, you should see the following output in the console:</p><div><pre class="programlisting">
<strong>Welcome to OpenCV 3.0.0-rc1</strong>
<strong>OpenCV Mat: Mat [ 5*10*CV_8UC1, isCont=true, isSubmat=false, nativeObj=0x2291b70, dataAddr=0x229bbd0 ]</strong>
<strong>OpenCV Mat data:</strong>
<strong>[ 0, 0, 0, 0, 0, 5, 0, 0, 0, 0;</strong>
<strong>  1, 1, 1, 1, 1, 5, 1, 1, 1, 1;</strong>
<strong>  0, 0, 0, 0, 0, 5, 0, 0, 0, 0;</strong>
<strong>  0, 0, 0, 0, 0, 5, 0, 0, 0, 0;</strong>
<strong>  0, 0, 0, 0, 0, 5, 0, 0, 0, 0]</strong>
</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Building your project with Ant</h1></div></div></div><p>If you want to <a id="id37" class="indexterm"/>rely on Apache Ant for building instead of using an <a id="id38" class="indexterm"/>IDE, a <code class="literal">build.xml</code> file is provided in the OpenCV samples. You can find this file in this chapter's repository as well. The following are its contents:</p><div><pre class="programlisting">&lt;project name="SimpleSample" basedir="." default="rebuild-run"&gt;
    &lt;property name="src.dir"     value="src"/&gt;
    &lt;property name="lib.dir"     value="${ocvJarDir}"/&gt;
    &lt;path id="classpath"&gt;
        &lt;fileset dir="${lib.dir}" includes="**/*.jar"/&gt;
    &lt;/path&gt;
    &lt;property name="build.dir"   value="build"/&gt;
    &lt;property name="classes.dir" value="${build.dir}/classes"/&gt;
    &lt;property name="jar.dir"     value="${build.dir}/jar"/&gt;
    &lt;property name="main-class"  value="${ant.project.name}"/&gt;

    &lt;target name="clean"&gt;
        &lt;delete dir="${build.dir}"/&gt;
    &lt;/target&gt;

    &lt;target name="compile"&gt;
        &lt;mkdir dir="${classes.dir}"/&gt;
        &lt;javac includeantruntime="false" srcdir="${src.dir}" destdir="${classes.dir}" classpathref="classpath"/&gt;
    &lt;/target&gt;

    &lt;target name="jar" depends="compile"&gt;
        &lt;mkdir dir="${jar.dir}"/&gt;
        &lt;jar destfile="${jar.dir}/${ant.project.name}.jar" basedir="${classes.dir}"&gt;
            &lt;manifest&gt;
                &lt;attribute name="Main-Class" value="${main-class}"/&gt;
            &lt;/manifest&gt;
        &lt;/jar&gt;
    &lt;/target&gt;

    &lt;target name="run" depends="jar"&gt;
        &lt;java fork="true" classname="${main-class}"&gt;
            &lt;sysproperty key="java.library.path" path="${ocvLibDir}"/&gt;
            &lt;classpath&gt;
                &lt;path refid="classpath"/&gt;
                &lt;path location="${jar.dir}/${ant.project.name}.jar"/&gt;
            &lt;/classpath&gt;
        &lt;/java&gt;
    &lt;/target&gt;

    &lt;target name="rebuild" depends="clean,jar"/&gt;

    &lt;target name="rebuild-run" depends="clean,run"/&gt;

&lt;/project&gt;</pre></div><p>This is a basic <code class="literal">build.xml</code> Ant file that defines tasks such as cleaning, compiling, and packing a <code class="literal">.jar</code> file, running, rebuilding, and rebuild-running. It expects your source code to be in a sibling <a id="id39" class="indexterm"/>folder called <code class="literal">src</code>. Make sure that the <code class="literal">SimpleSample.java</code> source code provided earlier is inside this directory.</p><p>Compiling and <a id="id40" class="indexterm"/>running the project using Ant is easy. Simply type the following:</p><div><pre class="programlisting">
<strong>ant -DocvJarDir=path/to/dir/containing/opencv-300.jar -DocvLibDir=path/to/dir/containing/opencv_java300/native/library</strong>
</pre></div><p>In case you have downloaded and extracted pre-built binaries, use the following command instead:</p><div><pre class="programlisting">
<strong>ant -DocvJarDir=X:\opencv3.0.0\opencv\build\java -DocvLibDir=X:\opencv3.00\opencv\build\java\x64</strong>
</pre></div><p>A successful run of Ant <code class="literal">build.xml</code> will look like the following screenshot:</p><div><img src="img/3972OS_01_13.jpg" alt="Building your project with Ant"/></div><p>The provided <code class="literal">build.xml</code> file can be reused for building your Java OpenCV applications. In order to use it, make sure that the project name matches your main class name. If your main class is inside the <code class="literal">package com.your.company</code>, and it's called <code class="literal">MainOpenCV</code>, you should change the <a id="id41" class="indexterm"/>first line of <code class="literal">build.xml</code> from <code class="literal">&lt;project name="SimpleSample" basedir="." default="rebuild-run"&gt;</code> to <code class="literal">&lt;project name="com.your.company.MainOpenCV" basedir="." default="rebuild-run"&gt;</code>.</p><p>You can also <a id="id42" class="indexterm"/>hardcode the <code class="literal">ocvJarDir</code> and <code class="literal">ocvLibDir</code> properties so you won't have to type them while invoking Ant. For <code class="literal">ocvJarDir</code>, simply change the <code class="literal">&lt;property name="lib.dir"     value="${ocvJarDir}"/&gt;</code> command to <code class="literal">&lt;property name="lib.dir"     value="X:\opencv2.47\opencv\build\java"/&gt;</code>.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec14"/>The Java OpenCV Maven configuration</h1></div></div></div><p>Apache Maven <a id="id43" class="indexterm"/>is a more complex build automation tool, primarily used for Java projects. It describes not only how software is built, but also how it depends on other libraries. Its projects are configured through a <strong>Project Object Model</strong>, named <code class="literal">pom.xml</code>. Maven dependencies are usually located in Maven 2 <a id="id44" class="indexterm"/>Central Repository. In case they aren't found there, you will need to add other repositories. You can also create a local repository and add your own dependencies there. At the time of writing this book, there were no public dependencies for Java OpenCV. So we will cover not only the process of installing the Java OpenCV Maven dependencies in a local repository but also how to use this book's Maven repository for the Windows builds of OpenCV 3.0.0 version. In case OpenCV developers host public Maven repositories, minor changes will be required. You will only need to find out the official OpenCV JAR <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and <code class="literal">version</code> and put them in your <code class="literal">pom.xml</code>.</p><p>In order to make your <a id="id45" class="indexterm"/>project dependent on any library, you only need to provide three fields in your <code class="literal">pom.xml</code>. They are <code class="literal">groupId</code>, <code class="literal">artifactId</code>, and <code class="literal">version</code>. The recommended way to make your project depend on libraries that are not hosted in the Central Maven Repository, is to install them using a simple command, like <code class="literal">mvn install:install-file -Dfile=non-maven-proj.jar -DgroupId=some.group -DartifactId=non-maven-proj -Dversion=1 -Dpackaging=jar</code>.</p><p>We will show you how to use the Packt repository for window builds in the next section and then we will give you the details on how to install them on your local repository, in case you need it.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Creating a Windows Java OpenCV Maven project pointing to the Packt repository</h2></div></div></div><p>This <a id="id46" class="indexterm"/>section shows how to create a basic Maven project and how to customize it so that it adds OpenCV <a id="id47" class="indexterm"/>dependencies. Besides this, it will generate an Eclipse project so that the readers can easily generate a project in Windows. A major advantage here is that there is no need to build or download the OpenCV library manually.</p><p>Although the Maven learning curve might be a little tougher than straightaway creating your project in your favorite IDE, it pays off in the long term span. The best part of using Maven is that you won't need to install OpenCV at all since all dependencies, including native files, are automatically downloaded. We'll show you how to do it in the following simple steps:</p><div><ol class="orderedlist arabic"><li class="listitem"><strong>Build a project from an archetype</strong>: Create an empty folder for your project. Let's name it as <code class="literal">D:\mvnopencv</code>. In that folder, type the following command:<div><pre class="programlisting">
<strong>mvn archetype:generate -DgroupId=com.mycompany.app -DartifactId=my-opencv-app -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</strong>
</pre></div><p>Let's break it down into parts. The <code class="literal">mvn archetype:generate</code> command tells Maven to run the <code class="literal">generate goal</code> command from the archetype plugin. From the documentation, we see that <code class="literal">generate goal</code> creates a Maven project from an archetype; it asks the user to choose an archetype from the archetype catalog, and retrieves it from the remote repository. Once retrieved, it is processed to create a working Maven project. This way, we deduce that the <code class="literal">-DarchetypeArtifactId=maven-archetype-quickstart</code> parameter is the selected archetype. This will generate a Java project with the following structure:</p><div><pre class="programlisting">my-opencv-app
|-- pom.xml
`-- src
    |-- main
    |   `-- java
    |       `-- com
    |           `-- company
    |               `-- app
    |                   `-- App.java
    `-- test
        `-- java
            `-- com
                `-- company
                    `-- app
                        `-- AppTest.java</pre></div><div><div><h3 class="title"><a id="note05"/>Note</h3><p>Note that the <code class="literal">-DgroupId=com.mycompany.app -DartifactId=my-opencv-app</code> properties will fill <code class="literal">pom.xml</code> and provide a part of the project tree.</p></div></div></li><li class="listitem"><strong>Add </strong><a id="id48" class="indexterm"/><strong>OpenCV dependencies</strong>: Since this is a project generated from a general Maven archetype, we should customize it so that it will <a id="id49" class="indexterm"/>look like a Java OpenCV project. In order to do that, we will need to add our dependencies. Open the generated <code class="literal">pom.xml</code> file in <code class="literal">D:\mvnopencv\my-opencv-app</code>. We should first add the Java OpenCV dependencies. Since they don't exist in the Maven central repository at the time of writing this book, you will also need to point to an online repository. We have provided native files for Windows x86 and Windows 64-bits. In order to add the Packt Maven repository, simply add the following lines to your <code class="literal">pom.xml</code> file:<div><pre class="programlisting">&lt;project  
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;  
  
  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;javaopencvbook&lt;/id&gt;
      &lt;url&gt;https://raw.github.com/JavaOpenCVBook/code/maven2/&lt;/url&gt;
    &lt;/repository&gt;
 &lt;/repositories&gt;

 &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
…
&lt;/project&gt;</pre></div><p>Now, also add the OpenCV dependencies. In order to compile your code, you will only need to add the OpenCV JAR dependency. In case you also want to execute it, you will need the Windows natives as well. These <a id="id50" class="indexterm"/>have been packed inside <code class="literal">opencvjar-runtime-3.0.0-natives-windows-x86.jar</code> for 32-bit architectures. For <a id="id51" class="indexterm"/>64-bit architectures, these are packed inside <code class="literal">opencvjar-runtime-3.0.0-natives-windows-x86_64.jar</code>. Near the <code class="literal">junit</code> dependencies, add the following:</p><div><pre class="programlisting">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;junit&lt;/groupId&gt;
    &lt;artifactId&gt;junit&lt;/artifactId&gt;
    &lt;version&gt;3.8.1&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.javaopencvbook&lt;/groupId&gt;
    &lt;artifactId&gt;opencvjar&lt;/artifactId&gt;
    &lt;version&gt;3.0.0&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.javaopencvbook&lt;/groupId&gt;
    &lt;artifactId&gt;opencvjar-runtime&lt;/artifactId&gt;
    &lt;version&gt;3.0.0&lt;/version&gt;
    &lt;classifier&gt;natives-windows-x86_64&lt;/classifier&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</pre></div><p>Notice the classifier property set to opencvjar-runtime. It is set to <code class="literal">natives-windows-x86_64</code>. This is the value you should use for a 64-bit platform. In case you want it for a 32-bit platform, just use <code class="literal">natives-windows-x86</code>.</p></li><li class="listitem"><strong>Configure build plugins</strong>: The <code class="literal">opencvjar-runtime</code> dependencies only include files such as <code class="literal">.dll</code>, <code class="literal">.so</code>, and so on. These files will be extracted to your target while executing the <code class="literal">mvn package</code> command. But, this will only happen <a id="id52" class="indexterm"/>if you add <code class="literal">maven-nativedependencies-plugin</code>. Besides, it is also important that you copy all the JAR libraries to your <code class="literal">/lib</code> folder <a id="id53" class="indexterm"/>when creating your distributable JAR. This will be dealt with by the <code class="literal">maven-dependency-plugin</code>. The last detail is to point your main class when creating a JAR, which is performed by <code class="literal">maven-jar-plugin</code>. All the build plugin configurations should be added as follows:<div><pre class="programlisting">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
      &lt;version&gt;2.4&lt;/version&gt;
      &lt;configuration&gt;
        &lt;archive&gt;
          &lt;manifest&gt;
            &lt;addClasspath&gt;true&lt;/addClasspath&gt;
            &lt;classpathPrefix&gt;lib/&lt;/classpathPrefix&gt;
            &lt;mainClass&gt;com.mycompany.app.App&lt;/mainClass&gt;
          &lt;/manifest&gt;
        &lt;/archive&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
      &lt;version&gt;2.1&lt;/version&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;id&gt;copy-dependencies&lt;/id&gt;
          &lt;phase&gt;package&lt;/phase&gt;
          &lt;goals&gt;
            &lt;goal&gt;copy-dependencies&lt;/goal&gt;
          &lt;/goals&gt;
          &lt;configuration&gt;
            &lt;outputDirectory&gt;${project.build.directory}/lib&lt;/outputDirectory&gt;
            &lt;overWriteReleases&gt;false&lt;/overWriteReleases&gt;
            &lt;overWriteSnapshots&gt;false&lt;/overWriteSnapshots&gt;
            &lt;overWriteIfNewer&gt;true&lt;/overWriteIfNewer&gt;
          &lt;/configuration&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;com.googlecode.mavennatives&lt;/groupId&gt;
      &lt;artifactId&gt;maven-nativedependencies-plugin&lt;/artifactId&gt;
      &lt;version&gt;0.0.7&lt;/version&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;id&gt;unpacknatives&lt;/id&gt;
          &lt;phase&gt;generate-resources&lt;/phase&gt;
          &lt;goals&gt;
            &lt;goal&gt;copy&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</pre></div><p>You can see the final <code class="literal">pom.xml</code> file in the <code class="literal">chapter1/maven-sample</code> directory in this chapter's sample code.</p></li><li class="listitem"><strong>Create a package</strong>: Now, you should check if everything's correct by making a <a id="id54" class="indexterm"/>package. Simply type the following command:<div><pre class="programlisting">
<strong>mvn package</strong>
</pre></div><p>The preceding should download all the plugins and dependencies, compile your <code class="literal">App.java</code> file from the archetype, generate your <code class="literal">my-opencv-app-1.0-SNAPSHOT.jar</code> in the <code class="literal">target</code> folder, as well as copy all the dependent libraries to your <code class="literal">target/lib</code> folder; check for the <code class="literal">junit</code>, <code class="literal">opencvjar</code>, and <code class="literal">opencvjar-runtime</code> JARs. Also, the native libraries are extracted to the <code class="literal">target</code> <code class="literal">/natives</code> folder, so <code class="literal">opencv_java300.dll</code> can be found there. Your compiled classes can also be found in the <code class="literal">target</code> <code class="literal">/classes</code> folder. The other generated folders are related to your tests.</p></li><li class="listitem"><strong>Customize your code</strong>: Now, we will change the source file to use the simple OpenCV <a id="id55" class="indexterm"/>functions. Navigate to <code class="literal">D:\mvnopencv\my-opencv-app\src\main\java\com\mycompany\app</code> and edit the <code class="literal">App.java</code> file. Simply <a id="id56" class="indexterm"/>add the following code:<div><pre class="programlisting">package com.mycompany.app;

import org.opencv.core.Core;
import org.opencv.core.Mat;
import org.opencv.core.CvType;
import org.opencv.core.Scalar;

public class App
{
  static{ System.loadLibrary(Core.NATIVE_LIBRARY_NAME); }

  public static void main(String[] args) {
    System.out.println("Welcome to OpenCV " + Core.VERSION);
    Mat m = new Mat(5, 10, CvType.CV_8UC1, new Scalar(0));
    System.out.println("OpenCV Mat: " + m);
    Mat mr1 = m.row(1);
    mr1.setTo(new Scalar(1));
    Mat mc5 = m.col(5);
    mc5.setTo(new Scalar(5));
    System.out.println("OpenCV Mat data:\n" + m.dump());
  }
}</pre></div><p>It is the same code from <code class="literal">SimpleSample</code> that we just put in the <code class="literal">App</code> class. Now we just need to run it. Remember to recompile it by running the following command:</p><div><pre class="programlisting">
<strong>mvn package</strong>
</pre></div></li><li class="listitem"><strong>Execute your code</strong>: Execute the generated JAR, pointing the native files in the <code class="literal">/native</code> folder through the <code class="literal">-Djava.library.path</code> property. This should be as simple as typing the following:<div><pre class="programlisting">
<strong>D:\mvnopencv\my-opencv-app&gt;java   -Djava.library.path=target\natives -jar target\my-opencv-app-1.0-SNAPSHOT.jar</strong>
</pre></div><p>Well done! Now you should have the same output as when running the <code class="literal">SimpleSample</code> class. In case you want to execute your project through a <code class="literal">.bat</code> file, simply type the preceding command in a file called <code class="literal">run.bat</code>, for instance, and save it in the <code class="literal">D:\mvnopencv\my-opencv-app</code> folder.</p></li><li class="listitem"><strong>Generate an Eclipse project</strong>: Now, you will be able to take advantage of some <a id="id57" class="indexterm"/>Maven features such as creating an Eclipse project by simply typing the following command:<div><pre class="programlisting">
<strong>mvn eclipse:eclipse</strong>
</pre></div></li></ol></div><p>In order to get <a id="id58" class="indexterm"/>the project inside Eclipse, open your workspace and then go to <strong>File</strong> | <strong>Import...</strong>. Then, choose <strong>Existing Projects into Workspace</strong>, click on <strong>Next</strong> | <strong>Browse...</strong> in the <strong>Select root directory</strong> radio button, and browse to <code class="literal">D:\mvnopencv\my-opencv-app</code>. It should recognize this folder as an Eclipse project. Then simply click on <strong>Finish</strong>.</p><p>In case you want to run your project now, beware that there are two warnings here. Eclipse does not recognize Maven by default. So, you will have an error telling you that <code class="literal">"The project cannot be built until build path errors are resolved", "Unbound classpath variable: 'M2_REPO/org/javaopencvbook/opencvjar/3.0.0/opencvjar-3.0.0.jar' in project 'my-opencv-app'"</code>.</p><p>This error simply means that your <code class="literal">M2_REPO</code> variable isn't defined. Go to <strong>Window</strong> | <strong>Preferences</strong>, and type classpath variables in the search box. Selecting it in the tree will bring you the tab to define this variable. Click on <strong>New...</strong> and the <strong>New Variable Entry</strong> dialog box will appear. In the <strong>Name</strong> input, call it <code class="literal">M2_REPO</code> and in the <strong>Path</strong> input, choose <strong>Folder...</strong> and browse to your Maven repository. This should be located in a folder similar to <code class="literal">C:/Users/baggio/.m2/</code>repository. Click on <strong>Ok</strong>, and then <strong>Ok</strong> again in the <strong>Preferences</strong> dialog box. It will ask for a full rebuild. Click on <strong>Yes</strong>, and then the error should be gone.</p><p>If you try to run your <code class="literal">App.java</code> class by right-clicking <strong>Run As</strong> | <strong>Java Application</strong>, it should give you the following exception: <strong>Exception in thread "main" java.lang.UnsatisfiedLinkError: no opencv_java300 in java.library.path</strong>.</p><p>It only means that Eclipse hasn't found your native files. Fixing it is as easy as expanding your project and locating the <strong>Referenced Libraries</strong> | <strong>opencvjar-3.0.0.jar</strong>. Right-click it and choose <strong>Properties</strong>. Select <strong>Native Library</strong> at the left and in the <strong>Location</strong> path, click <strong>Workspace...</strong>, <strong>my-opencv-app</strong> | <strong>target</strong> | <strong>natives</strong>. Remember that this folder will only exist if you <a id="id59" class="indexterm"/>have previously run the <code class="literal">mvn package</code> command. Run the <code class="literal">App</code> class again and it should <a id="id60" class="indexterm"/>work.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Creating a Java OpenCV Maven project pointing to a local repository</h2></div></div></div><p>The same <a id="id61" class="indexterm"/>instructions given in the previous section apply here. The only differences are that you will not need to add any additional repository to your <code class="literal">pom.xml</code> since they will be located in your <a id="id62" class="indexterm"/>local repository, and that you must install and create all the JARs in the Packt' repository in your machine. We assume that you have already obtained the <code class="literal">opencv-300.jar</code> and the native files required for your architecture, that is, if you are in Linux, you have <code class="literal">opencv_java300.so</code> already compiled.</p><p>In order to put your artifacts in a local repository, you must use the <code class="literal">goal install-file</code> from the <code class="literal">install</code> plugin. Firstly, you should install the <code class="literal">opencv jar</code> file. It should be in your <code class="literal">build</code> directory, in a folder that will look like <code class="literal">D:\opencv\build\bin</code>. In that folder, type in the following command:</p><div><pre class="programlisting">
<strong>mvn install:install-file -Dfile=opencvjar-3.0.0.jar -DgroupId=opencvjar -DartifactId=opencvjar -Dversion=3.0.0 -Dpackaging=jar</strong>
</pre></div><p>Make sure you use the same <code class="literal">groupId</code> and <code class="literal">artifactId</code> when referring to it in your <code class="literal">pom.xml</code> dependencies. Now, in order to install the native files, almost the same procedure will be used. Instead of installing the native file itself, it is advisable to convert it to a <code class="literal">.jar</code> file before installation. If you are using Linux, simply create a <code class="literal">ZIP</code> file from the <code class="literal">opencv_java300.so</code> and rename it as <code class="literal">opencv_java300.jar</code>. In fact, a <code class="literal">JAR</code> file is a <code class="literal">ZIP</code> file that obeys some standards. After you have created your JAR file, it is time to install it in your local Maven repository. Simply type the following command:</p><div><pre class="programlisting">
<strong>mvn install:install-file -Dfile=opencvjar -runtime-natives-linux-x86.jar -DgroupId=opencvjar -DartifactId=opencvjar-runtime -Dversion=3.0.0 -Dpackaging=jar -Dclassifier=natives-linux-x86</strong>
</pre></div><p>Notice the <code class="literal">natives-linux-x86</code> classifier. This is important for the dependencies to specify their <a id="id63" class="indexterm"/>architecture. After typing it, you should have both the dependencies installed. Now, simply <a id="id64" class="indexterm"/>update your <code class="literal">pom.xml</code> file to refer to <code class="literal">groupId opencvjar</code> instead of <code class="literal">org.javaopencvbook</code>. Following the instructions from the previous section should make you ready to use Maven from your local repository.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Summary</h1></div></div></div><p>This chapter provided several different approaches for setting up OpenCV for Java, that is, by either installing compiled binaries or compiling it from the source. It also pointed to instructions for making the main configurations in Eclipse and NetBeans IDE as well as for using building tools such as Ant and Maven. The user should be ready to easily start using OpenCV in his/her Java projects.</p><p>The next chapter will go deeper into OpenCV and address basic tasks such as handling images through matrices, reading image files, retrieving frames from a webcam, and creating nice Swing GUIs for your computer vision applications.</p></div></body></html>