<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Data Exploration and Data Visualization</h1>
                
            
            <article>
                
<div class="title-page-name">
<p class="calibre2">Data Exploration and Data Visualization techniques are essential to understanding data before one can implement predictive modeling. With existing open source R packages for statistical and mathematical algorithms, data professionals can easily explore their data and discover patterns/trends that are otherwise challenging to do in a relational database. Using SQL Server <strong class="calibre1">Machine Learning Services</strong> (<strong class="calibre1">ML Services</strong>) with R means that data exploration and data visualization are no longer siloed work, leading to faster and easier paths to predictive modeling.</p>
<p class="calibre2">This chapter outlines essential tips and tricks developers must know for data exploration and data visualization using R. You will learn how to integrate R for data exploration and data visualization in T-SQL and then stitch these techniques in SSRS and Power BI. If you are already familiar with R for data exploration and data visualization, feel free to skip to the last section of this chapter.</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding SQL and R data types</h1>
                
            
            <article>
                
<p class="calibre2">Before we dive into exploring data using R in T-SQL, let's get started with understanding data types to store data in R. The first and most important data type to be familiar with when working with R in T-SQL is data frame. The input and output parameters of <kbd class="calibre11">sp_execute_external_script</kbd> in SQL Server received and sent from R are data frames. Other data types that are important to know for data munging, and that are very similar to data frame, are matrix and data table, which are beyond the scope of this chapter.</p>
<p class="calibre2">Aside from data frame, R supports a limited number of scalar data types such as character, complex, date/time, integer, logical, numeric, and raw. Thus, when you provide data from SQL Server in R Scripts, when necessary the data will be implicitly converted to a compatible data type in R. When a conversion cannot be performed automatically, R will return <kbd class="calibre11">Unhandled SQL data type</kbd>. The following table provides a short example of data type conversion. For more information about implicit data type conversion, please visit <em class="calibre12">R Libraries and R Data Types</em> at <span><a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r/r-libraries-and-data-types#changes-in-data-types-between-sql-server-2016-and-earlier-versions" class="calibre10">https://docs.microsoft.com/en-us/sql/advanced-analytics/r/r-libraries-and-data-types#changes-in-data-types-between-sql-server-2016-and-earlier-versions</a></span>:</p>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">SQL Server Data Type (input parameters to sp_execute_external_script)</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">R Class</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">RESULT SET Data Type (output parameters to sp_execute_external_script)</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">datetime</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">POSIXct</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">Datetime</kbd></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">numeric(p,s)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">numeric</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">float</kbd></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">int</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">integer</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">int</kbd></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">varbinary(n)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">raw</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">varbinary(max)</kbd></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">varchar(n)</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">character</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">varchar(max)</kbd></p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Data frames in R</h1>
                
            
            <article>
                
<p class="calibre2">A data frame contains rows and columns, just like a table in SQL Server, where each column can have different basic data types, for example integer, character, and so on.</p>
<div class="packt_tip"><br class="calibre30"/>
Use <kbd class="calibre31">?</kbd> to learn more about a function:<br class="calibre30"/>
<kbd class="calibre31">? [function]</kbd></div>
<p class="calibre2">For more information about data frames, you can type the following command in <strong class="calibre1">R Tools for Visual Studio</strong> (<strong class="calibre1">RTVS</strong>), R Studio, or your other favorite R IDE:</p>
<pre class="calibre19"><strong class="calibre1">&gt; ? data.frame</strong>  </pre>
<p class="calibre2">By default, R uses memory. So once the input data frame is passed from <kbd class="calibre11">sp_execute_external_script</kbd>, R will store the input data in memory. Machine Learning Services (In-Database) is managed by Resource Governor in SQL Server as discussed in <span><a target="_blank" href="part0039.html#1565U0-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 3</a>, <em class="calibre12">Managing Machine Learning Services for SQL Server 2017 and R</em></span><em class="calibre12">.</em></p>
<p class="calibre2">A general guideline is to strive for a good balance between what types of computation should be done in SQL Server VS in R. This includes whether to do data munging/manipulation in R vs in SQL Server.</p>
<p class="calibre2">There are some built-in data frames available in R, such as <kbd class="calibre11">mtcars</kbd> or <kbd class="calibre11">iris</kbd>.</p>
<p class="calibre2">Let's take a look at a data frame in R. Run the following code in RTVS:</p>
<pre class="calibre19"><strong class="calibre1">&gt; mtcars;</strong>
  </pre>
<p class="calibre2">The output should be like this:</p>
<div class="packt_figure"><img class="aligncenter26" src="../images/00039.gif"/></div>
<div class="cdpaligncenter">Figure 4.1 - mtcars data</div>
<p class="calibre2">To check the data type, you can call the function <kbd class="calibre11">call</kbd> on the variable:</p>
<pre class="calibre19"><strong class="calibre1">&gt; class(mtcars); 
[1] "data.frame" </strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Data exploration and data munging</h1>
                
            
            <article>
                
<p class="calibre2">Data munging in R can be done independently without using SQL Server. The following diagram illustrates a recommended high-level process that developers can follow when using SQL Server and R. If you have worked in R before, you are likely familiar with steps 2, 3, and 5 performed in R directly.</p>
<p class="calibre2">Please note that Steps 3 and 4 are optional and will be discussed more in <span><a target="_blank" href="part0096.html#2RHM00-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 6</a>, </span><em class="calibre12">Predictive Modeling</em> and <span><a target="_blank" href="part0102.html#318PC0-e3f81285367248f4bbc6431bcd4f926d" class="calibre10">Chapter 7</a>, </span><em class="calibre12">Operationalizing R Code</em>:</p>
<div class="packt_figure"><img src="../images/00040.jpeg" class="calibre32"/></div>
<div class="cdpaligncenter">Figure 4.2 - High-Level Development Process for SQL Server Machine Learning Services with R</div>
<p class="calibre2">Let's get started with <em class="calibre12">Data Munging in R</em>. Specifically, in this section, we will be working with the R environment so that we know how it works in R before we stitch it together with T-SQL. If you are familiar with R, you may skip this section. Following are prerequisites for this section:</p>
<ol class="calibre14">
<li value="1" class="calibre8">An R IDE, for example RTVS as part of Visual Studio 2015 or 2017. For more information about RTVS, please visit <a href="http://aka.ms/rtvs" target="_blank" class="calibre10"><span>http://aka.ms/rtvs</span></a>.</li>
<li value="2" class="calibre8">The <kbd class="calibre11">WideWorldImporters</kbd> database restored to SQL Server 2016 or above. Please refer to <a href="http://aka.ms/wwi" target="_blank" class="calibre10"><span>http://aka.ms/wwi</span></a> to download the full SQL backup files that you can restore in your environment.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Importing SQL Server data into R</h1>
                
            
            <article>
                
<p class="calibre2">The most common way to connect to SQL Server from R is by using the RODBC package. Please note that prior to SQL Server 2016, this is the step that you'll likely need to work with.</p>
<p class="calibre2">In the example below, we want to retrieve a data set related to Sales Person Monthly Orders in 2015 from a SQL Server instance, <kbd class="calibre11">MsSQLGirl</kbd>; and a database, <kbd class="calibre11">WideWorldImporters</kbd> using a trusted connection (Windows Authentication).</p>
<p class="calibre2">Using RTVS, perform the steps mentioned as follows:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Create a new script called <kbd class="calibre11">Chapter04_01.R</kbd>. Ensure that the <kbd class="calibre11">RODBC</kbd> library is loaded by typing the following:</li>
</ol>
<pre class="calibre33">library(RODBC); </pre>
<ol start="2" class="calibre14">
<li value="2" class="calibre8">Define the connection string and get the connection handle:</li>
</ol>
<pre class="calibre33">connStr &lt;- "Driver=SQL Server;Server=MsSQLGirl; 
  Database=WideWorldImporters;trusted_connection=true"; 
dbHandle &lt;- odbcDriverConnect(connStr); </pre>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Define the query that you want to run in SQL Server. This can also be a query to call stored procedures, functions, views and so on. In this specific example, the query will get the Monthly Orders in 2015 by Sales Person:</li>
</ol>
<pre class="calibre33"># Define the query to be run 
order_query =  
"SELECT DATEFROMPARTS(YEAR(o.[OrderDate]),  
      MONTH(o.[OrderDate]), 1) AS OrderMonth, 
    sp.[PreferredName] AS SalesPerson, 
    COUNT(DISTINCT o.[OrderID]) AS OrderCount, 
    SUM(ol.[Quantity] * ol.[UnitPrice]) AS TotalAmount 
FROM [Sales].[Orders] o 
    INNER JOIN[Sales] .[OrderLines] ol 
        ON ol.[OrderID] = o.[OrderID] 
    INNER JOIN[Application] .[People] sp 
        ON sp.[PersonID] = o.[SalespersonPersonID] 
WHERE sp.[ValidTo] &gt;= GETDATE() 
    AND o.[OrderDate] BETWEEN '20150101' AND '20151231' 
GROUP BY 
DATEFROMPARTS(YEAR(o.[OrderDate]),  
MONTH(o.[OrderDate]), 1), 
    sp.[PreferredName];" 
 </pre>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Execute the query and store the output into <span><kbd class="calibre11">orders</kbd> </span>variable:</li>
</ol>
<pre class="calibre33"># Get the data set from SQL into the orders variable in R 
orders &lt;- sqlQuery(dbHandle, order_query); </pre>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Type the following to see the dataset in <kbd class="calibre11">orders</kbd>:</li>
</ol>
<pre class="calibre33">orders;  </pre>
<p class="calibre34">Or alternatively in RTVS go to the <span>Variable Explorer</span> window as shown in <em class="calibre12">Figure 4 - 2</em> and expand orders to see the details of the variable. Use the magnifying glass tool (<img src="../images/00041.jpeg" class="calibre27"/> )to see the output as shown in <em class="calibre12">Figure 4 - 3</em>:</p>
<div class="packt_figure"><img src="../images/00042.jpeg" class="calibre35"/></div>
<div class="cdpaligncenter">Figure 4 - 3 Variable Explorer in RTVS</div>
<div class="packt_figure"><img class="aligncenter27" src="../images/00043.jpeg"/></div>
<div class="cdpaligncenter">Figure 4 - 4 Viewing orders in Variable Explorer</div>
<p class="calibre2">Here is a data dictionary of the <kbd class="calibre11">orders</kbd> variable. It's useful to be familiar with the following columns as we will be using the orders data frame and its derived variables in this chapter:</p>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Column Names</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Description</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">OrderMonth</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The month that the orders take place</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">OrderCount</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The number of orders in the month for the Sales person.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">TotalAmount</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The order dollar amount</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">SalesPerson</kbd></p>
</td>
<td class="calibre22">
<p class="calibre2">The name of the Sales Person</p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Exploring data in R</h1>
                
            
            <article>
                
<p class="calibre2">There are a number of ways to explore data in R: following are some useful functions. <kbd class="calibre11">df</kbd> denotes a data frame variable and <kbd class="calibre11">col</kbd> denotes a column in <kbd class="calibre11">df</kbd>:</p>
<ul class="calibre7">
<li class="calibre8"><kbd class="calibre11">head(df)</kbd> returns the first few rows of the data frame <kbd class="calibre11">df</kbd>, by default 6.</li>
<li class="calibre8"><kbd class="calibre11">tail(df)</kbd> returns the last few rows of the data frame <kbd class="calibre11">df</kbd> , by default 6.</li>
<li class="calibre8"><kbd class="calibre11">summary(df)</kbd> provides basic summary statistics for each column in the data frame <kbd class="calibre11">df</kbd> .</li>
<li class="calibre8"><kbd class="calibre11">names(df)</kbd> returns the column name of the data frame <kbd class="calibre11">df</kbd> .</li>
<li class="calibre8"><kbd class="calibre11">str(df)</kbd> returns basic information about the data frame <kbd class="calibre11">df</kbd>.</li>
<li class="calibre8"><kbd class="calibre11">describe(df$col)</kbd> describes the distribution/skewness of a set of <kbd class="calibre11">col</kbd> values in <kbd class="calibre11">df</kbd> data frame. This can be quite powerful for constructing scales and item analysis. This requires the <kbd class="calibre11">psych</kbd> package to be installed first.</li>
<li class="calibre8">Following is an example of using the function <kbd class="calibre11">str</kbd> against the data frame <kbd class="calibre11">orders</kbd>:</li>
</ul>
<pre class="calibre33">&gt; str(orders) </pre>
<p class="calibre2">This is how the output looks:</p>
<div class="packt_figure"><img class="aligncenter28" src="../images/00044.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-5 The Output of str(orders)</div>
<div class="packt_tip">Unlike SQL Server, R is case-sensitive for both functions and variables. Ensure that you type them correctly.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Data munging in R</h1>
                
            
            <article>
                
<p class="calibre2">Data munging is the manual process of transforming one <em class="calibre12">raw</em> format into another format so that it is more consumable, either by humans or the next processes such as reporting, data visualization, statistical analysis, predictive analysis, and many more.</p>
<p class="calibre2">There are numerous R packages that are available for Data Munging. R comes preloaded with packages for simple data transformation and visualization. In this section, you will learn two super powerful packages that are commonly used for data munging: <kbd class="calibre11">dplyr</kbd>, <kbd class="calibre11">reshape</kbd>, and <kbd class="calibre11">lubridate</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding/removing rows/columns in data frames</h1>
                
            
            <article>
                
<p class="calibre2">Adding or removing rows or columns can be achieved easily. Following is a list of examples showing how you can achieve it with R as well as using <kbd class="calibre11">dplyr</kbd>:</p>
<ol class="calibre14">
<li value="1" class="calibre8"><strong class="calibre1">Adding new rows</strong>: Let's create a new data frame, <kbd class="calibre11">orders_newrows</kbd>, which <span>contain 2 new rows that we want to append to the end of</span> <kbd class="calibre11">orders</kbd><span>. Then we want to see the last few rows of</span> <kbd class="calibre11">orders</kbd><span>, using the</span> <kbd class="calibre11">tail</kbd> <span>function:</span></li>
</ol>
<pre class="calibre33">&gt; orders_newrows &lt;- data.frame( 
    OrderMonth = c("2015-12-01", "2015-12-01"), 
    SalesPerson = c("Julie", "Tomaz"), 
    OrderCount = c(201, 2017), 
    TotalAmount = c(340000, 370000)); 
 
&gt; orders &lt;- rbind(orders, orders_newrows); 
&gt; tail(orders); 
 </pre>
<p class="calibre34">This will trigger the following output:</p>
<pre class="calibre33">    OrderMonth SalesPerson OrderCount TotalAmount 
105 2015-12-01        Lily        194    442645.5 
106 2015-03-01      Hudson        389   1020488.6 
107 2015-10-01         Taj        195    437388.4 
108 2015-08-01        Lily        182    517126.3 
109 2015-12-01       Julie        201    340000.0 
110 2015-12-01       Tomaz       2017    370000.0 </pre>
<p class="calibre34">Using <kbd class="calibre11">dplyr</kbd>, you can call <kbd class="calibre11">bind_rows</kbd> to append multiple data frames. For example, the following displays <kbd class="calibre11">orders</kbd> and <kbd class="calibre11">orders_newrows</kbd> appended twice:</p>
<pre class="calibre33">&gt; bind_rows(orders, orders_newrows, orders_newrows);</pre>
<ol start="2" class="calibre14">
<li value="2" class="calibre8"><strong class="calibre1">Adding new columns</strong>: To illustrate let's create a new data frame <kbd class="calibre11">orders_tax</kbd> <span>that contains a sequence id for each row and the 10% Sales Tax amount of the Total Amount. We use <kbd class="calibre11">cbind</kbd> function to bind the orders variable with the</span> <kbd class="calibre11">orders_tax</kbd> <span>variable:</span></li>
</ol>
<pre class="calibre33">&gt; orders_discount &lt;- data.frame( 
    Discount = orders$TotalAmount * 0.25) 
&gt; orders &lt;- cbind(orders, orders_ discount); 
&gt; names(orders) </pre>
<p class="calibre34">This will give us the following output:</p>
<pre class="calibre33">[1] "OrderMonth"  "SalesPerson" "OrderCount"  "TotalAmount" 
[5] "Discount"  </pre>
<p class="calibre34">Using <kbd class="calibre11">dplyr</kbd>, you can call <kbd class="calibre11">bind_cols</kbd> to add a new column:</p>
<pre class="calibre33">&gt; orders_tax &lt;- data.frame( 
    RowID = seq(1:nrow(orders)), 
    SalesTax = orders$TotalAmount * 0.1 
    ) 
&gt; orders &lt;- bind_cols(orders,data.frame(orders_tax)); 
&gt; names(orders) </pre>
<p class="calibre34">The output is as follows:</p>
<pre class="calibre33">[1] "OrderMonth"  "SalesPerson" "OrderCount"  "TotalAmount"  
[5] "Discount"   "RowID"       "SalesTax"    </pre>
<p class="calibre34">Or you can add a new column called <kbd class="calibre11">TotalPlusTax</kbd>:</p>
<pre class="calibre33">&gt; mutate(orders, TotalPlusTax = TotalAmount * 0.125); </pre>
<ol start="3" class="calibre14">
<li value="3" class="calibre8"><strong class="calibre1">Removing a column</strong>: Now let's remove <kbd class="calibre11">RowID</kbd> from <kbd class="calibre11">orders</kbd><span>:</span></li>
</ol>
<pre class="calibre33">&gt; orders &lt;- orders[, !names(orders) == "RowID"] </pre>
<p class="calibre34">The command <kbd class="calibre11">names(orders)</kbd> lists the column names in orders. So, <kbd class="calibre11">!names(orders) == "RowID"</kbd> excludes the column name <kbd class="calibre11">RowID</kbd>.</p>
<p class="calibre34">Using <kbd class="calibre11">dplyr</kbd>, you can call <kbd class="calibre11">select</kbd> to select a set of column. For example, the following excludes <kbd class="calibre11">RowID</kbd> from <kbd class="calibre11">orders</kbd>:</p>
<pre class="calibre33">&gt; select(orders, -RowID); </pre>
<p class="calibre34">You can also easily select columns in orders where the column names start with <kbd class="calibre11">Order</kbd>:</p>
<pre class="calibre33">&gt; select(orders, matches("Order"));  </pre>
<p class="calibre34">Let's show <kbd class="calibre11">orders</kbd> with <kbd class="calibre11">SalesPerson</kbd> starting with <kbd class="calibre11">J</kbd>. First, to get the indexes of those that start with <kbd class="calibre11">J</kbd>, we can use the <kbd class="calibre11">grep</kbd> function:</p>
<pre class="calibre33">&gt; grep("^J.*", orders$SalesPerson); 
[1]   2  17  21  25  28  37  43  45  52  71  78 102 109 
&gt; orders[grep("^J.*", orders$SalesPerson),]; 
    OrderMonth SalesPerson OrderCount TotalAmount SalesTax 
2   2015-06-01        Jack        206    502828.7 50282.87 
17  2015-05-01        Jack        203    493282.0 49328.21 
21  2015-11-01        Jack        210    473676.4 47367.64 
25  2015-02-01        Jack        176    454979.3 45497.93 
28  2015-10-01        Jack        205    522954.2 52295.42 
37  2015-07-01        Jack        205    466244.0 46624.40 
43  2015-04-01        Jack        188    520575.8 52057.58 
45  2015-01-01        Jack        182    413761.0 41376.10 
52  2015-12-01        Jack        209    474157.7 47415.77 
71  2015-03-01        Jack        181    469591.0 46959.10 
78  2015-08-01        Jack        171    359710.5 35971.06 
102 2015-09-01        Jack        249    552961.4 55296.14 
109 2015-12-01       Julie        201    340000.0 34000.00 
 </pre>
<p class="calibre34">Using <kbd class="calibre11">dplyr</kbd>, you can call <kbd class="calibre11">select</kbd> to select a set of column. For example, the following excludes <kbd class="calibre11">RowID</kbd> from <kbd class="calibre11">orders</kbd>:</p>
<pre class="calibre33">&gt; filter(orders, grepl("^J.*", SalesPerson)); </pre>
<div class="packt_tip">You may have noticed in the last few <kbd class="calibre31">dplyr</kbd> examples that <kbd class="calibre31">dplyr</kbd> has a friendlier syntax. As an example, in the <kbd class="calibre31">filter</kbd> function, there is no need to specify the variable that the column belongs to. <br class="calibre30"/>
<br class="calibre30"/>
<kbd class="calibre31">  &gt; orders[grep("^J.*", orders$SalesPerson),]; # base</kbd><br class="calibre30"/>
<br class="calibre30"/>
<span class="calibre36"><kbd class="calibre31">  &gt; filter(orders, grepl("^J.*", SalesPerson)); # dplyr <br class="calibre30"/>
<br class="calibre30"/></kbd></span> Also, the select function is much friendlier. <br class="calibre30"/>
<br class="calibre30"/>
<kbd class="calibre31">  &gt; orders &lt;- orders[, !names(orders) == "RowID"] # base</kbd><br class="calibre30"/>
<br class="calibre30"/>
<kbd class="calibre31">  &gt; select(orders, -RowID); # dplyr</kbd></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">More data munging with dplyr</h1>
                
            
            <article>
                
<p class="calibre2">The following is a quick list of useful data munging activities, functions, and examples. <kbd class="calibre11">df</kbd> denotes a data frame variable.</p>
<table class="table">
<tbody class="calibre20">
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Purpose</strong></p>
</td>
<td class="calibre22">
<p class="calibre2"><strong class="calibre1">Functions</strong></p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2">Rename columns</p>
</td>
<td class="calibre22"><kbd class="calibre37">rename(df, new_column_name = old_column_name)</kbd></td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2">Sort/order data</p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">arrange(df, col1)</kbd></p>
<p class="calibre2">order data frame <kbd class="calibre11">df</kbd> by <kbd class="calibre11">col1</kbd>.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2">Deduplicate data</p>
</td>
<td class="calibre22">
<p class="calibre2"><kbd class="calibre11">distinct(df)</kbd></p>
<p class="calibre2"><kbd class="calibre11">distinct(df, [column names])</kbd></p>
<p class="calibre2">Deduplicate <kbd class="calibre11">df</kbd> for <kbd class="calibre11">[column names]</kbd> when provided.</p>
</td>
</tr>
<tr class="calibre21">
<td class="calibre22">
<p class="calibre2">Piping</p>
</td>
<td class="calibre22">
<p class="calibre2"><em class="calibre12">x %&gt;% f(y)</em></p>
<p class="calibre2">Perform <em class="calibre12">f(x,y)</em>. You can nest the syntax. For example:</p>
<p class="calibre2"><em class="calibre12">x %&gt;% f(y)</em><em class="calibre12">%&gt;% g(z) </em>is equivalent to <em class="calibre12">x %&gt;% g(f(x,y),z)</em>.</p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Finding missing values</h1>
                
            
            <article>
                
<p class="calibre2">R has a very short and simple way of finding missing values, which is <kbd class="calibre11">is.na(df)</kbd>. It returns row index(es) in <kbd class="calibre11">df</kbd> with missing values.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Transpose data</h1>
                
            
            <article>
                
<p class="calibre2">Transposing a dataset is not a trivial thing to do in SQL Server. Use <kbd class="calibre11">t(df)</kbd> in R to swap rows and columns of a data frame, <kbd class="calibre11">df</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Pivot / Unpivot data</h1>
                
            
            <article>
                
<p class="calibre2">The <kbd class="calibre11">reshape</kbd> package is super useful for pivoting and unpivoting data.</p>
<p class="calibre2">Use <kbd class="calibre11">cast</kbd> to pivot data as follows:</p>
<pre class="calibre19">library(reshape) 
x &lt;- data.frame(OrderMonth = orders$OrderMonth, 
                SalesPerson = orders$SalesPerson, 
                TotalAmount = orders$TotalAmount) 
x1 &lt;- cast(x, OrderMonth ~ SalesPerson) 
names(x1) </pre>
<p class="calibre2">Use <kbd class="calibre11">melt</kbd> to unpivot data as follows:</p>
<pre class="calibre19">melt(x1,id=c(OrderMonth)) </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Example - data exploration and munging using R in T-SQL</h1>
                
            
            <article>
                
<p class="calibre2">As shown earlier, there are very nifty data munging and data exploration techniques that you can do in R. Let's now stitch it all together in T-SQL. In this following example, we want to get a statistical summary of monthly sales person order counts and the total amount, in 2015 - specifically Min, Max, 1<sup class="calibre38">st</sup> Quartile, Median, 3<sup class="calibre38">rd</sup> Quartile - to get a sense of the data range and the distribution of the monthly orders per sales person:</p>
<pre class="calibre19"> 
USE WideWorldImporters 
GO 
 
-- Part 1: Get Monthly Order count and Order amount  
-- per Sales Person in Year 2015. 
DECLARE @SQLScript NVARCHAR(MAX) 
SET @SQLScript = N'SELECT DATEFROMPARTS(YEAR(o.[OrderDate]),  
MONTH(o.[OrderDate]), 1) AS OrderMonth, 
    sp.[PreferredName] AS SalesPerson, 
    COUNT(DISTINCT o.[OrderID]) AS OrderCount, 
    SUM(ol.[Quantity] * ol.[UnitPrice]) AS TotalAmount 
FROM [Sales].[Orders] o 
    INNER JOIN [Sales].[OrderLines] ol 
        ON ol.[OrderID] = o.[OrderID] 
    INNER JOIN [Application].[People] sp 
        ON sp.[PersonID] = o.[SalespersonPersonID] 
WHERE sp.[ValidTo] &gt;= GETDATE() 
    AND YEAR(o.[OrderDate]) = 2015 
GROUP BY 
DATEFROMPARTS(YEAR(o.[OrderDate]),  
MONTH(o.[OrderDate]), 1), 
    sp.[PreferredName];' 
 
-- Part 2: Prepare the R-script that will summarize the dataset. 
DECLARE @RScript NVARCHAR(MAX) 
SET @RScript = N'OutputDataSet &lt;- as.data.frame(t(sapply(InputDataSet[, c("OrderCount", "TotalAmount")], summary))); 
OutputDataSet &lt;- cbind(Column = row.names(OutputDataSet), OutputDataSet);' 
 
-- Part 3: Execute R in TSQL to get the monthly sales person's  
-- order count and total amount. 
EXECUTE sp_execute_external_script 
     @language = N'R' 
    ,@script = @RScript 
    ,@input_data_1 = @SQLScript 
WITH RESULT SETS (( 
            [Columns] NVARCHAR(30), [Min] FLOAT, 
            [Q1] FLOAT, [Median] FLOAT, 
            [Mean] FLOAT,  [Q3] FLOAT, 
            [Max] FLOAT)); 
GO 
 </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Data visualization in R</h1>
                
            
            <article>
                
<p class="calibre2">Good data visualization draws insights from a large amount of data and serves as a medium to communicate to the audience. Fortunately, R has powerful built-in functions as well as packages that can help you to create good data visualization. In this section, we will go through a number of built-in graphical functions and R libraries to show their capabilities. Then we'll walk through an example on how to stitch it together with T-SQL. You will also learn how to display graphics from R in SQL Operations Studio. Similar to the previous section, we will be using the <kbd class="calibre11">orders</kbd> dataset and will create a data frame <strong class="calibre1">d</strong> to narrow down the analysis for sales persons Amy, Jack, and Hudson.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Plot</h1>
                
            
            <article>
                
<p class="calibre2">The <kbd class="calibre11">plot()</kbd> function in R draws a simple scatterplot showing the relationship between two variables and distribution trends/outliers.</p>
<p class="calibre2">Here's an example of a script that visualizes the relationship between the number of orders and the monthly sales amount for <kbd class="calibre11">Amy</kbd>, <kbd class="calibre11">Jack</kbd>, and <kbd class="calibre11">Hudson</kbd> in 2015:</p>
<pre class="calibre19">&gt; d &lt;- orders[orders$SalesPerson %in% c("Amy", "Jack", "Hudson"), ]; 
&gt; plot(x = d$TotalAmount, y = d$OrderCount,  
main = "Monthly Orders", xlab = "Total Amount ($)",  
ylab = "Number of Orders", col = d$SalesPerson, pch = 19,  
xaxt = "n"); 
&gt; axis(side = 1, at = x &lt;- signif(seq(from = 0,  
to =  max(orders$TotalAmount), length.out = 6), 2), 
labels = paste(x / 1000, "k", sep = "")); </pre>
<p class="calibre2">The following diagram shows the Monthly Amount and the number of Orders that each Sales Person made in 2015. Using a plot like this allows us to easily see that there is a strong Sales Person denoted in blue dots:</p>
<div class="packt_figure"><img class="aligncenter29" src="../images/00045.gif"/></div>
<div class="cdpaligncenter">Figure 4-5 Scatterplot using the basic plot function</div>
<p class="calibre2">Obviously the preceding plot diagram takes a few steps to draw and you'll also need to add a <kbd class="calibre11">legend()</kbd> call to map the colors to the Sales Person. Following is a simpler way to draw a plot diagram with a one call.</p>
<p class="calibre2">The <kbd class="calibre11">ggplot2</kbd> library offers an easy way to create a similar chart using the <kbd class="calibre11">qplot</kbd> function. Following script is equivalent to the previous call:</p>
<pre class="calibre19">&gt; library(ggplot2)  
&gt;  qplot(x = TotalAmount, y = OrderCount, data = d,  
  color = SalesPerson, main = "Monthly Orders"); </pre>
<p class="calibre2">The following chart comes complete with a legend, which helps to show that <span>Hudson</span> is the top-performing <span>SalesPerson</span>:</p>
<div class="packt_figure"><img class="aligncenter30" src="../images/00046.gif"/></div>
<div class="cdpaligncenter">Figure 4-6 Scatterplot using the ggplot function</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Histogram</h1>
                
            
            <article>
                
<p class="calibre2">The <kbd class="calibre11">hist()</kbd> function in R draws a histogram representing the frequency distribution of the dataset.</p>
<p class="calibre2">Here's a script that draws a frequency distribution of the monthly sales person Total Amount in 2015:</p>
<pre class="calibre19">&gt; hist(orders$TotalAmount, main = "Monthly Orders",  
  xlab = "Total Amount ($)") </pre>
<p class="calibre2">Using the following histogram, we can easily see that the most common monthly total amount (per sales person) is between $400 K and $500 K every month:</p>
<div class="packt_figure"><img class="aligncenter31" src="../images/00047.gif"/></div>
<div class="cdpaligncenter">Figure 4-7 Histogram chart using basic hist function</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Boxplot</h1>
                
            
            <article>
                
<p class="calibre2">The boxplot chart allows us to show outliers for each Sales Person. This can easily be achieved in R using the <kbd class="calibre11">boxplot()</kbd> function. However, the <kbd class="calibre11">ggplot</kbd> function is very easy to use and to customize. Here's an example of writing a boxplot diagram using <kbd class="calibre11">ggplot()</kbd>:</p>
<pre class="calibre19">ggplot(orders,  
       aes( x = SalesPerson, 
            y = TotalAmount)) + 
      geom_boxplot(outlier.color = "red", outlier.size = 3) + 
      ggtitle(label = "Monthly Orders") + 
      xlab("Sales Person") + ylab("Total Amount ($)"); </pre>
<p class="calibre2">The following diagram shows the distribution of the <span>Monthly Orders</span> that each Sales Person made in 2015:</p>
<div class="packt_figure"><img class="aligncenter32" src="../images/00048.gif"/></div>
<div class="cdpaligncenter">Figure 4-8 Boxplot chart using ggplot function</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Scatter plot</h1>
                
            
            <article>
                
<p class="calibre2">In R, <kbd class="calibre11">scatterplot()</kbd> can be used to understand the relationship/trend between variables.</p>
<p class="calibre2">Following is an example of using scatterplot to understand the trend of monthly total amounts in 2015 for Amy, Hudson, and Jack:</p>
<pre class="calibre19">library(car) # For the scatterplot function 
library(RColorBrewer) # For choosing color palette more easily 
 
# Prepare d  
d$SalesPerson &lt;- factor(d$SalesPerson); 
d$OrderMonth &lt;- as.Date(d$OrderMonth); 
 
# Configure the palette to use 
my_colors &lt;- brewer.pal(nlevels(as.factor(d$SalesPerson)), "Set2") 
 
# Map the monthly orders 
scatterplot(TotalAmount ~ OrderMonth | SalesPerson, data = d, 
    xlab = "Month", ylab = "Total Amount",  
    main = "Monthly Orders", col = my_colors, 
    cex = 1.5, lwd = 3) </pre>
<p class="calibre2">Based on the following diagram, we can draw the conclusion that Hudson's monthly Total Amount is trending slightly down even though in general they are higher than Amy's and Jack. We can also see that Amy's monthly Total Amount has dropped quite sharply:</p>
<div class="packt_figure"><img src="../images/00049.gif" class="calibre39"/></div>
<div class="cdpaligncenter">Figure 4-9 Scatterplot chart using the scatterplot function</div>
<p class="calibre2">The ggplot function can also be used to create a scatterplot and overlays it with smooth lines that show the monthly pattern of the Sales Person:</p>
<pre class="calibre19"># Use the ggplot version 
ggplot(data = d, 
       aes(x = OrderMonth, y = TotalAmount, color = SalesPerson)) + 
    geom_point() + geom_smooth(method = "loess") + 
    scale_y_continuous(label = scales::dollar) + 
    scale_color_brewer(palette = "Set2") + 
    ggtitle(label = "Monthly Orders"); </pre>
<div class="packt_figure"><img class="aligncenter33" src="../images/00050.gif"/></div>
<div class="cdpaligncenter">Figure 4-10 Scatterplot chart using ggplot function</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Tree diagram</h1>
                
            
            <article>
                
<p class="calibre2">Data preparation for predictive modeling includes exploring the data structure and visualizing the decision rules for predicting values. These values can be categorical and continuous, represented as classification tree and regression tree respectively.</p>
<p class="calibre2">Below is an example of script to create a tree diagram depicting the decision rules for predicting the monthly Total Amount for a given Sales Person and <kbd class="calibre11">OrderCount</kbd>:</p>
<pre class="calibre19">library(rpart) 
library(rpart) 
library(rattle) 
library(rpart.plot) 
fit &lt;- rpart(TotalAmount ~ OrderCount + SalesPerson , data = d, method="anova"); 
fancyRpartPlot(fit, sub = "Monthly Sales Person") 
 </pre>
<p class="calibre2">Running the preceding script will give a neat tree diagram with the first line on the node as the average monthly Total Amount (that is, <em class="calibre12">619e+3</em> in scientific notation is actually $619,000), followed by n as the number of observations and the percentage that makes up the node:</p>
<div class="packt_figure"><img class="aligncenter34" src="../images/00051.gif"/></div>
<div class="cdpaligncenter">Figure 4-11 Tree Diagram using the rpart function</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Example – R data visualization in T-SQL</h1>
                
            
            <article>
                
<p class="calibre2">Now that we have learned a few examples of using R for data visualization, let's stitch it all together with T-SQL in SQL Operations Studio. Please note that SSMS doesn't render the image produced by R in T-SQL.</p>
<div class="packt_tip">Download SQL Operations Studio from <a href="https://docs.microsoft.com/en-us/sql/sql-operations-studio/download" target="_blank" class="calibre40"><span class="calibre36">https://docs.microsoft.com/en-us/sql/sql-operations-studio/download</span></a>.</div>
<p class="calibre2">Perform the following steps to run R in T-SQL to produce an image that can be visualized in SQL Operations Studio.</p>
<ol class="calibre14">
<li value="1" class="calibre8">Open SQL Operations Studio.</li>
<li value="2" class="calibre8">Connect to the <kbd class="calibre11">WideWorldImporters</kbd> database in your server in SQL Operations Studio.</li>
<li value="3" class="calibre8">Copy <kbd class="calibre11">Part 1</kbd> from Example: Data Visualization in T-SQL as we want to reuse the <kbd class="calibre11">@SQLScript</kbd> variable definition:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">-- Part 2: Prepare the R-script that will produce the visualization. 
DECLARE @RScript NVARCHAR(MAX) 
SET @RScript = N'library(ggplot2);  
    image_file = tempfile();  
    jpeg(filename = image_file, width=1000, height=400);  
    d &lt;- InputDataSet[InputDataSet$SalesPerson %in% c("Amy", "Jack", "Hudson"), ]; 
    print(qplot(x = TotalAmount, y = OrderCount, data = d, color = SalesPerson, main = "Monthly Orders")); 
    dev.off() 
    OutputDataSet &lt;- data.frame( 
            data=readBin(file(image_file,"rb"), 
            what=raw(),n=1e6));' 
 
-- Part 3: Execute R in TSQL to get the binary representation of the image. 
EXECUTE sp_execute_external_script 
     @language = N'R' 
    ,@script = @RScript 
    ,@input_data_1 = @SQLScript 
WITH RESULT SETS ((plot VARBINARY(MAX)));</strong> </pre>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">In SQL Operations Studio, execute the preceding script and you will get a result set with a column called <kbd class="calibre11">plot</kbd>.</li>
<li value="5" class="calibre8">Click on <span>Chart Viewer</span>, then choose image from <span>Chart Type</span>:</li>
</ol>
<div class="packt_figure"><img class="aligncenter35" src="../images/00052.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-12 Data Visualization output from R in SQL Operations Studio</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Integrating R code in reports and visualizations</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will delve into familiar reports and visualization Tools that are available in the Microsoft BI stack, such as <strong class="calibre1">SQL Server Reporting Services</strong> (<strong class="calibre1">SSRS</strong>), Power BI, and Mobile Reports.</p>
<p class="calibre2">There are three main use cases for integrating R graphics with SQL Server.</p>
<ol class="calibre14">
<li value="1" class="calibre8">Get a dataset output representing data / statistical analysis, training model, or predictive model:</li>
</ol>
<div class="packt_figure"><img class="aligncenter36" src="../images/00053.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-13 SQL Server Machine Learning Services process for data analysis in R</div>
<p class="calibre34">Execute <kbd class="calibre11">sp_execute_external_script</kbd> to run R to produce a dataset output as illustrated in (1) + (2) + (3). The data set output (3) could be from data/statistical analysis, a training model, predictive output, and so on. In SQL Server, we can optionally process the output further (4), for example, saving it into a table or passing it on to another stored procedure.</p>
<ol start="2" class="calibre14">
<li value="2" class="calibre8">Get a dataset output containing the varbinary representation of the graphics output of R.</li>
</ol>
<div class="packt_figure"><img class="aligncenter37" src="../images/00054.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-14 SQL Server R Services process for data visualization</div>
<p class="calibre34">Execute <kbd class="calibre11">sp_execute_external_script</kbd> to run R to produce a dataset output as illustrated in (1) + (2) + (3). The dataset output (3) in this case would have a varbinary (max) representation of the graphics output. In SQL Server, we can insert the output further (4), for example, saving the images as varbinary (max) into a table.</p>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Save the R graphics output to files and store the file paths in the dataset output. This is ideal when offline rendering is preferred:</li>
</ol>
<div class="packt_figure"><img class="aligncenter38" src="../images/00055.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-17 SQL Server Machine Learning Services process for data visualization to files</div>
<div class="title-page-name">
<p class="calibre34">Execute <kbd class="calibre11">sp_execute_external_script</kbd> to run R to produce a dataset output as illustrated in (1) + (2) + (3). The dataset output (3) in this case contain the file paths where the graphic outputs need to reside. In SQL Server, we can optionally process the output further (4). You can also integrate Filestream for this solution as described in <em class="calibre12">Tomaž Kaštrun's</em> blog here: <br class="title-page-name"/>
<a href="https://tomaztsql.wordpress.com/2016/09/25/filetable-and-storing-graphs-from-microsoft-r-server/" target="_blank" class="calibre10">https://tomaztsql.wordpress.com/2016/09/25/filetable-and-storing-graphs-from-microsoft-r-server/</a></p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Integrating R in SSRS reports</h1>
                
            
            <article>
                
<p class="calibre2">SSRS reports can read datasets from either a query or a stored procedure. Essentially this gives us enough flexibility to choose how we want to incorporate the R output as part of ad-hoc or operational reports in SSRS.</p>
<p class="calibre2">Now, let's take a look at a couple of examples where we integrate R in SSRS Reports. Suppose a data analyst wants to do a quick statistical analysis to understand the strength of the relationship between Sales Person and Total Amount. It's very easy to do this using SSRS. Here's an example showing how you can achieve this.</p>
<ol class="calibre14">
<li value="1" class="calibre8">Using either <strong class="calibre1">Visual Studio 2017</strong> or <strong class="calibre1">SQL Server Management Studio</strong>, connect to <kbd class="calibre11">WideWorldImporters</kbd>.</li>
<li value="2" class="calibre8">Create a new stored procedure called <kbd class="calibre11">dbo.usp_AnalyzeOrdersUsingAnova</kbd>:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">CREATE PROCEDURE dbo.usp_AnalyzeOrdersUsingAnova 
( 
  @StartDate DATE = '20150101', 
  @EndDate DATE = '20151231' 
) 
/********************************************************** 
 * Purpose: Determine if Monthly Orders (Total Amount in $)  
 *      has no dependency on Sales Person. 
 * Parameters:   
 *  @StartDate  - The start date of the Orders table 
 *  @EndDate  - The end date of Orders table 
 * Example on how to execute: 
 *  EXEC dbo.usp_AnalyzeOrdersUsingAnova 
 *     @StartDate = '20150101' 
 *    ,@EndDate = '20151231' 
 *****************************************************************/ 
AS 
BEGIN  
   
  DECLARE @input_query NVARCHAR(MAX);  
  DECLARE @RAOV NVARCHAR(MAX); 
 
  -- The SQL query representing Input data set. 
  -- Get the monthly orders from each Sales between  
  -- specific date and time. 
  SET @input_query = N' 
  SELECT 
    DATEFROMPARTS(YEAR(o.[OrderDate]),  
       MONTH(o.[OrderDate]), 1) AS OrderMonth, 
    sp.[PreferredName] AS SalesPerson, 
    COUNT(DISTINCT o.[OrderID]) AS OrderCount, 
    SUM(ol.[Quantity] * ol.[UnitPrice]) AS TotalAmount 
  FROM [Sales].[Orders] o 
    INNER JOIN[Sales] .[OrderLines] ol 
      ON ol.[OrderID] = o.[OrderID] 
    INNER JOIN[Application] .[People] sp 
      ON sp.[PersonID] = o.[SalespersonPersonID] 
  WHERE sp.[ValidTo] &gt;= GETDATE() 
    AND o.[OrderDate] BETWEEN ''' +  
CAST(@StartDate AS VARCHAR(30)) + ''' AND ''' + 
CAST(@EndDate AS VARCHAR(30)) + ''' 
  GROUP BY 
    DATEFROMPARTS(YEAR(o.[OrderDate]),  
      MONTH(o.[OrderDate]), 1), 
    sp.[PreferredName];' 
 
  -- The R code that tests if Total Amount has no strong  
  -- dependency to Sales Person 
  -- Note: Null Hypothesis (H0) in this case is Total Amount  
  --    has no strong dependency to Sales Person. 
  --    The closer p-value to 0 we can reject the H0. 
  SET @RAOV = N'a = aov(TotalAmount ~ SalesPerson, </strong><br class="title-page-name"/><strong class="calibre1">   data = InputDataSet); 
    m &lt;- summary(a); 
    library(plyr); 
    x &lt;- data.frame(RowID = 1:nrow(m[[1]]),  
      Attribute = rownames(m[[1]])); 
    OutputDataSet &lt;- cbind(x, ldply(m, data.frame));' 
 
  -- Using R Services produce the output as a table 
  EXEC sp_execute_external_script @language = N'R' 
    ,@script = @RAOV  
    ,@input_data_1 = @input_query 
    ,@input_data_1_name = N'InputDataSet' 
    ,@output_data_1_name = N'OutputDataSet'  
    WITH RESULT SETS (([RowID]  INT, 
          [Attribute]  NVARCHAR(50),  
          [DF]    NUMERIC(20,10), 
          [SumSq]  NUMERIC(20,10), 
          [MeanSq]  NUMERIC(20,10), 
          [FValue]  FLOAT, 
          [Pr(&gt;F)]  FLOAT 
          )); 
 
END</strong> </pre>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">Using Visual Studio 2017 or Report Builder, create a new report.</li>
<li value="4" class="calibre8">Save this file as <kbd class="calibre11">SQL+R_Chapter04_SSRS_Anova_01.rdl</kbd> by pressing <em class="calibre12">Ctrl</em>+<em class="calibre12">S</em>, or go to the <span>File</span> menu and click <span>Save</span>.</li>
<li value="5" class="calibre8">Create a new <span>Data Source</span> and save this <kbd class="calibre11">WideWorldImporters</kbd> that connects to the <kbd class="calibre11">WideWorldImporters</kbd> database on your server.</li>
<li value="6" class="calibre8">Then create a new <span>Data Set</span> with the following query definition, then click <span>Refresh Fields</span>:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">EXEC dbo.usp_AnalyzeOrdersUsingAnova</strong> </pre>
<div class="packt_figure"><img src="../images/00056.jpeg" class="calibre41"/></div>
<div class="cdpaligncenter">Figure 4-16 Specify the stored procedure to execute</div>
<ol start="7" class="calibre14">
<li value="7" class="calibre8">Create a <strong class="calibre1">Tablix</strong> to represent <kbd class="calibre11">AOV_SalesPerson</kbd> columns:</li>
</ol>
<div class="packt_figure"><img class="aligncenter39" src="../images/00057.gif"/></div>
<div class="cdpaligncenter">Figure 4-17 Add a Tablix that has all the columns from AOV_SalesPerson</div>
<ol start="8" class="calibre14">
<li value="8" class="calibre8">Optionally add another <strong class="calibre1">Tablix</strong> where its <kbd class="calibre11">DataSetName</kbd> is mapped to <kbd class="calibre11">AOV_SalesPerson</kbd>. On the first cell of the <strong class="calibre1">Tablix</strong> body, describe how to interpret the analysis with the following expression:</li>
</ol>
<pre class="calibre33">="Since the p-value of " &amp; Fields!Pr__F_.Value &amp; " is " &amp; IIf(Fields!Pr__F_.Value &lt; 0.05, "less", "greater") &amp; " than the .05 significance level, we " &amp; IIf(Fields!Pr__F_.Value &lt; 0.05, "reject", "accept") &amp; " the null hypothesis that the mean of monthly Total Amount of " &amp; Fields!Attribute.Value &amp; " are all equal. This means that there is " &amp;  IIf(Fields!Pr__F_.Value &lt; 0.05, "", "no") &amp; " dependency between " &amp; First(Fields!Attribute.Value, "AOV_SalesPerson") &amp; " and Monthly Orders Total Amount"</pre>
<ol start="9" class="calibre14">
<li value="9" class="calibre8">Click <span>Run</span> to see a preview of the report:</li>
</ol>
<div class="packt_figure"><img class="aligncenter40" src="../images/00058.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-18 Preview the Report</div>
<p class="calibre2">Another scenario that is commonly seen for using R is to draw data visualizations. In the following example, we are going to compare how Sales Person performs in the year 2015. From here, we can see the trend of Sales Person monthly orders and how they're performing in the 12 months.</p>
<ol start="1" class="calibre14">
<li value="1" class="calibre8">Using either <strong class="calibre1">Visual Studio 2017</strong> or <strong class="calibre1">SQL Server Management Studio</strong>, connect to <kbd class="calibre11">WideWorldImporters</kbd>.</li>
<li value="2" class="calibre8">Create a new stored procedure called <kbd class="calibre11">dbo.usp_CreateMonthlySalesPlot</kbd>:</li>
</ol>
<pre class="calibre33"><strong class="calibre1"> 
CREATE PROCEDURE dbo.usp_CreateMonthlySalesPlot 
( 
  @StartDate DATE = '20150101', 
  @EndDate DATE = '20151231' 
) 
/********************************************************** 
 * Purpose: Determine if Monthly Orders (Total Amount in $)  
 *      has no dependency on Sales Person. 
 * Parameter:   
 *  @StartDate  - Observation start date in the Orders table 
 *  @EndDate  - Observation end date in the Orders table 
 * Example on how to execute: 
 *  EXEC dbo.usp_AnalyzeOrdersUsingAnova 
 *     @StartDate = '20150101' 
 *    ,@EndDate = '20151231' 
 **********************************************************/ 
AS 
BEGIN  
   
  DECLARE @input_query NVARCHAR(MAX);  
  DECLARE @RPlot NVARCHAR(MAX); 
 
  -- The SQL query representing Input data set. 
  -- Get the monthly orders from each Sales between  
    specfic date and time. 
  SET @input_query = N' 
  SELECT 
    DATEFROMPARTS(YEAR(o.[OrderDate]),  
      MONTH(o.[OrderDate]), 1) AS OrderMonth, 
    sp.[PreferredName] AS SalesPerson, 
    COUNT(DISTINCT o.[OrderID]) AS OrderCount, 
    SUM(ol.[Quantity] * ol.[UnitPrice]) AS TotalAmount 
  FROM [Sales].[Orders] o 
    INNER JOIN [Sales] .[OrderLines] ol 
      ON ol.[OrderID] = o.[OrderID] 
    INNER JOIN [Application] .[People] sp 
      ON sp.[PersonID] = o.[SalespersonPersonID] 
  WHERE sp.[ValidTo] &gt;= GETDATE() 
    AND o.[OrderDate] BETWEEN ''' +  
      CAST(@StartDate AS VARCHAR(30)) +  
      ''' AND ''' +  
      CAST(@EndDate AS VARCHAR(30)) + ''' 
  GROUP BY 
    DATEFROMPARTS(YEAR(o.[OrderDate]), MONTH(o.[OrderDate]), 1), 
    sp.[PreferredName];' 
 
   
  -- The R code that produces the plot. 
  SET @RPlot = N'library(ggplot2);  
  image_file = tempfile();  
  jpeg(filename = image_file, width=600, height=800);  
  a &lt;- qplot(y = TotalAmount, x = OrderMonth,  
        data = InputDataSet, 
        color = SalesPerson,  
        facets = ~SalesPerson, 
        main = "Monthly Orders"); 
  a + scale_x_date(date_labels = "%b");     
  plot(a); 
  dev.off();  
  OutputDataSet &lt;-  data.frame( 
    data=readBin(file(image_file,"rb"), 
    what=raw(),n=1e6));   
' 
  EXEC sp_execute_external_script @language = N'R' 
    ,@script = @RPlot  
    ,@input_data_1 = @input_query 
    ,@input_data_1_name = N'InputDataSet' 
    ,@output_data_1_name = N'OutputDataSet'  
    WITH RESULT SETS (( [plot] VARBINARY(MAX))); 
 
END</strong> </pre>
<ol start="3" class="calibre14">
<li value="3" class="calibre8">In <span>Report Builder</span>, open <kbd class="calibre11">SQL+R_Chapter04_SSRS_Anova_01.rdl</kbd> from earlier, create a new <span>Data Set</span> with the following query definition, then click <span>Refresh Fields</span>. The field created is called <kbd class="calibre11">Plot</kbd> and there should be one row:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">EXEC dbo.usp_CreateMonthlySalesPlot</strong></pre>
<div class="packt_figure"><img class="aligncenter41" src="../images/00059.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-19 Specify the stored procedure to be executed</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre8">Insert a new <span>Image</span>, with the following <span>General</span> properties:</li>
</ol>
<p class="calibre42"><span>Select the image source</span>: <span>Database</span></p>
<p class="calibre42"><span>Use this field</span>: <kbd class="calibre11">=First(Fields!plot.Value, "MonthlyPlot")</kbd></p>
<p class="calibre42"><span>Use this MIME type</span>: <kbd class="calibre11">image/jpeg</kbd></p>
<div class="packt_figure"><img src="../images/00060.gif" class="calibre43"/></div>
<div class="cdpaligncenter">Figure 4-20 Configure Image to render the plot</div>
<div class="title-page-name"/>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Optionally, go to the <span>Size</span> item on the left pane and change <span>Display</span> to <span>Original Size</span>.</li>
</ol>
<p class="calibre2"> </p>
<ol start="6" class="calibre14">
<li value="6" class="calibre8">Click <span>Run</span> to see a preview of the report:</li>
</ol>
<div class="packt_figure"><img src="../images/00061.jpeg" class="calibre44"/></div>
<div class="cdpaligncenter">Figure 4-21 Preview the report with the plot</div>
<p class="calibre2">This RDL file can now be published to an <strong class="calibre1">SSRS Report Server</strong>.</p>
<p class="calibre2">For more information about SSRS, the following Microsoft Docs website is very useful:</p>
<p class="calibre2"><a href="https://docs.microsoft.com/sql/reporting-services/create-deploy-and-manage-mobile-and-paginated-reports" target="_blank" class="calibre10"><span>https://docs.microsoft.com/sql/reporting-services/create-deploy-and-manage-mobile-and-paginated-reports</span></a></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Integrating R in Power BI</h1>
                
            
            <article>
                
<p class="calibre2">Power BI is a powerful tool for visualizing data. Together with R, Power BI can render beautiful images with uncompromised dynamic interactivity. In this example, you'll learn how to create data visualizations similar to the one that we created in SSRS in the previous section:</p>
<div class="packt_figure"><img class="aligncenter42" src="../images/00062.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-22 Power BI Visualization with R Script Editor</div>
<div class="title-page-name"/>
<p class="calibre2">For simplicity, we will use Power BI desktop but you could just as well create one from the online <a href="https://powerbi.microsoft.com/en-us/" target="_blank" class="calibre10">PowerBI.com</a> version:</p>
<ol class="calibre14">
<li value="1" class="calibre8">Launch <strong class="calibre1">Power BI Desktop</strong> and create a new file.</li>
<li value="2" class="calibre8">From the <span>Home</span> menu, click on <span>Get Data</span> | <span>SQL Server</span>.</li>
<li value="3" class="calibre8">Connect to your SQL Server instance that has the <kbd class="calibre11">WideWorldImporters</kbd> database.</li>
<li value="4" class="calibre8">Then click on <span>Advanced Options</span> to provide the following query on the <span>SQL statement</span> field:</li>
</ol>
<pre class="calibre33"><strong class="calibre1">SELECT 
    DATEFROMPARTS(YEAR(o.[OrderDate]), 
    MONTH(o.[OrderDate]), 1) AS OrderMonth, 
    sp.[PreferredName] AS SalesPerson, 
    COUNT(DISTINCT o.[OrderID]) AS OrderCount, 
    SUM(ol.[Quantity] * ol.[UnitPrice]) AS TotalAmount 
FROM [Sales].[Orders] o 
    INNER JOIN[Sales] .[OrderLines] ol 
        ON ol.[OrderID] = o.[OrderID] 
    INNER JOIN[Application] .[People] sp 
        ON sp.[PersonID] = o.[SalespersonPersonID] 
WHERE sp.[ValidTo] &gt;= GETDATE() 
GROUP BY 
    DATEFROMPARTS(YEAR(o.[OrderDate]), MONTH(o.[OrderDate]), 1), 
    sp.[PreferredName];</strong> </pre>
<p class="calibre34">The dialog box should now look like this:</p>
<div class="packt_figure"><img src="../images/00063.jpeg" class="calibre45"/></div>
<div class="cdpaligncenter">Figure 4-23 SQL Server database data source details</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre8">Click <span>OK</span> to see the preview of the query.</li>
<li value="6" class="calibre8">Then click <span>Load</span> on the preview window:</li>
</ol>
<div class="packt_figure"><img src="../images/00064.jpeg" class="calibre46"/></div>
<div class="cdpaligncenter">Figure 4-24 Preview of the query</div>
<ol start="7" class="calibre14">
<li value="7" class="calibre8">From the <span>Visualizations</span> pane, click on the <span>R Script</span> icon.</li>
<li value="8" class="calibre8">Drag and drop the <kbd class="calibre11">OrderMonth</kbd>, <kbd class="calibre11">SalesPerson</kbd>, and <kbd class="calibre11">TotalAmount</kbd> <span>columns </span>from the <span>Fields</span> pane into the <span>Values</span> box.</li>
</ol>
<p class="calibre34">Please note that your table might be called <kbd class="calibre11">Query1</kbd> and you can rename this to something more meaningful such as <span>MonthlyOrders</span>, as shown as follows:</p>
<div class="packt_figure"><img class="aligncenter43" src="../images/00065.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-25 Choose Fields as inputs to R</div>
<ol start="9" class="calibre14">
<li value="9" class="calibre8">With the <span>OrderMonth</span>, instead of the default <span>Date Hierarchy</span> choose <span>OrderMonth</span> from the drop-down list in the <span>Values</span> field:</li>
</ol>
<div class="packt_figure"><img class="aligncenter44" src="../images/00066.jpeg"/></div>
<div class="cdpaligncenter">Figure 4-26 Choose Order Month instead of Data Hierarchy to display</div>
<ol start="10" class="calibre14">
<li value="10" class="calibre8">Ensure that the R Script graphic box is still in focus. Optionally you can resize it to make it wider or taller:</li>
</ol>
<p class="calibre2"/>
<div class="packt_figure"><img src="../images/00067.jpeg" class="calibre47"/></div>
<div class="cdpaligncenter">Figure 4-27 R Visualization box in Power BI Desktop</div>
<ol start="11" class="calibre14">
<li value="11" class="calibre8">Then, in <strong class="calibre1">R Script Editor</strong> located on the lower half of Power BI screen, enter the following R code:</li>
</ol>
<pre class="calibre33">dataset$OrderMonth &lt;- as.Date(dataset$OrderMonth); 
 
library(ggplot2); 
a &lt;- qplot(y = TotalAmount, x = OrderMonth, data = dataset, 
        color = SalesPerson, facets = ~SalesPerson, 
        main = "Monthly Orders"); 
a + scale_x_date(date_labels = "%b"); 
a + scale_y_continuous(label = scales::dollar);</pre>
<ol start="12" class="calibre14">
<li value="12" class="calibre8">Click on the <span>Run Script</span> button located on the right of the <span>R Script Editor</span> bar.</li>
<li value="13" class="calibre8">Add a <span>Slicer</span>, then drag and drop <span>OrderMonth</span>.</li>
<li value="14" class="calibre8">Deselect all the <span>OrderMonth</span> hierarchy except for <span>Year</span>, by clicking on the <span>X</span> from the <span>OrderMonth</span> list in the <strong class="calibre1"><span>Values</span></strong> filed:</li>
</ol>
<div class="packt_figure"><img src="../images/00068.jpeg" class="calibre48"/></div>
<div class="cdpaligncenter">Figure 4-28 Slicer for Year</div>
<ol start="15" class="calibre14">
<li value="15" class="calibre8">Now your Power BI report should look something like this:</li>
</ol>
<div class="packt_figure"><img src="../images/00069.jpeg" class="calibre49"/></div>
<div class="cdpaligncenter">Figure 4-29 Power BI Report</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, you have learned the importance of data preparation in predictive modeling, which involves both data exploration and data visualization exercises. R has a number of open-source packages that are useful for data munging, for example <kbd class="calibre11">dplyr</kbd>, <kbd class="calibre11">reshape</kbd>, and many more. The challenge is to hit the right balance between having data munging activities in SQL Server VS in R. The beauty of SQL Server Machine Learning Services is that it allows easy integration with SQL Server Reporting Services. In addition, Power BI also supports interactive data exploration with R visualizations. In the next chapter, you will learn more about the <kbd class="calibre11">RevoScaleR</kbd> library for portable, scalable, and distributable R functions.</p>


            </article>

            
        </section>
    </body></html>