<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Extensibility with R and Python"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Extensibility with R and Python</h1></div></div></div><p>You have already built models using ML Studio and have realized how easy and powerful it is. Despite a lot of ready-to-use modules available in ML Studio, there are still many tasks which can't be done inside ML Studio to build a required model and solve a problem at hand. Microsoft realizes this, so allows you to extend your experiments beyond the capability of ML Studio by writing code in either R or Python.</p><p>This chapter introduces you to the process of integrating your code in your experiment. You don't need any prior skills in Python or R to successfully finish this chapter. However, you can get the best out of this if you have some exposure to any of these two languages. Also, if you want to work with Azure ML at the professional level, it is highly recommended that you gain some skills either in R or Python. If you already know Python or are choosing to pick it up, then you should get exposure to Pandas library; especially, you should learn to work with the <code class="literal">DataFrame</code> module, as you would soon find out why. If you are choosing R, then <code class="literal">data.frame</code> is its default data structure and you can't miss it.</p><p>I don't recommend you to use one language over other. It is up to you to decide on one if you don't know either. The following early sections in this chapter provide you a quick introduction to both the languages in relation to Azure ML.</p><div class="section" title="Introduction to R"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec58"/>Introduction to R</h1></div></div></div><p>
<span class="strong"><strong>R</strong></span> is an open source <a id="id360" class="indexterm"/>statistical programming language and in recent years, it has been hugely popular. R has significant and vibrant communities worldwide and it is rich with libraries/packages, which get new additions every day. R is a first-class citizen in the Azure ML land, meaning that it has its native support for the language. Among many data structures, R has the <code class="literal">data.frame</code> data structure, which can be assumed to be a data table with rows and columns with column headers. Though there are differences, you can <a id="id361" class="indexterm"/>safely think of it as a dataset in ML Studio. So, whenever a dataset is passed to R code in an experiment, it implicitly gets converted to the <code class="literal">data.frame</code> data structure.</p></div></div>
<div class="section" title="Introduction to Python"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec59"/>Introduction to Python</h1></div></div></div><p>
<span class="strong"><strong>Python</strong></span> is also an open <a id="id362" class="indexterm"/>source general-purpose, high-level programming language. This means that it allows you to perform other functions, such as web/mobile/desktop application development along with scientific, mathematical, and statistical programming. Python is very popular among developers and also among the scientific community, such as R for the statistics community. Python is also popular for tasks such as data wrangling or munging, which is loosely the process of manually converting or mapping data from one raw form to another format that allows more convenient consumption of data. For such tasks, the Pandas library in Python is very useful and is used widely. The <code class="literal">DataFrame</code> objects comes with the Pandas library and in Azure ML, Microsoft ships this library along with the base Python and other useful libraries, such as <code class="literal">NumPy</code>, <code class="literal">SciPy</code>, <code class="literal">Pandas</code>, <code class="literal">IPython</code>, <code class="literal">Matplotlib</code>, and so on. If you are already familiar with Python then it's the <span class="strong"><strong>Anaconda</strong></span> distribution of Python 2.7.7.</p><p>The Pandas <code class="literal">DataFrame</code> object is similar to the <code class="literal">data.frame</code> data structure in R and a dataset in ML Studio.</p></div>
<div class="section" title="Why should you extend through R/Python code?"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec60"/>Why should you extend through R/Python code?</h1></div></div></div><p>Since the introduction <a id="id363" class="indexterm"/>of this chapter, you might be wondering that if ML <a id="id364" class="indexterm"/>Studio seems so easy and complete, then why does it need extending with coding? If you are thinking so, then let me assure you that this is not the case. To produce a predictive analytics solution for the real world, what ML Studio provides out of the box is quite promising, but very limited. The following are the common scenarios when you may need to write code and integrate with ML Studio:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There is only a limited set of algorithms available through ML Studio. If a certain algorithm is required either for prediction or evaluation, you need to code and integrate the test. For example, there is no specific algorithm available for time series analysis in ML Studio so far.</li><li class="listitem" style="list-style-type: disc">Though there are some options available, most of the cases of ML Studio with out-of-the box modules are not sufficient to meet the need of exploration and data preparation, which includes data wrangling and data preprocessing, for example, the need to apply the wavelet transform to the data.</li><li class="listitem" style="list-style-type: disc">Data visualization support in ML Studio is very limited and most of the data visualization requirement can't be met with it.</li><li class="listitem" style="list-style-type: disc">When you need to <a id="id365" class="indexterm"/>develop a new kind of model all together, you <a id="id366" class="indexterm"/>could use coding to develop that and then publish it as a web API.</li><li class="listitem" style="list-style-type: disc">To consume data from either a new source or a dataset of a different format, you need to code and consume the data inside ML Studio.</li></ul></div></div>
<div class="section" title="Extending experiments using the Python language"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec61"/>Extending experiments using the Python language</h1></div></div></div><p>You can extend your experiment with the Python script through the module called <span class="strong"><strong>Execute Python Script</strong></span>. You <a id="id367" class="indexterm"/>can explore more about this module with an illustration of processing a time series dataset. ML Studio comes with a sample dataset called <span class="strong"><strong>Time Series Dataset</strong></span> and this is a very simple time series dataset with two <a id="id368" class="indexterm"/>columns, where one represents time as an integer and the other shows the values as integers.</p><p>This illustration involves coding in Python and later coding in R, where the objective is to demonstrate how the integration of code works. Though there will be some explanation of code through embedded comments, it may not be with every detail, as it is beyond the scope of this book. If you are new to coding, then just follow the instructions to get the desired output and understand the integration.</p><div class="section" title="Understanding the Execute Python Script module"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec56"/>Understanding the Execute Python Script module</h2></div></div></div><p>To integrate <a id="id369" class="indexterm"/>Python code with ML Studio, you should use the <span class="strong"><strong>Execute Python Script</strong></span> module, which is the only module available for Python as of writing this book. This module has three input ports and two output ports, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0792EN_10_1.jpg" alt="Understanding the Execute Python Script module"/></div><p>While the first two inputs are datasets, the third one expects a <code class="literal">.zip</code> file to be uploaded to ML Studio to import the existing code; you can find more on this in the following sub section. The first output generates a dataset that can be used further in another module and the second output is the generated visualization, Python Device, which you can only right-click on and then click on <span class="strong"><strong>Visualize</strong></span> to view the generated graph. It supports both the console output as well as the display of PNG graphics using the Python interpreter.</p><p>The property section of <a id="id370" class="indexterm"/>the module comes with a very basic code editor, where you can write code. It also comes with a basic template of the code. The module must contain a function with the name <code class="literal">azureml_main</code> and it should have zero to two parameters. The function must also return a <code class="literal">DataFrame</code> object. Let's take a look at the following screenshot which displays the Python code which we need to integrate with the ML Studio:</p><div class="mediaobject"><img src="graphics/0792EN_10_2.jpg" alt="Understanding the Execute Python Script module"/></div><p>As you can note, the input datasets get converted to Pandas data frames. Connecting a dataset to the input ports is not a must. When an input data port is empty, the corresponding input data frame will be of the value <code class="literal">None</code> or <code class="literal">null</code>. Note here that the mapping between input ports and function parameters is positional, that is, the first connected input port, if <a id="id371" class="indexterm"/>connected, is mapped to the first parameter, <span class="strong"><strong>dataframe1</strong></span>, of the function and the second input, if connected, is mapped to the second parameter, <span class="strong"><strong>dataframe2</strong></span>, of the function.</p><p>You need to take care of proper indentation for Python code; otherwise, it would result in an error.</p><div class="section" title="Creating visualizations using Python"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec41"/>Creating visualizations using Python</h3></div></div></div><p>You can <a id="id372" class="indexterm"/>create data visualization using the <code class="literal">MatplotLib</code> <a id="id373" class="indexterm"/>library or any other library based on it and show it in the browser like any other visualization in ML Studio. However, the visualization created won't be automatically redirected. You have to save them as PNG files for ML Studio to pick it up and make it available through the second output port of the <code class="literal">Execute Python Script</code> module. The overall steps to generate data visualization using the <code class="literal">MatplotLib</code> library through the module are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Change the <code class="literal">MatplotLib</code> library backend to <code class="literal">agg</code> from the default Qt-based renderer</li><li class="listitem" style="list-style-type: disc">Create a figure using the MatplotLib API</li><li class="listitem" style="list-style-type: disc">Get the axis and create all plots in the same axis using a MatplotLib API or any other library that uses MatplotLib as a base for plotting, for example, Pandas</li><li class="listitem" style="list-style-type: disc">Save the <a id="id374" class="indexterm"/>generated figure to a PNG file</li></ul></div><p>Now that you have an <a id="id375" class="indexterm"/>overview of how to integrate the Python code, it's time to walk you through an example.</p></div></div><div class="section" title="A simple time series analysis with the Python script"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec57"/>A simple time series analysis with the Python script</h2></div></div></div><p>The <span class="strong"><strong>time series</strong></span> <a id="id376" class="indexterm"/>is a sequence of data points each having a timestamp associated with it, that is usually measured over a time interval. A simple time series analysis is to find the moving average for the series.</p><p>The moving <a id="id377" class="indexterm"/>average or simple moving average can be defined as the mean of the previous <span class="emphasis"><em>n</em></span> number of data in a series. Here, <span class="emphasis"><em>n</em></span> is the window size. Consider a simple time series data, as the following, where the first column is time, the second column contains value, and the third column calculates the moving average for the window size 3. For each value, its moving average is the average of the previous three values including itself:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Time</p>
</th><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Moving Average =  Sum of previous 3 values / 3</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>30</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>2</p>
</td><td style="text-align: left" valign="top">
<p>25</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>3</p>
</td><td style="text-align: left" valign="top">
<p>15</p>
</td><td style="text-align: left" valign="top">
<p>(15+25+30)/3 = 23.3</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>4</p>
</td><td style="text-align: left" valign="top">
<p>45</p>
</td><td style="text-align: left" valign="top">
<p> (45+15+25)/3 = 28.3</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>5</p>
</td><td style="text-align: left" valign="top">
<p>55</p>
</td><td style="text-align: left" valign="top">
<p>(55+45+15)/3 = 38.3</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>6</p>
</td><td style="text-align: left" valign="top">
<p>5</p>
</td><td style="text-align: left" valign="top">
<p>(5+55+45)/3 = 35.0</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>7</p>
</td><td style="text-align: left" valign="top">
<p>38</p>
</td><td style="text-align: left" valign="top">
<p>(38+5+55)/3 = 32.7</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>8</p>
</td><td style="text-align: left" valign="top">
<p>13</p>
</td><td style="text-align: left" valign="top">
<p>(13+38+5)/3 = 18.7</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>9</p>
</td><td style="text-align: left" valign="top">
<p>33</p>
</td><td style="text-align: left" valign="top">
<p>(33+13+38)/3 = 28.0</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>10</p>
</td><td style="text-align: left" valign="top">
<p>31</p>
</td><td style="text-align: left" valign="top">
<p>(31+33+13)/3 = 25.7</p>
</td></tr></tbody></table></div><p>We would use the <code class="literal">rolling_mean</code> Pandas method to calculate the moving average for the window size 10 to demonstrate the Python script integration We will use the previously mentioned sample time series dataset in ML Studio, add a new column to the dataset, and assign values to it by <a id="id378" class="indexterm"/>calculating the <span class="strong"><strong>simple moving </strong></span><a id="id379" class="indexterm"/>
<span class="strong"><strong>average</strong></span> for it. Let's take a look at the following screenshot:</p><div class="mediaobject"><img src="graphics/0792EN_10_3.jpg" alt="A simple time series analysis with the Python script"/></div><p>The comments in the code are self-explanatory. If you run your experiment with the preceding code, the first output will get you the modified dataset with the moving average values in the third column and the second output will get you the following visualization, where the <a id="id380" class="indexterm"/>red line represents the <a id="id381" class="indexterm"/>moving average:</p><div class="mediaobject"><img src="graphics/0792EN_10_4.jpg" alt="A simple time series analysis with the Python script"/></div></div><div class="section" title="Importing the existing Python code"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec58"/>Importing the existing Python code</h2></div></div></div><p>It may not be <a id="id382" class="indexterm"/>always practical to write enough code in a single script box to meet the requirement. Also, there will be scenarios where you would have an already built and tested code or an external library, which you would like to use inside ML Studio. In such scenarios, you can use the third input port (Input3) of the module. You can keep the prebuilt scripts in a folder, ZIP it, and upload it to ML Studio. It will be available in the <span class="strong"><strong>Saved Datasets</strong></span> section of the modules palette. Then, drag it to the canvas for your experiment and connect it to the third input port, Zip Bundle, of the module. The Azure ML execution framework will unzip it internally during runtime and the contents will be added to the library path of the Python interpreter. This means that the <code class="literal">azureml_main</code> entry point function can import these modules directly.</p></div><div class="section" title="Do it yourself – Python"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec59"/>Do it yourself – Python</h2></div></div></div><p>Add another column to the data frame in the preceding example to moving standard deviation and plot it as another line.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>Use the moving window function <code class="literal">rolling_std</code>.</p></div></div></div></div>
<div class="section" title="Extending experiments using the R language"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec62"/>Extending experiments using the R language</h1></div></div></div><p>Similar to Python, you <a id="id383" class="indexterm"/>can also use the R code/script to extend your experiment inside ML Studio. However, unlike Python, you get two modules for R, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Execute R Script module</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Create R Model module</strong></span></li></ul></div><div class="section" title="Understanding the Execute R Script module"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec60"/>Understanding the Execute R Script module</h2></div></div></div><p>Similar to the <a id="id384" class="indexterm"/>module for Python, the <span class="strong"><strong>Execute R Script</strong></span> module <a id="id385" class="indexterm"/>also has three input ports and two output ports. The property panel for the module comes with an R script editor where you can enter your code, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0792EN_10_5.jpg" alt="Understanding the Execute R Script module"/></div><p>The module comes with a sample script, as you can find in the preceding screenshot. You can use the <code class="literal">maml.mapInputPort()</code> method with the port number as argument 1 for Input1, and argument 2 for Input2 to access the input dataset as an R <code class="literal">data.frame</code> object.</p><p>The third input expects a <code class="literal">.zip</code> file to be uploaded to ML Studio to import the existing code. The first output generates a dataset that can be used further in another module and the second output is the generated visualization, R Device, which you can right-click on it and then click on <span class="strong"><strong>Visualize</strong></span> to view the generated graph. It supports the console output and the display of PNG graphics using the R interpreter. You don't have to take any extra steps to make the visualization available through the second output port of the module, as it would be redirected automatically.</p><p>Remember that if you <a id="id386" class="indexterm"/>import data that uses CSV or other formats, you <a id="id387" class="indexterm"/>have to convert the same to a dataset before using the data in an R module.</p></div><div class="section" title="A simple time series analysis with the R script"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec61"/>A simple time series analysis with the R script</h2></div></div></div><p>We will use the same <a id="id388" class="indexterm"/>time series example, as used previously, but this <a id="id389" class="indexterm"/>time, with the R script. We would use functions from an R package called <span class="strong"><strong>zoo</strong></span>, which is already available in ML Studio. Let's take a look at the following screenshot which displays the code written in R which we are going to integrate with the ML Studio:</p><div class="mediaobject"><img src="graphics/0792EN_10_6.jpg" alt="A simple time series analysis with the R script"/></div><p>The comments in the code are self-explanatory. However, note that on the line number 13, the new column's moving average values are assigned from the position 10 and to the last position, which is 126 here. As we have taken the moving window as 10, the first nine values for the column would be null or missing.</p><p>If you run your experiment <a id="id390" class="indexterm"/>with the preceding code, the first output will get you the <a id="id391" class="indexterm"/>modified dataset with the moving average values in the third column and the second output will get you the following visualization, where the red line represents the moving average:</p><div class="mediaobject"><img src="graphics/0792EN_10_7.jpg" alt="A simple time series analysis with the R script"/></div></div><div class="section" title="Importing an existing R code"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec62"/>Importing an existing R code</h2></div></div></div><p>Like for Python, you can use the third input port (Input3) of the module to import the external code. You <a id="id392" class="indexterm"/>can keep the prebuilt scripts in a folder, ZIP it, and then upload it to ML Studio. To upload a ZIP file to your workspace, click on <span class="strong"><strong>New</strong></span>, click on <span class="strong"><strong>Dataset</strong></span>, and then select <span class="strong"><strong>From local file</strong></span> and the <span class="strong"><strong>Zip file</strong></span> option. After the upload, the zipped file will be available in the <span class="strong"><strong>Saved Datasets</strong></span> list. Then, drag it to the canvas for your experiment and connect it to the third input port, Zip Bundle, of the module. All the files present in the ZIP file will be available for use during runtime. If any directory structure is there in the ZIP file, then it would be preserved. The root in the ZIP bundle is referred to as <code class="literal">src</code>.</p><p>For example, if you have <a id="id393" class="indexterm"/>created an R file named <code class="literal">myExternalCode.R</code>, zipped it to a file, and uploaded to ML Studio, then you can access it from the script editor for the module, shown as follows:</p><div class="informalexample"><pre class="programlisting">source("src/myExternalCode.R")</pre></div><div class="section" title="Including an R package"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec42"/>Including an R package</h3></div></div></div><p>If you want to include any R <a id="id394" class="indexterm"/>package that is not available out of the box in ML Studio, then you can ZIP the package and upload it. Usually, R packages are available as downloadable ZIP files. If you have already downloaded and extracted the R package that you are using in your code, you will need to ZIP the package again otherwise upload the original ZIP file for the R package to ML Studio. You need to install the R package as part of the custom code in the <span class="strong"><strong>Execute R Script</strong></span> module and the package will be installed only for your experiment.</p></div></div><div class="section" title="Understanding the Create R Model module"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec63"/>Understanding the Create R Model module</h2></div></div></div><p>The <span class="strong"><strong>Create R Model</strong></span> <a id="id395" class="indexterm"/>module can be used to create an untrained model using R code. You can build your model using any learner based on an R package or your new implementation.</p><p>The module takes the training script and the scoring script, the two user-defined R scripts, as inputs in the property sections based on which, the model will be built.</p><p>After you create the <a id="id396" class="indexterm"/>model, you can use the <span class="strong"><strong>Train Model</strong></span> module to train the model on a dataset similar to any other learner in ML Studio. Then, pass it to the <span class="strong"><strong>Score Model</strong></span> module to use the model to make predictions. You can then save the trained model, create a scoring experiment, and publish it as a web service.</p></div><div class="section" title="Do it yourself – R"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec64"/>Do it yourself – R</h2></div></div></div><p>Let's take a look at the following steps to build our own test using R for coding:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add another column to the data frame (in the preceding example) to move the median and plot it as another line.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>Use the moving window function <code class="literal">rollmedian</code>.</p></div></div></li><li class="listitem">Display all the already installed packages in ML Studio. You may use the following code:<div class="informalexample"><pre class="programlisting">data.set &lt;- data.frame(installed.packages())
maml.mapOutputPort("data.set")</pre></div></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec63"/>Summary</h1></div></div></div><p>You just completed a very important part of ML Studio in this chapter. You started with an introduction to both R and Python in relation to Azure ML. You explored the importance of why you may need to extend your experiment inside ML Studio using code. Then, you learned how to execute Python scripts and import an already built code inside ML Studio. You applied the same through an example of a simple time series analysis and also created visualization with Python. After Python, you explored the same for R and performed the same tasks of time series analysis and plotted the graph with an R script. ML Studio also comes with another module to build a complete model with R apart from just running a script.</p><p>In the next chapter, you will find out how to deploy a model as a web service API from your experiment inside ML Studio, which can be consumed outside.</p></div></body></html>