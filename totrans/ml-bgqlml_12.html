<html><head></head><body>
		<div id="_idContainer142">
			<h1 id="_idParaDest-131"><em class="italic"><a id="_idTextAnchor133"/>Chapter 9</em>: Suggesting the Right Product by Using Matrix Factorization</h1>
			<p>Suggesting the right product is one of the most common applications of <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>). Every day, product recommendation systems influence our choices on the internet. Newsletters, e-commerce websites, video streaming companies, and many other services leverage this powerful ML technique to offer us meaningful suggestions about the products that we may buy or like.</p>
			<p>In this chapter, with a hands-on and practical approach, we'll execute the main implementation steps to build a new recommendation engine using the matrix factorization algorithm.</p>
			<p>With a gradual and incremental approach and by leveraging BigQuery ML, we'll cover the following topics: </p>
			<ul>
				<li>Introducing the business scenario</li>
				<li>Discovering matrix factorization</li>
				<li>Configuring BigQuery Flex Slots</li>
				<li>Exploring and preparing the dataset</li>
				<li>Training the matrix factorization model</li>
				<li>Evaluating the matrix factorization model</li>
				<li>Using the matrix factorization model</li>
				<li>Drawing business conclusions</li>
			</ul>
			<h1 id="_idParaDest-132"><a id="_idTextAnchor134"/>Technical requirements</h1>
			<p>This chapter requires that you have access to a web browser and can leverage the following:</p>
			<ul>
				<li>A GCP account to access the Google Cloud Console.</li>
				<li>A GCP project to host the BigQuery datasets.</li>
				<li>BigQuery Flex slots to train matrix factorization models in BigQuery ML. The training for these kinds of algorithms is only available to flat-rate customers or customers with reservations. If you're using BigQuery with its on-demand pricing, we'll show you how to use BigQuery Flex Slots.</li>
			</ul>
			<p>Now that the technical requirements are clear, let's look at our use case about the BigQuery ML matrix factorization model.</p>
			<h1 id="_idParaDest-133"><a id="_idTextAnchor135"/>Introducing the business scenario</h1>
			<p>Imagine being a business analyst that works for the Google Merchandise e-commerce store. The website <a id="_idIndexMarker436"/>sells different Google-branded products to different users. Some of the users are registered and have their own identifier, and their clickstream activities are collected in a specific dataset.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout"><strong class="bold">Clickstream data</strong> is the <a id="_idIndexMarker437"/>digital footprint left by users navigating a specific website. This data typically includes the web pages they visited, the time they spent on each page, the device they used, the origin of the traffic, and other relevant information.</p>
			<p>In this scenario, the <a id="_idIndexMarker438"/>data is collected by Google using <strong class="bold">Google Analytics 360</strong> from the Google Merchandise e-commerce portal. This tool can be integrated with any website and allows us to gather information about the users' behavior on each page of the portal for further analysis and analytics. </p>
			<p>The following screenshot is of the Google Merchandise Store, which sells Google-branded gadgets:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer131" class="IMG---Figure">
					<img src="image/B16722_09_001.jpg" alt="Figure 9.1 – A screenshot of the Google Merchandise Store&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.1 – A screenshot of the Google Merchandise Store</p>
			<p>For our business scenario, we will imagine that our manager is asking us to build a new recommendation <a id="_idIndexMarker439"/>engine that can improve the user experience of their customers, as well as the revenues of their e-commerce sales.</p>
			<p>Our goal is to develop a ML model that selects the right product to suggest for each customer who's registered on the website. To achieve this goal, we will use the clickstream data from the Google Merchandise Store that has already been collected and published in a BigQuery public dataset.</p>
			<p>As business analysts, our job is to analyze the data, build an effective recommendation engine, and use it on the existing data to provide meaningful information to the marketing team. </p>
			<p>Now that we've explained and understood the business scenario, let's take a look at the ML technique that we will use to build a recommendation engine for our e-commerce portal.</p>
			<h1 id="_idParaDest-134"><a id="_idTextAnchor136"/>Discovering matrix factorization</h1>
			<p>In this <a id="_idIndexMarker440"/>section, we'll learn what <strong class="bold">matrix factorization</strong> is, and <a id="_idIndexMarker441"/>how it can be used to build recommendation engines.</p>
			<p><strong class="bold">Matrix factorization</strong> represents a class of algorithms usually used to build recommendation engines. These algorithms are built on matrices that represent the interactions between users and items. In these kinds of matrices, the following occurs:</p>
			<ul>
				<li>Each user or customer is represented as a row.</li>
				<li>Each item or product corresponds to a column of the matrix.</li>
				<li>Each cell of the matrix is filled with a numeric value: the <strong class="bold">feedback</strong>. </li>
			</ul>
			<p>This <strong class="bold">feedback</strong> represents <a id="_idIndexMarker442"/>a rating that a specific user has given to a specific item.</p>
			<p>In the following screenshot, we can see an example of a matrix where the rows are the customers of a video streaming service and the columns are the films offered by the platform. Some of the cells contain a rating that ranges from <strong class="bold">1</strong> to <strong class="bold">5</strong>: </p>
			<div>
				<div id="_idContainer132" class="IMG---Figure">
					<img src="image/B16722_09_002.jpg" alt="Figure 9.2 – Representation of a recommendation matrix&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.2 – Representation of a recommendation matrix</p>
			<p>In this example, we can say that <strong class="bold">User 1</strong> has expressed an average rating for the film <strong class="bold">The Shining</strong>, but disliked <strong class="bold">Titanic</strong>. On the other hand, <strong class="bold">User 4</strong> assigned the maximum rating to <strong class="bold">Titanic</strong>, but didn't rate the other films.</p>
			<p>According <a id="_idIndexMarker443"/>to different business scenarios, this feedback can be considered explicit or implicit:</p>
			<ul>
				<li><strong class="bold">Explicit feedback</strong> is available <a id="_idIndexMarker444"/>when the user voluntarily rates a specific item, such as on a review website.</li>
				<li>If explicit <a id="_idIndexMarker445"/>feedback is not available, <strong class="bold">implicit feedback</strong> can be calculated and inferred by the developer of the recommendation system. For example, if a customer has bought a product, we can assume they would give positive feedback for that item.</li>
			</ul>
			<p>Often, in e-commerce data, feedback is not explicitly given by the users but can be extracted from other information that's collected in the process, such as the number of clicks, the time spent on a specific page, or the quantity of a specific product bought by the user.</p>
			<p>Matrix factorization <a id="_idIndexMarker446"/>algorithms are widely used in real-life scenarios. Some examples are as follows:</p>
			<ul>
				<li>The suggested books that we see in an online bookshop.</li>
				<li>The recommended TV series that we can see on video streaming services.</li>
				<li>The posts that are highlighted in our social media feeds.</li>
				<li>The products suggested by internet advertising systems.</li>
			</ul>
			<p>In this section, we learned about the basics of matrix factorization. Now, let's configure BigQuery Flex Slots.</p>
			<h1 id="_idParaDest-135"><a id="_idTextAnchor137"/>Configuring BigQuery Flex Slots</h1>
			<p>In this <a id="_idIndexMarker447"/>chapter, we'll understand how to configure <a id="_idIndexMarker448"/>BigQuery <strong class="bold">Flex Slots</strong> to train our ML model.</p>
			<p>A BigQuery <strong class="bold">Slot</strong> is a unit of BigQuery analytics capacity that's used to execute SQL queries and <a id="_idIndexMarker449"/>train BigQuery ML models. One BigQuery slot represents the compute <a id="_idIndexMarker450"/>capacity of a <strong class="bold">Virtual Compute Processing Unit</strong> (<strong class="bold">VCPU</strong>). </p>
			<p><strong class="bold">Flex Slots</strong> allow us to buy BigQuery analytics capacity for short periods. They are usually used to quickly satisfy sudden demands for resources with a minimum duration of 60 seconds.</p>
			<p>Enabling <a id="_idIndexMarker451"/>Flex Slots is mandatory to train a matrix factorization model; otherwise, BigQuery will return an error during the training stage.</p>
			<p>Let's see how we can enable BigQuery Flex Slots if we're using an on-demand plan:</p>
			<ol>
				<li>If you haven't enabled BigQuery Reservations yet, we need to access <strong class="bold">Reservations</strong> from the BigQuery menu on the left:<div id="_idContainer133" class="IMG---Figure"><img src="image/B16722_09_003.jpg" alt="Figure 9.3 – Accessing Reservations from the BigQuery navigation menu&#13;&#10;"/></div><p class="figure-caption">Figure 9.3 – Accessing Reservations from the BigQuery navigation menu</p></li>
				<li>Click on the <strong class="bold">BUY SLOTS</strong> button to initialize the buying process for BigQuery Flex Slots:<div id="_idContainer134" class="IMG---Figure"><img src="image/B16722_09_004.jpg" alt="Figure 9.4 – Screenshot of the Reservations page&#13;&#10;"/></div><p class="figure-caption">Figure 9.4 – Screenshot of the Reservations page</p></li>
				<li>Choose <a id="_idIndexMarker452"/>the minimum number of Flex Slots to buy; that is, <strong class="bold">100</strong>. Then, click on the <strong class="bold">NEXT</strong> button:<div id="_idContainer135" class="IMG---Figure"><img src="image/B16722_09_005.jpg" alt="Figure 9.5 – BigQuery Buy Slots process&#13;&#10;"/></div><p class="figure-caption">Figure 9.5 – BigQuery Buy Slots process</p></li>
				<li>Confirm <a id="_idIndexMarker453"/>your choice by writing <strong class="bold">CONFIRM</strong> in the confirmation text box and clicking on the blue <strong class="bold">PURCHASE</strong> button:<div id="_idContainer136" class="IMG---Figure"><img src="image/B16722_09_006.jpg" alt="Figure 9.6 – Confirming your BigQuery Slots purchase&#13;&#10;"/></div><p class="figure-caption">Figure 9.6 – Confirming your BigQuery Slots purchase</p></li>
				<li>Once <a id="_idIndexMarker454"/>the purchase has been confirmed, you can switch to the <strong class="bold">ASSIGNMENTS</strong> tab to assign the reservation that you've just bought.</li>
				<li>On the <strong class="bold">ASSIGNMENTS</strong> tab, select your GCP project in the first combo box and the reservation of Flex Slots in the second. After that, click the <strong class="bold">CREATE</strong> button to finalize your configuration:<div id="_idContainer137" class="IMG---Figure"><img src="image/B16722_09_007.jpg" alt="Figure 9.7 – Assigning BigQuery slots&#13;&#10;"/></div><p class="figure-caption">Figure 9.7 – Assigning BigQuery slots</p></li>
				<li>When the assignment is complete, we can go back to the BigQuery home page.<p class="callout-heading">Important note</p><p class="callout">Warning: Remember to deactivate the reservation of BigQuery slots at the end of this use case. Every BigQuery slot costs $0.04 per hour. Forgetting to disable this reservation will generate unexpected billing for your GCP project.</p></li>
			</ol>
			<p>In this <a id="_idIndexMarker455"/>section, we learned how to buy BigQuery Flex Slots so that we can use matrix factorization. Now, we will focus on the data exploration and preparation steps.</p>
			<h1 id="_idParaDest-136"><a id="_idTextAnchor138"/>Exploring and preparing the dataset</h1>
			<p>In this section, we'll <a id="_idIndexMarker456"/>analyze the data we'll use to train our BigQuery ML <a id="_idIndexMarker457"/>model and apply the data preparation steps.</p>
			<p>Let's start by getting a clear understanding of the Google Analytics data that is available in the BigQuery public dataset so that we can build our recommendation system.</p>
			<h2 id="_idParaDest-137"><a id="_idTextAnchor139"/>Understanding the data</h2>
			<p>In this section, we'll import the necessary data and then understand the most relevant fields <a id="_idIndexMarker458"/>of the dataset that will be used to train the BigQuery ML model.</p>
			<p>Before we start developing the ML model, we'll look at the dataset and its schema. To start exploring the dataset, we need to do the following:</p>
			<ol>
				<li value="1">Log into our Google Cloud Console and access the <strong class="bold">BigQuery</strong> user interface from the navigation menu.</li>
				<li>Create a new dataset under the project that we created in <a href="B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039"><em class="italic">Chapter 2</em></a>, <em class="italic">Setting Up Your GCP and BigQuery Environment</em>. For this use case, we'll create the <strong class="source-inline">09_recommendation_engine</strong> dataset with the default options.</li>
				<li>After that, we need to open the <strong class="source-inline">bigquery-public-data</strong> GCP project, which hosts the BigQuery public datasets, and browse the datasets until we find <strong class="source-inline">google_analytics_sample</strong>.</li>
				<li>The BigQuery public dataset contains multiple tables that host the Google Analytics sample data. Each table presents a different suffix according to the year and the month that it refers to:<div id="_idContainer138" class="IMG---Figure"><img src="image/B16722_09_008.jpg" alt="Figure 9.8 – The Google Analytics sample dataset containing the ga_sessions tables&#13;&#10;"/></div><p class="figure-caption">Figure 9.8 – The Google Analytics sample dataset containing the ga_sessions tables</p><p>We'll use the <strong class="bold">ga_sessions</strong> tables to build our matrix factorization model. </p><p class="callout-heading">Tip</p><p class="callout">The <strong class="bold">ga_sessions</strong> table is not well described, but if we need further information about this dataset, we <a id="_idIndexMarker459"/>can leverage the examples available in the BigQuery documentation at <a href="https://support.google.com/analytics/answer/4419694?hl=en">https://support.google.com/analytics/answer/4419694?hl=en</a>.</p></li>
				<li>To simplify <a id="_idIndexMarker460"/>the data access process, let's create a single table that unifies all the tables with different suffixes. Let's execute the following SQL statement:<p class="source-code">CREATE OR REPLACE TABLE `09_recommendation_engine.all_ga_sessions` AS</p><p class="source-code">SELECT * FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`;</p><p>The query creates a new table called <strong class="source-inline">all_ga_sessions</strong> in our <strong class="source-inline">09_recommendation_engine</strong> dataset. This table stores all the data that comes from the different <strong class="source-inline">ga_sessions</strong> tables into a unique structure. To unify all the records, we've used the wildcard character, <strong class="source-inline">*</strong>.</p><p class="callout-heading">Tip</p><p class="callout"><strong class="bold">Wildcards</strong> are useful <a id="_idIndexMarker461"/>when a dataset contains multiple tables with similar names and compatible schemas. In this case, we're collecting all the data from the multiple <strong class="source-inline">ga_sessions_*</strong> tables and placing them in our new structure, <strong class="source-inline">all_ga_sessions</strong>.</p></li>
				<li>Now, we can simply query <strong class="source-inline">all_ga_sessions</strong> to get a preview of the schema:<p class="source-code">SELECT * FROM `09_recommendation_engine.all_ga_sessions`</p><p class="source-code">TABLESAMPLE SYSTEM (10 PERCENT);</p><p>The results of the query point out that the schema of the table is quite complex and contains multiple nested fields. Fortunately, for our purposes, we will only focus on some of them:</p><p><strong class="source-inline">fullVisitorID</strong> represents the identifier of each registered user that is browsing Google's website.</p><p><strong class="source-inline">productSku</strong> is the product code that identifies a specific product in Google's catalog. Some examples of products are mugs, T-shirts, bags, and socks.</p><p>The <strong class="source-inline">action_type</strong> column is the action that a user has performed during a web session. If this field is equal to <strong class="source-inline">6</strong>, the row represents a specific product being purchased by a customer.</p></li>
			</ol>
			<p>Now that <a id="_idIndexMarker462"/>we've discovered which columns will be used for our ML model, it's time to prepare our training dataset.</p>
			<h2 id="_idParaDest-138"><a id="_idTextAnchor140"/>Creating the training dataset</h2>
			<p>In this <a id="_idIndexMarker463"/>section, we'll create the tables that will host the training data of our BigQuery ML model.</p>
			<p>To train our model, we'll create a table that will host all the purchases that have been made by the registered customers on the website.</p>
			<p>Let's create the <strong class="source-inline">product_purchases</strong> table, which contains three fields:</p>
			<ul>
				<li>The code of each user: <strong class="source-inline">fullVisitorId</strong></li>
				<li>The identifier of the purchased product: <strong class="source-inline">purchased_product_id</strong></li>
				<li>The <strong class="source-inline">quantity</strong> field, which specifies the product that's been bought by the customer</li>
			</ul>
			<p>Execute the following SQL statement to create the table:</p>
			<p class="source-code">CREATE OR REPLACE TABLE `09_recommendation_engine.product_purchases` AS</p>
			<p class="source-code">SELECT    fullVisitorId,</p>
			<p class="source-code">          hits_product.productSKU AS purchased_product_id,</p>
			<p class="source-code">          COUNT(hits_product.productSKU) AS quantity</p>
			<p class="source-code">FROM</p>
			<p class="source-code">          `09_recommendation_engine.all_ga_sessions`,</p>
			<p class="source-code">          UNNEST(hits) AS hits,</p>
			<p class="source-code">          UNNEST(hits.product) AS hits_product</p>
			<p class="source-code">WHERE fullVisitorId IN (</p>
			<p class="source-code">                         SELECT fullVisitorId</p>
			<p class="source-code">                         FROM</p>
			<p class="source-code">                `09_recommendation_engine.all_ga_sessions`,</p>
			<p class="source-code">                         UNNEST(hits) AS hits</p>
			<p class="source-code">                         WHERE </p>
			<p class="source-code">                     hits.eCommerceAction.action_type = '6'</p>
			<p class="source-code">                         GROUP BY fullVisitorId</p>
			<p class="source-code">                          )</p>
			<p class="source-code">GROUP BY fullVisitorId, purchased_product_id;</p>
			<p>The most <a id="_idIndexMarker464"/>internal query extracts all the customers identified by <strong class="source-inline">fullVisitorId</strong> from the <strong class="source-inline">all_ga_sessions</strong> table that have at least bought a product on the e-commerce portal. To identify these purchases, we've added a <strong class="source-inline">WHERE</strong> clause to <strong class="source-inline">hits.eCommerceAction.action_type = '6'</strong>. To get distinct values of <strong class="source-inline">fullVisitorId</strong>, the query leverages the <strong class="source-inline">GROUP BY fullVisitorId</strong> clause.</p>
			<p>In the <strong class="source-inline">FROM</strong> clause of the nested query, we're using the <strong class="source-inline">UNNEST</strong> function to extract the nested fields present in the original table and access them.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout"><strong class="bold">UNNEST</strong> is a function <a id="_idIndexMarker465"/>that's used to convert an array into a set of multiple rows. It takes an array as input and returns a table with a single row for each item in the array.</p>
			<p>In the most external query, we simply extract the three fields that are relevant to our use case: <strong class="source-inline">fullVisitorId</strong>, <strong class="source-inline">purchased_product_id</strong>, and our total <strong class="source-inline">quantity</strong>. This last measure <a id="_idIndexMarker466"/>is obtained by using the <strong class="source-inline">SUM</strong> operator on all the transactions being performed by a specific user to buy a specific product.</p>
			<p>Now that we've created the table that our recommendation engine will be trained on, let's create the BigQuery ML model.</p>
			<h1 id="_idParaDest-139"><a id="_idTextAnchor141"/>Training the matrix factorization model</h1>
			<p>In this section, we'll train the BigQuery ML matrix factorization model in order to build a recommendation <a id="_idIndexMarker467"/>system with the e-commerce data that we've already prepared.</p>
			<p>Let's start training the <strong class="source-inline">purchase_recommender</strong> ML model by executing the following SQL statement:</p>
			<p class="source-code">CREATE OR REPLACE MODEL `09_recommendation_engine.purchase_recommender`</p>
			<p class="source-code">OPTIONS(model_type='matrix_factorization',</p>
			<p class="source-code">        user_col='fullVisitorID',</p>
			<p class="source-code">        item_col='purchased_product_id',</p>
			<p class="source-code">        rating_col='quantity',</p>
			<p class="source-code">        feedback_type='implicit'</p>
			<p class="source-code">        )</p>
			<p class="source-code">AS</p>
			<p class="source-code">SELECT fullVisitorID, purchased_product_id, quantity </p>
			<p class="source-code">FROM `09_recommendation_engine.product_purchases`; </p>
			<p>The first few lines of the query are composed of the <strong class="source-inline">CREATE OR REPLACE MODEL</strong> keywords, followed by the identifier of the new ML model, <strong class="source-inline">`09_recommendation_engine.purchase_recommender`</strong>, and <strong class="source-inline">OPTIONS</strong>.</p>
			<p>Now, let's focus on the <strong class="source-inline">OPTIONS</strong> values that we've used to train our BigQuery ML model:</p>
			<ul>
				<li>The model type is <strong class="source-inline">'matrix_factorization'</strong>. This option describes the algorithm that we're using to train our recommendation model.</li>
				<li>The <strong class="source-inline">user_col='fullVisitorID'</strong> option specifies which column represents the users of the recommendation engine. In our case, we're using the <strong class="source-inline">fullVisitorID</strong> field, which is assigned to the registered customers of the e-commerce portal.</li>
				<li>With the <strong class="source-inline">item_col='purchased_product_id'</strong> option, we're using the code of each product that's been purchased by our customers to identify each item in our model.</li>
				<li>Since we <a id="_idIndexMarker468"/>don't have an explicit rating for our products, we'll choose <strong class="source-inline">feedback_type='implicit'</strong> and use the purchased <strong class="source-inline">quantity</strong> value as the rating for our recommendation engine. In this case, we're assuming that if a user has bought large quantities of a product, they're interested and satisfied with the product. </li>
			</ul>
			<p>After about 7 minutes, the matrix factorization model will be trained, and we can move on to the next stage: the evaluation phase.</p>
			<h1 id="_idParaDest-140"><a id="_idTextAnchor142"/>Evaluating the matrix factorization model</h1>
			<p>In this <a id="_idIndexMarker469"/>section, we'll evaluate the performances of the matrix factorization model that we trained in the previous section.</p>
			<p>The evaluation stage of a matrix factorization model can be performed using the <strong class="source-inline">ML.EVALUATE</strong> BigQuery ML function or through the BigQuery UI.</p>
			<p>Let's execute the following query to extract all the evaluation parameters that characterize the recommendation model that we've just trained:</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">  *</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.EVALUATE(MODEL `09_recommendation_engine.recommender`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">    SELECT * FROM `09_recommendation_engine.product_visits`));</p>
			<p>The <a id="_idIndexMarker470"/>result of this query is shown in the following screenshot:</p>
			<div>
				<div id="_idContainer139" class="IMG---Figure">
					<img src="image/B16722_09_009.jpg" alt="Figure 9.9 – The record that's been extracted from the evaluation of the matrix factorization model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.9 – The record that's been extracted from the evaluation of the matrix factorization model</p>
			<p>The same information can be accessed by selecting the ML model from the BigQuery navigation menu and then accessing the <strong class="bold">Evaluation</strong> tab.</p>
			<p>In the following screenshot, you can see the evaluation metrics of the BigQuery ML model:</p>
			<div>
				<div id="_idContainer140" class="IMG---Figure">
					<img src="image/B16722_09_010.jpg" alt="Figure 9.10 – The Evaluation tab of the matrix factorization model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.10 – The Evaluation tab of the matrix factorization model</p>
			<p>Since <a id="_idIndexMarker471"/>the value of <strong class="bold">Mean squared error</strong> is very low, we can be satisfied with the results that have been achieved by our matrix factorization model.</p>
			<p>In this section, we learned how to access the performance indicators of our recommendation model. Now, let's use the recommendation model to find the best products to suggest to our customers.</p>
			<h1 id="_idParaDest-141"><a id="_idTextAnchor143"/>Using the matrix factorization model</h1>
			<p>In this <a id="_idIndexMarker472"/>section, we'll test the matrix factorization model to get the recommended products for the users of our website.</p>
			<p>To use our BigQuery ML model, we'll use the <strong class="source-inline">ML.RECOMMEND</strong> function while specifying the parameters for our prediction.</p>
			<p>The recommendation engine does not need to take any additional input parameters besides the model itself. If the model has one input column, the model will only return the recommendations for the rows in the input. If no input values are provided, the model will apply the prediction for each combination of users and items in the original dataset.</p>
			<p><strong class="source-inline">ML.RECOMMEND</strong> returns three columns:</p>
			<ul>
				<li>A column that represents the user. In our implementation, this is identified by the <strong class="source-inline">fullVisitorID</strong> column.</li>
				<li>A field dedicated to the item that is recommended to a specific user. In our case, this is represented by the <strong class="source-inline">purchased_product_id</strong> column.</li>
				<li>A third column that represents the predicted rating in the case of an explicit matrix factorization model. If the model is implicit, as in our case, the field stores the predicted confidence of the recommendation.</li>
			</ul>
			<p>Let's execute <a id="_idIndexMarker473"/>the following query to materialize a table that contains all the recommendations that have been generated by our matrix factorization model: </p>
			<p class="source-code">CREATE OR REPLACE TABLE `09_recommendation_engine.product_recommendations` AS</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">      DISTINCT fullVisitorID, purchased_product_id, predicted_quantity_confidence</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">      ML.RECOMMEND(MODEL`09_recommendation_engine.purchase_recommender`,</p>
			<p class="source-code">        (</p>
			<p class="source-code">        SELECT</p>
			<p class="source-code">          fullVisitorID</p>
			<p class="source-code">        FROM</p>
			<p class="source-code">          `09_recommendation_engine.product_purchases` ));</p>
			<p>The query creates a new table called <strong class="source-inline">product_recommendations</strong> that stores the <strong class="source-inline">DISTINCT</strong> couples of users and items. In our case, the couples are composed of the <strong class="source-inline">fullVisitorID</strong> and <strong class="source-inline">purchased_product_id</strong> columns.</p>
			<p>For each <a id="_idIndexMarker474"/>couple, the <strong class="source-inline">ML.RECOMMEND</strong> function also returns a predicted confidence that expresses the probability that a specific user has interest in a product in the e-commerce catalog. </p>
			<p>Now that we have the output of our recommendation engine, let's learn how to use this data from a business perspective.</p>
			<h1 id="_idParaDest-142"><a id="_idTextAnchor144"/>Drawing business conclusions</h1>
			<p>Now that we've applied our BigQuery ML model, let's learn how the generated results can be <a id="_idIndexMarker475"/>used from a business perspective to improve the effectiveness of our sales strategy.</p>
			<p>From the <strong class="source-inline">product_recommendations</strong> table, we can extract relevant information that we can use to improve our marketing campaigns or advertising strategy, and then target the users with higher propensity to buy a specific product.</p>
			<p>For example, by executing the following query, we can extract the first <strong class="source-inline">100</strong> users with the highest propensity to buy a specific product from our e-commerce portal:</p>
			<p class="source-code">SELECT *</p>
			<p class="source-code">FROM</p>
			<p class="source-code">    `09_recommendation_engine.product_recommendations`</p>
			<p class="source-code">ORDER BY predicted_quantity_confidence DESC</p>
			<p class="source-code">LIMIT 100;</p>
			<p>Executing this SQL statement returns the following result:</p>
			<div>
				<div id="_idContainer141" class="IMG---Figure">
					<img src="image/B16722_09_011.jpg" alt="Figure 9.11 – The customers with the highest propensity to buy a specific product&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.11 – The customers with the highest propensity to buy a specific product</p>
			<p>The list <a id="_idIndexMarker476"/>that we've just extracted can be sent to our marketing office to create tailored marketing campaigns. Alternatively, it can be used in our e-commerce portal to recommend the most interesting products for a specific registered customer.</p>
			<h1 id="_idParaDest-143"><a id="_idTextAnchor145"/>Summary</h1>
			<p>In this chapter, we built a recommendation engine based on the matrix factorization algorithm. After we introduced the business scenario, we discovered what matrix factorization is and the difference between explicit and implicit models. Before diving into data exploration, we enabled BigQuery Flex Slots, which are necessary to train this category of ML algorithms.</p>
			<p>Then, we applied some analyses and data preparation steps to the sample data collected by Google from the Google Merchandise e-commerce portal. Here, we've focused on the fields that were actually required to build our BigQuery ML model.</p>
			<p>Next, we created our training table, which includes the purchases that were made by each user, along with the related quantity for each product.</p>
			<p>After that, we trained our matrix factorization model on the data that we'd prepared. When the model was trained, we evaluated its key performance indicators using SQL code and the BigQuery UI.</p>
			<p>Finally, we generated some recommendations using our new matrix factorization model and extracted a list of 100 customers that can be targeted with high propensity to buy a set of products.</p>
			<p>In the next chapter, we'll introduce the XGBoost algorithm for predicting binary values.</p>
			<h1 id="_idParaDest-144"><a id="_idTextAnchor146"/>Further resources</h1>
			<ul>
				<li><strong class="bold">Google Analytics 360 public dataset</strong>: <a href="https://console.cloud.google.com/marketplace/product/obfuscated-ga360-data/obfuscated-ga360-data ">https://console.cloud.google.com/marketplace/product/obfuscated-ga360-data/obfuscated-ga360-data</a></li>
				<li><strong class="bold">BigQuery ML create model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create ">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create</a></li>
				<li><strong class="bold">BigQuery ML evaluate model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate ">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery ML RECOMMEND</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-recommend ">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-recommend</a></li>
				<li><strong class="bold">BigQuery ML explicit matrix factorization example</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-mf-explicit-tutorial">https://cloud.google.com/bigquery-ml/docs/bigqueryml-mf-explicit-tutorial</a></li>
				<li><strong class="bold">BigQuery ML implicit matrix factorization example</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-mf-implicit-tutorial#implicit-model ">https://cloud.google.com/bigquery-ml/docs/bigqueryml-mf-implicit-tutorial#implicit-model</a></li>
			</ul>
		</div>
	</body></html>