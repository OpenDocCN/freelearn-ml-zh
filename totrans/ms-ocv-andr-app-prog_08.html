<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Troubleshooting and Best Practices"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Troubleshooting and Best Practices</h1></div></div></div><p>Errors are an inevitable part of the development cycle—be it a website or a mobile application. Sometimes they are logical, syntactical, or even careless mistakes. Spending a lot of time on debugging or correcting errors can distract you and affect your productivity significantly. In this chapter, we will discuss some common errors that developers face while building applications. This can significantly reduce the time spent on debugging your code. Also, it is very important to build applications that are efficient. The second half of this chapter will deal with a few guidelines that can increase the performance of your applications.</p><div class="section" title="Troubleshooting errors"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec43"/>Troubleshooting errors</h1></div></div></div><p>This <a id="id384" class="indexterm"/>section talks about different possible errors that developers face while building an Android application, such as permission errors, and how to use <span class="strong"><strong>Logcat</strong></span> to debug the code.</p><div class="section" title="Permission errors"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec59"/>Permission errors</h2></div></div></div><p>Every <a id="id385" class="indexterm"/>application in the Android ecosystem needs the user's permission to perform any critical operations involving user data, such as using<a id="id386" class="indexterm"/> the Internet or the camera, just to name a few. To ensure this, the application developers (in this case, us) have to request the user for permissions to perform any critical operations. Developers do this at the time of building the application by declaring all the required permissions in the Android project (more details on this will be explained in the following pages). While installing an application from the Play Store or otherwise, the user is prompted to grant or deny the permissions that the application requires.</p><p>Only when the user has granted all the permissions, the application can be installed on the mobile. This way, the user is aware of all the tasks, services, and features, such as using the Internet or storing data on your phone's memory, that the application is going to use.</p><p>How does Android <a id="id387" class="indexterm"/>ensure that all the necessary permissions have been granted? It is very likely that a developer might forget to declare a few permissions while building the application. To handle this, Android has a set of predefined tasks that require user permission before<a id="id388" class="indexterm"/> they can be performed. While generating the APK for the application, the code is checked for all such tasks and whether the corresponding permission has been declared by the developer. Once the code passes this test, a working APK is generated, which can be used to install the application on any Android phone. Even before generating the APK, which is while actually building the application, if a corresponding permission for the task has not been declared, a system exception is thrown by the debugger and the application is forced to close.</p><p>So that was all about how permissions work, but how and where do you declare these permissions, and what are some common permissions that are needed while building applications related to computer vision or even otherwise?</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>If you already know how to declare permissions, you can skip this part and move on to the next section, which is on commonly used permissions.</p></div></div><p>Permissions in an application are declared in the <code class="literal">AndroidManifext.xml</code> file of the Android project using the <code class="literal">&lt;uses-permission&gt;</code> tag. For example, if the application needs to connect to the Internet, the appropriate permission for it should be written like this:</p><div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.INTERNET"/&gt;</pre></div><p>The final <code class="literal">AndroidManifest.xml</code> file should look like this:</p><div class="informalexample"><pre class="programlisting">&lt;manifest 
    package="com.example.Application"&gt;

    &lt;application android:allowBackup="true" android:label="@string/app_name"
        android:icon="@mipmap/ic_launcher" android:theme="@style/AppTheme"&gt;

        &lt;activity
            android:name="com.example.Application.MainActivity"
            android:label="@string/app_name" &gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MAIN" /&gt;
                &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;

    &lt;/application&gt;
    &lt;uses-permission android:name="android.permission.INTERNET"/&gt;
&lt;/manifest&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>Note: The permission is added within the <code class="literal">&lt;application&gt;</code> tag and not inside the <code class="literal">&lt;activity&gt;</code> tag.</p></div></div><p>After <a id="id389" class="indexterm"/>declaring this, your application will be allowed to <a id="id390" class="indexterm"/>use your phone's Internet connection.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>For more information on system and user permissions, refer to <a class="ulink" href="http://developer.android.com/guide/topics/security/permissions.html">http://developer.android.com/guide/topics/security/permissions.html</a>.</p></div></div><p>Let's now move on to some of the common permissions that an Android application may require.</p><div class="section" title="Some common permissions"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec23"/>Some common permissions</h3></div></div></div><p>The<a id="id391" class="indexterm"/> following are some of the common permissions that are used while building an application:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Permission to use the Internet</strong></span>: This permission is needed when the application wants to access the Internet or even if it wants to create any network sockets:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.INTERNET"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Read/Write to external storage</strong></span>: These permissions are needed when the application wants to read from the phone's internal memory or an SD card:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Accessing the device camera</strong></span>: This <a id="id392" class="indexterm"/>permission is needed when the application wants to access the device camera for taking a picture or a video:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.CAMERA"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Setting the orientation of the screen</strong></span>: This permission is needed when the application wants to change the orientation of the screen from landscape to portrait and vice versa:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.SET_ORIENTATION"/&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Reading the logs</strong></span>: This allows an application to read the low-level system log files. This proves to be helpful when debugging an application:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.READ_LOGS"/&gt;</pre></div></li></ul></div><p>These were some of the common permissions that are needed. Some other permissions, such as using NFC, Bluetooth, clearing cache files, are also needed depending on the requirement of the application.</p></div></div><div class="section" title="Debugging code using Logcat"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec60"/>Debugging code using Logcat</h2></div></div></div><p>As mentioned <a id="id393" class="indexterm"/>earlier, the act of debugging code forms a major part of the development cycle and there is nothing better than having a tool that makes debugging easier. Logcat is one such tool that helps you put print-like statements in your code to check the variable values or output of certain functions. It is difficult to debug an Android application because it's on your phone and not on your computer.</p><p>The <code class="literal">Log</code> class in Android helps you print out messages to Logcat. It also provides you with different logging methods, such as <code class="literal">verbose</code>, <code class="literal">warn</code>, <code class="literal">debug</code>, <code class="literal">error</code>, and <code class="literal">information</code>. The following are the method definitions for logging to Logcat:</p><div class="informalexample"><pre class="programlisting">v(String, String) (verbose)
d(String, String) (debug)
i(String, String) (information)
w(String, String) (warning)
e(String, String) (error)</pre></div><p>An example of how to use the <code class="literal">Log</code> class is shown in the following code. This code has been taken <a id="id394" class="indexterm"/>from <a class="ulink" href="https://developer.android.com/tools/debugging/debugging-studio.html">https://developer.android.com/tools/debugging/debugging-studio.html</a>:</p><div class="informalexample"><pre class="programlisting">import android.util.Log;
public class MyActivity extends Activity {
    private static final String TAG = MyActivity.class.getSimpleName();
    ...
    @Override
    public void onCreate(Bundle savedInstanceState) {
        if (savedInstanceState != null) {
            Log.d(TAG, "onCreate() Restoring previous state");
            /* restore state */
        } else {
            Log.d(TAG, "onCreate() No saved state available");
            /* initialize app */
        }
    }
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>For<a id="id395" class="indexterm"/> more <a id="id396" class="indexterm"/>information on Logcat and the <code class="literal">Log</code> class, refer to <a class="ulink" href="https://developer.android.com/tools/debugging/debugging-log.html">https://developer.android.com/tools/debugging/debugging-log.html</a>.</p></div></div></div></div></div>
<div class="section" title="Best practices"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec44"/>Best practices</h1></div></div></div><p>A mobile platform<a id="id397" class="indexterm"/> is not as powerful as a personal computer and hence requires developers to be extra cautious while building applications for mobile devices. A badly written code can make your application sluggish, hence, it is very important to write the code while keeping in mind the resource constraints of a mobile device, such as limited RAM, limited processing capabilities, and small cache size.</p><p>Here are a list of things that can affect an application's performance and should be taken care of while building an application:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Memory leaks</strong></span>: It is<a id="id398" class="indexterm"/> important to manage variables in the code properly. Because most of the code is written in Java, the developers need not spend much time on handling memory, as Java does this explicitly. While using C/C++, it becomes extremely important to handle variables in your code.</li><li class="listitem" style="list-style-type: disc"> <span class="strong"><strong>Duplicate data</strong></span>: While <a id="id399" class="indexterm"/>handling large amounts of data in applications that use datasets to train machine learning algorithms, we should avoid having multiple copies of the same data in different forms. For example, if we have an image in the form of a Mat object, and we copy that object to a 2D integer array, then we should make sure to delete the Mat object, as it is no longer needed and uses the space unnecessarily. Doing this not only helps your application, but also other applications that are running in the background. The more free cache space—the more the number of background processes that can run.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Network usage</strong></span>: This is<a id="id400" class="indexterm"/> again a very important point. Many applications need to exchange data from a central server or even with other mobile phones using the Internet. It becomes very important to minimize the amount of data that is being exchanged between these devices for two reasons: First, the lesser the amount of data that needs to be transferred, the quicker the transfer time. This will make the app more responsive and the data usage will be lesser (data usage can be very costly at times). Second, it will reduce the amount of battery consumed by your mobile device.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Limited computational capacity</strong></span>: Avoid <a id="id401" class="indexterm"/>unnecessary and redundant computations. For example, if your application performs some calculations on an array in multiple iterations and some calculations are repeated across different iterations, try to combine these calculations and store the result in a temporary variable so that it can be used across multiple iterations (without having to compute the result again). An important thing to note here is the trade-off between the computational capacity and memory capacity. It may not be possible to store every calculation that might be reused somewhere in the application again. It depends a lot on how the application is designed.</li></ul></div><p>The preceding list is not exhaustive. There are a lot of other important things that need to be taken care of while building your application, such as handling images (for multimedia applications), transferring data between activities, and distributing work between your mobile and server (cloud infrastructure), which are discussed in the following pages in detail.</p><div class="section" title="Handling images in Android"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec61"/>Handling images in Android</h2></div></div></div><p>Have you<a id="id402" class="indexterm"/> ever wondered how Android applications <a id="id403" class="indexterm"/>are able to load so many images and yet work smoothly? In this section, we will take a look at how we can load images into our applications and process them, without compromising on the performance of the applications.</p><div class="section" title="Loading images"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec24"/>Loading images</h3></div></div></div><p>In <a id="id404" class="indexterm"/>many applications, we need to load images from the phone's memory; for example, in applications such as Photo Editor or activities with a lot of thumbnails. The problem in doing so is the amount of memory required to load these images into the application. A lot of times even the <code class="literal">ImageView</code> control is not able to load the image because of memory constraints. Hence, to avoid such issues, it is always better to reduce the size of the picture before loading, and Android APIs provide you with an easy way of doing this.</p><p>The following is the code used to compress or reduce the image size before loading it into the application:</p><div class="informalexample"><pre class="programlisting">public static int calculateInSampleSize(
            BitmapFactory.Options options, int reqWidth, int reqHeight) {
    // Raw height and width of image
    final int height = options.outHeight;
    final int width = options.outWidth;
    int inSampleSize = 1;

    if (height &gt; reqHeight || width &gt; reqWidth) {

        final int halfHeight = height / 2;
        final int halfWidth = width / 2;

        // Calculate the largest inSampleSize value that is a power of 2 and keeps both
        // height and width larger than the requested height and width.
        while ((halfHeight / inSampleSize) &gt; reqHeight
                &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) {
            inSampleSize *= 2;
        }
    }

    return inSampleSize;
}</pre></div></div><div class="section" title="Processing images"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec25"/>Processing images</h3></div></div></div><p>There<a id="id405" class="indexterm"/> are many multimedia applications available on the market that provide users with a variety of options, ranging from changing the brightness of an image, cropping, resizing, and so on. It is very important for such applications to process images efficiently, which means that this should not affect the user experience and the application should not be sluggish. To avoid such issues, Android allows the developers to create multiple threads other than the main UI thread that can be used to do computationally expensive tasks in the background. Doing this does not affect the UI thread of your application and does not make the application look slow.</p><p>An easy way of offloading computations on non-UI threads is to use <code class="literal">ASyncTasks</code>. The following is an example that illustrates how to work with <code class="literal">ASyncTasks</code>. (This code has been taken from <a class="ulink" href="http://developer.android.com/training/displaying-bitmaps/process-bitmap.html">http://developer.android.com/training/displaying-bitmaps/process-bitmap.html</a>):</p><div class="informalexample"><pre class="programlisting">class BitmapWorkerTask extends AsyncTask&lt;Integer, Void, Bitmap&gt; {
    private final WeakReference&lt;ImageView&gt; imageViewReference;
    private int data = 0;

    public BitmapWorkerTask(ImageView imageView) {
        // Use a WeakReference to ensure the ImageView can be garbage collected
        imageViewReference = new WeakReference&lt;ImageView&gt;(imageView);
    }

    // Decode image in background.
    @Override
    protected Bitmap doInBackground(Integer... params) {
        data = params[0];
        return decodeSampledBitmapFromResource(getResources(), data, 100, 100));
    }

    // Once complete, see if ImageView is still around and set bitmap.
    @Override
    protected void onPostExecute(Bitmap bitmap) {
        if (imageViewReference != null &amp;&amp; bitmap != null) {
            final ImageView imageView = imageViewReference.get();
            if (imageView != null) {
                imageView.setImageBitmap(bitmap);
            }
        }
    }
}</pre></div></div></div><div class="section" title="Handling data between multiple activities"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec62"/>Handling data between multiple activities</h2></div></div></div><p>In this <a id="id406" class="indexterm"/>section, we will take a <a id="id407" class="indexterm"/>look at the different ways of sharing data across multiple activities in an efficient manner. There are different ways of achieving this, and each of them have their own pros and cons.</p><p>Here are a few ways to exchange data across activities:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Transferring data via Intent</li><li class="listitem" style="list-style-type: disc">Using static fields</li><li class="listitem" style="list-style-type: disc">Using a database or a file</li></ul></div><div class="section" title="Transferring data via Intent"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec26"/>Transferring data via Intent</h3></div></div></div><p>This is one<a id="id408" class="indexterm"/> of the most common ways of exchanging information across activities in Android.</p><p>A new activity in Android is launched using the <a id="id409" class="indexterm"/>
<code class="literal">Intent</code> class. The <code class="literal">Intent</code> class allows you to send the data as key-value pairs as extras to the activity that is being launched. An example demonstrating this is as follows:</p><div class="informalexample"><pre class="programlisting">public void launchNewActivity () {
  Intent intent = new Intent(this, NewActivity.class);
  intent.putExtra("Message", "Sending a string to New Activity");
  startActivity(intent);
}</pre></div><p>In the preceding code, <code class="literal">NewActivity</code> is the name of the new activity that is being launched. The <code class="literal">putExtra</code> function takes the key and the value as the first and second argument, respectively.</p><p>The next step is to retrieve the data in the launched activity. The code for doing this is as follows:</p><div class="informalexample"><pre class="programlisting">Intent intent = getIntent();
String message = intent.getStringExtra("Message");</pre></div><p>The <code class="literal">getStringExtra</code> function gets the value that corresponds to the key passed as an argument in the function; in this case, <code class="literal">Message</code>.</p></div><div class="section" title="Using static fields"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec27"/>Using static fields</h3></div></div></div><p>Another easy way<a id="id410" class="indexterm"/> of exchanging data between activities in Android is using static fields. The main idea behind using static fields is that they are persistent throughout the life of the program and they do not need any object to reference them.</p><p>Here is an example of a class with static fields that can be used for exchanging data:</p><div class="informalexample"><pre class="programlisting">public class StorageClass {
  private static String data;
  public static String getData() {return data;}
  public static String setData(String data) {this.data = data;}
}</pre></div><p>The <code class="literal">StorageClass</code> function has a static field data that will store the information that has to be transferred to the new activity.</p><p>From the launching activity:</p><div class="informalexample"><pre class="programlisting">StorageClass.setData("Here is a message");</pre></div><p>In the launched activity:</p><div class="informalexample"><pre class="programlisting">String data = StorageClass.getData();</pre></div></div><div class="section" title="Using a database or a file"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec28"/>Using a database or a file</h3></div></div></div><p>This is one<a id="id411" class="indexterm"/> of the most complex ways of exchanging data between activities. The idea behind this is to set up a database using SQLite or any other database framework, and use this as a shared resource between activities. This <a id="id412" class="indexterm"/>method requires you to write more code. Also, writing and reading from a database can be slower than the other mentioned techniques. However, this technique is better when it comes to sharing large amounts of data and not just simple strings or integers. These are a few techniques that can be used for exchanging data across multiple activities in an efficient manner.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec45"/>Summary</h1></div></div></div><p>This chapter summarizes all the possible permissions and errors that a developer can face while building computer vision applications on an Android platform. We also looked at some best practices that can make the applications perform better. In the next chapter, we will try to consolidate everything that we learnt so far and build a simple, yet powerful, application from scratch.</p></div></body></html>