<html><head></head><body>
		<div id="_idContainer073">
			<h1 id="_idParaDest-61"><em class="italic"><a id="_idTextAnchor061"/>Chapter 4</em>: Predicting Numerical Values with Linear Regression</h1>
			<p>Predicting numerical measures could be extremely valuable for companies that need to plan their strategies in terms of budgets and resources. In most industries, predicting numbers could bring huge business advantages over their competition, and also enable new business scenarios.</p>
			<p>Born from the statistics discipline, linear regression became one of the most well-known machine learning techniques to perform this kind of task. In data science, linear regression models are used to find and quantify the relationships between causes and effects among different variables. This kind of model can be very useful in different business scenarios where it's needed to make predictions on numerical measures.</p>
			<p>In this chapter, we'll go through all the steps required to build a linear regression model while leveraging BigQuery ML, which simplifies and accelerates all the stages of the development process.</p>
			<p>By following a gradual and incremental approach, we'll cover the following topics:</p>
			<ul>
				<li>Introducing the business scenario</li>
				<li>Discovering linear regression</li>
				<li>Exploring and understanding the dataset</li>
				<li>Training the linear regression model</li>
				<li>Evaluating the linear regression model</li>
				<li>Utilizing the linear regression model</li>
				<li>Drawing business conclusions</li>
			</ul>
			<p>Let's get started!</p>
			<h1 id="_idParaDest-62"><a id="_idTextAnchor062"/>Technical requirements</h1>
			<p>This chapter requires you to access to a web browser and be able to leverage the following:</p>
			<ul>
				<li>A GCP account to access Google Cloud Console</li>
				<li>A GCP project to host the BigQuery datasets</li>
			</ul>
			<p>Now, let's dive into the analysis and development parts of our BigQuery ML linear regression model.</p>
			<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/2Rru9wA">https://bit.ly/2Rru9wA</a></p>
			<h1 id="_idParaDest-63"><a id="_idTextAnchor063"/>Introducing the business scenario</h1>
			<p>Imagine being one of the business analysts that works for a large company in New York City. Your company <a id="_idIndexMarker234"/>manages the nation's largest bike sharing program. It leverages 10,000 bikes and has realized 600 stations across different New York areas: Manhattan, Brooklyn, Queens, and Jersey City.</p>
			<p>The following is a picture from a bike sharing station in New York City:</p>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="image/B16722_04_001.jpg" alt="Figure 4.1 – New York City bike sharing service by Citi Bike&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.1 – New York City bike sharing service by Citi Bike</p>
			<p>Thanks to the vision and spirit of innovation of the company, huge amounts of data has been collected since 2013 and is still updated every day. This data contains a lot of information about the usage of the service and can be used to extract very interesting statistics.</p>
			<p>At the time of writing, the bike sharing service is available for all the customers that have signed up for a weekly, monthly, or yearly subscription. However, this is not accessible to and convenient for people that only stay for a few days in the city, such as tourists or business travelers.</p>
			<p>Considering the large number of people staying in New York City for only a few days, the company wants people to be able to rent a bike for only a few hours. For this reason, management is thinking about the possibility to enable a new pay-as-you-go rental option. </p>
			<p>The company's goal is <a id="_idIndexMarker235"/>to create a fully digital experience for this segment of customers and is thinking about the development of a new mobile application. If the customer indicates their departure and arrival station in advance, the mobile application should be able to predict the average trip time and a cost estimation for the ride. Thanks to this feature, the customers would know in advance if the trip time is compatible with their time schedule and if it's cheaper compared to other public transportation services. </p>
			<p>One of the managers of the company may ask you to use <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>) to develop the prediction system that will be introduced to the new mobile application. The ML system should predict the trip time of a bike rental using the data that has already been collected and stored in a BigQuery public dataset.</p>
			<p>Now that we've explained and understood the problem statement, let's take a look at the machine learning technique that we can use to predict a numerical value such as the duration of a trip.</p>
			<h1 id="_idParaDest-64"><a id="_idTextAnchor064"/>Discovering linear regression</h1>
			<p><strong class="bold">Linear regression</strong> is one <a id="_idIndexMarker236"/>of the simplest techniques that we can apply when we have a continuous numerical value to predict. It is a well-known algorithm <a id="_idIndexMarker237"/>that was initially introduced in statistics to analyze the correlation between different variables.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">In statistics, the term regression means that two variables are correlated. This term describes a <a id="_idIndexMarker238"/>cause and effect relationship. The cause is called the <strong class="bold">independent variable</strong>, while <a id="_idIndexMarker239"/>the effect is called the <strong class="bold">dependent variable</strong>. The dependent variable can be calculated as a function of the independent variable.</p>
			<p>The following diagram shows the graphical representation of a simple linear relationship between two variables:</p>
			<div>
				<div id="_idContainer061" class="IMG---Figure">
					<img src="image/B16722_04_002.jpg" alt="Figure 4.2 – Representation of simple linear regression&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.2 – Representation of simple linear regression</p>
			<p>A linear <a id="_idIndexMarker240"/>regression model tries to predict the label by finding the best linear relationship between the label and its features. If the machine learning model uses only one input variable, the model is defined as <strong class="bold">simple linear regression</strong>. If the ML model is based on multiple features, it is called <strong class="bold">multivariate linear regression</strong>.</p>
			<p>In our business <a id="_idIndexMarker241"/>scenario, the duration of a ride can be expressed with a numeric value, so we can use the linear regression approach to train our ML model. An example of simple linear regression is represented by the possibility to leverage only one variable, such as the distance between the start and stop station, to predict the outcome. Multivariate linear regression is based on multiple input variables. In our scenario this could be the distance between the start and stop stations, the age of the rider, and the day of the week when the rent occurred.</p>
			<p>Training a linear <a id="_idIndexMarker242"/>regression model means trying to find the values of the coefficients that can be used in the linear equation between the input variables, called features, and the output variable, called the label.</p>
			<p>We won't go through all the details of linear regression in this book, but we can mention some examples of linear relation to better understand this concept. In real life, we can find a lot of measures that can be well-estimated with linear regression, such as the following:</p>
			<ul>
				<li>The weight of a person is dependent on their height.</li>
				<li>The revenues of a company are a function of the number of customers.</li>
				<li>The quantity of fuel consumed by a plane is conditioned by the distance traveled.</li>
			</ul>
			<p>Now that we've learned the basics of linear regression, it's time to take a look at the dataset that we'll use to build our machine learning model.</p>
			<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/>Exploring and understanding the dataset</h1>
			<p>Before diving into the machine learning implementation, it's necessary to analyze the data that is <a id="_idIndexMarker243"/>available for our use case. Since machine learning training is based on examples, we need to clearly understand what data to consider and check the quality of the available records.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">Data scientists and business analysts spend a lot of time and resources getting a clear understanding of the datasets, checking their quality, and preparing them. Although these operations don't seem to be directly linked to the realization of a machine learning algorithm, they are essential if you wish to get solid results. The actual training of the model is the last mile of a longer journey that begins with comprehending data, the control of its quality, and preparing it.</p>
			<p>Let's start <a id="_idIndexMarker244"/>by getting a clear understanding of the information that we have in our dataset to build our use case.</p>
			<h2 id="_idParaDest-66"><a id="_idTextAnchor066"/>Understanding the data</h2>
			<p>To have a <a id="_idIndexMarker245"/>clear understanding of the dataset that we're going to be using for the implementation of this use case, we need to do the following:</p>
			<ol>
				<li>Log into Google Cloud Console and access the BigQuery user interface from the navigation menu:<div id="_idContainer062" class="IMG---Figure"><img src="image/B16722_04_003.jpg" alt="Figure 4.3 – Accessing the BigQuery service from the GCP console&#13;&#10;"/></div><p class="figure-caption">Figure 4.3 – Accessing the BigQuery service from the GCP console</p></li>
				<li>Create a new dataset under the project that we created in <a href="B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039"><em class="italic">Chapter 2</em></a>, <em class="italic">Setting Up Your GCP and BigQuery Environment</em>. To do this, we need to select our GCP project in the BigQuery navigation menu and click on the <strong class="bold">Create Dataset</strong> button. For this scenario, we'll choose the name <strong class="source-inline">04_nyc_bike_sharing</strong>, keeping all the other options with default values:<div id="_idContainer063" class="IMG---Figure"><img src="image/B16722_04_004.jpg" alt="Figure 4.4 – Creating the new BigQuery dataset to host the assets of our use case&#13;&#10;"/></div><p class="figure-caption">Figure 4.4 – Creating the new BigQuery dataset to host the assets of our use case</p><p>This dataset <a id="_idIndexMarker246"/>will contain our BigQuery ML model and all the intermediate tables that we'll create in the next steps of this chapter.</p><p>Once the dataset has been created, it will be visible in the BigQuery navigation menu, as shown in the following screenshot:</p><div id="_idContainer064" class="IMG---Figure"><img src="image/B16722_04_005.jpg" alt="Figure 4.5 – The new dataset is available within the GCP project and &#13;&#10;visible in the BigQuery navigation menu&#13;&#10;"/></div><p class="figure-caption">Figure 4.5 – The new dataset is available within the GCP project and visible in the BigQuery navigation menu</p></li>
				<li>Open the <strong class="bold">bigquery-public-data</strong> GCP project that hosts all the BigQuery public datasets and browse the items until you find the <strong class="bold">new_york_citibike</strong> dataset. In this public <a id="_idIndexMarker247"/>dataset, we will see two BigQuery tables: <strong class="bold">citibike_stations</strong> and <strong class="bold">citibike_trips</strong>. The first table is a registry of the stations of our bike sharing service, while the second one is the most interesting for our use case. We can start analyzing it now:<div id="_idContainer065" class="IMG---Figure"><img src="image/B16722_04_006.jpg" alt="Figure 4.6 – The New York Citi Bike Public dataset contains two &#13;&#10;different tables that can be used for our business scenario&#13;&#10;"/></div><p class="figure-caption">Figure 4.6 – The New York Citi Bike Public dataset contains two different tables that can be used for our business scenario</p></li>
				<li>Let's click on the <strong class="bold">citibike_trips</strong> table in the BigQuery navigation menu to access the schema of the table:<div id="_idContainer066" class="IMG---Figure"><img src="image/B16722_04_007.jpg" alt="Figure 4.7 – The structure of the citibike_trips table lists all the fields that &#13;&#10;can be used as labels and features&#13;&#10;"/></div><p class="figure-caption">Figure 4.7 – The structure of the citibike_trips table lists all the fields that can be used as labels and features</p><p>The table is well-documented and for each column, we can easily understand the name, the datatypes, and the meaning of the content.</p><p>This table <a id="_idIndexMarker248"/>contains relevant information for our use case: the <strong class="bold">tripduration</strong> field indicates the duration expressed in seconds of each bike rental. The value of <strong class="bold">tripduration</strong> is a numeric value and it's what we want to predict in our business scenario, so it will be our <strong class="bold">label</strong>.</p><p>All the other fields in the table are potential <strong class="bold">features</strong>. In fact, we have information about the starting and stopping stations, when the trip happened, and some insights into the customer, such as their age. All these columns could be good candidates for features since the position of the stations is directly related to the distance to go through and affects the duration of the trip. Also, the moment the ride begins could affect the duration because, on some, days the streets could be busier. Then, from a customer perspective, we might guess that young people ride faster than old people. From a schema perspective, we can conclude that this table represents a good dataset for developing our machine learning model, but we need to check our initial guesses further.</p></li>
				<li>As the next <a id="_idIndexMarker249"/>step, let's take a look at how many records we have in the table and if they're enough for our purposes.<p>Clicking on the <strong class="bold">Details</strong> tab, we can see that the table contains more than 58 million records: </p></li>
			</ol>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/B16722_04_008.jpg" alt="Figure 4.8 – The Details tab of the citibike_trips table shows the number of records that are available&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.8 – The Details tab of the citibike_trips table shows the number of records that are available</p>
			<p>We can be extremely confident about building an ML model with this huge amount of data.</p>
			<p>In this section, we understood how much information we can obtain just by analyzing the metadata provided by BigQuery in its user interface. Now, it's time to look at the actual data in this table and use it effectively.</p>
			<h2 id="_idParaDest-67"><a id="_idTextAnchor067"/>Checking the data's quality</h2>
			<p>The quality of data is fundamental to building robust machine learning models. An ML model learns <a id="_idIndexMarker250"/>from examples. If the examples present incorrect data, the model will inevitably learn from these errors and apply them during the actual usage.</p>
			<p>Let's start analyzing the dataset that will be used to build our ML model:</p>
			<ol>
				<li value="1">Frist of all, we will focus on the <strong class="source-inline">tripduration</strong> field. This is the column that we want to predict with our machine learning model and represents our label:<p class="source-code">SELECT COUNT(*)</p><p class="source-code">FROM</p><p class="source-code">  `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">WHERE</p><p class="source-code">  tripduration is NULL</p><p class="source-code">  OR tripduration&lt;=0;</p><p>This query statement counts the number of rows with a <strong class="source-inline">tripduration</strong> that's empty or less than zero. Although the table description reported that the dataset only contains trips with a duration greater than 1 minute, we can immediately notice that the outcome of this query is a number greater than 0. In fact, we can find more than five million records with the <strong class="source-inline">tripduration</strong> field not properly valued. Since we cannot train a model on an empty or wrong value of the label, we'll need to exclude these records from our use case.</p></li>
				<li>Next, we'll inspect the minimum and the maximum value of the <strong class="source-inline">tripduration</strong> field to evidence any outlier that can cause poor performance for our machine learning model:<p class="source-code">SELECT  MIN (tripduration)/60 minimum_duration_in_minutes,</p><p class="source-code">        MAX (tripduration)/60  maximum_duration_in_minutes</p><p class="source-code">FROM</p><p class="source-code">  `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">WHERE</p><p class="source-code">  tripduration is not NULL</p><p class="source-code">  AND tripduration&gt;0;</p><p>While the minimum rental time is an expected value of 1 minute, we can see that the <a id="_idIndexMarker251"/>maximum value is not compatible with the normal functionality of a bike sharing service. In fact, the maximum duration is more than 300,000 minutes, which is approximately equivalent to a rental period of more than 225 days.</p><p>In the following screenshot, you can see the result of the query:</p><div id="_idContainer068" class="IMG---Figure"><img src="image/B16722_04_009.jpg" alt="Figure 4.8 – The Details tab of the citibike_trips table shows the number of records that are available&#13;&#10;"/></div><p class="figure-caption">Figure 4.9 – The results of the query, evidencing the presence of outliers in the tripduration column</p><p>While preparing our datasets, we'll take all these factors into considerations to avoid any impact on the machine learning model.</p></li>
				<li>Then, we can apply a similar check to all the columns that are potential features of our machine learning model, excluding the records that present a non-significant value of <strong class="source-inline">tripduration</strong>:<p class="source-code">SELECT  COUNT(*)</p><p class="source-code">FROM</p><p class="source-code">  `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">WHERE</p><p class="source-code">  (tripduration is not NULL</p><p class="source-code">  AND tripduration&gt;0) AND (</p><p class="source-code">  starttime is NULL</p><p class="source-code">  OR start_station_name is NULL</p><p class="source-code">  OR end_station_name is NULL</p><p class="source-code">  OR start_station_latitude is NULL</p><p class="source-code">  OR start_station_longitude is NULL</p><p class="source-code">  OR end_station_latitude is NULL</p><p class="source-code">  OR end_station_longitude is NULL);</p><p>With this query statement, we're only focusing on the records with a rental duration <a id="_idIndexMarker252"/>greater than zero and not empty. The goal of the query is to check that all the other potential features are not empty fields.</p><p>In this case, the query returns a count of zero. For this reason, we can be confident that, excluding the rows where <strong class="source-inline">tripduration</strong> is <strong class="source-inline">NULL</strong>, we'll get meaningful values for the other columns. </p></li>
				<li>After that, we can analyze the <strong class="source-inline">birth_year</strong> column, which represents the birth year of the customer that is using the bike sharing service:<p class="source-code">SELECT  COUNT(*)</p><p class="source-code">FROM</p><p class="source-code">  `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">WHERE</p><p class="source-code">  (tripduration is not NULL</p><p class="source-code">  AND tripduration&gt;0)</p><p class="source-code">  AND ( birth_year is NULL);</p><p>The <strong class="source-inline">SELECT COUNT (*)</strong> statement looks for records where the customer's birth year is empty. The query filters the records where <strong class="source-inline">tripduration</strong> is <strong class="source-inline">NULL</strong> or less than zero.</p><p>Upon executing <a id="_idIndexMarker253"/>the query, we can immediately notice that there are more than five million records that contain a <strong class="source-inline">NULL</strong> value for <strong class="source-inline">birth_year</strong>. We'll need to filter these records in the following stages of our use case.</p><p class="callout-heading">Tip</p><p class="callout">To accelerate the process of composing a <strong class="source-inline">SELECT</strong> statement on a table and to avoid any typos, BigQuery allows you to use the <strong class="bold">Query Table</strong> button, which automatically generates a SQL stub where you need to choose only the fields to extract. In addition, you can also select the table name from the navigation menu, or the column name from the <strong class="bold">Schema</strong> tab, to automatically include the name of the selected object in the SQL query that you're composing.</p></li>
			</ol>
			<p>Now that we've performed some quality checks on our dataset, let's focus on segmenting the rows into three different tables: training, evaluation, and prediction.</p>
			<h2 id="_idParaDest-68"><a id="_idTextAnchor068"/>Segmenting the dataset</h2>
			<p>One of the main <a id="_idIndexMarker254"/>principles of developing a machine learning model is based on segmenting our dataset into train and evaluation sets, and then using the ML model on different records.</p>
			<p>Let's start segmenting the dataset by performing the following steps:</p>
			<ol>
				<li value="1">To understand how the data is distributed across the years and months, we can use the following query statement:<p class="source-code">SELECT</p><p class="source-code">  EXTRACT (YEAR FROM starttime) year,</p><p class="source-code">  EXTRACT (MONTH FROM starttime) month,</p><p class="source-code">  count(*) total</p><p class="source-code">FROM</p><p class="source-code">  `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">WHERE </p><p class="source-code">  EXTRACT (YEAR FROM starttime)=2017 OR</p><p class="source-code">  EXTRACT (YEAR FROM starttime)=2018</p><p class="source-code">  AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">  AND  birth_year is not NULL</p><p class="source-code">  AND birth_year &lt; 2007</p><p class="source-code">GROUP BY</p><p class="source-code">  year, month </p><p class="source-code">ORDER BY</p><p class="source-code">  year, month asc;</p><p>The <strong class="source-inline">SELECT</strong> statement extracts the year and the month from the <strong class="source-inline">starttime</strong> field, which indicates the exact moment when the bike trip started.</p><p>To extract a <a id="_idIndexMarker255"/>portion of the entire timestamp, we can use the <strong class="source-inline">EXTRACT</strong> function, which accepts a parameter such as <strong class="source-inline">YEAR</strong>, <strong class="source-inline">MONTH</strong>, <strong class="source-inline">QUARTER</strong>, <strong class="source-inline">WEEK</strong>, <strong class="source-inline">DAYOFYEAR</strong>, or <strong class="source-inline">DAYOFWEEK</strong> as input, followed by the <strong class="source-inline">FROM</strong> keyword and the field that contains the date expression.</p><p>The query already excludes all the bad records that we found in the previous section and focuses on <strong class="source-inline">2017</strong> and <strong class="source-inline">2018</strong>.</p><p>To exclude outliers in the <strong class="source-inline">tripduration</strong> column, we're only taking into consideration the rows with a minimum rental time of 3 minutes and a maximum of 3 hours.</p><p>We can also add a filter to the year of birth of our customers, by filtering all the records with an empty <strong class="source-inline">birth_year</strong> and ignoring all the customers born after <strong class="source-inline">2007</strong>.</p><p>The query counts <a id="_idIndexMarker256"/>the number of rows segmenting the results per year and month with the <strong class="source-inline">GROUP BY</strong> clause and orders these periods in ascending mode, as specified in the <strong class="source-inline">ORDER BY</strong> clause. </p><p>In the following screenshot, you can see the query's result:</p><div id="_idContainer069" class="IMG---Figure"><img src="image/B16722_04_010.jpg" alt="Figure 4.10 – The results of the query describe the segmentation on a monthly basis&#13;&#10;"/></div><p class="figure-caption">Figure 4.10 – The results of the query describe the segmentation on a monthly basis</p><p>From the results of the query, we can see that the dataset goes from April 2017 until May 2018. We can use a rule of thumb and keep 80% of the data for training, 10% for evaluation, and the remaining 10% for prediction. By applying this rule to our dataset, we'll use the first 11 months for the training stage, the following 2 months for the evaluation stage, and the last month for the prediction stage.</p></li>
				<li>Applying what we <a id="_idIndexMarker257"/>decided on in the previous step, let's create a table that contains only the rows that will be used to train our BigQuery ML model:<p class="source-code">CREATE OR REPLACE TABLE `04_nyc_bike_sharing.training_table` AS</p><p class="source-code">  SELECT </p><p class="source-code">    tripduration/60 tripduration,</p><p class="source-code">                        starttime,</p><p class="source-code">                        stoptime,</p><p class="source-code">                        start_station_id,</p><p class="source-code">                        start_station_name, </p><p class="source-code">                        start_station_latitude,</p><p class="source-code">                        start_station_longitude, </p><p class="source-code">                        end_station_id,</p><p class="source-code">                        end_station_name, </p><p class="source-code">                        end_station_latitude,</p><p class="source-code">                        end_station_longitude, </p><p class="source-code">                        bikeid,</p><p class="source-code">                        usertype,</p><p class="source-code">                        birth_year, </p><p class="source-code">                        gender,</p><p class="source-code">                        customer_plan</p><p class="source-code">  FROM</p><p class="source-code">    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">  WHERE </p><p class="source-code">    (</p><p class="source-code">       (EXTRACT (YEAR FROM starttime)=2017 AND</p><p class="source-code">         (EXTRACT (MONTH FROM starttime)&gt;=04 OR</p><p class="source-code">           EXTRACT (MONTH FROM starttime)&lt;=10))</p><p class="source-code">        OR (EXTRACT (YEAR FROM starttime)=2018 AND</p><p class="source-code">          (EXTRACT (MONTH FROM starttime)&gt;=01 OR</p><p class="source-code">            EXTRACT (MONTH FROM starttime)&lt;=02))</p><p class="source-code">    )</p><p class="source-code">    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">    AND birth_year is not NULL</p><p class="source-code">    AND birth_year &lt; 2007;</p><p>The result <a id="_idIndexMarker258"/>of the query is stored in the new <strong class="source-inline">`04_nyc_bike_sharing.training_table`</strong> table that we created to support the following steps of our use case.</p><p>The <strong class="source-inline">SELECT</strong> statement extracts all the fields inside the <strong class="source-inline">citibike_trips</strong> table from the BigQuery public dataset, converting the value of <strong class="source-inline">tripduration</strong> from seconds into minutes.</p><p>The <strong class="source-inline">WHERE</strong> clause allows us to consider only the months that we want to use for the training stage. The time frame goes from April 2017 to February 2018. We've also applied the filters that come from the data quality checks in the same clause.</p></li>
				<li>Now that we've delimited the training dataset, we can create another table dedicated to <a id="_idIndexMarker259"/>the records that will be used to evaluate our machine learning model:<p class="source-code">CREATE OR REPLACE TABLE `04_nyc_bike_sharing.evaluation_table` AS</p><p class="source-code">SELECT </p><p class="source-code">    tripduration/60 tripduration,</p><p class="source-code">                       starttime,</p><p class="source-code">                       stoptime,</p><p class="source-code">                       start_station_id,</p><p class="source-code">                       start_station_name, </p><p class="source-code">                       start_station_latitude,</p><p class="source-code">                       start_station_longitude, </p><p class="source-code">                       end_station_id,</p><p class="source-code">                       end_station_name, </p><p class="source-code">                       end_station_latitude,</p><p class="source-code">                       end_station_longitude, </p><p class="source-code">                       bikeid,</p><p class="source-code">                       usertype,</p><p class="source-code">                       birth_year, </p><p class="source-code">                       gender, </p><p class="source-code">                       customer_plan</p><p class="source-code">              FROM</p><p class="source-code">    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE </p><p class="source-code">    (EXTRACT (YEAR FROM starttime)=2018 AND </p><p class="source-code">      (EXTRACT (MONTH FROM starttime)=03 OR </p><p class="source-code">        EXTRACT (MONTH FROM starttime)=04))</p><p class="source-code">    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">    AND  birth_year is not NULL</p><p class="source-code">    AND birth_year &lt; 2007;</p><p>The query is very similar to the statement that was used to create the training table. The only <a id="_idIndexMarker260"/>difference is related to the period we selected in the <strong class="source-inline">WHERE</strong> clause. For <strong class="source-inline">evaluation_table</strong>, we've focused our <strong class="source-inline">SELECT</strong> statement on the records from March and April 2018, which were previously excluded from the training table.</p></li>
				<li>Using the same approach, we can also create the table that will be used to test our machine learning model: <p class="source-code">CREATE OR REPLACE TABLE `04_nyc_bike_sharing.prediction_table` AS</p><p class="source-code">SELECT </p><p class="source-code">    tripduration/60 tripduration,</p><p class="source-code">                    starttime,</p><p class="source-code">                    stoptime,</p><p class="source-code">                    start_station_id,</p><p class="source-code">                    start_station_name, </p><p class="source-code">                    start_station_latitude,</p><p class="source-code">                    start_station_longitude, </p><p class="source-code">                    end_station_id,</p><p class="source-code">                    end_station_name, </p><p class="source-code">                    end_station_latitude,</p><p class="source-code">                    end_station_longitude, bikeid,</p><p class="source-code">                    usertype, birth_year, gender, </p><p class="source-code">                    customer_plan</p><p class="source-code">FROM</p><p class="source-code">    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">WHERE </p><p class="source-code">    EXTRACT (YEAR FROM starttime)=2018</p><p class="source-code">    AND EXTRACT (MONTH FROM starttime)=05</p><p class="source-code">    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">    AND birth_year is not NULL</p><p class="source-code">    AND birth_year &lt; 2007;</p><p>The query will apply the necessary logic but will only take the month of May 2018 into consideration.</p></li>
			</ol>
			<p>Now that we've <a id="_idIndexMarker261"/>segmented our dataset and we're clear about which records to use for the training, evaluation, and test phases, let's dive into the ML model's creation.</p>
			<h1 id="_idParaDest-69"><a id="_idTextAnchor069"/>Training the linear regression model</h1>
			<p>Training a BigQuery ML model is not a one-shot operation, but it's a process that can require multiple <a id="_idIndexMarker262"/>attempts and recycles to get closer to the final goal of developing an effective asset with good performance, according to the requirements of the business scenario. For our use case, we'll go try to improve the performance of our ML model multiple times. Let's get started:</p>
			<ol>
				<li value="1">First, let's start training a new machine learning model named <strong class="source-inline">trip_duration_by_stations</strong>:<p class="source-code">CREATE OR REPLACE MODEL `04_nyc_bike_sharing.trip_duration_by_stations`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='linear_reg') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `04_nyc_bike_sharing.training_table`;</p><p>In this statement, we can notice the <strong class="source-inline">CREATE OR REPLACE MODEL</strong> keyword, which is used to create a new model. This keyword is followed by the identifier of the model, which is represented by concatenating the dataset and ML model name.</p><p>After these first lines, we have the <strong class="source-inline">OPTIONS</strong> keyword, where the type of machine <a id="_idIndexMarker263"/>learning model to use is specified. In this case, we're using a linear regression identified by <strong class="source-inline">model_type='linear_reg'</strong>.</p><p>After <strong class="source-inline">OPTIONS</strong>, we need to specify the set of records that the ML model will be trained on. For this first attempt, we will decide to use only two features: the names of the start and of stop stations of the bike trip.</p><p>With the <strong class="source-inline">as label</strong> keyword, we are instructing BigQuery to use <strong class="source-inline">tripduration</strong> as the label for our machine learning model. As an alternative, it is possible to include the label among the list of <strong class="source-inline">OPTIONS</strong> with the <strong class="source-inline">INPUT_LABEL_COLS</strong> keyword, as shown in the following snippet of code:</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='linear_reg'</p><p class="source-code"> input_label_cols=['tripduration'])</p><p>After a few seconds, the BigQuery ML model will be created and available in the navigation menu, under the <strong class="source-inline">04_nyc_bike_sharing</strong> dataset. Select the ML model and click on the <strong class="bold">Evaluation</strong> tab, where we will find some performance indicators for our brand-new ML model; that is, <strong class="source-inline">trip_duration_by_stations</strong>.</p><p>In this case, we'll focus our attention on <strong class="bold">Mean absolute error</strong>. This value represents the average distance between the actual value and the predicted value of the label.</p><p>As shown <a id="_idIndexMarker264"/>in the following screenshot, it's very close to 7 minutes:</p><div id="_idContainer070" class="IMG---Figure"><img src="image/B16722_04_011.jpg" alt="Figure 4.11 – The Evaluation tab shows some key performance indicators of the ML model&#13;&#10;"/></div><p class="figure-caption">Figure 4.11 – The Evaluation tab shows some key performance indicators of the ML model</p></li>
				<li>Now, let's try to enrich the ML model with other features that can bring additional value: <p class="source-code">CREATE OR REPLACE MODEL `04_nyc_bike_sharing.trip_duration_by_stations_and_day`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='linear_reg') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">    IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR</p><p class="source-code">          EXTRACT(DAYOFWEEK FROM starttime)=7, </p><p class="source-code">          true, false) is_weekend,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `04_nyc_bike_sharing.training_table`;</p><p>In this second model, we've added a new feature called <strong class="source-inline">is_weekend</strong>. This field is a <strong class="bold">boolean</strong> value that calculates and extracts the day of the week in which the bike rental happened. It is generated by an <strong class="source-inline">IF</strong> statement that returns <strong class="source-inline">true</strong> if the day is Sunday or Saturday, represented by the values <strong class="source-inline">1</strong> and <strong class="source-inline">7</strong>; otherwise, it's <strong class="source-inline">false</strong>.</p><p>If we check <a id="_idIndexMarker265"/>the mean absolute error of this new BigQuery ML model, we can notice that we've slightly improved the performance of our model with a value of 6.7784.</p></li>
				<li>Since we've had some improvements from adding more features, let's try including the age of the customer as a new parameter for our ML model:<p class="source-code">CREATE OR REPLACE MODEL </p><p class="source-code">  `04_nyc_bike_sharing.trip_duration_by_stations_day_age`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='linear_reg') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">  IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR</p><p class="source-code">        EXTRACT(DAYOFWEEK FROM starttime)=7, </p><p class="source-code">        true, false) is_weekend,</p><p class="source-code">  EXTRACT(YEAR FROM starttime)-birth_year as age,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `04_nyc_bike_sharing.training_table`;</p><p>Compared to the previous model, we've added the new <strong class="source-inline">age</strong> column, which is calculated as the difference between the year of <strong class="source-inline">starttime</strong> and the customer's birth year.</p><p>Once we've executed the query statement, we will see that the new <strong class="source-inline">age</strong> feature doesn't improve the performance of our ML model. This is because the mean absolute error is 6.9508. This value is better compared to our first attempt, but worse than the second.</p></li>
			</ol>
			<p>In this section, we created <a id="_idIndexMarker266"/>different ML models while trying to use different features in our dataset. Next, we will continue using the <strong class="source-inline">trip_duration_by_stations_and_day</strong> model, which, during the training phase, realized the best performance in terms of mean absolute error.</p>
			<p>Now, let's learn how to start the evaluation phase.</p>
			<h1 id="_idParaDest-70"><a id="_idTextAnchor070"/>Evaluating the linear regression model</h1>
			<p>For the evaluation stage of our BigQuery ML model, we'll use the <strong class="source-inline">ML.EVALUATE</strong> function and <a id="_idIndexMarker267"/>the table that we've expressly created to host the evaluation records. These are completely separate from the rows that are used during the training phase.</p>
			<p>Let's execute the following query to evaluate our ML model on the evaluation table: </p>
			<p class="source-code">SELECT</p>
			<p class="source-code">  *</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.EVALUATE(MODEL `04_nyc_bike_sharing.trip_duration_by_stations_and_day`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">          start_station_name,</p>
			<p class="source-code">          end_station_name,</p>
			<p class="source-code">          IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR </p>
			<p class="source-code">                EXTRACT(DAYOFWEEK FROM starttime)=7, </p>
			<p class="source-code">                true, false) is_weekend,</p>
			<p class="source-code">          tripduration as label</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">          `04_nyc_bike_sharing.evaluation_table`));</p>
			<p>The <strong class="source-inline">SELECT</strong> statement extracts all the fields returned by the <strong class="source-inline">ML.EVALUATE</strong> function. The evaluation function is applied to the <strong class="source-inline">`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</strong> model and on the rows that have been extracted from the <strong class="source-inline">evaluation_table</strong> table.</p>
			<p>The most internal <strong class="source-inline">SELECT</strong> extracts the same fields that were used to train the ML model as <a id="_idIndexMarker268"/>the features that are applying the same transformations, such as on the <strong class="source-inline">is_weekend</strong> field, which is calculated with the same logic as the training phase.</p>
			<p>The results of the query show a mean absolute error very close to 7 minutes, which is similar to the value of 6.7784 that was achieved during the training phase. For this reason, we can say that the ML model maintains its performance on a dataset different from the training one. We can say that the model is not affected by overfitting.</p>
			<p>In the following screenshot, you can see the performance indicators that have been extracted by the evaluation query:</p>
			<div>
				<div id="_idContainer071" class="IMG---Figure">
					<img src="image/B16722_04_012.jpg" alt="Figure 4.12 – The query results of the EVALUATE function show the ML key &#13;&#10;performance calculated on the evaluation table&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.12 – The query results of the EVALUATE function show the ML key performance calculated on the evaluation table</p>
			<p>Now that we've <a id="_idIndexMarker269"/>trained the model and we're also satisfied with the outcomes of the evaluation stage, let's learn how to apply our machine learning model to other records and get predictions.</p>
			<h1 id="_idParaDest-71"><a id="_idTextAnchor071"/>Utilizing the linear regression model</h1>
			<p>To use our BigQuery ML model, we'll use the <strong class="source-inline">ML.PREDICT</strong> function and the table that we've <a id="_idIndexMarker270"/>expressly created to host the records that we haven't used yet.</p>
			<p>The following query will predict the label using the data in <strong class="source-inline">prediction_table</strong>:</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">   tripduration as actual_duration,</p>
			<p class="source-code">   predicted_label as predicted_duration,</p>
			<p class="source-code">   ABS(tripduration - predicted_label) difference_in_min</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.PREDICT(MODEL `04_nyc_bike_sharing.trip_duration_by_stations_and_day`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">          start_station_name,</p>
			<p class="source-code">          end_station_name,</p>
			<p class="source-code">          IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR </p>
			<p class="source-code">                EXTRACT(DAYOFWEEK FROM starttime)=7, </p>
			<p class="source-code">                true, false) is_weekend,</p>
			<p class="source-code">          tripduration</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">          `04_nyc_bike_sharing.prediction_table`</p>
			<p class="source-code">    ))</p>
			<p class="source-code">    order by  difference_in_min asc;</p>
			<p>The query statement is composed of a <strong class="source-inline">SELECT</strong> keyword, which extracts the actual and the predicted duration of the rental. It calculates the difference in minutes and orders the results <a id="_idIndexMarker271"/>from the minimum to the maximum difference of minutes. To calculate the difference, we used the <strong class="source-inline">ABS</strong> function, which extracts the absolute value of a numeric.</p>
			<p>The <strong class="source-inline">ML.PREDICT</strong> function is applied to the <strong class="source-inline">SELECT</strong> statement, which extracts the features and the actual duration from <strong class="source-inline">prediction_table</strong>. This last field is only used for comparison with the predicted value and is not used to run the ML model.</p>
			<p>In the following screenshot, you can see the results of the query execution:</p>
			<div>
				<div id="_idContainer072" class="IMG---Figure">
					<img src="image/B16722_04_013.jpg" alt="Figure 4.13 – The query results of the PREDICT function show the actual and the predicted duration.&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.13 – The query results of the PREDICT function show the actual and the predicted duration.</p>
			<p>Now that we've applied our model, let's formulate some final considerations and provide the answers to our managers about the possibility of predicting the trip duration of a bike rental.</p>
			<h1 id="_idParaDest-72"><a id="_idTextAnchor072"/>Drawing business conclusions</h1>
			<p>In this section, we'll formulate some final considerations using the results that we got from applying our ML model.</p>
			<p>By enriching the <a id="_idIndexMarker272"/>previous query with a parent <strong class="source-inline">SELECT COUNT</strong> statement, we can identify how many predictions are less than <strong class="source-inline">15</strong> minutes away from the actual value.</p>
			<p>Let's execute the following query to calculate how often the trip duration predictions are far from the actual values:</p>
			<p class="source-code">SELECT COUNT (*)</p>
			<p class="source-code">FROM (</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">   tripduration as actual_duration,</p>
			<p class="source-code">   predicted_label as predicted_duration,</p>
			<p class="source-code">   ABS(tripduration - predicted_label) difference_in_min</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.PREDICT(MODEL `04_nyc_bike_sharing.trip_duration_by_stations_and_day`,</p>
			<p class="source-code">    (</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">          start_station_name,</p>
			<p class="source-code">          end_station_name,</p>
			<p class="source-code">          IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR </p>
			<p class="source-code">                EXTRACT(DAYOFWEEK FROM starttime)=7, </p>
			<p class="source-code">                true, false) is_weekend,</p>
			<p class="source-code">          tripduration</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">          `04_nyc_bike_sharing.prediction_table`</p>
			<p class="source-code">    ))</p>
			<p class="source-code">    order by difference_in_min asc) where difference_in_min&lt;=15;</p>
			<p>The result of the <strong class="source-inline">SELECT COUNT</strong> query returns a value of 1,548,370 predictions, with a difference between the predicted and the actual value being less than <strong class="source-inline">15</strong> minutes.</p>
			<p>Considering that <a id="_idIndexMarker273"/>the total size of the <strong class="source-inline">prediction_table</strong> table is 1,728,078, we can say that in 89.6% of cases, our machine learning model is able to predict the trip duration with a gap that's less than 15 minutes.</p>
			<p>For the reasons we expressed previously, we can suggest to management to start with a quarterly fare for the new on-demand and pay-as-you-go pricing model. With this strategy, when a customer picks up a bike from a start station and specifies its destination on the mobile application on a specific day of the week, our model will be able to predict <a id="_idIndexMarker274"/>the exact fare of the ride with a mean absolute error of about 7 minutes. The 89.6% the application will provide a good estimation of the price to our customer.</p>
			<h1 id="_idParaDest-73"><a id="_idTextAnchor073"/>Summary</h1>
			<p>In this chapter, we built our first machine learning use case based on a real-life scenario. After a brief introduction to the use case, we discovered what linear regression is and how it can be used to predict numerical values.</p>
			<p>Before diving into actually developing the machine learning model, we learned that having a clear understanding of the data and checking its quality is fundamental to getting effective machine learning models. To start from a solid foundation, we leveraged the BigQuery public dataset, which collects information about all the rentals for a bike sharing service in New York City.</p>
			<p>For training the model, we used different features to understand which variables are relevant to building our BigQuery ML model.</p>
			<p>Then, we chose one machine learning model to carry on to the evaluation stage. In this phase, we used the BigQuery evaluation function to verify that the machine learning model could also effectively work on new rows outside the training dataset.</p>
			<p>Finally, we applied our ML model to a third subset of records to predict the duration of each bike rental. We did this by leveraging the start and stop stations chosen by the user and the day of the week that the trip is happening on.</p>
			<p>We also calculated that 89% of them have a difference of less than 15 minutes compared to the actual duration of the trip. For this reason, we can conclude that we can provide a good user experience to our customers if the company applies a quarterly fare to our new pay-as-you-go offering.</p>
			<p>In the next chapter, we'll discover binary logistic regression and how to use it with BigQuery ML to predict boolean variables.</p>
			<h1 id="_idParaDest-74"><a id="_idTextAnchor074"/>Further reading</h1>
			<ul>
				<li><strong class="bold">NYC Bike Sharing Public Dataset</strong>: <a href="https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike">https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike</a></li>
				<li><strong class="bold">BigQuery ML Create Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create</a></li>
				<li><strong class="bold">BigQuery ML Evaluate Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery ML Predict</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict</a></li>
				<li><strong class="bold">BigQuery ML Linear Regression Example</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-natality">https://cloud.google.com/bigquery-ml/docs/bigqueryml-natality</a></li>
			</ul>
		</div>
	</body></html>