<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-208"><a id="_idTextAnchor217"/>14</h1>
<h1 id="_idParaDest-209"><a id="_idTextAnchor218"/>Survival Models</h1>
<p>In <em class="italic">Chapter 13</em><em class="italic">, Time-to-Event Variables</em>, we introduced the topics of survival analysis, censoring, and <strong class="bold">time-to-event</strong> (<strong class="bold">TTE</strong>) variables. In this chapter, we will provide an in-depth overview and walkthrough of the implementation of these techniques with respect to three primary model frameworks:</p>
<ul>
<li>Kaplan-Meier model</li>
<li>Exponential model</li>
<li>Cox Proportional Hazards model</li>
</ul>
<p>We will discuss how each approach provides probabilistic insight into the survival and hazard risk of study subjects using univariate Kaplan-Meier and exponential approaches as well as the multivariate Cox Proportional Hazards regression model. We’ll walk through examples using real data and discuss the results so that the reader understands how to assess performance and translate test output into useful information. Finally, we will show how to use the trained models to provide forecast probabilities for unseen data.</p>
<h1 id="_idParaDest-210"><a id="_idTextAnchor219"/>Technical requirements</h1>
<p>In this chapter, we use an additional Python library for survival analysis: <code>lifelines</code>. Please install the following versions of these libraries to run the provided code. Instructions for installing libraries can be found in <a href="B18945_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a><em class="italic">, Sampling </em><em class="italic">and Generalization</em>:</p>
<ul>
<li><code>lifelines== 0.27.4</code></li>
</ul>
<p>More information about <code>lifelines</code> can be found at this link:</p>
<p><a href="https://lifelines.readthedocs.io/en/latest/index.xhtml">https://lifelines.readthedocs.io/en/latest/index.xhtml</a></p>
<h1 id="_idParaDest-211"><a id="_idTextAnchor220"/>Kaplan-Meier model</h1>
<p>The <a id="_idIndexMarker1015"/>first model for survival analysis we will discuss is the <code>lifelines</code> library. Let’s get started.</p>
<h2 id="_idParaDest-212"><a id="_idTextAnchor221"/>Model definition</h2>
<p>The <a id="_idIndexMarker1016"/>Kaplan-Meier estimator is defined by the following formula:</p>
<p> ˆ S (t) = ∏ i:t i≤t  n i − d i _ n i </p>
<p>Here, n i is the number of subjects at risk just before time t, d i is the number of death events at time t, and  ˆ S (t) (the survival function) is the probability that life is longer than t. The Π symbol used in the formula is like the symbol Σ; however, Π indicates multiplication. This means that the preceding formula will result in a multiplication of fractions for each time step t. This means that the Kaplan-Meier estimator is a series of declining horizontal steps. To make this clear, let’s take a look at its application with some example data.</p>
<p>Let’s say that we have the following data, where the <code>duration</code> column represents how long a subject survived and the <code>death</code> column indicates whether a death was observed in the study. Let’s walk through the calculations for the Kaplan-Meier estimator for this data:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-9">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">duration</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">death</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><code>5</code></p>
</td>
<td class="No-Table-Style">
<p><code>1</code></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><code>7</code></p>
</td>
<td class="No-Table-Style">
<p><code>1</code></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><code>3.5</code></p>
</td>
<td class="No-Table-Style">
<p><code>1</code></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><code>8</code></p>
</td>
<td class="No-Table-Style">
<p><code>0</code></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><code>2</code></p>
</td>
<td class="No-Table-Style">
<p><code>1</code></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><code>5</code></p>
</td>
<td class="No-Table-Style">
<p><code>1</code></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.1 – Death and duration example data</p>
<p>Initially (at t = 0), all subjects are at risk, but no subjects have died. That means the current survival rate is 1. We calculate the value of the survival function at t = 0 as follows:</p>
<p> ˆ S (0) =  n 0 − d 0 _ n 0  =  6 − 0 _ 6  = 1</p>
<p>The <a id="_idIndexMarker1017"/>first event occurs at t = 2. At this point, all subjects (six subjects) are at risk just before the event, and one subject dies at this time. We calculate the current survival rate at this point, then multiply this value by all the previous values. The survival rate at t = 2 is given here:</p>
<p> n 2 − d 2 _ n 2  =  6 − 1 _ 6  ≈ 0.83</p>
<p>Then, we calculate the survival function at t = 2:</p>
<p> ˆ S (2) =  n 0 − d 0 _ n 0  * n 2 − d 2  ______________ n 2  =  6 − 0 _ 6  * 6 − 1  ___________ 6  ≈ 0.83</p>
<p>The next event occurs at t = 3.5. We repeat the process as outlined previously. However, there are only five subjects at risk at this point since one has already died. Thus, the current survival rate at time t = 3.5 is this:</p>
<p> n 3 − d 3 _ n 3  =  5 − 1 _ 5  = 0.8</p>
<p>Then, we calculate the survival function at this point:</p>
<p> ˆ S (3.5) =  n 0 − d 0  _ n 0  * n 2 − d 2  _ n 2  * n 3.5 − d 3.5   _____________  n 3.5  =  6 − 0 _ 6  * 6 − 1  _ 6  * 5 − 1  ___________ 5  ≈ 0.67</p>
<p>The next event occurs at t = 5, where two subjects die. At t = 5, there are four remaining subjects at risk, and two subjects die. Thus, we have a survival rate of 0.5 at t = 5. The new value of the survival function is calculated as follows:</p>
<p> ˆ S (5) = 1 * 0.83 * 0.67 * 0.5 ≈ 0.33</p>
<p>The final event occurs at t = 7. At this point, the survival rate is 0.5 and the value of the survival function at this point is approximately 0.167:</p>
<p> ˆ S (7) = 1 * 0.83 * 0.67 * 0.5 * 0.5 ≈ 0.167</p>
<p>Since our study ends here, this is the final value of the survival function, and the function value remains constant through the end of the study.</p>
<p>As you can see, this <a id="_idIndexMarker1018"/>survival model is simple to calculate. Notice also that we did not mention assumptions or underlying statistical distributions. The Kaplan-Meier estimator is a nonparametric survival model. As we discussed in <a href="B18945_05.xhtml#_idTextAnchor087"><em class="italic">Chapter 5</em></a><em class="italic">, Non-Parametric Tests</em>, this means it can be used as an alternative to parametric models when the data under analysis does not meet the assumptions of parametric models. The Kaplan-Meier estimator is a useful model to have in your tool belt for that reason.</p>
<p>Now that we have had a walkthrough of how this model works, let’s look at how to calculate the Kaplan-Meier estimator survival function with the <code>lifelines</code> package in Python.</p>
<h2 id="_idParaDest-213"><a id="_idTextAnchor222"/>Model example</h2>
<p>For this<a id="_idIndexMarker1019"/> example, we will use the <code>larynx</code> dataset from <code>lifelines</code>. This dataset consists of six variables: <code>time</code>, <code>age</code>, <code>death</code>, <code>Stage_II</code>, <code>Stage_III</code>, and <code>Stage_IV</code>. The information for this dataset is limited, so we will make the following assumptions about the variables for the purposes of this example:</p>
<ul>
<li><code>time</code> is the amount of time a patient lived after diagnosis of larynx cancer</li>
<li><code>age</code> is the age of the patient at the time of diagnosis</li>
<li><code>death</code> indicates whether the death was observed during the study</li>
<li><code>Stage_II</code> indicates that the cancer was at stage two at the time of diagnosis</li>
<li><code>Stage_III</code> indicates that the cancer was at stage three at the time of diagnosis</li>
<li><code>Stage_IV</code> indicates that the cancer was at stage four at the time of diagnosis</li>
<li>When a patient is not indicated in stage two or above, they were in stage one at the time of diagnosis</li>
</ul>
<p>Let’s start by calculating the survival function of all the patients in the study. We will use <code>KaplanMeierFitter</code> from <code>lifelines</code>. This is an object that will be the Kaplan-Meier model we just discussed. To fit this model, we will use the <code>fit()</code> method, which takes two arguments: <code>duration</code> and <code>event_observed</code>. <code>duration</code> is how long the patient lived in the study. <code>event_observed</code> is whether the death was observed: <code>True</code> for <a id="_idIndexMarker1020"/>observed and <code>False</code> for not observed. The data is already set up to work with these two arguments. We can fit the model as follows:</p>
<pre class="source-code">
import matplotlib.pyplot as plt
from lifelines import datasets
from lifelines.fitters.kaplan_meier_fitter import KaplanMeierFitter
data = datasets.load_larynx()
kmf = KaplanMeierFitter()
kmf.fit(data.time, data.death)
# this prints the first 5 elements of the survival function
kmf.survival_function_.head()</pre>
<p>The output of the preceding code is shown in <em class="italic">Figure 14</em><em class="italic">.2</em>, which is the first five elements of the survival function:</p>
<div><div><img alt="Figure 14.2 – First five elements of the larynx survival function" height="210" src="img/B18945_14_002.jpg" width="169"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.2 – First five elements of the larynx survival function</p>
<p>The elements of the survival function shown in <em class="italic">Figure 14</em><em class="italic">.2</em> are slowly decreasing, which is indicative of patients dying over time. However, it’s difficult to get the full story from a series of numbers. Let’s plot this series. We can also get the confidence intervals from <a id="_idIndexMarker1021"/>the <code>KaplanMeierFitter</code> object, as shown in the next code block:</p>
<pre class="source-code">
fig, ax = plt.subplots(1)
kmf.survival_function_.plot(ax=ax)
ci = kmf.confidence_interval_survival_function_
index = ci.index
ci_low, ci_high = ci.values[:, 0], ci.values[:, 1]
ax.fill_between(index, ci_low, ci_high, color='gray', alpha=0.3)</pre>
<p>This code results in the plot shown in <em class="italic">Figure 14</em><em class="italic">.3</em>, which is the survival function over time:</p>
<div><div><img alt="Figure 14.3 – Larynx survival function using Kaplan-Meier estimation" height="757" src="img/B18945_14_003.jpg" width="1070"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.3 – Larynx survival function using Kaplan-Meier estimation</p>
<p>The Kaplan-Meier estimator survival function for the larynx data is shown in <em class="italic">Figure 14</em><em class="italic">.3</em>. This function decreases over time until the last observed death at time step 8 where the function remains constant until the end of the study.</p>
<p>Now, consider <a id="_idIndexMarker1022"/>we have a few features in this dataset that we may want to compare. For example, we have the stages of cancer at the initial diagnosis, and we have the ages of the individuals. Let us start by comparing the survival functions of two age groups. Then, let us compare the survival functions of groups based on the cancer stage.</p>
<p>The ages of individuals in the study range from about 40 to 85, with the bulk of the individuals in the range of 60 to 80 years old. Let’s split the individuals into groups at the age of 65. Anyone younger than 65 will be in the younger group, and anyone 65 or older will be in the older group. The survival functions for the two groups are shown in <em class="italic">Figure 14</em><em class="italic">.4</em>:</p>
<div><div><img alt="Figure 14.4 – Larynx survival functions for older and younger groups" height="723" src="img/B18945_14_004.jpg" width="1081"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.4 – Larynx survival functions for older and younger groups</p>
<p>The survival functions for the older and younger group shown in <em class="italic">Figure 14</em><em class="italic">.4</em> appear to exhibit little difference until around time step 7. However, the confidence intervals never appear to diverge. It appears that age does not appear to be a strong factor for survival based on this data.</p>
<p>Now, let’s do a <a id="_idIndexMarker1023"/>similar survival analysis with the various stages. As mentioned previously, we will assume that any individual that is not indicated in stage two or above was diagnosed as stage one. The survival functions for these groups are shown in <em class="italic">Figure 14</em><em class="italic">.5</em>:</p>
<div><div><img alt="Figure 14.5 – Larynx survival functions based on stage" height="731" src="img/B18945_14_005.jpg" width="1055"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.5 – Larynx survival functions based on stage</p>
<p>The survival functions for the groups based on stage are shown in <em class="italic">Figure 14</em><em class="italic">.5</em>. This plot omits the confidence intervals for plot clarity. Based on the plot, there does not appear to be a significant difference between stage one and stage two. We start to see a difference at stage three. The difference between stage four and the other stages is distinctly noticeable.</p>
<p>In this section, we discussed the Kaplan-Meier model for survival, which is a nonparametric model for survival data. We also discussed how to compare the survival functions of multiple <a id="_idIndexMarker1024"/>groups within a set. In the next section, we will discuss the exponential model, which is a parametric model for survival data.</p>
<h1 id="_idParaDest-214"><a id="_idTextAnchor223"/>Exponential model</h1>
<p>In the<a id="_idIndexMarker1025"/> last section, we studied the non-parametric <strong class="bold">Kaplan-Meier survival model</strong>. We will now bridge parametric modeling with the <strong class="bold">exponential model</strong> and then will discuss a semi-parametric model, the <strong class="bold">Cox Proportional Hazards model</strong>, in the next section. Before considering the exponential model, we will review what the exponential distribution is and why we mention it in this section. This distribution is based on the Poisson process. Here, events occur independently over time and the event rate, λ, is calculated by the number of occurrences per unit of time, as follows:</p>
<p> λ = Y _ t  </p>
<p>The <a id="_idIndexMarker1026"/>Poisson distribution<a id="_idIndexMarker1027"/> is a <strong class="bold">statistical discrete distribution</strong> concerning the number of events occurring in a specified time period. It is defined as follows. Let <em class="italic">Y</em> be the number of occurrences in time <em class="italic">t</em>. Y follows the Poisson distribution with parameter λ if a probability mass function is given by the following formula:</p>
<p>f(Y) = Pr(y = Y) = e −λ λ Y _ Y ! </p>
<p>The mean and the variance of the discrete variable y are equal to the event rate. Instead of focusing on how many events occur in a specific time period, we can think about how long the event occurs; that’s why the exponential distribution is considered in this section. Let T be the time until the event occurs (Y = 1). The probability density function is calculated by the following formula:</p>
<p>f(t) = P(T = t) = λ e −λt</p>
<p>And the cumulative distribution function is calculated as follows:</p>
<p>F(t) = P(T ≤ t) = 1 − e −λt</p>
<p>The function F(t) represents the probability of not surviving past time t or the probability that survival time is less than t. We can see in <em class="italic">Figure 14</em><em class="italic">.6</em> the following probability form:</p>
<div><div><img alt="Figure 14.6 – Curve of the probability of not surviving past time t" height="486" src="img/B18945_14_006.jpg" width="580"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.6 – Curve of the probability of not surviving past time t</p>
<p>In contrast, the<a id="_idIndexMarker1028"/> survival function is related to the probability of surviving past a certain time t:</p>
<p>S(t) = P(T &gt; t) = 1 − P(T ≤ t) = e −λt</p>
<p>By visualization, the survival function will have the form seen in <em class="italic">Figure 14</em><em class="italic">.7</em>:</p>
<div><div><img alt="Figure 14.7 – Curve of the survival function" height="496" src="img/B18945_14_007.jpg" width="650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.7 – Curve of the survival function</p>
<p>The <strong class="bold">accumulated hazard function</strong> is H(t) = λt. We can then we can rewrite the survival <a id="_idIndexMarker1029"/>function in terms of the hazard function as follows:</p>
<p>S(t) = e −H(t) </p>
<p>Given S(t) and f(t), we can <a id="_idIndexMarker1030"/>use the idea of the log-likelihood equation approach and estimate the value for λ via maximum likelihood estimation.</p>
<h2 id="_idParaDest-215"><a id="_idTextAnchor224"/>Model example</h2>
<p>We <a id="_idIndexMarker1031"/>will use the same <code>larynx</code> dataset from <code>lifeline</code> as in the last section. In this example, we will use <code>ExponentialFitter</code> from <code>lifelines</code>. Similarly, the <code>fit()</code> method takes two arguments: <code>duration</code> and <code>event_observed</code>. We can fit the model as follows:</p>
<pre class="source-code">
from lifelines import ExponentialFitter
from lifelines import datasets
data = datasets.load_larynx()
exf = ExponentialFitter()
exf.fit(data.time, data.death)
# this print the first 5 elements of the survival function
exf.survival_function_.head()</pre>
<p>In the Kaplan-Meier model, the curve looks like stair steps, but using the exponential approach, the curve is gradually decreasing continuously, as we can see here:</p>
<div><div><img alt="Figure 14.8 – Larynx survival function using exponential distribution" height="248" src="img/B18945_14_008.jpg" width="372"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.8 – Larynx survival function using exponential distribution</p>
<p>At time step 8, the<a id="_idIndexMarker1032"/> function remains constant until the end of the study in the Kaplan-Meier model, but in the exponential model, the curve continues to decrease until the end of the study. We also perform similar studies between the younger group (less than 65 years old) and the older group (from 65 years old) (see <em class="italic">Figure 14</em><em class="italic">.9</em>):</p>
<div><div><img alt="Figure 14.9 – Larynx survival functions for older and younger groups" height="248" src="img/B18945_14_009.jpg" width="372"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.9 – Larynx survival functions for older and younger groups</p>
<p>We also do this on survival analysis with the various stages in the Larynx case (see <em class="italic">Figure 14</em><em class="italic">.10</em>):</p>
<div><div><img alt="Figure 14.10 – Larynx survival functions based on stage" height="248" src="img/B18945_14_010.jpg" width="372"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.10 – Larynx survival functions based on stage</p>
<p>Both the<a id="_idIndexMarker1033"/> exponential and Kaplan-Meier models give us similar information. There are advantages and disadvantages between the two models. In the Kaplan-Meier model, results interpretation is simpler; we can estimate the survival function value for both models, but one <a id="_idIndexMarker1034"/>advantage of the exponential model is to be able <a id="_idIndexMarker1035"/>to <strong class="bold">estimate the hazard ratio</strong>. Two disadvantages of <a id="_idIndexMarker1036"/>exponential models are that results are not always realistic and that we must assume a constant hazard ratio, which is not always practical. In the next section, we will discuss another survival model, the Cox Proportional Hazards regression model, which is semi-parametric.</p>
<h1 id="_idParaDest-216"><a id="_idTextAnchor225"/>Cox Proportional Hazards regression model</h1>
<p>Survival analysis, also<a id="_idIndexMarker1037"/> called TTE analysis, as we discussed in <em class="italic">Chapter 13</em><em class="italic">, Time-to-Event Variables</em>, is an analytical approach that uses probability to estimate the time remaining before an event occurs based on previous observations. We have seen how this can be helpful when including appropriate covariates in applications such as estimating life expectancy, mechanical failure, and customer churn, which can help with prioritizing needs and to more efficiently allocate resources. As we discussed in depth in <a href="B18945_13.xhtml#_idTextAnchor206"><em class="italic">Chapter 13</em></a>, censoring is an aspect making survival analysis unique from other statistical questions that can be solved using techniques such as regression. Consequently—and because dropping an observation due to censoring will almost certainly mislead our model and provide results we cannot trust—we insert what is known<a id="_idIndexMarker1038"/> as an <strong class="bold">event status indicator</strong> to help account for whether an event will occur or fail to occur prior to estimating the time before an event’s occurrence. Recall that the event status indicator, δ, for object i is described as follows:</p>
<p>δ i = { 1 if the event was observed,   0 if censoring was observed.</p>
<p>We <a id="_idIndexMarker1039"/>noted that δ i = 1 when the true event T i occurs <em class="italic">before</em> censoring time C i and δ i = 0 when the true event T i occurs<em class="italic"> after</em> censoring time C i  and that thus, the outcome Y for object i is this:</p>
<p>Y i = min(T i, C i)</p>
<p>Censored survival data for object ican be captured as (Y i, δ i). In this chapter, we have discussed<a id="_idIndexMarker1040"/> the <strong class="bold">non-parametric</strong> <strong class="bold">Kaplan-Meier survival model</strong>, which uses a raw conditional probability of survival counts respective to the sample volume at each point in time without consideration of covariates. We then walked through the<a id="_idIndexMarker1041"/> parametric <strong class="bold">exponential survival model</strong>, which, unlike the Kaplan-Meier model assumes the data fits specific distributions and additionally includes a hazard ratio to compare groups. We will now discuss the<a id="_idIndexMarker1042"/> semi-parametric <strong class="bold">Cox Proportional Hazards survival model</strong>, also referred to as the <strong class="bold">Cox Proportional Hazards </strong><strong class="bold">regression model</strong>.</p>
<p>The primary purpose and distinction of the Cox Proportional Hazards model is to use multiple covariates risk factors to model survival time. These covariates can be categorical or continuous. The Cox Proportional Hazards model is able to account for differences in survival between groups by leveraging <a id="_idIndexMarker1043"/>the <strong class="bold">hazard ratio</strong>. As we have discussed, the hazard ratio is the ratio of the event rate, at any point in time, for one group with respect to another group provided that survival up to that point in time has been maintained among the two groups.</p>
<p>The hazard ratio can be calculated as follows:</p>
<div><div><img alt="" height="100" role="presentation" src="img/B18945_14_1_formula.jpg" width="820"/>
</div>
</div>
<p>The issue with the hazard ratio is that when we fail to obtain a balance of values across covariates shared among the groups, we lose control of confounding variables. When we cannot control for confounding variables, we cannot reliably obtain inference. To account for any imbalance that may exist among covariate values in survival analysis, we can use the <strong class="bold">Cox Proportional Hazards model</strong> to introduce coefficients that help explain different levels of exogenous influence. The model follows this form:</p>
<p>h(t) = h 0(t) e (β 1X 1+β 2X 2+…+β nX n)</p>
<p>Here, h(t) is the<a id="_idIndexMarker1044"/> expected hazard value at the base time, <em class="italic">t</em>, h 0(t) is the baseline hazard value at <em class="italic">t</em> when all covariates in the variable matrix <em class="italic">X</em> are equal to zero, and <em class="italic">n</em> is the count of variables included in the model. The coefficients β n provide quantification into the impact (effect) of each columnar variable in <em class="italic">X</em>. Therefore, we are able to predict survival using the specific values of the input variables multiplied against their corresponding estimated coefficients.</p>
<p>Cox Proportional Hazards <a id="_idIndexMarker1045"/>has three pertinent assumptions:</p>
<ul>
<li>It is assumed the hazard ratio <em class="italic">remains constant</em> through follow-up. If the nature of input for one group is subject to change, this may negatively influence the results of the model; for example, we compare the performance of two machines, but one is likely to improve when the weather is warmer and the other is not, so our model may not be able to properly model mechanical survival.</li>
<li>Complete <em class="italic">survival independence</em>. This means the survival of one study participant or object has no dependence on the other. Consider two separate machines. If one’s vibrations are likely to result in an early failure that would not otherwise occur, and that vibration is additionally felt by the other machine, also at that other machine’s detriment, there may not be survival independence between the two machines. However, if the vibration of the first machine is not felt by the other, there is likely to be survival independence if all other confounders are controlled for.</li>
<li>The model <a id="_idIndexMarker1046"/>assumes <em class="italic">any censoring that takes place is non-informative</em>. As such, any censoring that takes place does not introduce confounding into the model. Losing a study subject due to censoring prior to follow-up must not be correlated to changes in survival risk. For example, when testing the mechanical survival of two types of machines in a specific area of a facility, if one machine is relocated to another area of the facility to minimize its own self-destructive vibrations, this is informative censoring. However, if the machine was moved to a different area simply to make space and the move does not impact the machine’s survival risk or outcome, the censoring is non-informative. Therefore, it does not introduce model confounding. The Cox Proportional Hazards model is for <strong class="bold">right-censored</strong> data.</li>
</ul>
<p>The steps to be taken when performing Cox Proportional Hazards regression modeling are outlined next. The sequence is important as the test should only be performed when practical. These steps follow<a id="_idIndexMarker1047"/> the outline provided by the <strong class="bold">National Institutes of Health</strong> (<strong class="bold">NIH</strong>) (<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7876211/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7876211/</a>).</p>
<h2 id="_idParaDest-217"><a id="_idTextAnchor226"/>Step 1</h2>
<p>Set up the <a id="_idIndexMarker1048"/>null hypothesis to be tested (hypotheses in the multivariate case, which we will look at). We will use the <em class="italic">Stanford heart transplant</em> dataset, which lists the survival of the patients waiting for transplants in the Stanford heart transplant program. We will use <code>age</code> and <code>year</code> with respect to the start date of the program, <code>transplant</code> status, and the existence of previous bypass <code>surgery</code> as predictors for survival, which ends in either death or transplant. Survival duration is the <code>stop</code> variable, which is the exit time of the study. <code>event</code> is the variable confirming right-censoring and corresponds to either death or transplant. The null hypothesis for each variable is that there is no statistically significant difference in survival between the groups. For example, age has no impact on survival, while awaiting transplant would be the null hypothesis. The code is shown in the following snippet:</p>
<pre class="source-code">
import statsmodels.api as sm
data = sm.datasets.get_rdataset('heart', package='survival').data
train_data = data.iloc[0:171]
test_data = data.iloc[171:]
exog=train_data[['age','year', 'transplant','surgery']]#df_test[['age','year','surgery','transplant']]
endog=train_data['stop']
data.head(2)</pre>
<p>Two <a id="_idIndexMarker1049"/>additional aspects of our data to be aware of are (1) that age has negative values; the starting <code>age</code> value is 48 years old, so an age of -1 corresponds to a 47-year-old patient and (2) <code>year</code> starts November 1, 1967. <code>id</code> is unique to each patient’s identification. We will not model this variable but can use it for reference. In <em class="italic">Figure 14</em><em class="italic">.11</em> we can see, for reference, the first two rows of the data, including all variables we will use to model survival:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-6">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">start</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">stop</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Event</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Age</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">year</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">surgery</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">transplant</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">id</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>50</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>-17.1554</p>
</td>
<td class="No-Table-Style">
<p>0.123203</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>6</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>3.835729</p>
</td>
<td class="No-Table-Style">
<p>0.25462</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.11 – First two rows of the Stanford Heart Transplant data set</p>
<h2 id="_idParaDest-218"><a id="_idTextAnchor227"/>Step 2</h2>
<p>We estimate the survival function using a <code>stop=1</code>), corresponding to index column <code>event_at</code> equal to 1, we have right-censoring for three patients. We observed the event take place for one patient (<code>observed=1</code>) and the other two patients were censored. Here, we show the corresponding data. The patient with <code>id=45</code> stops but restarts the same day, then survives until day 45. We see the same for patient <code>id=3</code>, who survives until day 16 when they receive a transplant. The patient with <code>id=15</code> does not re-enter for follow-up; we assume since they did not receive a transplant, they did not survive.</p>
<p>In the following code sample, the <code>durations</code> variable corresponds to survival time and <code>event_observed</code> corresponds to the event (transplant or death) that results in right-censoring:</p>
<pre class="source-code">
from lifelines import KaplanMeierFitter
import matplotlib.pyplot as plt
KaplanMeierFitter = KaplanMeierFitter()
KaplanMeierFitter.fit(durations=train_data['stop'], event_observed=train_data['event'])
KaplanMeierFitter.event_table.reset_index()</pre>
<p>Note<a id="_idIndexMarker1050"/> from the Kaplan-Meier results that <code>event=1</code> with <code>stop=1</code> results in <code>observed=1</code>, whereas <code>event=0</code> with <code>stop=1</code> results in <code>censored=1</code> and <code>stop=1</code> results in <code>removed=1</code>. All three conditions result in those corresponding samples being removed from the calculation for that day’s calculation, but unlike the patient who experienced the event, those who were censored are considered to survive at least as long as the study continues. We can see this by considering the Kaplan-Meier survival estimation probability function, S t:</p>
<p>S t =  n Patients at Start − nPatients with Event = 1 at time t     ______________________________________   n Patients at Start </p>
<p>Here, survival probability at any time, <em class="italic">t</em>, is denoted as S t.</p>
<p>In looking at our event table from the <code>KaplanMeierFitter</code> function, we have the following:</p>
<p>S t =  n Patients at risk − n Patients observed at time t    _________________________________   n Patients at risk </p>
<p>We can understand that a <code>removed</code> patient has limited impact on survival estimations unless they were also noted as <code>observed=1</code>, which we can ascribe to <code>event=1</code>.</p>
<p>Let’s consider patients 3, 15, and 45 to understand this relationship better. We can see based on counts in <em class="italic">Figure 14</em><em class="italic">.12</em> and <em class="italic">Figure 14</em><em class="italic">.13</em> that these patients were removed from the denominator on day 1 (<code>event_at=1</code>). However, by looking at <em class="italic">Figure 14</em><em class="italic">.14</em>, we can see patients 15 and 45 have later stops corresponding to events that get factored into the survival function. Let’s look at <em class="italic">Figure 14</em><em class="italic">.12</em> first so we can see the three removed patients on day 1:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-4">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><strong class="bold">event_at</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">removed</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">observed</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">censored</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">entrance</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">at_risk</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>171</p>
</td>
<td class="No-Table-Style">
<p>171</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>171</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>2</p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
<td class="No-Table-Style">
<p>6</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>168</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>6</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>162</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>4</p>
</td>
<td class="No-Table-Style">
<p>4</p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>156</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>…</p>
</td>
<td class="No-Table-Style">
<p>…</p>
</td>
<td class="No-Table-Style">
<p>…</p>
</td>
<td class="No-Table-Style">
<p>…</p>
</td>
<td class="No-Table-Style">
<p>…</p>
</td>
<td class="No-Table-Style">
<p>…</p>
</td>
<td class="No-Table-Style">
<p>…</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>107</p>
</td>
<td class="No-Table-Style">
<p>1401</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>5</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>108</p>
</td>
<td class="No-Table-Style">
<p>1408</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>4</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>109</p>
</td>
<td class="No-Table-Style">
<p>1572</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>110</p>
</td>
<td class="No-Table-Style">
<p>1587</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>2</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>111</p>
</td>
<td class="No-Table-Style">
<p>1800</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.12 – Summary of the events table for the Stanford Heart Transplant data set</p>
<p>Now, we can <a id="_idIndexMarker1051"/>see in <em class="italic">Figure 14</em><em class="italic">.13</em> all patients that had stops on day 1.</p>
<pre class="source-code">
train_data.loc[train_data['stop']==1]</pre>
<p>The patients with stops on day 1 are patients with <code>id</code> 3, 15, and 45:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table004-2">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">start</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Stop</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">event</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Age</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Year</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">surgery</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">transplant</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">id</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>6.297057</p>
</td>
<td class="No-Table-Style">
<p>0.265572</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>5.815195</p>
</td>
<td class="No-Table-Style">
<p>0.991102</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>15</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>-11.8166</p>
</td>
<td class="No-Table-Style">
<p>3.263518</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>45</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.13 – Training data values for patients who exited the study on day 1</p>
<p>To get a better understanding of how this analysis works, we can look specifically at all records for the patients having <code>id</code> 3, 15, and 45:</p>
<pre class="source-code">
 train_data.loc[train_data['id'].isin([3, 15,45])]</pre>
<p>These patients registered a stop on day 1, but patients 3 and 45 also registered stops on days 16 and 45, respectively:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table005-2">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">start</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">stop</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">event</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Age</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">year</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">surgery</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">transplant</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">id</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>6.297057</p>
</td>
<td class="No-Table-Style">
<p>0.265572</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>16</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>6.297057</p>
</td>
<td class="No-Table-Style">
<p>0.265572</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>3</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>5.815195</p>
</td>
<td class="No-Table-Style">
<p>0.991102</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>15</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>-11.8166</p>
</td>
<td class="No-Table-Style">
<p>3.263518</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>45</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>45</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>-11.8166</p>
</td>
<td class="No-Table-Style">
<p>3.263518</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>45</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.14 – Training data values for patients 3, 15, and 45</p>
<p>We can <a id="_idIndexMarker1052"/>also see patient 45 is the only patient with a <code>stop</code> value (corresponding to <code>event_at</code>) on day 45. Therefore, we know a transplant results in an observation and a removal. To identify the values at day 45, run the following code:</p>
<pre class="source-code">
KaplanMeierFitter.event_table.loc[KaplanMeierFitter.event_table.index==45.0]</pre>
<p>The code outputs the table in <em class="italic">Figure 14</em><em class="italic">.15</em>:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table006-2">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">event_at</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">removed</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">observed</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">censored</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">entrance</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">at_risk</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>45</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>87</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.15 – Events on day 45</p>
<p>Now we can look at the events table filtered to events with a stop at day 45 by running the following code:</p>
<pre class="source-code">
train_data.loc[train_data['stop']==45]</pre>
<p>This gives us the tabular output seen in <em class="italic">Figure 14</em><em class="italic">.16</em>:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table007-1">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">start</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">stop</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">event</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">Age</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">year</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">surgery</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">transplant</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">id</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>45</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>-11.8166</p>
</td>
<td class="No-Table-Style">
<p>3.263518</p>
</td>
<td class="No-Table-Style">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>1</p>
</td>
<td class="No-Table-Style">
<p>45</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.16 – Events having a stop on day 45</p>
<p>We can repeat this step to see if there is a difference in survival until the end of the study for those who receive a transplant and those who do not by splitting the two groups out in the following code:</p>
<pre class="source-code">
from lifelines import KaplanMeierFitter
import matplotlib.pyplot as plt
KaplanMeierFitter_n = KaplanMeierFitter()
KaplanMeierFitter_y = KaplanMeierFitter()
KaplanMeierFitter_n.fit(durations=data.loc[data['transplant']==0]['stop'], event_observed=data.loc[data['transplant']==0]['event'], label='no transplant')
KaplanMeierFitter_y.fit(durations=data.loc[data['transplant']==1]['stop'], event_observed=data.loc[data['transplant']==1]['event'], label='transplant');</pre>
<p>We<a id="_idIndexMarker1053"/> observe in the <strong class="bold">Kaplan-Meier survival function</strong> in <em class="italic">Figure 14</em><em class="italic">.17</em> a steady decrease in survival probability for both groups, but <a id="_idIndexMarker1054"/>a steeper decrease for the group that does not receive a transplant. We can also see the group, overall, with no transplant does not survive if the group that does receive the transplant. By the time the program closed, there were no non-transplants surviving. The shading corresponds to the 95% confidence interval bands for each probability interval:</p>
<div><div><img alt="Figure 14.17 – Kaplan-Meier survival estimation probability function" height="846" src="img/B18945_14_017.jpg" width="1178"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.17 – Kaplan-Meier survival estimation probability function</p>
<p>To generate the exact probability of survival on any day (corresponding to the <code>stop</code> time), we<a id="_idIndexMarker1055"/> can run the following code:</p>
<pre class="source-code">
print('Non-Transplant Survival Probability at day 300: ', KaplanMeierFitter_n.predict(300))
print('Transplant Survival Probability at day 300: ', KaplanMeierFitter_y.predict(300))</pre>
<p>Here we can see the probabilities of survival at day 300 for the transplant and non-transplant groups:</p>
<pre class="source-code">
Non-Transplant Survival Probability at day 300:  0.3545098269168237
Transplant Survival Probability at day 300:  0.4911598783770023</pre>
<h2 id="_idParaDest-219"><a id="_idTextAnchor228"/>Step 3</h2>
<p>Now, we will <a id="_idIndexMarker1056"/>use a <strong class="bold">log-rank test</strong> to determine if survivor curves are statistically different. At this step, we investigate if there is any statistical significance in survival between transplant and non-transplant groups. If there is no statistical significance, it would not be useful to understand the relationships between the covariates and their impacts on survival. We<a id="_idIndexMarker1057"/> looked at <strong class="bold">contingency table analysis</strong> using the <strong class="bold">Chi-Square test of independence</strong> earlier in the book. This is essentially the<a id="_idIndexMarker1058"/> log-rank test here, where we compare the survival distributions of the two groups (transplant versus non-transplant). We use this approach because the data is right-censored, and thus right-skewed; as such, we are working with non-parametric distributions. The null hypothesis is that the hazard ratio between the two groups is equal to 1, which would mean they are equal in terms of survival or hazard risk.</p>
<p>In the following code sample, we use the two different patient distributions (those with and those without transplants) as groups A and B in the <code>logrank_test</code> function:</p>
<pre class="source-code">
from lifelines.statistics import logrank_test
lr_results = logrank_test(durations_A=data.loc[data['transplant']==0]['stop'],
                          durations_B=data.loc[data['transplant']==1]['stop'],
                          event_observed_A=data.loc[data['transplant']==0]['event'],
                          event_observed_B=data.loc[data['transplant']==1]['event'])</pre>
<p>We can<a id="_idIndexMarker1059"/> see the Chi-Square distribution is used:</p>
<pre class="source-code">
print(lr_results.null_distribution)</pre>
<p>This shows the default distribution is the chi-square distribution:</p>
<pre class="source-code">
chi squared</pre>
<p>We can run the following code to see the results of the test:</p>
<pre class="source-code">
lr_results.summary</pre>
<p>We can also see a statistically significant difference at a 5% level of significance between the two groups. Therefore, we can assume there is a purpose in proceeding to use the Cox Proportional Hazards model to understand the relationships between the covariates we outlined earlier and the hazard risk for survival:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table008">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="bold">test_statistic</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">P</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">-</strong><strong class="bold">log2(p)</strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>4.02651</p>
</td>
<td class="No-Table-Style">
<p>0.044791</p>
</td>
<td class="No-Table-Style">
<p>4.480663</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.18 – Log-rank test results</p>
<h2 id="_idParaDest-220"><a id="_idTextAnchor229"/>Step 4</h2>
<p>Here, we run the Cox Proportional Hazards test and analyze the p-values and confidence intervals for the terms included to identify whether they have statistical significance with respect to influence on survival rate. We look at the hazard ratio to determine any effects they have provided:</p>
<pre class="source-code">
from lifelines import CoxPHFitter
CoxPHFitter = CoxPHFitter()
CoxPHFitter.fit(df=train_data[['age','year','surgery','transplant','stop','event']], duration_col='stop', event_col='event')
CoxPHFitter.print_summary()</pre>
<p>We can <a id="_idIndexMarker1060"/>see three of our four terms are significant at the 5% level of significance for predicting survival; our <code>surgery</code> variable does not appear to be based on the p-value. The 95% confidence interval for surgery does not contain 0, however, which suggests statistical significance. The difference is because the p-value is calculated based on the test statistic with respect to the critical value, which is estimated using the <em class="italic">log of the hazard ratio</em>, and the confidence interval is based on the <em class="italic">hazard ratio</em> itself. This discrepancy could mean the <code>surgery</code> variable is significant, but also that it may not be. Since we are not statistically certain, we should err on the side of caution and not consider it useful when predicting future survival.</p>
<p>Note that <code>exp(coef)</code> corresponds to the hazard ratio and <code>coef</code> is the log of the hazard ratio. This follows the equation we provided earlier for the expected hazard value at the base time, <em class="italic">t</em>.</p>
<p>We can say, based on the hazard ratio <code>(exp(coef))</code> of 1.03, that a single unit increase in age over age 48 results in an increase of the hazard by a factor of 1.03, or 3%. With respect to our <code>transplant</code> variable, we can say with a 95% level of confidence that having the heart transplant decreased the hazard by a factor of 0.54, which is equivalent to 46%.</p>
<p>Here in <em class="italic">Figure 14</em><em class="italic">.19</em>, we can see the results of the Cox Proportional Hazards regression model:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table009">
<colgroup>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p><strong class="bold">Model</strong></p>
</td>
<td class="No-Table-Style" colspan="7">
<p><code>lifelines.CoxPHFitter</code></p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Duration column</p>
</td>
<td class="No-Table-Style" colspan="7">
<p><code>stop</code></p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Event column</p>
</td>
<td class="No-Table-Style" colspan="7">
<p><code>event</code></p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Baseline estimation</p>
</td>
<td class="No-Table-Style" colspan="7">
<p><code>breslow</code></p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Number of observations</p>
</td>
<td class="No-Table-Style" colspan="7">
<p>171</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Number of events observed</p>
</td>
<td class="No-Table-Style" colspan="7">
<p>74</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Partial log likelihood</p>
</td>
<td class="No-Table-Style" colspan="7">
<p>-298.47</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="5">
<p>Time fit was run</p>
</td>
<td class="No-Table-Style" colspan="7">
<p>2023-03-18 16:23:26 UTC</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p>coef</p>
</td>
<td class="No-Table-Style">
<p>exp (coef)</p>
</td>
<td class="No-Table-Style" colspan="3">
<p>se (coef)</p>
</td>
<td class="No-Table-Style">
<p>coef lower 95%</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>coef upper 95%</p>
</td>
<td class="No-Table-Style">
<p>exp (coef) lower 95%</p>
</td>
<td class="No-Table-Style">
<p>exp (coef) upper 95%</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>cmp to</p>
</td>
<td class="No-Table-Style">
<p>z</p>
</td>
<td class="No-Table-Style">
<p>p</p>
</td>
<td class="No-Table-Style">
<p>-log2 (p)</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Age</p>
</td>
<td class="No-Table-Style">
<p>0.03</p>
</td>
<td class="No-Table-Style">
<p>1.03</p>
</td>
<td class="No-Table-Style" colspan="3">
<p>0.01</p>
</td>
<td class="No-Table-Style">
<p>0.01</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>0.06</p>
</td>
<td class="No-Table-Style">
<p>1.01</p>
</td>
<td class="No-Table-Style">
<p>1.06</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>2.35</p>
</td>
<td class="No-Table-Style">
<p>0.02</p>
</td>
<td class="No-Table-Style">
<p>5.74</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Year</p>
</td>
<td class="No-Table-Style">
<p>-0.16</p>
</td>
<td class="No-Table-Style">
<p>0.85</p>
</td>
<td class="No-Table-Style" colspan="3">
<p>0.07</p>
</td>
<td class="No-Table-Style">
<p>-0.3</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>-0.02</p>
</td>
<td class="No-Table-Style">
<p>0.74</p>
</td>
<td class="No-Table-Style">
<p>0.98</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>-2.25</p>
</td>
<td class="No-Table-Style">
<p>0.02</p>
</td>
<td class="No-Table-Style">
<p>5.35</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Surgery</p>
</td>
<td class="No-Table-Style">
<p>-0.64</p>
</td>
<td class="No-Table-Style">
<p>0.53</p>
</td>
<td class="No-Table-Style" colspan="3">
<p>0.37</p>
</td>
<td class="No-Table-Style">
<p>-1.36</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>0.08</p>
</td>
<td class="No-Table-Style">
<p>0.26</p>
</td>
<td class="No-Table-Style">
<p>1.08</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>-1.74</p>
</td>
<td class="No-Table-Style">
<p>0.08</p>
</td>
<td class="No-Table-Style">
<p>3.62</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Transplant</p>
</td>
<td class="No-Table-Style">
<p>-0.62</p>
</td>
<td class="No-Table-Style">
<p>0.54</p>
</td>
<td class="No-Table-Style" colspan="3">
<p>0.27</p>
</td>
<td class="No-Table-Style">
<p>-1.15</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>-0.08</p>
</td>
<td class="No-Table-Style">
<p>0.32</p>
</td>
<td class="No-Table-Style">
<p>0.92</p>
</td>
<td class="No-Table-Style" colspan="2">
<p>0</p>
</td>
<td class="No-Table-Style">
<p>-2.26</p>
</td>
<td class="No-Table-Style">
<p>0.02</p>
</td>
<td class="No-Table-Style">
<p>5.41</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="4">
<p>Concordance</p>
</td>
<td class="No-Table-Style" colspan="4">
<p>0.67</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="4">
<p>Partial AIC</p>
</td>
<td class="No-Table-Style" colspan="4">
<p>604.95</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="4">
<p>Log-likelihood ratio test</p>
</td>
<td class="No-Table-Style" colspan="4">
<p>21.22 on 4 df</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style" colspan="4">
<p>-log2(p) of ll-ratio test</p>
</td>
<td class="No-Table-Style" colspan="4">
<p>11.77</p>
</td>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
<td class="No-Table-Style"/>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.19 – Cox Proportional Hazard model output</p>
<p>In <em class="italic">Figure 14</em><em class="italic">.20</em>, we <a id="_idIndexMarker1061"/>can see <code>age</code>, which applies only a 3% increase in hazard, does not explain much of the variance in the results. The age range spans roughly 9 years through 64 years of age. Without other covariates, we cannot say exactly why this might be, but including more covariates could prove helpful in understanding this variable more. Of the significant variables, <code>transplant</code> has notably the largest impact on survival outcomes:</p>
<pre class="source-code">
plt.title('Coefficients within Confidence Intervals')
CoxPHFitter.plot()</pre>
<div><div><img alt="Figure 14.20 – Confidence intervals for hazard-ratio terms" height="846" src="img/B18945_14_020.jpg" width="1244"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.20 – Confidence intervals for hazard-ratio terms</p>
<p>We can<a id="_idIndexMarker1062"/> see the assumption of a constant hazard ratio between all patients in the survival function plot in <em class="italic">Figure 14</em><em class="italic">.21</em>. This is why it is important to prevent informative censoring. Let us assume this assumption is met.</p>
<p>Note that when predicting, we do not have start and stop times. Therefore, we can input only the quantifiable covariates for a given patient, as follows:</p>
<pre class="source-code">
CoxPHFitter.predict_survival_function(train_data[['age','year','surgery','transplant']]).plot()
plt.xlabel('Survival Time')
plt.ylabel('Survival Probability')
plt.title('Survival Function for All Patients')
plt.legend().set_visible(False)</pre>
<div><div><img alt="Figure 14.21 – Survival function for all patients" height="846" src="img/B18945_14_021.jpg" width="1178"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.21 – Survival function for all patients</p>
<h2 id="_idParaDest-221"><a id="_idTextAnchor230"/>Step 5</h2>
<p>In <em class="italic">Figure 14</em><em class="italic">.22</em>, we can use <a id="_idIndexMarker1063"/>the Cox Proportional Hazards model to predict the survival function for our held-out test patient:</p>
<pre class="source-code">
CoxPHFitter.predict_survival_function(test_data[['age','year','surgery','transplant']]).plot()
plt.xlabel('Survival Time')
plt.ylabel('Survival Probability')
plt.title('Survival Function for Holdout')</pre>
<div><div><img alt="Figure 14.22 – Survival function for test patient, id=171" height="846" src="img/B18945_14_022.jpg" width="1178"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.22 – Survival function for test patient, id=171</p>
<p>To generate<a id="_idIndexMarker1064"/> the probability for this patient’s survival, using their covariates, at each potential stop point, we can run the following code:</p>
<pre class="source-code">
CoxPHFitter.predict_survival_function(test_data[['age','year','surgery','transplant','stop','event']])</pre>
<h1 id="_idParaDest-222"><a id="_idTextAnchor231"/>Summary</h1>
<p>In this chapter, we discussed three survival analysis models in depth; the Kaplan-Meier, the exponential, and the Cox Proportional Hazards regression models. Using these frameworks, we modeled survival functions and estimated survival probabilities and hazard ratios for various TTE, right-censored studies. For the multivariate case, we used Cox Proportional Hazards regression to model hazard ratios for covariate analysis on dependent variables. For all models, we demonstrated using the confidence intervals for assessing significance, as well as the corresponding p-values. At this point, the reader should be able to confidently identify the scenarios in which each model would outperform the others and appropriately fit and implement that model to obtain the necessary results for strategic success.</p>
</div>
</div></body></html>