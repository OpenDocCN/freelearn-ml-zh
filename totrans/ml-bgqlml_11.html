<html><head></head><body>
		<div id="_idContainer130">
			<h1 id="_idParaDest-117"><em class="italic"><a id="_idTextAnchor119"/>Chapter 8</em>: Forecasting Using Time Series</h1>
			<p>Predicting future trends using historical data is one of the most fascinating activities that we can do with machine learning.</p>
			<p>Making predictions based on historical data points and time series is particularly interesting and can be very useful in different industries. Forecasting can help us in predicting the future, but also in identifying anomalies in data that don't respect the expected pattern.</p>
			<p>In this chapter, we'll focus on time series forecasting by using the ARIMA Plus algorithm. This technique can be used to predict numerical values in different fields, such as the sales of a company, the customers in a restaurant, stock prices, and the electricity consumption of a building.</p>
			<p>To understand how we can use BigQuery ML to forecast trends and to effectively present our results, we'll go through the following topics:</p>
			<ul>
				<li>Introducing the business scenario</li>
				<li>Discovering time series forecasting</li>
				<li>Exploring and understanding the dataset</li>
				<li>Training the time series forecasting model</li>
				<li>Evaluating the time series forecasting model</li>
				<li>Using the time series forecasting model</li>
				<li>Presenting the forecast</li>
			</ul>
			<h1 id="_idParaDest-118"><a id="_idTextAnchor120"/>Technical requirements</h1>
			<p>This chapter requires you to access a web browser and to have the possibility to leverage the following:</p>
			<ul>
				<li>A GCP account to access Google Cloud Console</li>
				<li>A GCP project to host the BigQuery datasets</li>
			</ul>
			<p>Now, that we're ready with the technical requirements, let's dive into the analysis and development of our BigQuery ML forecasting model.</p>
			<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/2QY0Qlp">https://bit.ly/2QY0Qlp</a></p>
			<h1 id="_idParaDest-119"><a id="_idTextAnchor121"/>Introducing the business scenario</h1>
			<p>Imagine being a <a id="_idIndexMarker403"/>business analyst who works for the state of Iowa. The state monitors the retail distribution of liquors and spirits by collecting data from every shop in the territory. Controlling liquor sales is particularly important for monitoring citizen health and for checking tax income.</p>
			<p>In the following screenshot, you can see a picture of typical shelves of liquors and spirits in a shop:</p>
			<div>
				<div id="_idContainer113" class="IMG---Figure">
					<img src="image/B16722_08_001.jpg" alt="Figure 8.1 – The shelves in a liquor shop&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.1 – The shelves in a liquor shop</p>
			<p>For our business <a id="_idIndexMarker404"/>scenario, we can imagine that the state of Iowa wants to predict the number of liters that will be sold in the first 30 days of 2020 leveraging the historical data collected in the previous years.</p>
			<p>Your manager may ask you to predict the number of liters that will be sold by all the shops in the state by leveraging the time series data that was already collected in the database.</p>
			<p>As a business analyst, your job is to find the best algorithm to forecast the sales volumes and to present the results in a graphical way to the governor's staff.</p>
			<p>Now that we've explained and understood the problem statement, let's take a look at the machine learning technique that we can use to forecast the sales, by using historical data.</p>
			<h1 id="_idParaDest-120"><a id="_idTextAnchor122"/>Discovering time series forecasting</h1>
			<p>A <strong class="bold">time series</strong> is a sequence of data <a id="_idIndexMarker405"/>points mapped at a certain time frequency. For example, it can contain the price of a stock collected at<a id="_idIndexMarker406"/> regular intervals, the sales volumes of each day in a specific timeframe, or the temperature <a id="_idIndexMarker407"/>measured by an <strong class="bold">Internet of Things</strong> (<strong class="bold">IoT</strong>) sensor during the day.</p>
			<p>In the following diagram, you can see a time series graph of the data collected by a temperature sensor in the first 15 days of 2020:</p>
			<div>
				<div id="_idContainer114" class="IMG---Figure">
					<img src="image/B16722_08_002.jpg" alt="Figure 8.2 – Example of time series generated by a temperature sensor&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.2 – Example of time series generated by a temperature sensor</p>
			<p><strong class="bold">Forecasting</strong> using time series <a id="_idIndexMarker408"/>analysis comprises the use of machine learning models to predict the future values of a specific measure by leveraging the known past data.</p>
			<p>BigQuery ML provides a specific machine learning algorithm to forecast numerical values using time series data. The algorithm is designed and developed to do the following:</p>
			<ul>
				<li>Automatically clean and adjust the training data to overcome the data quality issues, for example, missing or duplicated values and spikes.</li>
				<li>Compensate for variations caused by specific periods, such as holidays.</li>
				<li>Decompose trends using the Seasonal and Trend Decomposition Loess algorithm.</li>
				<li>Extrapolate the seasonality from the data.</li>
				<li>And finally, apply the<a id="_idIndexMarker409"/> trend modeling of the <strong class="bold">Autoregressive Integrated Moving Average</strong> (<strong class="bold">ARIMA</strong>) model to predict future numerical values using historical ones.</li>
			</ul>
			<p>You can use ARIMA models to <a id="_idIndexMarker410"/>discover hidden patterns in time series data or to forecast the future values of a specific measure.</p>
			<p>In this section, we've learned the basics of time series forecasting. Now let's take a look at the dataset that we'll use to build our BigQuery ML model.</p>
			<h1 id="_idParaDest-121"><a id="_idTextAnchor123"/>Exploring and understanding the dataset</h1>
			<p>Before starting the<a id="_idIndexMarker411"/> development of the machine learning model, we'll start looking at the dataset and its structure.</p>
			<p>Let's start by getting a clear understanding of the time series data that we have in the BigQuery public dataset to build our forecasting model in the next section.</p>
			<h2 id="_idParaDest-122"><a id="_idTextAnchor124"/>Understanding the data</h2>
			<p>In this section, we'll analyze the structure of the<a id="_idIndexMarker412"/> data to identify the fields to use for the machine learning model creation.</p>
			<p>To start exploring the data, we need to do the following:</p>
			<ol>
				<li value="1">Log into our Google Cloud Console and access the <strong class="bold">BigQuery</strong> user interface from the navigation menu.</li>
				<li>Create a new dataset under the project that we created in <a href="B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039"><em class="italic">Chapter 2</em></a>, <em class="italic">Setting Up Your GCP and BigQuery Environment</em>. For this use case, we'll create the dataset <strong class="source-inline">08_sales_forecasting</strong> with the default options.</li>
				<li>Open the GCP project <strong class="bold">bigquery-public-data</strong> that hosts the BigQuery public datasets and browse the datasets until we find <strong class="source-inline">iowa_liquor_sales</strong>.<p>As seen in the following<a id="_idIndexMarker413"/> screenshot, the BigQuery public dataset contains only one table that hosts the data collected from the liquor shops in Iowa:</p><div id="_idContainer115" class="IMG---Figure"><img src="image/B16722_08_003.jpg" alt="Figure 8.3 – The Iowa liquor sales public dataset contains the sales of all the liquor shops in Iowa&#13;&#10;"/></div><p class="figure-caption">Figure 8.3 – The Iowa liquor sales public dataset contains the sales of all the liquor shops in Iowa</p><p>We'll use the table <strong class="bold">sales</strong> to build our forecasting model. This table contains all the information about the liquor sold in the state of Iowa since 2012.</p></li>
				<li>Let's click on the table name <strong class="bold">sales</strong> in the BigQuery navigation menu to access the schema of the table:<div id="_idContainer116" class="IMG---Figure"><img src="image/B16722_08_004.jpg" alt="Figure 8.4 – The structure of the table lists all the information collected in the table&#13;&#10;"/></div><p class="figure-caption">Figure 8.4 – The structure of the table lists all the information collected in the table</p></li>
				<li>Each field is well described in the <strong class="bold">Description</strong> column.<p>The table contains the column <strong class="bold">date</strong>, which represents the day of the sale. For our purposes, we'll try to<a id="_idIndexMarker414"/> forecast the total number of liters sold on a specific day. For this reason, we can notice the presence of the field <strong class="bold">volume_sold_liters</strong>. This numeric field expresses the quantity of liquor sold during each transaction.</p></li>
			</ol>
			<p>In this section, we've analyzed the metadata of the <strong class="bold">sales</strong> table and understood which fields are interesting to build our forecasting model on. Next, it's time to look at the actual data and start querying it.</p>
			<h2 id="_idParaDest-123"><a id="_idTextAnchor125"/>Checking the data quality</h2>
			<p>In this section, we'll apply <a id="_idIndexMarker415"/>some data quality checks to analyze the completeness of our training dataset.</p>
			<p>Let's start analyzing the table that will be used to build our BigQuery ML model:</p>
			<ol>
				<li value="1">In order to identify the timeframe of our dataset, let's extract the minimum and maximum value of the <strong class="source-inline">date</strong> field from the <strong class="source-inline">`bigquery-public-data.iowa_liquor_sales.sales`</strong> table:<p class="source-code">SELECT min(date), max(date) FROM `bigquery-public-data.iowa_liquor_sales.sales`; </p><p>By executing this SQL statement, we can notice that the data goes from 2012 to the end of November 2020.</p><p>The result of the query is presented in the following screenshot:</p><div id="_idContainer117" class="IMG---Figure"><img src="image/B16722_08_005.jpg" alt="Figure 8.5 – The result of the query shows the timeframe of the dataset&#13;&#10;"/></div><p class="figure-caption">Figure 8.5 – The result of the query shows the timeframe of the dataset</p><p>For our purposes, we can focus our attention on the sales that occurred in 2018 and 2019 to forecast the first 30 days of 2020.</p></li>
				<li>In the second step, we'll analyze the number of distinct dates that we can find in the chosen timeframe:<p class="source-code">SELECT COUNT(DISTINCT date)</p><p class="source-code">FROM</p><p class="source-code">        `bigquery-public-data.iowa_liquor_sales.sales`</p><p class="source-code">WHERE</p><p class="source-code">        EXTRACT (year from date) = 2019         OR  EXTRACT (year from date) = 2018;</p><p>The query <strong class="source-inline">COUNT</strong> and the <strong class="source-inline">DISTINCT</strong> values available in the field <strong class="source-inline">date</strong>. With the expression <strong class="source-inline">EXTRACT (year from date)</strong>, the SQL statement considers only the sales that happened in <strong class="source-inline">2018</strong> and <strong class="source-inline">2019</strong>.</p><p>The result of the query is <a id="_idIndexMarker416"/>presented in the following screenshot:</p></li>
			</ol>
			<div>
				<div id="_idContainer118" class="IMG---Figure">
					<img src="image/B16722_08_006.jpg" alt="Figure 8.6 – The result of the query shows the distinct dates in the dataset&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.6 – The result of the query shows the distinct dates in the dataset</p>
			<p>From the results, it's clear that the dataset doesn't contain the information for each day of the 2 years. This is probably caused by missing values due to public holidays and store closures. This is not a big issue because BigQuery ML will automatically manage the missing values during the training phase.</p>
			<p>Now that we've performed some SQL queries to better understand our dataset, let's focus on creating our training dataset.</p>
			<h2 id="_idParaDest-124"><a id="_idTextAnchor126"/>Creating the training dataset</h2>
			<p>In this section, we'll create a table to <a id="_idIndexMarker417"/>store the data points that will be used to train the forecasting model in the next section. Before training the model, we'll also use Data Studio to graphically analyze the time series.</p>
			<p>To train our model, we'll create a specific table that will host the historical data points of our time series:</p>
			<ol>
				<li value="1">Let's create a table that contains only two fields. The first one is <strong class="source-inline">date</strong> and the second one is <strong class="source-inline">total_sold_liters</strong>:<p class="source-code">CREATE OR REPLACE TABLE `08_sales_forecasting.iowa_liquor_sales` AS</p><p class="source-code">SELECT </p><p class="source-code">        date,</p><p class="source-code">        SUM(volume_sold_liters) total_sold_liters</p><p class="source-code">FROM</p><p class="source-code">        `bigquery-public-data.iowa_liquor_sales.sales`</p><p class="source-code">WHERE</p><p class="source-code">        EXTRACT (year from date) = 2019 OR  EXTRACT (year from date) = 2018</p><p class="source-code">GROUP BY</p><p class="source-code">        date;</p><p>The query creates the table <strong class="source-inline">iowa_liquor_sales</strong> in the dataset <strong class="source-inline">08_sales_forecasting</strong>.</p><p>The table contains two different fields: the <strong class="source-inline">date</strong> column represents when the transaction happened and the second field is calculated as the <strong class="source-inline">SUM</strong> of the liquor quantities sold in a day. <strong class="source-inline">total_sold_liters</strong> is an aggregated value calculated on the <strong class="source-inline">GROUP BY date</strong> clause and for each day of the years <strong class="source-inline">2018</strong> and <strong class="source-inline">2019</strong>.</p></li>
				<li>The second step will be to graphically analyze the data stored in the table <strong class="source-inline">iowa_liquor_sales</strong>.<p>As shown in the following screenshot, from the BigQuery navigation menu on the left, let's select the dataset <strong class="source-inline">08_sales_forecasting</strong> and then the table <strong class="source-inline">iowa_liquor_sales</strong>:</p><div id="_idContainer119" class="IMG---Figure"><img src="image/B16722_08_007.jpg" alt="Figure 8.7 – The training table iowa_liquor_sales is visible in the BigQuery navigation menu&#13;&#10;"/></div><p class="figure-caption">Figure 8.7 – The training table iowa_liquor_sales is visible in the BigQuery navigation menu</p></li>
				<li>After that, let's <a id="_idIndexMarker418"/>click on <strong class="bold">EXPORT</strong> and then <strong class="bold">Explore with Data Studio</strong> as presented in the following screenshot:<div id="_idContainer120" class="IMG---Figure"><img src="image/B16722_08_008.jpg" alt="Figure 8.8 – From BigQuery, it's possible to open Data Studio&#13;&#10;"/></div><p class="figure-caption">Figure 8.8 – From BigQuery, it's possible to open Data Studio</p><p><strong class="bold">Data Studio</strong> is a free data <a id="_idIndexMarker419"/>visualization tool <a id="_idIndexMarker420"/>provided by Google and natively integrated with BigQuery that can be easily used to plot data in reports and diagrams.</p></li>
				<li>In Data Studio, we can select <strong class="bold">Time series chart</strong> as the chart type as shown in the following screenshot:<div id="_idContainer121" class="IMG---Figure"><img src="image/B16722_08_009.jpg" alt="Figure 8.9 – In Data Studio, it's possible to select Time series chart to visualize the data&#13;&#10;"/></div><p class="figure-caption">Figure 8.9 – In Data Studio, it's possible to select Time series chart to visualize the data</p></li>
				<li>Then, we can choose the field <strong class="bold">date</strong> for <strong class="bold">Dimension</strong> and <strong class="bold">total_sold_liters</strong> for <strong class="bold">Metric</strong>, as is presented in the following screenshot:<div id="_idContainer122" class="IMG---Figure"><img src="image/B16722_08_010.jpg" alt="Figure 8.10 – In Data Studio, it's possible to select Dimension and Metric settings to draw the diagram&#13;&#10;"/></div><p class="figure-caption">Figure 8.10 – In Data Studio, it's possible to select Dimension and Metric settings to draw the diagram</p></li>
				<li>After that, we <a id="_idIndexMarker421"/>can move to the <strong class="bold">Style</strong> tab and select <strong class="bold">Linear interpolation</strong> in the <strong class="bold">Missing Data</strong> combo box:<div id="_idContainer123" class="IMG---Figure"><img src="image/B16722_08_011.jpg" alt="Figure 8.11 – The Linear interpolation option allows to improve the visualization &#13;&#10;of the diagram in case of missing values&#13;&#10;"/></div><p class="figure-caption">Figure 8.11 – The Linear interpolation option allows to improve the visualization of the diagram in case of missing values</p></li>
				<li>After these configurations, we can visualize the diagram drawn by Data Studio that represents the trend line of the liquor quantities sold in the selected period:</li>
			</ol>
			<div>
				<div id="_idContainer124" class="IMG---Figure">
					<img src="image/B16722_08_012.jpg" alt="Figure 8.12 – The time series is shown in Data Studio with a blue line on the chart&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.12 – The time series is shown in Data Studio with a blue line on the chart</p>
			<p>Now that we've <a id="_idIndexMarker422"/>created the table on which our forecasting model will be trained and visualized the data in a diagram, let's dive into the creation of the machine learning model.</p>
			<h1 id="_idParaDest-125"><a id="_idTextAnchor127"/>Training the time series forecasting model</h1>
			<p>In this section, we'll train <a id="_idIndexMarker423"/>the BigQuery ML time series forecasting model.</p>
			<p>Let's start training the machine learning model <strong class="source-inline">liquor_forecasting</strong>, executing the following SQL statement:</p>
			<p class="source-code">CREATE OR REPLACE MODEL `08_sales_forecasting.liquor_forecasting`</p>
			<p class="source-code">OPTIONS</p>
			<p class="source-code"> (model_type = 'ARIMA',</p>
			<p class="source-code">  time_series_timestamp_col = 'date',</p>
			<p class="source-code">  time_series_data_col = 'total_sold_liters',</p>
			<p class="source-code">  auto_arima = TRUE,</p>
			<p class="source-code">  data_frequency = 'AUTO_FREQUENCY'</p>
			<p class="source-code">) AS</p>
			<p class="source-code">SELECT *</p>
			<p class="source-code">FROM</p>
			<p class="source-code"> `08_sales_forecasting.iowa_liquor_sales`; </p>
			<p>The SQL statement is composed of the following parts:</p>
			<ul>
				<li>The first lines of the query start with the keywords <strong class="source-inline">CREATE OR REPLACE MODEL</strong>, followed by the identifier of the machine learning model, <strong class="source-inline">`08_sales_forecasting.liquor_forecasting`</strong>, and by  <strong class="source-inline">OPTIONS</strong>.</li>
				<li>Now let's focus on the options that we've used to train our machine learning model. The selected model type is <strong class="source-inline">'ARIMA'</strong>. This option describes the algorithm that we're using to train the BigQuery ML forecasting model.</li>
				<li><strong class="source-inline">time_series_timestamp_col = 'date'</strong> specifies the column that is used to host the time of the data points in the time series.</li>
				<li>The next option <a id="_idIndexMarker424"/>selects the column <strong class="source-inline">total_sold_liters</strong> as the column that stores the value of each data point and it's represented by the clause <strong class="source-inline">time_series_data_col = 'total_sold_liters'</strong>.</li>
				<li>The property <strong class="source-inline">auto_arima</strong>, set to <strong class="source-inline">TRUE</strong>, allows BigQuery ML to automatically identify the parameters <strong class="source-inline">p</strong>, <strong class="source-inline">d</strong>, and <strong class="source-inline">q</strong> of the model.</li>
				<li>With the last parameter, <strong class="source-inline">'AUTO_FREQUENCY'</strong>, BigQuery automatically infers the frequency of the time series. In this case, the frequency is daily. The other options are <strong class="source-inline">'HOURLY'</strong>, <strong class="source-inline">'DAILY'</strong>, <strong class="source-inline">'WEEKLY'</strong>, <strong class="source-inline">'MONTHLY'</strong>, <strong class="source-inline">'QUARTERLY'</strong>, and <strong class="source-inline">'YEARLY'</strong>.</li>
				<li>The final part of the SQL statement is composed of the <strong class="source-inline">SELECT</strong> statement applied on the training table <strong class="source-inline">iowa_liquor_sales</strong>.</li>
			</ul>
			<p>Now that we've trained  the time series forecasting model based on the ARIMA algorithm, let's take a look at how we can evaluate it with the BigQuery ML syntax and the BigQuery UI.</p>
			<h1 id="_idParaDest-126"><a id="_idTextAnchor128"/>Evaluating the time series forecasting model</h1>
			<p>In this section, we'll<a id="_idIndexMarker425"/> evaluate the performance of the machine learning model that we trained in the previous one.</p>
			<p>The evaluation stage of a time series model can be performed by using the <strong class="source-inline">ML.EVALUATE</strong> BigQuery ML function.</p>
			<p>Let's execute the following query to extract all the evaluation parameters that characterize the ARIMA model:</p>
			<p class="source-code">SELECT *</p>
			<p class="source-code">FROM</p>
			<p class="source-code"> ML.EVALUATE(MODEL `08_sales_forecasting.liquor_forecasting`);</p>
			<p>The results of the query are visualized in the following screenshot:</p>
			<div>
				<div id="_idContainer125" class="IMG---Figure">
					<img src="image/B16722_08_013.jpg" alt="Figure 8.13 – The records extracted from the evaluation of the time series forecasting model&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.13 – The records extracted from the evaluation of the time series forecasting model</p>
			<p>Each row defines each non-seasonal ARIMA model classified as an <strong class="bold">ARIMA(p,d,q)</strong> model. For each row, we can notice the following:</p>
			<ul>
				<li>The field <strong class="bold">non_seasonal_p</strong> represents the parameter <strong class="bold">p</strong> of the ARIMA model. The value of the row is the number of autoregressive terms used for the prediction. It indicates the number of observations used to predict the next value of the time series.</li>
				<li>The field <strong class="bold">non_seasonal_d</strong> represents the parameter <strong class="bold">d</strong> of the ARIMA model. The value of the row indicates how many times it's necessary to apply the difference between one data point and the previous one to mitigate the seasonality of the dataset.</li>
				<li><strong class="bold">non_seasonal_q</strong> represents the parameter <strong class="bold">q</strong> of the ARIMA model. It indicates the number of observations to calculate the <a id="_idIndexMarker426"/>moving average that is used to predict the next value of the time series.</li>
				<li><strong class="bold">has_drift</strong> shows if a drift constant was applied to the model.</li>
				<li><strong class="bold">log_likelihood</strong> is a parameter that measures the level of fit of a statistical model to a specific dataset.</li>
				<li><strong class="bold">AIC</strong> represents the <strong class="bold">Akaike Information Criterion</strong>. This value is used to evaluate the goodness<a id="_idIndexMarker427"/> of the model. Lower values of AIC are generally better. For this reason, we can consider the first model the best.</li>
				<li><strong class="bold">variance</strong> measures how far the data points are from the average value of the series.</li>
				<li>The <strong class="bold">seasonal_periods</strong> column expresses the seasonal patterns in our data. In this case, BigQuery ML has identified a <strong class="bold">WEEKLY</strong> and <strong class="bold">YEARLY</strong> pattern in the sales time series.</li>
			</ul>
			<p>Now that we've presented the performance indicators of our time series forecasting model, let's try using it to forecast the first 30 days of 2020.</p>
			<h1 id="_idParaDest-127"><a id="_idTextAnchor129"/>Using the time series forecasting model</h1>
			<p>To use our <a id="_idIndexMarker428"/>BigQuery ML model, we'll use the <strong class="source-inline">ML.FORECAST</strong> function to specify the parameters for the prediction.</p>
			<p>The query will extract all the fields produced by the forecast function that accepts the following parameters:</p>
			<ul>
				<li>The model name, <strong class="source-inline">`08_sales_forecasting.liquor_forecasting`</strong>, preceded by the keyword <strong class="source-inline">MODEL</strong>.</li>
				<li>A <strong class="source-inline">STRUCT</strong> that includes the <strong class="source-inline">horizon</strong> of the forecast: <strong class="source-inline">30</strong> days and the <strong class="source-inline">confidence_level</strong> chosen for the prediction – in this case, 80%:<p class="source-code">SELECT</p><p class="source-code">  *</p><p class="source-code">FROM</p><p class="source-code">  ML.FORECAST(MODEL `08_sales_forecasting.liquor_forecasting`,</p><p class="source-code">              STRUCT(30 AS horizon, 0.8 AS confidence_level)); </p></li>
			</ul>
			<p>The execution of the query generates the records shown in the following screenshot:</p>
			<div>
				<div id="_idContainer126" class="IMG---Figure">
					<img src="image/B16722_08_014.jpg" alt="Figure 8.14 – The results generated by the forecast function&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.14 – The results generated by the forecast function</p>
			<p>We can notice in <em class="italic">Figure 8.14</em> that the predictions are chronologically ordered according to the date in the field <strong class="bold">forecast_timestamp</strong>. Each row represents a day and its related field <strong class="bold">forecast_value</strong> predicted by the BigQuery ML model. Since we've selected a horizon of 30 days, our<a id="_idIndexMarker429"/> result set is composed of 30 rows that go from January 1, 2020 to January 30 of the same year. The <strong class="source-inline">confidence_level</strong> value of 0.8 means that 80% of the predicted values should fall into the prediction interval identified by the fields <strong class="bold">prediction_interval_lower_bound</strong> and <strong class="bold">prediction_interval_upper_bound</strong>.</p>
			<p>Now that we've applied our model, let's understand how we can effectively present the results using Data Studio.</p>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor130"/>Presenting the forecast</h1>
			<p>In this section, we'll <a id="_idIndexMarker430"/>create a time series diagram with Data Studio in order to graphically present the forecast results. </p>
			<p>Using the following query, we can create a table that contains both the historical and forecasted values: </p>
			<p class="source-code">CREATE OR REPLACE TABLE `08_sales_forecasting.iowa_liquor_sales_forecast` AS</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">  history_date AS date,</p>
			<p class="source-code">  history_value,</p>
			<p class="source-code">  NULL AS forecast_value,</p>
			<p class="source-code">  NULL AS prediction_interval_lower_bound,</p>
			<p class="source-code">  NULL AS prediction_interval_upper_bound</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  (</p>
			<p class="source-code">    SELECT</p>
			<p class="source-code">      date AS history_date,</p>
			<p class="source-code">      total_sold_liters AS history_value</p>
			<p class="source-code">    FROM</p>
			<p class="source-code">      `08_sales_forecasting.iowa_liquor_sales`</p>
			<p class="source-code">  )</p>
			<p class="source-code">UNION ALL</p>
			<p class="source-code">SELECT</p>
			<p class="source-code">  CAST(forecast_timestamp AS DATE) AS date,</p>
			<p class="source-code">  NULL AS history_value,</p>
			<p class="source-code">  forecast_value,</p>
			<p class="source-code">  prediction_interval_lower_bound,</p>
			<p class="source-code">  prediction_interval_upper_bound</p>
			<p class="source-code">FROM</p>
			<p class="source-code">  ML.FORECAST(MODEL `08_sales_forecasting.liquor_forecasting`,</p>
			<p class="source-code">              STRUCT(30 AS horizon, 0.8 AS confidence_level));</p>
			<p>The execution of the SQL statement generates the table <strong class="source-inline">iowa_liquor_sales_forecast</strong>, which is composed of the following:</p>
			<ul>
				<li>All the records are from the training table, <strong class="source-inline">iowa_liquor_sales</strong>, from which we have extracted  <strong class="source-inline">history_date</strong> and  <strong class="source-inline">history_value</strong> of the time series. We've also <a id="_idIndexMarker431"/>added some <strong class="source-inline">NULL</strong> fields to standardize the schema with the second part of the query separated by  <strong class="source-inline">UNION ALL</strong>.</li>
				<li>All the forecasted records generated by the <strong class="source-inline">ML.FORECAST</strong> function were already applied in the previous section, <em class="italic">Using the time series forecasting model</em>. It's particularly interesting to notice that we don't extract only  <strong class="source-inline">forecast_value</strong>, but also the lower and upper bounds of our predictions represented by the fields <strong class="source-inline">prediction_interval_lower_bound</strong> and <strong class="source-inline">prediction_interval_upper_bound</strong>.</li>
				<li>The presence of the <strong class="source-inline">CAST</strong> function, applied to the column <strong class="source-inline">forecast_timestamp</strong>, is necessary to change the data type from <strong class="source-inline">TIMESTAMP</strong> to <strong class="source-inline">DATE</strong> according <a id="_idIndexMarker432"/>to the schema of the training table.</li>
			</ul>
			<p>As we've already done in the section <em class="italic">Creating the training dataset</em>, we can now do the following:</p>
			<ol>
				<li value="1">Select from the BigQuery navigation menu the <strong class="source-inline">iowa_liquor_sales_forecast</strong> table that we just created.</li>
				<li>Click on <strong class="bold">Export</strong> and then <strong class="bold">Explore with Data Studio</strong> to access the reporting tool.</li>
				<li>From the <strong class="bold">chart </strong>panel, choose <strong class="bold">Time series chart</strong>.</li>
				<li>Drag and drop <strong class="bold">history_value</strong>, <strong class="bold">forecast_value</strong>, <strong class="bold">prediction_interval_lower_bound</strong>, and <strong class="bold">prediction_interval_upper_bound</strong> into the <strong class="bold">Metric</strong> panel as shown in the following screenshot:<div id="_idContainer127" class="IMG---Figure"><img src="image/B16722_08_015.jpg" alt="Figure 8.15 – The DATA panel allows us to customize the metrics of the chart&#13;&#10;"/></div><p class="figure-caption">Figure 8.15 – The DATA panel allows us to customize the metrics of the chart</p></li>
				<li>Move to the <strong class="bold">Style</strong> panel and<a id="_idIndexMarker433"/> scroll down until we find the <strong class="bold">Missing Data</strong> section. Here, we select <strong class="bold">Linear interpolation</strong>.</li>
				<li>Then, at the top of the screen, we can apply a filter on the <strong class="bold">date</strong> column to focus our chart only on the period that goes from the first of <strong class="bold">December 2019</strong> until the thirtieth of <strong class="bold">January 2020</strong>:<div id="_idContainer128" class="IMG---Figure"><img src="image/B16722_08_016.jpg" alt="Figure 8.16 – Application of the filter on the date column&#13;&#10;"/></div><p class="figure-caption">Figure 8.16 – Application of the filter on the date column</p></li>
				<li>Clicking on <strong class="bold">APPLY</strong>, the chart <a id="_idIndexMarker434"/>will be finally visualized as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer129" class="IMG---Figure">
					<img src="image/B16722_08_017.jpg" alt="Figure 8.17 – Time series chart in Data Studio&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.17 – Time series chart in Data Studio</p>
			<p>Looking at the legend of the<a id="_idIndexMarker435"/> diagram, we can visualize the historical and the forecasted values represented by different colors. We can also notice that the <strong class="bold">forecast_value</strong> line is always included in the prediction interval.</p>
			<h1 id="_idParaDest-129"><a id="_idTextAnchor131"/>Summary</h1>
			<p>In this chapter, we've built our time series forecasting machine learning model. After the introduction of the business scenario, we discovered what time series forecasting is, and in particular, the ARIMA algorithm that is used to predict values from historical data points.</p>
			<p>Before diving into the development of the BigQuery ML model, we applied some analyses on the data collected by the state of Iowa related to liquor sales in the shops of the territory. For this purpose, we introduced the use of the reporting tool Data Studio, which can be easily accessed by the BigQuery UI and be leveraged to draw a time series chart.</p>
			<p>We then created our training table, which includes the time series of historical data, and trained our BigQuery ML model on it. Then, we evaluated the time series forecasting model by leveraging the BigQuery ML SQL syntax.</p>
			<p>In the last step, we forecasted the quantity of liquor sold in Iowa with a horizon of 30 days and drew the results in a Data Studio dashboard that could be presented to non-technical people.</p>
			<p>In the next chapter, we'll introduce the matrix factorization algorithm to build recommendation engines.</p>
			<h1 id="_idParaDest-130"><a id="_idTextAnchor132"/>Further resources</h1>
			<ul>
				<li><strong class="bold">Iowa Liquor Retail Sales Public Dataset</strong>: <a href="https://console.cloud.google.com/marketplace/product/iowa-department-of-commerce/iowa-liquor-sales">https://console.cloud.google.com/marketplace/product/iowa-department-of-commerce/iowa-liquor-sales</a></li>
				<li><strong class="bold">BigQuery ML Create Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create</a></li>
				<li><strong class="bold">BigQuery ML Evaluate Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery ML Forecast</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-forecast">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-forecast</a></li>
				<li><strong class="bold">BigQuery ML Time Series Forecasting example</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/arima-single-timeseries-forecasting-tutorial">https://cloud.google.com/bigquery-ml/docs/arima-single-timeseries-forecasting-tutorial</a></li>
			</ul>
		</div>
	</body></html>