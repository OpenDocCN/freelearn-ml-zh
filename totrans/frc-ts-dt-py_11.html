<html><head></head><body>
<div id="_idContainer241">
<h1 class="chapter-number" id="_idParaDest-121"><a id="_idTextAnchor728"/><a id="_idTextAnchor729"/><a id="_idTextAnchor730"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-122"><a id="_idTextAnchor731"/><span class="koboSpan" id="kobo.2.1">Managing Uncertainty Intervals</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Forecasting</span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.4.1"> is essentially predicting the future, and with any prediction, there will be a particular amount of uncertainty. </span><span class="koboSpan" id="kobo.4.2">Quantifying this uncertainty provides an analyst with an understanding of how reliable their forecasts are, and provides their manager the confidence required to stake a lot of capital on </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">a decision.</span></span></p>
<p><span class="koboSpan" id="kobo.6.1">Prophet was designed from the ground up with</span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.7.1"> uncertainty modeling in mind. </span><span class="koboSpan" id="kobo.7.2">Although you interact with it using </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.8.1">either </span><strong class="bold"><span class="koboSpan" id="kobo.9.1">Python</span></strong><span class="koboSpan" id="kobo.10.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.11.1">R</span></strong><span class="koboSpan" id="kobo.12.1">, the underlying model is built in </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.13.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.14.1">Stan</span></strong><span class="koboSpan" id="kobo.15.1"> programming language, a probabilistic language that allows Prophet to perform </span><strong class="bold"><span class="koboSpan" id="kobo.16.1">Bayesian sampling</span></strong><span class="koboSpan" id="kobo.17.1"> in an </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.18.1">efficient manner to provide a deeper understanding of the uncertainty in the model, and thus the business risk of </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">the forecast.</span></span></p>
<p><span class="koboSpan" id="kobo.20.1">There are three sources of uncertainty</span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.21.1"> that contribute to the total uncertainty in your </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">Prophet model:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.23.1">Uncertainty in </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">the trend</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Uncertainty in the seasonality, holidays, and </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">additional regressors</span></span></li>
<li><span class="koboSpan" id="kobo.27.1">Uncertainty due to noise in </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">the data</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.29.1">The last of these is an inherent attribute of whatever data you are using, but the first two can be modeled and examined. </span><span class="koboSpan" id="kobo.29.2">In this chapter, you will learn how Prophet models uncertainty, how you can control it in your model, and how you can use these uncertainty estimations to quantify risk. </span><span class="koboSpan" id="kobo.29.3">Specifically, this chapter will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.31.1">Modeling uncertainty </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">in trends</span></span></li>
<li><span class="koboSpan" id="kobo.33.1">Modeling uncertainty </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">in season</span><a id="_idTextAnchor732"/><a id="_idTextAnchor733"/><span class="koboSpan" id="kobo.35.1">ality</span></span></li>
</ul>
<h1 id="_idParaDest-123"><a id="_idTextAnchor734"/><span class="koboSpan" id="kobo.36.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.37.1">The data files and code for the examples in this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">at </span></span><a href="https://github.com/PacktPublishing/Forecasting-Time-Series-Data-with-Prophet-Second-Edition"><span class="No-Break"><span class="koboSpan" id="kobo.39.1">https://github.com/PacktPublishing/Forecasting-Time-Series-Data-with-Prophet-Second-Edition</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.40.1">.</span></span></p>
<h1 id="_idParaDest-124"><a id="_idTextAnchor735"/><span class="koboSpan" id="kobo.41.1">Modeling uncertainty in trends</span></h1>
<p><span class="koboSpan" id="kobo.42.1">You may have notic</span><a id="_idTextAnchor736"/><span class="koboSpan" id="kobo.43.1">ed in </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.44.1">different component plots throughout this book </span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.45.1">that the trend shows uncertainty bounds, while the seasonality curves do </span><a id="_idTextAnchor737"/><span class="koboSpan" id="kobo.46.1">not. </span><span class="koboSpan" id="kobo.46.2">By default, Prophet only estimates uncertainty in the trend, plus uncertainty due to random noise in the data. </span><span class="koboSpan" id="kobo.46.3">The noise is modeled as a normal distribution around the trend an</span><a id="_idTextAnchor738"/><span class="koboSpan" id="kobo.47.1">d trend uncertainty is modeled</span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.48.1"> with </span><strong class="bold"><span class="koboSpan" id="kobo.49.1">maximum a posteriori </span></strong><span class="koboSpan" id="kobo.50.1">(</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.51.1">MAP</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">)</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.53.1"> estimation</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">MAP estimation is an optimization problem that is solved with </span><strong class="bold"><span class="koboSpan" id="kobo.56.1">Monte Carlo simulations</span></strong><span class="koboSpan" id="kobo.57.1">. </span><span class="koboSpan" id="kobo.57.2">Named </span><a id="_idTextAnchor739"/><span class="koboSpan" id="kobo.58.1">after the</span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.59.1"> famous casino in Monaco, the Monte Carlo method uses repeated random sampling to estimate an unknown value, usually used when closed-form equations are either non-existent or </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">computationally difficult.</span></span></p>
<p><span class="koboSpan" id="kobo.61.1">In </span><a href="B19630_06.xhtml#_idTextAnchor375"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.62.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.63.1">, </span><em class="italic"><span class="koboSpan" id="kobo.64.1">Forecasting Holiday Effects</span></em><span class="koboSpan" id="kobo.65.1">, we talked </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.66.1">about </span><strong class="bold"><span class="koboSpan" id="kobo.67.1">prior distributions</span></strong><span class="koboSpan" id="kobo.68.1">, or the </span><strong class="bold"><span class="koboSpan" id="kobo.69.1">probability distribution</span></strong><span class="koboSpan" id="kobo.70.1"> of an</span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.71.1"> estimate prior to receiving additional information about it. </span><span class="koboSpan" id="kobo.71.2">In MAP estimation, you are es</span><a id="_idTextAnchor740"/><span class="koboSpan" id="kobo.72.1">timating the central</span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.73.1"> tendency of a </span><strong class="bold"><span class="koboSpan" id="kobo.74.1">posterior distribution</span></strong><span class="koboSpan" id="kobo.75.1">, or a probability distribution, after learning additional information. </span><span class="koboSpan" id="kobo.75.2">In the case of trend uncertainty, the posterior distribution is the distribution of estimated trend values at each date, after seeing the training data. </span><span class="koboSpan" id="kobo.75.3">This optimization problem is a relatively quick problem to solve. </span><span class="koboSpan" id="kobo.75.4">So, even with many iterations, it can complete in just seconds during the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.76.1">model.fit(df)</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.77.1"> call.</span></span></p>
<p><span class="koboSpan" id="kobo.78.1">Let’s take a look at some Prophet parameters you can use to control trend uncertainty. </span><span class="koboSpan" id="kobo.78.2">We’re going to use a new dataset in this chapter, covering the number of crimes reported to the Baltimore police department each day from 2011 through 2019. </span><span class="koboSpan" id="kobo.78.3">Let’s begin with our imports and loading </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">the data:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.80.1">
import pandas as pd
import matplotlib.pyplot as plt
from prophet import Prophet
from prophet.plot import add_changepoints_to_plot
import numpy as np
np.random.seed(42)
df = pd.read_csv('baltimore_crime.csv')
df.columns = ['ds', 'y']</span></pre>
<p><span class="koboSpan" id="kobo.81.1">If you plot the data, you’ll see </span><a id="_idTextAnchor741"/><span class="koboSpan" id="kobo.82.1">that it has a relatively flat trend, seasonality, and a couple of outliers. </span><span class="koboSpan" id="kobo.82.2">In parti</span><a id="_idTextAnchor742"/><span class="koboSpan" id="kobo.83.1">cular, I have drawn a dashed line in the following graph at the level of 250 </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.84.1">crimes </span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.85.1">per day. </span><span class="koboSpan" id="kobo.85.2">There are two data points abo</span><a id="_idTextAnchor743"/><span class="koboSpan" id="kobo.86.1">ve </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">this line:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer229">
<span class="koboSpan" id="kobo.88.1"><img alt="Figure 11.1 – Baltimore crime data" src="image/Fig_11.1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.89.1">Figure 11.1 – Baltimore crime data</span></p>
<p><span class="koboSpan" id="kobo.90.1">Although those points probably won’t affect our forecasts as much as the outliers did in the National Geographic data we looked at in </span><a href="B19630_10.xhtml#_idTextAnchor641"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.91.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.92.1">, </span><em class="italic"><span class="koboSpan" id="kobo.93.1">Accounting for Outliers and Special Events</span></em><span class="koboSpan" id="kobo.94.1">, let’s re</span><a id="_idTextAnchor744"/><span class="koboSpan" id="kobo.95.1">move them and avoid any potential issues </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.97.1">
df.loc[df['y'] &gt; 250, 'y'] = None</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.98.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.99.1">Notice that we imported NumPy and set the random seed. </span><span class="koboSpan" id="kobo.99.2">MAP estimation is a deterministic calculation in Prophet, so you will always get the same trend repeatedly (or, very nearly the same trend, due to slight differences in how different machines handle floating-point numbers). </span><span class="koboSpan" id="kobo.99.3">However, the uncertainty intervals are randomly created. </span><span class="koboSpan" id="kobo.99.4">With 1,000 iterations, they should be very similar in repeated experiments, but if no random seed was set, then your</span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.100.1"> plots may not match those in this book. </span><span class="koboSpan" id="kobo.100.2">Furthermore, </span><strong class="bold"><span class="koboSpan" id="kobo.101.1">Markov chain Monte Carlo </span></strong><span class="koboSpan" id="kobo.102.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.103.1">MCMC</span></strong><span class="koboSpan" id="kobo.104.1">) sampling, which is used when uncertainty estimates f</span><a id="_idTextAnchor745"/><span class="koboSpan" id="kobo.105.1">or seasonality are needed and will be discussed later in this chapter, does add randomness to the trend calculations. </span><span class="koboSpan" id="kobo.105.2">Setting the random seed will ensure that you get the same results as </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">this book.</span></span></p>
<p><span class="koboSpan" id="kobo.107.1">The </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.108.1">biggest </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.109.1">sour</span><a id="_idTextAnchor746"/><span class="koboSpan" id="kobo.110.1">ce of uncertainty in the Prophet forecast comes from the potential for future trend changes. </span><span class="koboSpan" id="kobo.110.2">When training the model, Prophet runs through many Monte Carlo simulations for the future, assuming that future trend changepoints will occur with the same frequency and magnitude as the historical changepoints. </span><span class="koboSpan" id="kobo.110.3">For this reason, a time series with large-magnitude changepoints in its history will see very wide trend uncertainty; we saw this with the National Geographic Instagram data in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.111.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.112.1">.7</span></em><span class="koboSpan" id="kobo.113.1"> from </span><a href="B19630_10.xhtml#_idTextAnchor641"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.114.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.115.1">, </span><em class="italic"><span class="koboSpan" id="kobo.116.1">Accounting for Outliers and </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.117.1">Special Events</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.119.1">The number of Monte Carlo simulations Prophet runs through is set with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">uncertainty_samples</span></strong><span class="koboSpan" id="kobo.121.1"> argument during model instantiation. </span><span class="koboSpan" id="kobo.121.2">By default, it is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">1000</span></strong><span class="koboSpan" id="kobo.123.1">, so Prophet simulates 1,000 different future trend lines and uses these to </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">estimate uncertainty.</span></span></p>
<p><span class="koboSpan" id="kobo.125.1">Let’s build our first model explicitly stating this default by setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">uncertainty_samples=1000</span></strong><span class="koboSpan" id="kobo.127.1"> when instantiating our model. </span><span class="koboSpan" id="kobo.127.2">We’ll then fit the model, create a five-year forecast, and plot it with the changepoints. </span><span class="koboSpan" id="kobo.127.3">For this Baltimore crime data, we can keep all the other</span><a id="_idTextAnchor747"/><span class="koboSpan" id="kobo.128.1"> defaults during </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">model instantiation:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.130.1">
model = Prophet(uncertainty_samples=1000)
model.fit(df)
future = model.make_future_dataframe(periods=365 * 5)
forecast = model.predict(future)
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.131.1">It loo</span><a id="_idTextAnchor748"/><span class="koboSpan" id="kobo.132.1">ks like crime in Baltimore was up in 2011 at the beginning of the dataset, dropped a bit over the next few years, and then rose again, before dropping. </span><span class="koboSpan" id="kobo.132.2">Prophet continues this</span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.133.1"> trend onward </span><a id="_idTextAnchor749"/><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.134.1">into </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">the future:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer230">
<span class="koboSpan" id="kobo.136.1"><img alt="Figure 11.2 – Baltimore crime forecast with 1,000 uncertainty samples" src="image/Fig_11.2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.137.1">Figure 11.2 – Baltimore crime forecast with 1,000 uncertainty samples</span></p>
<p><span class="koboSpan" id="kobo.138.1">The uncertainty (</span><a id="_idTextAnchor750"/><span class="koboSpan" id="kobo.139.1">the lighter-shaded area in the plot) exists throughout both the historical and future points. </span><span class="koboSpan" id="kobo.139.2">Now, let’s plot </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">the components:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.141.1">
fig2 = model.plot_components(forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.142.1">The</span><a id="_idTextAnchor751"/><span class="koboSpan" id="kobo.143.1"> trend uncertainty only exists in the forecasted future; there is no uncertainty evident in the </span><a id="_idTextAnchor752"/><span class="No-Break"><span class="koboSpan" id="kobo.144.1">historical data:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer231">
<span class="koboSpan" id="kobo.145.1"><img alt="Figure 11.3 – Baltimore crime components plot with 1,000 uncertainty samples" src="image/Fig_11.3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.146.1">Figure 11.3 – Baltimore crime components plot with 1,000 uncertainty samples</span></p>
<p><span class="koboSpan" id="kobo.147.1">This is</span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.148.1"> because all historical uncertainty is attributed to noise. </span><span class="koboSpan" id="kobo.148.2">As I</span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.149.1"> said earlier, the noise is modeled as a normal distribution around the prediction. </span><span class="koboSpan" id="kobo.149.2">As trend uncertainty is due to uncertainty with future trend changepoints, trend uncertainty only exists in the future. </span><span class="koboSpan" id="kobo.149.3">The total uncertainty seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.150.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.151.1">.2</span></em><span class="koboSpan" id="kobo.152.1"> is the noise uncertainty plus the trend unce</span><a id="_idTextAnchor753"/><span class="koboSpan" id="kobo.153.1">rtainty. </span><span class="koboSpan" id="kobo.153.2">Also, the Prophet team notes that their assumption that future trend changes will never be of greater magnitude than previous trend changes is a very limiti</span><a id="_idTextAnchor754"/><span class="koboSpan" id="kobo.154.1">ng assumption, and so you should not expect to get extremely accurate coverage on </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">uncertainty intervals.</span></span></p>
<p><span class="koboSpan" id="kobo.156.1">When Prophet ran through those 1,000 iterations to estimate future trend changes, it saved each result in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">predictive_samples</span></strong><span class="koboSpan" id="kobo.158.1"> attribute of the model. </span><span class="koboSpan" id="kobo.158.2">This is a dictionary with keys of </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">'yhat'</span></strong><span class="koboSpan" id="kobo.160.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">'trend'</span></strong><span class="koboSpan" id="kobo.162.1">, storing, respectively, the estimated values for the total prediction and the prediction of just the trend, for </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">each iteration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.164.1">
samples = model.predictive_samples(future)</span></pre>
<p><span class="koboSpan" id="kobo.165.1">By plotting </span><strong class="source-inline"><span class="koboSpan" id="kobo.166.1">samples['trend']</span></strong><span class="koboSpan" id="kobo.167.1"> against </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">future['ds']</span></strong><span class="koboSpan" id="kobo.169.1">, for each sample, you can see each of</span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.170.1"> Prophet’s 1,000 </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.171.1">potential</span><a id="_idTextAnchor755"/> <span class="No-Break"><span class="koboSpan" id="kobo.172.1">trend simulations:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer232">
<span class="koboSpan" id="kobo.173.1"><img alt="Figure 11.4 – Baltimore crime trend with 1,000 uncertainty samples" src="image/Fig_11.4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.174.1">Figure 11.4 – Baltimore crime trend with 1,000 uncertainty samples</span></p>
<p><span class="koboSpan" id="kobo.175.1">By default, Prophet has an uncertainty interval of 80%. </span><span class="koboSpan" id="kobo.175.2">Each of those 1,000 possible trend lines are equally probable within an 80% confidence level. </span><span class="koboSpan" id="kobo.175.3">Because future uncertainty is estimated from future potential changepoints, which are, in turn, estimated from previous changepoints, increasing or decreasing the number of previous changepoints through the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.177.1"> will have a matching effect on </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">uncertainty bounds.</span></span></p>
<p><span class="koboSpan" id="kobo.179.1">It is usually unnecessary to change the number of uncertainty samples to anything other than the default.</span><a id="_idTextAnchor756"/><span class="koboSpan" id="kobo.180.1"> Increasing it will give you a better estimate of uncertainty, at the cost of computing time, but 1,000 samples is usually plenty to get a good estimate. </span><span class="koboSpan" id="kobo.180.2">Setting the argument to either </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">uncertainty_samples=0</span></strong><span class="koboSpan" id="kobo.182.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">uncertainty_samples=False</span></strong><span class="koboSpan" id="kobo.184.1"> is a special case, though, which disables uncertainty estimation and speeds up </span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">calculations significantly.</span></span></p>
<p><span class="koboSpan" id="kobo.186.1">The uncertainty level can be controlled through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">interval_width</span></strong><span class="koboSpan" id="kobo.188.1"> argument. </span><span class="koboSpan" id="kobo.188.2">If you </span><a id="_idTextAnchor757"/><span class="koboSpan" id="kobo.189.1">want more confidence in your uncertainty levels, you may want to increase this value; decreasing it will give you tighter limits but less confidence. </span><span class="koboSpan" id="kobo.189.2">Let’s increase the width to </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">0.99</span></strong><span class="koboSpan" id="kobo.191.1">, for a 99% </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">confidence level:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.193.1">
model = Prophet(interval_width=0.99)
model.fit(df)
future = model.make_future_dataframe(periods=365 * 5)
forecast = model.predict(future)</span></pre>
<p><span class="koboSpan" id="kobo.194.1">I’ll only plot the trend, as that is where the effect of this change is </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">most evident:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.196.1">
from prophet.plot import plot_forecast_component
plot_forecast_component(model,
                        forecast,
                        ‹trend›,
                        figsize=(10.5, 3.25))
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.197.1">Compare the </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.198.1">following diagram</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.199.1"> with the trend compo</span><a id="_idTextAnchor758"/><span class="koboSpan" id="kobo.200.1">nent in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.201.1">Figure 11</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.202.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer233">
<span class="koboSpan" id="kobo.204.1"><img alt="Figure 11.5 – Baltimore crime trend with a 99% uncertainty interval width" src="image/Fig_11.5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.205.1">Figure 11.5 – Baltimore crime trend with a 99% uncertainty interval width</span></p>
<p><span class="koboSpan" id="kobo.206.1">The wid</span><a id="_idTextAnchor759"/><span class="koboSpan" id="kobo.207.1">th of </span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.208.1">uncertainty is much greater in this plot. </span><span class="koboSpan" id="kobo.208.2">Because we want higher </span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.209.1">confidence that the bounds contain the true trend, we have to expand the bounds to provide this </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">higher certainty.</span></span></p>
<p><span class="koboSpan" id="kobo.211.1">You</span><a id="_idTextAnchor760"/><span class="koboSpan" id="kobo.212.1">’ve been modeling trend uncertainty throughout this book. </span><span class="koboSpan" id="kobo.212.2">But now you want to see uncertainty bounds in seasonality as well. </span><span class="koboSpan" id="kobo.212.3">In the next section, you’ll learn h</span><a id="_idTextAnchor761"/><a id="_idTextAnchor762"/><span class="koboSpan" id="kobo.213.1">ow to </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">accomplish this.</span></span></p>
<h1 id="_idParaDest-125"><a id="_idTextAnchor763"/><span class="koboSpan" id="kobo.215.1">Modeling uncertainty in seasonality</span></h1>
<p><span class="koboSpan" id="kobo.216.1">MAP estimat</span><a id="_idTextAnchor764"/><span class="koboSpan" id="kobo.217.1">ion is very fast, which is why it is Prophet’</span><a id="_idTextAnchor765"/><span class="koboSpan" id="kobo.218.1">s default mode, but it will not work with seasonalities, so a different method is needed. </span><span class="koboSpan" id="kobo.218.2">To model seasonality uncertainty, Prophet needs to use an MCMC method. </span><span class="koboSpan" id="kobo.218.3">A </span><strong class="bold"><span class="koboSpan" id="kobo.219.1">Marko</span><a id="_idTextAnchor766"/><span class="koboSpan" id="kobo.220.1">v chain</span></strong><span class="koboSpan" id="kobo.221.1"> is </span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.222.1">a model that describes a sequence of events, with the probability of each event depending upon the</span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.223.1"> state in the previous event. </span><span class="koboSpan" id="kobo.223.2">Prophet models </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.224.1">seasonal uncertainty with this chained sequence and uses the Monte Carlo method, which was described at the beginning of the previous section, to repeat the sequence </span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">many times.</span></span></p>
<p><span class="koboSpan" id="kobo.226.1">The downside is that MCMC sampling is slow; on a macOS or Linux machine, you should expect fitting times of several minutes instead of several seconds. </span><span class="koboSpan" id="kobo.226.2">On a Windows machine, unfortunately, the PyStan API, which interfaces with Prophet’s model in the Stan language, has upstream issues, meaning MCMC sampling is extremely slow. </span><span class="koboSpan" id="kobo.226.3">Depending upon the number of data points, fitting a model on a Windows machine can sometimes take </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">several hours.</span></span></p>
<p><span class="koboSpan" id="kobo.228.1">The Prophet team recommends that users on Windows machines work with Prophet in R or use Python in a Linux virtual machine. </span><span class="koboSpan" id="kobo.228.2">Another alternative is to use Google’s Colab notebooks, which are similar to cloud-hosted Jupyter notebooks. </span><span class="koboSpan" id="kobo.228.3">They are free to use and are built in Linux, so they do not face the PyStan issues that Windows does. </span><span class="koboSpan" id="kobo.228.4">You can access them </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">at </span></span><a href="https://colab.research.google.com/"><span class="No-Break"><span class="koboSpan" id="kobo.230.1">https://colab.research.google.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.231.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.232.1">With that caveat out of the way, let’s see how to model uncertainty in seasonality. </span><span class="koboSpan" id="kobo.232.2">We will leave the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">1000</span></strong><span class="koboSpan" id="kobo.234.1"> uncertainty samples that we’ve used so far and add a different argumen</span><a id="_idTextAnchor767"/><span class="koboSpan" id="kobo.235.1">t for </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">mcmc_samples</span></strong><span class="koboSpan" id="kobo.237.1">. </span><span class="koboSpan" id="kobo.237.2">If you set this argument to </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">0</span></strong><span class="koboSpan" id="kobo.239.1">, Prophet will revert to MAP estimation and only provid</span><a id="_idTextAnchor768"/><span class="koboSpan" id="kobo.240.1">e uncertainty in the trend component, reverting to the models we created in the previous examples in this chapter. </span><span class="koboSpan" id="kobo.240.2">We will use 300 </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">MCMC samples:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.242.1">
model = Prophet(mcmc_samples=300)
model.fit(df)
future = model.make_future_dataframe(periods=365 * 5)
forecast = model.predict(future)
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.243.1">After fitting</span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.244.1"> and predicting, we plot the forecast. </span><span class="koboSpan" id="kobo.244.2">The first thing that</span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.245.1"> may jump out at you is the number of changepoints, as can be se</span><a id="_idTextAnchor769"/><span class="koboSpan" id="kobo.246.1">en in the </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">following graph:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer234">
<span class="koboSpan" id="kobo.248.1"><img alt="Figure 11.6 – Baltimore crime forecast with 300 MCMC samples" src="image/Fig_11.6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.249.1">Figure 11.6 – Baltimore crime forecast with 300 MCMC samples</span></p>
<p><span class="koboSpan" id="kobo.250.1">We’ll</span><a id="_idTextAnchor770"/><span class="koboSpan" id="kobo.251.1"> deal with that changepoint issue in a bit. </span><span class="koboSpan" id="kobo.251.2">Now</span><a id="_idTextAnchor771"/><span class="koboSpan" id="kobo.252.1"> though, let’s look at the </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">components plot:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.254.1">
fig2 = model.plot_components(forecast)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.255.1">You should now see uncertainty intervals around both the </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">weekly</span></strong><span class="koboSpan" id="kobo.257.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">yearly</span></strong> <a id="_idTextAnchor772"/><span class="koboSpan" id="kobo.259.1">seasonalities </span><span class="No-Break"><span class="koboSpan" id="kobo.260.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer235">
<span class="koboSpan" id="kobo.261.1"><img alt="Figure 11.7 – Baltimore crime components plot with 300 MCMC samples" src="image/Fig_11.7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.262.1">Figure 11.7 – Baltimore crime components plot with 300 MCMC samples</span></p>
<p><span class="koboSpan" id="kobo.263.1">Had we added </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.264.1">holidays or any additional regressors, you’d see</span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.265.1"> uncertainty intervals there, too. </span><span class="koboSpan" id="kobo.265.2">Go ahead and try it out yourself, using the Divvy example from </span><a href="B19630_09.xhtml#_idTextAnchor599"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.266.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.267.1">, </span><em class="italic"><span class="koboSpan" id="kobo.268.1">Including </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.269.1">Additional Regressors</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.271.1">In this model, we accepted the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">uncertainty_samples=1000</span></strong><span class="koboSpan" id="kobo.273.1"> argument and set </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">mcmc_samples=300</span></strong><span class="koboSpan" id="kobo.275.1">. </span><span class="koboSpan" id="kobo.275.2">When Prophet runs its MCMC method, it uses a total of four chains (although this value can be changed using the keyword </span><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">chains</span></strong><span class="koboSpan" id="kobo.277.1"> argument in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">fit</span></strong><span class="koboSpan" id="kobo.279.1"> call). </span><span class="koboSpan" id="kobo.279.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">mcmc_samples</span></strong><span class="koboSpan" id="kobo.281.1"> argument is the total number of samples generated per chain. </span><span class="koboSpan" id="kobo.281.2">This is different from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">uncertainty_samples</span></strong><span class="koboSpan" id="kobo.283.1"> argument, which is the total number of sampled trend lines </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">to generate.</span></span></p>
<p><span class="koboSpan" id="kobo.285.1">When </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">m</span><a id="_idTextAnchor773"/><span class="koboSpan" id="kobo.287.1">cmc_samples=0</span></strong><span class="koboSpan" id="kobo.288.1">, Prophet will generate exactly the number of potential trend lines as defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">uncertainty_samples</span></strong><span class="koboSpan" id="kobo.290.1"> argument. </span><span class="koboSpan" id="kobo.290.2">However, when </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">mcmc_samples</span></strong><span class="koboSpan" id="kobo.292.1"> is any value greater than zero, Prophet will generate </span><em class="italic"><span class="koboSpan" id="kobo.293.1">at least</span></em><span class="koboSpan" id="kobo.294.1"> the number of potential trend lines as defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">uncertainty_samples</span></strong><span class="koboSpan" id="kobo.296.1"> argument, but potentially more as it needs to have the same number of iterations per chain. </span><span class="koboSpan" id="kobo.296.2">That all may be rather confusing, but it is just a s</span><a id="_idTextAnchor774"/><span class="koboSpan" id="kobo.297.1">mall technicality. </span><span class="koboSpan" id="kobo.297.2">The only practical effect you may notice is that </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">model.predictive_samples(future)</span></strong><span class="koboSpan" id="kobo.299.1"> may have fractionally more rows than you specified </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">uncertainty_samples</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.303.1">Now, let’s get </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.304.1">back to those changepoints. </span><span class="koboSpan" id="kobo.304.2">Why were there so many</span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.305.1"> when performing MCMC sampling? </span><span class="koboSpan" id="kobo.305.2">If you remember from </span><a href="B19630_08.xhtml#_idTextAnchor537"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.306.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.307.1">, </span><em class="italic"><span class="koboSpan" id="kobo.308.1">Influencing Trend Changepoints</span></em><span class="koboSpan" id="kobo.309.1">, Prophet sets a high number of potential changepoints and tries to set their magnitude as low as possible. </span><span class="koboSpan" id="kobo.309.2">This works fine with MAP estimation. </span><span class="koboSpan" id="kobo.309.3">In a Bayesian analysis, however, as is the case in MCMC sampling, there is a well-known phenomenon that causes the parameters not to shrink in the </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">same way.</span></span></p>
<p><span class="koboSpan" id="kobo.311.1">This is a plot of the changepoint magnitudes of our first model shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.312.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.313.1">.2</span></em><span class="koboSpan" id="kobo.314.1">, and our most r</span><a id="_idTextAnchor775"/><span class="koboSpan" id="kobo.315.1">ecent model, in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.316.1">Figure 11</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.317.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer236">
<span class="koboSpan" id="kobo.319.1"><img alt="Figure 11.8 – Changepoint magnitudes resulting from different uncertainty estimations" src="image/Fig_11.8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.320.1">Figure 11.8 – Changepoint magnitudes resulting from different uncertainty estimations</span></p>
<p><span class="koboSpan" id="kobo.321.1">The problem we have is not one of our modeling, just one of visualization. </span><span class="koboSpan" id="kobo.321.2">The two dashed lines in the preceding graphs show the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">0.01</span></strong><span class="koboSpan" id="kobo.323.1"> threshold for plotting changepoint magnitudes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">add_changepoints_to_plot</span></strong><span class="koboSpan" id="kobo.325.1"> function (the dotted lines show an increased threshold </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">0.</span><a id="_idTextAnchor776"/><span class="koboSpan" id="kobo.328.1">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.330.1">Changepoints that extend beyond this line were plotted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.331.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.332.1">.2</span></em><span class="koboSpan" id="kobo.333.1">. </span><span class="koboSpan" id="kobo.333.2">The model plotted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.334.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.335.1">.6</span></em><span class="koboSpan" id="kobo.336.1"> has many more chang</span><a id="_idTextAnchor777"/><span class="koboSpan" id="kobo.337.1">epoints extending beyond this line, so they are plotted, too. </span><span class="koboSpan" id="kobo.337.2">However, the extra changepoints cancel each other out. </span><span class="koboSpan" id="kobo.337.3">They are negative and then positive. </span><span class="koboSpan" id="kobo.337.4">The overall effect is that the trends in both </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.338.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.339.1">.2</span></em><span class="koboSpan" id="kobo.340.1"> and </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.341.1">Figure</span><a id="_idTextAnchor778"/><span class="koboSpan" id="kobo.342.1"> 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.343.1">.6</span></em><span class="koboSpan" id="kobo.344.1"> are </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">nearly identical:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer237">
<span class="koboSpan" id="kobo.346.1"><img alt="Figure 11.9 – Trend lines resulting from different changepoint uncertainty estimations﻿" src="image/Fig_11.9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.347.1">Figure 11.9 – Trend lines resulting from different changepoint uncertainty estimations</span><a id="_idTextAnchor779"/></p>
<p><span class="koboSpan" id="kobo.348.1">The lesson from</span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.349.1"> this is not to worry too much about it. </span><span class="koboSpan" id="kobo.349.2">If you </span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.350.1">want a more reasonable number of changepoints on your plot, feel free to change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">threshold</span></strong><span class="koboSpan" id="kobo.352.1"> argument when adding the changepoints. </span><span class="koboSpan" id="kobo.352.2">Here, </span><a id="_idTextAnchor780"/><span class="koboSpan" id="kobo.353.1">we change it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">0.1</span></strong><span class="koboSpan" id="kobo.355.1">, the level marked in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.356.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.357.1">.8</span></em><span class="koboSpan" id="kobo.358.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">dotted line:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.360.1">
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast,
                         threshold=0.1)
plt.show()</span></pre>
<p><span class="koboSpan" id="kobo.361.1">Now we see a similar number</span><a id="_idTextAnchor781"/><span class="koboSpan" id="kobo.362.1"> of changepoints </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer238">
<span class="koboSpan" id="kobo.364.1"><img alt="Figure 11.10 – Baltimore crime forecast with an increased changepoint threshold" src="image/Fig_11.10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.365.1">Figure 11.10 – Baltimore crime forecast with an increased changepoint threshold</span></p>
<p><span class="koboSpan" id="kobo.366.1">They are different</span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.367.1"> changepoints but remember that this is just</span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.368.1"> an issue that cropped up with visualization. </span><span class="koboSpan" id="kobo.368.2">The final trend in both models was very similar. </span><span class="koboSpan" id="kobo.368.3">The slight differences that</span><a id="_idTextAnchor782"/><span class="koboSpan" id="kobo.369.1"> arise are due to the different statistical sampling techniques; neither technique is more correct than the other – they are both estimations of </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">the data.</span></span></p>
<p><span class="koboSpan" id="kobo.371.1">This isn’t al</span><a id="_idTextAnchor783"/><span class="koboSpan" id="kobo.372.1">ways the case though. </span><span class="koboSpan" id="kobo.372.2">Sometimes you’ll see too many dramatic trend changes with MCMC sampling. </span><span class="koboSpan" id="kobo.372.3">If this happens, you can simply decrease your </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">changepoint_prior_scale</span></strong><span class="koboSpan" id="kobo.374.1"> value and rein in those changepoint magnitudes a bit. </span><span class="koboSpan" id="kobo.374.2">For example, let’s decrease it from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">0.05</span></strong><span class="koboSpan" id="kobo.376.1"> default value we’ve been using down </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">0.03</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.380.1">
model = Prophet(changepoint_prior_scale=0.03,
                mcmc_samples=300)
model.fit(df)
future = model.make_future_dataframe(periods=365 * 5)
forecast = model.predict(future)
fig = model.plot(forecast)
add_changepoints_to_plot(fig.gca(), model, forecast,
                         threshold=0.1)
pl</span><a id="_idTextAnchor784"/><span class="koboSpan" id="kobo.381.1">t.show()</span></pre>
<p><span class="koboSpan" id="kobo.382.1">At this level, we</span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.383.1"> have fewer significant changepoints tha</span><a id="_idTextAnchor785"/><span class="koboSpan" id="kobo.384.1">n</span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.385.1"> in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.386.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.387.1">.6</span></em><span class="koboSpan" id="kobo.388.1">, as can </span><a id="_idTextAnchor786"/><span class="koboSpan" id="kobo.389.1">be seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">following graph:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer239">
<span class="koboSpan" id="kobo.391.1"><img alt="Figure 11.11 – Baltimore crime forecast with increased changepoint regularization" src="image/Fig_11.11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.392.1">Figure 11.11 – Baltimore crime forecast with increased changepoint regularization</span></p>
<p><span class="koboSpan" id="kobo.393.1">If we compare the trend lines, we see that this regularized line matches the original MAP estim</span><a id="_idTextAnchor787"/><span class="koboSpan" id="kobo.394.1">ation ever so </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">slightly better:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer240">
<span class="koboSpan" id="kobo.396.1"><img alt="Figure 11.12 – Trend lines resulting from different changepoint prior scales﻿" src="image/Fig_11.12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.397.1">Figure 11.12 – Trend lines resulting from different changepoint prior scales</span><a id="_idTextAnchor788"/></p>
<p><span class="koboSpan" id="kobo.398.1">If you use</span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.399.1"> MCMC sampling, just be sure t</span><a id="_idTextAnchor789"/><span class="koboSpan" id="kobo.400.1">o pay attention to</span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.401.1"> the increased number of changepoints. </span><span class="koboSpan" id="kobo.401.2">If your trend line appears to be overfitting, you can simply reduce the change</span><a id="_idTextAnchor790"/><a id="_idTextAnchor791"/><span class="koboSpan" id="kobo.402.1">point prior scale to </span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">control it.</span></span></p>
<h1 id="_idParaDest-126"><a id="_idTextAnchor792"/><span class="koboSpan" id="kobo.404.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.405.1">Uncertainty intervals are a vital tool for understanding your forecast. </span><span class="koboSpan" id="kobo.405.2">No prediction of the future can carry absolute confidence. </span><span class="koboSpan" id="kobo.405.3">By explicitly stating the confidence level in your model, you provide your audience with an understanding of the risk involved in the model’s predictions, to better guide </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">their decisions.</span></span></p>
<p><span class="koboSpan" id="kobo.407.1">In this chapter, you learned that all models built in previous chapters used MAP estimations to create confidence levels. </span><span class="koboSpan" id="kobo.407.2">This method requires less time to compute than the alternative, MCMC sampling, but can only model uncertainty in the trend component. </span><span class="koboSpan" id="kobo.407.3">Often, this is enough. </span><span class="koboSpan" id="kobo.407.4">However, for those times when you also need uncertainty stated for seasonality, holidays, or extra regressors, you also learned how to apply MCMC sampling in Prophet to build a more comprehensive model </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">of uncertainty.</span></span></p>
<p><span class="koboSpan" id="kobo.409.1">Finally, you learned about an inherent weakness of MCMC sampling in terms of its ability to apply regularization to trend changepoints. </span><span class="koboSpan" id="kobo.409.2">You will usually see a larger quantity of significant changepoints in a Prophet model built with MCMC sampling than one built with MAP estimation. </span><span class="koboSpan" id="kobo.409.3">It is for this reason that you learned to pay close attention to trend overfitting when using MCMC sampling and to tune your changepoint prior </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">scale accordingly.</span></span></p>
<p><span class="koboSpan" id="kobo.411.1">In the next chapter, you’ll learn about cross-validation in Prophet. </span><span class="koboSpan" id="kobo.411.2">You may be familiar with k-fold cross-validation from other machine learning applications; k-fold fails with time series. </span><span class="koboSpan" id="kobo.411.3">We will cover a different method, called </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">forward chaining.</span></span></p>
</div>
<div>
<div class="IMG---Figure" id="_idContainer242">
</div>
</div>


<div class="Content" id="_idContainer243">
<h1 id="_idParaDest-127"><a id="_idTextAnchor793"/><span class="koboSpan" id="kobo.1.1">Part 3: Diagnostics and Evaluation</span></h1>
<p><span class="koboSpan" id="kobo.2.1">This final section will be about model evaluation and the next steps. </span><span class="koboSpan" id="kobo.2.2">You will learn how to use Prophet’s built-in performance metrics to compare different models in a statistically robust way and how to visualize their performance. </span><span class="koboSpan" id="kobo.2.3">Finally, the section will close out with some additional features of Prophet that could be used when deploying Prophet in real-world use cases, where updating models and sharing results are likely to be </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">frequent occurrences.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This section comprises the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><a href="B19630_12.xhtml#_idTextAnchor794"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 12</span></em></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Performing Cross-Validation</span></em></li>
<li><a href="B19630_13.xhtml#_idTextAnchor839"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 13</span></em></a><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Evaluating Performance Metrics</span></em></li>
<li><a href="B19630_14.xhtml#_idTextAnchor927"><em class="italic"><span class="koboSpan" id="kobo.12.1">Chapter 14</span></em></a><span class="koboSpan" id="kobo.13.1">, </span><em class="italic"><span class="koboSpan" id="kobo.14.1">Productionalizing Prophet</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer244">
</div>
</div>
</body></html>