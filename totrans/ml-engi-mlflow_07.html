<html><head></head><body>
		<div id="_idContainer074">
			<h1 id="_idParaDest-77"><a id="_idTextAnchor094"/><em class="italic">Chapter 5</em>: Managing Models with MLflow</h1>
			<p>In this chapter, you will learn about different features for model management in MLflow. You will learn about the model life cycle in MLflow and we will explain how to integrate it with your regular development workflow and how to create custom models not available in MLflow. A model life cycle will be introduced alongside the Model Registry feature of MLflow.</p>
			<p>Specifically, we will look at the following sections in this chapter:</p>
			<ul>
				<li>Understanding models in MLflow</li>
				<li>Exploring model flavors in MLflow</li>
				<li>Managing models and signature schemas</li>
				<li>Managing the life cycle with a model registry</li>
			</ul>
			<p>From a workbench perspective, we would like to use MLflow to manage our models and implement a clear model life cycle. The addition of managed model features to our benchmark leveraging MLflow will step up the quality and operations of our <strong class="bold">machine learning engineering</strong> solution.</p>
			<h1 id="_idParaDest-78"><a id="_idTextAnchor095"/>Technical requirements</h1>
			<p>For this chapter, you will need the following:</p>
			<ul>
				<li>The latest version of Docker installed on your machine. If you don’t already have it installed, please follow the instructions at <a href="https://docs.docker.com/get-docker/">https://docs.docker.com/get-docker/</a>.</li>
				<li>The latest version of <strong class="source-inline">docker-compose</strong> installed. Please follow the instructions at https://docs.docker.com/compose/install/.</li>
				<li>Access to Git in the command line and installed as described at <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">https://git-scm.com/book/en/v2/Getting-Started-Installing-Git</a>.</li>
				<li>Access to a Bash terminal (Linux or Windows).</li>
				<li>Access to a browser.</li>
				<li>Python 3.5+ installed.</li>
				<li>The latest version of your machine learning workbench installed locally, described in <a href="B16783_03_Final_SB_epub.xhtml#_idTextAnchor066"><em class="italic">Chapter 3</em></a>, <em class="italic">Your Data Science Workbench</em>.</li>
			</ul>
			<h1 id="_idParaDest-79"><a id="_idTextAnchor096"/>Understanding models in MLflow</h1>
			<p>On the MLflow platform, you have two main components available to manage models:</p>
			<ul>
				<li><strong class="bold">Models</strong>: This module manages the format, library, and standards enforcement module <a id="_idIndexMarker177"/>on the platform. It supports a variety of the most used machine learning models: sklearn, XGBoost, TensorFlow, H20, fastai, and others. It has features to manage output and input schemas of models and to facilitate deployment.</li>
				<li><strong class="bold">Model Registry</strong>: This module handles a model life cycle, from registering and tagging <a id="_idIndexMarker178"/>model metadata so it can be retrieved by relevant systems. It supports models in different states, for instance, live development, testing, and production.</li>
			</ul>
			<p>An MLflow model is <a id="_idIndexMarker179"/>at its core a packaging format for models. The main goal of MLflow model packaging is to decouple the model type from the environment that <a id="_idIndexMarker180"/>executes the model. A good analogy of an MLflow model is that it’s a bit like a <strong class="bold">Dockerfile</strong> for a model, where you describe metadata of the model, and deployment tools upstream are able to interact with the model based on the specification.</p>
			<p>As can be seen in the diagram in <em class="italic">Figure 5.1</em>, on one side you have your model library, for instance, TensorFlow or sklearn. At the core of MLflow, you have the MLflow model format, which is able to be served in a multitude of flavors (model formats) to cater to different types of inference tools on-premises and in the cloud:</p>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="image/image0011.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.1 – MLflow models diagram</p>
			<p><em class="italic">Figure 5.1</em> was extracted <a id="_idIndexMarker181"/>from the URL <a href="https://www.infoq.com/presentations/mlflow-databricks/#">https://www.infoq.com/presentations/mlflow-databricks/#</a>.</p>
			<p>The central piece of the definition of MLflow models is the MLflow model file, as depicted in the next screenshot:</p>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="image/image0022.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.2 – An example of an MLmodel file</p>
			<p>An MLmodel <a id="_idIndexMarker182"/>example can be seen in <em class="italic">Figure 5.2</em> and provides the following information:</p>
			<ul>
				<li><strong class="bold">run_id</strong>: This is a reference to the run of the model of the project that allowed the creation of the model.</li>
				<li><strong class="bold">time_created</strong>: The timestamp of when the model was created.</li>
				<li><strong class="bold">flavors</strong>: Flavors are different types of models, whether that is the native models (TensorFlow, Keras, sklearn, and so on) supported by MLflow or the <strong class="source-inline">pyfunc</strong> model provided by MLflow.</li>
				<li><strong class="bold">signature</strong>: This is the component of the MLmodel that defines the model signature and allows you to, in some way, type the inference process of your model. It allows the validation of input data that needs to match the signature of the model.</li>
			</ul>
			<p>The <strong class="bold">MLflow Models</strong> module provides you with the ability to deploy your models in a native environment of the library of your model or in a generic interoperable MLflow environment called <strong class="source-inline">pyfunc</strong>. This function is supported in any environment that supports Python, providing flexibility to the deployer of the model on how best to run the model once logged in MLflow:</p>
			<ol>
				<li>In the GitHub repo of the project, please go to the <strong class="source-inline">Gradflow</strong> folder and start the environment in this chapter by running the following command:<p class="source-code">make </p></li>
				<li>You can run <a id="_idIndexMarker183"/>all the cells including the model cell depicted in <em class="italic">Figure 5.3</em>:<div id="_idContainer061" class="IMG---Figure"><img src="image/image0032.jpg" alt=""/></div><p class="figure-caption">Figure 5.3 – An example of an MLmodel file</p><p>The model in <em class="italic">Figure 5.3</em> should be very similar to the one used in <a href="B16783_04_Final_SB_epub.xhtml#_idTextAnchor081"><em class="italic">Chapter 4</em></a><em class="italic">, Experiment Management in MLflow</em>. Using <strong class="source-inline">mlflow.start_run</strong>, you can start logging your model in MLflow and use the innate capabilities of the platform to capture relevant details of the model being developed.</p></li>
				<li>You can now explore the <strong class="source-inline">MLmodel</strong> file in MLflow:<div id="_idContainer062" class="IMG---Figure"><img src="image/image0042.jpg" alt=""/></div><p class="figure-caption">Figure 5.4 – An example of an MLmodel file</p></li>
				<li>Explore <a id="_idIndexMarker184"/>the <strong class="source-inline">conda</strong> file in MLflow:<div id="_idContainer063" class="IMG---Figure"><img src="image/image0052.jpg" alt=""/></div><p class="figure-caption">Figure 5.5 – An example of an MLmodel file</p></li>
				<li>Load the model as <strong class="source-inline">MLflow Pyfunc</strong> for prediction:<p class="source-code">import mlflow</p><p class="source-code">logged_model = ‘/data/artifacts/1/132e6fa332f2412d85f3cb9e6d6bc933/artifacts/model’</p><p class="source-code"># Load model as a PyFuncModel.</p><p class="source-code">loaded_model = mlflow.pyfunc.load_model(logged_model)</p><p class="source-code"># Predict on a Pandas DataFrame.</p><p class="source-code">import pandas as pd</p><p class="source-code">loaded_model.predict(pd.DataFrame(X_test))</p><p>Alternatively, the model can be loaded in the native H5 Keras format and loaded to a completely different application, as shown in <em class="italic">Figure 5.4</em>, by using the <strong class="source-inline">/data/model/model.h5 file</strong>.</p></li>
			</ol>
			<p>After introducing <a id="_idIndexMarker185"/>in this section the concept of models in MLflow, we will next delve a bit deeper into the different types of models in MLflow.</p>
			<h1 id="_idParaDest-80"><a id="_idTextAnchor097"/>Exploring model flavors in MLflow</h1>
			<p>Model flavors in MLflow are basically the different models of different libraries supported by MLflow. This functionality allows MLflow to handle the model types with native <a id="_idIndexMarker186"/>libraries of each specific model and support some of the native functionalities of the models. The following list presents a selection of representative models to describe and illustrate the support available in MLflow:</p>
			<ul>
				<li><strong class="source-inline">mlflow.tensorflow</strong>: TensorFlow is by far one of the most used libraries, particularly geared toward deep learning. MLflow integrates natively with the model format and the monitoring abilities by saving logs in TensorBoard formats. Auto-logging is supported in MLflow for TensorFlow models. The Keras model in <em class="italic">Figure 5.5</em> is a good example of TensorFlow support in MLflow.</li>
				<li><strong class="source-inline">mlflow.h2o</strong>: H2O is a complete machine learning platform geared toward the automation of models and with some overlapping features with MLflow. MLflow provides the ability to load (<strong class="source-inline">load_model</strong>) and log models (<strong class="source-inline">log_model</strong>) in H2O native format, allowing interoperability between the tools. Unfortunately, as of the current MLflow version, you can’t use auto-logging on <strong class="source-inline">h2o</strong> models:<p class="source-code">mlflow.h2o.load_model(...)</p><p class="source-code">mlflow.h2o.log_model(...)</p></li>
				<li><strong class="source-inline">mlflow.spark</strong>: MLflow integrates with the Apache Spark library natively through two <a id="_idIndexMarker187"/>main interfaces: Spark MLlib for machine learning and the MLeap platform (https://combust.github.io/mleap-docs/). Mleap is more of a deployment platform while MLlib is more of a library that you can add to your projects.</li>
			</ul>
			<p>A very comprehensive list of flavors/formats is supported by MLflow and their usage and support can be read about here: <a href="https://www.mlflow.org/docs/latest/python_api/index.html&#13;">https://www.mlflow.org/docs/latest/python_api/index.html.</a></p>
			<h2 id="_idParaDest-81"><a id="_idTextAnchor098"/>Custom models</h2>
			<p>We can delve into the next excerpt of code and the custom <strong class="source-inline">RandomPredictor</strong> model. As long <a id="_idIndexMarker188"/>as you provide a class with an interface with the <strong class="source-inline">fit</strong> and <strong class="source-inline">predict methods</strong>, you can have your own custom MLflow model:</p>
			<p class="source-code">class RandomPredictor(mlflow.pyfunc.PythonModel):</p>
			<p class="source-code">  def __init__(self):</p>
			<p class="source-code">    pass</p>
			<p class="source-code">  def fit(self):</p>
			<p class="source-code">    pass</p>
			<p class="source-code">  def predict(self, context, model_input):</p>
			<p class="source-code">    return model_input.apply(</p>
			<p class="source-code">        lambda column: random.randint(0,1))</p>
			<p>In the preceding <strong class="source-inline">class</strong>, we basically use a random probability, and it can be used as a sample model in a system where you want to make sure that your model is better than a random model.</p>
			<p>In this <a id="_idIndexMarker189"/>section, we introduced different types of model flavors and the creation of a custom mode. We will next look at some of the schemas and signature features of MLflow.</p>
			<h1 id="_idParaDest-82"><a id="_idTextAnchor099"/>Managing model signatures and schemas</h1>
			<p>An important feature of MLflow is to provide an abstraction for input and output schemas <a id="_idIndexMarker190"/>of models and the ability to validate model data during prediction and training.</p>
			<p>MLflow throws an error if your input does not match the schema and signature of the model during prediction:</p>
			<ol>
				<li value="1">We will next look at a code listing of a simple model of digit classification (the details of the dataset are available here: <a href="https://archive.ics.uci.edu/ml/datasets/Optical+Recognition+of+Handwritten+Digits">https://archive.ics.uci.edu/ml/datasets/Optical+Recognition+of+Handwritten+Digits</a>). The following code flattens the image into a pandas DataFrame and fits a model to the dataset:<p class="source-code">from sklearn import datasets, svm, metrics</p><p class="source-code">from sklearn.model_selection import train_test_split</p><p class="source-code">import mlflow</p><p class="source-code">digits = datasets.load_digits()</p><p class="source-code">n_samples = len(digits.images)</p><p class="source-code">data = digits.images.reshape((n_samples, -1))</p><p class="source-code">clf = svm.SVC(gamma=0.001)</p><p class="source-code">X_train, X_test, y_train, y_test = train_test_split(</p><p class="source-code">    data, digits.target, test_size=0.5, shuffle=False)</p><p class="source-code">mlflow.sklearn.autolog()</p><p class="source-code">with mlflow.start_run():</p><p class="source-code">    clf.fit(X_train, y_train)</p></li>
				<li>We’ll look <a id="_idIndexMarker191"/>at the previous code listing, which you can run in a new notebook and navigate through the MLflow UI to investigate in more depth the MLmodel generated in <em class="italic">Figure 5.6</em>:<div id="_idContainer064" class="IMG---Figure"><img src="image/image0062.jpg" alt=""/></div><p class="figure-caption">Figure 5.6 – Sample of an MLmodel file</p></li>
				<li>The MLmodel file contains the signature in JSON of input and output files. For some of the flavors autologged, we will not be able to infer the signature automatically so you can provide the signature inline when logging the model:<p class="source-code"># flatten the images</p><p class="source-code">from mlflow.models.signature import infer_signature</p><p class="source-code">with mlflow.start_run(run_name=’untuned_random_forest’):</p><p class="source-code">    …</p><p class="source-code">    signature = infer_signature(X_train, </p><p class="source-code">        wrappedModel.predict(None, X_train))</p><p class="source-code">    mlflow.pyfunc.log_model(“random_forest_model”, </p><p class="source-code">                            python_model=wrappedModel, </p><p class="source-code">                            signature=signature)</p></li>
			</ol>
			<p>In the previous code block, the signature of the model is provided by the <strong class="source-inline">infer_signature </strong>method. As the model is logged through <strong class="source-inline">log_model</strong>, the signature is provided. One important advantage of the signatures being logged alongside the model is that they can <a id="_idIndexMarker192"/>serve as documentation and metadata for the model. Third-party systems can consume the metadata and interact with the models by validating the data or generating documentation for the models.</p>
			<p>In this section, we introduced the model schema and signature features of MLflow models. We will now move on to the other critical module in this space, namely the Model Registry.</p>
			<h1 id="_idParaDest-83"><a id="_idTextAnchor100"/>Introducing Model Registry</h1>
			<p><strong class="bold">MLflow Model Registry</strong> is a module in MLflow that comprises a centralized store for Models, an API allowing the management of the life cycle of a model in a registry.</p>
			<p>A typical <a id="_idIndexMarker193"/>workflow for a machine learning model developer is to acquire training data; clean, process, and train models; and from there on, hand over to a system or person that deploys the models. In very small settings, where you have one person responsible for this function, it is quite trivial. Challenges and friction start to arise when the variety and quantity of models in a team start to scale. A selection of common friction points raised by machine learning developers with regards to storing and retrieving models follows:</p>
			<ul>
				<li>Collaboration in larger teams</li>
				<li>Phasing out stale models in production</li>
				<li>The provenance of a model</li>
				<li>A lack of documentation for models</li>
				<li>Identifying the correct version of a model</li>
				<li>How to integrate the model with deployment tools</li>
			</ul>
			<p>The main idea behind <strong class="bold">MLflow Model Registry</strong> is to provide a central store model in an organization where all the relevant models are stored and can be accessed by humans <a id="_idIndexMarker194"/>and systems. A good analogy would be a Git repository for models with associated relevant metadata and centralized state management for models.</p>
			<p>In the MLflow UI (available in your local environment), you should click on the tab on the right side of <strong class="bold">Experiments</strong> with the label <strong class="bold">Models</strong> as indicated by the arrow:</p>
			<ol>
				<li value="1">Through this module, you are able to list all the models registered, search by name, or create by name. For each model, you can see the label of the latest version and the specific versions that are in staging or production:<div id="_idContainer065" class="IMG---Figure"><img src="image/image0072.jpg" alt=""/></div><p class="figure-caption">Figure 5.7 – Model Registry UI</p></li>
				<li>A new model can be created by clicking on the <strong class="bold">Create Model</strong> button where a relevant name can be given to a specific model as shown in <em class="italic">Figure 5.8</em>:<div id="_idContainer066" class="IMG---Figure"><img src="image/image0082.jpg" alt=""/></div><p class="figure-caption">Figure 5.8 – Model Registry UI – Create Model</p></li>
				<li>You can also <a id="_idIndexMarker195"/>create models in MLflow by running into the <strong class="bold">Experiments</strong> model and choosing one of your models, and from there, specifically deciding to register the model. You will have to associate your run with an existing model or create a new model name to associate with this particular type of model thereafter:</li>
			</ol>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/image0092.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.9 – Model Tracking UI – Create New Model</p>
			<p>When you <a id="_idIndexMarker196"/>add a new model, MLflow automatically increases the version and labels this version as the latest version and everyone in the organization can query the registry for the latest version of a model for a given problem.</p>
			<h2 id="_idParaDest-84">Adding your best model to Mode<a id="_idTextAnchor101"/>l Registry</h2>
			<p>Everything that <a id="_idIndexMarker197"/>can be done in the UI in MLflow can also be implemented through the MLflow API.</p>
			<p>We can quickly go back to our use case of stock market prediction and add our first baseline model to Model Registry and run the <strong class="source-inline">hyperopt_optimization_logistic_regression_mlflow.ipynb notebook</strong>, available in the repo of this chapter, and sort the runs according to the F1 score metrics in descending order as represented by <em class="italic">Figure 5.10</em>:</p>
			<div>
				<div id="_idContainer068" class="IMG---Figure">
					<img src="image/image0101.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.10 – Selecting the best model</p>
			<p>From there, you <a id="_idIndexMarker198"/>should be able to register the best model with the name <strong class="source-inline">BTC StockPrediction</strong> as represented in <em class="italic">Figure 5.11</em>:</p>
			<div>
				<div id="_idContainer069" class="IMG---Figure">
					<img src="image/image0111.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.11 – Naming your model</p>
			<p>By returning to the models module, you will notice, as represented in <em class="italic">Figure 5.12</em>, your newly created model under <strong class="bold">Version 1</strong>:</p>
			<div>
				<div id="_idContainer070" class="IMG---Figure">
					<img src="image/image0121.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.12 – Registered Models</p>
			<p>Having introduced <a id="_idIndexMarker199"/>the functionalities of Model Registry, in the next section, we will describe a model development life cycle to help organize the management of your models.</p>
			<h1 id="_idParaDest-85"><a id="_idTextAnchor102"/>Managing the model development life cycle</h1>
			<p>Managing the <a id="_idIndexMarker200"/>model life cycle is quite important when working in a team of more than one model developer. It’s quite usual for multiple model developers to try different models within the same project, and having a reviewer decide on the model that ends up going to production is quite important:</p>
			<div>
				<div id="_idContainer071" class="IMG---Figure">
					<img src="image/image0131.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.13 – Example of a model development life cycle</p>
			<p>A model in <a id="_idIndexMarker201"/>its life cycle can undergo the following stages if using a life cycle similar to the one represented in <em class="italic">Figure 5.13</em>:</p>
			<ul>
				<li><strong class="bold">Development</strong>: The state where the model developer is still exploring and trying out different approaches and is still trying to find a reasonable solution to their machine learning problem.</li>
				<li><strong class="bold">Staging</strong>: The state where the model can be tested automatically with production-type traffic.</li>
				<li><strong class="bold">Production</strong>: When the model is ready to handle real-life production traffic.</li>
				<li><strong class="bold">Archive</strong>: When the model no longer serves the business purpose that it was initially developed for, it will be archived and its metadata stored for future reference or compliance.</li>
			</ul>
			<p>For instance, a reviewer or supervisor, as represented in <em class="italic">Figure 5.14</em>, can move a model from the <strong class="bold">Development</strong> state to <strong class="bold">Staging</strong> for further deployment in a test environment and the model can be transitioned into production if approved by reviewers:</p>
			<div>
				<div id="_idContainer072" class="IMG---Figure">
					<img src="image/image0141.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.14 – Example of a model development life cycle</p>
			<p>When transitioning <a id="_idIndexMarker202"/>from a state in MLflow, you have the option to send the model in an existing state to the next state:</p>
			<div>
				<div id="_idContainer073" class="IMG---Figure">
					<img src="image/image0151.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.15 – Stage Transition in MLflow</p>
			<p>The transitions <a id="_idIndexMarker203"/>from the <strong class="bold">Staging</strong> to <strong class="bold">Production</strong> stages in a mature environment are meant to be done automatically, as we will demonstrate in the upcoming chapters of the book.</p>
			<p>With this section, we have concluded the description of the features related to models in MLflow.</p>
			<h1 id="_idParaDest-86"><a id="_idTextAnchor103"/>Summary</h1>
			<p>In this chapter, we first introduced the Models module in MLflow and the support for different algorithms, from tree-based to linear to neural. We were exposed to the support in terms of the logging and metrics of models and the creation of custom metrics.</p>
			<p>In the last two sections, we introduced the Model Registry model and how to use it to implement a model life cycle to manage our models.</p>
			<p>In the next chapters and section of the book, we will focus on applying the concepts learned so far in terms of real-life systems and we will architect a machine learning system for production environments.</p>
			<h1 id="_idParaDest-87"><a id="_idTextAnchor104"/>Further reading</h1>
			<p>In order to solidify your knowledge and dive deeper into the concepts introduced in this chapter, you should look at the following links:</p>
			<ul>
				<li><a href="https://www.mlflow.org/docs/latest/models.html">https://www.mlflow.org/docs/latest/models.html</a></li>
				<li><a href="https://www.mlflow.org/docs/latest/model-registry.html">https://www.mlflow.org/docs/latest/model-registry.html</a></li>
				<li><a href="https://www.slideshare.net/Hadoop_Summit/introducing-mlflow-an-open-source-platform-for-the-machine-learning-lifecycle-for-onprem-or-in-the-cloud">https://www.slideshare.net/Hadoop_Summit/introducing-mlflow-an-open-source-platform-for-the-machine-learning-life cycle-for-onprem-or-in-the-cloud</a></li>
			</ul>
		</div>
		<div>
			<div id="_idContainer075">
			</div>
		</div>
	</body></html>