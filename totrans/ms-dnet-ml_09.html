<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;9.&#xA0;AdventureWorks Production &#x2013; Neural Networks"><div class="book" id="1IHDQ2-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09" class="calibre1"/>Chapter 9. AdventureWorks Production – Neural Networks</h1></div></div></div><p class="calibre6">One day you are sitting in your office, basking in the glow of your new-found rock star status at AdventureWorks when your boss knocks on the door. She says, "Since you did such a good job with the consumer-facing portion of our existing website, we want to know if you would be interested in working on an internally-facing greenfield project." You cut her off with a resounding, "Yes!" She smiles and continues, "Okay. The problem is in our production area. Management is very interested in how we can reduce our scrap amount. Every month we get a report from Excel that looks like this:"</p><div class="mediaobject"><img src="../images/00123.jpeg" alt="AdventureWorks Production – Neural Networks" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">"The problem is that we don't know what to do with this data. Production is a complex workflow with many variables that can impact whether an item gets scrapped. We are looking for two things:</p><div class="book"><ul class="itemizedlist"><li class="listitem">A way of identifying the items that most impact whether items get scrapped</li><li class="listitem">A tool that allows our planners to alter the key variables to play <span class="strong"><em class="calibre11">what if…</em></span> and make changes to the production process"</li></ul></div><p class="calibre6">You tell your boss okay. Since this is a greenfield application and you have been hearing the hype around ASP.NET Core 1.0, this seems like a great place to try it. Also, you have heard about one of the hot models in data science, neural networks, and want to see whether the reality matches the hype.</p></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;AdventureWorks Production &#x2013; Neural Networks">
<div class="book" title="Neural networks"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch09lvl1sec46" class="calibre1"/>Neural networks</h1></div></div></div><p class="calibre6">A relative latecomer to data science, neural networks attempt to have the computer imitate how the brain operates. The gray matter between our ears is very good, up to a point, at making connections and drawing inferences. The promise of neural networks is that if we can build models that are patterned after how our brain works, we can combine the speed of computers and the pattern-matching ability of our wetware to make a learning model that can provide insights that computers or humans alone might miss.</p></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;AdventureWorks Production &#x2013; Neural Networks">
<div class="book" title="Neural networks">
<div class="book" title="Background"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec77" class="calibre1"/>Background</h2></div></div></div><p class="calibre6">Neural networks takes their vocabulary from the actual brain; a neural network is a collection of neurons. If you remember from Biology 101 (or Crysis 2), the brain has billions of neurons that look more or less like this:</p><div class="mediaobject"><img src="../images/00124.jpeg" alt="Background" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">The axon terminal of one neuron connects to another neuron's dendrite. Since an individual neuron can have multiple dendrites and axon terminals, neurons can connect, and be connected to, numerous other neurons. The actual connection area between two neurons is called the synapse. Our brains use electrical signals to pass messages among neurons.</p><div class="mediaobject"><img src="../images/00125.jpeg" alt="Background" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Since we are modeling the human brain for neural networks, it stands to reason that we will use the same vocabulary. In a neural network, we have a series of inputs and an output. Between the inputs and outputs, there is a hidden layer comprising neurons. Any connection from the inputs into the hidden layer, among the neurons inside the hidden layer, and from the hidden layer to the output is called a synapse.</p><div class="mediaobject"><img src="../images/00126.jpeg" alt="Background" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Notice that every synapse connects only to the neurons (or output) to its immediate right. Data always flows in one direction in a neural network and synapses never connect to themselves or any other preceding neuron in the network. One more thing to note is that when the hidden layer has many neurons, it is called a deep belief network (or deep learning). We will not be covering deep belief networks in this book, though it is certainly something you might want to toss around the next time you are out bowling with friends.</p><p class="calibre6">In a neural network, the synapse has only one job. They form a connection from one neuron to the next, applying a weight to that connection. For example, Neuron 1 activates the synapse with a weight of two, so that Neuron 2 receives an input of two:</p><div class="mediaobject"><img src="../images/00127.jpeg" alt="Background" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Neurons have a more complicated job. They take in the values from all of their input synapses, take input from something called a bias (I'll get to that in a second), apply an activation function to the inputs, and then either output a signal or do nothing. The activation function can treat each input separately, combine them, or do a mixture of both. There are many kinds of activation functions, ranging from simple to mind-boggling. In this example, the inputs are added together:</p><div class="mediaobject"><img src="../images/00128.jpeg" alt="Background" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Some neural networks are smart enough to add and drop neurons as needed. For this book, we will not be doing anything like that—we will fix the number of neurons in each layer. Going back to some vocabulary that I dropped on you in the preceding paragraph, there are two kinds of inputs for any given activation function inside a neuron: the weights as transmitted by the synapses and the bias. The weights are a number that is assigned to the synapse, depending on the nature of the synapse, and does not change during the lifetime of the neural network. The bias is a global value that is assigned to all neurons (and output) which, unlike the weights, changes frequently. The machine learning component of the neural network is the many iterations that the computer does to create the best combination of weights and bias to give the optimal predictive score.</p></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;AdventureWorks Production &#x2013; Neural Networks">
<div class="book" title="Neural networks">
<div class="book" title="Neural network demo"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec78" class="calibre1"/>Neural network demo</h2></div></div></div><p class="calibre6">With this mental model in place, let's take a look at a neural network in action. Let's look at a series of students who studied and drank beer before an exam and compare whether they passed that exam or not:</p><div class="mediaobject"><img src="../images/00129.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Since we have two input (<span class="strong"><em class="calibre11">x</em></span>) variables (<span class="strong"><strong class="calibre7">Hours Studying</strong></span> and <span class="strong"><strong class="calibre7">Beers Drank</strong></span>), our neural network will have two inputs. We have one dependent variable (<span class="strong"><strong class="calibre7">Passed?</strong></span>) so our neural network will have one output:</p><div class="mediaobject"><img src="../images/00130.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">One thing to note is that the number of inputs depends on the range of values. So if we had a categorical input (such as male/female), we would have a number of inputs that correspond to the range of values in the category:</p><div class="mediaobject"><img src="../images/00131.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre9"> </p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Go into Visual Studio and create a new C# ASP.NET web application:<div class="mediaobject"><img src="../images/00132.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="2">In the next <a id="id445" class="calibre1"/>dialog box, select <span class="strong"><strong class="calibre7">ASP.NET 5 Templates</strong></span> and change the authentication type to <span class="strong"><strong class="calibre7">No Authentication</strong></span>. Note that the templates will probably change from ASP.NET 5 to ASP.NET Core 1 after the writing of this book. You can consider these two terms synonymously.<div class="mediaobject"><img src="../images/00133.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="3">If everything<a id="id446" class="calibre1"/> code-gens as it should, you will get the following project:<div class="mediaobject"><img src="../images/00134.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="4">Next, let's add<a id="id447" class="calibre1"/> an F# Windows Library project:<div class="mediaobject"><img src="../images/00135.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="5">Once the F# project has been created, open up the NuGet Package Manager Console and install numl. Make sure that you are targeting the F# project for the NuGet installation:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; install-package numl</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00136.jpeg" alt="Neural network demo" class="calibre8"/></div><p class="calibre15"> </p></li><li class="listitem" value="6">Rename <code class="literal">Scipt1.fsx</code> to <code class="literal">StudentNeuralNetwork.fsx</code>.</li><li class="listitem" value="7">Go to the script <a id="id448" class="calibre1"/>and replace everything in it with this code:<div class="informalexample"><pre class="programlisting">#r "../packages/numl.0.8.26.0/lib/net40/numl.dll"

open numl
open numl.Model
open numl.Supervised.NeuralNetwork

type Student = {[&lt;Feature&gt;]Study: float; 
                [&lt;Feature&gt;]Beer: float; 
                [&lt;Label&gt;] mutable Passed: bool}

let data = 
    [{Study=2.0;Beer=3.0;Passed=false};
     {Study=3.0;Beer=4.0;Passed=false};
     {Study=1.0;Beer=6.0;Passed=false};
     {Study=4.0;Beer=5.0;Passed=false};
     {Study=6.0;Beer=2.0;Passed=true};
     {Study=8.0;Beer=3.0;Passed=true};
     {Study=12.0;Beer=1.0;Passed=true};
     {Study=3.0;Beer=2.0;Passed=true};]

let data' = data |&gt; Seq.map box
let descriptor = Descriptor.Create&lt;Student&gt;()
let generator = NeuralNetworkGenerator()
generator.Descriptor &lt;- descriptor
let model = Learner.Learn(data', 0.80, 100, generator)
let accuracy = model.Accuracy</pre></div></li><li class="listitem" value="8">When you send this to the FSI, you will get the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val generator : NeuralNetworkGenerator</strong></span>
<span class="strong"><strong class="calibre7">val model : LearningModel =</strong></span>
<span class="strong"><strong class="calibre7">  Learning Model:</strong></span>
<span class="strong"><strong class="calibre7">  Generator numl.Supervised.NeuralNetwork.NeuralNetworkGenerator</strong></span>
<span class="strong"><strong class="calibre7">  Model:</strong></span>
<span class="strong"><strong class="calibre7">numl.Supervised.NeuralNetwork.NeuralNetworkModel</strong></span>
<span class="strong"><strong class="calibre7">  Accuracy: 100.00 %</strong></span>

<span class="strong"><strong class="calibre7">val accuracy : float = 1.0</strong></span>
</pre></div></li></ol><div class="calibre13"/></div><p class="calibre6">If you worked through the example in <a class="calibre1" title="Chapter 3. More AdventureWorks Regression" href="part0029_split_000.html#RL0A2-a18db0be6c20485ba81f22e43ca13055">Chapter 3</a>, <span class="strong"><em class="calibre11">More AdventureWorks Regression</em></span>, this code will look familiar. The <code class="literal">Student</code> type has three properties: <code class="literal">Study</code>, <code class="literal">Beer</code>, and <code class="literal">Passed</code>. Note that <code class="literal">Passed</code> is marked as mutable because numl expects any prediction data type to be of the same type that was used when the model was created. Numl then mutates the response <a id="id449" class="calibre1"/>variable to whatever the model comes up with, so we have to use the mutable keyword. Alternative implementations would be to pass into the prediction function a type without that response variable or return a new instance so the value can be immutable. Feel free to contribute to the open source project if you feel strongly about this (I'll see you there J).</p><p class="calibre6">In any event, the data is an array of instances of our students. We then create a descriptor of the <code class="literal">Student</code> type and a generator of a neural network. Notice that we know the generator's <code class="literal">descriptor</code> property is mutable because we assign it using the <code class="literal">&lt;-</code> symbol in this line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">generator.Descriptor &lt;- descriptor</strong></span>
</pre></div><p class="calibre6">Next, we pass the generator to the learner and create the model. Under the hood, numl is scaling our data and running multiple instances of a neural network to determine the optimal solution. Once the generator has finished its work, it reports that it has an accuracy of 100%. We can then test our neural network with some new data. Go to the script and add this:</p><div class="informalexample"><pre class="programlisting">let testData = {Study=7.0;Beer=1.0;Passed=false}
let predict = model.Model.Predict(testData)</pre></div><p class="calibre6">When you send this to the FSI, you will get this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val testData : Student = {Study = 7.0;</strong></span>
<span class="strong"><strong class="calibre7">                          Beer = 1.0;</strong></span>
<span class="strong"><strong class="calibre7">                          Passed = false;}</strong></span>

<span class="strong"><strong class="calibre7">&gt; </strong></span>

<span class="strong"><strong class="calibre7">val predict : obj = {Study = 7.0;</strong></span>
<span class="strong"><strong class="calibre7">                     Beer = 1.0;</strong></span>
<span class="strong"><strong class="calibre7">                     Passed = true;}</strong></span>
</pre></div><p class="calibre6">In this case, our student who studies 7 hours and has 1 beer will pass the test.</p></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;AdventureWorks Production &#x2013; Neural Networks">
<div class="book" title="Neural networks">
<div class="book" title="Neural network – try #1"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch09lvl2sec79" class="calibre1"/>Neural network – try #1</h2></div></div></div><p class="calibre6">With the theory out of the way, let's see if neural networks can help us with AdventureWorks. As in <a class="calibre1" title="Chapter 3. More AdventureWorks Regression" href="part0029_split_000.html#RL0A2-a18db0be6c20485ba81f22e43ca13055">Chapter 3</a>, <span class="strong"><em class="calibre11">More AdventureWorks Regression</em></span>, let's see if we can use a business<a id="id450" class="calibre1"/> area expert to help us formulate some viable hypotheses. When we visit the manager of manufacturing, he says, "I think there are a couple of areas that you should look at. See if the production location has an impact. We have seven major locations":</p><div class="mediaobject"><img src="../images/00137.jpeg" alt="Neural network – try #1" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">"I am curious if our <span class="strong"><strong class="calibre7">Paint</strong></span> location generates more than expected defects because we have high turnover in that area."</p><p class="calibre6">"Also, see if there is a relationship between vendors and products with defects. In some cases, we purchase parts for a single vendor; in other cases, we have two or three vendors supplying us parts. We don't track which part came from which vendor when we build a bike, but perhaps you can find that certain vendors are associated with purchase orders that have defects."</p><p class="calibre6">These seem like two good places to start, so let's head over to the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and create a new script file called <code class="literal">AWNeuralNetwork.fsx</code> in the F# project:</p><div class="mediaobject"><img src="../images/00138.jpeg" alt="Neural network – try #1" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, open up<a id="id451" class="calibre1"/> the NuGet Package Manager and enter this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM&gt; Install-Package SQLProvider -prerelease</strong></span>
</pre></div><p class="calibre6">Next, open the script file and enter this (note that the version number might be different for you):</p><div class="informalexample"><pre class="programlisting">#r "../packages/SQLProvider.0.0.11-alpha/lib/FSharp.Data.SQLProvider.dll"
#r "../packages/numl.0.8.26.0/lib/net40/numl.dll"
#r "../packages/FSharp.Collections.ParallelSeq.1.0.2/lib/net40/FSharp.Collections.ParallelSeq.dll"

open numl
open System
open numl.Model
open System.Linq
open FSharp.Data.Sql
open numl.Supervised.NeuralNetwork
open FSharp.Collections.ParallelSeq

[&lt;Literal&gt;]
let connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=AdventureWorks2014;user id= PacktReader;password= P@cktM@chine1e@rning;"

type AdventureWorks = SqlDataProvider&lt;ConnectionString=connectionString&gt;
let context = AdventureWorks.GetDataContext()</pre></div><p class="calibre6">Sending this to the<a id="id452" class="calibre1"/> REPL will give you the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val connectionString : string =</strong></span>
<span class="strong"><strong class="calibre7">  "data source=nc54a9m5kk.database.windows.net;initial catalog=A"+[70 chars]</strong></span>
<span class="strong"><strong class="calibre7">type AdventureWorks = SqlDataProvider&lt;...&gt;</strong></span>
<span class="strong"><strong class="calibre7">val context : SqlDataProvider&lt;...&gt;.dataContext</strong></span>
</pre></div><p class="calibre6">Next, let's tackle the location hypothesis. Go to the script and enter the following:</p><div class="informalexample"><pre class="programlisting">type WorkOrderLocation = {[&lt;Feature&gt;] Location10: bool; 
                          [&lt;Feature&gt;] Location20: bool; 
                          [&lt;Feature&gt;] Location30: bool; 
                          [&lt;Feature&gt;] Location40: bool; 
                          [&lt;Feature&gt;] Location45: bool; 
                          [&lt;Feature&gt;] Location50: bool; 
                          [&lt;Feature&gt;] Location60: bool; 
                          [&lt;Label&gt;] mutable Scrapped: bool}

let getWorkOrderLocation (workOrderId, scrappedQty:int16) =
    let workOrderRoutings = context.``[Production].[WorkOrderRouting]``.Where(fun wor -&gt; wor.WorkOrderID = workOrderId) |&gt; Seq.toArray
    match workOrderRoutings.Length with
    | 0 -&gt; None
    | _ -&gt;
        let location10 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 10)
        let location20 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 20)
        let location30 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 30)
        let location40 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 40)
        let location45 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 45)
        let location50 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 50)
        let location60 = workOrderRoutings |&gt; Array.exists(fun wor -&gt; wor.LocationID = int16 60)
        let scrapped = scrappedQty &gt; int16 0
        Some {Location10=location10;Location20=location20;Location30=location30;Location40=location40;
        Location45=location45;Location50=location50;Location60=location60;Scrapped=scrapped}</pre></div><p class="calibre6">Sending this to the REPL gives you the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">type WorkOrderLocation =</strong></span>
<span class="strong"><strong class="calibre7">  {Location10: bool;</strong></span>
<span class="strong"><strong class="calibre7">   Location20: bool;</strong></span>
<span class="strong"><strong class="calibre7">   Location30: bool;</strong></span>
<span class="strong"><strong class="calibre7">   Location40: bool;</strong></span>
<span class="strong"><strong class="calibre7">   Location45: bool;</strong></span>
<span class="strong"><strong class="calibre7">   Location50: bool;</strong></span>
<span class="strong"><strong class="calibre7">   Location60: bool;</strong></span>
<span class="strong"><strong class="calibre7">   mutable Scrapped: bool;}</strong></span>
<span class="strong"><strong class="calibre7">val getWorkOrderLocation :</strong></span>
<span class="strong"><strong class="calibre7">  workOrderId:int * scrappedQty:int16 -&gt; WorkOrderLocation option</strong></span>
</pre></div><p class="calibre6">You can see we<a id="id453" class="calibre1"/> have a record type with each location as a field and an indicator if there was anything scrapped. The level of automacy for this data structure is work order. Each order might visit one or all of the locations and might have some scrap quantity. The <code class="literal">getWorkOrderFunction</code> takes the <code class="literal">WorkOrderLocation</code> table, where each location is a row in the table, and flattens into this <code class="literal">WorkOrderLocation</code> record type.</p><p class="calibre6">Next, go back to the script and enter this:</p><div class="informalexample"><pre class="programlisting">let locationData =
    context.``[Production].[WorkOrder]`` 
    |&gt; PSeq.map(fun wo -&gt; getWorkOrderLocation(wo.WorkOrderID,wo.ScrappedQty))
    |&gt; Seq.filter(fun wol -&gt; wol.IsSome)
    |&gt; Seq.map(fun wol -&gt; wol.Value)
    |&gt; Seq.toArray</pre></div><p class="calibre6">Sending this to the REPL gives us the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val locationData : WorkOrderLocation [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|{Location10 = true;</strong></span>
<span class="strong"><strong class="calibre7">     Location20 = true;</strong></span>
<span class="strong"><strong class="calibre7">     Location30 = true;</strong></span>
<span class="strong"><strong class="calibre7">     Location40 = false;</strong></span>
<span class="strong"><strong class="calibre7">     Location45 = true;</strong></span>
<span class="strong"><strong class="calibre7">     Location50 = true;</strong></span>
<span class="strong"><strong class="calibre7">     Location60 = true;</strong></span>
<span class="strong"><strong class="calibre7">     Scrapped = false;}; {Location10 = false;</strong></span>
<span class="strong"><strong class="calibre7">                          Location20 = false;</strong></span>
<span class="strong"><strong class="calibre7">                          Location30 = false;</strong></span>
<span class="strong"><strong class="calibre7">                          Location40 = false;</strong></span>
</pre></div><p class="calibre6">This code is very much what you saw in <a class="calibre1" title="Chapter 5. Time Out – Obtaining Data" href="part0036_split_000.html#12AK81-a18db0be6c20485ba81f22e43ca13055">Chapter 5</a>, <span class="strong"><em class="calibre11">Time Out – Obtaining Data</em></span>. We go to the database and pull in all the work orders and then map the locations into our <code class="literal">WorkOrderLocation</code> record. Notice that we are using the <code class="literal">PSeq</code> so that we can get a performance boost by<a id="id454" class="calibre1"/> making simultaneous calls to the database to get the locations for each work order.</p><p class="calibre6">With the data local, let's try out a neural network. Go into the script file and enter this:</p><div class="informalexample"><pre class="programlisting">let locationData' = locationData |&gt; Seq.map box
let descriptor = Descriptor.Create&lt;WorkOrderLocation&gt;()
let generator = NeuralNetworkGenerator()
generator.Descriptor &lt;- descriptor
let model = Learner.Learn(locationData', 0.80, 5, generator)
let accuracy = model.Accuracy</pre></div><p class="calibre6">Sending that to the REPL, after a long wait, will give you the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val generator : NeuralNetworkGenerator</strong></span>
<span class="strong"><strong class="calibre7">val model : LearningModel =</strong></span>
<span class="strong"><strong class="calibre7">  Learning Model:</strong></span>
<span class="strong"><strong class="calibre7">  Generator numl.Supervised.NeuralNetwork.NeuralNetworkGenerator</strong></span>
<span class="strong"><strong class="calibre7">  Model:</strong></span>
<span class="strong"><strong class="calibre7">numl.Supervised.NeuralNetwork.NeuralNetworkModel</strong></span>
<span class="strong"><strong class="calibre7">  Accuracy: 0.61 %</strong></span>

<span class="strong"><strong class="calibre7">val accuracy : float = 0.006099706745</strong></span>
</pre></div><p class="calibre6">So, ugh, it does not look like the location can predict where defects might occur. As we saw in <a class="calibre1" title="Chapter 3. More AdventureWorks Regression" href="part0029_split_000.html#RL0A2-a18db0be6c20485ba81f22e43ca13055">Chapter 3</a>, <span class="strong"><em class="calibre11">More AdventureWorks Regression</em></span>, sometimes you do not need a working model to make the experiment worthwhile. In this case, we can go back to the director and tell him that scraps are occurring all over his production location, not just in the painting (so much for blaming the new guy).</p></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;AdventureWorks Production &#x2013; Neural Networks">
<div class="book" title="Neural networks">
<div class="book" title="Neural network – try #2"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch09lvl2sec80" class="calibre1"/>Neural network – try #2</h2></div></div></div><p class="calibre6">Let's see if we can find <a id="id455" class="calibre1"/>anything using the director's second hypothesis that certain vendors might have higher defect rates than others. Go back to the script and enter this:</p><div class="informalexample"><pre class="programlisting">type  VendorProduct = {WorkOrderID: int;
                       [&lt;Feature&gt;]BusinessEntityID: int; 
                       [&lt;Feature&gt;]ProductID: int; 
                       [&lt;Label&gt;] mutable Scrapped: bool}

let workOrders = context.``[Production].[WorkOrder]`` |&gt; Seq.toArray
let maxWorkOrder = workOrders.Length
let workOrderIds = Array.zeroCreate&lt;int&gt;(1000)
let workOrderIds' = workOrderIds |&gt; Array.mapi(fun idx i -&gt; workOrders.[System.Random(idx).Next(maxWorkOrder)])
                                 |&gt; Array.map(fun wo -&gt; wo.WorkOrderID)</pre></div><p class="calibre6">When you send it<a id="id456" class="calibre1"/> to the FSI, you will get the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">type VendorProduct =</strong></span>
<span class="strong"><strong class="calibre7">  {WorkOrderID: int;</strong></span>
<span class="strong"><strong class="calibre7">   BusinessEntityID: int;</strong></span>
<span class="strong"><strong class="calibre7">   ProductID: int;</strong></span>
<span class="strong"><strong class="calibre7">   mutable Scrapped: bool;}</strong></span>

<span class="strong"><strong class="calibre7">       …</strong></span>
<span class="strong"><strong class="calibre7">    FSharp.Data.Sql.Common.SqlEntity; FSharp.Data.Sql.Common.SqlEntity;</strong></span>
<span class="strong"><strong class="calibre7">    FSharp.Data.Sql.Common.SqlEntity; FSharp.Data.Sql.Common.SqlEntity; ...|]</strong></span>
<span class="strong"><strong class="calibre7">val maxWorkOrder : int = 72591</strong></span>
<span class="strong"><strong class="calibre7">val workOrderIds : int [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0;</strong></span>
<span class="strong"><strong class="calibre7">    ...|]</strong></span>
<span class="strong"><strong class="calibre7">val workOrderIds' : int [] =</strong></span>
</pre></div><p class="calibre6">The <code class="literal">VendorProduct</code> record type should be familiar to you. The next code block creates an array of 1,000 random work order IDs. As we learned from the first experiment, neural networks take a long time to complete. We will look at some big-data solutions in the next chapter, but until then we'll do what data scientists have done for as long as they have done data science—take a sample of the larger dataset. Notice that we are using the <code class="literal">Array.Mapi</code> high-order function so that we can use the index value to locate the correct value in the work orders array. Unfortunately, we can't pass the index into the type provider and have it evaluate on the server, so the entire work order table is brought local so that we can use the index.</p><p class="calibre6">Next, enter this into the script:</p><div class="informalexample"><pre class="programlisting">let (|=|) id a = Array.contains id a

let vendorData = 
    query{for p in context.``[Production].[Product]`` do
          for wo in p.FK_WorkOrder_Product_ProductID do
          for bom in p.FK_BillOfMaterials_Product_ProductAssemblyID do
          join pv in context.``[Purchasing].[ProductVendor]`` on (bom.ComponentID = pv.ProductID)
          join v in context.``[Purchasing].[Vendor]`` on (pv.BusinessEntityID = v.BusinessEntityID)
          select  ({WorkOrderID = wo.WorkOrderID;BusinessEntityID = v.BusinessEntityID; ProductID = p.ProductID; Scrapped = wo.ScrappedQty &gt; int16 0})}
          |&gt; Seq.filter(fun vp -&gt; vp.WorkOrderID |=| workOrderIds')
          |&gt; Seq.toArray</pre></div><p class="calibre6">When you<a id="id457" class="calibre1"/> send it to the FSI, after a bit of a wait, you will get the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val ( |=| ) : id:'a -&gt; a:'a [] -&gt; bool when 'a : equality</strong></span>
<span class="strong"><strong class="calibre7">val vendorData : VendorProduct [] =</strong></span>
<span class="strong"><strong class="calibre7">  [|{WorkOrderID = 25;</strong></span>
<span class="strong"><strong class="calibre7">     BusinessEntityID = 1576;</strong></span>
<span class="strong"><strong class="calibre7">     ProductID = 764;</strong></span>
<span class="strong"><strong class="calibre7">     Scrapped = false;}; {WorkOrderID = 25;</strong></span>
<span class="strong"><strong class="calibre7">                          BusinessEntityID = 1586;</strong></span>
<span class="strong"><strong class="calibre7">                          ProductID = 764;</strong></span>
<span class="strong"><strong class="calibre7">                          Scrapped = false;}; {WorkOrderID = 25;</strong></span>
</pre></div><p class="calibre6">The first line is the <code class="literal">in</code> (<code class="literal">|=|</code>) operator that we ran across in <a class="calibre1" title="Chapter 5. Time Out – Obtaining Data" href="part0036_split_000.html#12AK81-a18db0be6c20485ba81f22e43ca13055">Chapter 5</a>, <span class="strong"><em class="calibre11">Time Out – Obtaining Data</em></span>. The next code block hydrates the <code class="literal">vendorData</code> array with the data from the 1,000 randomly selected work orders. Notice that there is some repetition because each work order will use several parts and each part might be supplied by a variety of vendors (in this case, called business entities).</p><p class="calibre6">With the data local, go into the script and enter this:</p><div class="informalexample"><pre class="programlisting">let vendorData' = vendorData |&gt; Seq.map box
let descriptor' = Descriptor.Create&lt;VendorProduct&gt;()
let generator' = NeuralNetworkGenerator()
generator'.Descriptor &lt;- descriptor'
let model' = Learner.Learn(vendorData', 0.80, 5, generator')
let accuracy' = model'.Accuracy</pre></div><p class="calibre6">When you send it to the FSI, you will get the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">val generator' : NeuralNetworkGenerator</strong></span>
<span class="strong"><strong class="calibre7">val model' : LearningModel =</strong></span>
<span class="strong"><strong class="calibre7">  Learning Model:</strong></span>
<span class="strong"><strong class="calibre7">  Generator numl.Supervised.NeuralNetwork.NeuralNetworkGenerator</strong></span>
<span class="strong"><strong class="calibre7">  Model:</strong></span>
<span class="strong"><strong class="calibre7">numl.Supervised.NeuralNetwork.NeuralNetworkModel</strong></span>
<span class="strong"><strong class="calibre7">  Accuracy: 99.32 %</strong></span>

<span class="strong"><strong class="calibre7">val accuracy' : float = 0.9931740614</strong></span>
</pre></div><p class="calibre6">So, this is interesting. We have a very high accuracy rate. One wonders: is this because in the case of a single vendor for a product, all of the scrapped amount will be associated with them <a id="id458" class="calibre1"/>because they are the only ones. However, since a single vendor might supply multiple input products and those products might have different scrap rates, you can use the model to predict if a given vendor and a given product will have a scrap rate. Also, notice that instead of adding an input for each vendor and product (which would have made a very sparse data frame), there is one input for vendor and one for product. Although these can be considered categorical values, we can sacrifice some precision for this exercise.</p><p class="calibre6">The key thing about the neural network that you will want to remember is that the neural network can't tell you how it got its answer (very much like the human brain, no?). So the neural network won't report back which combination of vendors and products will lead to defects. To do that, you would need to use a different model.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Building the application"><div class="book" id="1JFUC2-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec47" class="calibre1"/>Building the application</h1></div></div></div><p class="calibre6">With this neural<a id="id459" class="calibre1"/> network giving us enough of what we need, let's go ahead and build out our ASP.NET 5.0 application with the model. At the time of writing, ASP.NET 5.0 only supports C# so we will have to translate our F# into C# and port the code into the application. Once the other languages are supported by ASP.NET, we will update the sample code on the website.</p><p class="calibre6">If you are not familiar with C#, it is the most popular language on the .NET stack and is very similar to Java. C# is a general-purpose language that initially combined imperative and object-oriented language features. Lately, functional constructs have been bolted onto the language specifications. However, as the old carpenter axiom goes, "If it's a screw, use a screwdriver. If it's a nail, use a hammer." Since that's the case, you are much better served to do .NET functional programming with F#. I'll do my best in the next section to explain any differences in the C# implementation when we port the code over.</p></div>

<div class="book" title="Building the application">
<div class="book" title="Setting up the models"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec81" class="calibre1"/>Setting up the models</h2></div></div></div><p class="calibre6">You already have<a id="id460" class="calibre1"/> the boilerplate MVC site created. Open up NuGet Package Manager Console and install numl into it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">PM &gt; install-package numl</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00139.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, create a folder called <code class="literal">Models</code> in the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span>:</p><div class="mediaobject"><img src="../images/00140.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In that folder, add a<a id="id461" class="calibre1"/> new class file named <code class="literal">VendorProduct</code>:</p><div class="mediaobject"><img src="../images/00141.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Inside that file, replace all of the code with the following:</p><div class="informalexample"><pre class="programlisting">using numl.Model;

namespace AdventureWorks.ProcessAnalysisTool.Models
{
    public class VendorProduct
    {
        public int WorkOrderID { get; set; }
        [Feature]
        public int BusinessEntityID { get; set; }
        [Feature]
        public int ProductID { get; set; }
        [Label]
        public bool Scrapped { get; set; }
    }
}</pre></div><p class="calibre6">As you can guess, this is the <a id="id462" class="calibre1"/>equivalent of the record type we create in F#. The only real difference is that the properties are mutable by default (so be careful). Go to the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and find the <code class="literal">Project.json</code> file. Open it and remove this entry in the <code class="literal">frameworks</code> section:</p><div class="informalexample"><pre class="programlisting">:    "dnxcore50": { }</pre></div><p class="calibre6">This section should now look like the following:</p><div class="mediaobject"><img src="../images/00142.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Go ahead and run the <a id="id463" class="calibre1"/>website to make sure it is good:</p><div class="mediaobject"><img src="../images/00143.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">What we are doing is removing the site's dependency on .NET Core. Although numl does support .NET Core, we don't need it right now.</p><p class="calibre6">If the site is up and running, let's add the rest of our helper classes. Go back into the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add a new class file named <code class="literal">Product.cs</code>. Go into that class and replace the existing code with this:</p><div class="informalexample"><pre class="programlisting">using System;

namespace AdventureWorks.ProcessAnalysisTool.Models
{
    public class Product
    {
        public int ProductID { get; set; }
        public string Description { get; set; }
    }
}</pre></div><p class="calibre6">This is another<a id="id464" class="calibre1"/> record-equivalent class which will be used when the user selects the <code class="literal">Product</code> they want to model.</p><p class="calibre6">Go back to the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add a new class file named <code class="literal">Vendor.cs</code>. Go into that class and replace the existing code with this:</p><div class="informalexample"><pre class="programlisting">using System;

namespace AdventureWorks.ProcessAnalysisTool.Models
{
    public class Vendor
    {
        public int VendorID { get; set; }
        public String Description { get; set; }

    }
}</pre></div><p class="calibre6">Like the <code class="literal">Product</code> class, this will be used to populate the select list for the user.</p><p class="calibre6">Go back into the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add a new class file named <code class="literal">Repository.cs</code>. Go into that class and replace the existing code with the following:</p><div class="informalexample"><pre class="programlisting">using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Linq;

namespace AdventureWorks.ProcessAnalysisTool.Models
{
    public class Repository
    {
        public String ConnectionString { get; private set; }
        public Repository(String connectionString)
        {
            this.ConnectionString = connectionString;
        }

        public ICollection&lt;Vendor&gt; GetAllVendors()
        {
            var vendors = new List&lt;Vendor&gt;();
            using (var connection = new SqlConnection(this.ConnectionString))
            {
                var commandText =
                    "Select distinct V.BusinessEntityID, V.Name from [Purchasing].[Vendor] as V " +
                    "Inner join[Purchasing].[ProductVendor] as PV " +
                    "on V.BusinessEntityID = PV.BusinessEntityID " +
                    "order by 2 asc";

                using (var command = new SqlCommand(commandText, connection))
                {
                    connection.Open();
                    var reader = command.ExecuteReader();
                    while (reader.Read())
                    {
                        vendors.Add(new Vendor() { VendorID = (int)reader[0], Description = (string)reader[1] });
                    }
                }
            }
            return vendors;
        }

        public ICollection&lt;Product&gt; GetAllProducts()
        {
            var products = new List&lt;Product&gt;();
            using (var connection = new SqlConnection(this.ConnectionString))
            {
                var commandText =
                    "Select distinct P.ProductID, P.Name from [Production].[Product] as P " +
                    "Inner join[Purchasing].[ProductVendor] as PV " +
                    "on P.ProductID = PV.ProductID " +
                    "order by 2 asc";

                using (var command = new SqlCommand(commandText, connection))
                {
                    connection.Open();
                    var reader = command.ExecuteReader();
                    while (reader.Read())
                    {
                        products.Add(new Product() { ProductID = (int)reader[0], Description = (string)reader[1] });
                    }
                }
            }
            return products;
        }

        public ICollection&lt;VendorProduct&gt; GetAllVendorProducts()
        {
            var vendorProducts = new List&lt;VendorProduct&gt;();
            using (var connection = new SqlConnection(this.ConnectionString))
            {
                var commandText =
                    "Select WO.WorkOrderID, PV.BusinessEntityID, PV.ProductID, WO.ScrappedQty " +
                    "from[Production].[Product] as P " +
                    "inner join[Production].[WorkOrder] as WO " +
                    "on P.ProductID = WO.ProductID " +
                    "inner join[Production].[BillOfMaterials] as BOM " +
                    "on P.ProductID = BOM.ProductAssemblyID " +
                    "inner join[Purchasing].[ProductVendor] as PV " +
                    "on BOM.ComponentID = PV.ProductID ";

                using (var command = new SqlCommand(commandText, connection))
                {
                    connection.Open();
                    var reader = command.ExecuteReader();
                    while (reader.Read())
                    {
                        vendorProducts.Add(new VendorProduct()
                        {
                            WorkOrderID = (int)reader[0],
                            BusinessEntityID = (int)reader[1],
                            ProductID = (int)reader[2],
                            Scrapped = (short)reader[3] &gt; 0
                        });
                    }
                }
            }

            return vendorProducts;
        }

        public ICollection&lt;VendorProduct&gt; GetRandomVendorProducts(Int32 number)
        {
            var returnValue = new List&lt;VendorProduct&gt;();
            var vendorProducts = this.GetAllVendorProducts();
            for (int i = 0; i &lt; number; i++)
            {
                var random = new System.Random(i);
                var index = random.Next(vendorProducts.Count - 1);
                returnValue.Add(vendorProducts.ElementAt(index));
            }
            return returnValue;
        }
    }
}</pre></div><p class="calibre6">As you can probably <a id="id465" class="calibre1"/>guess, this is the class that calls out to the database. Since C# does not have type providers, we need to handwrite the ADO.NET code. We will need to add a reference to <code class="literal">System.Data</code> to make this code work. Go into the <span class="strong"><strong class="calibre7">References</strong></span> in <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and add it:</p><div class="mediaobject"><img src="../images/00144.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">You can run the site again to make sure we are on the right track. In the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span>, add a class file<a id="id466" class="calibre1"/> called <code class="literal">NeuralNetwork.cs</code>. Replace all of its code with this:</p><div class="informalexample"><pre class="programlisting">using numl;
using numl.Model;
using numl.Supervised.NeuralNetwork;
using System;
using System.Collections.Generic;

namespace AdventureWorks.ProcessAnalysisTool.Models
{
    public class NeuralNetwork
    {
        public ICollection&lt;VendorProduct&gt; VendorProducts { get; private set; }
        public LearningModel Model { get; private set; }

        public NeuralNetwork(ICollection&lt;VendorProduct&gt; vendorProducts)
        {
            if(vendorProducts ==  null)
            {
                throw new ArgumentNullException("vendorProducts");
            }
            this.VendorProducts = vendorProducts;
            this.Train();
        }

        internal void Train()
        {
            var vendorData = VendorProducts;
            var descriptor = Descriptor.Create&lt;VendorProduct&gt;();
            var generator = new NeuralNetworkGenerator();
            generator.Descriptor = descriptor;
            var model = Learner.Learn(vendorData, 0.80, 5, generator);
            if (model.Accuracy &gt; .75)
            {
                this.Model = model;
            }
        }

        public bool GetScrappedInd(int vendorId, int productId)
        {
            if(this.Model == null)
            {
                return true;
            }
            else
            {
                var vendorProduct = new VendorProduct()
                {
                    BusinessEntityID = vendorId, ProductID = productId,
                    Scrapped = false
                };
                return (bool)this.Model.Model.Predict((object)vendorProduct);
            }
        }
    }
}</pre></div><p class="calibre6">This class does the heavy lifting of the neural network calculations for us. Notice that the class is data–agnostic, so<a id="id467" class="calibre1"/> it can be ported over to .NET Core easily. All we need is a collection of <code class="literal">VendorProducts</code> to be passed into the constructor for the neural network to calculate.</p><p class="calibre6">With all of these classes created, your solution explorer should look like this:</p><div class="mediaobject"><img src="../images/00145.jpeg" alt="Setting up the models" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">You should be able to compile and run the website. Let's now implement a user interface for the neural <a id="id468" class="calibre1"/>network.</p></div></div>

<div class="book" title="Building the application">
<div class="book" title="Building the UX"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec82" class="calibre1"/>Building the UX</h2></div></div></div><p class="calibre6">The following steps<a id="id469" class="calibre1"/> will guide you to build the UX:</p><p class="calibre6">Go into the <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and select <span class="strong"><strong class="calibre7">AdventureWorks.ProcessAnalysisTool</strong></span>. Navigate to <span class="strong"><strong class="calibre7">Add</strong></span> | <span class="strong"><strong class="calibre7">New Item</strong></span>:</p><div class="mediaobject"><img src="../images/00146.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In the next dialog, select <span class="strong"><strong class="calibre7">Class</strong></span> and name it <code class="literal">Global.cs</code>:</p><div class="mediaobject"><img src="../images/00147.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Go to the <code class="literal">Global</code> class<a id="id470" class="calibre1"/> and replace all of the contents with the following:</p><div class="informalexample"><pre class="programlisting">using AdventureWorks.ProcessAnalysisTool.Models;

namespace AdventureWorks.ProcessAnalysisTool
{
    public static class Global
    {
        static NeuralNetwork _neuralNetwork = null;

        public static void InitNeuralNetwork()
        {
            var connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=AdventureWorks2014;user id= PacktReader;password= P@cktM@chine1e@rning;";
            var repository = new Repository(connectionString);
            var vendorProducts = repository.GetRandomVendorProducts(1000);
            _neuralNetwork = new NeuralNetwork(vendorProducts);
        }

        public static NeuralNetwork NeuralNetwork
        { get
            {
                return _neuralNetwork;
            }
        }
    }
}</pre></div><p class="calibre6">This class creates a new neural network for us. We can access the neural network's functions via the read-only property called <code class="literal">Neural Network</code>. Because it is marked static, the class will stay in<a id="id471" class="calibre1"/> memory as long as the application is running.</p><p class="calibre6">Next, locate the <code class="literal">Startup.cs</code> file in the main site:</p><div class="mediaobject"><img src="../images/00148.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Open the file and replace the constructor (called <code class="literal">Startup</code>) with this code:</p><div class="informalexample"><pre class="programlisting">        public Startup(IHostingEnvironment env)
        {
            // Set up configuration sources.
            var builder = new ConfigurationBuilder()
                .AddJsonFile("appsettings.json")
                .AddEnvironmentVariables();
                Configuration = builder.Build();

            Global.InitNeuralNetwork();
        }</pre></div><p class="calibre6">When the website<a id="id472" class="calibre1"/> starts up, it will create a global neural network that all requests can use.</p><p class="calibre6">Next, locate the <code class="literal">HomeController</code> in the <code class="literal">Controllers</code> directory.</p><div class="mediaobject"><img src="../images/00149.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Open that file and add this method to populate some drop lists of vendors and products:</p><div class="informalexample"><pre class="programlisting">        [HttpGet]
        public IActionResult PredictScrap()
        {
            var connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=AdventureWorks2014;user id= PacktReader;password= P@cktM@chine1e@rning;";
            var repository = new Repository(connectionString);
            var vendors = repository.GetAllVendors();
            var products = repository.GetAllProducts();

            ViewBag.Vendors = new SelectList(vendors, "VendorID", "Description");
            ViewBag.Products = new SelectList(products, "ProductID", "Description");

            return View();
        } </pre></div><p class="calibre6">Next, add this method to run <code class="literal">Calculate</code> on the global neural network when the vendor and product are <a id="id473" class="calibre1"/>posted back to the server:</p><div class="informalexample"><pre class="programlisting">        [HttpPost]
        public IActionResult PredictScrap(Int32 vendorId, Int32 productId)
        {
            ViewBag.ScappedInd = Global.NeuralNetwork.GetScrappedInd(vendorId, productId);

            var connectionString = "data source=nc54a9m5kk.database.windows.net;initial catalog=AdventureWorks2014;user id= PacktReader;password= P@cktM@chine1e@rning;";
            var repository = new Repository(connectionString);
            var vendors = repository.GetAllVendors();
            var products = repository.GetAllProducts();

            ViewBag.Vendors = new SelectList(vendors, "VendorID", "Description", vendorId);
            ViewBag.Products = new SelectList(products, "ProductID", "Description", productId);

            return View();
        }</pre></div><p class="calibre6">If you collapse to definitions, the <code class="literal">HomeController</code> will look like this:</p><div class="mediaobject"><img src="../images/00150.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, go into<a id="id474" class="calibre1"/> <span class="strong"><strong class="calibre7">Solution Explorer</strong></span> and navigate to <span class="strong"><strong class="calibre7">AdventureWorks.ProcessAnalysisTool</strong></span> | <span class="strong"><strong class="calibre7">Views</strong></span> | <span class="strong"><strong class="calibre7">Home</strong></span>. Right-click on the folder and navigate to <span class="strong"><strong class="calibre7">Add</strong></span> | <span class="strong"><strong class="calibre7">New Item</strong></span>:</p><div class="mediaobject"><img src="../images/00151.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">In the next dialog box, select <span class="strong"><strong class="calibre7">MVC View Page</strong></span> and name it <code class="literal">PredictScrap.cshtml</code>:</p><div class="mediaobject"><img src="../images/00152.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Open this page and replace <a id="id475" class="calibre1"/>all of the contents with the following:</p><div class="informalexample"><pre class="programlisting">&lt;h2&gt;Determine Scrap Rate&lt;/h2&gt;

@using (Html.BeginForm())
{
    &lt;div class="form-horizontal"&gt;
        &lt;h4&gt;Select Inputs&lt;/h4&gt;
        &lt;hr /&gt;

        &lt;div class="form-group"&gt;
            &lt;div class="col-md-10"&gt;
                @Html.DropDownList("VendorID", (SelectList)ViewBag.Vendors, htmlAttributes: new { @class = "form-control" })
                @Html.DropDownList("ProductID", (SelectList)ViewBag.Products, htmlAttributes: new { @class = "form-control" })
           &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;div class="col-md-offset-2 col-md-10"&gt;
                &lt;input type="submit" value="Predict!" class="btn btn-default" /&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;h4&gt;Will Have Scrap?&lt;/h4&gt;
        &lt;div class="form-group"&gt;
            &lt;div class="col-md-offset-2 col-md-10"&gt;
                @ViewBag.ScappedInd
            &lt;/div&gt;
        &lt;/div&gt;
   &lt;/div&gt;
}</pre></div><p class="calibre6">This is the input form that will allow users to select vendors and products and see what the neural network<a id="id476" class="calibre1"/> will predict—whether this combination will have scrap. When you run the site and navigate to <code class="literal">localhost:port/home/PredictScrap</code> for the first time, you will see the droplists ready for you:</p><div class="mediaobject"><img src="../images/00153.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Select a vendor and a product and click on <span class="strong"><strong class="calibre7">Predict!</strong></span>:</p><div class="mediaobject"><img src="../images/00154.jpeg" alt="Building the UX" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">We now have a fully functioning ASP .NET Core 1.0 website that uses a neural network to predict<a id="id477" class="calibre1"/> AdventureWorks scrap percentages. With this skeleton, we can hand the site off to a UX expert to make the site have a better look and feel—with the core functionality in place.</p></div></div>
<div class="book" title="Summary" id="1KEEU1-a18db0be6c20485ba81f22e43ca13055"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec48" class="calibre1"/>Summary</h1></div></div></div><p class="calibre6">This chapter broke some new ground. We dove into ASP.NET 5.0 for our website design. We used numl to create two neural networks: one that showed that there is no relationship between the area of the company and the scrap rate, and another that can be used to predict if there will be scrap based on the vendor and product. We then implemented the second model in our website.</p></div></body></html>