# 1

# 介绍 Azure 机器学习服务

**机器学习**（**ML**），通过利用数据来构建和训练模型以进行预测，正在迅速成熟。**Azure 机器学习**（**AML**）是微软的云服务，它不仅能够实现模型开发，还能支持您的数据科学生命周期。AML 是一个旨在赋能数据科学家、ML 工程师和公民数据科学家的工具。它提供了一个框架，通过 **MLOps** 训练和部署模型，在由微软的财富 500 强客户多年反馈支持的协作环境中监控、重新训练、评估和重新部署模型。

在本章中，我们将专注于部署 AML 工作区，这是利用 Azure 资源提供环境以汇集您在使用 AML 时将利用的资产的资源。我们将展示如何使用 Azure CLI 的 `ml` 扩展来部署这些资源，允许通过命令行进行模型训练和部署。我们将通过利用 **Azure 资源管理**（**ARM**）模板来设置工作区，这些模板被称为 ARM 部署。

在部署过程中，将部署关键资源，包括 **AML Studio**，一个数据科学家用于管理其工作负载的门户，通常被称为您的 **工作区**；**Azure Key Vault** 用于存储敏感信息；**Application Insights** 用于记录信息；**Azure 容器注册库** 用于存储可利用的 docker 镜像；以及一个 **Azure 存储账户** 用于存储数据。当您在 Azure 机器学习服务工作区中导航时，这些资源将在幕后被利用，通过利用您选择的 **集成开发环境**（**IDE**），包括 **Jupyter Notebook**、**Jupyter Lab** 以及 **VS Code** 来编写代码。

在本章中，我们将涵盖以下主题：

+   构建您的第一个 AMLS 工作区

+   导航 AMLS

+   创建用于编写代码的计算资源

+   在 AMLS 中开发

+   将 AMLS 连接到 VS Code

# 技术要求

在本节中，您将注册 Azure 账户并使用基于网页的 Azure 门户创建各种资源。因此，您需要互联网访问和一个正常工作的网页浏览器。

以下章节的先决条件：

+   互联网访问

+   网页浏览器，最好是 Google Chrome 或 Microsoft Edge Chromium

+   如果您还没有 Azure 订阅，您可以按照以下链接利用 30 天内可用的 $200 Azure 信用额度：[https://azure.microsoft.com/en-us/free/](https://azure.microsoft.com/en-us/free/)。

+   Azure CLI >= 2.15.0

+   本书所使用的代码已发布在以下仓库中：[https://github.com/PacktPublishing/Azure-Machine-Learning-Engineering.git](https://github.com/PacktPublishing/Azure-Machine-Learning-Engineering.git)。

+   您将利用 GitHub 仓库中的代码：

    +   [https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-workspace/azuredeploy.json](https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-workspace/azuredeploy.json)

    +   [https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-compute-create-computeinstance/azuredeploy.json](https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-compute-create-computeinstance/azuredeploy.json)

# 构建您的第一个 AMLS 工作区

在 Azure 中，有无数种创建 Azure 资源的方法。最常见的方法是通过 `ml` 扩展（V2），它为您提供了一个熟悉的终端来自动化部署。您还可以使用 ARM 模板创建资源。CLI 和 ARM 模板都提供了一个可自动化、可重复的过程来在 Azure 中创建资源。

在接下来的小节中，我们将首先通过 Web 门户创建一个 **AMLS 工作区**。在您掌握这项任务后，您还将通过 Azure CLI 创建另一个工作区。一旦您理解了 CLI 的工作原理，您将创建一个 ARM 模板并使用它来部署第三个工作区。在了解所有三种部署方法之后，您将删除所有多余的资源，然后进入下一节；保留多余的资源运行将花费您金钱，所以请小心。

## 通过 Azure 门户创建 AMLS 工作区

使用门户创建 AMLS 工作区是最简单、最直接的方法。通过 GUI，您创建一个 **资源组**，一个用于存放多个资源的容器，以及您的 AMLS 工作区和所有其组件。要创建工作区，请导航到 [https://portal.azure.com](https://portal.azure.com) 并按照以下步骤操作：

1.  导航到 [https://portal.azure.com](https://portal.azure.com) 并在搜索框中输入 `Azure Machine Learning`，如 *图 1.1* 所示，然后按 *Enter*：

![图 1.1 – 选择资源组](img/B18003_01_001.jpg)

图 1.1 – 选择资源组

1.  在 Azure 门户的右上角，选择 *图 1.2* 中显示的 **+ 创建** 选项：

![图 1.2 – 创建 AML 工作区](img/B18003_01_002.jpg)

图 1.2 – 创建 AML 工作区

选择 **+ 创建** 选项将显示 *基本* 选项卡，如下所示：

![图 1.3 – 填写创建 ML 工作区所需的字段](img/B18003_01_003.jpg)

图 1.3 – 填写创建 ML 工作区所需的字段

1.  在创建 AML 工作区的 *图 1.3* 中所示的 *基本* 选项卡中，填写以下值：

    1.  **订阅**：您要部署资源的 Azure 订阅。

    1.  **资源组**：点击**创建新**并输入资源组的名称。在Azure中，资源组可以被视为文件夹或容器，用于存放特定解决方案的资源。在我们部署AMLS工作空间时，资源将被部署到这个资源组中，以确保我们可以在完成此练习后轻松删除资源。

    1.  **工作空间名称**：AMLS工作空间资源的名称。

    1.  其余选项都是默认的，您可以选择**审查 + 创建**按钮。

1.  这将导致验证发生——一旦信息被验证，点击**+ 创建**按钮来部署您的资源。

1.  工作空间创建通常需要几分钟。一旦部署完成，在Azure门户中点击**转到资源**，然后点击**启动工作室**以进入AMLS工作空间。

您现在位于如图*图1.4*所示的AMLS登录页面：

![图1.4 – AMLS](img/B18003_01_004.jpg)

图1.4 – AMLS

恭喜！您现在已成功构建了您的第一个AMLS工作空间。虽然您现在可以开始加载数据，但请花时间浏览下一节，了解如何通过代码创建它。

## 通过Azure CLI创建AMLS工作空间

对于喜欢先编写代码再创建资源的用户，*Azure CLI*是完美的选择。在撰写本文时，AML CLI v2是Azure CLI可用的最新扩展。在利用Azure CLI v2时，资产是通过利用YAML文件定义的，我们将在后面的章节中看到。

注意

Azure CLI v2使用遵循以下格式的命令：`az ml <名词> <动词> <选项>`。

要通过Azure CLI `ml`扩展（v2）创建AMLS工作空间，请按照以下步骤操作：

1.  您需要从[https://docs.microsoft.com/en-us/cli/azure/install-azure-cli](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)安装Azure CLI。

1.  查找您的订阅ID。在Azure门户中的搜索框中，您可以输入`Subscriptions`，然后列出Azure订阅及其ID。对于您想要使用的订阅，将**订阅ID**信息复制到CLI中使用。

这是Azure门户中**订阅**的视图：

![图1.5 – Azure订阅列表](img/B18003_01_005.jpg)

图1.5 – Azure订阅列表

1.  根据您的操作系统启动**命令行解释器**（CLI）——例如，**命令提示符**（CMD）或**Windows Powershell**（Windows PS）——然后通过运行以下命令来检查您的Azure CLI版本：

    [PRE0]

注意

您需要有一个大于2.15.0版本的Azure CLI才能利用`ml`扩展。

1.  如果旧扩展已安装，您需要将其移除以确保您的CLI正常工作。您可以通过运行以下命令来移除旧的`ml`扩展：

    [PRE1]

    [PRE2]

1.  要安装`ml`扩展，请运行以下命令：

    [PRE3]

1.  现在，让我们通过Azure CLI运行以下命令来连接到Azure中的您的订阅，在此处将`xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`替换为在*图1*中找到的**订阅ID**信息：

    [PRE4]

    [PRE5]

1.  通过运行以下命令创建一个资源组。请注意，`rg_name`是资源组的示例名称，就像`aml-ws`是AML工作区的示例名称一样：

    [PRE6]

1.  通过运行以下命令创建一个AML工作区，请注意`eastus2`是我们将部署此AML工作区的Azure区域：

    [PRE7]

您现在已使用Azure CLI `ml`扩展和通过门户创建了一个AMLS工作区。还有一种常用的创建AMLS工作区的方法，即ARM模板，我们将在下一节中探讨。

## 使用ARM模板创建AMLS工作区

ARM模板编写可能具有挑战性，但它们为您提供了轻松自动化和参数化创建Azure资源的方法。在本节中，您将首先编写一个简单的ARM模板来构建一个AMLS工作区，然后使用Azure CLI部署您的模板。为此，请执行以下步骤：

1.  ARM模板可以从GitHub下载，并在此处找到：[https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-workspace/azuredeploy.json](https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-workspace/azuredeploy.json)。

此模板创建了以下Azure服务：

+   **Azure** **存储账户**

+   **Azure** **密钥保管库**

+   **Azure** **应用程序洞察**

+   **Azure** **容器注册库**

+   **一个** **AML工作区**

示例模板有三个必需的参数：

+   `environment`，资源将在其中创建

+   `name`，这是我们赋予AMLS工作区的名称

+   `location`，资源将部署到的Azure区域

1.  要部署您的模板，您必须首先创建一个资源组，如下所示：

    [PRE8]

1.  确保您的命令提示符已打开到您下载`azuredeploy.json`文件的目录，并运行以下命令：

    [PRE9]

创建工作区需要几分钟时间。

到目前为止，我们已经涵盖了大量的信息，无论是使用门户、CLI还是现在使用ARM模板创建AMLS工作区。在下一节中，我们将向您展示如何导航工作区，通常被称为工作室。

# 导航AMLS

AMLS为数据科学团队提供了访问关键资源的方式。在本节中，您将学习如何通过探索工作室中的关键组件来导航AMLS。您将简要了解其功能，我们将在后续章节中详细介绍。

打开浏览器并转到[https://portal.azure.com](https://portal.azure.com)。使用您的Azure AD凭据登录。登录到门户后，您将看到几个图标。选择**资源组**图标，然后点击**Azure机器学习**资源。

在**概述**页面，点击以下截图中的**启动工作室**按钮：

![图1.6 – 启动工作室](img/B18003_01_006.jpg)

图1.6 – 启动工作室

点击**图1.6**中显示的图标将在新窗口中打开AMLS。

工作室启动将带您进入AMLS的主首页。UI包括匹配多个角色（包括**无代码**、**低代码**和**基于代码**的机器学习）的功能。主页有两个部分——左侧菜单面板和右侧工作区面板。

AMLS工作区首页如**图1.7**所示：

![图1.7 – AMLS工作区首页](img/B18003_01_007.jpg)

图1.7 – AMLS工作区首页

现在，让我们简要了解前面的截图：

+   在**图1.7**的**1**部分，显示左侧菜单面板。点击此面板中的任何单词将弹出一个新的右侧工作区面板，其中包括屏幕的**2**和**3**部分。我们可以选择这些关键词中的任何一个，快速访问AMLS工作区中的关键资源。随着我们开始探索AMLS工作区，我们将深入研究这些关键资源。

+   在**图1.7**的**2**部分，提供了到我们将在这本书中使用的关键资源的快速链接，使AMLS用户能够创建覆盖各种支持角色的新项目。

+   随着我们继续探索我们的环境，并在AMLS工作区中创建资产（无论是基于代码还是低代码选项），最近资源将开始出现在**图1.7**的**3**部分，使用户能够查看最近使用的资源，无论是计算、代码执行、创建的模型，还是使用的数据集。

首页提供快速访问您在AMLS工作区中找到的关键资源。除了快速链接外，向下滚动，您还可以查看**文档**部分。在**文档**部分，我们看到优秀的文档，帮助您了解如何最好地利用您的AML环境。

**文档**部分，作为文档资源的中心，显示在AMLS首页的右侧面板：

![图1.8 – 文档](img/B18003_01_008.jpg)

图1.8 – 文档

如**图1.8**所示，AMLS首页为您提供丰富的文档资源，帮助您开始学习。链接包括培训模块、教程，甚至有关如何利用AMLS的博客。

在页面右上角，有多个选项可用：

+   **通知**：铃铛图标表示通知，显示您使用 AMLS 工作区时生成的消息。这些消息将包含有关资源创建和删除的信息，以及有关您工作区中运行的资源的信息。

![图 1.9 – 右上角选项](img/B18003_01_009.jpg)

图 1.9 – 右上角选项

+   **设置**：铃铛旁边出现的齿轮图标展示了 Azure 门户的设置。单击图标提供设置基本设置的能力，如*图 1**.10*所示：

![图 1.10 – 工作区自定义设置](img/B18003_01_010.jpg)

图 1.10 – 工作区自定义设置

在**设置**选项卡中，有选项可以更改工作区 UI 的背景，使用主题。有浅色和深色可供选择。然后，有一个更改首选语言和格式的部分。检查**语言**下拉菜单以查看语言列表——随着新语言添加到工作区，语言列表将发生变化。

+   **帮助**：问号图标提供有用的资源，从教程到提交支持请求。这是所有**帮助**内容组织的地方：

![图 1.11 – AMLS 工作区支持帮助](img/B18003_01_011.jpg)

图 1.11 – AMLS 工作区支持帮助

提供有关如何使用工作区以及如何开发和部署数据科学项目的教程链接。单击**启动引导游览**以使用逐步引导游览。

要解决与工作区相关的任何问题，请单击**运行工作区诊断**并按照说明操作：

+   **支持**：这是链接技术、订阅核心限制和其他 Azure 相关问题以创建工单的部分。

+   **资源**：这是提供链接到 AML 文档以及托管在 GitHub 上的有用速查表的章节。本节还提供 Microsoft 的**隐私和条款**链接。

单击笑脸图标将显示**发送我们****反馈**部分：

![图 1.12 – 反馈页面](img/B18003_01_012.jpg)

图 1.12 – 反馈页面

利用本节，AMLS 工作区用户可以向 AMLS 产品团队提供反馈。

在以下屏幕截图中，我们可以看到工作区选择菜单：

![图 1.13 – 工作区选择菜单](img/B18003_01_013.jpg)

图 1.13 – 工作区选择菜单

当在多个项目上使用多个工作区时，可能需要在不同 Azure AD 目录之间切换 AMLS 工作区。此选项可通过选择订阅和工作区名称来访问，如*图 1**.13*所示。此外请注意，在`config`文件中，它包含允许授权用户通过代码直接连接到 AMLS 工作区的关键信息，可以在工作区选择菜单中下载以与**Azure Machine Learning SDK for Python**（**AML SDK v2**）一起使用。

接下来，我们将讨论图1.7中显示的AMLS左侧导航菜单。此导航菜单将允许您在与AML环境交互时操作您的资产，并分为三个部分：

+   **作者**部分包括**笔记本**、**自动机器学习**和**设计器**

+   **资产**部分包括作为您数据科学工作负载一部分创建的工件，这些将在后续章节中详细探讨。

+   **管理**部分包括作为您数据科学工作负载一部分将利用的资源。

按以下顺序回顾各个部分：

+   **作者**是数据科学家选择开发首选工具的部分：

    +   **笔记本**：这是菜单中**作者**部分的某个部分，提供对您的文件以及AMLS工作空间IDE的访问，该IDE类似于Jupyter笔记本，但为数据科学家执行特征工程和建模提供了一些额外功能。在此IDE中，用户可以选择Python内核的版本，将其连接到具有指定Python版本的Conda环境。

![图1.14 – 作者菜单项](img/B18003_01_014.jpg)

图1.14 – 作者菜单项

**笔记本**是**作者**部分中的一个选项，提供对文件、样本、文件管理、终端访问的访问，以及在本章的*在AMLS中开发*部分中我们将看到的内置IDE：

![图1.15 – 笔记本](img/B18003_01_015.jpg)

图1.15 – 笔记本

我们将突出显示**笔记本**选择中找到的不同功能：

1.  在图1.15的第**1**节中，点击**文件**标签会显示协作AMLS工作空间内的所有用户目录，以及存储在这些目录中的文件。

1.  在图1.15的第**2**节中，点击**样本**标签提供了AML教程，以充分利用AMLS。

1.  此外，您还可以利用计算资源上的终端。

在本节中，您可以创建新文件。点击+图标，您将能够创建新文件。请注意，您既可以上传文件，也可以创建文件夹目录。这使得您可以轻松上传数据文件，同时也可以上传代码。

创建`.ipynb`扩展名，**文件类型**菜单包括Jupyter、Python、R、Shell、文本和其他，您可以在其中提供自己的文件扩展名。

在图1.7的左侧导航菜单中，我们看到了**笔记本**，我们对其进行了简要回顾，以及**自动机器学习**和**设计器**。接下来，我们将对**自动机器学习**部分提供一个高级概述。

+   **自动化机器学习**：此选项也可以从**作者**部分选择。**自动化机器学习**是一个无需编码的工具，它提供了利用数据选择机器学习模型类型和计算能力来完成模型创建的能力。在未来的章节中，我们将更详细地介绍这一点，但就目前而言，此选项提供了一个基于提供的数据集建立模型的指南。您将被提示选择分类、回归或时间序列预测；自然语言处理（多类或多标签分类）；或计算视觉（包括多类、标签、目标检测和实例分割）基于您的工作负载。这是一个指导性的逐步过程。有设置可以停止模型超过预设时间，以确保意外成本有限。**自动化机器学习**还提供了排除算法的能力。AML将选择多种算法，并使用数据集运行它们，以提供最佳模型。除了根据给定数据集运行多个算法以确定最佳模型的能力外，**自动化机器学习**还包括模型可解释性，提供有关哪些特征在确定响应变量时更重要或更不重要的见解。此过程所需的时间取决于数据集以及分配给任务的计算资源。自动化机器学习使用临时的计算资源，因此当实验提交运行时，它将启动计算并运行实验。构建模型作为作业在实验内部运行，并保存为快照以供未来分析。使用**自动化机器学习**构建最佳模型后，AMLS提供了通过单点部署托管在**Azure 容器实例**（**ACI**）中的 REST API 来利用最佳模型的能力，用于开发和测试环境。AMLS还可以通过 REST API 部署到**Azure Kubernetes 服务**（**AKS**）并利用 CLI v2 或 SDK v2，AMLS支持**端点**，简化了模型部署的过程。

点击左侧菜单标签中的**自动化机器学习**，可以打开创建新的**自动化** **机器学习**作业的能力：

![图 1.16 – 自动化机器学习界面选项](img/B18003_01_016.jpg)

图 1.16 – 自动化机器学习界面选项

现在我们已经看到了**笔记本**和**自动化机器学习**部分，我们将查看**设计师**部分以获得低代码体验。

+   **设计师**：这是提供低代码环境的部分。数据科学家可以拖放并开发模型训练和验证。**设计师**有两个部分——左侧是菜单，右侧是开发作者部分。一旦构建了模型，就会提供将模型以各种形式部署的选项。

这里是一个使用**设计师**构建的示例实验：

![图 1.17 – 设计师示例](img/B18003_01_017.jpg)

图 1.17 – 设计师示例

**设计师**提供了使用多种机器学习模型进行建模的选项，例如分类、回归、聚类、推荐、计算机视觉和文本分析。

现在我们已经回顾了编写模型的各个部分 – **笔记本**、**自动机器学习**和**设计师** – 我们将在AMLS **资产**导航部分探索资产的概念。

+   **资产**是一个存储所有实验作业及其工件的部分：

![图1.18 – 资产菜单项](img/B18003_01_018.jpg)

图1.18 – 资产菜单项

+   **数据**：此部分将在**数据资产**选项卡下显示在AMLS工作空间内使用的已注册数据集。数据集管理每次注册新数据集时创建的版本。数据集可以通过UI、SDK或CLI创建：

    +   **数据资产**：此部分显示在工作空间内使用的所有数据集列表：

![图1.19 – 数据集显示](img/B18003_01_019.jpg)

图1.19 – 数据集显示

点击**数据资产**，查看所有数据集的列表。显示数据集的UI可以通过添加和删除列来定制您的视图。除了通过UI注册数据集的能力外，还可以通过点击**存档**来存档数据集。随着时间的推移，存储库中的数据可能会发生变化，因为应用程序添加了数据。

+   **数据存储**：在左侧面板菜单的**数据**部分中也可以选择。数据存储可以被视为检索数据的位置。数据存储的例子包括Azure Blob存储、Azure文件共享、Azure Data Lake存储或Azure数据库，包括SQL、PostgreSQL和MySQL。所有连接到与您的AMLS工作空间关联的数据存储并在Azure Key Vault中存储的安全措施。在AMLS工作空间部署期间，创建了一个Azure Blob存储账户。这个Azure Blob存储账户是您AMLS工作空间的默认数据存储。

+   可以使用当前处于预览状态的功能来监控已注册的数据集，通过点击*图1.19*中显示的**数据集监控（预览）**标签进行查看。

+   **作业**：**作业**屏幕显示了所有实验，它们是作业组，以及您在AMLS工作空间内执行的代码：

![图1.20 – 实验显示](img/B18003_01_020.jpg)

图1.20 – 实验显示

您可以通过添加或删除列来定制和重置UI中作业的默认视图，包括给定作业的属性。

每个实验都会在**实验**下以蓝色文本的形式显示，如*图1.20*所示。在**作业**部分，我们可以选择多个实验并查看它们的性能图表。

+   **管道**：管道是在实验作业中执行的一系列步骤：

![图1.21 – 管道显示](img/B18003_01_021.jpg)

图1.21 – 管道显示

通常，设计实验将显示管道并提供作业的状态。与 **作业** 和 **数据集** 的 UI 一样，UI 在查看管道时提供了自定义选项。您还可以显示 **管道端点**。**管道草稿** 选项也是可用的。您可以根据 **状态**、**实验** 或 **标签** 对视图进行排序或过滤。还有选择所有筛选器和清除筛选器的选项。还有选择显示行数的选项。

+   **环境**：设置 Python 环境可能会是一项艰巨的任务，因为利用开源包的价值伴随着管理各种包版本复杂性的挑战。虽然这个问题并非仅限于 AMLS 工作空间，但 Azure 已经为管理这些资源提供了解决方案——在 AMLS 中，它们被称为 **环境**。**环境**是 AMLS 中的一个部分，允许用户查看和注册哪些包，以及哪些 Docker 镜像应由计算资源利用。微软已经创建了这些环境中的几个，这些环境被认为是经过精心挑选的，用户也可以创建自己的自定义环境。我们将在 [*第 3 章*](B18003_03.xhtml#_idTextAnchor053) 中利用自定义环境，即 *在 AMLS 中训练机器学习模型*，因为我们将在计算集群上运行实验作业。

**环境** 部分提供了 AMLS 工作空间利用的环境列表：

![图 1.22 – 环境](img/B18003_01_022.jpg)

图 1.22 – 环境

在 **精选环境** 部分，有各种各样的环境可供选择。这对于需要具有特定库的环境的应用程序非常有用。创建的环境列表可供选择。点击每个 **名称** 可以查看环境包含的内容。目前，以下大多数环境都用于推理目的。

+   **模型**：**模型** 部分显示了所有注册的模型及其版本。UI 提供了如图所示的自定义列：

![图 1.23 – 模型显示](img/B18003_01_023.jpg)

图 1.23 – 模型显示

模型可以通过手动方式、通过 SDK 或通过 CLI 进行注册。更改显示模型数量、显示模型的当前版本或所有版本，以及排序、过滤和清除的能力都是可用的。

+   **端点**：模型可以作为 REST 端点部署。这些端点利用模型，并基于训练模型提供预测值，从而提供响应。利用 REST 协议，这些模型可以很容易地被其他应用程序消费。点击 AMLS 左侧导航菜单上的 **端点** 将显示这些内容。

**端点** 部分显示了实时和批量推理的端点：

![图 1.24 – 端点显示](img/B18003_01_024.jpg)

图 1.24 – 端点显示

实时端点被称为在线端点，通常处理一行数据并产生一个评分输出，并且作为 REST API 性能良好。批量端点用于基于批量的执行，我们传递大量数据集，然后提供预测输出。这通常是一个长时间运行的过程。虽然 CLI v1 和 SDK v1 允许 AMLS 用户部署到 ACI 和 Kubernetes，但本书将专注于利用 CLI v2 和 SDK v2 的部署，这些部署利用端点部署到托管在线端点、Kubernetes 在线端点和批量推理端点。

+   **管理** 是用户可以管理 AMLS 工作空间利用的资源部分，包括 **计算**、**数据标注** 和 **链接服务**：

    +   **计算**: 这是我们管理用于开发数据科学项目的各种计算资源的地方。在 AMLS 的 **计算** 部分中可以找到四种类型的计算资源。这四种包括 **计算实例**、**计算集群**、**推理集群** 和 **附加计算**。

**计算** 部分提供了对使用 AMLS 工作空间利用的计算资源的可见性：

![图 1.25 – 计算选项](img/B18003_01_025.jpg)

图 1.25 – 计算选项

一个计算资源可以是一个单独的节点，也可以包括几个 **节点**。节点是一个 **虚拟机**（**VM**）实例。单个节点实例可以垂直扩展，并且将仅限于 **中央处理器**（**CPU**）和 **图形处理器**（**GPU**）。计算实例是单个节点。这些资源非常适合开发工作。另一方面，计算集群可以水平扩展，并且可以用于处理大型数据集的工作负载，因为工作负载可以在节点之间进行分配。为了实现扩展，可以通过并行执行作业来有效地使用我们的 AML SDK 进行训练和评分。

在 **计算** 部分中，随着计算资源的创建，您的订阅可用配额将显示出来，提供了对给定订阅中可用核心数量的可见性。大多数 Azure VM SKU 都可用于计算资源。对于 GPU，根据地区，如果该地区可用，用户可以创建支持请求来扩展 vCore。在创建计算集群时，可以设置计算集群使用的节点数量从 0 到 N 个节点。

AMLS工作空间中的计算资源按节点每小时计费。在计算集群中，将最小节点数设置为`0`将在达到缩放下之前的空闲秒数后，实验完成后关闭计算资源。对于计算实例，您可以选择何时开启或关闭实例以节省费用。除了计算实例和计算集群之外，AMLS还有推理集群的概念。**计算**部分中的**推理集群**允许您查看或创建一个AKS集群。计算部分中可用的最后一种计算类型位于**附加计算**部分。此部分允许您附加自己的计算资源，包括**Azure Databricks**、**Synapse Spark pools**、**HDInsights**、虚拟机以及其他。

+   **数据标注**：**数据标注**是AMLS中添加的新功能选项。此功能用于为基于自定义视觉建模的项目标记图像。图像在AMLS的**数据标注**项目中标记。多个用户可以在一个项目中标记图像。为了进一步提高生产力，有ML辅助数据标注。在标注项目中，可以标记文本和图像。对于图像项目，标注任务包括**多类图像分类**，它涉及从一组类别中对图像进行分类，以及**多标签图像分类**，它从一组类别中应用更多标签。还有**对象识别**，它为图像中找到的每个对象定义一个边界框，最后是**实例分割**，它为图像提供多边形并分配一个类别标签。**文本**项目包括**多类**、**多标签**和**文本命名实体识别**选项。**多类**将对文本应用单个标签，而**多标签**允许您对一个文本片段应用一个或多个标签。**文本命名实体识别**允许用户为一段文本提供一个或多个实体。

**数据标注**功能需要GPU支持的计算资源，因为其计算密集型特性。提供项目说明的选项可用。每个用户都会分配一个队列，并且用户在项目中的进度也会在每个项目的仪表板上显示。

以下截图显示了如何显示一个示例标注项目：

![图1.26 – 数据标注](img/B18003_01_026.jpg)

图1.26 – 数据标注

+   **链接服务**：这为您提供了与其他Microsoft产品的集成，目前包括Azure Synapse Analytics，以便您可以将Apache Spark pools附加到服务中。点击**+ 添加集成**按钮，从Azure订阅中选择，然后选择Synapse工作区。

**链接服务**，如以下截图所示，提供了与其他Microsoft产品建立连接的可见性：

![图1.27 – 链接服务](img/B18003_01_027.jpg)

图1.27 – 链接服务

通过这个目前处于公共预览阶段的链接服务，AMLS可以利用Azure Synapse工作区，将Apache Spark池的力量带入你的AMLS环境。数据科学工作负载的一个重要组成部分是数据准备，通过**链接服务**，可以利用Spark进行数据转换。

在对AMLS工作区有基本了解之后，你现在可以继续编写代码。然而，在这样做之前，你需要创建一个将支持你的作业的虚拟机。**计算实例**是专门用于编写代码的AMLS虚拟机。它们有多种形状和大小，可以通过AMLS GUI、Azure CLI、Python代码或ARM模板创建。每个用户都需要有自己的计算实例，因为AMLS只允许每个计算实例有一个用户。

我们将首先通过AMLS GUI创建计算实例。然后，我们将为我们的计算实例添加一个计划，以便它能够自动启动和关闭；这是一个重要的节省成本措施。接下来，我们将使用Azure CLI创建计算实例。最后，我们将使用启用计划的ARM模板创建计算实例。尽管你将创建三个计算实例，但无需删除它们，因为你只需在使用期间为其付费。

小贴士

当你不使用计算实例时，请确保将其关闭。让计算实例持续运行会产生每小时的费用。

在本节中，我们已经通过AMLS导航，利用左侧导航菜单面板。我们探索了**作者**、**资产**和**管理**部分以及AMLS中找到的每个组件。现在我们已经涵盖了导航AMLS组件，让我们继续创建计算实例，这样你就可以开始在AMLS中编写代码了。

# 创建用于编写代码的计算实例

在本节中，你将创建一个计算实例以开始你的开发。每个子节将演示如何使用不同的方法在你的AMLS工作区中创建这些资源。

## 通过AMLS GUI创建计算实例

创建计算实例最直接的方式是通过AMLS。计算实例有多种大小，你应该根据你的数据大小进行调整。一个很好的经验法则是，你应该有20倍于CSV格式数据大小的RAM，或者2倍于pandas DataFrame（Python数据科学中最流行的数据结构）数据大小的RAM。这是因为，当你将CSV文件作为pandas DataFrame读取时，它会将数据扩展到10倍。

计算机的名称必须在给定的Azure区域中是唯一的，因此你需要确保你的计算资源名称是唯一的，否则部署将失败。

现在，让我们创建一个计算实例——一个可以用于开发的单个VM类型的计算实例。每个计算实例都分配给工作区中的单个用户，以便他们进行开发。

要创建计算实例，请按照以下步骤操作：

1.  登录到 AMLS 工作区。

1.  在左侧菜单中点击 **计算**。

1.  点击 **新建**。

将打开一个新标签页以配置我们的计算实例。以下截图展示了计算实例的创建：

![图 1.28 – 选择虚拟机类型和区域](img/B18003_01_028.jpg)

图 1.28 – 选择虚拟机类型和区域

在 **配置所需设置** 下，如 *图 1**.28* 所示，让我们执行以下步骤：

1.  您需要为您的计算实例提供一个名称。让我们将其命名为 `amldevinstance`。请注意，计算实例的名称在给定的 Azure 区域中必须是唯一的。鉴于此名称可能已被使用，实际上，您可以在计算名称前或后添加前缀或后缀以确保其唯一性。

1.  将 **虚拟机类型** 设置为 **CPU**。对于高性能深度学习模型，也可以选择 **GPU**。现在，设置 **虚拟机大小**。大小分配将显示基于可用配额的节点。

1.  从可用的 CPU 列表中选择一个虚拟机大小。

1.  点击 **下一步**：**高级设置**。

1.  如果您想从远程机器使用计算实例，请开启 **启用 SSH 访问**。**启用虚拟网络** 选项可用于连接到连接到企业网络的私有网络。还有一个将计算分配给其他用户的选项（**分配给其他用户**）。如果启动时需要配置任何 shell 脚本，请使用 **使用设置** **脚本** 选项：

![图 1.29 – 配置设置](img/B18003_01_029.jpg)

图 1.29 – 配置设置

现在我们已经为计算提供了基本配置，我们可以转到下一节，关于安排关机时间以节省金钱。

## 为计算实例添加计划

在 AML 服务的上一个版本中，数据科学家必须手动启动和关闭计算实例。不出所料，这导致用户在周末和假期忘记关闭它们时产生了大量账单。为了解决这个问题，Microsoft 添加了自动启动和关闭计算实例的功能。我们建议将关机计划设置在正常工作时间结束后。

从 *图 1**.29* 中，点击 **添加计划** 按钮以启用设置启动或关机自动计划的功能。

这是计算实例的 **启动和关机计划** 窗口：

![图 1.30 – 为计算实例安排关机时间](img/B18003_01_030.jpg)

图 1.30 – 为计算实例安排关机时间

如 *图 1**.30* 所示，为计算实例设置自动关机时间可以节省成本。一旦设置，系统将自动关机以节省金钱。

设置好您的计划后，点击**创建**并等待实例创建。一旦实例创建完成，它将自动启动，并显示计算实例页面。

## 通过 Azure CLI 创建计算实例

使用代码创建计算实例的一个主要优点是能够保存您的配置文件以供以后使用。

根据您的操作系统启动您的命令行解释器（例如，CMD 或 Windows PS），将 Azure CLI 连接到您的 Azure 订阅，并运行以下命令以创建计算实例，注意计算实例的名称必须在 Azure 区域内是唯一的：

[PRE10]

正如您通过 Azure CLI 创建 AMLS 工作空间一样，您现在已经使用它创建了一个计算实例。下一节将介绍如何使用 ARM 模板创建计算实例的详细信息。

## 使用 ARM 模板创建计算实例

使用 ARM 模板创建你的 AMLS 工作空间后，你还可以同时实例化计算实例，指定其类型、大小和计划。这对于想要严格控制计算实例配置的大型组织来说是一个极好的策略。这也非常适合希望一步创建多个计算实例的团队。为了做到这一点，请按照以下步骤操作：

1.  ARM 模板可以从 GitHub 下载，位于此处：[https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-compute-create-computeinstance/azuredeploy.json](https://github.com/Azure/azure-quickstart-templates/blob/master/quickstarts/microsoft.machinelearningservices/machine-learning-compute-create-computeinstance/azuredeploy.json)。

模板为您创建计算实例。

示例模板有三个必需的参数：

+   `workspaceName`，这是部署位置。

+   `computeName`，这是要创建的计算实例的名称。

+   `objectId`，这是分配计算实例的人的对象ID。在您的案例中，它将为您自己。

要获取您的对象ID，您可以运行以下命令：

[PRE11]

1.  为了部署您的模板，您必须将其部署到一个已经存在于资源组中的工作空间中。确保用您使用 `az ad signed-in-user show` 命令找到的对象ID替换 `objectId`。确保您的命令提示符位于您下载 `azuredeploy.json` 文件的位置，并运行以下命令：

    [PRE12]

小贴士

为了创建除自己之外的用户计算实例，请使用**代表创建**选项并指定用户ID。

现在您已经知道如何使用图形用户界面、Azure CLI 和 ARM 模板创建计算实例。您还知道如何为您的计算实例安排启动和关闭时间，并准备好使用它来开发代码，这将是下一节的重点。

# 在 AMLS 中开发

在您的计算实例虚拟机创建完成后，您可以使用它用R或Python编写代码。具体来说，您可以在**Jupyter**、**JupyterLab**、**Visual Studio Code**（**VSCode**）或终端中编写代码。Jupyter和JupyterLab都是编写Python代码的IDE示例。VS Code是微软推荐的IDE，它允许您使用多种语言（包括R和Python）进行脚本编写。

在本节中，您将首先打开一个Jupyter笔记本，并使用它连接到您的AMLS工作区。同样，您将使用JupyterLab做同样的事情。最后，您将学习如何使用AML笔记本来开发代码。

## 使用Jupyter Notebook开发Python代码

可能是数据科学家在AMLS中编写代码最常见的方式是通过最常用的**Python IDE** Jupyter Notebook。然而，Jupyter Notebook确实存在许多限制；它缺少了传统IDE中最基本的功能，例如**代码检查**和代码分析，以在您尝试运行代码之前标记错误。尽管如此，许多数据科学家仍然更喜欢它，因为它具有简洁、易于使用的界面。为了打开Jupyter并创建笔记本，请按照以下步骤操作：

1.  前往AML工作区UI。

1.  在菜单的**管理**部分左侧导航菜单中点击**计算**。

以下截图显示了所有创建的计算实例列表：

![图1.31 – 计算实例列表](img/B18003_01_031.jpg)

图1.31 – 计算实例列表

1.  从列表中选择您的计算实例，然后点击**启动**（如果它尚未启动）。一旦计算实例启动，将出现一个指向**应用程序**的链接。

1.  点击**JupyterLab**或**Jupyter**链接以打开用于进一步开发的Jupyter笔记本。

1.  要访问左侧菜单中的AMLS工作区笔记本，请转到**笔记本**部分。

1.  在下一屏幕上，您应该在左侧窗格中看到文件夹。在AMLS工作区中的每个用户都会默认为他们创建一个文件夹。在您的用户文件夹内，您可以选择一个笔记本来工作。如图*图1.15*所示，还有创建文件夹和新笔记本的选项。

现在您已经知道如何在AMLS中使用Jupyter Notebook，我们将探讨如何利用AML笔记本。

## 使用AML笔记本进行开发

AML笔记本类似于Jupyter笔记本，为您提供了另一种开发代码的选项。您选择使用Jupyter、JupyterLab或AML笔记本在很大程度上是个人偏好的问题。请尝试所有三种，以确定哪一种最适合您。为了开始使用AML笔记本进行开发，请按照以下步骤操作：

1.  前往AMLS工作区UI。

1.  在左侧导航菜单的**作者**部分下点击**笔记本**。

1.  展开文件夹并选择您的笔记本或创建一个新的笔记本：

![图1.32 – 文件菜单选项](img/B18003_01_032.jpg)

图1.32 – 文件菜单选项

1.  点击**创建** **新文件**。

1.  将笔记本文件命名为 `amlbookchapter1.ipynb`。

1.  一旦您点击 **创建**，*图 1.33* 中的页面应该会弹出。前面的过程将为我们创建一个新的笔记本以开始开发：

![图 1.33 – 新笔记本](img/B18003_01_033.jpg)

图 1.33 – 新笔记本

在您的笔记本中，您将看到 IDE 默认为 **Python 3.10 - SDK V2** 环境。每个单元格都将允许您在运行的计算实例上执行代码。

在 AMLS 中开发代码主要有两种方式：Jupyter 和 AML 笔记本。然而，存在一个功能更强大的 IDE，它包含许多提高您生产力的功能——VS Code。在下一节中，您将下载 VS Code 并将其连接到 AMLS。

# 将 AMLS 连接到 VS Code

VS Code 是一个旨在与 Windows、macOS 或 Linux 一起工作的 IDE。它的 Git 集成和调试功能使其成为代码编辑器的自然选择。VS Code 有一个扩展，可以直接与您的 AMLS 环境一起使用以构建、训练和部署 ML 模型。为了利用这个强大的工具，请按照以下步骤安装和配置 VS Code：

1.  在 [https://code.visualstudio.com/download](https://code.visualstudio.com/download) 下载并安装 VS Code。

1.  在 VS Code 内部，点击如 *图 1.34* 所示的 `Azure Machine Learning`，并选择 **安装**：

![图 1.34 – 选择 VS Code 扩展](img/B18003_01_034.jpg)

图 1.34 – 选择 VS Code 扩展

1.  登录您的 Azure 账户（*Ctrl + Shift + p*），并输入以下内容：

    [PRE13]

将为您打开一个新的浏览器窗口，以便您提供凭证以启用登录。

1.  通过使用命令面板设置默认 workspace。为了设置您的默认 AMLS workspace，您需要打开一个文件夹，这样 VS Code 可以在其中存储元数据。这可以通过从菜单中选择 **文件** 并选择 **打开文件夹** 来完成。

1.  通过使用命令面板（*Ctrl + Shift + p*）并输入 `Azure ML: Set Default Workspace` 来选择您的默认工作区。此命令将引导您选择您的订阅和您的 workspace：

    [PRE14]

1.  前往 Azure 图标（*Shift + Alt + A*），并如 *图 1.35* 所示进入 **机器学习** 部分：

![图 1.35 – Azure 图标](img/B18003_01_035.jpg)

图 1.35 – Azure 图标

1.  在 Azure 图标的 **机器学习** 部分中，如 *图 1.36* 所示，右键单击并选择为我们的计算实例 **连接**：

![图 1.36 – 连接到计算实例](img/B18003_01_036.jpg)

图 1.36 – 连接到计算实例

1.  VS Code 扩展将被安装到您连接的计算实例上，您将被要求确认您信任父文件夹中所有文件的作者。选择 **是的，我信任** **作者**。

1.  这将在您的本地机器上打开一个新的 VS Code 实例。在这个新的 VS Code 实例中，您将看到在 *使用 AML 笔记本开发* 部分之前创建的用户目录和笔记本，如 *图 1.37* 所示：

![图1.37 – 在VS Code中打开笔记本](img/B18003_01_037.jpg)

图1.37 – 在VS Code中打开笔记本

1.  通过点击`azureml_py310_sdkv2`内核在右上角选择您的Python解释器：

![图1.38 – 选择内核](img/B18003_01_038.jpg)

图1.38 – 选择内核

1.  选择解释器后，您可以在*图1.39*中创建一个`print`语句：

![图1.39 – 编写代码](img/B18003_01_039.jpg)

图1.39 – 编写代码

1.  要执行此代码，请按左侧单元格的播放按钮（*Ctrl + Enter*）。请注意，提供的Python代码将打印出当前工作目录。您的代码将在显示的目录路径所示的计算实例上执行。

在VS Code中保存笔记本将保存笔记本到您的AMLS工作区。

在本节中，您已安装VS Code、AML VS Code扩展，并在您的AMLS工作区中连接到您的计算实例以运行您的代码。VS Code提供了IntelliSense、运行和调试您的代码的能力，以及内置的Git集成。将这些功能与AMLS工作区集成相结合，使其成为开发的首选选择。

# 摘要

在本章中，您已探讨了创建AMLS工作区的选项，如何在AMLS中导航，如何创建用于开发代码的计算实例，以及如何使用您的计算实例来开发代码。您通过Azure门户、通过CLI以及通过ARM模板深入了解了创建AMLS工作区。您已导航到AMLS工作区组件，探索了AMLS的**作者**、**资产**和**管理**部分。您已探索了各种IDE，包括Jupyter、AML笔记本以及VS Code，这是Microsoft的旗舰IDE，您创建的计算实例是通过门户、CLI或ARM模板实现的。这个基础为您提供了开始编写ML解决方案所需的一切。

在下一章中，您将导入数据到AMLS并连接到各种数据源。您还将学习如何自动跟踪数据的变化，并在必要时回滚到早期版本。
