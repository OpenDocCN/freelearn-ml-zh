<html><head></head><body>
		<div id="_idContainer183">
			<h1 id="_idParaDest-172"><em class="italic"><a id="_idTextAnchor174"/>Chapter 12</em>: Using BigQuery ML with AI Notebooks</h1>
			<p>For data scientists and machine learning engineers, notebooks are a fundamental productivity tool. Notebooks allow us to interact with computing resources because we can use them to write and execute code, visualize the results, and share the outcomes with other data scientists. Data engineers, data scientists, and machine learning engineers make experiments and explore data before deploying code into the production environment. They leverage notebooks because they offer a flexible and agile environment to develop and test in.</p>
			<p>In this chapter, we'll learn what <strong class="bold">AI Platform Notebooks</strong> is, how to provision a notebook environment, and how to use it to develop a BigQuery ML model.</p>
			<p>We'll start by discovering the basics of notebooks and then start getting some hands-on practice with <strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>).  </p>
			<p>In this chapter, we'll cover the following topics:</p>
			<ul>
				<li>Discovering AI Platform Notebooks</li>
				<li>Implementing BigQuery ML models within notebooks </li>
			</ul>
			<h1 id="_idParaDest-173"><a id="_idTextAnchor175"/>Technical requirements</h1>
			<p>This chapter requires that you have access to a web browser and can leverage the following:</p>
			<ul>
				<li>A GCP account to access the Google Cloud Console</li>
				<li>A GCP project to host BigQuery datasets</li>
			</ul>
			<p>Now that we know about the technical requirements for this chapter, let's learn how to develop a machine learning model using AI Platform Notebooks.</p>
			<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/2QVZ1oY">https://bit.ly/2QVZ1oY</a></p>
			<h1 id="_idParaDest-174"><a id="_idTextAnchor176"/>Discovering AI Platform Notebooks</h1>
			<p>In<a id="_idIndexMarker549"/> this section, we'll learn what <strong class="bold">AI Platform Notebooks</strong> is and the advantages that it can provide.</p>
			<p><strong class="bold">AI Platform Notebooks</strong> is a fully managed service that allows data engineers and data scientists to use a JupyterLab development environment. This service allows us to develop, evaluate, test, and deploy machine learning models.</p>
			<p><strong class="bold">JupyterLab</strong> is a <a id="_idIndexMarker550"/>web tool for data scientists that is developed and maintained by Project Jupyter (<a href="https://jupyter.org/about">https://jupyter.org/about</a>). The goal of the project is to develop open source software and standards that offer a unique interface across different programming languages.</p>
			<p>Using AI Platform <a id="_idIndexMarker551"/>Notebooks with JupyterLab can bring several advantages:</p>
			<ul>
				<li>We can easily set up our pre-configured machine learning environments with the most important and useful ML libraries, such as TensorFlow, Keras, PyTorch, and others.</li>
				<li>We can leverage the scalability of the cloud by increasing the size of the hardware resources according to our requirements. For example, we can improve the performance of<a id="_idIndexMarker552"/> our notebook by scaling up the RAM or adding <strong class="bold">Graphics Processing Units</strong> (<strong class="bold">GPUs</strong>).</li>
				<li>We are allowed to access the other Google Cloud services from our notebook without the need to perform any additional configuration. From AI Platform Notebooks, we can easily leverage BigQuery, Dataflow, and Dataproc.</li>
				<li>We can integrate our development environment with code versioning applications such as Git.</li>
				<li>We can easily share our notebooks with colleagues or friends, thus making collaboration faster and increasing productivity.<p>In the following screenshot, you can see the web interface of a JupyterLab notebook:</p></li>
			</ul>
			<div>
				<div id="_idContainer166" class="IMG---Figure">
					<img src="image/B16722_12_001.jpg" alt="Figure 12.1 –JupyterLab's web interface&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.1 –JupyterLab's web interface</p>
			<p>A <a id="_idIndexMarker553"/>notebook can contain descriptive content, code blocks, and results. It is composed of a sequence of cells that can be executed. There are two types of cells:</p>
			<ul>
				<li><strong class="bold">Code cells</strong>: Contain<a id="_idIndexMarker554"/> executable code to run. The result of their execution is visualized immediately after the code.</li>
				<li><strong class="bold">Markdown cells</strong>: Contain<a id="_idIndexMarker555"/> HTML code to produce headers, lists, and formatted text. These cells are usually used to describe the code and make the entire notebook readable and easy to understand.</li>
			</ul>
			<p>Let's move on to the next section!</p>
			<h2 id="_idParaDest-175"><a id="_idTextAnchor177"/>AI Platform Notebooks pricing</h2>
			<p>In this<a id="_idIndexMarker556"/> section, you'll understand how the price of AI Notebooks is calculated and billed to your Google Cloud account.</p>
			<p>Since the JupyterLab software is open source, when you use AI Platform Notebooks, you're only charged for the Google Cloud resources that you consume.</p>
			<p>To start <a id="_idIndexMarker557"/>using AI Platform Notebooks, you'll have to pay for the following:</p>
			<ul>
				<li><strong class="bold">Google Compute Engine</strong> (<strong class="bold">GCE</strong>), the<a id="_idIndexMarker558"/> virtual machine that's used to deploy your development environment. GCE is charged according to the provisioned number of virtual CPUs, memory, and disk that you have.</li>
				<li>Any<a id="_idIndexMarker559"/> other service that can be invoked from the notebook, such as BigQuery.<p class="callout-heading">Tip</p><p class="callout">Remember to turn off the GCE that hosts your AI Platform Notebook when you are not using it. If the virtual machine is left active, you will continue to pay for those resources, even if you are not actually using them.</p></li>
			</ul>
			<p>Now that we've learned what AI Platform Notebooks is and why it can be useful when you're developing a machine learning model, in the next section, we'll understand how to configure our first notebook. </p>
			<h2 id="_idParaDest-176"><a id="_idTextAnchor178"/>Configuring the first notebook</h2>
			<p>In this <a id="_idIndexMarker560"/>section, we'll set up our first AI Platform notebook, which will be used to train, evaluate, and test the BigQuery ML model.</p>
			<p>After logging into the GCP console, we can start configuring our first notebook. Let's get started:</p>
			<ol>
				<li>First, let's browse the console's navigation menu until we find the <strong class="bold">AI Platform (Unified)</strong> item. From the submenu, select <strong class="bold">Notebooks</strong>:<div id="_idContainer167" class="IMG---Figure"><img src="image/B16722_12_002.jpg" alt="Figure 12.2 – AI Platform Notebooks in the console's menu&#13;&#10;"/></div><p class="figure-caption">Figure 12.2 – AI Platform Notebooks in the console's menu</p></li>
				<li>If this is<a id="_idIndexMarker561"/> the first time that we're accessing this service, we will be asked to enable the API. We can click the blue <strong class="bold">ENABLE</strong> button to start using the service:<div id="_idContainer168" class="IMG---Figure"><img src="image/B16722_12_003.jpg" alt="Figure 12.3 – Enabling the Notebooks API&#13;&#10;"/></div><p class="figure-caption">Figure 12.3 – Enabling the Notebooks API</p></li>
				<li>After a <a id="_idIndexMarker562"/>few minutes, the service will be enabled and ready to use. We'll be redirected to a web page containing the statistics of the API that we've just enabled:<div id="_idContainer169" class="IMG---Figure"><img src="image/B16722_12_004.jpg" alt="Figure 12.4 – The statistics of the Notebooks API&#13;&#10;"/></div><p class="figure-caption">Figure 12.4 – The statistics of the Notebooks API</p></li>
				<li>Selecting the <strong class="bold">Notebooks</strong> item from the console's navigation menu once more, we'll access the page dedicated to AI Platform Notebooks. By selecting the blue <strong class="bold">CREATE INSTANCE</strong> button, we'll start configuring the notebook:<div id="_idContainer170" class="IMG---Figure"><img src="image/B16722_12_005.jpg" alt="Figure 12.5 – Creating new instances&#13;&#10;"/></div><p class="figure-caption">Figure 12.5 – Creating new instances</p></li>
				<li>To create<a id="_idIndexMarker563"/> a notebook instance, we need to choose an <strong class="bold">Instance name</strong>, <strong class="bold">Region</strong>, and <strong class="bold">Zone</strong> that we want to use. We also need to choose an <strong class="bold">Operating System</strong> and <strong class="bold">Environment</strong>:<div id="_idContainer171" class="IMG---Figure"><img src="image/B16722_12_006.jpg" alt="Figure 12.6 – The available options for creating a notebook instance&#13;&#10;"/></div><p class="figure-caption">Figure 12.6 – The available options for creating a notebook instance</p><p>For our<a id="_idIndexMarker564"/> use case, we will set <strong class="source-inline">bigqueryml-packt-notebook</strong> for <strong class="bold">Instance name</strong>, <strong class="bold">us-west1</strong> for <strong class="bold">Region</strong>, <strong class="bold">use-west1-a</strong> for <strong class="bold">Zone</strong>, <strong class="bold">Debian 10</strong> for <strong class="bold">Operating System</strong>, and <strong class="bold">Python 3 (with Intel MKL)</strong> for <strong class="bold">Environment</strong>.</p></li>
				<li>Scrolling down the configuration page, select <strong class="bold">n1-standard-2</strong> for <strong class="bold">Machine type</strong>. After that, we can start creating the instance by clicking the blue <strong class="bold">CREATE</strong> button:<div id="_idContainer172" class="IMG---Figure"><img src="image/B16722_12_007.jpg" alt="Figure 12.7 – Additional options for creating a notebook instance&#13;&#10;"/></div><p class="figure-caption">Figure 12.7 – Additional options for creating a notebook instance</p></li>
				<li>After a<a id="_idIndexMarker565"/> few minutes, the notebook instance will be ready to use. Upon selecting <strong class="bold">OPEN JUPYTERLAB</strong>, the JupyterLab notebook will open a new window containing the development environment:<div id="_idContainer173" class="IMG---Figure"><img src="image/B16722_12_008.jpg" alt="Figure 12.8 – The list of notebook instances available in the GCP project&#13;&#10;"/></div><p class="figure-caption">Figure 12.8 – The list of notebook instances available in the GCP project</p></li>
				<li>In the <a id="_idIndexMarker566"/>web interface of the JupyterLab notebook, we can initialize the first notebook file by selecting <strong class="bold">Python 3</strong> as the notebook type:<div id="_idContainer174" class="IMG---Figure"><img src="image/B16722_12_009.jpg" alt="Figure 12.9 – Selecting the runtime engine to use in the notebook&#13;&#10;"/></div><p class="figure-caption">Figure 12.9 – Selecting the runtime engine to use in the notebook</p></li>
				<li>Upon <a id="_idIndexMarker567"/>making this selection, a new notebook file will be created and ready for us to develop our BigQuery ML machine learning model:</li>
			</ol>
			<div>
				<div id="_idContainer175" class="IMG---Figure">
					<img src="image/B16722_12_010.jpg" alt="Figure 12.10 – When the notebook is initialized, an empty file is displayed&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.10 – When the notebook is initialized, an empty file is displayed</p>
			<p>In this section, we <a id="_idIndexMarker568"/>configured our first AI Platform notebook. In the next section, we'll use it to execute some code blocks in order to create, evaluate, and test a BigQuery ML machine learning model.</p>
			<h1 id="_idParaDest-177"><a id="_idTextAnchor179"/>Implementing BigQuery ML models within notebooks</h1>
			<p>In<a id="_idIndexMarker569"/> this section, we'll leverage <a id="_idIndexMarker570"/>the notebook instance that we configured in the <em class="italic">Configuring the first notebook</em> section to run BigQuery SQL statements and develop the BigQuery ML machine learning model.</p>
			<p>To learn how a notebook can be used, we'll reuse some of the code blocks that we built in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>. It's important to remember that the goal of the use case was to predict the rental time of each ride for the New York City bike sharing service. To achieve this goal, we've trained a simple linear regression machine learning model. In this section, we'll use the same technique; that is, we'll be embedding the code into an AI Platform notebook.</p>
			<h2 id="_idParaDest-178"><a id="_idTextAnchor180"/>Compiling the AI notebook</h2>
			<p>In <a id="_idIndexMarker571"/>this section, we'll compile the notebook using <strong class="bold">Code</strong> cells to embed the SQL queries and <strong class="bold">Markdown</strong> cells to create titles and descriptions. Let's start compiling our notebook by performing the following steps:</p>
			<ol>
				<li value="1">First, let's create a title for our notebook. From the cell type drop-down menu, we can select <strong class="bold">Markdown</strong> and insert the following code block into the first cell of the notebook:<p class="source-code"># NYC Bike Sharing Linear Regression</p><p>In the following screenshot, you can see how the first cell is configured:</p><div id="_idContainer176" class="IMG---Figure"><img src="image/B16722_12_011.jpg" alt="Figure 12.11 – An example of a Markdown cell&#13;&#10;"/></div><p class="figure-caption">Figure 12.11 – An example of a Markdown cell</p><p>The <strong class="bold">#</strong> character preceding the text is used to identify a title at the first level.</p></li>
				<li>By clicking on the <strong class="bold">+</strong> button in the notebook menu, you'll add a new cell. Let's select <strong class="bold">Markdown</strong> as the cell type and insert the following text, which describes the notebook:<p class="source-code">The following steps will show you how to train, evaluate and test a linear regression model using BigQuery ML.</p></li>
				<li>To check whether we've written the previous steps properly, we can use the Run button in the notebook menu. We can run each cell to visualize the result:<div id="_idContainer177" class="IMG---Figure"><img src="image/B16722_12_012.jpg" alt="Figure 12.12 – The Run button in the notebook menu&#13;&#10;"/></div><p class="figure-caption">Figure 12.12 – The Run button in the notebook menu</p><p>In the <a id="_idIndexMarker572"/>following screenshot, you can see the outcome of executing the first two steps, which contain the title and a short description:</p><div id="_idContainer178" class="IMG---Figure"><img src="image/B16722_12_013.jpg" alt="Figure 12.13 – The result of executing the first few cells&#13;&#10;"/></div><p class="figure-caption">Figure 12.13 – The result of executing the first few cells</p></li>
				<li>Let's add a subtitle to start the data preparation section of the model. We'll add another <strong class="bold">Markdown</strong> cell by inserting the following title:<p class="source-code">## Data preparation</p><p>The double <strong class="source-inline">##</strong> character preceding the text is used to identify a title of the second level. It can be considered a subtitle of the title we wrote in <em class="italic">Step 1</em>.</p></li>
				<li>Now, we're ready to create the <strong class="source-inline">12_notebook</strong> BigQuery dataset, which will be used to host our BigQuery ML models. Let's create a <strong class="bold">Code</strong> cell with the following Python code:<p class="source-code">from google.cloud import bigquery</p><p class="source-code"># Construct a BigQuery client object.</p><p class="source-code">client = bigquery.Client()</p><p class="source-code">dataset_id = "{}.12_notebook".format(client.project)</p><p class="source-code"># Construct a full Dataset object to send to the API.</p><p class="source-code">dataset = bigquery.Dataset(dataset_id)</p><p class="source-code"># Geographic location where the dataset should reside.</p><p class="source-code">dataset.location = "US"</p><p class="source-code"># Dataset creation</p><p class="source-code">dataset = client.create_dataset(dataset, timeout=30)  </p><p class="source-code">print("Created dataset {}.{}".format(client.project, dataset.dataset_id))</p><p>The <a id="_idIndexMarker573"/>preceding code creates the <strong class="source-inline">12_notebook</strong> dataset in <strong class="source-inline">US</strong> within the current GCP project. At the end of the cell, the <strong class="source-inline">print</strong> command is used to present a confirmation message, stating that the dataset has been created successfully.</p></li>
				<li>Now, we can add a new <strong class="bold">Code</strong> cell and write the following SQL statement to create the <strong class="source-inline">`12_notebook.training_table`</strong> table:<p class="source-code">%%bigquery</p><p class="source-code">### Creation of the training table ###</p><p class="source-code">CREATE OR REPLACE TABLE `12_notebook.training_table` AS</p><p class="source-code">              SELECT </p><p class="source-code">                    tripduration/60 tripduration,</p><p class="source-code">                    starttime,</p><p class="source-code">                    stoptime,</p><p class="source-code">                    start_station_id,</p><p class="source-code">                    start_station_name,</p><p class="source-code">                    start_station_latitude,</p><p class="source-code">                    start_station_longitude,</p><p class="source-code">                    end_station_id,</p><p class="source-code">                    end_station_name,</p><p class="source-code">                    end_station_latitude,</p><p class="source-code">                    end_station_longitude,</p><p class="source-code">                    bikeid,</p><p class="source-code">                    usertype,</p><p class="source-code">                    birth_year,</p><p class="source-code">                    gender,</p><p class="source-code">                    customer_plan</p><p class="source-code">              FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE </p><p class="source-code">                    (</p><p class="source-code">                        (EXTRACT (YEAR FROM starttime)=2017 AND</p><p class="source-code">                          (EXTRACT (MONTH FROM starttime)&gt;=04 OR EXTRACT (MONTH FROM starttime)&lt;=10))</p><p class="source-code">                        OR (EXTRACT (YEAR FROM starttime)=2018 AND</p><p class="source-code">                          (EXTRACT (MONTH FROM starttime)&gt;=01 OR EXTRACT (MONTH FROM starttime)&lt;=02))</p><p class="source-code">                    )</p><p class="source-code">                    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007;</p><p>The <strong class="source-inline">%%bigquery</strong> keyword allows us to include code blocks that contain SQL queries. The SQL statement will be run directly on BigQuery through the native integration of the AI Platform notebook and the analytical database.</p><p>The business logic to create the table is the same as what we used to create the <strong class="source-inline">`04_nyc_bike_sharing.training_table`</strong> table in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>.</p></li>
				<li>Now, let's<a id="_idIndexMarker574"/> include an additional <strong class="bold">Code</strong> cell in the notebook to create the evaluation table, as follows:<p class="source-code">%%bigquery</p><p class="source-code">### Creation of the evaluation table ###</p><p class="source-code">CREATE OR REPLACE TABLE  `12_notebook.evaluation_table` AS</p><p class="source-code">SELECT </p><p class="source-code">                    tripduration/60 tripduration,</p><p class="source-code">                    starttime,</p><p class="source-code">                    stoptime,</p><p class="source-code">                    start_station_id,</p><p class="source-code">                    start_station_name,</p><p class="source-code">                    start_station_latitude,</p><p class="source-code">                    start_station_longitude,</p><p class="source-code">                    end_station_id,</p><p class="source-code">                    end_station_name,</p><p class="source-code">                    end_station_latitude,</p><p class="source-code">                    end_station_longitude,</p><p class="source-code">                    bikeid,</p><p class="source-code">                    usertype,</p><p class="source-code">                    birth_year,</p><p class="source-code">                    gender,</p><p class="source-code">                    customer_plan</p><p class="source-code">                FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">                WHERE </p><p class="source-code">                    (EXTRACT (YEAR FROM starttime)=2018 AND (EXTRACT (MONTH FROM starttime)=03 OR EXTRACT (MONTH FROM starttime)=04))</p><p class="source-code">                    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007;</p><p>The business logic to create the table is the same as what we used to create the <strong class="source-inline">`04_nyc_bike_sharing.evaluation_table`</strong> table in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>.</p></li>
				<li>Finally, let's <a id="_idIndexMarker575"/>add another <strong class="bold">Code</strong> cell to create the prediction table with the following SQL statement:<p class="source-code">%%bigquery</p><p class="source-code">### Creation of the prediction table ###</p><p class="source-code">CREATE OR REPLACE TABLE  `12_notebook.prediction_table` AS</p><p class="source-code">              SELECT </p><p class="source-code">                   tripduration/60 tripduration,</p><p class="source-code">                    starttime,</p><p class="source-code">                    stoptime,</p><p class="source-code">                    start_station_id,</p><p class="source-code">                    start_station_name,</p><p class="source-code">                    start_station_latitude,</p><p class="source-code">                    start_station_longitude,</p><p class="source-code">                    end_station_id,</p><p class="source-code">                    end_station_name,</p><p class="source-code">                    end_station_latitude,</p><p class="source-code">                    end_station_longitude,</p><p class="source-code">                    bikeid,</p><p class="source-code">                    usertype,</p><p class="source-code">                    birth_year,</p><p class="source-code">                    gender,</p><p class="source-code">                    customer_plan</p><p class="source-code">                FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE </p><p class="source-code">                    EXTRACT (YEAR FROM starttime)=2018</p><p class="source-code">                    AND EXTRACT (MONTH FROM starttime)=05</p><p class="source-code">                     AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007;</p><p>The <a id="_idIndexMarker576"/>business logic to create the table is the same as what we used to create the <strong class="source-inline">`04_nyc_bike_sharing.prediction_table`</strong> table in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>.</p></li>
				<li>Let's add a subtitle to start the training section of the model. We'll add a <strong class="bold">Markdown</strong> cell by inserting the following title:<p class="source-code">## Training the linear regression</p></li>
				<li>Now, we're ready to write the BigQuery ML query that will train our machine learning model from the notebook. Let's add a new <strong class="bold">Code</strong> cell by including the following SQL statement:<p class="source-code">%%bigquery</p><p class="source-code">CREATE OR REPLACE MODEL `12_notebook.trip_duration_notebook`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='linear_reg') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">  IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">  EXTRACT(YEAR FROM starttime)-birth_year as age,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `12_notebook.training_table`;</p><p>The<a id="_idIndexMarker577"/> BigQuery ML code that we used to create the <strong class="source-inline">`12_notebook.trip_duration_notebook`</strong> machine learning model contains the same business logic that we used in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>, to train the <strong class="source-inline">`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</strong> model.</p></li>
				<li>Let's add a subtitle to start the training section of the model. We'll add a <strong class="bold">Markdown</strong> cell by inserting the following title:<p class="source-code">## Evaluating the linear regression</p></li>
				<li>Now, we're ready to write the BigQuery ML query that will evaluate the machine learning model. Let's add a new <strong class="bold">Code</strong> cell by including the following SQL statement:<p class="source-code">%%bigquery</p><p class="source-code">SELECT</p><p class="source-code">  *</p><p class="source-code">FROM</p><p class="source-code">  ML.EVALUATE(MODEL `12_notebook.linear_regression_notebook`,</p><p class="source-code">    (</p><p class="source-code">    SELECT</p><p class="source-code">          start_station_name,</p><p class="source-code">          end_station_name,</p><p class="source-code">          IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">           tripduration as label</p><p class="source-code">    FROM</p><p class="source-code">           `12_notebook.evaluation_table`));</p><p>The <a id="_idIndexMarker578"/>code block that we used to evaluate the <strong class="source-inline">`12_notebook.trip_duration_notebook`</strong> machine learning model contains the same business logic that we used in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>, to evaluate the <strong class="source-inline">`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</strong> model.</p></li>
				<li>Let's add a subtitle to start the prediction section of the model. We'll add a <strong class="bold">Markdown</strong> cell by inserting the following title:<p class="source-code">## Testing the linear regression</p></li>
				<li>Now, we can include the BigQuery ML query that we'll use for our ML model. Let's add a new <strong class="bold">Code</strong> cell by including the following SQL statement:<p class="source-code">%%bigquery</p><p class="source-code">SELECT</p><p class="source-code">   tripduration as actual_duration,</p><p class="source-code">   predicted_label as predicted_duration,</p><p class="source-code">   ABS(tripduration - predicted_label) difference_in_min</p><p class="source-code">FROM</p><p class="source-code">  ML.PREDICT(MODEL `12_notebook.linear_regression_notebook`,</p><p class="source-code">    (</p><p class="source-code">    SELECT</p><p class="source-code">          start_station_name,</p><p class="source-code">          end_station_name,</p><p class="source-code">          IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">           tripduration</p><p class="source-code">    FROM</p><p class="source-code">           `12_notebook.prediction_table`</p><p class="source-code">    ))</p><p class="source-code">    order by  difference_in_min asc;</p><p>The <a id="_idIndexMarker579"/>code block that we used to test the <strong class="source-inline">`12_notebook.trip_duration_notebook`</strong> machine learning model contains the same business logic that we used in <a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic">Chapter 4</em></a>, <em class="italic">Predicting Numerical Values with Linear Regression</em>, to use the <strong class="source-inline">`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</strong> model.</p></li>
				<li>At the end of the compilation phase, we can save the notebook using the <strong class="bold">Save Notebook</strong> button in the main menu or by using the <strong class="bold">Save Notebook As…</strong> option.</li>
			</ol>
			<p>In this section, we compiled our notebook using code cells and Markdown cells. In the next section, we'll run the code that we've written in the notebook.</p>
			<h2 id="_idParaDest-179"><a id="_idTextAnchor181"/>Running the code in the AI notebook</h2>
			<p>In this<a id="_idIndexMarker580"/> section, we'll run the code that we wrote in the <em class="italic">Compiling the AI notebook</em> section. Let's<a id="_idIndexMarker581"/> start by taking a look at the notebook that we've prepared.</p>
			<p>In the following screenshot, we can visualize our AI notebook, which alternates between descriptive cells and code cells:</p>
			<div>
				<div id="_idContainer179" class="IMG---Figure">
					<img src="image/B16722_12_014.jpg" alt="Figure 12.14 – The entire notebook file compiled&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.14 – The entire notebook file compiled</p>
			<p>To run the entire notebook, we can simply open the <strong class="bold">Run</strong> menu at the top of the window and select <strong class="bold">Run All Cells</strong>, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer180" class="IMG---Figure">
					<img src="image/B16722_12_015.jpg" alt="Figure 12.15 – Running all the cells&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.15 – Running all the cells</p>
			<p>Upon <a id="_idIndexMarker582"/>selecting <strong class="bold">Run All Cells</strong>, all the cells in the AI Platform <a id="_idIndexMarker583"/>notebook will be executed sequentially.</p>
			<p>At the end of the evaluation step, the results of the <strong class="source-inline">ML.EVALUATE</strong> function will be shown in the <em class="italic">Evaluating the linear regression</em> section.</p>
			<p>The following screenshot shows the values returned by the evaluation stage:</p>
			<div>
				<div id="_idContainer181" class="IMG---Figure">
					<img src="image/B16722_12_016.jpg" alt="Figure 12.16 – The values returned by the evaluation function&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.16 – The values returned by the evaluation function</p>
			<p>At the end of the prediction step, the results of the <strong class="source-inline">ML.PREDICT</strong> function will be shown in the <strong class="source-inline">Testing the linear regression</strong> section.</p>
			<p>In the following <a id="_idIndexMarker584"/>screenshot, we <a id="_idIndexMarker585"/>can visualize the results presented at the end of the notebook:</p>
			<div>
				<div id="_idContainer182" class="IMG---Figure">
					<img src="image/B16722_12_017.jpg" alt="Figure 12.17 – The values returned by the PREDICT function&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.17 – The values returned by the PREDICT function</p>
			<p>As you can see, after executing the code block, the notebook presents the results of the predictions immediately after the SQL statement. This characteristic is particularly important if we wish to increase the readability and understanding of the BigQuery ML development steps.</p>
			<p>In this section, we learned how to compile an AI notebook and how to run all the cells that contain code blocks or titles and descriptions.</p>
			<h1 id="_idParaDest-180"><a id="_idTextAnchor182"/>Summary</h1>
			<p>In this chapter, we learned what AI notebooks are and why they can be useful in the development of a machine learning model, and we also understood the pricing model. We discovered the relationship between Google AI Platform Notebooks and the open source environment JupyterLab.</p>
			<p>First, we provisioned our first notebook instance using the Google Cloud Console web interface. Then, we used this new instance to develop a simple linear regression model, alternating code blocks and descriptive cells in the notebook file in the meantime.</p>
			<p>Finally, we executed all the steps in the notebook and visualized the results directly in its web interface.</p>
			<p>In the next chapter, we'll learn how to invoke TensorFlow models directly from BigQuery using BigQuery ML.</p>
			<h1 id="_idParaDest-181"><a id="_idTextAnchor183"/>Further resources</h1>
			<ul>
				<li><strong class="bold">NYC Bike Sharing public dataset</strong>: <a href="https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike ">https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike</a></li>
				<li><strong class="bold">BigQuery ML create model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create ">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create</a></li>
				<li><strong class="bold">BigQuery ML evaluate model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate ">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery ML PREDICT</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict ">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict</a></li>
				<li><strong class="bold">BigQuery ML linear regression example</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-natality">https://cloud.google.com/bigquery-ml/docs/bigqueryml-natality</a></li>
				<li><strong class="bold">Jupyter Notebooks best practices</strong>: <a href="https://cloud.google.com/blog/products/ai-machine-learning/best-practices-that-can-improve-the-life-of-any-developer-using-jupyter-notebooks">https://cloud.google.com/blog/products/ai-machine-learning/best-practices-that-can-improve-the-life-of-any-developer-using-jupyter-notebooks</a></li>
				<li><strong class="bold">Prototyping models in AI Platform</strong>: <a href="https://codelabs.developers.google.com/codelabs/prototyping-caip-notebooks/#0">https://codelabs.developers.google.com/codelabs/prototyping-caip-notebooks/#0</a></li>
			</ul>
		</div>
	</body></html>