# *第9章*：大规模车队管理

**物联网**（**IoT**）始于1999年，在宝洁公司，凯文·阿什顿提出了将**射频识别**（**RFID**）天线集成到口红货架上的想法，以便分支经理更好地跟踪化妆品库存以进行补充。从那时起，这项技术以某种形式被广泛应用于所有行业领域，并在当今世界变得无处不在。

在已知物理边界内管理一组RFID标签、传感器和执行器是一项相对简单的工作。然而，在全球范围内管理数百万（或数十亿或数万亿）这些设备在其整个生命周期内则不是。尤其是当这些设备分布在不同的地点，具有各种形式的连接和接口时。

因此，在本章中，您将了解远程上线、维护和诊断设备车队的最佳实践。此外，您将通过构建操作枢纽来获得实际经验，以评估连接车队的健康状况并采取必要的行动。

在本章中，我们将涵盖以下主题：

+   全球上线设备车队

+   大规模管理您的车队

+   建立操作枢纽的动手练习

+   检查你的知识

# 技术要求

本章的技术要求与[*第2章*](B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032)“边缘工作负载基础”中概述的要求相同。请参阅该章节中的完整要求。

# 全球上线设备车队

我们已经在[*第8章*](B17595_08_Final_SS_ePub.xhtml#_idTextAnchor163)，“边缘的DevOps和MLOps”中向您介绍了物联网制造供应链中涉及的不同活动。**上线**指的是制造、组装并将设备注册到注册机构的过程。在本节中，我们将深入了解以下在上线工作流程中发挥作用的活动：

![Figure 9.1 – 设备上线活动

![img/Table_09_01.jpg]

Figure 9.1 – 设备上线活动

到目前为止，在这本书中，您一直在使用**树莓派**（或虚拟环境）进行动手练习。这是开发和原型设计中的常见做法。然而，随着您的项目向更高环境（如QA或生产）发展，建议您考虑工业级硬件，并且能够在各种条件下运行。因此，*图9.1*中提到的所有上述活动都需要在您的设备（即连接的HBS枢纽）可以通过您的分销渠道在不同的零售店（并且像热蛋糕一样畅销！）提供之前完成。

在本章的剩余部分，我们假设你的公司已经定义了与首选供应商的供应链，并且设备制造工作流程已经运行，以便组装设备。当你的客户打开这些设备（充满兴奋！）并启动设置过程时，设备需要在本地（边缘）启动并成功注册到**AWS IoT**服务，以实现完全运行。

因此，你可能正在想，为了使设备注册成功，需要提前执行哪些必要步骤？下面就是。

## 注册证书颁发机构

存在着不同类型的*加密*凭证，例如用户ID、密码、销售令牌（如**JWT**和**OAuth**）以及对称或非对称密钥，这些密钥可以被物联网设备使用。我们建议使用非对称密钥，因为在撰写本文时，这些被认为是行业中最安全的做法。在所有之前的动手实践中，你利用了由AWS IoT**证书颁发机构**（**CA**）生成的**非对称X.509**密钥和证书，这些证书嵌入在运行Greengrass的连接HBS网关中。CA是一个受信任的实体，它颁发加密凭证，如数字密钥和证书。这些凭证在云上注册并嵌入到设备中，以启用传输层安全或基于TLS的相互认证。具体来说，与相互TLS认证工作流程相关联的数字资源有四个，如下所示：

+   **X.509证书**：这是一个需要在设备和云中都存在的证书，在相互TLS握手过程中被展示。

+   **私钥和公钥**：使用如**Rivest-Shamir-Adleman**（**RSA**）或**椭圆曲线加密**（**ECC**）算法生成的非对称密钥对。作为最佳实践，私钥仅保留在设备上，并且应该得到保护，以避免身份泄露。

+   **签名CA**：这是一个由受信任的CA（如AWS和Verisign）签发的根或中间证书。设备在注册过程中需要发送这个签发CA以及客户端证书。如果签名CA不可用，也可以发送TLS相互认证中的**服务器名称指示**（**SNI**）部分来验证信任。

+   **服务器证书**：这是一个由设备使用的证书，用于在TLS握手期间通过展示的证书链验证，它不是在与冒充服务器通信。

下面的图示显示了工作流程以及这些数字资源在设备和云中的位置：

![图9.2 – 物联网工作流程中的加密凭证

![图片](img/Figure_09_02.jpg)

图9.2 – 物联网工作流程中的加密凭证

因此，在设计过程中尽早决定CA至关重要。这样，它就可以颁发设备所需的上述数字资源，以便与后端权威机构进行注册并完全运行。CA可以以以下三种不同的方式与AWS IoT Core一起使用，如下表所示，并列出其优缺点：

![图9.3 – 选择CA

](img/B17595_09_03.jpg)

图9.3 – 选择CA

一旦完成CA设置，下一步就是根据场景选择设备供应方法。让我们在下一节中更详细地了解这一点。

## 决定供应方法

在物联网世界的许多情况下，术语“供应”和“注册”被交替使用，但我们认为它们之间存在明显的区别。对我们来说，设备供应是两种活动的结合——设备注册和设备激活。“设备注册”是指设备使用其初始加密凭证对注册机构（如AWS IoT身份服务）进行成功认证，报告独特的属性，如型号和序列号，并在设备注册表中关联为唯一的身份。此外，该机构可以返回一组新的凭证，设备可以用这些凭证替换之前的凭证。在此之后，权限提升器可以提高关联主体（如X.509证书）的权限，以便设备能够被激活并完全运行。

在这些供应步骤中存在不同的方法，这些方法通常源于组织希望在制造供应链中拥有的控制水平或便利性。通常，这种选择是由多个因素决定的，例如内部技能、成本、安全性、上市时间或对产品知识产权的敏感性。您在[*第二章*](B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032)“边缘工作负载基础”中学习了通过IoT设备测试器实现自动供应的方法，这种方法在原型设计和实验目的上非常普遍。

在本节中，我们将讨论两种可扩展到从一台设备到数百万台设备（或更多）的生产级供应方法，这些方法通过以下场景反向工作。

### 场景1 – 批量供应具有独特固件映像的HBS集线器

在此场景中，您可以使用包含独特加密凭证的独特固件映像，在您的供应链中批量供应HBS集线器群。

1.  作为HBS集线器的设备制造商，首先，您将使用支持的API将您选择的CA与AWS IoT Core关联起来。这个CA将管理信任链，并为整个设备群创建和验证加密凭证（如证书或证书签名请求）。

1.  然后，您将创建一个配置模板，本质上是一个配置文件，它包含了 AWS IoT 身份服务创建事物（或虚拟表示）的指令，用于 HBS 中心设备群的批量部署。这个模板将包括不同的输入参数，如 `ThingName`、`SerialNumber` 和 **证书签名请求**（**CSRs**），这将导致创建物联网资源，如虚拟事物、设备元数据、证书和政策。您可以参考官方 *AWS 上的物联网* 博客上显示的模板，标题为 *使用 AWS IoT 设备管理服务轻松部署设备群* ([https://aws.amazon.com/blogs/iot/deploy-fleets-easily-with-aws-iot-device-management-services/](https://aws.amazon.com/blogs/iot/deploy-fleets-easily-with-aws-iot-device-management-services/))。该模板可在 *创建配置模板* 部分找到。

1.  下一步是生成加密凭据，如私钥和 CSR，通过首选的工具链（如 **OpenSSL**）。在此之后，创建一个包含设备列表和加密凭据的输入文件，这些文件将被输入到配置模板中。这个输入文件在最简单的形式下可能看起来像这样：

    [PRE0]

1.  现在，是时候调用 API 来创建所有这些虚拟设备（即事物），在云端的物联网设备注册表中批量创建，以及相应的由 CA 签署的加密凭据（如证书或 CSR）。一旦这一步完成，就需要创建一个令牌交换角色，并将这些事物与 Greengrass 特定的结构相关联，例如 Greengrass 核心组件、事物组以及安装过程中所需的配置文件（`config.yaml`）。

1.  在此之后，您将注入之前步骤中生成的凭据，包括来自 *步骤 3* 的私钥和来自 *步骤 4* 的已签名证书，到您的固件中。这个更新的固件通常被称为金盘镜像，然后与您的组装团队（无论是内部团队还是合同制造商）共享。组装团队将把这个镜像闪存到制造工作流程中的设备部分：

![图 9.4 – 嵌入凭据的大规模配置

](img/Figure_09_04.jpg)

图 9.4 – 嵌入凭据的大规模配置

这种方法对于运行 RTOS 的微控制器来说相当常见，因为这些硬件（目前）不支持增量更新。然而，对于连接的 HBS 中心，将固件镜像与加密凭据解耦在操作上更为灵活和高效。

这就是第二个选项的用武之地。在这里，你仍然会像上一步一样从你的证书机构生成事物和唯一的凭证，但你不会将其注入到固件中。相反，你将开发一个智能固件，它可以接受通过不同接口（如 **安全壳** (**SSH**), **网络文件系统** (**NFS**), 或 **串行连接**)提供的凭证。作为最佳实践，通常还会将凭证存储在单独的芯片中，如安全元素或 **可信平台模块** (**TPM**)。此外，固件可以使用公钥加密标准接口（如 *PKCS#11*）实时检索固件或其他本地应用程序所需的密钥和证书。在撰写本书时，Greengrass v2 正在等待对 TPM 的支持，尽管它曾是 Greengrass v1 的支持功能：

![图 9.5 – 使用注入接口进行批量配置

](img/Figure_09_05.jpg)

图 9.5 – 使用注入接口进行批量配置

让我们看看如何进行第二个选项：

1.  一旦设备组装完成，包含必要的配置和凭证的金色镜像，产品将通过不同的分销渠道到达客户手中。当客户打开设备并首次唤醒时，引导过程开始。

1.  引导过程将实例化各种本地进程（或 *守护进程*），即固件指令。其中之一包括与 AWS IoT Identity 服务进行注册，设备将连接到云端点并交换 TLS 互信中嵌入的凭证部分。考虑到事物、证书和政策已经作为组装的先决条件创建，如果互信成功，设备将完全运行。

### 场景 2 – 具有共享声明的 HBS 中心在需要时进行配置

让我们考虑以下场景；你的设备在制造时可能没有接受唯一凭证的能力。或者，对于你的组织来说，在供应链中的每个 HBS 中心中嵌入唯一凭证的操作成本过高。这就是另一种模式出现的地方，被称为按声明的批量配置，其中，作为设备制造商，你可以在你的设备系列中嵌入一个非唯一的共享凭证（称为声明）。然而，我们建议你不要为整个设备系列共享相同的声明，而只共享其中的一部分，以减少任何安全问题的爆炸半径。请看以下步骤：

1.  作为第一步，合同制造商在设备上加载固件以及舰队配置插件和共享证书（即声明），而不进行任何定制。声明方法通过模板方法来配置所需的云资源，这种方法与之前的场景类似。您可以参考AWS文档中提供的示例模板，称为*为Greengrass核心设备设置AWS IoT舰队配置*（[https://docs.aws.amazon.com/greengrass/v2/developerguide/fleet-provisioning-setup.html#create-provisioning-template](https://docs.aws.amazon.com/greengrass/v2/developerguide/fleet-provisioning-setup.html#create-provisioning-template)）。主要区别在于，所有这些资源都是即时配置的，每个设备都从当前位置启动引导过程，而不是在制造设施中批量映像。

1.  此方法还支持预配置钩子功能，其中可以调用lambda函数来验证不同的参数或执行预配置逻辑。例如，它可以像覆盖参数一样简单，也可以更复杂，例如检查声明证书是否在撤销列表中：

    [PRE1]

    在这里，当网关首次唤醒并连接到AWS IoT时，声明证书被交换为永久性X.509证书，这些证书由CA（AWS或BYO）签名。这就是舰队配置插件发挥作用的地方，因为它允许设备发布和订阅所需的**MQ遥测传输**（**mqtt**）主题，接受唯一的凭据，并持久化存储在安全类型中：

    ![图9.6 – 使用共享声明的舰队配置

    ![图片](img/Figure_09_06.jpg)

    图9.6 – 使用共享声明的舰队配置

1.  在此之后，设备还必须断开与之前通过共享声明启动的会话，并使用唯一的凭据重新连接。

    警告

    如果共享声明没有通过供应链得到保护，声明方法配置的舰队配置会带来安全风险。

一旦设备已经配置，下一步就是组织它们，以简化其整个生命周期的管理。Greengrass核心设备可以被组织成事物组，这是在AWS IoT生态系统中组织设备群的结构。事物组可以是静态的或动态的。正如其名称所暗示的，静态组允许根据非变化的属性组织设备，例如产品类型、制造商、序列号、生产日期等。

此外，静态组允许构建具有父设备和子设备的设备层次结构，这些设备可以跨越多达七层。例如，查询属于公司XYZ的序列号范围内的洗衣机传感器的组，可以用来识别因生产缺陷需要召回的设备。

相比之下，动态组是通过索引信息创建的，例如连接状态、注册元数据或设备阴影。因此，动态组的成员总是变化的。这就是为什么动态组不与任何设备层次结构相关联的原因；例如，查询在某个时间点连接且固件版本为v1的HBS设备组。这个结果可以让车队运营商向相应的所有者推送固件更新通知。

使用物组的优势之一是能够在设备组级别分配车队权限（即策略），然后这些策略会级联到该层次结构中的所有设备。这简化了在每个设备级别管理策略的负担。同时，尽管如此，仍然可以拥有针对特定设备的策略，AWS IoT身份服务将在身份验证和授权工作流程中自动评估组与设备级别之间允许的最小权限访问级别。

现在您已经很好地了解了如何使用不同的方法配置和组织HBS集线器。接下来，让我们讨论一旦推出如何管理车队。

# 在规模上管理您的设备车队

虽然监控少量设备可能更容易，但管理规模化的设备车队可能会变成一个运营噩梦。为什么？好吧，这是因为物联网设备（如HBS集线器）不仅部署在受控的区域内（如数据中心）。正如您现在应该已经了解到的，这些设备可以部署在任何地方，例如家庭、办公室、商业地点，这些地方可能具有不同的电力消耗、网络连接和安全状态。例如，可能会有设备离线运行，无法通过公共或私人网络访问，因为该场所的Wi-Fi连接间歇性不可用。因此，作为一名物联网专业人士，您必须考虑各种场景，并提前规划如何规模化地管理您的车队。

在连接的HBS集线器背景下，设备管理可以帮助您实现以下目标：

+   从现实世界中捕获可操作的信息。

+   通过早期捕获异常来提高解决方案的效率。

+   通过预测性或预防性维护来优化成本。

+   防止知识产权被盗或未经授权的访问。

+   建立一个持续的反馈循环来提高客户体验。

+   通过更多数据洞察来生成额外的收入来源。

因此，如您所了解的，开发和推出物联网解决方案只是开始。为了实现之前提到的业务成果，有必要治理整个解决方案的生命周期。因此，设备管理也可以被视为以下活动的更大范畴：

+   配置

+   组织

+   监控

+   维护

+   诊断

下图显示了物联网设备管理的工作流程：

![图9.7 – 物联网设备管理流程

![图片](img/Figure_09_07.jpg)

图9.7 – 物联网设备管理流程

各种状态下的组件数量，例如以下内容：

## 监控

可以配置组件以指定不同的发布间隔（以秒为单位），因此指标可以带批处理或不带批处理发布。例如，对于lambda，默认的批处理窗口是10秒，最大等待时间可能是900秒。

+   （`$local/greengrass/telemetry`），您可以在核心设备上本地处理这些数据，即使与云端的连接是间歇性的。

+   可选地，该组件可以配置为将遥测数据发布到云端的*mqtt*主题。

+   任何自定义组件，如部署在核心设备上的lambda函数或容器，都可以将自定义指标发布到本地主题（`cloudwatch`/`metric`/`put`）。

+   如果遥测数据在本地发布，则没有费用，但将其推送到云端时则需收费。

+   *遥测代理*会原生前缀发布以下指标：

    +   此代理收集遥测数据，并通过**Amazon EventBridge**（一个无服务器事件总线服务）以尽力而为的方式将其发布到云端。

    +   一旦Greengrass核心设备启动并运行，数据就会开始流动。默认情况下，遥测代理每小时汇总遥测数据，每24小时将其发布到云端。

    +   由于消息发布到AWS IoT Core的保留主题，因此没有数据传输费用。

    +   系统内存和CPU利用率

    +   文件描述符的总数，其中每个描述符代表一个打开的文件

    +   **遥测代理**是您可以用来收集本地遥测数据的另一个选项，默认情况下对所有Greengrass核心设备启用：

        +   监控Greengrass启用的HBS中心节点及其相关设备对于实现可靠、高可用和性能良好的物联网工作负载至关重要。您应该有一种机制来收集边缘解决方案的监控数据，以便在发生故障时进行调试。Greengrass支持收集*系统健康遥测*和*自定义指标*，这些是用于监控Greengrass核心设备上不同组件和应用程序关键操作性能的诊断数据点。以下是可以收集这些数据的不同方式列表：

        +   运行、停止和完成

        +   错误的、损坏的和无状态的

    在后续的动手操作部分，您将收集这些指标并在云上进行处理。

    +   *CloudWatch指标*是Greengrass组件，允许您将自定义指标发布到Amazon CloudWatch：

    +   我们已经在上一节中讨论了与Greengrass相关的第一个三个主题。因此，我们将继续关注剩余的活动。

    +   这是一个几乎实时发布到本地主题的系统遥测数据连续流。默认配置是每60秒。

    +   因此，如果您考虑需要从与中心关联的传感器和执行器收集指标的场景，而不仅仅是从网关收集，则自定义应用程序可以检索这些数据点并将它们本地发布或发布到云端点以进行监控目的。*   *日志管理器*是Greengrass组件，可以部署到您的Greengrass核心设备以收集日志，并可选项地将其上传到Amazon CloudWatch Logs：

    +   尽管指标可以帮助反映设备的状态，但日志对于排除异常或故障至关重要。

    +   对于日志的实时可观察性，Greengrass提供了各种日志文件。其中一些您可能已经使用过，如下所示：

        +   **Greengrass.log**：这是用于查看关于核心和组件部署的实时信息的日志文件。例如，使用HBS中心，此日志文件可以报告核心软件的错误、异常和故障，您（或客户）可以分析这些故障或故障以确定停机时间或故障。

        +   **Component.log**：这是用于查看核心设备上运行的组件实时信息的日志文件（s）。

        +   **Main.log**：这是处理组件生命周期信息的日志文件。

    +   日志管理器组件可以以不同的频率上传日志。日志管理器的默认配置是每5分钟上传一次新日志到AWS CloudWatch。此外，还可以配置更低的上传间隔以实现更频繁的上传。日志格式也可以在文本格式和JSON格式之间进行配置。

    +   日志管理器还支持每小时或当文件大小限制超过时进行文件轮换。日志文件的默认大小限制为1 MB，磁盘大小为10 MB，并且可以完全配置。为了优化日志大小，使用不同环境的不同详细程度（如开发、测试和生产）也是一个最佳实践：

        +   例如，您可以选择DEBUG级别的日志来帮助在非生产环境中进行故障排除，或选择ERROR级别的日志以减少生产环境中设备生成的日志数量。此选择也有助于优化成本。

当您从HBS中心收集所有这些数据点（指标和日志）并将它们发布到云端时，下一步是允许不同的角色，如车队运营商（或其他下游业务）消费这些信息。这可以通过CloudWatch实现，它原生提供与日志洞察、生成仪表板、设置警报等相关的能力。如果您的组织已经标准化了监控解决方案（如**Splunk**、**Sumologic**、**Datadog**或其他），CloudWatch也支持该集成。

最后，在控制平面中，Greengrass 与 **AWS CloudTrail** 集成，记录与服务 API、IAM 用户和角色相关的访问事件。这些访问日志可用于确定有关 Greengrass 访问的更多详细信息，例如请求的 IP 地址、请求者是谁以及何时发起的请求，这些信息对于各种安全和运营需求可能很有用。

## 维护

之前解释过的服务，例如 Amazon CloudWatch（或第三方解决方案），可能足够强大，可以生成监控物联网工作负载健康状况所需的各类洞察。然而，物联网管理员或车队运营商的另一个常见需求是拥有一个单视图，使他们能够从设备车队中消费一套全面的信息，以便快速排查操作事件。

例如，考虑一个场景，客户抱怨他们的 HBS 调制解调器出现故障。作为车队运营商，您可以从仪表板观察到大量的连接丢失和高资源利用率。因此，您查阅日志（在设备或云中），并确定这是一个由于特定组件（如 *聚合器*）导致的内存泄漏问题。根据您的操作剧本，您需要确定这是否是一个孤立的问题，或者车队中的更多设备是否表现出类似的行为。因此，您需要一个界面来搜索、识别和可视化跨车队的指标，例如设备状态、设备连接、电池水平，或者根据用户位置进行过滤的集合。这就需要一款车队管理解决方案，如 **AWS Fleet Hub**，它允许通过无代码方法创建一个完全管理的网络应用程序，以满足各种角色的需求。在我们的场景中，这个网络应用程序可以帮助运营商几乎实时地查看、查询和交互连接的 HBS 调制解调器车队，并进一步排查问题。除了监控之外，运营商还可以响应警报，并通过单一界面触发远程操作 **空中**（**OTA**）来修复部署的设备。AWS Fleet Hub 应用程序还支持以下功能：

+   *集成*现有的身份和访问管理系统，如 Active Directory 和 LDAP，允许基于角色的访问到不同的角色，例如车队运营商、车队经理、设备制造商、第三方以及以某种方式与 HBS 调制解调器交互的 IT 运营商。此外，这还允许这些用户使用 **单点登录**（**SSO**）并从任何桌面、平板电脑或智能手机上的浏览器访问车队中心。

+   *聚合*来自其他服务（如AWS IoT Fleet Indexing、Amazon CloudWatch或**Amazon Simple Notification Service**（SNS））的数据。IoT Fleet Indexing服务有助于索引、搜索、查询和聚合来自设备注册、设备阴影和设备连接事件的 数据。此外，还可以创建自定义字段。CloudWatch指标可以与这些可搜索字段结合使用来创建警报。最后，当警报阈值被突破时，Amazon SNS可以通知不同的角色。

总结来说，Fleet Hub提供的这些功能可以让一个组织更快地响应不同的运营事件，从而提高客户体验。

## 诊断

在前面的场景中，你学习了如何通过单视图来实时了解运营事件。然而，如果通过Fleet Hub的远程操作不足以修复已识别的问题，如何进一步诊断问题呢？例如，操作员可能已触发远程操作来重新启动聚合组件或HBS中心本身，但这并没有解决最终消费者的问题。因此，作为下一步，操作员需要直接访问中心或相关传感器以进行进一步的故障排除。传统上，在这种情况下，公司会安排与技术人员预约，这意味着额外的成本和客户的等待时间。这就是AWS IoT Secure Tunneling这样的远程诊断功能派上用场的地方。这是一个AWS托管服务，允许车队操作员通过安全隧道获得额外的权限（如SSH或RDP访问）到目标设备。

Greengrass的加密隧道组件使得操作员工作站与Greengrass启用的设备（如HBS中心）之间即使在其后有受限防火墙的情况下也能进行安全的双向通信。这是通过远程操作在底下的安全隧道中导航实现的。此外，设备还将继续使用在遥测中使用的相同的加密凭证（即*X509证书*）。客户端（即**车队操作员**）的唯一其他依赖是需要在笔记本电脑或网络浏览器上安装代理软件。这是因为代理软件通过在会话启动时允许与隧道服务交换临时凭证（即**访问令牌**）来实现魔法。以下图表显示了安全隧道的工作流程：

![图9.8 – 诊断的加密隧道工作流程

](img/Figure_09_08.jpg)

图9.8 – 诊断的加密隧道工作流程

对于我们的场景，源指的是车队操作员的工作站，目标指的是连接的HBS中心，而安全隧道服务由AWS管理。

现在您已经很好地理解了如何更好地监控、维护和诊断边缘设备，让我们在本章的最后部分亲自动手。

# 熟练掌握车队中心架构

在本节中，您将学习如何使用核发射器和遥测代理从边缘设备捕获各种指标和日志，并通过Amazon CloudWatch和AWS IoT车队中心进行可视化。以下是在实验室中您将完成的不同服务和步骤的架构：

![图9.9 – 实践操作中心]

![img/Figure_09_09.jpg]

图9.9 – 实践操作中心

以下表格列出了您将在本练习中使用的服务：

![图9.10 – 本练习范围内的服务]

![img/Table_09_10.jpg]

图9.10 – 本练习范围内的服务

在本实践部分，您的目标是以下步骤，如前所述的架构所示：

1.  使用AWS IoT车队中心构建操作仪表板。

1.  部署一个核发射器组件并通过遥测从边缘收集指标。

1.  部署一个日志管理组件并将日志流式传输到Cloudwatch。

1.  在物联网车队中心（IoT Fleet Hub）和CloudWatch上可视化结果。

让我们更详细地查看前面的步骤。

## 构建云资源

在本节中，您将学习如何设置一个车队中心应用程序，该应用程序可以用于监控连接的HBS中心的数据指标。执行以下步骤：

1.  导航到**AWS IoT核心控制台**并选择**车队中心**。选择**入门**并点击**创建应用程序**。

1.  这将提示您使用AWS SSO设置**单点登录**。如果您以前没有使用过这项服务，请创建一个带有必要信息的用户。您将通过电子邮件收到邀请，您需要接受邀请并按照说明设置密码。点击**下一步**。

1.  现在您需要配置与AWS IoT数据的索引。如前所述，车队中心通过聚合来自不同来源的信息，为您提供单一视角视图。这就是您设置所有这些集成的地方。

1.  在**车队索引**部分点击**管理索引**。这将打开AWS IoT设置页面。再次点击**管理索引**并启用所有可用选项，例如**设备索引**和**设备组索引**。如有需要，您还可以创建自定义搜索字段。点击**更新**。

1.  返回车队中心设置屏幕，设置现在应该处于活动状态。点击**下一步**。

1.  创建一个应用程序角色和一个您选择的名称的应用程序。点击查看策略权限以了解提供给应用程序的访问权限。您应该注意到，您正在为车队中心提供访问权限以集成所有这些资源，如前所述。点击**创建应用程序**。

1.  在 Fleet Hub 的 **应用** 选项卡上，当应用 URL 显示为活动状态时，点击一次。对于首次访问，这将提示您添加一个 SSO 用户。点击该选项并添加您之前创建的用户。点击 **添加选定的用户**。

1.  完成后，再次点击应用 URL，进入网页仪表板，并使用您在 *步骤 2* 中配置的凭据登录。点击应用程序图标，它应该为您打开仪表板。

恭喜！您已经设置好了 Fleet Hub 仪表板！

注意

虽然我们只为这个实验创建了一个用户，但您可以将 AWS SSO 集成到您组织的身份管理系统，如 Active Directory。这将允许基于角色的访问仪表板，针对不同的角色。理想情况下，此配置将属于身份工程师的职责范围，而不是物联网专业人士的职责。

接下来，让我们设置从 HBS 中心到云端的遥测数据摄取的路由规则：

1.  导航到 **Amazon EventBridge** 控制台 ([https://go.aws/3xcB2T7](https://go.aws/3xcB2T7))，并点击 **创建规则**。

1.  为规则选择一个名称和描述。

1.  在 `AWS`。

1.  服务名称：`Greengrass`。

1.  事件类型：`Greengrass Telemetry Data`。

1.  保持 **选择事件总线** 部分为默认设置。

1.  在 `/aws/events/` <替换为您的选择名称>

1.  保持其他所有设置为默认，并点击 **创建**。

干得好！EventBridge 已经准备好摄取遥测数据并将其发布到 CloudWatch 组。

我们将在实验结束时再次访问这些仪表板，以可视化从中心收集的数据。现在，让我们转换方向，配置和部署 Greengrass 上的边缘连接器。

## 从云端部署组件到边缘

在本节中，您将学习如何将 **Nucleus Emitter** 和 **Log Manager** 代理部署到 Greengrass 启用的 HBS 中心，以将健康遥测数据发布到云端。执行以下步骤：

1.  请导航到 Amazon Greengrass 控制台，选择 `aws.greengrass.telemetry.NucleusEmitter` 和 `aws.greengrass.LogManager` 组件。您可以随意点击 **查看配方** 来审查此组件的配置。

1.  保持所有之前组件以及前两个组件选中状态，点击 **下一步**。在接下来的屏幕中，保持其他选项为默认设置，并选择 **部署**。

## 可视化结果

现在，您已经设置了车队中心并在边缘部署了代理，您可以使用以下步骤可视化遥测数据：

1.  导航到 **AWS IoT Core 控制台**，点击 **Fleet Hub**，并选择在实验室中创建的应用程序。

1.  在**设备列表**部分，点击Greengrass启用HBS网关设备。你将能够查看设备的状态以及各种其他属性，如字段属性、设备影子文件（即配置的设备状态）、设备所属的组以及部署的历史（即作业）。

1.  返回主页。你可以随意使用屏幕顶部的搜索和筛选选项来细化结果。通常，这在你有大量网关和关联设备时很有用。你还可以切换到**摘要**部分，以可视化按类型、事物组以及断开连接的原因的总设备数量。

1.  点击**创建警报**。这将帮助你设置以下违规的通知：

    1.  选择一个字段：**断开连接原因**。

    1.  选择一个聚合类型：**计数**。

    1.  选择**周期**设置为**5分钟**，然后点击**下一步**。

    1.  选择**指标**设置为**大于/等于1**，然后点击**下一步**。

    1.  假设你只有一个设备网关，如果你有更多，你可以增加计数。

    1.  配置通知和警报详情，然后点击**下一步和提交**。

    因此，作为一支船队运营商，你现在可以可视化你的设备船队的健康状况，同时对于阈值违规发出警报。

1.  导航到**AWS CloudWatch**控制台，点击**日志**然后选择**日志组**。

1.  搜索并点击**/aws/events/<将此替换为你选择的名称>日志组**，并可视化日志流。

1.  可能需要一些时间来填充，但日志流应该会显示从Greengrass网关设备收集的遥测数据。

1.  随意使用**日志洞察**，它允许你通过查询界面分析日志。

到目前为止，你已经学会了如何使用AWS原生解决方案操作Greengrass启用设备船队。这些模式也适用于非Greengrass设备，例如，利用其他设备SDK（如*AWS IoT Device SDK*或*FreeRTOS*）的设备。

挑战区

我将给你一个快速挑战，让你确定如何从AWS IoT Fleet Hub触发OTA作业到特定的HBS网关设备。这在需要推送更新，如操作事件期间所需的配置文件时很有用。祝你好运！

让我们通过一个简要的总结和一些知识检查问题来结束这一章。

# 摘要

在本章中，你被介绍了设计模式和设备集群的上线、管理和维护的最佳实践。这些实践可以帮助你在不同的地理位置部署和操作数百万（或更多）的连接设备。此外，你还学习了如何远程诊断边缘设备以解决常见问题或安全地隧道以进行高级故障排除。在此之后，你实施了一个边缘到云架构，利用各种 AWS 构建的组件和服务。这使得你可以从 HBS 节点收集健康遥测数据，设备管理员可以通过仪表板可视化这些数据，通过警报进行通知，或根据需要采取行动。

在下一章和最后一章中，我们将总结你在整本书中学到的所有关键教训（以及更多），这样你就可以为现实世界构建良好的解决方案了。

# 知识检查

在进入下一章之前，通过回答以下问题来测试你的知识。答案可以在书的末尾找到：

1.  对或错：设备注册和设备激活是相同的。

1.  有哪些不同的方式可以利用 AWS IoT Greengrass 中的证书颁发机构（CA）？

1.  是否有实时配置设备的选择？如果有，那是什么？

1.  对或错：指标和日志是监控 IoT 工作负载所需的所有数据点。

1.  你认为拥有一个单视图来查看整个设备集群有什么好处？

1.  如果需要，不派遣技术人员的情况下，远程故障排除设备的缓解策略是什么？（提示：考虑隧道。）

1.  AWS IoT Greengrass 提供哪些组件来收集系统健康遥测数据？

1.  对或错：在边缘设备上聚合指标是不可能的。它只能在云中完成。

# 参考资料列表

查看以下资源以获取本章讨论的概念的更多信息：

+   关于在 AWS IoT 核心中使用 X.509 证书进行设备制造和配置的论文：[https://d1.awsstatic.com/whitepapers/device-manufacturing-provisioning.pdf](https://d1.awsstatic.com/whitepapers/device-manufacturing-provisioning.pdf)

+   在何时使用 AWS IoT 设备管理：[https://aws.amazon.com/iot-device-management/](https://aws.amazon.com/iot-device-management/)

+   AWS IoT Greengrass 集群管理功能发布：[https://aws.amazon.com/about-aws/whats-new/2021/08/aws-iot-greengrass-v-2-4/](https://aws.amazon.com/about-aws/whats-new/2021/08/aws-iot-greengrass-v-2-4/)

+   AWS IoT 设备管理的设备中心：[https://docs.aws.amazon.com/iot/latest/fleethubuserguide/what-is-aws-iot-monitor.html](https://docs.aws.amazon.com/iot/latest/fleethubuserguide/what-is-aws-iot-monitor.html)

+   AWS IoT 事物组：[https://docs.aws.amazon.com/iot/latest/developerguide/thing-groups.html](https://docs.aws.amazon.com/iot/latest/developerguide/thing-groups.html)
