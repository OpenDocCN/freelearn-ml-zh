<html><head></head><body>
  <div class="calibre1" id="_idContainer078">
    <h1 class="chapternumber">8</h1>
    <h1 class="chaptertitle" id="_idParaDest-146">Build a Backend with Web APIs</h1>
    <h1 class="heading" id="_idParaDest-147">Introduction</h1>
    <p class="normal">When we say Web API, it’s an application programming interface we develop that’s meant for the client to consume. Said API uses HTTP to communicate. A browser can use a Web API to expose data and functionality to other browsers and applications.</p>
    <p class="normal1">When developing a Web API, you can use any programming language and framework you want. Regardless of the chosen tech, there are things you always need to consider, like data storage, security, authentication, authorization, documentation, testing, and more.</p>
    <p class="normal1">It’s with this understanding of what things we need to consider that we can use an AI assistant to help us build a backend.</p>
    <p class="normal1">In this chapter, we will:</p>
    <ul class="calibre15">
      <li class="bulletlist">Learn about Web APIs</li>
      <li class="bulletlist1">Create a Web API with Python and Flask</li>
      <li class="bulletlist1">Use our AI assistant to answer questions, suggest code, and create documentation and tests</li>
    </ul>
    <h1 class="heading" id="_idParaDest-148">Business domain: e-commerce</h1>
    <p class="normal">We will keep working on our e-commerce<a id="_idIndexMarker163" class="calibre3"/> example in this chapter. This time, the focus is on the API. The API lets you read and write data that’s important in the e-commerce domain. What’s important to keep in mind as you develop this API is that there are a couple of important aspects to it:</p>
    <ul class="calibre15">
      <li class="bulletlist">Logical domains: It’s beneficial to divide up your app into different logical domains. Within the context of e-commerce, that usually translates to products, orders, invoices, and so on.</li>
      <li class="bulletlist1">What part of the business should handle each logical domain? <ul class="calibre17">
          <li class="bulletlist2"><strong class="screentext">Products</strong>: Maybe there’s a dedicated team. It’s common for the same team to also manage all types of discounts and campaigns that might occur.</li>
          <li class="bulletlist3"><strong class="screentext">Invoices and payment</strong>: There’s usually a dedicated team that takes care of how the user can pay for things, for example, via credit cards, invoices, and other methods.</li>
          <li class="bulletlist3"><strong class="screentext">Inventory</strong>: You need to have a certain amount of goods in stock. How do you know how much? You need to work with business analysts or data<a id="_idIndexMarker164" class="calibre3"/> folk to make correct forecasts.</li>
        </ul>
      </li>
    </ul>
    <h1 class="heading" id="_idParaDest-149">Problem and data domain</h1>
    <p class="normal">We’ve already mentioned a few different logical <a id="_idIndexMarker165" class="calibre3"/>domains around products, orders, invoices, and so on. The problems you’ll have in this domain are generally:</p>
    <ul class="calibre15">
      <li class="bulletlist">Reading and writing: What data do you wish to read or write (or maybe both)?</li>
      <li class="bulletlist1">How will users access your data (all of it or maybe there will be filters applied to limit the output)?</li>
      <li class="bulletlist1">Access and roles: You can expect that different roles will need to have access to your system. An administrator role should probably have access to most of the data, whereas a logged-in user should only be able to see the part of the data that belongs to them. This is not something we will address in this chapter, but it’s something you should consider when you build out this API.</li>
    </ul>
    <h1 class="heading" id="_idParaDest-150">Feature breakdown</h1>
    <p class="normal">Now that we understand that there are both business problems as well as data problems, we need to start to identify the features that we need. Once we get to this level of detail, it should be easier to come up with specific prompts.</p>
    <p class="normal1">A way to do this feature breakdown<a id="_idIndexMarker166" class="calibre3"/> is as follows – for example, for products:</p>
    <ul class="calibre15">
      <li class="bulletlist">Read all products.</li>
      <li class="bulletlist1">Read products given a filter: Usually, you won’t want to read all products but maybe all products of a certain category, or maybe even limit it to a specific value such as 10 products or 20 products.</li>
      <li class="bulletlist1">Search for products: You should support the user looking for specific products, usually via a category, name, or perhaps part of a certain campaign.</li>
      <li class="bulletlist1">Retrieve detailed information on a specific product.</li>
    </ul>
    <p class="normal1">I’m sure there are more features for products, but now you have an idea of what granular detail you should have before you continue building the API.</p>
    <h1 class="heading" id="_idParaDest-151">Prompt strategy</h1>
    <p class="normal">In this chapter, you will see how we use<a id="_idIndexMarker167" class="calibre3"/> both Copilot Chat and the in-editor mode. We will start with the Chat mode as it’s quite useful for situations where you want to generate starter code. It’s also quite efficient in that it lets you select certain lines of code and lets you update only those based on a prompt. Examples of the latter could be when you want to improve such code. You will see this use case later in the chapter when we improve a route to read from a database instead of reading static data from a list. There will also be cases in this chapter where we use the in-editor mode. This is the recommended approach when you’re actively typing the code and want to make smaller tweaks. In this chapter, we will use the “Exploratory prompt pattern” as described in <em class="italic">Chapter 2</em>. </p>
    <h1 class="heading" id="_idParaDest-152">Web APIs</h1>
    <p class="normal">Using a Web API is a<a id="_idIndexMarker168" class="calibre3"/> great way to ensure our front-end application has access to the data and functionality it needs to read and write data.</p>
    <p class="normal1">The expectations of a Web API are:</p>
    <ul class="calibre15">
      <li class="bulletlist">It is accessible <a id="_idIndexMarker169" class="calibre3"/>over the web.</li>
      <li class="bulletlist1">It leverages HTTP protocol and HTTP verbs such as <code class="inlinecode">GET</code>, <code class="inlinecode">POST</code>, <code class="inlinecode">PUT</code>, <code class="inlinecode">DELETE</code>, and others to communicate intentions.</li>
    </ul>
    <h2 class="heading1" id="_idParaDest-153">What language and framework should you pick?</h2>
    <p class="normal">In this chapter, we already decided we will use Python and Flask. But why? What criteria do we use to pick a language and framework?</p>
    <p class="normal1">You can use any <a id="_idIndexMarker170" class="calibre3"/>language and framework you want, but here are some criteria to consider:</p>
    <ul class="calibre15">
      <li class="bulletlist">What languages and frameworks do you know?</li>
      <li class="bulletlist1">Are they easy to learn?</li>
      <li class="bulletlist1">Do they have a large community?</li>
      <li class="bulletlist1">Are they free and open source?</li>
      <li class="bulletlist1">How often are they updated?</li>
      <li class="bulletlist1">Do they have good documentation?</li>
      <li class="bulletlist1">Do they have good tooling?</li>
    </ul>
    <p class="normal1">These are just some of the criteria to consider.</p>
    <p class="normal1">The reason for picking Python and Flask is that they check many of the above boxes (so does the Express framework for Node.js, but the objective here is to just show how you can build a Web API using an AI assistant, so feel free to use whatever web framework you prefer). Also, the point of this book is to show how an AI assistant can help us build a backend; with what prompts and how and the framework and language is not the focus.</p>
    <h2 class="heading1" id="_idParaDest-154">Planning the Web API</h2>
    <p class="normal">When you plan your <a id="_idIndexMarker171" class="calibre3"/>Web API, you should consider the following:</p>
    <ul class="calibre15">
      <li class="bulletlist">What data do you want to expose? For example, products and orders.</li>
      <li class="bulletlist1">What functionality do you want to expose? For example, reading order data.</li>
      <li class="bulletlist1">How will you structure your Web API?</li>
      <li class="bulletlist1">Security and authentication: You need to determine not only what areas of your app should require the user to log in but also what parts should be restricted to specific user types.</li>
      <li class="bulletlist1">Storage and <a id="_idIndexMarker172" class="calibre3"/>database: Common choices are, for example, MySQL and Postgres.</li>
    </ul>
    <p class="normal1">Use the above points as a checklist when you plan your Web API.</p>
    <h1 class="heading" id="_idParaDest-155">Creating a Web API with Python and Flask</h1>
    <p class="normal">A key insight to working with an<a id="_idIndexMarker173" class="calibre3"/> AI assistant is that we can use it to generate code, <em class="italic">but</em> we need to have a good understanding of the problem domain and the solution domain. This means that we should know how to create a Web API with Python and Flask before we ask our AI assistant to help us. Can we create it without an AI assistant? Yes, but we risk getting stuck and not knowing what to do next.</p>
    <p class="normal1">So, how much knowledge are we talking about? If you know Python in general and how to build a Web API in any language, you are good to go.</p>
    <p class="normal1">Let’s begin.</p>
    <h2 class="heading1" id="_idParaDest-156">Step 1: Create a new project</h2>
    <p class="normal">First, we need to create a new <a id="_idIndexMarker174" class="calibre3"/>project. If you know Python, you know using a virtual environment is a good idea as it isolates the project from other Python projects on your computer. Using a virtual environment is not required but is recommended as different versions of Python and packages can cause issues.</p>
    <p class="normal1">Okay, so we know we need a virtual environment. How do we create one? Let’s rely on our AI assistant to help us remember the syntax. For the prompt below, you can either open a text file or use the chat functionality in GitHub Copilot.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How do I create a virtual environment for Python? </p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <div class="note">
      <p class="normal1">The in-editor experience, typing a prompt in an open text file, prefers you to use <code class="inlinecode">q:</code> at the start of a sentence. If you use the Chat functionality, there’s no need to add <code class="inlinecode">q:</code>.</p>
    </div>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <p class="normal1">The answer is on the same row as <code class="inlinecode">a:</code>.</p>
    <pre class="programlisting2"><code class="hljs-con">python -m venv venv
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Here’s how the output can look in an <code class="inlinecode">app.py</code> file containing both the prompt and the response:</p>
    <pre class="programlisting"><code class="hljs-code"># q: How do I create a virtual environment for Python? a: python –m venv venv 
</code></pre>
    <p class="normal1">To use the command the AI assistant responded with, we would need to open a terminal, paste the command, and run it.</p>
    <p class="normal1">At this point, you need enough conceptual knowledge to know that you need to activate the virtual environment to use it. But again, let’s ask the AI assistant to help us.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How do<a id="_idIndexMarker175" class="calibre3"/> I activate a virtual environment for Python in Windows?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code">a: Venv\Scripts\activate
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <div class="note">
      <p class="normal1">If you are on a Mac or Linux, change the above prompt to reflect your operating system.</p>
    </div>
    <h2 class="heading1" id="_idParaDest-157">Step 2: Install Flask</h2>
    <p class="normal">The conceptual <a id="_idIndexMarker176" class="calibre3"/>knowledge you need to have is that you can install packages – in this case, Flask – using <code class="inlinecode">pip</code>. Let’s ask the AI assistant to help us. Keep working with your <code class="inlinecode">app.py</code> file and add your prompt as another comment.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How do I install Flask with pip?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting2"><code class="hljs-con">pip install Flask
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Your <code class="inlinecode">app.py</code> should now look like so:</p>
    <pre class="programlisting"><code class="hljs-code"># q: How do I create a virtual environment for Python? a: python –m venv venv
# q: How do I install Flask with pip? a: pip install Flask
</code></pre>
    <div class="note">
      <p class="normal1">As you’re using your AI tool to get quick answers on how to do something, it’s up to you if you want to clear the text file from questions and responses.</p>
    </div>
    <p class="normal1">Great, we now <a id="_idIndexMarker177" class="calibre3"/>know how to install Flask.</p>
    <h2 class="heading1" id="_idParaDest-158">Step 3: Create an entry point</h2>
    <p class="normal">We need to create an <a id="_idIndexMarker178" class="calibre3"/>entry point for our Web API. This is the file that will be executed when we run our Web API. For Python, you usually name this file <code class="inlinecode">app.py</code>.</p>
    <h2 class="heading1" id="_idParaDest-159">Step 4: Create a Flask app</h2>
    <p class="normal">At this point, we <a id="_idIndexMarker179" class="calibre3"/>have our project, we’ve installed Flask, and we have an entry point file, but the application is not a Flask application yet, so let’s create one.</p>
    <p class="normal1">Let’s ask the AI assistant to help us.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How do I create a Flask app?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1">As usual, keep typing your questions as comments prepended with a <code class="inlinecode">q:</code> in your open text file. Here’s the response from your latest prompt:</p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">We’re not getting much back from the AI assistant. But we know we need to import Flask. Let’s improve the prompt.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">How do I create a Flask app with a default route and a “hello” route?</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1">Now you’ll see an improved prompt response. The prompt contains more explicit instructions to create routes and logical areas in the app:</p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-comment"># create app</span>
app = Flask(__name__)
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'</span><span class="hljs-string">/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Hello World!'</span>
<span class="hljs-comment"># hello route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/hello'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">hello</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Hello World!'</span>
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Now we have <a id="_idIndexMarker180" class="calibre3"/>some starting code for our Flask app.</p>
    <p class="normal1">Next, let’s focus on the use case for our Web API – e-commerce.</p>
    <h1 class="heading" id="_idParaDest-160">Use case: a Web API for an e-commerce site</h1>
    <p class="normal">So far, in this book, we’ve taken <a id="_idIndexMarker181" class="calibre3"/>you through the process of building a front-end application for an e-commerce site. We used an AI assistant to help us with the front-end application. Now, we will build a Web API for the e-commerce site.</p>
    <p class="normal1">In the previous section, we used an AI assistant to help us create a Flask app. Now, we will use the AI assistant to help us create a Web API for an e-commerce site.</p>
    <h2 class="heading1" id="_idParaDest-161">Step 1: Create a Web API for an e-commerce site</h2>
    <p class="normal">Let’s plan this task<a id="_idIndexMarker182" class="calibre3"/> first. Based on previous chapters, the e-commerce site has the following features:</p>
    <ul class="calibre15">
      <li class="bulletlist"><strong class="screentext">Product catalog</strong>: Containing the products we aim to sell.</li>
      <li class="bulletlist1"><strong class="screentext">Shopping cart</strong>: With a shopping cart, we can add products to the cart, remove products from the cart, and update the quantity of products in the cart. Once we’re happy with the products in the cart, we can check out and have the products paid for and shipped.</li>
      <li class="bulletlist1"><strong class="screentext">A checkout process</strong>: In the checkout process, we need to collect payment information and shipping information.</li>
    </ul>
    <p class="normal1">With the above information in mind, let’s craft a prompt for our AI assistant.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Show<a id="_idIndexMarker183" class="calibre3"/> me code to create a Flask Web API that includes routes for a product catalog, shopping cart, and checkout process.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-comment"># create app</span>
app = Flask(__name__)
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'</span><span class="hljs-string">/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Hello World!'</span>
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Products'</span>
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Cart'</span>
<span class="hljs-comment"># checkout</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Checkout'</span>
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">Okay, so we have some starting code for our Web API, but we need to improve it in the following ways:</p>
    <ul class="calibre15">
      <li class="bulletlist">We need to return JSON instead of text.</li>
      <li class="bulletlist1">We want to add code to read and write to a database.</li>
      <li class="bulletlist1">We want to add tests.</li>
      <li class="bulletlist1">We want <a id="_idIndexMarker184" class="calibre3"/>to document the Web API.</li>
    </ul>
    <h2 class="heading1" id="_idParaDest-162">Step 2: Return JSON instead of text</h2>
    <p class="normal">JSON is a <a id="_idIndexMarker185" class="calibre3"/>common format<a id="_idIndexMarker186" class="calibre3"/> for data. It’s a format that is easy to read and write for both humans and machines. To use JSON in Python, we need to import the <code class="inlinecode">json</code> package. The method we will use is <code class="inlinecode">jsonify()</code>, which is a method that will convert a Python dictionary to JSON.</p>
    <p class="normal1">Let’s see how we can use <code class="inlinecode">jsonify()</code> in our Web API. For this operation, we can keep using the AI assistant as prompt comments in the code, or we can use GitHub Copilot’s Chat feature (this is a separate extension of GitHub Copilot).</p>
    <p class="normal1">Let’s use the latter. To use GitHub Copilot’s Chat feature (refer to this link for updated install instructions: <a href="https://docs.github.com/en/copilot/github-copilot-chat/using-github-copilot-chat-in-your-ide" class="calibre3"><span class="calibre3">https://docs.github.com/en/copilot/github-copilot-chat/using-github-copilot-chat-in-your-ide</span></a>), we need to select the code we want to improve and click the chat icon on the left side of Visual Studio Code (if you are using the default orientation, where the icons are placed vertically – it depends what other extensions you have installed). Here’s the icon to look for. Ensure the GitHub Copilot Chat extension has been correctly installed:</p>
    <figure class="mediaobject"><img alt="Chat icon for GitHub Copilot" src="../Images/B21232_08_01.png" class="calibre19"/></figure>
    <p class="packt_figref">Figure 8.1: Chat icon for GitHub Copilot</p>
    <p class="normal1">Once we click the <strong class="screentext">Chat</strong> icon, and the code selected, we can start chatting with GitHub Copilot. Let’s ask GitHub Copilot to help us return JSON instead of text.</p>
    <p class="normal1">We add the following prompt to the chat window:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Add code to respond with JSON for all routes.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <figure class="mediaobject"><img alt="Prompt in Copilot chat window" src="../Images/B21232_08_02.png" class="calibre19"/></figure>
    <p class="packt_figref">Figure 8.2: Prompt in Copilot chat window</p>
    <p class="normal1">The chat<a id="_idIndexMarker187" class="calibre3"/> functionality generates an answer consisting of code including the <code class="inlinecode">jsonify()</code> method.</p>
    <figure class="mediaobject"><img alt="Copilot chat response" src="../Images/B21232_08_03.png" class="calibre19"/></figure>
    <p class="packt_figref">Figure 8.3: Copilot Chat response</p>
    <p class="normal1">Here’s <a id="_idIndexMarker188" class="calibre3"/>the code generated by GitHub Copilot:</p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify
<span class="hljs-comment"># create app</span>
app = Flask(__name__)
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Hello World!'</span>})
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    products = [
        {<span class="hljs-string">'id'</span>: <span class="hljs-attr">1</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Product 1'</span>, <span class="hljs-string">'price'</span>: <span class="hljs-attr">10.99</span>},
        {<span class="hljs-string">'id'</span>: <span class="hljs-attr">2</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Product 2'</span>, <span class="hljs-string">'price'</span>: <span class="hljs-attr">5.99</span>},
        {<span class="hljs-string">'id'</span>: <span class="hljs-attr">3</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'</span><span class="hljs-string">Product 3'</span>, <span class="hljs-string">'price'</span>: <span class="hljs-attr">7.99</span>}
    ]
    <span class="hljs-keyword">return</span> jsonify(products)
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'</span><span class="hljs-string">message'</span>: <span class="hljs-string">'Cart'</span>})
<span class="hljs-comment"># checkout</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Checkout'</span>})
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <h2 class="heading1" id="_idParaDest-163">Step 3: Add code to read and write to a database</h2>
    <p class="normal">Okay, so we<a id="_idIndexMarker189" class="calibre3"/> have a Web API that returns JSON. Now, we need to add code to read and write to a database. Let’s use the chat feature again to help us with this task.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Add code to read and write to a database and apply it to all our routes.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1">Here’s the code we end up with:</p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify
<span class="hljs-comment"># create app</span>
app = Flask(__name__)
<span class="hljs-comment"># connect to database</span>
conn = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
<span class="hljs-comment"># create table</span>
conn.execute(<span class="hljs-string">'''CREATE TABLE IF NOT EXISTS products</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             name TEXT NOT NULL,</span>
<span class="hljs-string">             price REAL NOT NULL);'''</span>)
<span class="hljs-comment"># insert data</span>
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Product 1'</span>, <span class="hljs-attr">10.99</span>))
conn.execute(<span class="hljs-string">"</span><span class="hljs-string">INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Product 2'</span>, <span class="hljs-attr">5.99</span>))
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Product 3'</span>, <span class="hljs-attr">7.99</span>))
conn.commit()
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Hello World!'</span>})
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    cursor = conn.execute(<span class="hljs-string">"SELECT id, name, price FROM products"</span>)
    products = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        product = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'name'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'price'</span>: row[<span class="hljs-attr">2</span>]}
        products.append(product)
    <span class="hljs-keyword">return</span> jsonify(products)
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Cart'</span>})
<span class="hljs-comment"># checkout</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Checkout'</span>})
<span class="hljs-comment"># close connection</span>
conn.close()
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">As you can see, we get quite a lot of code:</p>
    <ul class="calibre15">
      <li class="bulletlist">Code to connect to a database – in this case, we get a connection to the common SQLite database. </li>
      <li class="bulletlist1">Code that creates a table and even reads from it in the <code class="inlinecode">/products</code> route, but we don’t get code to write to the database. </li>
      <li class="bulletlist1">We don’t get code to read and write to the other routes either.</li>
    </ul>
    <p class="normal1">Based on the code above, we realize it’s a good start, but there are things we’d like to improve, so we will change the prompt to address the shortcomings. We need the prompt to ensure all routes read their data from a database, not just one.</p>
    <p class="normal1">So, we can <a id="_idIndexMarker190" class="calibre3"/>either adjust the code ourselves, knowing that most of the code is in place, or try to adjust the prompt. Let’s try the latter.</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Add code to read and write to a database and apply it to all our routes.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify
<span class="hljs-comment"># create app</span>
app = Flask(__name__)
<span class="hljs-comment"># connect to database</span>
conn = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
<span class="hljs-comment"># create table </span>
conn.execute(<span class="hljs-string">'''CREATE TABLE IF NOT EXISTS products</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             name TEXT NOT NULL,</span>
<span class="hljs-string">             price REAL NOT NULL);'''</span>)
<span class="hljs-comment"># insert data</span>
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Product 1'</span>, <span class="hljs-attr">10.99</span>))
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Product 2'</span>, <span class="hljs-attr">5.99</span>))
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Product 3'</span>, <span class="hljs-attr">7.99</span>))
conn.commit()
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Hello World!'</span>})
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    cursor = conn.execute(<span class="hljs-string">"SELECT id, name, price FROM products"</span>)
    products = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        product = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'name'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'price'</span>: row[<span class="hljs-attr">2</span>]}
        products.append(product)
    <span class="hljs-keyword">return</span> jsonify(products)
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    cursor = conn.execute(<span class="hljs-string">"SELECT id, name, price FROM products"</span>)
    products = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        product = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'name'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'price'</span>: row[<span class="hljs-attr">2</span>]}
        products.append(product)
    <span class="hljs-keyword">return</span> jsonify(products)
<span class="hljs-comment"># checkout</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    cursor = conn.execute(<span class="hljs-string">"SELECT id, name, price FROM products"</span>)
    products = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        product = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'name'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'price'</span>: row[<span class="hljs-attr">2</span>]}
        products.append(product)
    <span class="hljs-keyword">return</span> jsonify(products)
<span class="hljs-comment"># close connection</span>
conn.close()
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">The improved<a id="_idIndexMarker191" class="calibre3"/> prompt made the following changes:</p>
    <ul class="calibre15">
      <li class="bulletlist">Added database code to the <code class="inlinecode">/checkout</code> and <code class="inlinecode">/cart</code> routes.</li>
      <li class="bulletlist1">All three routes read from the products table, which is incorrect. That’s something we need to address in an upcoming prompt. The great news is that we can just tell Copilot Chat what the problem is with a prompt and expect the AI assistant to change the code accordingly.</li>
    </ul>
    <p class="normal1">The above code is better than our very first prompt but has issues still.</p>
    <p class="normal1">You could try to adjust the prompt in Copilot Chat, but let’s fall back on our other approach – namely, prompts in the code. To add these prompts, put your cursor in the code and add the prompt as a comment. Here are some prompts we added:</p>
    <ul class="calibre15">
      <li class="bulletlist"><em class="italic"># create tables</em>: We’re repeating the comment we have already used, but because Copilot is now aware of all the routes, it does a better job this time, suggesting three database tables should be created rather than just the <code class="inlinecode">products</code> one.</li>
      <li class="bulletlist1"><em class="italic"># add product to cart, productId and quantity in body, create cart if needed, else update</em>: This prompt is detailed as it asks what information should be added to each cart entry.</li>
      <li class="bulletlist1"><em class="italic"># product catalog</em> and <em class="italic"># shopping cart</em> are also repeated prompts (we remove the old prompt, and retype it to toggle a new suggestion). This time, we get Copilot to suggest the correct database tables to read from.</li>
    </ul>
    <p class="normal1">Note below how we <a id="_idIndexMarker192" class="calibre3"/>reshape the code with various prompts in the code as comments:</p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> flask
<span class="hljs-comment"># create app</span>
app = flask.Flask(__name__)
<span class="hljs-comment"># connect to database</span>
db = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
<span class="hljs-comment"># create tables</span>
db.execute(<span class="hljs-string">'''CREATE TABLE IF NOT EXISTS products</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             name TEXT NOT NULL,</span>
<span class="hljs-string">             price REAL NOT NULL);'''</span>)
db.execute(<span class="hljs-string">'''CREATE TABLE IF NOT EXISTS cart</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             product_id INTEGER NOT NULL,</span>
<span class="hljs-string">             quantity INTEGER NOT NULL);'''</span>)
db.execute(<span class="hljs-string">'''</span><span class="hljs-string">CREATE TABLE IF NOT EXISTS checkout</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             cart_id INTEGER NOT NULL,</span>
<span class="hljs-string">             total REAL NOT NULL);'''</span>)
db.commit()
db.close()
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Hello World!'</span>})
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    db = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
    cursor = db.execute(<span class="hljs-string">"SELECT id, name, price FROM products"</span>)
    products = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        product = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'</span><span class="hljs-string">name'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'price'</span>: row[<span class="hljs-attr">2</span>]}
        products.append(product)
    db.close()
    <span class="hljs-keyword">return</span> flask.jsonify(products)
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    db = sqlite3.connect(<span class="hljs-string">'</span><span class="hljs-string">example.db'</span>)
    cursor = db.execute(<span class="hljs-string">"SELECT id, product_id, quantity FROM cart"</span>)
    cart = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        item = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'product_id'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'quantity'</span>: row[<span class="hljs-attr">2</span>]}
        cart.append(item)
    db.close()
    <span class="hljs-keyword">return</span> flask.jsonify(cart)
<span class="hljs-comment"># add product to cart, productId and quantity in body, create cart if needed, else update</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart/'</span><span>, methods=[</span><span class="hljs-string">'POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">add_to_cart</span>():
    db = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
    <span class="hljs-comment"># get product id and quantity from body</span>
    product_id = flask.request.json[<span class="hljs-string">'productId'</span>]
    quantity = flask.request.json[<span class="hljs-string">'quantity'</span>]
    <span class="hljs-comment"># check if cart exists</span>
    cursor = db.execute(<span class="hljs-string">"SELECT id FROM cart"</span>)
    cart_id = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        cart_id = row[<span class="hljs-attr">0</span>]
    <span class="hljs-comment"># if cart exists, update</span>
    <span class="hljs-keyword">if</span> cart_id:
        db.execute(<span class="hljs-string">"UPDATE cart SET product_id = ?, quantity = ? WHERE id = ?"</span>, (product_id, quantity, cart_id))
    <span class="hljs-comment"># else create</span>
    <span class="hljs-keyword">else</span>:
        db.execute(<span class="hljs-string">"INSERT INTO cart (product_id, quantity) VALUES (?, ?)"</span>, (product_id, quantity))
    <span class="hljs-comment"># close</span>
    db.commit()
    db.close()
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Added to cart'</span>})
<span class="hljs-comment"># checkout POST, cartId in body</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span>, methods=[</span><span class="hljs-string">'</span><span class="hljs-string">POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    <span class="hljs-comment"># insert cart into checkout</span>
    conn = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
    <span class="hljs-comment"># get cart id from body</span>
    cart_id = flask.request.json[<span class="hljs-string">'cartId'</span>]
    <span class="hljs-comment"># write to checkout</span>
    conn.execute(<span class="hljs-string">"INSERT INTO checkout (cart_id, total) VALUES (?, ?)"</span>, (cart_id, <span class="hljs-attr">0</span>))
    <span class="hljs-comment"># close</span>
    conn.commit()
    conn.close()
</code></pre>
    <p class="normal1">Is this code good enough or do we need to adjust it further?</p>
    <p class="normal1">There’s definitely <a id="_idIndexMarker193" class="calibre3"/>room for improvement and here’s what you should be looking for:</p>
    <ul class="calibre15">
      <li class="bulletlist">The code is not DRY (Don’t Repeat Yourself); we have a lot of duplicate code. We can solve this by creating a function that takes a query and returns the result.</li>
      <li class="bulletlist1">Authentication and authorization are missing. We should add this to the code.</li>
      <li class="bulletlist1">Documentation is missing.</li>
      <li class="bulletlist1">The code is not secure. We should add some security measures, especially when it comes to the database. As developers, having some knowledge of how to secure code, we can use prepared statements to prevent SQL injection attacks and also validate the data that we receive from the client.</li>
    </ul>
    <h2 class="heading1" id="_idParaDest-164">Step 4: Improve the code</h2>
    <p class="normal">The best way to<a id="_idIndexMarker194" class="calibre3"/> improve the code is to use the code that we have as a starting point and first just try to run it. We can then see what errors we get and what we need to fix.</p>
    <p class="normal1">After that, we work on architecture and design and separate the code into different files.</p>
    <p class="normal1">Lastly, we add authentication and authorization and security measures.</p>
    <h3 class="heading2" id="_idParaDest-165">Run the code</h3>
    <p class="normal">Let’s run the <a id="_idIndexMarker195" class="calibre3"/>code. We need to set the Flask variable <code class="inlinecode">FLASK_APP</code> to <code class="inlinecode">app.py</code> and then run the app.</p>
    <div class="note">
      <p class="normal1">If you are using Windows, you need to use <code class="inlinecode">set</code> instead of <code class="inlinecode">export</code> to set the variable.</p>
    </div>
    <pre class="programlisting2"><code class="hljs-con"><span class="hljs-con-meta"># </span>flask variable windows
set FLASK_APP=app.py
flask run
</code></pre>
    <p class="normal1">The app is working! We can now go to <code class="inlinecode">http://localhost:5000</code> and see the message <strong class="screentext">Hello World!</strong>.</p>
    <p class="normal1">Going to <code class="inlinecode">/products</code>, <code class="inlinecode">/cart</code>, and <code class="inlinecode">/checkout</code> also works, but we don’t have any data in the database yet. Let’s add some data to the database. By inserting the above code at the top of the file and running the app again, we can do this:</p>
    <pre class="programlisting"><code class="hljs-code">db.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Apple'</span>, <span class="hljs-attr">1.99</span>))
db.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Banana'</span>, <span class="hljs-attr">2.99</span>))
</code></pre>
    <p class="normal1">Now, if you rerun the app and go to <code class="inlinecode">/products</code>, you should see the products that we added as the following JSON output:</p>
    <pre class="programlisting"><code class="hljs-code"><span>[</span>
  <span>{</span>
    <span class="hljs-attr">"id"</span><span>:</span> <span class="hljs-attr">1</span><span>,</span>
    <span class="hljs-attr">"</span><span class="hljs-attr">name"</span><span>:</span> <span class="hljs-string">"Apple"</span><span>,</span>
    <span class="hljs-attr">"price"</span><span>:</span> <span class="hljs-attr">1.99</span>
  <span>},</span>
  <span>{</span>
    <span class="hljs-attr">"id"</span><span>:</span> <span class="hljs-attr">2</span><span>,</span>
    <span class="hljs-attr">"name"</span><span>:</span> <span class="hljs-string">"Banana"</span><span>,</span>
    <span class="hljs-attr">"price"</span><span>:</span> <span class="hljs-attr">2.99</span>
  <span>}</span>
<span>]</span>
</code></pre>
    <h3 class="heading2" id="_idParaDest-166">Refactor the code</h3>
    <p class="normal">Great – lots of <a id="_idIndexMarker196" class="calibre3"/>progress so far! Now let’s refactor the code and make it more DRY (Don’t Repeat Yourself, a term for ensuring we don’t duplicate code too much). We can use Copilot to help us with this.</p>
    <p class="normal1">Provide it with the following prompt:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Improve the code by separating the database parts into a separate module db.py and expose the functions as follows: get_products, get_cart, add_to_cart, checkout.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <p class="normal1">We get two responses, one for the <code class="inlinecode">db.py</code> file and one for the <code class="inlinecode">app.py</code> file. Let’s start with the <code class="inlinecode">db.py</code> file.</p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-comment"># connect to database</span>
conn = sqlite3.connect(<span class="hljs-string">'example.db'</span>)
<span class="hljs-comment"># create tables</span>
conn.execute(<span class="hljs-string">'''CREATE TABLE IF NOT EXISTS products</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             name TEXT NOT NULL,</span>
<span class="hljs-string">             price REAL NOT NULL);'''</span>)
conn.execute(<span class="hljs-string">'''CREATE TABLE IF NOT EXISTS cart</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             product_id INTEGER NOT NULL,</span>
<span class="hljs-string">             quantity INTEGER NOT NULL);'''</span>)
conn.execute(<span class="hljs-string">'''</span><span class="hljs-string">CREATE TABLE IF NOT EXISTS checkout</span>
<span class="hljs-string">             (id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="hljs-string">             cart_id INTEGER NOT NULL,</span>
<span class="hljs-string">             total REAL NOT NULL);'''</span>)
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Apple'</span>, <span class="hljs-attr">1.99</span>))
conn.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES (?, ?)"</span>, (<span class="hljs-string">'Banana'</span>, <span class="hljs-attr">2.99</span>))
conn.commit()
<span class="hljs-keyword">def</span> <span class="hljs-meta">get_products</span>():
    cursor = conn.execute(<span class="hljs-string">"SELECT id, name, price FROM products"</span>)
    products = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        product = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'name'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'price'</span>: row[<span class="hljs-attr">2</span>]}
        products.append(product)
    <span class="hljs-keyword">return</span> products
<span class="hljs-keyword">def</span> <span class="hljs-meta">get_cart</span>():
    cursor = conn.execute(<span class="hljs-string">"SELECT id, product_id, quantity FROM cart"</span>)
    cart = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        item = {<span class="hljs-string">'id'</span>: row[<span class="hljs-attr">0</span>], <span class="hljs-string">'product_id'</span>: row[<span class="hljs-attr">1</span>], <span class="hljs-string">'quantity'</span>: row[<span class="hljs-attr">2</span>]}
        cart.append(item)
    <span class="hljs-keyword">return</span> cart
<span class="hljs-keyword">def</span> <span class="hljs-meta">add_to_cart</span>(<span>product_id, quantity</span>):
    <span class="hljs-comment"># check if cart exists</span>
    cursor = conn.execute(<span class="hljs-string">"SELECT id FROM cart"</span>)
    cart_id = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
        cart_id = row[<span class="hljs-attr">0</span>]
    <span class="hljs-comment"># if cart exists, update</span>
    <span class="hljs-keyword">if</span> cart_id:
        conn.execute(<span class="hljs-string">"UPDATE cart SET product_id = ?, quantity = ? WHERE id = ?"</span>, (product_id, quantity, cart_id))
    <span class="hljs-comment"># else create</span>
    <span class="hljs-keyword">else</span>:
        conn.execute(<span class="hljs-string">"INSERT INTO cart (product_id, quantity) VALUES (?, ?)"</span>, (product_id, quantity))
    conn.commit()
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>(<span>cart_id</span>):
    <span class="hljs-comment"># insert cart into checkout</span>
    conn.execute(<span class="hljs-string">"</span><span class="hljs-string">INSERT INTO checkout (cart_id, total) VALUES (?, ?)"</span>, (cart_id, <span class="hljs-attr">0</span>))
    conn.commit()
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <div class="note">
      <p class="normal1">We need to improve the above code a bit, as it’s using an open connection to the database. We should close the connection after we are done with it. Ensure you add code to close the connection after the commit. Also, ensure per route that you open and close the connection.</p>
    </div>
    <p class="normal1">This looks good. Let’s <a id="_idIndexMarker197" class="calibre3"/>add it to our project. We can create a new file called <code class="inlinecode">db.py</code> and copy the code into it.</p>
    <p class="normal1">Next, let’s see what it suggested for the <code class="inlinecode">app.py</code> file:</p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword">import</span> flask
<span class="hljs-keyword">import</span> db
<span class="hljs-comment"># create app</span>
app = flask.Flask(__name__)
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'</span><span class="hljs-string">/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Hello World!'</span>})
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    products = db.get_products()
    <span class="hljs-keyword">return</span> flask.jsonify(products)
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    cart = db.get_cart()
    <span class="hljs-keyword">return</span> flask.jsonify(cart)
<span class="hljs-comment"># add product to cart, productId and quantity in body, create cart if needed, else update</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'</span><span class="hljs-string">/cart'</span><span>, methods=[</span><span class="hljs-string">'POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">add_to_cart</span>():
    <span class="hljs-comment"># get product id and quantity from body</span>
    product_id = flask.request.json[<span class="hljs-string">'productId'</span>]
    quantity = flask.request.json[<span class="hljs-string">'quantity'</span>]
    db.add_to_cart(product_id, quantity)
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'</span><span class="hljs-string">Added to cart'</span>})
<span class="hljs-comment"># checkout POST, cartId in body</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span>, methods=[</span><span class="hljs-string">'POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    <span class="hljs-comment"># get cart id from body</span>
    cart_id = flask.request.json[<span class="hljs-string">'cartId'</span>]
    db.checkout(cart_id)
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Checkout successful'</span>})
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <p class="normal1">As you can see, it has separated the database code into the <code class="inlinecode">db.py</code> file and has also added the imports for the <code class="inlinecode">db.py</code> file. Let’s copy this code into our <code class="inlinecode">app.py</code> file and replace its content.</p>
    <p class="normal1">Does it work? Let’s <a id="_idIndexMarker198" class="calibre3"/>run the app and see. It runs without any errors, and we get JSON output when we go to <code class="inlinecode">/products</code>, <code class="inlinecode">/cart</code>, and <code class="inlinecode">/checkout</code>. If you want, you can also make a <code class="inlinecode">POST</code> request to <code class="inlinecode">/cart</code> to write cart content – great!</p>
    <h2 class="heading1" id="_idParaDest-167">Step 5: Document the API</h2>
    <p class="normal">We can use Copilot Chat to<a id="_idIndexMarker199" class="calibre3"/> help us document the API. Let’s provide it with the following prompt:</p>
    <p class="normal1"><strong class="screentext">[Prompt]</strong></p>
    <p class="normal1">Document the API using Swagger. The API should have the following endpoints: GET /products, GET /cart, POST /cart/add, POST /checkout.</p>
    <p class="normal1"><strong class="screentext">[End of prompt]</strong></p>
    <div class="note">
      <p class="normal1">Swagger or OpenAPI standard is a way to document your API routes. These route specifications can then be visualized, and you get a quick overview of what your API can do. Additionally, there’s something called Swagger UI, a web page that not only lets you see what routes you have in your API but you can make requests and more, to ensure the API is working as it should.</p>
    </div>
    <p class="normal1">Here’s the output, which<a id="_idIndexMarker200" class="calibre3"/> involves both code and documentation:</p>
    <p class="normal1"><strong class="screentext">[Prompt response]</strong></p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-comment"># app.py</span>
<span class="hljs-keyword">import</span> flask
<span class="hljs-keyword">import</span> db
<span class="hljs-keyword">from</span> flasgger <span class="hljs-keyword">import</span> Swagger, swag_from
<span class="hljs-comment"># create app</span>
app = flask.Flask(__name__)
swagger = Swagger(app)
<span class="hljs-comment"># default route</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">index</span>():
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Hello World!'</span>})
<span class="hljs-comment"># product catalog</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/products'</span><span>, methods=[</span><span class="hljs-string">'GET'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-meta">@swag_from(</span><span class="hljs-string">'swagger/products.yml'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">products</span>():
    products = db.get_products()
    <span class="hljs-keyword">return</span> flask.jsonify(products)
<span class="hljs-comment"># shopping cart</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart'</span><span>, methods=[</span><span class="hljs-string">'GET'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-meta">@swag_from(</span><span class="hljs-string">'swagger/cart.yml'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">cart</span>():
    cart = db.get_cart()
    <span class="hljs-keyword">return</span> flask.jsonify(cart)
<span class="hljs-comment"># add product to cart, productId and quantity in body, create cart if needed, else update</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/cart/add'</span><span>, methods=[</span><span class="hljs-string">'POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-meta">@swag_from(</span><span class="hljs-string">'swagger/add_to_cart.yml'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">add_to_cart</span>():
    <span class="hljs-comment"># get product id and quantity from body</span>
    product_id = flask.request.json[<span class="hljs-string">'productId'</span>]
    quantity = flask.request.json[<span class="hljs-string">'quantity'</span>]
    db.add_to_cart(product_id, quantity)
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Added to cart'</span>})
<span class="hljs-comment"># checkout POST, cartId in body</span>
<span class="hljs-meta">@app.route(</span><span class="hljs-string">'/checkout'</span><span>, methods=[</span><span class="hljs-string">'POST'</span><span>]</span><span class="hljs-meta">)</span>
<span class="hljs-meta">@swag_from(</span><span class="hljs-string">'swagger/checkout.yml'</span><span class="hljs-meta">)</span>
<span class="hljs-keyword">def</span> <span class="hljs-meta">checkout</span>():
    <span class="hljs-comment"># get cart id from body</span>
    cart_id = flask.request.json[<span class="hljs-string">'cartId'</span>]
    db.checkout(cart_id)
    <span class="hljs-keyword">return</span> flask.jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Checkout successful'</span>})
<span class="hljs-comment"># start app on port 5000</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>, port=<span class="hljs-attr">5000</span>)
</code></pre>
    <p class="normal1"><strong class="screentext">[End of response]</strong></p>
    <p class="normal1">And it tells us to <a id="_idIndexMarker201" class="calibre3"/>create the following files and folders: </p>
    <pre class="programlisting"><code class="hljs-code">folder: swagger 
products.yml 
file: cart.yml 
file: add_to_cart.yml 
file: checkout.yml 
file: swagger.yml
</code></pre>
    <p class="normal1">Let’s create these files manually and copy the content into them.</p>
    <pre class="programlisting"><code class="hljs-code"><span class="hljs-string">products.yml</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">tags:</span>
  <span class="hljs-meta">-</span> <span class="hljs-string">products</span>
<span class="hljs-attr">responses:</span>
  <span class="hljs-attr">200:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">A</span> <span class="hljs-string">list</span> <span class="hljs-string">of</span> <span class="hljs-string">products</span>
    <span class="hljs-attr">schema:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
      <span class="hljs-attr">items:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
        <span class="hljs-attr">properties:</span>
          <span class="hljs-attr">id:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
          <span class="hljs-attr">name:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
          <span class="hljs-attr">price:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">number</span>
<span class="hljs-string">cart.yml</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">tags:</span>
  <span class="hljs-meta">-</span> <span class="hljs-string">cart</span>
<span class="hljs-attr">responses:</span>
  <span class="hljs-attr">200:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">A</span> <span class="hljs-string">list</span> <span class="hljs-string">of</span> <span class="hljs-string">items</span> <span class="hljs-string">in</span> <span class="hljs-string">the</span> <span class="hljs-string">cart</span>
    <span class="hljs-attr">schema:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
      <span class="hljs-attr">items:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
        <span class="hljs-attr">properties:</span>
          <span class="hljs-attr">id:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
          <span class="hljs-attr">product_id:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
          <span class="hljs-attr">quantity:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
<span class="hljs-string">add_to_cart.yml</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">tags:</span>
  <span class="hljs-meta">-</span> <span class="hljs-string">cart</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-meta">-</span> <span class="hljs-attr">in:</span> <span class="hljs-string">body</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">body</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">schema:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
      <span class="hljs-attr">properties:</span>
        <span class="hljs-attr">productId:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
        <span class="hljs-attr">quantity:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
<span class="hljs-attr">responses:</span>
  <span class="hljs-attr">200:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">Added</span> <span class="hljs-string">to</span> <span class="hljs-string">cart</span>
<span class="hljs-string">checkout.yml</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">tags:</span>
  <span class="hljs-meta">-</span> <span class="hljs-string">checkout</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-meta">-</span> <span class="hljs-attr">in:</span> <span class="hljs-string">body</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">body</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">schema:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
      <span class="hljs-attr">properties:</span>
        <span class="hljs-attr">cartId:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
<span class="hljs-attr">responses:</span>
  <span class="hljs-attr">200:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">successful</span>
</code></pre>
    <p class="normal1">What’s missing is<a id="_idIndexMarker202" class="calibre3"/> installing the <code class="inlinecode">flassger</code> Swagger library:</p>
    <pre class="programlisting2"><code class="hljs-con">pip install flasgger
</code></pre>
    <p class="normal1">Navigate to <code class="inlinecode">http://localhost:5000/apidocs/</code> and you should see Swagger UI.</p>
    <figure class="mediaobject"><img alt="API doc generated by Swagger" src="../Images/B21232_08_04.png" class="calibre19"/></figure>
    <p class="packt_figref">Figure 8.4: API doc generated by Swagger</p>
    <p class="normal1">You should verify that the <a id="_idIndexMarker203" class="calibre3"/>API works as expected by interacting with generated docs and ensure the routes generate the expected output.</p>
    <p class="normal1">It’s definitely possible to keep improving at this point but take a moment to realize how much we created with only prompts and a few lines of code. We have a working API with a database and documentation. We can now focus on improving the code and adding more features.</p>
    <h1 class="heading" id="_idParaDest-168">Assignment</h1>
    <p class="normal">Here’s the suggested assignment for this chapter: A good assignment would be to add more features to the API, such as:</p>
    <ul class="calibre15">
      <li class="bulletlist">Add a new endpoint to get a single product.</li>
      <li class="bulletlist1">Add a new endpoint to remove a product from the cart.</li>
      <li class="bulletlist1">Add a new endpoint to update the quantity of a product in the cart.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal1">You can solve this by just adding the above to Copilot Chat as prompts and see what it generates. Expect both the code and documentation to change.</p>
    </div>
    <h1 class="heading" id="_idParaDest-169">Solution</h1>
    <p class="normal">You can find the solution to this assignment in the GitHub repository: <a href="https://github.com/PacktPublishing/AI-Assisted-Software-Development-with-GitHub-Copilot-and-ChatGPT/tree/main/08" class="calibre3"><span class="calibre3">https://github.com/PacktPublishing/AI-Assisted-Software-Development-with-GitHub-Copilot-and-ChatGPT/tree/main/08</span></a> </p>
    <h1 class="heading" id="_idParaDest-170">Challenge</h1>
    <p class="normal">Improve this API by adding more features. You can use Copilot Chat to help you with this.</p>
    <h1 class="heading" id="_idParaDest-171">Summary</h1>
    <p class="normal">In this chapter, we discussed how to plan out our API. Then we looked at how we can choose Python and Flask for the job but stressed the importance of having contextual knowledge on how to actually build a Web API. In general, you should always know how to do something before you ask an AI assistant to help you with it, at least at a high level.</p>
    <p class="normal1">Then we ended up crafting prompts for the AI assistant to help us with the Web API. We ended up working with our e-commerce site and created a Web API to serve it.</p>
    <p class="normal1">After that, we discussed how to improve the code and add more features to the API.</p>
    <p class="normal1">In the next chapter, we will discuss how to improve our app by adding artificial intelligence to it.</p>
    <h1 class="heading" id="_idParaDest-172">Join our community on Discord </h1>
    <p class="normal">Join our community’s Discord space for discussions with the author and other readers: </p>
    <p class="normal1"><a href="https://packt.link/aicode" class="calibre3"><span class="calibre3">https://packt.link/aicode</span></a></p>
    <p class="normal1"><span class="calibre3"><img alt="" src="../Images/QR_Code510410532445718281.png" class="calibre4"/></span></p>
  </div>
</body></html>