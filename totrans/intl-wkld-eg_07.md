# *第五章*：从边缘摄取和流式传输数据

**边缘计算**可以减少传输到云（或本地数据中心）的数据量，从而节省网络带宽成本。通常，高性能的边缘应用程序需要本地计算、存储、网络、数据分析以及机器学习能力，以在低延迟下处理高保真数据。AWS将基础设施扩展到边缘，超出**区域**和**可用区**，以满足您的工作负载需求。正如您在前几章中学到的，**AWS IoT Greengrass**允许您在设备和网关上运行复杂的边缘应用程序。

在本章中，您将了解适用于边缘工作负载的不同数据设计和转换策略。我们将解释您如何根据**数据速度**（如热、温和冷）、**数据多样性**（如结构化和非结构化）以及**数据量**（如高频或低频）在边缘通过不同的工作流程摄取来自不同传感器的数据。之后，您将学习从边缘将原始和转换后的数据流式传输到不同云服务的方法。到本章结束时，您应该熟悉使用AWS IoT Greengrass进行数据处理。

在本章中，我们将涵盖以下主要主题：

+   定义物联网工作负载的数据模型

+   为边缘设计数据模式

+   了解Stream Manager

+   在边缘构建您的第一个数据编排工作流程

+   从边缘流式传输到云上的数据湖

# 技术要求

本章的技术要求与在[*第二章*](B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032)*，边缘工作负载基础*中概述的要求相同。请参阅该章节中的完整要求。

您可以在此处找到GitHub代码仓库：[https://github.com/PacktPublishing/Intelligent-Workloads-at-the-Edge/tree/main/chapter5](https://github.com/PacktPublishing/Intelligent-Workloads-at-the-Edge/tree/main/chapter5)

# 定义物联网工作负载的数据模型

根据IDC的预测，到2025年，全球数据总量将从2018年的33 **泽字节**（**ZB**）增长到175 ZB。此外，IDC估计到2025年将有416亿个连接的物联网设备或*事物*，产生79.4 ZB的数据（[https://www.datanami.com/2018/11/27/global-datasphere-to-hit-175-zettabytes-by-2025-idc-says/](https://www.datanami.com/2018/11/27/global-datasphere-to-hit-175-zettabytes-by-2025-idc-says/)）。此外，许多其他来源重申，数据和信息是*货币*、*生命线*，甚至是信息行业中的*新石油*。

因此，数据驱动型经济将长期存在，**物联网**（**IoT**）将作为推动者，从大量设备（或端点）如传感器和执行器中获取数据，并生成汇总见解以实现业务成果。因此，作为一名物联网从业者，你应该熟悉**数据建模**的基本概念以及它是如何实现边缘**数据管理**的。

所有行业，如工业、商业、消费、交通、能源、医疗保健等，都在探索新的用例以提高其收入或利润，并为顾客创新。物联网设备，如消费者家庭中的连接中心、道路上的智能停车计费器或连接汽车，将与客户共存，即使在没有互联网连接的情况下也能运行。

这是从过去为企业工作的集中式解决方案到的一种范式转变。例如，一位银行员工可能将他们的工作负载托管在数据中心，但现在他们可以在其分支机构实时监控客户活动（如可疑行为、人流量或ATM中的现金可用性），以更好地服务客户。因此，需要一种新的策略来处理本地生成数据，并能够从边缘处理和流式传输数据到云端。

在本章中，我们将重新思考和评估不同大数据架构在物联网和边缘计算环境下的适用性。我们将考虑的三个领域是数据管理、数据架构模式和反模式。

## 什么是数据管理？

根据**数据管理协会**（**DAMA**）的**数据管理知识体系**（**DMBOK2**），数据管理是制定、执行和监督计划、政策、项目和做法，以在整个生命周期中交付、控制、保护和增强数据和信息资产的价值（更多信息，请参阅[DAMA-DMBOK2](https://technicspub.com/dmbok/)）。

DAMA详细介绍了数据管理框架，如下所示：

![图 5.1 – 数据管理生命周期]

![图片 B17595_05_001.jpg]

![图 5.1 – 数据管理生命周期]

在这里，我们认识到一个机会，即通过边缘计算的相关概念来增强DAMA框架。因此，在本节中，我们将更深入地探讨与数据建模、数据架构和**数据集成与互操作性**（**DII**）相关的原则，我们认为这些原则与边缘计算和物联网相关。

在我们讨论如何建模数据之前，让我们先定义物联网环境下的数据。物联网数据来自不同的传感器、执行器和网关。因此，它们可以以不同的形式出现，如下所示：

+   **结构化数据**：这指的是一种可预测的数据形式；例如，包括设备元数据和设备关系。

+   **半结构化数据**：这是一种具有一定程度变异性和随机性的数据形式；例如，包括传感器和执行器馈送。

+   **非结构化数据**：这是一种具有更高程度变异性和随机性的数据形式；例如，包括原始图像、音频或视频。

现在，让我们讨论如何使用数据建模技术来治理、组织和存储不同形式的数据。

## 什么是数据建模？

**数据建模**是软件工程中的一种常见实践，其中定义并分析数据需求，以支持组织范围内不同信息系统中的业务流程。存在三种不同类型的数据模型：

+   概念数据模型

+   逻辑数据模型

+   物理数据模型

在以下图中，展示了不同建模方法之间的关系：

![图5.2 – 数据建模方法

](img/B17595_05_002.jpg)

图5.2 – 数据建模方法

有趣的事实

在第二次世界大战期间，德国军队使用恩尼格玛机作为所有安全无线通信的主要通信方式。大约80年前，当艾伦·图灵破解了每条消息末尾放置的文本时，他破解了恩尼格玛密码。这有助于解读德国军队的关键秘密信息，并帮助结束世界大战。此外，这种机制导致了通过定义一种解码数据的语言来解锁洞察力的时代，这后来被正式化为数据建模。

对于数据库而言，最常见的数据建模技术是**实体-关系**（ER）模型。在软件工程中，ER模型是一种常见的以图形方式表示不同实体（如人、物体、地点、事件等）之间关系的方法，以便更好地组织信息，推动组织的业务流程。换句话说，ER模型是一种抽象的数据模型，它定义了所需信息的结构，可以独立于任何特定的数据库技术。在本节中，我们将使用ER模型方法解释不同的数据模型。首先，让我们借助用例图来定义客户与其关联的连接HBS中心设备的关联关系：

![图5.3 – 用例图

](img/B17595_05_003.jpg)

图5.3 – 用例图

现在，让我们通过一系列概念性、逻辑性和物理模型来构建ER图：

1.  **概念数据模型**定义了实体及其关系。这是数据建模练习的第一步，由数据架构师等角色使用，从业务利益相关者那里收集初始需求集。例如，*传感器*、*设备*和*客户*是关系中的三个实体，如下所示图所示：![图5.4 – 概念数据模型

    ![img/B17595_05_004.jpg]

    图5.4 – 概念数据模型

1.  然后将**概念模型**转换为**逻辑数据模型**。在数据建模的这个步骤中，使用概念模型作为基础定义了数据结构以及附加属性。

    例如，你可以定义关系中的不同实体的属性，如传感器类型或设备标识符（通常是一个序列号或MAC地址），如下所示。此外，还可能有不同形式的关系，如下所示：

    +   关联是设备和传感器之间的关系。

    +   所有权是客户和设备之间的关系。

    以下图示说明了前面的点：

    ![图5.5 – 逻辑数据模型

    ![img/B17595_05_005.jpg]

    图5.5 – 逻辑数据模型

1.  数据建模的最后一步是从定义的逻辑模型构建一个**物理数据模型**。物理模型通常是数据模型的技术或产品特定实现。例如，你为实体的不同属性定义数据类型，如数字或字符串，这些将在特定供应商的数据库解决方案上部署：

![图5.6 – 物理数据模型

![img/B17595_05_006.jpg]

图5.6 – 物理数据模型

企业已经使用ER建模几十年来自行设计和治理复杂分布式数据解决方案。所有前面的步骤都可以可视化为以下工作流程，这并不局限于任何特定的技术、产品、领域或操作环境（如数据中心、云或边缘）：

![图5.7 – 数据建模流程

![img/B17595_05_007.jpg]

图5.7 – 数据建模流程

现在你已经了解了数据建模的基础，在下一节中，让我们看看如何为物联网工作负载实现这一点。

## 你如何设计物联网的数据模型？

现在，让我们看看如何将前面提到的数据建模概念应用到物联网工作负载中常见的结构化、非结构化和半结构化数据的例子。通常，当我们提到结构化数据的数据建模时，首先想到的是**关系数据库**（**RDBMS**）。然而，对于大多数物联网工作负载，结构化数据通常包括设备与其他实体之间的层次关系。这最好用图或有序键值数据库来展示。同样，对于半结构化数据，在物联网工作负载中，它通常被表示为键值、时间序列或文档存储。

在本节中，我们将向您展示使用NoSQL数据解决方案的数据建模技术，以继续为HBS构建更多功能。建模RDBMS超出了本书的范围。然而，如果您对此感兴趣，互联网上有大量可供参考的材料。

NoSQL数据库旨在为开发者提供从较长的数据库模式设计周期中解脱出来的自由。然而，认为NoSQL数据库缺乏任何数据模型是错误的。设计NoSQL解决方案与RDBMS设计截然不同。对于RDBMS，开发者通常创建一个遵循规范化指南的数据模型，而不关注访问模式。数据模型可以在出现新的业务需求时进行修改，从而导致漫长的发布周期。收集的数据以不同的表格形式组织，包括行、列和参照完整性。相比之下，对于NoSQL解决方案设计，开发者必须知道需要回答的问题才能开始设计模型。从用例反向理解业务查询是至关重要的。因此，在通过关系型或NoSQL数据库进行数据建模时，要记住的一般规则如下：

+   关系型建模主要关注数据的结构。设计原则是*我能得到什么答案？*

+   NoSQL建模主要关注特定于应用程序的访问模式。设计原则是*我要问什么问题？*

    有趣的事实

    NoSQL的常见缩写翻译为*不仅SQL*。这突出了NoSQL不仅支持NoSQL，还可以处理关系型、半结构化和非结构化数据。例如，亚马逊、Facebook、Twitter、LinkedIn和谷歌等组织都设计了不同的NoSQL技术。

在我向您展示一些数据建模的例子之前，让我们了解我们的应用程序（即HBS中心）的访问模式的五个基本属性，这些属性需要考虑以便提出相关的问题：

+   **数据类型**：范围内的数据类型是什么？例如，数据是否与遥测、命令控制或关键事件相关？让我们快速回顾一下这些数据类型的用法：

    a) **遥测**：这是由传感器/执行器（如温度或湿度读数）发出的持续数据流，可以在边缘进行聚合或直接发布到云中进行进一步处理。

    b) **命令与控制**：这些是可执行的消息，例如开关灯，可以在两个设备之间或终端用户与设备之间发生。

    c) **事件**：这些是比常规遥测数据更复杂的场景的数据模式，例如家庭中的网络中断或建筑中的火灾警报。

+   **数据大小**：范围内的数据量是多少？是否需要本地（在边缘）存储和检索数据，或者数据需要传输到不同的数据持久化层（如云上的数据湖）？

+   **数据形状**：从不同的边缘设备（如文本、二进制大对象和图像）生成数据的格式是什么？请注意，图像和视频等不同数据形式可能具有不同的计算需求（例如GPU）。

+   **数据速度**：基于所需延迟，数据处理查询的速度是多少？你有没有热、温或冷的数据路径？

+   **数据一致性**：这些数据中有多少需要强一致性而不是最终一致性？

回答前面的问题将帮助您确定解决方案是否应该基于以下之一：

+   **BASE方法**：**基本可用性**、**软状态**、**最终一致性**，这是NoSQL数据库的典型特征

+   **ACID方法**：**原子性**、**一致性**、**隔离性**和**持久性**，这是关系数据库的典型特征

我们将在下一节更详细地讨论这些概念。

## 在物联网工作负载中选择ACID或BASE

以下表格列出了两种方法之间的一些关键区别。这应该能够帮助你从用例反向做出明智的决定：

![图5.8 – ACID与BASE总结](img/Figure_5.8_ACID_versus_BASE_summary.jpg)

![img/B17595_05_008.jpg](img/B17595_05_008.jpg)

图5.8 – ACID与BASE总结

有趣的事实

ACID和BASE代表了pH谱的相对面。吉姆·格雷在1970年提出了这个想法，并在1981年6月发表了一篇名为《事务概念：优点与局限》的论文。

到目前为止，你已经理解了数据建模和设计方法的基本原理。你一定很好奇如何将这些概念与你之前章节中开发的连接型HBS产品联系起来。让我们看看如何将理论与实践相结合。

你还记得数据建模的第一个阶段吗？

Bingo！概念上是这样的。

## 连接型HBS中心的概念建模

以下图是一个假设的概念模型，描述了HBS中心：

![图5.9 – 连接型HBS的概念数据模型](img/Figure_5.9_A_conceptual_data_model_for_connected_HBS.jpg)

![img/B17595_05_009.jpg](img/B17595_05_009.jpg)

图5.9 – 连接型HBS的概念数据模型

在前面的图中，你可以观察到不同的设备，如灯光、HVAC和洗衣机，是如何安装在一所房子的不同房间里的。现在概念模型已经建立，让我们看看逻辑视图。

## 连接型HBS中心的逻辑建模

为了构建逻辑模型，我们需要问自己最终消费者可能会问的问题类型，例如以下问题：

+   显示设备的状态（例如，洗涤是否完成？）。

+   打开或关闭设备（例如，关闭灯光）。

+   显示设备的读取（例如，现在的温度是多少？）。

+   进行新的读取（例如，冰箱消耗了多少能量？）。

+   显示设备（或设备）在一段时间内的聚合连接状态。

为了回答这些问题，让我们确定我们的最终应用程序的访问模式：

![图5.10 – 连接型HBS的逻辑数据模型](img/Figure_5.10_A_logical_data_model_for_connected_HBS.jpg)

![img/B17595_05_Table_1.jpg](img/B17595_05_Table_1.jpg)

图5.10 – 连接型HBS的逻辑数据模型

现在我们已经捕捉到了数据建模需求的总览，您可以看到解决方案需要以高频率摄取结构化和半结构化格式的数据。此外，它不需要强一致性。因此，使用利用 BASE 方法的 NoSQL 解决方案来设计数据层是有意义的。

## 连接的 HBS 中心物理建模

作为最后一步，我们需要根据收集到的需求定义物理数据模型。为此，我们将定义一个主键和一个二级键。如果您不知道所有属性，您不需要定义所有属性，这是 NoSQL 解决方案的一个关键优势。

### 定义主键

如其名所示，这是表中的一个必需属性，通常被称为**分区键**。在一个表中，没有两个主键应该有相同的值。还有一个**复合键**的概念。它由两个属性组成，一个分区键和一个**排序键**。

在我们的场景中，我们将创建一个具有复合键（如图所示）的`Sensor`表。主键是一个**设备标识符**，排序键是一个时间戳，它使我们能够查询时间范围内的数据：

![图 5.11 – 传感器表中的复合键

![图片](img/B17595_05_011.jpg)

图 5.11 – 传感器表中的复合键

### 定义二级索引

一个**二级索引**允许我们使用不同的键查询表中的数据，除了对主键或复合键的查询。这为您的应用程序在查询不同用例的数据时提供了更多的灵活性。使用二级索引进行查询与直接从表中查询非常相似。

因此，对于二级索引，如以下图表所示，我们选择了主键作为传感器标识符（`sensor_id`）以及时间戳作为排序键：

![图 5.12 – 传感器表中的二级索引

![图片](img/B17595_05_012.jpg)

图 5.12 – 传感器表中的二级索引

### 定义额外的属性

NoSQL 解决方案的关键优势是没有强制性的模式。因此，可以在数据到来时动态创建其他属性。话虽如此，如果开发人员已经知道一些属性，则没有限制将它们包含在数据模型中：

![图 5.13 – 传感器表中的其他属性

![图片](img/B17595_05_013.jpg)

图 5.13 – 传感器表中的其他属性

现在数据层已经存在，让我们创建访问这些数据的接口。

### 定义接口

现在我们将为传感器表创建两个不同的方面。**方面**是一个虚拟结构，它使您能够以不同的视图查看存储在表中的数据。方面可以映射到功能结构，如方法或 API，以执行对表的各种**创建、读取、更新、删除**（**CRUD**）操作：

+   `putItems`：此维度允许写入操作，并在有效载荷中至少需要复合键。

+   `getItems`：此维度允许查询具有所有或选择性属性的项的读取操作。

以下截图展示了`getItems`维度的定义：

![图5.14 – `getItems`维度的定义

![img/B17595_05_014.jpg](img/B17595_05_014.jpg)

图5.14 – `getItems`维度的定义

因此，现在你已经创建了数据模型及其接口。这使你能够理解开发边缘应用所需的数据特性。

# 在边缘设计数据模式

当数据从边缘的不同传感器/执行器通过不同的协议或通道安全地流向网关或云端时，它需要被安全存储、处理和编目以供进一步消费。因此，任何物联网数据架构都需要考虑数据模型（如前所述）、数据存储、数据流模式以及反模式，这些内容将在本节中介绍。让我们从数据存储开始。

## 数据存储

云端的大数据解决方案旨在可靠地存储千兆字节、太字节或艾字节的数据，并能够跨全球多个地理位置进行扩展，以提供高可用性和冗余，以满足企业满足其**恢复时间目标**（**RTO**）和**恢复点目标**（**RPO**）。然而，边缘解决方案，如我们自己的连接HBS中心解决方案，在计算、存储和网络方面资源有限。因此，我们需要设计边缘解决方案以适应不同的时效性、低延迟用例，并将重负载交给云端。**数据湖**是云端的知名模式，它允许集中存储到达的数据，而无需首先对数据进行结构化。之后，可以对数据进行不同类型的分析、机器学习和可视化，以帮助消费者实现更好的业务成果。那么，边缘的数据湖是什么？

让我们介绍一种新的模式，称为*数据池塘*，用于在边缘生成并临时持久化的数据权威来源（即，金数据源）。以下列出了数据池塘的一些特性：

+   数据池塘能够快速并以灵活的方式摄取和消费数据。数据生产者只需要知道将数据推送到哪里，即本地存储、本地流或云端。存储层、模式、摄取频率和数据质量的选择留给数据生产者。

+   数据池塘应该与低成本存储一起工作。通常，物联网设备存储空间较小；因此，只有与边缘操作高度相关的数据才能在本地持久化。其余数据被推送到云端进行进一步处理或丢弃（如果数据噪声大）。

+   数据池塘支持读取时模式。数据池塘中可以有多个流支持多个模式。

+   数据池塘应支持静态和加密中的数据保护机制。实现基于角色的访问控制，允许审计数据从边缘流向云的数据轨迹也是有用的。

下图显示了如何将来自不同传感器/执行器的数据持久化并安全地在数据池塘中管理：

![图5.15 – 边缘数据池塘架构](img/B17595_05_015.jpg)

![img/B17595_05_016.jpg](img/B17595_05_016.jpg)

图5.15 – 边缘数据池塘架构

在前面的数据流中涉及的实体包括以下内容：

+   **数据生产者**：这些是生成数据的实体。这些包括物理实体（如传感器、执行器或相关设备）或逻辑实体（如应用程序），并配置为在数据池塘中存储数据或将数据发布到云中。

+   **数据池塘团队**：通常，数据操作团队定义数据池塘（或湖泊）的数据访问机制，而开发团队支持数据管理。

+   **数据消费者**：边缘和云应用程序使用授权机制从数据池塘（或湖泊）检索数据，以进一步迭代数据并满足业务需求。

下面的截图显示了数据池塘的组织实体：

![图5.16 – 数据池塘的组织实体](img/B17595_05_016.jpg)

![img/B17595_05_017.jpg](img/B17595_05_017.jpg)

图5.16 – 数据池塘的组织实体

现在你已经了解了数据如何在数据池塘中存储，并由不同的实体进行管理或治理。接下来，让我们讨论不同类型的数据以及它们如何被集成。

## 数据集成概念

DII通过不同的层发生，如下所示：

+   **批量**：此层聚合数据生产者生成的数据。目标是通过对多个来源或维度的数据进行整合来提高数据洞察的准确性。

+   **速度**：此层传输数据生产者生成数据。目标是允许以可接受的准确度进行近乎实时的数据分析。

+   **服务**：此层合并批量层和速度层的数据，以便下游消费者或商业用户能够获得全面和增量洞察业务。

下图是DII的说明图：

![图5.17 -- 数据集成与互操作性（DII）](img/B17595_05_015.jpg)

![img/B17595_05_017.jpg](img/B17595_05_017.jpg)

图5.17 -- 数据集成与互操作性（DII）

如您所见，数据流中存在多个层次，通常在大数据世界中使用**提取、转换和加载**（**ETL**）方法或**提取、加载和转换**（**ELT**）方法来实现。ETL方法包括从不同来源提取数据、实施数据质量和一致性标准、转换（或聚合）数据以符合标准格式，以及将数据加载（或交付）到下游应用。

ELT过程是ETL的一种变体，具有类似的步骤。不同之处在于，提取的数据在转换之前加载。这在边缘工作负载中也很常见，因为本地网关可能没有足够的资源在本地进行转换；因此，它在进一步处理之前发布数据。

但这些数据集成模式如何在边缘使用呢？让我们接下来探索这个问题。

## 数据流模式

边缘的ETL流程将包括以下三个不同的步骤：

1.  从传感器/执行器等设备中提取数据

1.  数据转换以清理、过滤或重新结构化数据，以便进一步消费

1.  将数据加载到持久层，如数据池、数据湖或数据仓库以发布数据

对于ELT流程，步骤**2**和**3**将以相反的顺序进行。

智能家居的ETL场景

例如，在智能家居场景中，通常从不同的传感器/执行器中提取数据，然后进行数据转换，这可能包括格式更改、结构更改、语义转换或去重。此外，数据转换允许您过滤掉家庭中的任何噪声数据（想想哭闹的婴儿或嘈杂的宠物），从而减少将所有比特和字节发布到云中的网络费用。基于入侵警报或补充打印机墨盒等用例，数据转换可以批量或实时进行，通过在准备移动到加载步骤之前在临时区域物理存储结果或虚拟存储传输数据到内存中。

这些核心模式（ETL或ELT）随着时间的推移而演变，形成了不同的数据流架构，例如事件驱动、批量、lambda和**复杂事件处理**（**CEP**）。我们将在下一节中解释每个模式。

### 事件驱动（或流式）

边缘应用在事件发生时，在一天中生成和处理数据通常以较小的数据集进行，这是非常常见的。近实时数据处理具有较低的延迟，可以是同步的也可以是异步的。

在异步数据流中，设备（如传感器）在继续处理之前不会等待接收系统确认更新。例如，在智能家居中，一个运动/占用传感器可以根据检测到的事件触发入侵通知，但继续监控而无需等待确认。

相比之下，在实时同步数据流中，源和目标之间不允许存在任何时间延迟或其他差异。例如，在一个智能家居中，如果发生火灾警报，它应该以确定性的方式通知紧急服务。

使用 AWS Greengrass，您可以设计**同步**和**异步**的数据通信。除此之外，在我们构建边缘的多面架构时，在边缘构建多进程或多线程的多语言解决方案以支持不同的低延迟用例是很常见的：

![图 5.18 – 边缘事件驱动架构

![img/B17595_05_018.jpg](img/B17595_05_018.jpg)

图 5.18 – 边缘事件驱动架构

### 微批处理（或聚合处理）

大多数企业执行频繁的批处理，以便为最终用户提供业务洞察。在这种模式下，数据移动将代表在特定时间点的全部数据集，例如在一段时间结束时（如一天、一周或一个月）连接家庭的能源计量读数，或者自上次发送以来值已更改的数据，例如 hvac 读数或触发的火灾警报。通常，批处理系统被设计为随着数据的增长而按比例扩展和增长。然而，由于缺乏动力，这在边缘是不可行的，如前所述。

因此，对于物联网用例，利用微批处理更为常见。在这里，数据是本地存储的，并且以更高的频率进行处理，例如每几秒、几分钟、几小时或几天（跨越几周或几个月）。这允许数据消费者从本地数据源以降低延迟和成本的方式收集见解，即使在断开互联网连接的情况下也是如此。AWS Greengrass 的 **Stream Manager** 功能允许您在边缘执行聚合处理。Stream Manager 带来了关于如何在边缘处理数据的增强功能，例如为多个通道定义带宽和数据优先级、超时行为以及直接导出到不同的 AWS 服务，如 Amazon S3、AWS IoT Analytics、AWS IoT SiteWise 和 Amazon Kinesis 数据流：

![图 5.19 – 边缘微批处理架构

![img/B17595_05_019.jpg](img/B17595_05_019.jpg)

图 5.19 – 边缘微批处理架构

### Lambda 架构

Lambda 架构是一种结合了微批处理和流（近实时）数据处理的方法。它使综合数据可用于下游消费。例如，一个制冷单元、加湿器或制造厂上的任何关键设备都可以在它变得无法运行之前进行监控和修复。因此，对于连接的 HBS 网关解决方案，微批处理将允许您检测长期趋势或故障模式。这种能力反过来可以帮助您的车队运营商为最终消费者推荐预防性或预测性维护。这种工作流程通常被称为数据流分析流程的温暖或冷路径。

另一方面，流处理将允许车队操作员通过遥测数据获得近乎实时的洞察。这将使消费者能够在检测到任何盗窃时采取关键任务行动，例如锁定整个房屋并呼叫紧急服务。这也被称为lambda架构中的热点路径：

![图5.20 – 边缘的lambda架构]

![img/B17595_05_020.jpg]

图5.20 – 边缘的lambda架构

有趣的事实

Lambda架构与AWS Lambda服务无关。这个术语是由Nathan Marz提出的，他在BackType和Twitter等公司从事大数据相关技术工作。这是一个用于描述可扩展和容错的数据处理的设计模式。

## 边缘的数据流反模式

到目前为止，我们已经了解了边缘上常见的数据处理模式。让我们也讨论一些反模式。

### 复杂事件处理（CEP）

事件是从摄入的数据中识别复杂情况的数据模式，例如家庭中的网络中断或建筑中的火灾警报。从几个传感器或设备中检测事件可能更容易；然而，要从不同的来源获得对复杂事件的可见性，并能够捕获状态或触发条件逻辑以快速识别和解决问题，则需要特殊处理。

正是CEP模式发挥作用的地方。CEP可能资源密集，需要扩展到所有大小的数据并成比例增长。因此，它仍然不是边缘上非常常见的模式。在云上，如AWS IoT事件或AWS EventBridge之类的托管服务可以使您更容易地对来自您的物联网设备生成数据进行CEP。

### 批处理

传统上，在批处理中，数据以聚合的形式作为块或文件移动，要么是来自消费者的临时请求，要么是自动的定期计划。数据将是从某个时间点的一个完整集合（称为快照）或一个变化集合（增量）。批处理需要不断扩展底层基础设施以促进数据增长和处理需求。因此，这是一个更适合大数据或云上数据仓库解决方案的模式。话虽如此，对于边缘用例，你仍然可以利用前面解释过的微批处理模式来聚合在资源受限环境中可行的大量数据。

### 复制

在云上，维护不同位置的重复数据集副本是一种常见做法，以提高业务连续性、改善最终用户体验或增强数据弹性。然而，在边缘的背景下，**数据复制**可能很昂贵，因为你可能需要冗余部署。例如，使用连接的HBS中心解决方案，如果网关需要支持用于复制的冗余存储，这将增加硬件的**物料清单**（BOM）成本，你可能会在市场上失去竞争优势。

### 归档

不常使用或未积极使用的数据可以迁移到对组织更具成本效益的替代数据存储解决方案。类似于复制，对于在边缘本地存档数据，需要额外部署硬件资源。这增加了设备的 **物料清单** （**BOM**） 成本，并导致额外的运营开销。因此，通常将数据湖中的转换数据存档到云上的成本效益存储服务，如 **Amazon Glacier**。此后，这些数据可用于本地操作、数据恢复或合规性需求。

# 通过实验室进行实践方法

在本节中，您将学习如何使用不同的 AWS 服务在边缘构建 lambda 架构。以下图表显示了 lambda 架构：

![图 5.21 – 实验室架构](img/B17595_05_021.jpg)

](img/B17595_05_021.jpg)

图 5.21 – 实验室架构

上述工作流程使用以下服务。在本章中，您将完成 *步骤 1–6* （如图 5.21 所示）。这包括设计并部署边缘组件、本地处理和转换数据，以及将数据推送到不同的云服务：

\

![图 5.22 – 实践实验室组件](img/B17595_05_022.jpg)

](img/B17595_05_022.jpg)

图 5.22 – 实践实验室组件

在本实践部分，您的目标将包括以下内容：

1.  构建云资源（即 Amazon Kinesis 数据流、Amazon S3 存储桶和 DynamoDB 表）。

1.  在 Raspberry Pi 上本地构建和部署边缘组件（即工件和配方）。

1.  验证数据是否从边缘流式传输到云（AWS IoT Core）。

## 构建云资源

从 `chapter5/cfn` 文件夹部署 CloudFormation 模板以创建云资源，例如 Amazon S3 存储桶、Kinesis 数据流和 DynamoDB 表。在后续部分需要时，您需要从已部署堆栈的 *资源* 部分替换这些相应的名称。

## 构建边缘组件

现在，让我们跳转到我们的设备来构建和部署所需的边缘组件：

1.  从 Raspberry Pi 设备的终端导航到以下工作目录：

    [PRE0]

1.  使用您选择的编辑器（如 *nano*、*vi* 或 *emac*）打开 Python 脚本：

    [PRE1]

    def read_value(self):

    message = {}

    device_list = ['hvac', 'refrigerator', 'washingmachine']

    device_name = random.choice(device_list)

    if device_name == 'hvac' :

    message['device_id'] = "1"

    message['timestamp'] = float("%.4f" % (time()))

    message['device_name'] = device_name

    message['temperature'] = round(random.uniform(10.0, 99.0), 2)

    message['humidity'] = round(random.uniform(10.0, 99.0), 2)

    elif device_name == 'washingmachine' :

    message['device_id'] = "2"

    message['timestamp'] = float("%.4f" % (time()))

    message['device_name'] = device_name

    message['duty_cycles'] = round(random.uniform(10.0, 99.0), 2)

    else :

    message['device_id'] = "3"

    message['timestamp'] = float("%.4f" % (time()))

    message['device_name'] = device_name

    message['vibration'] = round(random.uniform(100.0, 999.0), 2)

    return message

    [PRE2]

1.  现在，打开以下`publisher`脚本并导航到代码：

    [PRE3]

    TIMEOUT = 10

    ipc_client = awsiot.greengrasscoreipc.connect()

    sensor = DummySensor()

    while True:

    message = sensor.read_value()

    message_json = json.dumps(message).encode('utf-8')

    request = PublishToTopicRequest()

    request.topic = args.pub_topic

    publish_message = PublishMessage()

    publish_message.json_message = JsonMessage()

    publish_message.json_message.message = message

    request.publish_message = publish_message

    operation = ipc_client.new_publish_to_topic()

    operation.activate(request)

    future = operation.get_response()

    future.result(TIMEOUT)

    print("publish")

    time.sleep(5)

    [PRE4]

1.  现在您已经审查了代码，请检查以下配方文件以审查`Publisher`组件所需的访问控制和依赖项：

    [PRE5]

1.  现在我们有了组件和配方，让我们创建一个本地部署：

    [PRE6]

1.  使用以下命令验证组件是否已成功部署（并正在运行）：

    [PRE7]

    以下输出：

    [PRE8]

1.  现在`Publisher`组件已经启动并运行，让我们也审查`Subscriber`组件中的代码：

    [PRE9]

    def setup_subscription():

    request = SubscribeToTopicRequest()

    request.topic = args.sub_topic

    handler = StreamHandler()

    operation = ipc_client.new_subscribe_to_topic(handler)

    future = operation.activate(request)

    future.result(TIMEOUT)

    return operation

    [PRE10]

    def send_cloud(message_json):

    message_json_string = json.dumps(message_json)

    request = PublishToIoTCoreRequest()

    request.topic_name = args.pub_topic

    request.qos = QOS.AT_LEAST_ONCE

    request.payload = bytes(message_json_string,"utf-8")

    publish_message = PublishMessage()

    publish_message.json_message = JsonMessage()

    publish_message.json_message.message = bytes(message_json_string, "utf-8")

    request.publish_message = publish_message

    operation = ipc_client.new_publish_to_iot_core()

    operation.activate(request)

    logger.debug(message_json)

    [PRE11]

1.  现在您已经审查了代码，让我们检查以下配方文件以审查`Subscriber`组件所需的访问控制和依赖项：

    [PRE12]

1.  现在我们有了组件和配方，让我们创建一个本地部署：

    [PRE13]

    以下输出：

    [PRE14]

1.  使用以下命令验证组件是否已成功部署（并正在运行）。现在您应该看到`Publisher`和`Subscriber`组件在本地运行：

    [PRE15]

    以下输出：

    [PRE16]

1.  如您所观察到的，在先前的代码中，`Subscriber`组件不仅会订阅树莓派上的本地`mqtt`主题，它还会开始向AWS IoT Core（在云中）发布数据。让我们从AWS IoT控制台中验证这一点：

    请导航到`hbs/cloudtopic`。 | 点击**订阅**。

    提示

    如果您已更改配方文件中的默认主题名称，请在订阅时使用该名称；否则，您将看不到传入的消息。

1.  现在你已经从边缘到云中有了近乎实时的数据流动，让我们通过集成Stream Manager来处理微批处理流程。此组件将订阅`hbslocal/topic`主题（与订阅者相同）。然而，它将使用Stream Manager功能将数据附加到本地数据流，而不是将其发布到云中。Stream Manager是你在边缘构建lambda架构的关键功能。我们将把代码分解成不同的片段，以便你更好地理解这些概念。因此，让我们导航到工作目录：

    [PRE17]

1.  首先，我们创建一个具有所需属性（如流名称、数据大小、存活时间、持久性、数据刷新、数据保留策略等）的本地流。流中的数据可以保留在本地以供进一步处理，或者可以使用导出定义参数将其导出到云中。在我们的案例中，我们将数据导出到Kinesis，但你也可以使用类似的方法将数据导出到其他支持的服务，如S3、IoT Analytics等：

    [PRE18]

1.  现在流已定义，数据将通过`append_message api`附加：

    [PRE19]

    事实核查

    Stream Manager允许你在边缘部署lambda架构，而无需部署和管理单独的轻量级数据库或流解决方案。因此，你可以减少此解决方案的操作开销或BOM成本。除此之外，作为数据湖的Stream Manager，你可以使用无模式的动态方法在边缘持久化数据（记得BASE吗？）。最后，你可以使用Stream Manager与云数据服务（如IoT Analytics、S3和Kinesis）之间的原生集成将数据发布到云中，而无需编写任何额外的代码。Stream Manager对于具有较大有效负载的用例（如blob、图像或视频，可以轻松通过HTTPS传输）也非常有益。

1.  现在你已经审查了代码，让我们为Stream Manager组件添加更新Kinesis流的必要权限：

    请导航到**AWS IoT控制台**。 | 选择**安全**（在左侧面板上）。 | 选择**角色别名**并选择适当的选项。 | 点击**编辑IAM角色**。 | 附加策略。 | 选择**Amazon Kinesis Full Access**。 | 附加策略。

    请注意，不建议在生产工作负载中使用此类通用策略。这里使用它是为了帮助读者熟悉测试环境中的操作。

1.  在部署此组件之前，让我们快速检查配方文件：

    [PRE20]

    组件配置：

    默认配置：

    子主题: "hbs/localtopic"

    kinesis_stream: "<用cfn替换的kinesis流>"

    访问控制：

    aws.greengrass.ipc.pubsub：

    com.hbs.hub.Aggregator:pubsub:1:

    策略描述: "允许访问订阅主题"

    操作：

    - aws.greengrass#SubscribeToTopic

    - aws.greengrass#PublishToTopic

    资源：

    - "*"

    组件依赖：

    aws.greengrass.StreamManager：

    版本要求："^2.0.0"

    清单：

    - 平台：

    os: all

    生命周期：

    安装：

    pip3 install awsiotsdk numpy -t .

    运行：|

    export PYTHONPATH=$PYTHONPATH:{artifacts:path}/stream_manager

    PYTHONPATH=$PWD python3 -u {artifacts:path}/hbs_aggregator.py --sub-topic="{configuration:/sub_topic}" --kinesis-stream="{configuration:/kinesis_stream}"

    [PRE21]

1.  接下来，在我们已经审查了工件和配方之后，让我们创建一个本地部署：

    [PRE22]

1.  使用以下命令验证组件是否已成功部署（并且正在运行）。您应该观察到以下所有组件在本地运行：

    [PRE23]

    输出如下：

    [PRE24]

1.  `Aggregator`组件将直接从本地流将数据发布到云上的Kinesis流。让我们导航到AWS S3控制台，检查传入的消息是否出现：

    前往**Amazon Kinesis控制台**。| 选择**Data Streams**。| 选择流。| 前往**监控**选项卡。| 检查**传入数据**或**获取记录**等指标。

如果您在图表上看到一些数据点，这意味着数据已成功到达云。

注意

您始终可以在之前部署的CloudFormation堆栈的*资源*或*输出*部分中找到此实验所需的具体资源名称（例如前面的Kinesis流）。

## 验证从边缘到云的数据流

在本节中，您将执行一些最终验证，以确保从边缘组件流出的交易性和批量数据成功持久化在数据湖中：

1.  在上一节的*第19步中，您已经通过指标验证了Kinesis流正在接收数据。现在，让我们了解数据是如何从流层持久化到数据湖的：

    前往**Amazon Kinesis控制台**。| 选择**Delivery Streams**。| 选择相应的交付流。| 点击**配置**选项卡。| 滚动到**目标设置**。| 点击Amazon S3目标下的S3存储桶。

    点击存储桶，深入到存储批量数据的子存储桶中，这些数据以压缩格式存储以帮助优化存储成本。

1.  作为最后一步，导航到`Tables`。然后，选择此实验的表。点击**查看项目**。

    您能看到时间序列数据吗？干得好。

    注意

    如果您无法完成前面的任何步骤，请参阅GitHub仓库中的*故障排除*部分或创建一个问题以获取更多说明。

恭喜！您已经走得很远了，学习如何使用不同的AWS边缘和云服务构建从边缘到云的lambda架构。现在，在我们结束这一章之前，让我们总结一些额外的主题。

# 参考附加主题

除了我们迄今为止所阅读的内容之外，还有一些我想提到的主题。无论何时您有时间，请查看它们，因为它们确实有很多好处，并且可以在网上找到。

## 时间序列数据库

在本章中，我们学习了如何利用NoSQL（键值）数据存储，例如Amazon DynamoDB，来持久化时间序列数据。另一种常见的持久化物联网数据的方式是使用**时间序列数据库**（**TSDB**），例如**Amazon Timestream**或**Apache Cassandra**。正如你所知，时间序列数据由来自不同来源（如传感器和执行器）的测量或事件组成，这些数据按时间索引。因此，建模时间序列数据库的基本原理与之前解释的NoSQL数据解决方案非常相似。所以，剩下显然的问题就是*你如何选择NoSQL和TSDB？*看看以下考虑因素：

+   **考虑数据汇总和数据精度要求**：

    例如，让我看看月度或年度的能源利用率。这需要遍历一系列按时间范围索引的数据点，以计算过去12周内同一时期能源百分比的增加，按周汇总。这种查询可能会在分布式键值存储中变得昂贵。

+   **考虑在一段时间后清除数据**：

    例如，消费者真的关心从每小时到每月的整体能源利用率的精确指标吗？可能不是。因此，更有效的方法是存储短期内的精确数据，然后存储汇总和降采样数据以识别长期趋势。这种功能可以通过一些NoSQL数据库部分实现（例如DynamoDB项目过期功能）。然而，TSDB更适合，因为它们还可以通过不同的方式提供降采样和汇总功能，例如使用物化视图。

## 非结构化数据

你可能好奇，本章的大部分讨论都与结构化和半结构化数据相关。我们根本未触及非结构化数据（如图像、音频和视频）。你说得对。考虑到物联网是物理世界和虚拟世界之间的桥梁，将会有大量非结构化数据需要处理，以用于不同的分析和机器学习用例。

例如，考虑一个场景，你客户家中安装的安全摄像头通过运动传感器检测到任何入侵或意外移动，并开始流式传输周围环境的视频。该视频流将通过你的智能中心或移动设备进行消费。因此，在这种情况下，安全摄像头正在流式传输未结构化的视频数据，作为一个可以存储（如果用户允许）在中心或云对象存储上的P2P流。在[*第7章*](B17595_07_Final_SS_ePub.xhtml#_idTextAnchor138)“边缘机器学习工作负载”中，你将学习从边缘摄取、存储和推断未结构化数据的技术。然而，我们不会深入探讨未结构化数据的建模技术，因为这主要属于数据科学，并且与物联网实践者的日常生活不太相关。

# 摘要

在本章中，你了解了与物联网边缘工作负载常见的数据建模技术、数据存储和数据集成模式。你学习了如何在Greengrass上构建、测试和部署边缘组件。此外，你实现了一个lambda架构来收集、处理和从边缘的不同来源流式传输数据。最后，你通过可视化物联网核心上的传入数据来验证了工作流程。

在下一章中，你将学习如何将所有这些数据在云上提供服务，以生成不同终端用户的有价值见解。

# 知识检查

在进入下一章之前，通过回答以下问题来测试你的知识。答案可以在书的末尾找到：

1.  正误判断：数据建模仅适用于关系型数据库。

1.  执行数据建模练习的好处是什么？

1.  ETL架构对于边缘计算有什么相关性？（提示：考虑lambda。）

1.  正误判断：Lambda架构与AWS Lambda服务相同。

1.  你能想到至少一个在边缘进行数据处理的好处吗？

1.  Greengrass的哪个组件是必需的，以便设备能够正常运行？

1.  正误判断：管理实时处理的流仅适用于云。

1.  你可以实施什么策略来在边缘本地持久化数据，以延长其存储时间？

# 参考文献

查看以下资源，以获取本章讨论的概念的更多信息：

+   *数据管理知识体系*：[https://www.dama.org/cpages/body-of-knowledge](https://www.dama.org/cpages/body-of-knowledge)

+   *亚马逊的Dynamo*：[https://www.allthingsdistributed.com/2007/10/amazons_dynamo.html](https://www.allthingsdistributed.com/2007/10/amazons_dynamo.html)

+   *DynamoDB的NoSQL设计*：[https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-general-nosql-design.html](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-general-nosql-design.html)

+   *Lambda 架构*：[http://lambda-architecture.net/](http://lambda-architecture.net/)

+   *在AWS IoT Greengrass Core上管理数据流*: [https://docs.aws.amazon.com/greengrass/v2/developerguide/manage-data-streams.html](https://docs.aws.amazon.com/greengrass/v2/developerguide/manage-data-streams.html)

+   *AWS上的数据湖*: [https://aws.amazon.com/solutions/implementations/data-lake-solution/](https://aws.amazon.com/solutions/implementations/data-lake-solution/)
