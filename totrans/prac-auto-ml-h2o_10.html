<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer277">
<h1 class="chapter-number" id="_idParaDest-150"><a id="_idTextAnchor196"/>10</h1>
<h1 id="_idParaDest-151"><a id="_idTextAnchor197"/>Working with Plain Old Java Objects (POJOs)</h1>
<p>Companies often use a mix of strategies that can deliver services up to the expected standards. In the case of services that use <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>), they need to consider how they can quickly and easily build, extract, and deploy their models in production without affecting their ongoing service.</p>
<p>Hence, the portability of trained models is very important. How do you take a model object created by your training pipeline built with a certain technology and use that in your prediction pipeline, which might be built using a different technology? Ideally, the model object should be an object that is self-contained and easily distributable.</p>
<p>In the world of software engineering, the Java programming language has been known to be one of the most widely used platform-independent programming languages. When Java compiles a program, it converts it into platform-independent byte code that can be interpreted by any machine that has a <strong class="bold">Java Virtual Machine</strong> (<strong class="bold">JVM</strong>) installed in it. And expanding on this feature, you have <strong class="bold">Plain Old Java Objects</strong> (<strong class="bold">POJOs</strong>).</p>
<p>POJOs are ordinary objects that can be run by any Java program, irrespective of any framework. This makes POJOs very portable when deployed to different kinds of machines. H2O also has provisions to extract trained models in the form of POJOs, which can then be used for deployment in production.</p>
<p>In this chapter, we shall dive deep into understanding what POJOs are and how we can download them after successfully training a model in Python, R, and H2O Flow. Then, we’ll learn how to load a POJO into a simple Java program to make predictions.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Introduction to POJOs</li>
<li>Extracting H2O models as POJOs</li>
<li>Using a H2O model as a POJO</li>
</ul>
<p>By the end of this chapter, you should be able to extract trained models in the form of POJOs using Python, R, or H2O Flow and then load these POJO models into your ML program to make predictions.</p>
<h1 id="_idParaDest-152"><a id="_idTextAnchor198"/>Technical requirements</h1>
<p>For this chapter, you will require the following:</p>
<ul>
<li>The latest version of your preferred web browser.</li>
<li>An <strong class="bold">Integrated Development Environment</strong> (<strong class="bold">IDE</strong>) of your choice.</li>
<li>(Optional) Jupyter Notebook by Project Jupyter (<a href="https://jupyter.org/">https://jupyter.org/</a>)</li>
</ul>
<p>All the experiments conducted in this chapter are performed on Jupyter notebooks to provide you with better visual examples of outputs. You are free to follow along using the same setup or perform the same experiments in environments specific to the language you are using. All the code examples for this chapter can be found on GitHub at <a href="https://github.com/PacktPublishing/Practical-Automated-Machine-Learning-on-H2O/tree/main/Chapter%2010">https://github.com/PacktPublishing/Practical-Automated-Machine-Learning-on-H2O/tree/main/Chapter%2010</a>.</p>
<h1 id="_idParaDest-153"><a id="_idTextAnchor199"/>Introduction to POJOs</h1>
<p><strong class="bold">POJO</strong> is a term<a id="_idIndexMarker1040"/> coined by Martin Fowler, Rebecca Parsons, and Josh Mackenzie in September 2000. It is an ordinary Java object, but what makes it <em class="italic">plain old</em> is not what it should do but rather what it should not do. </p>
<p>A Java object can be a POJO in the following circumstances:</p>
<ul>
<li>The Java object does not extend from any class.</li>
<li>The Java object does not implement any interfaces.</li>
<li>The Java object does not use any annotations from outside.</li>
</ul>
<p>What these three restrictions lead to is a Java object that is not dependent on any other library or object outside of itself and is self-contained d enough to perform its logic on its own. You can easily embed POJOs in any Java environment due to their portability, and because of Java’s platform independence, they can be run on any machine.</p>
<p>H2O can export trained models in the form of POJOs. These POJO models can then be deployed and used to make predictions on inbound data. The only dependency on using POJO models is the <strong class="source-inline">h2o-genmodel.jar</strong> file. This is a JAR file that is needed to compile and run H2O model POJOs. This JAR file is a library that contains the base classes and <strong class="source-inline">GenModel</strong>, a helper class to support Java-generated models, from which the model POJOs are derived. This same library is also responsible for supporting scoring by using the model POJOs. </p>
<p>When working with model POJOs in production, you will need the<a id="_idTextAnchor200"/> <strong class="source-inline">h2o-genmodel.jar</strong> file to compile, deploy, and run your model POJOs. POJOs are simple Java code that are not tied to any particular version of H2O. However, it is still recommended to use the latest version of <strong class="source-inline">h2o-genmodel.jar</strong> since it can load the current version, as well as older versions, of your POJO. You can find detailed documentation regarding <strong class="source-inline">h2o-genmodel.jar</strong> at <a href="https://docs.h2o.ai/h2o/latest-stable/h2o-genmodel/javadoc/index.xhtml">https://docs.h2o.ai/h2o/latest-stable/h2o-genmodel/javadoc/index.xhtml</a>.</p>
<p>Now that we know<a id="_idIndexMarker1041"/> what POJOs are and how H2O model POJOs work, let’s learn how to extract trained H2O models using AutoML as POJOs by using simple examples.</p>
<h1 id="_idParaDest-154"><a id="_idTextAnchor201"/>Extracting H2O models as POJOs</h1>
<p>Models trained <a id="_idIndexMarker1042"/>using H2O’s AutoML can <a id="_idIndexMarker1043"/>also be extracted as POJOs so that they can be deployed to your production systems.</p>
<p>In the following sub-sections, we shall learn how to extract the model POJOs using the Python and R programming languages, as well as how we can extract model POJOs using H2O Flow.</p>
<h2 id="_idParaDest-155"><a id="_idTextAnchor202"/>Downloading H2O models as POJOs in Python</h2>
<p>Let’s see <a id="_idIndexMarker1044"/>how <a id="_idIndexMarker1045"/>we<a id="_idIndexMarker1046"/> can extract H2O models as POJOs using a simple example in Python. We shall use the same Iris flower dataset we have been using so far. This dataset can be found at <a href="https://archive.ics.uci.edu/ml/datasets/iris">https://archive.ics.uci.edu/ml/datasets/iris</a>. </p>
<p>Follow these steps to train models using H2O AutoML in Python. After doing this, you will extract the leader model and download it as a POJO:</p>
<ol>
<li>Import the <strong class="source-inline">h2o</strong> module and start your H2O server: <p class="source-code">import h2o</p><p class="source-code">h2o.init()</p></li>
<li>Import the dataset by passing the location of the dataset in your system. Execute the following command:<p class="source-code"><strong class="bold">data_frame = h2o.import_file("Dataset/iris.data")</strong></p></li>
<li>Set the feature and label names by executing the following commands:<p class="source-code">features = data_frame.columns</p><p class="source-code">label = "C5"</p><p class="source-code">features.remove(label)</p></li>
<li>Initialize <a id="_idIndexMarker1047"/>the <a id="_idIndexMarker1048"/>H2O <a id="_idIndexMarker1049"/>AutoML object and set the <strong class="source-inline">max_model</strong> parameter to <strong class="source-inline">10</strong> and the <strong class="source-inline">seed</strong> value to <strong class="source-inline">5</strong> by executing the following commands:<p class="source-code">aml=h2o.automl.H2OAutoML(max_models=10, seed = 5)</p></li>
<li>Trigger AutoML by passing the training dataset, the feature columns, and the label column as the parameters, as follows:<p class="source-code">aml.train(x = features, y = label, training_frame = data_frame)</p></li>
<li>Once the training has finished, H2O AutoML should have trained a few models and ranked them based on a default ranking performance metric on a leaderboard. The highest ranking model on the leaderboard is called a <em class="italic">leader</em> and can be accessed directly by using the <strong class="source-inline">aml.leader</strong> command. Using this reference, you can download the leader model as a POJO by running the following command:<p class="source-code">h2o.download_pojo(aml.leader, path="~/Downloads/", jar_name="AutoMLModel")</p></li>
</ol>
<p>This should download a model POJO called <strong class="source-inline">AutoMLModel</strong>, as specified in the <strong class="source-inline">jar_name</strong> parameter, to the path specified in the <strong class="source-inline">path</strong> parameter. If the <strong class="source-inline">path</strong> parameter is not set, then H2O will print the model POJO’s details on the console instead of downloading it as a JAR file. </p>
<p>You can also view the contents of the POJO by opening the file in any editor. The file will contain a single public class that is named after your leader model and extends the <strong class="source-inline">GenModel</strong> class, which is a part of <strong class="source-inline">h2o-genmodel.jar</strong>.</p>
<p>Now that<a id="_idIndexMarker1050"/> we<a id="_idIndexMarker1051"/> know <a id="_idIndexMarker1052"/>how we can extract a POJO model using Python, let’s see a similar example in the R programmi<a id="_idTextAnchor203"/>ng language.</p>
<h2 id="_idParaDest-156"><a id="_idTextAnchor204"/>Downloading H2O models as POJOs in R</h2>
<p>Similar<a id="_idIndexMarker1053"/> to how we can<a id="_idIndexMarker1054"/> extract<a id="_idIndexMarker1055"/> a model from the AutoML leaderboard in Python, we can do the same in the R programming language. We shall use the same Iris flower dataset in this section. Follow these steps to train models using H2O AutoML and then extract the leader model to download it as a POJO:</p>
<ol>
<li value="1">Import the <strong class="source-inline">h2o</strong> module and spin up your H2O server: <p class="source-code">library(h2o)</p><p class="source-code">h2o.init()</p></li>
<li>Import the dataset by passing the location of the dataset in your system. Execute the following command:<p class="source-code">data_frame &lt;- h2o.importFile("Dataset/iris.data")</p></li>
<li>Set the feature and label names by executing the following commands:<p class="source-code">label &lt;- "C5"</p><p class="source-code">features &lt;- setdiff(names(data), label)</p></li>
<li>Trigger AutoML by passing the training dataset, the feature columns, and the label columns as parameters. Also, set <strong class="source-inline">max_models</strong> to <strong class="source-inline">10</strong> and the <strong class="source-inline">seed</strong> value to <strong class="source-inline">5</strong>:<p class="source-code">aml &lt;- h2o.automl(x = features, y = label, training_frame = data_frame, max_models=10, seed = 5)</p></li>
<li>Once training is finished and you have the leaderboard, you can access the leader model using <strong class="source-inline">aml@leaderboard</strong>. We can also download the leader model as a POJO by executing the following command:<p class="source-code">h2o.download_pojo(aml@leaderboard, path="~/Downloads/", jar_name="AutoMLModel")</p></li>
</ol>
<p>This will <a id="_idIndexMarker1056"/>start <a id="_idIndexMarker1057"/>downloading <a id="_idIndexMarker1058"/>the <strong class="source-inline">AutoMLModel</strong> model POJO to your device at the specified path.</p>
<p>Now that we know how we can extract a POJO model in the R programming language, let’s see how we can do this in H2O Flow.</p>
<h2 id="_idParaDest-157"><a id="_idTextAnchor205"/>Downloading H2O models as POJOs in H2O Flow</h2>
<p>Downloading<a id="_idIndexMarker1059"/> model <a id="_idIndexMarker1060"/>POJOs <a id="_idIndexMarker1061"/>in H2O Flow is very easy. H2O allows models to be downloaded as POJOs by simply clicking on a button. In <a href="B17298_02.xhtml#_idTextAnchor038"><em class="italic">Chapter 2</em></a>, <em class="italic">Working with H2O Flow (H2O’s Web UI)</em>, in the <em class="italic">Working with Model Training Functions in H2O Flow</em> section, you learned how to access a specific model’s information.</p>
<p>For every model’s information output in H2O Flow, in the <strong class="bold">Actions</strong> subsection, you have an interactive button titled <strong class="bold">Download POJO</strong>, as shown in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer275">
<img alt="Figure 10.1 – Gathering model information with the Download POJO button " height="223" src="image/B17298_10_001.jpg" width="1162"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – Gathering model information with the Download POJO button</p>
<p>You can simply click the <strong class="bold">Download POJO</strong> button to download the model as a POJO. You can download all the models that have been trained by H2O using this interactive button in H2O Flow.</p>
<p>Now that <a id="_idIndexMarker1062"/>we have explored how we can<a id="_idIndexMarker1063"/> download<a id="_idIndexMarker1064"/> models as POJOs in Python, R, and H2O Flow, let’s learn how to use this model POJO to make predictions.</p>
<h1 id="_idParaDest-158"><a id="_idTextAnchor206"/>Using a H2O model as a POJO</h1>
<p>As mentioned<a id="_idIndexMarker1065"/> in the<a id="_idIndexMarker1066"/> previous section, a model POJO can be used on any platform that has a JVM installed. The only dependency is the <strong class="source-inline">h2o-genmodel.jar</strong> file, a JAR file that’s needed to compile and run the model POJO to make predictions.</p>
<p>So, let’s complete an experiment where we can use the model POJO along with the <strong class="source-inline">h2o-genmodel.jar</strong> file to understand how we can use model POJOs in any environment with JVM. We shall write a Java program that imports the <strong class="source-inline">h2o-genmodel.jar</strong> file and uses it to load the model POJO into the program. Once the model POJO has been loaded, we will use it to make predictions on the sample data.</p>
<p>So, let’s start by creating a folder where we can keep the H2O POJO file needed for the experiment and then write some code that uses it. Follow these steps:</p>
<ol>
<li value="1">Open your terminal and create an empty folder by executing the following command:<p class="source-code">mkdir H2O_POJO</p><p class="source-code">cd H2O_POJO</p></li>
<li>Now, copy your model POJO file to the folder by executing the following command:<p class="source-code">mv {path_to_download_location}/{name_of_model_POJO} .</p></li>
</ol>
<p>Keep in mind that you may need to mention the name of the model you downloaded, as well as the path where you have downloaded your model POJO file.</p>
<ol>
<li value="3">Then, you need to download the <strong class="source-inline">h2o-genmodel.jar</strong> file. There are two ways you can do this:<ol><li>You can <a id="_idIndexMarker1067"/>download the <strong class="source-inline">h2o-genmodel.jar</strong> file from your currently running <a id="_idIndexMarker1068"/>local H2O server by running the following command:</li></ol><p class="source-code">curl http://localhost:54321/3/h2o-genmodel.jar &gt; h2o-genmodel.jar</p></li>
</ol>
<p>Keep in mind you will need an actively running H2O server present on <strong class="source-inline">localhost:54321</strong>. If your server is running on a different port, then edit the command with the appropriate port number.</p>
<ol>
<li value="2">The <strong class="source-inline">h2o-genmodel.jar</strong> file is also available as a <strong class="bold">Maven</strong> dependency if you plan to use it in a Maven project. Apache Maven is a project management tool that does automated dependency management. Just add the following lines of code to your Maven <strong class="source-inline">pom.xml</strong> file inside its <strong class="source-inline">dependencies</strong> tag with, preferably, the latest version:</li>
</ol>
<p class="source-code">&lt;dependency&gt;</p>
<p class="source-code">&lt;dependency&gt;</p>
<p class="source-code">        &lt;groupId&gt;ai.h2o&lt;/groupId&gt;</p>
<p class="source-code">        &lt;artifactId&gt;h2o-genmodel&lt;/artifactId&gt;</p>
<p class="source-code">        &lt;version&gt;3.35.0.2&lt;/version&gt;</p>
<p class="source-code">&lt;/dependency&gt;</p>
<p class="source-code">    </p>
<p class="source-code">    </p>
<p class="source-code">    </p>
<p>The Maven repository for this can be found here: https://mvnrepository.com/artifact/ai.h2o/h2o-genmodel.</p>
<ol>
<li value="4">Now, let’s <a id="_idIndexMarker1069"/>create <a id="_idIndexMarker1070"/>a sample Java program that uses the model POJO and the <strong class="source-inline">h2o<a id="_idTextAnchor207"/>-genmodel.jar</strong> file to make predictions on random data values. Create a Java program called <strong class="source-inline">main.java</strong> by executing the following command in your terminal:<p class="source-code"><strong class="bold"><a id="_idTextAnchor208"/>vim main.java</strong></p></li>
</ol>
<p>This should open the <strong class="source-inline">vim</strong> editor for you to write your program in.</p>
<ol>
<li value="5">Let’s start writing our Java program:<ol><li>First, import the necessary dependencies, as follows:</li></ol><p class="source-code">import hex.genmodel.easy.RowData;</p><p class="source-code">import hex.genmodel.easy.EasyPredictModelWrapper;</p><p class="source-code">import hex.genmodel.easy.prediction.*;</p><ol><li value="2">Then, create the <strong class="source-inline">main</strong> class, as follows:</li></ol><p class="source-code">public class main { }</p><ol><li value="3">Inside the <strong class="source-inline">main</strong> class, declare our model POJO’s class name, as follows:</li></ol><p class="source-code">private static final String modelPOJOClassName = "{name_of_model_POJO}";</p><ol><li value="4">Then, create a <strong class="source-inline">main</strong> function inside the <strong class="source-inline">main</strong> class, as follows:</li></ol><p class="source-code">public static void main(String[] args) throws Exception { }</p><ol><li value="5">Inside this <strong class="source-inline">main</strong> function, declare the <strong class="source-inline">rawModel</strong> variable as a <strong class="source-inline">GenModel</strong> object and initialize it by creating it as an instance of your model POJO by passing <strong class="source-inline">modelPOJOClassName</strong>, as follows:</li></ol><p class="source-code">hex.genmodel.GenModel rawModel;</p><p class="source-code">rawModel = (hex.genmodel.GenModel) Class.forName(modelPOJOClassName).getDeclaredConstructor().newInstance();</p><ol><li value="6">Now, let’s <a id="_idIndexMarker1071"/>wrap this <strong class="source-inline">rawModel</strong> object in <a id="_idIndexMarker1072"/>an <strong class="source-inline">EasyPredictModelWrapper</strong> class. This class comes with easy-to-use functions that will make it easy for us to make predictions. Add the following code to your file:</li></ol><p class="source-code">EasyPredictModelWrapper model = new EasyPredictModelWrapper(rawModel);</p><ol><li value="7">Now that we have our <strong class="source-inline">modelPOJO</strong> object loaded and wrapped in <strong class="source-inline">EasyPredictModelWrapper</strong>, let’s create some sample data for making predictions. Since we are using a model trained using the Iris dataset, let’s create a <strong class="source-inline">RowData</strong> that contains <strong class="source-inline">C1</strong>, <strong class="source-inline">C2</strong>, <strong class="source-inline">C3</strong>, and <strong class="source-inline">C4</strong> as features and some appropriate values. Add the following code to your file:</li></ol><p class="source-code">RowData row = new RowData();</p><p class="source-code">row.put("C1", 5.1);</p><p class="source-code">row.put("C2", 3.5);</p><p class="source-code">row.put("C3", 1.4);</p><p class="source-code">row.put("C4", 0.2);</p><ol><li value="8">Now, we need to create a prediction handler object that we can use to store the prediction results. Since the Iris dataset is for a multinomial classification problem, we will create an appropriate multinomial prediction handler object, as follows:</li></ol><p class="source-code">MultinomialModelPrediction predictionResultHandler = model.predictMultinomial(row);</p></li>
</ol>
<p>For different types of problems, you will need to use the appropriate types of prediction handler objects. You can find more information about this at https://docs.h2o.ai/h2o/latest-stable/h2o-genmodel/javadoc/index.xhtml.</p>
<ol>
<li value="9">Now, let’s add some <strong class="source-inline">print</strong> statements so that we can get a clean and easy-to-understand <a id="_idIndexMarker1073"/>output. Add <a id="_idIndexMarker1074"/>the following <strong class="source-inline">print</strong> statements:</li>
</ol>
<p class="source-code">System.out.println("Predicted Class of Iris flower is: " + predictionResultHandler.label);</p>
<p><strong class="source-inline">predictionResultHandler.label</strong> will contain the predicted label value.</p>
<ol>
<li value="10">Let’s also print out the different class probabilities so that we have an idea of what probability the label was predicted:</li>
</ol>
<p class="source-code">System.out.println("Class probabilities are: ");</p>
<p class="source-code">for (int labelClassIndex = 0; labelClassIndex &lt; predictionResultHandler.classProbabilities.length; labelClassIndex++) {</p>
<p class="source-code">        System.out.println(predictionResultHandler.classProbabilities[labelClassIndex]);</p>
<p class="source-code">}</p>
<ol>
<li value="11">Finally, as the most important step, make sure all your braces are closed correctly and save the file.</li>
</ol>
<ol>
<li value="6">Once your file is ready, just compile the file by executing the following command:<p class="source-code"><strong class="bold">javac -cp h2o-genmodel.jar -J-Xmx2g -J-XX:MaxPermSize=128m DRF_1_AutoML_1_20220619_210236.java main.java</strong></p></li>
<li>Once compilation is successful, execute the compiled file by running the following command in your Terminal:<p class="source-code"><strong class="bold">java -cp .:h2o-genmodel.jar main</strong></p></li>
</ol>
<p>You <a id="_idIndexMarker1075"/>should<a id="_idIndexMarker1076"/> get the following output:</p>
<div>
<div class="IMG---Figure" id="_idContainer276">
<img alt="Figure 10.2 – Prediction results from the H2O model POJO implementation " height="156" src="image/B17298_10_002.jpg" width="713"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – Prediction results from the H2O model POJO implementation</p>
<p>As you can see, using the model POJO is very easy – you just need to create the POJO and use it in any regular Java program by implementing the <strong class="source-inline">h2o-genmodel.jar</strong> file.</p>
<p class="callout-heading">Tip</p>
<p class="callout">If you plan on using model POJOs in production, then it is highly recommended that you understand the <strong class="source-inline">h2o-genmodel.jar</strong> library in detail. This library can provide you with lots of features and functionality that can make your deployment experience easy. You can find out more about this library here: <a href="https://docs.h2o.ai/h2o/latest-stable/h2o-genmodel/javadoc/index.xhtml">https://docs.h2o.ai/h2o/latest-stable/h2o-genmodel/javadoc/index.xhtml</a>.</p>
<p>Congratulations! This chapter has helped you understand how to build, extract, and deploy model POJOs <a id="_idIndexMarker1077"/>to make predictions on inbound data. You <a id="_idIndexMarker1078"/>are now one step closer to using H2O in production.</p>
<h1 id="_idParaDest-159"><a id="_idTextAnchor209"/>Summary</h1>
<p>In this chapter, we started by understanding what the usual problems are when working with an ML service in production. We understood how the portability of software, as well as ML models, plays an important role in seamless deployments. We also understood how Java’s platform independence makes it good for deployments and how POJOs play a role in it.</p>
<p>Then, we explored what POJOs are and how they are independently functioning objects in the Java domain. We also learned that H2O has provisions to extract models trained by AutoML in the form of POJOs, which we can use as self-contained ML models capable of making predictions.</p>
<p>Building on top of this, we learned how to extract ML models in H2O as POJOs in Python, R, and H2O Flow. Once we understood how to download H2O ML models as POJOs, we learned how to use them to make predictions.</p>
<p>First, we understood that we need the <strong class="source-inline">h2o-genmodel.jar</strong> library and that it is responsible for interpreting the model POJO in Java. Then, we created an experiment where we downloaded the H2O model POJO and <strong class="source-inline">h2o-genmodel.jar</strong> and created a simple Java program that uses both of these files to make predictions on some sample data; this gave us some practical experience in working with model POJOs.</p>
<p>In the next chapter, we shall explore MOJOs, objects similar to POJOs but with some special benefits that can also be used in production.</p>
</div>
<div>
<div id="_idContainer278">
</div>
</div>
</div></body></html>