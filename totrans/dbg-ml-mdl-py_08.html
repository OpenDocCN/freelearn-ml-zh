<html><head></head><body>
<div id="_idContainer100">
<h1 class="chapter-number" id="_idParaDest-153"><a id="_idTextAnchor243"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-154"><a id="_idTextAnchor244"/><span class="koboSpan" id="kobo.2.1">Controlling Risks Using Test-Driven Development</span></h1>
<p><span class="koboSpan" id="kobo.3.1">There are risks, such as selecting unreliable models, associated with creating models and technologies built on top of our models. </span><span class="koboSpan" id="kobo.3.2">The question is, could we avoid them and better manage the risks associated with machine learning modeling? </span><span class="koboSpan" id="kobo.3.3">In this chapter, we will talk about programming strategies such as unit testing, which could help us not only in developing and selecting better models but also in reducing risks associated </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">with modeling.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.7.1">Test-driven development</span></span></li>
<li><span class="koboSpan" id="kobo.8.1">Machine learning </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">differential testing</span></span></li>
<li><span class="koboSpan" id="kobo.10.1">Tracking machine </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">learning experiments</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.12.1">By the end of this chapter, you will have learned how to reduce the risk of unreliable modeling and software development using unit and differential testing and how to reliably build upon previous attempts in model training and evaluation using machine learning </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">experiment tracking.</span></span></p>
<h1 id="_idParaDest-155"><a id="_idTextAnchor245"/><span class="koboSpan" id="kobo.14.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.15.1">The following requirements should be considered for this chapter as they will help you better understand the concepts, use them in your projects, and practice with the </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">provided code:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.17.1">Python </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">library requirements:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.19.1">pytest</span></strong><span class="koboSpan" id="kobo.20.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">7.2.2</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.22.1">ipytest</span></strong><span class="koboSpan" id="kobo.23.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">0.13.0</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.25.1">mlflow</span></strong><span class="koboSpan" id="kobo.26.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">2.1.1</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.28.1">aif360</span></strong><span class="koboSpan" id="kobo.29.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">0.5.0</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.31.1">shap</span></strong><span class="koboSpan" id="kobo.32.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">0.41.0</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.34.1">sklearn</span></strong><span class="koboSpan" id="kobo.35.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">1.2.2</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">numpy</span></strong><span class="koboSpan" id="kobo.38.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">1.22.4</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">pandas</span></strong><span class="koboSpan" id="kobo.41.1"> &gt;= </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">1.4.4</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.43.1">You will also require basic knowledge of model bias and the definition of bias measures such as the </span><strong class="bold"><span class="koboSpan" id="kobo.44.1">disparate impact </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.45.1">ratio</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.46.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.47.1">DIR</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.49.1">You can find the code files for this chapter on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">at </span></span><a href="https://github.com/PacktPublishing/Debugging-Machine-Learning-Models-with-Python/tree/main/Chapter08"><span class="No-Break"><span class="koboSpan" id="kobo.51.1">https://github.com/PacktPublishing/Debugging-Machine-Learning-Models-with-Python/tree/main/Chapter08</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.52.1">.</span></span></p>
<h1 id="_idParaDest-156"><a id="_idTextAnchor246"/><span class="koboSpan" id="kobo.53.1">Test-driven development for machine learning modeling</span></h1>
<p><span class="koboSpan" id="kobo.54.1">One approach to reducing</span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.55.1"> the risks of developing unreliable models</span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.56.1"> and pushing them to production is test-driven development. </span><span class="koboSpan" id="kobo.56.2">We aim to design unit tests (that is, tests designed to test individual components of software) that reduce the risks of code revision either within the same or in different life cycles. </span><span class="koboSpan" id="kobo.56.3">To better understand this concept, we need to understand what unit tests are and how we can design and use them </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">in Python</span><a id="_idTextAnchor247"/><span class="koboSpan" id="kobo.58.1">.</span></span></p>
<h2 id="_idParaDest-157"><a id="_idTextAnchor248"/><span class="koboSpan" id="kobo.59.1">Unit testing</span></h2>
<p><span class="koboSpan" id="kobo.60.1">Unit tests are designed to test the smallest</span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.61.1"> components, or units, in the code and software we design. </span><span class="koboSpan" id="kobo.61.2">In machine learning modeling, we might have many modules taking care of different steps of a machine learning life cycle, such as data curation and wrangling or model evaluation. </span><span class="koboSpan" id="kobo.61.3">Unit tests help us avoid errors and mistakes, and design our code without the need to worry about whether we made a mistake that will not be detected early on. </span><span class="koboSpan" id="kobo.61.4">Detecting issues in our code early has lower costs and helps us to avoid error pile-ups, which makes the debugging process easier. </span><span class="koboSpan" id="kobo.61.5">Pytest is a Python testing</span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.62.1"> framework that helps us in designing different tests, including unit tests, in machine </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">learning programmi</span><a id="_idTextAnchor249"/><span class="koboSpan" id="kobo.64.1">ng.</span></span></p>
<h3><span class="koboSpan" id="kobo.65.1">Using Pytest</span></h3>
<p><span class="koboSpan" id="kobo.66.1">Pytest is a simple-to-use Python</span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.67.1"> library that we can use to design unit tests by performing the </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.69.1">Identify the component we want to design the unit </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">test for.</span></span></li>
<li><span class="koboSpan" id="kobo.71.1">Define a small operation to be used for testing that component. </span><span class="koboSpan" id="kobo.71.2">For example, if the module is part of data processing, the test can be designed using a very small toy dataset, either real </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">or synthetic.</span></span></li>
<li><span class="koboSpan" id="kobo.73.1">Design a function starting with </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">"test_"</span></strong><span class="koboSpan" id="kobo.75.1"> for the </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">corresponding component.</span></span></li>
<li><span class="koboSpan" id="kobo.77.1">Repeat </span><em class="italic"><span class="koboSpan" id="kobo.78.1">Steps 1</span></em><span class="koboSpan" id="kobo.79.1"> to </span><em class="italic"><span class="koboSpan" id="kobo.80.1">3</span></em><span class="koboSpan" id="kobo.81.1"> for all the components of the code for which we want to design unit tests. </span><span class="koboSpan" id="kobo.81.2">It is better to cover as many components </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">as possible.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.83.1">The designed tests can then be used to test changes in your code. </span><span class="koboSpan" id="kobo.83.2">We will practice unit test design here, using Pytest, for a function that calculates the DIR and returns “unbiased data” or “biased data” using the input thresholds for DIR for </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">bias detection:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.85.1">
import pandas as pdfrom aif360.sklearn.metrics import disparate_impact_ratio
def dir_grouping(data_df: pd.DataFrame,
    sensitive_attr: str, priviledge_group,
    dir_threshold = {'high': 1.2, 'low': 0.8}):
        """
        Categorizing data as fair or unfair according to DIR
        :param data_df: Dataframe of dataset
        :param sensitive_attr: Sensitive attribute under investigation
        :priviledge_group: The category in the sensitive attribute that needs to be considered as priviledged
        :param dir_threshold:
        """
    dir = disparate_impact_ratio(data_df,
        prot_attr=sensitive_attr,
        priv_group=priviledge_group, pos_label=True)
    if dir &lt; dir_threshold['high'] and dir &gt; dir_threshold[
        'low']:
        assessment = "unbiased data"
    else:
        assessment = "biased data"
    return assessment</span></pre>
<p><span class="koboSpan" id="kobo.86.1">Now that we’ve defined an example</span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.87.1"> usage of this function to use for our unit test design, we can select the first 100 rows of the dataset and calculate </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">the DIR:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.89.1">
# calculating DIR for a subset of adult income data in shap libraryimport shap
X,y = shap.datasets.adult()
X = X.set_index('Sex')
X_subset = X.iloc[0:100,]</span></pre>
<p><span class="koboSpan" id="kobo.90.1">According to the calculated DIR, this subset of the data is biased concerning the </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">'Sex'</span></strong><span class="koboSpan" id="kobo.92.1"> attribute. </span><span class="koboSpan" id="kobo.92.2">To design the unit tests, we need to import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">pytest</span></strong><span class="koboSpan" id="kobo.94.1"> library. </span><span class="koboSpan" id="kobo.94.2">But if you are using Jupyter or Colab notebooks for prototyping, you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">ipytest</span></strong><span class="koboSpan" id="kobo.96.1"> to test </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">your code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.98.1">
import pytest# you can use ipytest if you are using Jupyter or Colab notebook
import ipytest
ipytest.autoconfig()</span></pre>
<p><span class="koboSpan" id="kobo.99.1">We must add </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">%%ipytest -qq</span></strong><span class="koboSpan" id="kobo.101.1"> if we’re using </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">pytest</span></strong><span class="koboSpan" id="kobo.103.1"> in a Jupyter or Colab notebook and want to run the tests using </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">ipytest</span></strong><span class="koboSpan" id="kobo.105.1">. </span><span class="koboSpan" id="kobo.105.2">Then, we can define</span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.106.1"> our unit test function, </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">test_dir_grouping()</span></strong><span class="koboSpan" id="kobo.108.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.110.1">
%%ipytest -qqdef test_dir_grouping():
    bias_assessment = dir_grouping(data_df = X_subset,
        sensitive_attr = 'Sex',priviledge_group = 1,
        dir_threshold = {'high':1.2, 'low': 0.8})
    assert bias_assessment == "biased data"</span></pre>
<p><span class="koboSpan" id="kobo.111.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">assert</span></strong><span class="koboSpan" id="kobo.113.1"> command checks whether the result of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">dir_grouping()</span></strong><span class="koboSpan" id="kobo.115.1"> function is “biased data,” as it is supposed to be according to our previous analysis, for the first 100 rows of the dataset. </span><span class="koboSpan" id="kobo.115.2">If the result is different, then the </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">test fails.</span></span></p>
<p><span class="koboSpan" id="kobo.117.1">When you have all the unit tests ready</span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.118.1"> for the components of your software, you can run </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">pytest</span></strong><span class="koboSpan" id="kobo.120.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.121.1">command-line interface</span></strong><span class="koboSpan" id="kobo.122.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.123.1">CLI</span></strong><span class="koboSpan" id="kobo.124.1">) for a specific module, directory, or all of your tests (source: </span><a href="https://docs.pytest.org/en/7.1.x/how-to/usage.html"><span class="koboSpan" id="kobo.125.1">https://docs.pytest.org/en/7.1.x/how-to/usage.html</span></a><span class="koboSpan" id="kobo.126.1">). </span><span class="koboSpan" id="kobo.126.2">For example, if you wrote </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">test_dir_grouping</span></strong><span class="koboSpan" id="kobo.128.1">, as shown in the preceding code, within a Python script called </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">test_script.py</span></strong><span class="koboSpan" id="kobo.130.1">, you can only test that script </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.132.1">
pytest test_script.py</span></pre> <p><span class="koboSpan" id="kobo.133.1">Alternatively, you can run </span><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">pytest</span></strong><span class="koboSpan" id="kobo.135.1"> in a specific directory. </span><span class="koboSpan" id="kobo.135.2">If you have a code base that contains many different modules, you can organize your tests according to the grouping of your main functions and classes and then test each directory, </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.137.1">
# "testdir" could be a directory containing test scriptspytest testdir/</span></pre>
<p><span class="koboSpan" id="kobo.138.1">Instead, if you simply run </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">pytest</span></strong><span class="koboSpan" id="kobo.140.1">, it will execute all the tests in all the files named </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">test_*.py</span></strong><span class="koboSpan" id="kobo.142.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">\*_test.py</span></strong><span class="koboSpan" id="kobo.144.1"> in the current directory and </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">its subdirectories:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.146.1">
pytest</span></pre> <p><span class="koboSpan" id="kobo.147.1">You can also use a Python interpreter to execute the tests </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">pytest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.151.1">
python -m pytest</span></pre> <p><span class="koboSpan" id="kobo.152.1">If you are using Jupyter or Colab Notebook and used </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">ipytest</span></strong><span class="koboSpan" id="kobo.154.1">, you can run Pytest </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.156.1">
ipytest.run()</span></pre> <p><span class="koboSpan" id="kobo.157.1">Now, imagine we execute</span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.158.1"> the designed </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">test_dir_grouping()</span></strong><span class="koboSpan" id="kobo.160.1"> function in one of these ways. </span><span class="koboSpan" id="kobo.160.2">When the test is passed, we will see a message like the following, which tells us 100% of the tests passed. </span><span class="koboSpan" id="kobo.160.3">This is because we are only testing one test and the test passed (</span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.161.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.162.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer097">
<span class="koboSpan" id="kobo.164.1"><img alt="Figure 8.1 – The output of Pytest when the designed test passed" src="image/B16369_08_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.165.1">Figure 8.1 – The output of Pytest when the designed test passed</span></p>
<p><span class="koboSpan" id="kobo.166.1">If we mistakenly change </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">assessment = "biased data"</span></strong><span class="koboSpan" id="kobo.168.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">assessment = "unbiased data"</span></strong><span class="koboSpan" id="kobo.170.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">dir_grouping()</span></strong><span class="koboSpan" id="kobo.172.1"> function, we get the following result instead, which tells us 100% of the tests failed. </span><span class="koboSpan" id="kobo.172.2">This is because we only have one test, which failed in this case (</span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.173.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.174.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer098">
<span class="koboSpan" id="kobo.176.1"><img alt="Figure 8.2 – Failure message after running Pytest" src="image/B16369_08_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.177.1">Figure 8.2 – Failure message after running Pytest</span></p>
<p><span class="koboSpan" id="kobo.178.1">The failure message in </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">pytest</span></strong><span class="koboSpan" id="kobo.180.1"> contains some complementary information that we can use to debug our code. </span><span class="koboSpan" id="kobo.180.2">In this case, it is telling us that in </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">test_dir_grouping()</span></strong><span class="koboSpan" id="kobo.182.1">, it tried</span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.183.1"> to assert the output of </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">test_dir_grouping()</span></strong><span class="koboSpan" id="kobo.185.1">, which was “unbiased data,” with “</span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">biased</span><a id="_idTextAnchor250"/><span class="koboSpan" id="kobo.187.1"> data.”</span></span></p>
<h4><span class="koboSpan" id="kobo.188.1">Pytest fixtures</span></h4>
<p><span class="koboSpan" id="kobo.189.1">When programming</span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.190.1"> for data analysis and machine learning modeling, we need to use data that is in different variables or data objects, comes from a file in our local machine or the cloud, is queried from a database, or comes from a URL in our tests. </span><span class="koboSpan" id="kobo.190.2">Fixtures help us in these processes by removing the need to repeat the same code across our tests. </span><span class="koboSpan" id="kobo.190.3">Attaching a fixture function to a test will run it and return data to the test before each test runs. </span><span class="koboSpan" id="kobo.190.4">Here, we have used examples provided on the Pytest documentation page for fixtures (source: </span><a href="https://docs.pytest.org/en/7.1.x/how-to/fixtures.html"><span class="koboSpan" id="kobo.191.1">https://docs.pytest.org/en/7.1.x/how-to/fixtures.html</span></a><span class="koboSpan" id="kobo.192.1">). </span><span class="koboSpan" id="kobo.192.2">First, let’s define two very simple classes called </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">Fruit</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.194.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">FruitSalad</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.197.1">
# Example of using Pytest fixtures available in </span><a href="https://docs.pytest.org/en/7.1.x/how-to/fixtures.html"><span class="koboSpan" id="kobo.198.1">https://docs.pytest.org/en/7.1.x/how-to/fixtures.html</span></a><span class="koboSpan" id="kobo.199.1">
class Fruit:
    def __init__(self, name):
        self.name = name
        self.cubed = False
    def cube(self):
        self.cubed = True
class FruitSalad:
    def __init__(self, *fruit_bowl):
        self.fruit = fruit_bowl
        self._cube_fruit()
    def _cube_fruit(self):
        for fruit in self.fruit:
            fruit.cube()</span></pre>
<p><span class="koboSpan" id="kobo.200.1">When we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">pytest</span></strong><span class="koboSpan" id="kobo.202.1">, it looks at the parameters</span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.203.1"> in the test function signature and looks for fixtures with the same names as those parameters. </span><span class="koboSpan" id="kobo.203.2">Pytest then runs those fixtures, captures what they return, and passes those objects as arguments to the test function. </span><span class="koboSpan" id="kobo.203.3">We inform Pytest that a function is a fixture by decorating it with </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">@pytest.fixture</span></strong><span class="koboSpan" id="kobo.205.1">. </span><span class="koboSpan" id="kobo.205.2">In the following example, when we run the tests, </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">test_fruit_salad</span></strong><span class="koboSpan" id="kobo.207.1"> requests </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">fruit_bowl</span></strong><span class="koboSpan" id="kobo.209.1">, and Pytest executes </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">fruit_bowl</span></strong><span class="koboSpan" id="kobo.211.1"> and passes the returned object </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">test_fruit_salad</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.215.1">
# Arrange@pytest.fixture
def fruit_bowl():
    return [Fruit("apple"), Fruit("banana")]
def test_fruit_salad(fruit_bowl):
    # Act
    fruit_salad = FruitSalad(*fruit_bowl)
    # Assert
    assert all(fruit.cubed for fruit in fruit_salad.fruit)</span></pre>
<p><span class="koboSpan" id="kobo.216.1">Here are some of the features</span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.217.1"> of fixtures that can help us in designing </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">our tests:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.219.1">Fixtures can request other fixtures. </span><span class="koboSpan" id="kobo.219.2">This helps us in designing smaller fixtures that can be even used as part of other fixtures to make more </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">complex tests.</span></span></li>
<li><span class="koboSpan" id="kobo.221.1">Fixtures can be reused in different tests. </span><span class="koboSpan" id="kobo.221.2">They work like functions to be used in different tests with their own </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">returned results.</span></span></li>
<li><span class="koboSpan" id="kobo.223.1">A test or fixture can request more than one fixture at </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">a time.</span></span></li>
<li><span class="koboSpan" id="kobo.225.1">Fixtures can be requested more than once </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">per test.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.227.1">In test-driven development, we aim to write production-ready code</span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.228.1"> that passes the designed unit tests. </span><span class="koboSpan" id="kobo.228.2">Higher coverage of the modules and components in your code by the designed unit test could help you in revising your code that’s related to any component of a machine learning life cycle with peace </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">of mind.</span></span></p>
<p><span class="koboSpan" id="kobo.230.1">In this section, you learned about unit testing, but other techniques can help us in reliable programming and machine learning model development, such as differential testing. </span><span class="koboSpan" id="kobo.230.2">We will introduce</span><a id="_idTextAnchor251"/> <span class="No-Break"><span class="koboSpan" id="kobo.231.1">this next.</span></span></p>
<h1 id="_idParaDest-158"><a id="_idTextAnchor252"/><span class="koboSpan" id="kobo.232.1">Machine learning differential testing</span></h1>
<p><span class="koboSpan" id="kobo.233.1">Differential testing</span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.234.1"> attempts to check two versions of a piece of software, considered as base and test versions, on the same input and then compare the outputs. </span><span class="koboSpan" id="kobo.234.2">This process helps us identify whether the outputs are the same and identify unexpected differences (Gulzar et al., 2019; </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.235.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.236.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer099">
<span class="koboSpan" id="kobo.238.1"><img alt="Figure 8.3 – Simplified flowchart of differential testing as a process to test the outputs of two implementations of the same process on the same data" src="image/B16369_08_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.239.1">Figure 8.3 – Simplified flowchart of differential testing as a process to test the outputs of two implementations of the same process on the same data</span></p>
<p><span class="koboSpan" id="kobo.240.1">In differential testing, the base version</span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.241.1"> is already verified and considered the approved version, while the test version needs to be checked in comparison with the base version in producing the correct output. </span><span class="koboSpan" id="kobo.241.2">In differential testing, we can also aim to assess whether the observed differences between the outputs of the base and test versions are expected or can </span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">be explained.</span></span></p>
<p><span class="koboSpan" id="kobo.243.1">In machine learning modeling, we can also</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.244.1"> benefit from differential testing when comparing two different implementations of the same algorithms on the same data. </span><span class="koboSpan" id="kobo.244.2">For example, we can use it to compare models built using </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">scikit-learn</span></strong><span class="koboSpan" id="kobo.246.1"> and Spark </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">MLlib</span></strong><span class="koboSpan" id="kobo.248.1"> as two different libraries for machine learning modeling. </span><span class="koboSpan" id="kobo.248.2">If we need to recreate a model using </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">scikit-learn</span></strong><span class="koboSpan" id="kobo.250.1"> and add it to our pipeline while the original model is built in Spark </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">MLlib</span></strong><span class="koboSpan" id="kobo.252.1">, we can use differential testing to assess the outputs and make sure either there is no difference or the differences are expected (Herbold and Tunkel, 2023). </span><em class="italic"><span class="koboSpan" id="kobo.253.1">Table 8.1</span></em><span class="koboSpan" id="kobo.254.1"> provides some examples of algorithms with available classes in both </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">scikit-learn</span></strong><span class="koboSpan" id="kobo.256.1"> and Spark </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">MLlib</span></strong><span class="koboSpan" id="kobo.258.1">. </span><span class="koboSpan" id="kobo.258.2">This approach has been used more extensively to compare models between different deep learning frameworks, such as TensorFlow </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">and PyTorch:</span></span></p>
<table class="No-Table-Style" id="table001-7">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.260.1">Method</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.261.1">scikit-learn</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.262.1">Spark MLlib</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.263.1">Logistic regression</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">LogisticRegression</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">LogisticRegression</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.266.1">Naive Bayes</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">GaussianNB, MultinomialNB</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">NaiveBayes</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.269.1">Decision tree</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">DecisionTree Classifier</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">DecisionTreeClassifier</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.272.1">Random forest</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">RandomForest Classifier</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">RandomForestClassifier</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.275.1">Support </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">vector machine</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">LinearSVC</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">LinearSVC</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.279.1">Multilayer perceptron</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">MLPClassifier</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">MultilayerPerceptron Classifier</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.282.1">Gradient boosting</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">GradientBoosting Classifier</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">GBTClassifier</span></strong></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.285.1">Table 8.1 – Some of the overlapping algorithms and their class names in scikit-learn and Spark MLlib</span></p>
<p><span class="koboSpan" id="kobo.286.1">Experiment tracking</span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.287.1"> is another technique that we can benefit</span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.288.1"> from besides unit and differential testing in our machine </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">learning projects</span><a id="_idTextAnchor253"/><span class="koboSpan" id="kobo.290.1">.</span></span></p>
<h1 id="_idParaDest-159"><a id="_idTextAnchor254"/><span class="koboSpan" id="kobo.291.1">Tracking machine learning experiments</span></h1>
<p><span class="koboSpan" id="kobo.292.1">Keeping track of our machine learning experiments</span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.293.1"> will help us reduce the risks of invalid conclusions and selecting unreliable models. </span><span class="koboSpan" id="kobo.293.2">Experiment tracking in machine learning is about saving the information about the experiments – for instance, the data that has been used – the testing performance and the metric used for performance assessment, and the algorithms and the hyperparameters used for modeling. </span><span class="koboSpan" id="kobo.293.3">Here are some of the important considerations for using a machine learning experiment </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">tracking tool:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.295.1">Can you integrate the tool with your </span><strong class="bold"><span class="koboSpan" id="kobo.296.1">continuous integration/continuous development</span></strong><span class="koboSpan" id="kobo.297.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.298.1">CI/CD</span></strong><span class="koboSpan" id="kobo.299.1">) pipeline and machine learning</span><a id="_idIndexMarker504"/> <span class="No-Break"><span class="koboSpan" id="kobo.300.1">modeling frameworks?</span></span></li>
<li><span class="koboSpan" id="kobo.301.1">Can you reproduce </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">your experiments?</span></span></li>
<li><span class="koboSpan" id="kobo.303.1">Can you easily search through the experiments to find the best models or models with bad or </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">unexpected behaviors?</span></span></li>
<li><span class="koboSpan" id="kobo.305.1">Does it cause any security or </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">privacy issues?</span></span></li>
<li><span class="koboSpan" id="kobo.307.1">Does the tool help you better collaborate in your machine </span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">learning projects?</span></span></li>
<li><span class="koboSpan" id="kobo.309.1">Does the tool let you track hardware (for example, </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">memory) consumption?</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.311.1">Some of the commonly used machine learning experiment tracking tools and their URLs are provided in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.312.1">Table 8.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">:</span></span></p>
<table class="No-Table-Style" id="table002-4">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.314.1">Tool</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.315.1">URL</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.316.1">MLflow Tracking</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://mlflow.org/docs/latest/tracking.html"><span class="No-Break"><span class="koboSpan" id="kobo.317.1">https://mlflow.org/docs/latest/tracking.html</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.318.1">DVC</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://dvc.org/doc/use-cases/experiment-tracking"><span class="No-Break"><span class="koboSpan" id="kobo.319.1">https://dvc.org/doc/use-cases/experiment-tracking</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.320.1">Weights &amp; </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">Biases</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://wandb.ai/site/experiment-tracking"><span class="No-Break"><span class="koboSpan" id="kobo.322.1">https://wandb.ai/site/experiment-tracking</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.323.1">Comet ML</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.comet.com/site/products/ml-experiment-tracking/"><span class="No-Break"><span class="koboSpan" id="kobo.324.1">https://www.comet.com/site/products/ml-experiment-tracking/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.325.1">ClearML</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://clear.ml/clearml-experiment/"><span class="No-Break"><span class="koboSpan" id="kobo.326.1">https://clear.ml/clearml-experiment/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.327.1">Polyaxon</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://polyaxon.com/product/#tracking"><span class="No-Break"><span class="koboSpan" id="kobo.328.1">https://polyaxon.com/product/#tracking</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.329.1">TensorBoard</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.tensorflow.org/tensorboard"><span class="No-Break"><span class="koboSpan" id="kobo.330.1">https://www.tensorflow.org/tensorboard</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.331.1">Neptune AI</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://neptune.ai/product/experiment-tracking"><span class="No-Break"><span class="koboSpan" id="kobo.332.1">https://neptune.ai/product/experiment-tracking</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.333.1">SageMaker</span></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://aws.amazon.com/sagemaker/experiments/"><span class="No-Break"><span class="koboSpan" id="kobo.334.1">https://aws.amazon.com/sagemaker/experiments/</span></span></a></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.335.1">Table 8.2 – Examples of tools for teaching machine learning experiments</span></p>
<p><span class="koboSpan" id="kobo.336.1">Here, we want to practice </span><strong class="bold"><span class="koboSpan" id="kobo.337.1">MLflow Tracking</span></strong><span class="koboSpan" id="kobo.338.1"> in Python. </span><span class="koboSpan" id="kobo.338.2">First, we need to import</span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.339.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">required</span></span><span class="No-Break"><a id="_idIndexMarker506"/></span><span class="No-Break"><span class="koboSpan" id="kobo.341.1"> libraries:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.342.1">
import pandas as pdimport numpy as np
from sklearn.metrics import mean_squared_error, roc_auc_score
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier as RF
from sklearn.datasets import load_breast_cancer
import mlflow
import mlflow.sklearn
np.random.seed(42)</span></pre>
<p><span class="koboSpan" id="kobo.343.1">Then, we must define a function for evaluating the results of the models we would like </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">to test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.345.1">
def eval_metrics(actual, pred, pred_proba):    rmse = np.sqrt(mean_squared_error(actual, pred))
    roc_auc = roc_auc_score(actual, pred_proba)
    return rmse, roc_auc</span></pre>
<p><span class="koboSpan" id="kobo.346.1">Next, we must load the breast cancer dataset from </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">scikit-learn</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.348.1">for modeling:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.349.1">
X, y = load_breast_cancer(return_X_y=True)# split the data into training and test sets. </span><span class="koboSpan" id="kobo.349.2">(0.7, 0.3) split
X_train, X_test, y_train, y_test = train_test_split(X, y,
    test_size = 0.3, random_state=42)</span></pre>
<p><span class="koboSpan" id="kobo.350.1">Now, we are ready to define an experiment </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">mlflow</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.354.1">
experiment_name = "mlflow-randomforest-cancer"existing_exp = mlflow.get_experiment_by_name(
    experiment_name)
if not existing_exp:
    experiment_id = mlflow.create_experiment(
        experiment_name, artifact_location="...")
else:
    experiment_id = dict(existing_exp)['experiment_id']
mlflow.set_experiment(experiment_name)</span></pre>
<p><span class="koboSpan" id="kobo.355.1">Now, we must go over three different</span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.356.1"> numbers of decision trees, or three different numbers of estimators, to build, train, and test three different random forest models on the loaded breast cancer dataset. </span><span class="koboSpan" id="kobo.356.2">All the information from these three runs will be stored within the specified experiment but as different runs. </span><span class="koboSpan" id="kobo.356.3">As you can see in the following code, we use different functionalities </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">mlflow</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">mlflow.start_run</span></strong><span class="koboSpan" id="kobo.361.1">: To start a run as part of </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">an experiment</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">mlflow.log_param</span></strong><span class="koboSpan" id="kobo.364.1">: To log the number of estimators as a hyperparameter of </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">the model</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">mlflow.log_metric</span></strong><span class="koboSpan" id="kobo.367.1">: To log the calculated metric for the performance of the model on the defined </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">test set</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">mlflow.sklearn.log_model</span></strong><span class="koboSpan" id="kobo.370.1">: To log</span><a id="_idIndexMarker508"/> <span class="No-Break"><span class="koboSpan" id="kobo.371.1">the model:</span></span></li>
</ul>
<pre class="source-code"><span class="koboSpan" id="kobo.372.1">
for idx, n_estimators in enumerate([5, 10, 20]):    rf = RF(n_estimators = n_estimators, random_state = 42)
    rf.fit(X_train, y_train)
    pred_probs = rf.predict_proba(X_test)
    pred_labels = rf.predict(X_test)
    # calculating rmse and roc-auc for the randorm forest
    # model predictions on the test set
    rmse, roc_auc = eval_metrics(actual = y_test,
        pred = pred_labels,pred_proba = [
            iter[1]for iter in pred_probs])
    # start mlflow
    RUN_NAME = f"run_{idx}"
    with mlflow.start_run(experiment_id=experiment_id,
        run_name=RUN_NAME) as run:
            # retrieve run id
            RUN_ID = run.info.run_id
        # track parameters
        mlflow.log_param("n_estimators", n_estimators)
        # track metrics
        mlflow.log_metric("rmse", rmse)
        # track metrics
        mlflow.log_metric("roc_auc", roc_auc)
        # track model
        mlflow.sklearn.log_model(rf, "model")</span></pre>
<p><span class="koboSpan" id="kobo.373.1">We can also retrieve an already stored experiment, </span><span class="No-Break"><span class="koboSpan" id="kobo.374.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.375.1">
from mlflow.tracking import MlflowClientesperiment_name = "mlflow-randomforest-cancer"
client = MlflowClient()
# retrieve experiment information
experiment_id = client.get_experiment_by_name(
    esperiment_name).experiment_id</span></pre>
<p><span class="koboSpan" id="kobo.376.1">Then, we can get information on different</span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.377.1"> runs in </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">that experiment:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.379.1">
# retrieve runs information (parameter: 'n_estimators',    metric: 'roc_auc')
experiment_info = mlflow.search_runs([experiment_id])
# extracting run ids for the specified experiment
runs_id = experiment_info.run_id.values
# extracting parameters of different runs
runs_param = [client.get_run(run_id).data.params[
    "n_estimators"] for run_id in runs_id]
# extracting roc-auc across different runs
runs_metric = [client.get_run(run_id).data.metrics[
    "roc_auc"] for run_id in runs_id]</span></pre>
<p><span class="koboSpan" id="kobo.380.1">We can also identify the best runs according to a metric used for model testing, which is ROC-AUC in </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">this example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.382.1">
df = mlflow.search_runs([experiment_id],    order_by=["metrics.roc_auc"])
best_run_id = df.loc[0,'run_id']
best_model_path = client.download_artifacts(best_run_id,
    "model")
best_model = mlflow.sklearn.load_model(best_model_path)
print("Best model: {}".format(best_model))</span></pre>
<p><span class="koboSpan" id="kobo.383.1">This results in the </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">following output:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.385.1">
Best mode: RandomForestClassifier(n_estimators=5,    random_state=42)</span></pre>
<p><span class="koboSpan" id="kobo.386.1">We can also delete runs of a run or an experiment altogether if needed, as follows. </span><span class="koboSpan" id="kobo.386.2">But you need to make sure you wish to delete </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">such information:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.388.1">
# delete runs (make sure you are certain about deleting the runs)for run_id in runs_id:
    client.delete_run(run_id)
# delete experiment (make sure you are certain about deleting the experiment)
client.delete_experiment(experiment_id)</span></pre>
<p><span class="koboSpan" id="kobo.389.1">In this section, you learned about experiment tracking</span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.390.1"> in a machine learning setting. </span><span class="koboSpan" id="kobo.390.2">You will learn more about the techniques you can use for risk control in your machine learning projects in the next </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">two chap</span><a id="_idTextAnchor255"/><span class="koboSpan" id="kobo.392.1">ters.</span></span></p>
<h1 id="_idParaDest-160"><a id="_idTextAnchor256"/><span class="koboSpan" id="kobo.393.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.394.1">In this chapter, you learned about test-driven development using unit testing to control risks in your machine learning development projects. </span><span class="koboSpan" id="kobo.394.2">You learned about unit testing in Python using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">pytest</span></strong><span class="koboSpan" id="kobo.396.1"> library. </span><span class="koboSpan" id="kobo.396.2">We also briefly reviewed the concept of differential testing, which helps you in comparing different versions of your machine learning modules and software. </span><span class="koboSpan" id="kobo.396.3">Later, you learned about model experiment tracking as an important tool that not only facilitates your model experimentations and selection but also helps you in risk control in your machine learning projects. </span><span class="koboSpan" id="kobo.396.4">You practiced using </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">mlflow</span></strong><span class="koboSpan" id="kobo.398.1"> in Python as one of the widely used machine learning experiment tracking tools. </span><span class="koboSpan" id="kobo.398.2">Now, you know how to develop reliable models and programming modules through test-driven development and </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">experiment tracking.</span></span></p>
<p><span class="koboSpan" id="kobo.400.1">In the next chapter, you will learn about strategies to test models, assess their qualities, and monitor their performance in production. </span><span class="koboSpan" id="kobo.400.2">You will learn about practical methods for model monitoring, integration testing, and model pipeline and </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">infrastructure tes</span><a id="_idTextAnchor257"/><span class="koboSpan" id="kobo.402.1">ting.</span></span></p>
<h1 id="_idParaDest-161"><a id="_idTextAnchor258"/><span class="koboSpan" id="kobo.403.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.404.1">How does </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">pytest</span></strong><span class="koboSpan" id="kobo.406.1"> help you in developing code modules in your machine </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">learning projects?</span></span></li>
<li><span class="koboSpan" id="kobo.408.1">How do </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">pytest</span></strong><span class="koboSpan" id="kobo.410.1"> fixtures help you in </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">pytest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">?</span></span></li>
<li><span class="koboSpan" id="kobo.414.1">What is differential testing and when do you </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">need it?</span></span></li>
<li><span class="koboSpan" id="kobo.416.1">What is </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">mlflow</span></strong><span class="koboSpan" id="kobo.418.1"> and how does it help you in your machine learning </span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">modeling proj</span><a id="_idTextAnchor259"/><span class="koboSpan" id="kobo.420.1">ects?</span></span></li>
</ol>
<h1 id="_idParaDest-162"><a id="_idTextAnchor260"/><span class="koboSpan" id="kobo.421.1">References</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.422.1">Herbold, Steffen, and Steffen Tunkel. </span><em class="italic"><span class="koboSpan" id="kobo.423.1">Differential testing for machine learning: an analysis for classification algorithms beyond deep learning</span></em><span class="koboSpan" id="kobo.424.1">. </span><span class="koboSpan" id="kobo.424.2">Empirical Software Engineering 28.2 (</span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">2023): 34.</span></span></li>
<li><span class="koboSpan" id="kobo.426.1">Lichman, M. </span><span class="koboSpan" id="kobo.426.2">(2013). </span><em class="italic"><span class="koboSpan" id="kobo.427.1">UCI Machine Learning Repository</span></em><span class="koboSpan" id="kobo.428.1"> [</span><a href="https://archive.ics.uci.edu/ml"><span class="koboSpan" id="kobo.429.1">https://archive.ics.uci.edu/ml</span></a><span class="koboSpan" id="kobo.430.1">]. </span><span class="koboSpan" id="kobo.430.2">Irvine, CA: University of California, School of Information and </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">Computer Science.</span></span></li>
<li><span class="koboSpan" id="kobo.432.1">Gulzar, Muhammad Ali, Yongkang Zhu, and Xiaofeng Han. </span><em class="italic"><span class="koboSpan" id="kobo.433.1">Perception and practices of differential testing</span></em><span class="koboSpan" id="kobo.434.1">. </span><span class="koboSpan" id="kobo.434.2">2019 IEEE/ACM 41st International Conference on Software Engineering: Software Engineering in Practice (ICSE-SEIP). </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">IEEE, 2019.</span></span></li>
</ul>
</div>
</body></html>