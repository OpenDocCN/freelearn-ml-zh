<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Movie Recommendation System Web Application">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07"/>&#13;
 Chapter 7. Movie Recommendation System Web Application</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>The purpose of this chapter is to explain a real case example of the recommendation system in action, using the Django framework. We are going to implement a movie recommendation system in which each user that subscribes to the service will receive suggested movies based on his preferences as we have discussed in <a class="link" title="Chapter 5. Recommendation Systems" href="text00037.html#page">Chapter 5</a>&#13;
 , <span class="emphasis">&#13;
<em>Recommendation systems</em>&#13;
</span>&#13;
 , also we are going to use the same data which consists of 603 movies rated more than 50 times by 942 users. In order to receive recommendations, each user has to rate a certain number of movies, so an information retrieval system (<a class="link" title="Chapter 4. Web Mining Techniques" href="text00032.html#ch04">Chapter 4</a>&#13;
 , <span class="emphasis">&#13;
<em>Web-mining techniques</em>&#13;
</span>&#13;
 ) to search the movies to rate is implemented. The different parts of the Django application are going to be discussed: settings, models, user login/logout, commands, information retrieval system, recommendation systems, an admin interface and APIs (all the code is available on the GitHub of the author <code class="literal">chapter_7</code>&#13;
 folder at <a class="ulink" href="https://github.com/ai2010/machine_learning_for_the_web/tree/master/chapter_7">https://github.com/ai2010/machine_learning_for_the_web/tree/master/chapter_7</a>&#13;
 ). Since <a class="link" title="Chapter 6. Getting Started with Django" href="text00046.html#ch06">Chapter 6</a>&#13;
 , <span class="emphasis">&#13;
<em>Basics of Django: a simple web framework</em>&#13;
</span>&#13;
 just introduced the main features of Django, whenever a new feature is employed a technical explanation is also provided. Now we can start describing the different settings and the initial setup to run the application.</p>&#13;
<div class="section" title="Application setup">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec43"/>&#13;
 Application setup</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>We <a id="id546" class="indexterm"/>&#13;
 create and start Django as usual:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>django-admin startproject server_movierecsys</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
<p>and from the <code class="literal">server_movierecsys</code>&#13;
 folder we start the application:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>python manage.py startapp books_recsys_app</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
<p>Now the <code class="literal">settings.py</code>&#13;
 needs to be configured. As we see in <a class="link" title="Chapter 6. Getting Started with Django" href="text00046.html#ch06">Chapter 6</a>&#13;
 , <span class="emphasis">&#13;
<em>Basics of Django: a simple web framework</em>&#13;
</span>&#13;
 we set the installed apps, HTML templates, a layout formatting folder, and an SQLite database:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">INSTALLED_APPS = (
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'rest_framework_swagger',
    'books_recsys_app',
)

TEMPLATE_DIRS = (
    os.path.join(BASE_DIR, 'templates'),
)
STATIC_URL = '/static/'
STATICFILES_DIRS = ( os.path.join(BASE_DIR, "static"), )
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}</pre>&#13;
</div>&#13;
<p>Apart <a id="id547" class="indexterm"/>&#13;
 from the standard apps, and the rest framework (swagger), the <code class="literal">books_recsys_app</code>&#13;
 has been included in the installed apps list.</p>&#13;
<p>In this case, we need to load data persistently in the memory so that the user experience is improved by not calculating or retrieving data at each user request. To save data or the results of expensive calculations in the memory, we set up the cache system of Django in <code class="literal">settings.py</code>&#13;
 :</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.filebased.FileBasedCache',
        'LOCATION': '/var/tmp/django_cache',
        'TIMEOUT': None,
    }
}</pre>&#13;
</div>&#13;
<p>We have chosen the <span class="strong">&#13;
<strong>File Based Cache</strong>&#13;
</span>&#13;
 cache type stored in <code class="literal">/var/tmp/django_cache</code>&#13;
 and a <code class="literal">None</code>&#13;
 timeout which means the data in the cache will never expire.</p>&#13;
<p>To use the<a id="id548" class="indexterm"/>&#13;
 admin interface, we set up the <code class="literal">superuser</code>&#13;
 account through the command:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>python manage.py createsuperuser (admin/admin)</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
<p>The application is live at <code class="literal">http://localhost:8000/</code>&#13;
 by typing:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>python manage.py runserver</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
</div>&#13;
</div>&#13;

<div class="section" title="Models">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec44"/>&#13;
 Models</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>In this application, we need to<a id="id549" class="indexterm"/>&#13;
 store the data related to each movie and the movies' ratings from each user of the website. We set up three models:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">class UserProfile(models.Model):
    user = models.ForeignKey(User, unique=True)
    array = jsonfield.JSONField()
    arrayratedmoviesindxs = jsonfield.JSONField()
    lastrecs = jsonfield.JSONField()

    def __unicode__(self):
            return self.user.username

    def save(self, *args, **kwargs):
        create = kwargs.pop('create', None)
        recsvec = kwargs.pop('recsvec', None)
        print 'create:',create
        if create==True:
            super(UserProfile, self).save(*args, **kwargs)
        elif recsvec!=None:
             self.lastrecs = json.dumps(recsvec.tolist())
             super(UserProfile, self).save(*args, **kwargs)
        else:
            nmovies = MovieData.objects.count()
            array = np.zeros(nmovies)
            ratedmovies = self.ratedmovies.all()
            self.arrayratedmoviesindxs = json.dumps([m.movieindx for m in ratedmovies])
            for m in ratedmovies:
                array[m.movieindx] = m.value
            self.array = json.dumps(array.tolist())
            super(UserProfile, self).save(*args, **kwargs)
    
class MovieRated(models.Model):
    user = models.ForeignKey(UserProfile, related_name='ratedmovies')
    movie = models.CharField(max_length=100)
    movieindx = models.IntegerField(default=-1)
    value = models.IntegerField()
    
class MovieData(models.Model):
    title = models.CharField(max_length=100)
    array = jsonfield.JSONField()
    ndim = models.IntegerField(default=300)
    description = models.TextField()</pre>&#13;
</div>&#13;
<p>The <a id="id550" class="indexterm"/>&#13;
 model <code class="literal">MovieData</code>&#13;
 stores the data for each movie: title, description, and vector representation (<code class="literal">ndim</code>&#13;
 is the dimension of the vector representation). <code class="literal">MovieRated</code>&#13;
 records each movie rated by the user logged in (each object <code class="literal">MovieRated</code>&#13;
 is associated with has a <code class="literal">UserProfile</code>&#13;
 that utilizes the website). The <code class="literal">UserProfile</code>&#13;
 model stores all the users that sign up to the website, so they can rate movies and receive recommendations. Each <code class="literal">UserProfile</code>&#13;
 extends the default Django user model by adding the <code class="literal">array</code>&#13;
 field, which stores all the movie's ratings from the <code class="literal">user,</code>&#13;
 and the <code class="literal">recsvec</code>&#13;
 field which stores his last recommendations: the <code class="literal">save</code>&#13;
 function is overridden to fill the <code class="literal">array</code>&#13;
 field with all the <code class="literal">MovieRated</code>&#13;
 objects associated with the user (if the <code class="literal">else</code>&#13;
 statement is <code class="literal">true</code>&#13;
 ), and to fill the <code class="literal">lastrecs</code>&#13;
 field with the last recommendations (<code class="literal">else if</code>&#13;
 statement). Note that the <code class="literal">MovieRated</code>&#13;
 model has a <code class="literal">UserProfile</code>&#13;
 foreign key with the <code class="literal">related_name</code>&#13;
 equal to <code class="literal">ratedmovies</code>&#13;
 : in the <code class="literal">save</code>&#13;
 function of the <code class="literal">UserProfile</code>&#13;
 model, <code class="literal">self.ratedmovies.all()</code>&#13;
 refers to all the <code class="literal">RatedMovie</code>&#13;
 objects that have the same <code class="literal">UserProfile</code>&#13;
 value. The field <code class="literal">arrayratedmoviesindxs</code>&#13;
 on the <code class="literal">UserProfile</code>&#13;
 model records all the movies rated by the user and it is used by the API of the application.</p>&#13;
<p>To write these data structures on the database we need to run:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>python manage.py makemigrations</strong>&#13;

</span>&#13;


<span class="strong">
<strong>python manage.py migrate</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
</div>&#13;

<div class="section" title="Commands">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec45"/>&#13;
 Commands</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>The commands<a id="id551" class="indexterm"/>&#13;
 used in this application are needed to load the data into the memory (cache) and make the user experience fast. Although the movie database is the same used in <a class="link" title="Chapter 4. Web Mining Techniques" href="text00032.html#ch04">Chapter 4</a>&#13;
 , <span class="emphasis">&#13;
<em>Web mining techniques</em>&#13;
</span>&#13;
 (that is 603 movies rated more than 50 times by 942 users), each movie needs a description to set up an information retrieval system on the movies to rate. The first command we develop takes all the movie titles in the utility matrix used in <a class="link" title="Chapter 4. Web Mining Techniques" href="text00032.html#ch04">Chapter 4</a>&#13;
 , <span class="emphasis">&#13;
<em>Web Mining Techniques</em>&#13;
</span>&#13;
 and collects the corresponding descriptions from <span class="strong">&#13;
<strong>Open Movie Database</strong>&#13;
</span>&#13;
 (<span class="strong">&#13;
<strong>OMDb</strong>&#13;
</span>&#13;
 ) online <a id="id552" class="indexterm"/>&#13;
 service:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from django.core.management.base import BaseCommand
import os
import optparse
import numpy as np
import json
import pandas as pd
import requests
class Command(BaseCommand):

    option_list = BaseCommand.option_list + (
            optparse.make_option('-i', '--input', dest='umatrixfile',
                                 type='string', action='store',
                                 help=('Input utility matrix')),   
            optparse.make_option('-o', '--outputplots', dest='plotsfile',
                                 type='string', action='store',
                                 help=('output file')),  
            optparse.make_option('--om', '--outputumatrix', dest='umatrixoutfile',
                                 type='string', action='store',
                                 help=('output file')),            
        )
        
        
    def getplotfromomdb(self,col,df_moviesplots,df_movies,df_utilitymatrix):
        string = col.split(';')[0]
        
        title=string[:-6].strip()
        year = string[-5:-1]      
        plot = ' '.join(title.split(' ')).encode('ascii','ignore')+'. '
        
        url = "http://www.omdbapi.com/?t="+title+"&amp;y="+year+"&amp;plot=full&amp;r=json"
        
        headers={"User-Agent": "Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2049.0 Safari/537.36"}
        r = requests.get(url,headers=headers)
        jsondata =  json.loads(r.content)
        if 'Plot' in jsondata:
            #store plot + title
            plot += jsondata['Plot'].encode('ascii','ignore')

        if plot!=None and plot!='' and plot!=np.nan and len(plot)&gt;3:#at least 3 letters to consider the movie
            df_moviesplots.loc[len(df_moviesplots)]=[string,plot]
            df_utilitymatrix[col] = df_movies[col]
            print len(df_utilitymatrix.columns)

        return df_moviesplots,df_utilitymatrix
    
    def handle(self, *args, **options):
        pathutilitymatrix = options['umatrixfile']
        df_movies = pd.read_csv(pathutilitymatrix)
        movieslist = list(df_movies.columns[1:])

        df_moviesplots = pd.DataFrame(columns=['title','plot'])
        df_utilitymatrix = pd.DataFrame()
        df_utilitymatrix['user'] = df_movies['user']

        for m in movieslist[:]:
            df_moviesplots,df_utilitymatrix=self.getplotfromomdb(m,df_moviesplots,df_movies,df_utilitymatrix)

        outputfile = options['plotsfile']
        df_moviesplots.to_csv(outputfile, index=False)
        outumatrixfile = options['umatrixoutfile']
        df_utilitymatrix.to_csv(outumatrixfile, index=False)</pre>&#13;
</div>&#13;
<p>The<a id="id553" class="indexterm"/>&#13;
 command syntax is:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>python manage.py --input=utilitymatrix.csv --outputplots=plots.csv –outputumatrix='umatrix.csv'</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
<p>Each movie title contained in the <code class="literal">utilitymatrix</code>&#13;
 file is used by the <code class="literal">getplotfromomdb</code>&#13;
 function to retrieve the movie's description (<code class="literal">plot</code>&#13;
 ) from the website <a class="ulink" href="http://www.omdbapi.com/">http://www.omdbapi.com/</a>&#13;
 using the requests in the Python module. The descriptions (and <code class="literal">titles</code>&#13;
 ) of the movies are then saved in a CSV file (<code class="literal">outputplots</code>&#13;
 ) together with the corresponding utility matrix (<code class="literal">outputumatrix</code>&#13;
 ).</p>&#13;
<p>The other command will take the movie's descriptions and create an information retrieval <a id="id554" class="indexterm"/>&#13;
 system (<span class="strong">&#13;
<strong>Term Frequency, Inverse Document Frequency</strong>&#13;
</span>&#13;
 (<span class="strong">&#13;
<strong>TF-IDF</strong>&#13;
</span>&#13;
 ) model) to allow the user to find movies typing some relevant words. This tf-idf model is then saved in the Django cache together with the initial recommendation systems models (<span class="strong">&#13;
<strong>CF item-based</strong>&#13;
</span>&#13;
 and <span class="strong">&#13;
<strong>log-likelihood</strong>&#13;
</span>&#13;
 <a id="id555" class="indexterm"/>&#13;
 ratio). The code<a id="id556" class="indexterm"/>&#13;
 is as follows:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from django.core.management.base import BaseCommand
import os
import optparse
import numpy as np
import pandas as pd
import math
import json
import copy
from BeautifulSoup import BeautifulSoup
import nltk
from nltk.corpus import stopwords
from nltk.tokenize import WordPunctTokenizer
tknzr = WordPunctTokenizer()
#nltk.download('stopwords')
stoplist = stopwords.words('english')
from nltk.stem.porter import PorterStemmer
stemmer = PorterStemmer()
from sklearn.feature_extraction.text import TfidfVectorizer
from books_recsys_app.models import MovieData
from django.core.cache import cache

class Command(BaseCommand):

    option_list = BaseCommand.option_list + (
            optparse.make_option('-i', '--input', dest='input',
                                 type='string', action='store',
                                 help=('Input plots file')),
            optparse.make_option('--nmaxwords', '--nmaxwords', dest='nmaxwords',
                                 type='int', action='store',
                                 help=('nmaxwords')),
            optparse.make_option('--umatrixfile', '--umatrixfile', dest='umatrixfile',
                                 type='string', action='store',
                                 help=('umatrixfile')), 
        )
        
    def PreprocessTfidf(self,texts,stoplist=[],stem=False):
        newtexts = []
        for i in xrange(len(texts)):
            text = texts[i]
            if stem:
               tmp = [w for w in tknzr.tokenize(text) if w not in stoplist]
            else:
               tmp = [stemmer.stem(w) for w in [w for w in tknzr.tokenize(text) if w not in stoplist]]
            newtexts.append(' '.join(tmp))
        return newtexts
    
    def handle(self, *args, **options):
        input_file = options['input']
        
        df = pd.read_csv(input_file)
        tot_textplots = df['plot'].tolist()
        tot_titles = df['title'].tolist()
        nmaxwords=options['nmaxwords']
        vectorizer = TfidfVectorizer(min_df=0,max_features=nmaxwords)
        processed_plots = self.PreprocessTfidf(tot_textplots,stoplist,True)
        mod_tfidf = vectorizer.fit(processed_plots)
        vec_tfidf = mod_tfidf.transform(processed_plots)
        ndims = len(mod_tfidf.get_feature_names())
        nmovies = len(tot_titles[:])
        
        #delete all data
        MovieData.objects.all().delete()
        
        matr = np.empty([1,ndims])
        titles = []
        cnt=0
        for m in xrange(nmovies):
            moviedata = MovieData()
            moviedata.title=tot_titles[m]
            moviedata.description=tot_textplots[m]
            moviedata.ndim= ndims
            moviedata.array=json.dumps(vec_tfidf[m].toarray()[0].tolist())
            moviedata.save()
            newrow = moviedata.array
            if cnt==0:
                matr[0]=newrow
            else:
                matr = np.vstack([matr, newrow])
            titles.append(moviedata.title)
            cnt+=1
        #cached
        cache.set('data', matr)
        cache.set('titles', titles)
        cache.set('model',mod_tfidf)

        
        #load the utility matrix
        umatrixfile = options['umatrixfile']
        df_umatrix = pd.read_csv(umatrixfile)
        Umatrix = df_umatrix.values[:,1:]
        cache.set('umatrix',Umatrix)
        #load rec methods... 
        cf_itembased = CF_itembased(Umatrix)
        cache.set('cf_itembased',cf_itembased)
        llr = LogLikelihood(Umatrix,titles)
        cache.set('loglikelihood',llr)
        
from scipy.stats import pearsonr
from scipy.spatial.distance import cosine 
def sim(x,y,metric='cos'):
    if metric == 'cos':
       return 1.-cosine(x,y)
    else:#correlation
       return pearsonr(x,y)[0]
       
class CF_itembased(object):
...        
class LogLikelihood(object):
...</pre>&#13;
</div>&#13;
<p>To run the <a id="id557" class="indexterm"/>&#13;
 command the syntax is:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>python manage.py load_data --input=plots.csv --nmaxwords=30000  --umatrixfile=umatrix.csv</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
<p>The input parameter takes the movie's descriptions obtained using the <code class="literal">get_plotsfromtitles</code>&#13;
 command and creates a <code class="literal">tf-idf</code>&#13;
 model (see <a class="link" title="Chapter 4. Web Mining Techniques" href="text00032.html#ch04">Chapter 4</a>&#13;
 , <span class="emphasis">&#13;
<em>Web-mining techniques</em>&#13;
</span>&#13;
 ) using a maximum of words specified by the <code class="literal">nmaxwords</code>&#13;
 parameter. The data of each movie is also saved in a <code class="literal">MovieData</code>&#13;
 object (title, tf-idf representation, description, and <code class="literal">ndim</code>&#13;
 number of words of the tf-idf vocabulary). Note that the first time the command is run the <code class="literal">stopwords</code>&#13;
 from <code class="literal">nltk.download('stopwords')</code>&#13;
 (commented in the preceding code) need to be downloaded.</p>&#13;
<p>The tf-idf model, the title's list, and the matrix of the tf-idf movies' representations, are saved in the Django cache using the commands:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from django.core.cache import cache
...
cache.set('model',mod_tfidf)
cache.set('data', matr)
cache.set('titles', titles)</pre>&#13;
</div>&#13;
<div class="note" title="Note">&#13;
<h3 class="title"><a id="note05"/>&#13;
 Note</h3>&#13;
<p>Note that the cache Django module (<code class="literal">django.core.cache</code>&#13;
 ) needs to be loaded (at the beginning of the file) to be used.</p>&#13;
</div>&#13;
<p>In the same way, the utility matrix (<code class="literal">umatrixfile</code>&#13;
 parameter) is used to initialize the two recommendation systems used by the application: item-based collaborative filtering and log-likelihood ratio method. Both methods are not written in the preceding code because they are essentially<a id="id558" class="indexterm"/>&#13;
 the same as the code described in <a class="link" title="Chapter 5. Recommendation Systems" href="text00037.html#page">Chapter 5</a>&#13;
 , <span class="emphasis">&#13;
<em>Recommendation systems</em>&#13;
</span>&#13;
 (the full code can be seen in the <code class="literal">chapter_7</code>&#13;
 folder of the author's GitHub repository as usual). The methods and the utility matrix are then loaded into the Django cache ready to use:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">cache.set('umatrix',Umatrix)
   cache.set('cf_itembased',cf_itembased)
   cache.set('loglikelihood',llr)</pre>&#13;
</div>&#13;
<p>Now the data (and models) can be used in the web pages just by calling the corresponding name, as we will see in the following sections.</p>&#13;
</div>&#13;

<div class="section" title="User sign up login/logout implementation">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec46"/>&#13;
 User sign up login/logout implementation</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>This application can recommend <a id="id559" class="indexterm"/>&#13;
 movies to different users that are registered on the website. To manage the registration process, we use the standard <code class="literal">User</code>&#13;
 Django module as we have seen in the <span class="emphasis">&#13;
<em>Models</em>&#13;
</span>&#13;
 sections. Each page of the website refers to the <code class="literal">base.html</code>&#13;
 page, which implements a top bar that allows the user to register or sign in (right side):</p>&#13;
<div class="mediaobject"><img src="Image00533.jpg" alt="User sign up login/logout implementation"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Clicking on one of the two buttons <span class="strong">&#13;
<strong>sign in</strong>&#13;
</span>&#13;
 or <span class="strong">&#13;
<strong>sign up</strong>&#13;
</span>&#13;
 will activate the code:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">                &lt;form class="navbar-search pull-right" action="{% url 'auth' %}" method="GET"&gt;
                  {% csrf_token %}
                   &lt;div style="overflow: hidden; padding-right: .5em;"&gt;
                     &lt;input type="submit" name="auth_method" value="sign up" size="30" style="float: right" /&gt;
                     &lt;input type="submit" name="auth_method" value="sign in" size="30" style="float: right" /&gt;
                    &lt;/div&gt;
                &lt;/form&gt;</pre>&#13;
</div>&#13;
<p>The two methods refer to the <code class="literal">urls.py</code>&#13;
 :</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">    url(r'^auth/', 'books_recsys_app.views.auth', name='auth')</pre>&#13;
</div>&#13;
<p>This calls the <a id="id560" class="indexterm"/>&#13;
 <code class="literal">auth</code>&#13;
 function in the <code class="literal">views.py</code>&#13;
 :</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">def auth(request):
    if request.method == 'GET':
        data = request.GET
        auth_method = data.get('auth_method')
        if auth_method=='sign in':
           return render_to_response(
               'books_recsys_app/signin.html', RequestContext(request, {})) 
        else:    
            return render_to_response(
                'books_recsys_app/createuser.html', RequestContext(request, {}))
    elif request.method == 'POST':
        post_data = request.POST
        name = post_data.get('name', None)
        pwd = post_data.get('pwd', None)
        pwd1 = post_data.get('pwd1', None)
        create = post_data.get('create', None)#hidden input
        if name and pwd and create:
           if User.objects.filter(username=name).exists() or pwd!=pwd1:
               return render_to_response(
                   'books_recsys_app/userexistsorproblem.html', RequestContext(request))
           user = User.objects.create_user(username=name,password=pwd)
           uprofile = UserProfile()
           uprofile.user = user
           uprofile.name = user.username
           uprofile.save(create=True)

           user = authenticate(username=name, password=pwd)
           login(request, user)
           return render_to_response(
               'books_recsys_app/home.html', RequestContext(request))
        elif name and pwd:
            user = authenticate(username=name, password=pwd)
            if user:
                login(request, user)
                return render_to_response(
                    'books_recsys_app/home.html', RequestContext(request))
            else:
                #notfound
                return render_to_response(
                    'books_recsys_app/nopersonfound.html', 
                       RequestContext(request))</pre>&#13;
</div>&#13;
<p>The function will <a id="id561" class="indexterm"/>&#13;
 redirect to the sign up page as shown in the following screenshot:</p>&#13;
<div class="mediaobject"><img src="Image00534.jpg" alt="User sign up login/logout implementation"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>If you have already registered, it will take you to the sign in page as shown in the following screenshot:</p>&#13;
<div class="mediaobject"><img src="Image00535.jpg" alt="User sign up login/logout implementation"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>The page <a id="id562" class="indexterm"/>&#13;
 allows the user to create a username and password and log in to the website. The data is then used to create a new object of the User Django model and the related <code class="literal">UserProfile</code>&#13;
 object (note that the <code class="literal">create</code>&#13;
 argument is <code class="literal">True</code>&#13;
 to save the object without associating an array of rated movies):</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">user = User.objects.create_user(username=name,password=pwd)
uprofile = UserProfile()
uprofile.user = user
uprofile.save(create=True)
user = authenticate(username=name, password=pwd)</pre>&#13;
</div>&#13;
<p>The user is then logged in using the standard Django methods:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from django.contrib.auth import authenticate, login
...
login(request, user)</pre>&#13;
</div>&#13;
<p>Hence, the website top bar looks like (username:<span class="strong">&#13;
<strong>a</strong>&#13;
</span>&#13;
 ) as shown in the following screenshot:</p>&#13;
<div class="mediaobject"><img src="Image00536.jpg" alt="User sign up login/logout implementation"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Note that in cases where a user with the same name already exists (new sign up exception event) or where a user is not found (sign in exception event), both are implemented and the reader can look into the code to understand how these events are handled.</p>&#13;
<p>The <span class="strong">&#13;
<strong>sign out</strong>&#13;
</span>&#13;
 button refers to the <code class="literal">urls.py</code>&#13;
 :</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">url(r'^signout/','books_recsys_app.views.signout',name='signout')</pre>&#13;
</div>&#13;
<p>This calls the <code class="literal">signout</code>&#13;
 function from <code class="literal">views.py</code>&#13;
 :</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from django.contrib.auth import logout
…
def signout(request):
    logout(request)
    return render_to_response(
        'books_recsys_app/home.html', RequestContext(request))  </pre>&#13;
</div>&#13;
<p>The function uses <a id="id563" class="indexterm"/>&#13;
 the standard Django logout method and redirects to the home page (the <span class="strong">&#13;
<strong>sign in</strong>&#13;
</span>&#13;
 and <span class="strong">&#13;
<strong>sign out</strong>&#13;
</span>&#13;
 buttons will be shown again in the top bar). The user can now search for movies to rate using the information retrieval system (search engine) described in the next section.</p>&#13;
</div>&#13;

<div class="section" title="Information retrieval system (movies query)">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec47"/>&#13;
 Information retrieval system (movies query)</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>In order to rate movies, the user<a id="id564" class="indexterm"/>&#13;
 needs to search for them using the home page:</p>&#13;
<div class="mediaobject"><img src="Image00537.jpg" alt="Information retrieval system (movies query)"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>By Typing some relevant words in the text box, the page will call (through the <code class="literal">urls.py</code>&#13;
 corresponding <span class="emphasis">&#13;
<em>home</em>&#13;
</span>&#13;
 URL) the <code class="literal">home</code>&#13;
 function in the <code class="literal">views.py</code>&#13;
 file:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">def home(request):
    context={}
    if request.method == 'POST':
        post_data = request.POST
        data = {}
        data = post_data.get('data', None)
        if data:
            return redirect('%s?%s' % (reverse('books_recsys_app.views.home'),
                                urllib.urlencode({'q': data})))
    elif request.method == 'GET':
        get_data = request.GET
        data = get_data.get('q',None)
        titles = cache.get('titles')
        if titles==None:
            print 'load data...'
            texts = []
            mobjs = MovieData.objects.all()
            ndim = mobjs[0].ndim
            matr = np.empty([1,ndim])
            titles_list = []
            cnt=0
            for obj in mobjs[:]:
                texts.append(obj.description)
                newrow = np.array(obj.array)
                #print 'enw:',newrow
                if cnt==0:
                    matr[0]=newrow
                else:
                    matr = np.vstack([matr, newrow])
                titles_list.append(obj.title)
                cnt+=1
            vectorizer = TfidfVectorizer(min_df=1,max_features=ndim) 
            processedtexts = PreprocessTfidf(texts,stoplist,True)
            model = vectorizer.fit(processedtexts)
            cache.set('model',model)
            #cache.set('processedtexts',processedtexts)
            cache.set('data', matr)
            cache.set('titles', titles_list)
        else:
            print 'loaded',str(len(titles))
          
        Umatrix = cache.get('umatrix')
        if Umatrix==None:
            df_umatrix = pd.read_csv(umatrixpath)
            Umatrix = df_umatrix.values[:,1:]
            cache.set('umatrix',Umatrix)
            cf_itembased = CF_itembased(Umatrix)
            cache.set('cf_itembased',cf_itembased)
            cache.set('loglikelihood',LogLikelihood(Umatrix,movieslist))
            
        if not data:
            return render_to_response(
                'books_recsys_app/home.html', RequestContext(request, context))
        
        
        #load all movies vectors/titles
        matr = cache.get('data')
        titles = cache.get('titles')
        model_tfidf = cache.get('model')
        #find movies similar to the query
        queryvec = model_tfidf.transform([data.lower().encode('ascii','ignore')]).toarray()     
        sims= cosine_similarity(queryvec,matr)[0]
        indxs_sims = list(sims.argsort()[::-1])
        titles_query = list(np.array(titles)[indxs_sims][:nmoviesperquery])
        
        context['movies']= zip(titles_query,indxs_sims[:nmoviesperquery])
        context['rates']=[1,2,3,4,5]
        return render_to_response(
            'books_recsys_app/query_results.html', 
              RequestContext(request, context))</pre>&#13;
</div>&#13;
<p>The <code class="literal">data</code>&#13;
 parameter at the beginning of the function will store the typed query and the function will use it to transform it to a vector tf-idf representation using the model already loaded in memory by the <code class="literal">load_data</code>&#13;
 command:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">        matr = cache.get('data')
        titles = cache.get('titles')
        model_tfidf = cache.get('model')</pre>&#13;
</div>&#13;
<p>Also the <a id="id565" class="indexterm"/>&#13;
 matrix (key: <code class="literal">matr</code>&#13;
 ) and the movies' titles (key: <code class="literal">titles</code>&#13;
 ) are retrieved from the cache to return the list of movies similar to the query vector (see <a class="link" title="Chapter 4. Web Mining Techniques" href="text00032.html#ch04">Chapter 4</a>&#13;
 , <span class="emphasis">&#13;
<em>Web-mining techniques</em>&#13;
</span>&#13;
 for further details). Also note that in case the cache is empty, the models (and the other data) are created and loaded in memory directly from the first call of this function. For example, we can type <code class="literal">war</code>&#13;
 as a query and the website will return the most similar movies to this query (<code class="literal">query_results.html</code>&#13;
 ):</p>&#13;
<div class="mediaobject"><img src="Image00538.jpg" alt="Information retrieval system (movies query)"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>As we can see, we <a id="id566" class="indexterm"/>&#13;
 have five movies (at the beginning of the <code class="literal">views.py</code>&#13;
 file we can set the number of movies per query parameter: <code class="literal">nmoviesperquery</code>&#13;
 ) and most of them are related to war. From this page we can rate the movies as we discuss in the following section.</p>&#13;
</div>&#13;

<h1>读累了记得休息一会哦~</h1>
<p> </p>
<p><strong>公众号：古德猫宁李</strong></p>
<ul>
<li>电子书搜索下载</li>
<li>书单分享</li>
<li>书友学习交流</li>

<p> </p>
</ul>
<p><strong>网站：</strong><a href="https://www.chenjin5.com">沉金书屋 https://www.chenjin5.com</a></p>
<ul>
<li>电子书搜索下载</li>
<li>电子书打包资源分享</li>
<li>学习资源分享</li>

</ul>

<div class="section" title="Rating system">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec48"/>&#13;
 Rating system</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Each user (when logged in) can rate <a id="id567" class="indexterm"/>&#13;
 movies simply by clicking on the rate value (1 to 5) at the side of the movie title in the movies' results page (see preceding screenshot). This action will trigger the <code class="literal">rate_movie</code>&#13;
 function in the <code class="literal">views.py</code>&#13;
 file (through the corresponding URL in <code class="literal">urls.py</code>&#13;
 ):</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">def rate_movie(request):
    data = request.GET
    rate = data.get("vote")
    movies,moviesindxs = zip(*literal_eval(data.get("movies")))
    movie = data.get("movie")
    movieindx = int(data.get("movieindx"))
    #save movie rate
    userprofile = None
    if request.user.is_superuser:
        return render_to_response(
            'books_recsys_app/superusersignin.html', RequestContext(request))
    elif request.user.is_authenticated() :
        userprofile = UserProfile.objects.get(user=request.user)
    else:
        return render_to_response(
            'books_recsys_app/pleasesignin.html', RequestContext(request))
    
    if MovieRated.objects.filter(movie=movie).filter(user=userprofile).exists():
        mr = MovieRated.objects.get(movie=movie,user=userprofile)
        mr.value = int(rate)
        mr.save()
    else:
        mr = MovieRated()
        mr.user = userprofile
        mr.value = int(rate)
        mr.movie = movie
        mr.movieindx = movieindx
        mr.save()
        
    userprofile.save()
    #get back the remaining movies
    movies = RemoveFromList(movies,movie)
    moviesindxs = RemoveFromList(moviesindxs,movieindx)
    print movies
    context = {}
    context["movies"] = zip(movies,moviesindxs)
    context["rates"] = [1,2,3,4,5]
    return render_to_response(
        'books_recsys_app/query_results.html', 
          RequestContext(request, context))</pre>&#13;
</div>&#13;
<p>The function will<a id="id568" class="indexterm"/>&#13;
 store the <code class="literal">rate</code>&#13;
 of the movie in an object of the <code class="literal">MovieRated</code>&#13;
 model, and the corresponding movies <code class="literal">rate</code>&#13;
 vector of the user is updated (through the <code class="literal">userprofile.save()</code>&#13;
 ). The movies not rated are then sent back to the page <code class="literal">query_results.html</code>&#13;
 . Note that the user needs to be logged in to rate a movie or the exception event that will ask the user to sign in will be shown (page: <code class="literal">pleasesignin.html</code>&#13;
 ).</p>&#13;
</div>&#13;

<div class="section" title="Recommendation systems">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec49"/>&#13;
 Recommendation systems</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>This function will use the parameters set at the <a id="id569" class="indexterm"/>&#13;
 beginning of the <code class="literal">views.py</code>&#13;
 file:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">nminimumrates=5
numrecs=5
recmethod = 'loglikelihood'</pre>&#13;
</div>&#13;
<p>This defines the minimum number of movies to rate before obtaining recommendations, the number of recommendations to show to the user, and the recommendation system method respectively. To show recommendations the user can click on the <span class="strong">&#13;
<strong>Recommendations</strong>&#13;
</span>&#13;
 button on the top bar:</p>&#13;
<div class="mediaobject"><img src="Image00536.jpg" alt="Recommendation systems"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>This action will trigger <a id="id570" class="indexterm"/>&#13;
 the <code class="literal">movies_recs</code>&#13;
 function in the <code class="literal">views.py</code>&#13;
 file (through the corresponding URL defined in the <code class="literal">urls.py</code>&#13;
 file):</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">def movies_recs(request):
    
    userprofile = None
    if request.user.is_superuser:
        return render_to_response(
            'books_recsys_app/superusersignin.html', RequestContext(request))
    elif request.user.is_authenticated():
        userprofile = UserProfile.objects.get(user=request.user)
    else:
        return render_to_response(
            'books_recsys_app/pleasesignin.html', RequestContext(request))
    ratedmovies=userprofile.ratedmovies.all()
    context = {}
    if len(ratedmovies)&lt;nminimumrates:
        context['nrates'] = len(ratedmovies)
        context['nminimumrates']=nminimumrates
        return render_to_response(
            'books_recsys_app/underminimum.html', RequestContext(request, context))
            
    u_vec = np.array(userprofile.array)
    Umatrix = cache.get('umatrix')
    movieslist = cache.get('titles')
    #recommendation...
    u_rec = None
    if recmethod == 'cf_userbased':
        u_rec = CF_userbased(u_vec,numrecs,Umatrix)      
    elif recmethod == 'cf_itembased':
        cf_itembased = cache.get('cf_itembased')
        if cf_itembased == None:
            cf_itembased = CF_itembased(Umatrix)
        u_rec = cf_itembased.CalcRatings(u_vec,numrecs)        
    elif recmethod == 'loglikelihood':
        llr = cache.get('loglikelihood')
        if llr == None:
            llr = LogLikelihood(Umatrix,movieslist)
        u_rec = llr.GetRecItems(u_vec,True)
    #save last recs
    userprofile.save(recsvec=u_rec)
    context['recs'] = list(np.array(movieslist)[list(u_rec)][:numrecs])
    return render_to_response(
        'books_recsys_app/recommendations.html', 
          RequestContext(request, context))</pre>&#13;
</div>&#13;
<p>The<a id="id571" class="indexterm"/>&#13;
 function will retrieve the rated movies vector from the corresponding <code class="literal">UserProfile</code>&#13;
 object and it will load the recommendation system method (specified by the <code class="literal">recmethod</code>&#13;
 parameter) from cache. The recommendations are first stored in the <code class="literal">userprofile</code>&#13;
 object and then returned to the <code class="literal">recommendations.html</code>&#13;
 page. For example, using the <code class="literal">cf_itembased</code>&#13;
 method:</p>&#13;
<div class="mediaobject"><img src="Image00539.jpg" alt="Recommendation systems"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>This is a sample result page after rating the five movies related to the word <code class="literal">war</code>&#13;
 (see preceding screenshot). The reader can play more with the parameters and the different algorithms to evaluate the differences.</p>&#13;
</div>&#13;

<div class="section" title="Admin interface and API">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec50"/>&#13;
 Admin interface and API</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>In order to manage the <a id="id572" class="indexterm"/>&#13;
 data of the application, the <a id="id573" class="indexterm"/>&#13;
 admin interface and an API point can be set. From the admin panel we can see both the movie's data, and the user registered, writing the following <code class="literal">admin.py</code>&#13;
 file:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from django.contrib import admin
from books_recsys_app.models import MovieData,UserProfile
      
class MoviesAdmin(admin.ModelAdmin):
      list_display = ['title', 'description']

admin.site.register(UserProfile)
admin.site.register(MovieData,MoviesAdmin)</pre>&#13;
</div>&#13;
<p>After setting the corresponding <code class="literal">admin</code>&#13;
 URL on the <code class="literal">urls.py</code>&#13;
 file:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">url(r'^admin/', include(admin.site.urls))</pre>&#13;
</div>&#13;
<p>We should see our admin panel (at <code class="literal">http://localhost:8000/admin/</code>&#13;
 ) with the two models and the data within the models resembles the fields specified in the <code class="literal">admin.py</code>&#13;
 file:</p>&#13;
<div class="mediaobject"><img src="Image00540.jpg" alt="Admin interface and API"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>To set the API <a id="id574" class="indexterm"/>&#13;
 endpoint to retrieve the data for <a id="id575" class="indexterm"/>&#13;
 each registered user, first we need to write out <code class="literal">serializers.py</code>&#13;
 specifying which fields of the <code class="literal">UserProfile</code>&#13;
 model we want to employ:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from books_recsys_app.models import UserProfile
from rest_framework import serializers

class UsersSerializer(serializers.HyperlinkedModelSerializer):
    class Meta:
        model = UserProfile
        fields = ('name', 'arrayratedmoviesindxs','lastrecs')</pre>&#13;
</div>&#13;
<p>In this case, we want to collect the ID of the movies, rated by the user, and his last recommended movie's ID. Then the API is set in the <code class="literal">api.py</code>&#13;
 file as follows:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">from rest_framework import generics
from rest_framework.permissions import AllowAny
from rest_framework.pagination import PageNumberPagination
from books_recsys_app.serializers import UsersSerializer
from books_recsys_app.models import UserProfile

class LargeResultsSetPagination(PageNumberPagination):
    page_size = 1000
    page_size_query_param = 'page_size'
    max_page_size = 10000
    
class UsersList(generics.ListAPIView):

    serializer_class = UsersSerializer
    permission_classes = (AllowAny,)
    pagination_class = LargeResultsSetPagination
    
    def get_queryset(self):
        query = self.request.query_params.get
        if query('name'):
           return UserProfile.objects.filter(name=query('name')) 
        else:
           return UserProfile.objects.all()</pre>&#13;
</div>&#13;
<p>Note that a query <a id="id576" class="indexterm"/>&#13;
 parameter <code class="literal">name</code>&#13;
 is allowed in<a id="id577" class="indexterm"/>&#13;
 case we want to collect only the data for one particular user. After setting the corresponding URL in the <code class="literal">urls.py</code>&#13;
 file:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">url(r'^users-list/',UsersList.as_view(),name='users-list')</pre>&#13;
</div>&#13;
<p>The end point can be called through the <code class="literal">curl</code>&#13;
 command using the terminal:</p>&#13;
<div class="informalexample">&#13;
<pre class="programlisting">
<span class="strong">
<strong>curl -X GET localhost:8000/users-list/</strong>&#13;

</span>&#13;


</pre>&#13;
</div>&#13;
<p>It can also be called using the swagger interface for testing purposes (see <a class="link" title="Chapter 6. Getting Started with Django" href="text00046.html#ch06">Chapter 6</a>&#13;
 , <span class="emphasis">&#13;
<em>Basics of Django: a simple web framework</em>&#13;
</span>&#13;
 ).</p>&#13;
</div>&#13;

<div class="section" title="Summary">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch07lvl1sec51"/>&#13;
 Summary</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>We have just shown how to build an application to recommend movies using the Django framework. You now should have some degree of confidence in how to develop a professional web application using Python and the machine-learning algorithms that power it.</p>&#13;
<p>In the next chapter, an additional example on a movie's web sentiment reception will give you even more understanding to efficiently write your own machine-learning web application in Python.</p>&#13;
</div>&#13;
</body></html>