<html><head></head><body>
		<div id="_idContainer195">
			<h1 id="_idParaDest-182"><em class="italic"><a id="_idTextAnchor184"/>Chapter 13</em>: Running TensorFlow Models with BigQuery ML</h1>
			<p>TensorFlow is one of the most used and relevant <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>) frameworks available. It allows data scientists and ML engineers to develop advanced models, and it also provides great flexibility and a rich set of mathematical functions.</p>
			<p>The advanced features that TensorFlow offers provide a huge opportunity for data analysts that want to leverage existing models developed by data scientists and ML engineers.</p>
			<p>Furthermore, the interoperability between BigQuery ML and TensorFlow represents a way to fill the gap between business and technical stakeholders within companies. The first group is usually more focused on in-depth knowledge of the data, while the second is technical-oriented and focused on programming skills.</p>
			<p>In this chapter, we'll learn what TensorFlow is and how it can be used with BigQuery ML. We'll understand how to export a BigQuery ML model into the TensorFlow format and how to run TensorFlow models using BigQuery ML SQL syntax. </p>
			<p>To understand how we can complement BigQuery ML with TensorFlow, we'll cover the following topics: </p>
			<ul>
				<li>Introducing TensorFlow</li>
				<li>Discovering the relationship between BigQuery ML and TensorFlow</li>
				<li>Converting BigQuery ML models into TensorFlow</li>
				<li>Running TensorFlow models with BigQuery ML</li>
			</ul>
			<h1 id="_idParaDest-183"><a id="_idTextAnchor185"/>Technical requirements</h1>
			<p>This chapter requires that you have access a web browser and can leverage the following:</p>
			<ul>
				<li>A GCP account to access the Google Cloud Console</li>
				<li>A GCP project to host BigQuery datasets</li>
				<li>A GCP project to host the Google Cloud storage bucket</li>
			</ul>
			<p>Now that we've covered the technical requirements, let's start exploring BigQuery ML for TensorFlow models.</p>
			<p>Check out the following video to see the Code in Action: <a href="https://bit.ly/33ngmdf">https://bit.ly/33ngmdf</a></p>
			<h1 id="_idParaDest-184"><a id="_idTextAnchor186"/>Introducing TensorFlow</h1>
			<p>In this section, we'll introduce <strong class="bold">TensorFlow</strong>, its origins, and what this framework has achieved <a id="_idIndexMarker586"/>in the ML community.</p>
			<p><strong class="bold">TensorFlow</strong> is an open source library that's used to develop ML models. It's very flexible and can be used to address a wide variety of use cases and business scenarios. Since TensorFlow is based on math functions, its name comes from the mathematical concept of the <strong class="bold">Tensor</strong>.</p>
			<p>In math, a <strong class="bold">Tensor</strong> is an <a id="_idIndexMarker587"/>algebraic object that describes a relationship between sets of other algebraic objects. Some examples of tensors are vectors and matrixes.</p>
			<p>The TensorFlow library was originally created by Google's engineers and then released under the Apache License in 2015. Now, it is recognized as one of the most popular ML frameworks due to its potential and flexibility. In fact, a TensorFlow model can be executed on local machines, on-premises servers, in the cloud, or at the edge, such as on mobile phones and video surveillance cameras.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout"><strong class="bold">Edge computing</strong> is a <a id="_idIndexMarker588"/>computing paradigm that brings the computation of business logic closer to the location where it is required. When a ML model runs at the edge, it is typically executed directly on the sensors or cameras that collect the data for the model to function without connecting to other systems.</p>
			<p>TensorFlow is widely used by the ML community and is applied to solve different challenges in the artificial intelligence space, such as the following:</p>
			<ul>
				<li>Airbnb leverages TensorFlow to classify customers pictures, thus improving the virtual tours of houses to rent. For more details, you can visit the following link: https://medium.com/airbnb-engineering/categorizing-listing-photos-at-airbnb-f9483f3ab7e3.</li>
				<li>Google uses TensorFlow to empower its products, such as Google Search, Gmail, and Translate, with artificial intelligence capabilities. For more details, you can visit the following link: <a href="https://ai.googleblog.com/search/label/TensorFlow">https://ai.googleblog.com/search/label/TensorFlow</a>.</li>
				<li>PayPal uses TensorFlow to prevent fraud and applies ML to increase the accuracy of its fraud detection models. For more details, you can visit the following link: <a href="https://medium.com/paypal-engineering">https://medium.com/paypal-engineering</a>.</li>
				<li>Twitter leverages TensorFlow to identify and show the most relevant tweets to its users. For more details, you can visit the following link: https://blog.tensorflow.org/2019/03/ranking-tweets-with-tensorflow.html.</li>
				<li>Other interesting use cases can be found on the TensorFlow case studies web page at <a href="https://www.tensorflow.org/about/case-studies?hl=en">https://www.tensorflow.org/about/case-studies?hl=en</a>.</li>
			</ul>
			<p>Compared to what happens with BigQuery ML, advanced programming skills are required to <a id="_idIndexMarker589"/>develop a ML model using TensorFlow. In fact, the high flexibility of the TensorFlow library is balanced by the need to invest a certain amount of time in code development to create the model. Now, the suggested programming language to develop ML models with TensorFlow is Python.</p>
			<p>Once the development and training phase of a TensorFlow model is completed, it can be exported into the <strong class="bold">SavedModel</strong> format.</p>
			<p>The <strong class="bold">SavedModel</strong> format contains <a id="_idIndexMarker590"/>the entire TensorFlow model. This format allows us to deploy the model without the need to run the code again in all the compatible environments. A SavedModel is composed of multiple files and folders stored in the same parent folder:</p>
			<ul>
				<li>The SavedModel file stores the TensorFlow logic. This file is called <strong class="source-inline">saved_model.pb</strong>.</li>
				<li>The <strong class="source-inline">variables</strong> directory contains the parameters of the trained model.</li>
				<li>The <strong class="source-inline">assets</strong> folder can contain the external and additional files that are used by the ML model.</li>
			</ul>
			<p>When a TensorFlow model is in the SavedModel format, it can be easily loaded and used on the <a id="_idIndexMarker591"/>platform where we want to use this model. The platform could <a id="_idIndexMarker592"/>be a physical server, a cloud instance, a smartphone, or an <strong class="bold">Internet of Things</strong> (<strong class="bold">IoT</strong>) device.</p>
			<p>In this section, we introduced the basics of TensorFlow. In the next section, we'll discover how BigQuery ML is linked to TensorFlow.</p>
			<h1 id="_idParaDest-185"><a id="_idTextAnchor187"/>Discovering the relationship between BigQuery ML and TensorFlow</h1>
			<p>In this section, we'll understand the relationship between BigQuery ML and TensorFlow. After <a id="_idIndexMarker593"/>completing this section, we'll <a id="_idIndexMarker594"/>be able to understand when to use BigQuery ML and TensorFlow according to our use case, but also how to get the best out of the two technologies, when they're used together. </p>
			<h2 id="_idParaDest-186"><a id="_idTextAnchor188"/>Understanding commonalities and differences</h2>
			<p>BigQuery ML <a id="_idIndexMarker595"/>and TensorFlow have some similar <a id="_idIndexMarker596"/>aspects, but there are also some relevant differences to highlight.</p>
			<p>In the following table, we have summarized the main similarities and differences of these two frameworks:</p>
			<div>
				<div id="_idContainer184" class="IMG---Figure">
					<img src="image/B16722_13_001.jpg" alt="Figure 13.1 – Comparing BigQuery ML and TensorFlow&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.1 – Comparing BigQuery ML and TensorFlow</p>
			<p>First, it is important to underline that TensorFlow offers greater flexibility in terms of the ML <a id="_idIndexMarker597"/>models that can be implemented. While <a id="_idIndexMarker598"/>BigQuery ML is characterized by a specific list of supported model types (https://cloud.google.com/bigquery-ml/docs/introduction#supported_models_in), TensorFlow offers a wider spectrum of ML techniques. </p>
			<p>BigQuery ML <a id="_idIndexMarker599"/>was designed as an extension of BigQuery and for this reason, it only focuses on structured data, which can be represented in a tabular format. All the BigQuery ML techniques are based on the possibility to train and apply the models to rows stored in BigQuery tables. On the other hand, TensorFlow is open to different formats, including free text, images, audio, and videos.</p>
			<p>To train, evaluate, and test BigQuery ML models, the user should know the SQL syntax and have minimal ML experience. Implementing a TensorFlow model, on the other hand, requires good programming skills and good knowledge of ML topics because the framework provides higher flexibility in terms of customization.</p>
			<p>Considering the features of these two technologies, it is clear that they are addressed to different stakeholders in the companies. While BigQuery ML can easily be used by business analysts and data analysts that are familiar with data analytics tasks and SQL queries, TensorFlow is designed for advanced programmers, such as experienced data scientists and ML engineers.</p>
			<p>Now that <a id="_idIndexMarker600"/>we have understood the commonalities and the differences of BigQuery ML and TensorFlow, in the next section, we'll learn how these two frameworks can complement each other.</p>
			<h2 id="_idParaDest-187"><a id="_idTextAnchor189"/>Collaborating with BigQuery ML and TensorFlow</h2>
			<p>In this <a id="_idIndexMarker601"/>section, we'll discover how to use <a id="_idIndexMarker602"/>BigQuery ML and TensorFlow together to get the maximum value from both technologies.</p>
			<p>The following diagram shows the interactions between business analysts and data scientists using BigQuery ML and TensorFlow:</p>
			<div>
				<div id="_idContainer185" class="IMG---Figure">
					<img src="image/B16722_13_002.jpg" alt="Figure 13.2 – Interactions between BigQuery ML and TensorFlow&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.2 – Interactions between BigQuery ML and TensorFlow</p>
			<p>As we've described in <a href="B16722_01_Final_ASB_ePub.xhtml#_idTextAnchor016"><em class="italic">Chapter 1</em></a>, <em class="italic">Introduction to Google Cloud and BigQuery</em>, the first steps of the ML development cycle are exploring the data and completely understanding it.</p>
			<p>After this first phase of analysis, the data needs to be cleaned and prepared to train the ML algorithm. This phase is fundamental to creating a valuable ML model and proceeding on to the training stage.</p>
			<p>When <a id="_idIndexMarker603"/>it's time to actually develop the <a id="_idIndexMarker604"/>ML model, depending on our knowledge, background, and previous experience, we have two options:</p>
			<ul>
				<li>If you are a business analyst or data analyst, you will prefer using BigQuery ML for its simplicity and immediacy thanks to the SQL syntax.</li>
				<li>If you're a data scientist or a ML engineer, you will choose to train a TensorFlow model due to its flexibility and because it offers more opportunities for customization.</li>
			</ul>
			<p>As shown in the preceding diagram, the upper branch represents the typical workflow of a business or data analyst who leverages BigQuery ML SQL statements to create, evaluate, and use a ML model on data that's already been stored in BigQuery. This branch requires that you have good knowledge of the SQL language, the basics of ML, and the underlying data.</p>
			<p>On the other hand, the lower branch of the diagram represents the development process based on a TensorFlow library that's been made by data scientists or ML engineers, who have a great experience in programming and ML algorithms.</p>
			<p>Typically, data analysts know the data very well but have little knowledge of the most advanced programming techniques, while data scientists and ML engineers have in-depth coding skills but a limited comprehension of the business data. This situation usually occurs in more established companies due to the employees having different professional backgrounds. This can cause friction between those who know the industry very well and the business processes where other people are more focused on programming.</p>
			<p>In order to reduce this gap and mitigate the risk of friction, BigQuery ML allows us to do the following:</p>
			<ul>
				<li>Export the ML models that have been developed with BigQuery ML into the TensorFlow SavedModel format.</li>
				<li>Import TensorFlow ML models in the SavedModel format.</li>
			</ul>
			<p>Looking at the preceding diagram, we can see that a business analyst can export BigQuery ML models and deploy them to other environments that are different from BigQuery and compatible with TensorFlow.</p>
			<p>On the <a id="_idIndexMarker605"/>other hand, a data scientist who <a id="_idIndexMarker606"/>has implemented advanced TensorFlow models can save them into a Google Cloud storage bucket, which means they can be imported into BigQuery ML.</p>
			<p>This kind of bidirectional interaction between BigQuery ML and the TensorFlow framework allows us to do the following:</p>
			<ul>
				<li>Extend the applicability of a BigQuery ML model that is no longer confined to using data stored in BigQuery.</li>
				<li>Import BigQuery ML advanced TensorFlow models that were not originally supported by the BigQuery ML syntax and use them, through SQL queries, on the data stored in BigQuery.</li>
			</ul>
			<p>In this section, we learned how BigQuery ML and TensorFlow can interact and why it's so important to leverage this kind of integration. In the next section, we'll train a BigQuery ML model and export it in TensorFlow format.</p>
			<h1 id="_idParaDest-188"><a id="_idTextAnchor190"/>Converting BigQuery ML models into TensorFlow</h1>
			<p>In this <a id="_idIndexMarker607"/>section, we'll train the same deep neural network that we trained in <a href="B16722_11_Final_ASB_ePub.xhtml#_idTextAnchor160"><em class="italic">Chapter 11</em></a>, <em class="italic">Implementing Deep Neural Networks</em>, and then export this model into the TensorFlow SavedModel format.</p>
			<h2 id="_idParaDest-189"><a id="_idTextAnchor191"/>Training the BigQuery ML to export it</h2>
			<p>Before <a id="_idIndexMarker608"/>we start training the model, let's access BigQuery to create the dataset and the tables that will be used for training and prediction:</p>
			<ol>
				<li>Log into our Google Cloud Console and access the <strong class="bold">BigQuery</strong> user interface from the navigation menu.</li>
				<li>Create a new dataset under the project that we' created in <a href="B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039"><em class="italic">Chapter 2</em></a>, <em class="italic">Setting Up Your GCP and BigQuery Environment</em>. For this use case, we'll create a dataset called <strong class="source-inline">13_tensorflow_model</strong> with the default options.</li>
				<li>Now, we're <a id="_idIndexMarker609"/>ready to create the table that will contain the training dataset. Let's execute the following SQL statement:<p class="source-code">CREATE OR REPLACE TABLE `13_tensorflow_model.training_table` AS</p><p class="source-code">              SELECT</p><p class="source-code">                   tripduration/60 tripduration,</p><p class="source-code">                   start_station_name,</p><p class="source-code">                   end_station_name,</p><p class="source-code">                   IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">                   EXTRACT(YEAR FROM starttime)-birth_year as age</p><p class="source-code">              FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE</p><p class="source-code">                    (</p><p class="source-code">                        (EXTRACT (YEAR FROM starttime)=2017 AND</p><p class="source-code">                          (EXTRACT (MONTH FROM starttime)&gt;=04 OR EXTRACT (MONTH FROM starttime)&lt;=10))</p><p class="source-code">                        OR (EXTRACT (YEAR FROM starttime)=2018 AND</p><p class="source-code">                          (EXTRACT (MONTH FROM starttime)&gt;=01 OR EXTRACT (MONTH FROM starttime)&lt;=02))</p><p class="source-code">                    )</p><p class="source-code">                    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007; </p><p>The result of this query is stored in the new <strong class="source-inline">`13_tensorflow_model.training_table`</strong> table that we created to support the following steps of our use case.</p><p>The business logic of this query is the same as what we applied in the <em class="italic">Preparing the dataset</em> section of <a href="B16722_11_Final_ASB_ePub.xhtml#_idTextAnchor160"><em class="italic">Chapter 11</em></a>, <em class="italic">Implementing Deep Neural Networks</em>.</p></li>
				<li>Now, we will <a id="_idIndexMarker610"/>create the table that will be used to test our ML model: <p class="source-code">CREATE OR REPLACE TABLE  `13_tensorflow_model.prediction_table` AS</p><p class="source-code">              SELECT</p><p class="source-code">                   tripduration/60 tripduration,</p><p class="source-code">                   start_station_name,</p><p class="source-code">                   end_station_name,</p><p class="source-code">                   IF (EXTRACT(DAYOFWEEK FROM starttime)=1 OR EXTRACT(DAYOFWEEK FROM starttime)=7, true, false) is_weekend,</p><p class="source-code">                   EXTRACT(YEAR FROM starttime)-birth_year as age</p><p class="source-code">                        FROM</p><p class="source-code">                    `bigquery-public-data.new_york_citibike.citibike_trips`</p><p class="source-code">              WHERE</p><p class="source-code">                    EXTRACT (YEAR FROM starttime)=2018</p><p class="source-code">                    AND EXTRACT (MONTH FROM starttime)=05</p><p class="source-code">                     AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)</p><p class="source-code">                    AND  birth_year is not NULL</p><p class="source-code">                    AND birth_year &lt; 2007;</p><p>This query applies the same logic that was used to create the training table but only takes May 2018 into consideration.</p></li>
				<li>Now, let's <a id="_idIndexMarker611"/>train our ML model, which will be exported into TensorFlow format in the <em class="italic">Exporting the BigQuery ML model</em> section:<p class="source-code">CREATE OR REPLACE MODEL `13_tensorflow_model.bigquery_ml_model_to_export`</p><p class="source-code">OPTIONS</p><p class="source-code">  (model_type='DNN_REGRESSOR',</p><p class="source-code">        ACTIVATION_FN = 'CRELU') AS</p><p class="source-code">SELECT</p><p class="source-code">  start_station_name,</p><p class="source-code">  end_station_name,</p><p class="source-code">  is_weekend,</p><p class="source-code">  age,</p><p class="source-code">  tripduration as label</p><p class="source-code">FROM</p><p class="source-code">  `13_tensorflow_model.training_table`;</p><p>The business logic that was used to create the <strong class="source-inline">`13_tensorflow_model.bigquery_ml_model_to_export`</strong> ML model is the same logic we used to train the <strong class="source-inline">CRELU</strong> deep neural network in the <em class="italic">Training the deep neural network models</em> section of <a href="B16722_11_Final_ASB_ePub.xhtml#_idTextAnchor160"><em class="italic">Chapter 11</em></a>, <em class="italic">Implementing Deep Neural Networks</em>.</p></li>
			</ol>
			<p>Now that we've trained a ML model, in the next section, we'll learn how to export it into the TensorFlow SavedModel format.</p>
			<h2 id="_idParaDest-190"><a id="_idTextAnchor192"/>Exporting the BigQuery ML model</h2>
			<p>In this section, we'll export a BigQuery ML model into a Google Cloud storage bucket in the TensorFlow <a id="_idIndexMarker612"/>SavedModel format. Let's get started:</p>
			<ol>
				<li value="1">First, we need to access to the Cloud Shell from the Google Cloud Console:<div id="_idContainer186" class="IMG---Figure"><img src="image/B16722_13_003.jpg" alt="Figure 13.3 – The Activate Cloud Shell button in the Google Cloud Console&#13;&#10;"/></div><p class="figure-caption">Figure 13.3 – The Activate Cloud Shell button in the Google Cloud Console</p><p class="callout-heading">Important note</p><p class="callout">The <strong class="bold">Cloud Shell</strong> is an <a id="_idIndexMarker613"/>online Linux-based environment that can be accessed from the web browser of the Google Cloud Console. With the Cloud Shell, you can manage <a id="_idIndexMarker614"/>your Google Cloud resources by leveraging its preloaded utilities, such as the <strong class="bold">gcloud</strong> command-line tool.</p></li>
				<li>After clicking on the <strong class="bold">Cloud Shell</strong> button, a Linux command line will be provisioned and presented at the bottom of the screen. If this is the first time you're using the Google Cloud Shell, the following banner will be presented:<div id="_idContainer187" class="IMG---Figure"><img src="image/B16722_13_004.jpg" alt="Figure 13.4 – The Cloud Shell information box&#13;&#10;"/></div><p class="figure-caption">Figure 13.4 – The Cloud Shell information box</p><p>After clicking <a id="_idIndexMarker615"/>on the blue <strong class="bold">Continue</strong> button, the Linux command line will be provisioned, as shown in the following screenshot:</p><div id="_idContainer188" class="IMG---Figure"><img src="image/B16722_13_005.jpg" alt="Figure 13.5 – The Cloud Shell environment&#13;&#10;"/></div><p class="figure-caption">Figure 13.5 – The Cloud Shell environment</p></li>
				<li>We need to authenticate our account for the Google Cloud SDK by running the following command:<p class="source-code">gcloud auth login</p><p>A web URL will be shown in the command line. By clicking on this URL, we'll authorize our account to use Cloud SDK. At the end of this process, you'll see a code on the web page that you can copy and paste into your Cloud Shell to complete the authorization process.</p></li>
				<li>Then, we can run the following command to set the current project name in the new <strong class="source-inline">PROJECT</strong> variable:<p class="source-code">PROJECT=$(gcloud config get-value project)</p></li>
				<li>Using the <strong class="source-inline">PROJECT</strong> variable, we'll create a second variable, <strong class="source-inline">BUCKET</strong>, that will <a id="_idIndexMarker616"/>contain the name of the Google Cloud storage bucket to create, which is where the BigQuery ML model will be exported:<p class="source-code">BUCKET=${PROJECT}-us-bigqueryml-export-tf</p><p>The Google Cloud storage bucket name will be a concatenation of the name of our project and the <strong class="source-inline">-us-bigqueryml-export-tf</strong> string.</p></li>
				<li>Now that we have the name of the bucket stored in a variable, we can create the new bucket by running the following command:<p class="source-code">gsutil mb -l us gs://${BUCKET}</p><p class="callout-heading">Important note</p><p class="callout">The <strong class="source-inline">gsutil mb</strong> command is <a id="_idIndexMarker617"/>used to create a new bucket, while the <strong class="source-inline">–l US</strong> option specifies the geographic location where we want to create the bucket. In this case, the bucket will be created in the United States.</p><p>If this is the first time that you are using Cloud Shell to create a Google Cloud storage bucket, then the following banner will appear before the bucket is created:</p><div id="_idContainer189" class="IMG---Figure"><img src="image/B16722_13_006.jpg" alt="Figure 13.6 – The Cloud Shell authorization box"/></div><p class="figure-caption">Figure 13.6 – The Cloud Shell authorization box</p><p>Upon clicking on the blue <strong class="bold">Authorize</strong> button, the bucket will be created.</p></li>
				<li>Now, let's <a id="_idIndexMarker618"/>execute the command that will export the BigQuery ML model into the Google Cloud storage bucket in the TensorFlow SavedModel format. Let's run the following command:<p class="source-code">     bq extract -m 13_tensorflow_model.bigquery_ml_model_to_export gs://${BUCKET}/bqml_exported_model</p><p>The <strong class="source-inline">bq extract</strong> command is used to extract the BigQuery ML model that's specified after the <strong class="source-inline">–m</strong> option. The last part of the command indicates the path of the Google Cloud storage bucket where we want to extract the model and the related subfolder; that is, <strong class="source-inline">bqml_exported_model</strong>. As an alternative, it's also possible to export the BigQuery ML model using the following SQL query:</p><p class="source-code">EXPORT MODEL 13_tensorflow_model.bigquery_ml_model_to_export</p><p class="source-code">OPTIONS (URI = "gs://${BUCKET}/bqml_exported_model" );</p></li>
				<li>To verify the presence of the exported model, we can browse the Google Cloud Console menu and access the <strong class="bold">Browser</strong> functionality under <strong class="bold">Storage</strong>, as shown in the following screenshot:<div id="_idContainer190" class="IMG---Figure"><img src="image/B16722_13_007.jpg" alt="Figure 13.7 – Google Cloud Storage – Browser&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption"> </p>
			<p class="figure-caption">Figure 13.7 – Google Cloud Storage – Browser</p>
			<p>Upon <a id="_idIndexMarker619"/>accessing the Google Cloud storage bucket we created in <em class="italic">Step 6</em> and entering the <strong class="source-inline">bqml_exported_model</strong> subfolder, we'll see the exported version of the BigQuery ML model, as shown in the following screenshot: </p>
			<div>
				<div id="_idContainer191" class="IMG---Figure">
					<img src="image/B16722_13_008.jpg" alt="Figure 13.8 – The BigQuery ML model exported into the TensorFlow SavedModel format&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.8 – The BigQuery ML model exported into the TensorFlow SavedModel format</p>
			<p>From this <a id="_idIndexMarker620"/>list of the files, we can easily recognize the main components of the TensorFlow SavedModel format that we mentioned in the <em class="italic">Introducing TensorFlow</em> section of this chapter. We can see the <strong class="source-inline">saved_model.pb</strong> file, which contains the TensorFlow program, the <strong class="source-inline">assets</strong> and <strong class="source-inline">variables</strong> folders, and some additional metadata files.</p>
			<p>Now that the model has been exported into the TensorFlow SavedModel format, it's possible to share it with other people and run it on a TensorFlow-compatible environment, outside of BigQuery.</p>
			<p>In this section, we learned how to export a BigQuery ML model into a Google Cloud storage bucket by using the TensorFlow SavedModel format. In the next section, we'll learn how to import existing TensorFlow models into BigQuery ML.</p>
			<h1 id="_idParaDest-191"><a id="_idTextAnchor193"/>Running TensorFlow models with BigQuery ML</h1>
			<p>In this section, we'll import the TensorFlow model that we exported in the <em class="italic">Converting BigQuery ML models into TensorFlow</em> section. Once the model has been imported, we'll use it through the BigQuery ML syntax.</p>
			<p>First, we <a id="_idIndexMarker621"/>need to remember that our BigQuery ML model has been exported into the folder of a Google Cloud storage bucket. The ML model is stored in the TensorFlow SavedModel format and is in the same format as any other ML model that's been developed by a data scientist using TensorFlow.</p>
			<p>If we want to use a TensorFlow model in BigQuery ML, we need to perform the following steps:</p>
			<ol>
				<li value="1">First, let's run the <strong class="source-inline">CREATE OR REPLACE MODEL</strong> SQL statement. Keep in mind that the path of the bucket –  <strong class="source-inline">'gs://&lt;PROJECT_NAME&gt;-us-bigqueryml-export-tf/bqml_exported_model/*'</strong> – is based on the name of your current project, so you need to replace the <strong class="source-inline">&lt;PROJECT_NAME&gt;</strong> placeholder with the name of the project you're working on:<p class="source-code">CREATE OR REPLACE MODEL `13_tensorflow_model.trip_duration_tf_imported_model`</p><p class="source-code">OPTIONS (model_type='tensorflow',</p><p class="source-code">         model_path='gs://&lt;PROJECT_NAME&gt;-us-bigqueryml-export-tf/bqml_exported_model/*');</p><p>The syntax of the query is composed of the <strong class="source-inline">CREATE OR REPLACE MODEL</strong> keywords, followed by the identifier of the new ML model; that is, <strong class="source-inline">`13_tensorflow_model.trip_duration_tf_imported_model`</strong>.</p><p>In the <strong class="source-inline">OPTIONS</strong> clause, we've specified <strong class="source-inline">'tensorflow'</strong> in the <strong class="source-inline">model_type</strong> option. Using the <strong class="source-inline">model_path</strong> parameter, we've specified the folder where the TensorFlow SavedModel will be stored in the Google Cloud storage bucket.</p></li>
				<li>To verify that BigQuery ML successfully loaded the TensorFlow model, we can browse the BigQuery navigation menu and check that the model is present in the <strong class="source-inline">13_tensorflow_model</strong> dataset.<p>The following <a id="_idIndexMarker622"/>screenshot shows that the TensorFlow model has been imported into BigQuery ML. Its name is <strong class="source-inline">trip_duration_tf_imported_model</strong>:</p><div id="_idContainer192" class="IMG---Figure"><img src="image/B16722_13_009.jpg" alt="Figure 13.9 – The TensorFlow model imported into BigQuery&#13;&#10;"/></div><p class="figure-caption">Figure 13.9 – The TensorFlow model imported into BigQuery</p></li>
				<li>If we click on <strong class="source-inline">trip_duration_tf_imported_model</strong>, we'll be able to access the ML model's details.<p>The following screenshot shows the details of the imported ML model:</p><div id="_idContainer193" class="IMG---Figure"><img src="image/B16722_13_010.jpg" alt="Figure 13.10 – The details of the ML model we've imported into BigQuery&#13;&#10;"/></div><p class="figure-caption">Figure 13.10 – The details of the ML model we've imported into BigQuery</p><p>On the <strong class="bold">Details</strong> page of the model, we can clearly see that the model type is <strong class="bold">TENSORFLOW</strong>. This feature confirms that, originally, the ML model was in the TensorFlow SavedModel format and has been imported into BigQuery ML.</p></li>
				<li>Now, we <a id="_idIndexMarker623"/>can use the imported TensorFlow model with the BigQuery ML <strong class="source-inline">ML.PREDICT</strong> function. Let's run the following SQL statement:<p class="source-code">SELECT</p><p class="source-code">  *</p><p class="source-code">FROM</p><p class="source-code">  ML.PREDICT(MODEL `13_tensorflow_model.trip_duration_tf_imported_model`,</p><p class="source-code">    (</p><p class="source-code">    SELECT</p><p class="source-code">         start_station_name,</p><p class="source-code">          end_station_name,</p><p class="source-code">          is_weekend,</p><p class="source-code">          age,</p><p class="source-code">          tripduration</p><p class="source-code">    FROM</p><p class="source-code">           `13_tensorflow_model.prediction_table`));</p><p>The result of the query will be presented after a few seconds in the BigQuery UI.</p><p>The following <a id="_idIndexMarker624"/>screenshot shows the results of executing the query, along with the predictions that were generated by the ML model:</p></li>
			</ol>
			<div>
				<div id="_idContainer194" class="IMG---Figure">
					<img src="image/B16722_13_011.jpg" alt="Figure 13.11 – The predictions that were generated by the TensorFlow model, imported into BigQuery"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.11 – The predictions that were generated by the TensorFlow model, imported into BigQuery</p>
			<p>As we can see, the predicted values are stored in the <strong class="source-inline">predictions</strong> column and represent the predicted trip duration to go from <strong class="source-inline">start_station_name</strong> to <strong class="source-inline">end_station_name</strong> using the bike sharing service.</p>
			<p>In this <a id="_idIndexMarker625"/>section, we learned how to import a TensorFlow model into BigQuery ML and how to use it by leveraging the BigQuery ML SQL syntax.</p>
			<h1 id="_idParaDest-192"><a id="_idTextAnchor194"/>Summary</h1>
			<p>In this chapter, we learned what TensorFlow is and why it is so important for the ML industry. </p>
			<p>First, we analyzed the main commonalities and differences between BigQuery ML and TensorFlow, and we understood that they are addressed to different target personas within the ML community.</p>
			<p>Then, we discovered how we can complement BigQuery ML and TensorFlow to get the maximum value by combining these two frameworks.</p>
			<p>By taking a gradual and step-by-step approach, we learned how to export BigQuery ML models into the TensorFlow format so that we can deploy them into environments other than BigQuery.</p>
			<p>After that, we tested how to import and use a TensorFlow model in BigQuery ML. This approach enables data analysts to easily access and use advanced TensorFlow ML models that have been developed by data scientists and ML engineers. Finally, after importing the ML model, we tested the imported ML model on a BigQuery table to predict the trip duration of a bike ride with the New York City bike sharing service.</p>
			<p>In the next chapter, we'll focus on some BigQuery tips and best practices so that we can improve our ML skills further.</p>
			<h1 id="_idParaDest-193"><a id="_idTextAnchor195"/>Further resources</h1>
			<ul>
				<li><strong class="bold">NYC Bike Sharing Public Dataset</strong>: <a href="https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike">https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike</a></li>
				<li><strong class="bold">BigQuery ML Create Model for TensorFlow</strong>: https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-tensorflow</li>
				<li><strong class="bold">BigQuery ML Evaluate Model</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">BigQuery ML Predict</strong>: <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict">https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict</a></li>
				<li><strong class="bold">TensorFlow official website</strong>: https://www.tensorflow.org/</li>
			</ul>
		</div>
	</body></html>