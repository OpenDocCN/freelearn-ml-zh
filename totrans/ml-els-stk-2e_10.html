<html><head></head><body>
		<div id="_idContainer205">
			<h1 id="_idParaDest-144"><em class="italic"><a id="_idTextAnchor146"/>Chapter 8</em>: Anomaly Detection in Other Elastic Stack Apps</h1>
			<p>When the first edition of this book was authored two years ago, there was no concept of other apps within the stack leveraging Elastic ML for domain-specific solutions. However, since then, Elastic ML has become a <strong class="bold">provider</strong> of anomaly detection for domain-specific solutions, providing tailor-made job configurations that users can enable with a single click.</p>
			<p>In this chapter, we will explore what Elastic ML brings to various Elastic Stack apps:</p>
			<ul>
				<li>Anomaly detection in Elastic APM</li>
				<li>Anomaly detection in the Logs app</li>
				<li>Anomaly detection in the Metrics app</li>
				<li>Anomaly detection in the Uptime app </li>
				<li>Anomaly detection in the Elastic Security app </li>
			</ul>
			<h1 id="_idParaDest-145"><a id="_idTextAnchor147"/>Technical requirements</h1>
			<p>The information in this chapter is relevant as of v7.12 of the Elastic Stack.</p>
			<h1 id="_idParaDest-146"><a id="_idTextAnchor148"/>Anomaly detection in Elastic APM</h1>
			<p>Elastic APM <a id="_idIndexMarker511"/>takes application monitoring and performance <a id="_idIndexMarker512"/>management to a whole new level by allowing users to instrument their application code to get deep insights into the performance of individual microservices and transactions. In complex environments, this could generate a large number of measurements and poses a potentially paradoxical situation – one in which greater observability is obtained via this detailed level of measurement while possibly overwhelming the analyst who has to sift through the results for actionable insights.</p>
			<p>Fortunately, Elastic APM and Elastic ML are a match made in heaven. Anomaly detection not only automatically adapts to the unique performance characteristics of each transaction type via unsupervised machine learning, but it can also scale to handle the possibly voluminous amounts of data that APM can generate.</p>
			<p>While the user is always free to create anomaly detection jobs against any kind of time-series data in any<a id="_idIndexMarker513"/> index, regardless of type, there is a<a id="_idIndexMarker514"/> compelling argument to simply provide pre-made, out-of-the-box job configurations on Elastic APM data, since the data format is already known.</p>
			<h2 id="_idParaDest-147"><a id="_idTextAnchor149"/>Enabling anomaly detection for APM</h2>
			<p>In order to <a id="_idIndexMarker515"/>take advantage of anomaly detection with <a id="_idIndexMarker516"/>your APM data, you need to obviously have some APM data collected for some declared services, and to have the data collected to be stored in indices accessible via the <strong class="source-inline">apm-*</strong> index pattern:</p>
			<ol>
				<li>If you have not yet set up anomaly detection on your APM data, you will see an indicator at the top of the screen letting you know that it still needs to be set up:<div id="_idContainer172" class="IMG---Figure"><img src="image/B17040_08_1.jpg" alt="Figure 8.1 – An indicator for when anomaly detection is not yet enabled on APM&#13;&#10;"/></div><p class="figure-caption">Figure 8.1 – An indicator for when anomaly detection is not yet enabled on APM</p></li>
				<li>To demonstrate what the configuration of anomaly detection would look like, a trivial <em class="italic">Hello World</em> Node.js application was created and instrumented with Elastic APM. This application (called <em class="italic">myapp</em>) was also tagged with the <strong class="source-inline">environment</strong> tag of <strong class="source-inline">dev</strong> to signify that the application is a development app (this is all done within the APM agent for the Node.js configuration):<div id="_idContainer173" class="IMG---Figure"><img src="image/B17040_08_2.jpg" alt="Figure 8.2 – Sample Node.js app instrumented with Elastic APM&#13;&#10;"/></div><p class="figure-caption">Figure 8.2 – Sample Node.js app instrumented with Elastic APM</p></li>
				<li>When<a id="_idIndexMarker517"/> viewed inside of Elastic APM, the <a id="_idIndexMarker518"/>service will look as follows:<div id="_idContainer174" class="IMG---Figure"><img src="image/B17040_08_3.jpg" alt="Figure 8.3 – Sample Node.js app viewed in the Elastic APM UI&#13;&#10;"/></div><p class="figure-caption">Figure 8.3 – Sample Node.js app viewed in the Elastic APM UI</p></li>
				<li>To enable anomaly detection on this service, simply go to <strong class="bold">Settings</strong>, click on <strong class="bold">Anomaly detection</strong>, and then click on the <strong class="bold">Create ML Job</strong> button:<div id="_idContainer175" class="IMG---Figure"><img src="image/B17040_08_4.jpg" alt="Figure 8.4 – Creating ML jobs for APM data&#13;&#10;"/></div><p class="figure-caption">Figure 8.4 – Creating ML jobs for APM data</p></li>
				<li>Next, specify<a id="_idIndexMarker519"/> the environment name that <a id="_idIndexMarker520"/>you want to build the job for:<div id="_idContainer176" class="IMG---Figure"><img src="image/B17040_08_5.jpg" alt="Figure 8.5 – Specifying the environment to build the ML job for&#13;&#10;"/></div><p class="figure-caption">Figure 8.5 – Specifying the environment to build the ML job for</p></li>
				<li>Here we<a id="_idIndexMarker521"/> will select <strong class="bold">dev</strong> as it is the only <a id="_idIndexMarker522"/>choice available for our application. Once selected and after clicking the <strong class="bold">Create Jobs</strong> button, we get confirmation that our job was created, and it is listed in the table:<div id="_idContainer177" class="IMG---Figure"><img src="image/B17040_08_6.jpg" alt="Figure 8.6 – Listing of created anomaly detection jobs in APM&#13;&#10;"/></div><p class="figure-caption">Figure 8.6 – Listing of created anomaly detection jobs in APM</p></li>
				<li>If we go<a id="_idIndexMarker523"/> to the Elastic ML app to see the<a id="_idIndexMarker524"/> details of the job that was created for us, we will see the following:<div id="_idContainer178" class="IMG---Figure"><img src="image/B17040_08_7.jpg" alt="Figure 8.7 – Listing of created anomaly detection jobs in ML&#13;&#10;"/></div><p class="figure-caption">Figure 8.7 – Listing of created anomaly detection jobs in ML</p></li>
				<li>Inspecting this further, we can see that the actual detector configuration for the job is the following:<div id="_idContainer179" class="IMG---Figure"><img src="image/B17040_08_8.jpg" alt="Figure 8.8 – Detector configuration for the APM job&#13;&#10;"/></div><p class="figure-caption">Figure 8.8 – Detector configuration for the APM job</p><p>Notice that this leverages the <strong class="source-inline">high_mean</strong> function on the <strong class="source-inline">transaction.duration.us</strong> field, split both on <strong class="source-inline">transaction.type</strong> and <a id="_idIndexMarker525"/>partitioned on <strong class="source-inline">service.name</strong>. Also <a id="_idIndexMarker526"/>notice that the <strong class="source-inline">bucket_span</strong> value of the job is 15 minutes, which may or may not be the ideal setting for your environment. </p><p class="callout-heading">Note</p><p class="callout">It should be noted that this configuration is the only one possible when using this one-click approach from the APM UI, as the configuration is hardcoded. If you want to customize or create your own configurations, you could either create them from scratch or possibly clone this job and set your own bucket span and/or detector logic. </p></li>
				<li>From the perspective of the data that is being queried, we can click on the <strong class="bold">Datafeed</strong> tab to see the settings as follows:<div id="_idContainer180" class="IMG---Figure"><img src="image/B17040_08_9..jpg" alt="Figure 8.9 – Datafeed configuration for the APM job&#13;&#10;"/></div><p class="figure-caption">Figure 8.9 – Datafeed configuration for the APM job</p><p>Notice<a id="_idIndexMarker527"/> that we are only querying<a id="_idIndexMarker528"/> for documents that match <strong class="source-inline">"service.environment" : "dev"</strong> as we indicated when setting up the job in the APM UI.</p></li>
				<li>We can click on the <strong class="bold">Datafeed preview</strong> tab to see a sample of the observations that will be fed to Elastic ML for this particular job, as shown in the following figure:</li>
			</ol>
			<div>
				<div id="_idContainer181" class="IMG---Figure">
					<img src="image/B17040_08_10..jpg" alt="Figure 8.10 – Datafeed preview for the APM job&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.10 – Datafeed preview for the APM job</p>
			<p>Now that the APM job is configured and running, let's turn our focus to where within the APM UI the anomaly detection job's results will be reflected.</p>
			<h2 id="_idParaDest-148"><a id="_idTextAnchor150"/>Viewing the anomaly detection job results in the APM UI</h2>
			<p>In addition to<a id="_idIndexMarker529"/> viewing the job results in the <a id="_idIndexMarker530"/>Elastic ML UI, there are three key places in which the results of anomaly detection jobs are manifested in the APM UI:</p>
			<ul>
				<li><strong class="bold">Services overview</strong>: This view in the APM UI gives a high-level health indicator that corresponds to the max anomaly score of the anomaly detection results for that particular service:</li>
			</ul>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer182" class="IMG---Figure">
					<img src="image/B17040_08_11..jpg" alt="Figure 8.11 – Services overview in the APM UI&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.11 – Services overview in the APM UI</p>
			<ul>
				<li><strong class="bold">Service map</strong>: This dynamic view shows application transaction dependencies, with a color-coded anomaly indicator based on the max anomaly score of the anomaly detection results for that particular service:</li>
			</ul>
			<div>
				<div id="_idContainer183" class="IMG---Figure">
					<img src="image/B17040_08_12..jpg" alt="Figure 8.12 – Service map in the APM UI&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.12 – Service map in the APM UI</p>
			<ul>
				<li><strong class="bold">Transaction duration chart</strong>: This <a id="_idIndexMarker531"/>chart, under <a id="_idIndexMarker532"/>the main <strong class="bold">Transactions</strong> view in APM, shows the expected bounds and a colored annotation when the anomaly score is over 75 for a particular transaction type:</li>
			</ul>
			<div>
				<div id="_idContainer184" class="IMG---Figure">
					<img src="image/B17040_08_13..jpg" alt="Figure 8.13 – Transaction duration chart in the APM UI&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.13 – Transaction duration chart in the APM UI</p>
			<p>These helpful <a id="_idIndexMarker533"/>indicators of anomalousness<a id="_idIndexMarker534"/> guide the user to investigate further and troubleshoot problems using the deep capabilities of the APM and ML UIs. Let's see one <a id="_idIndexMarker535"/>more way to integrate Elastic ML with data from APM, using the <strong class="bold">data recognizer</strong>.</p>
			<h2 id="_idParaDest-149"><a id="_idTextAnchor151"/>Creating ML Jobs via the data recognizer</h2>
			<p>While "the <a id="_idIndexMarker536"/>data recognizer" isn't an official marketing name<a id="_idIndexMarker537"/> of an actual feature in Elastic ML, it can in fact be very helpful in assisting the user to create pre-configured jobs for data that is <em class="italic">recognized</em>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Pre-configured<a id="_idIndexMarker538"/> jobs for the data recognizer are defined and stored in the following GitHub repository: <a href="https://github.com/elastic/kibana/tree/master/x-pack/plugins/ml/server/models/data_recognizer/modules">https://github.com/elastic/kibana/tree/master/x-pack/plugins/ml/server/models/data_recognizer/modules</a>.</p>
			<p>Essentially, the workflow for creating a new job using the recognizer is as follows:</p>
			<p>If, during the process of creating an anomaly detection job, the data selected for the job's input (index pattern or saved search) matches search patterns known to one of the pre-defined recognizer modules, then you can offer the user the ability to create one of those pre-defined jobs. We can see an example of this using the trivial Node.js example from earlier in this chapter. Instead of creating the anomaly detection job from the APM UI, we can instead go through the Elastic ML UI and select the <strong class="source-inline">apm-*</strong> index pattern:</p>
			<ul>
				<li>By selecting the index pattern, we will see two preconfigured jobs offered to us in<a id="_idIndexMarker539"/> addition <a id="_idIndexMarker540"/>to the normal job wizards:</li>
			</ul>
			<div>
				<div id="_idContainer185" class="IMG---Figure">
					<img src="image/B17040_08_14..jpg" alt="Figure 8.14 – Jobs offered from the data recognizer&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.14 – Jobs offered from the data recognizer</p>
			<ul>
				<li>The first "APM" job is the same type of job we already created earlier in this chapter from the APM UI. The second option (<strong class="bold">APM</strong>: <strong class="bold">Node.js</strong>) is actually a collection of three jobs:</li>
			</ul>
			<div>
				<div id="_idContainer186" class="IMG---Figure">
					<img src="image/B17040_08_15..jpg" alt="Figure 8.15 – Node.js jobs offered from the data recognizer&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.15 – Node.js jobs offered from the data recognizer</p>
			<ul>
				<li>The third is, yet again, the same type of job we already created earlier in this chapter <a id="_idIndexMarker541"/>from the APM UI, but the other two are<a id="_idIndexMarker542"/> unique. This notion of offering the users suggested jobs if the source data is "recognized" is not unique to APM data and you may see those suggested jobs in other situations or use cases (such as choosing the indices of the sample Kibana data, data from nginx, and so on). </li>
			</ul>
			<p>Now that we've seen how Elastic ML is be embedded into the APM app, let's keep exploring to find out how anomaly detection is leveraged by the Logs app.</p>
			<h1 id="_idParaDest-150"><a id="_idTextAnchor152"/>Anomaly detection in the Logs app</h1>
			<p>The Logs<a id="_idIndexMarker543"/> app inside of the <strong class="bold">Observability</strong> section of Kibana <a id="_idIndexMarker544"/>offers a similar view of your data as the Discover app. However, the users who appreciate more of a <em class="italic">live tail</em> view of their logs, regardless of the index the data is stored, will love the Logs app:</p>
			<div>
				<div id="_idContainer187" class="IMG---Figure">
					<img src="image/B17040_08_16..jpg" alt="Figure 8.16 – The Logs app, part of the Observability section of Kibana&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.16 – The Logs app, part of the Observability section of Kibana</p>
			<p>Notice that there<a id="_idIndexMarker545"/> is both an <strong class="bold">Anomalies</strong> tab and a <strong class="bold">Categories</strong> tab. Let's<a id="_idIndexMarker546"/> first discuss the <strong class="bold">Categories</strong> section.</p>
			<h2 id="_idParaDest-151"><a id="_idTextAnchor153"/>Log categories</h2>
			<p>Elastic ML's categorization<a id="_idIndexMarker547"/> capabilities, first shown back in <a href="B17040_03_Epub_AM.xhtml#_idTextAnchor049"><em class="italic">Chapter 3</em></a><em class="italic">, Anomaly Detection</em>, are applied in a generic way to any index of unstructured log data. Within the Logs app, however, categorization is employed with some more strict constraints on the data. In short, the data is expected to be in <strong class="bold">Elastic</strong> <strong class="bold">Common</strong> <strong class="bold">Schema</strong> (<strong class="bold">ECS</strong>) with certain fields defined (especially a field called <strong class="source-inline">event.dataset</strong>).</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The logs dataset from <a href="B17040_07_Epub_AM.xhtml#_idTextAnchor131"><em class="italic">Chapter 7</em></a><em class="italic">, AIOps and Root Cause Analysis</em>, is duplicated for this chapter in the GitHub repository for use with the Logs app, with the addition of the <strong class="source-inline">event.dataset</strong> field. If you're importing via the file upload facility in ML, be sure to override the field name to be <strong class="source-inline">event.dataset</strong> instead of the default <strong class="source-inline">event_dataset</strong> that will be offered.</p>
			<p>One can imagine the reason behind this constraint, given that the Logs app is trying to create the categorization job for you in a templated way. Therefore, it needs to be certain of the naming convention of the fields. This would obviously not be the case if this were to be done in the ML app, where the onus is on the user to declare the names of the categorization field and the message field.</p>
			<p>If you do, however, configure the Logs app to invoke categorization, then the output of this will look something like the following figure, which shows each distinct log category, sorted by<a id="_idIndexMarker548"/> the maximum anomaly score:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer188" class="IMG---Figure">
					<img src="image/B17040_08_17..jpg" alt="Figure 8.17 – The Logs app displaying categorization results from Elastic ML&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.17 – The Logs app displaying categorization results from Elastic ML</p>
			<p>Users can then click the <strong class="bold">Analyze in ML</strong> button to navigate over to the Anomaly Explorer in the ML UI for further inspection.</p>
			<h2 id="_idParaDest-152"><a id="_idTextAnchor154"/>Log anomalies</h2>
			<p>The <strong class="bold">Anomalies</strong> section of <a id="_idIndexMarker549"/>the Logs app provides a view similar to that of the Anomaly Explorer:</p>
			<div>
				<div id="_idContainer189" class="IMG---Figure">
					<img src="image/B17040_08_18..jpg" alt="Figure 8.18 – The Logs app displaying a view similar to ML's Anomaly Explorer&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.18 – The Logs app displaying a view similar to ML's Anomaly Explorer</p>
			<p>It also allows the <a id="_idIndexMarker550"/>user to manage the anomaly detection jobs if the <strong class="bold">Manage ML jobs</strong> button is clicked:</p>
			<div>
				<div id="_idContainer190" class="IMG---Figure">
					<img src="image/B17040_08_19..jpg" alt="Figure 8.19 – The Logs app allowing the management of ML jobs&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.19 – The Logs app allowing the management of ML jobs</p>
			<p>The <strong class="bold">Log rate</strong> job displayed on the left-hand side of <em class="italic">Figure 8.18</em> is just a simple <strong class="source-inline">count</strong> detector, partitioned on the <strong class="source-inline">event.dataset</strong> field.</p>
			<p>Users should note that these ML jobs can be recreated here, but not permanently deleted – you must go to the anomaly detection job management page in the ML app to delete the jobs.</p>
			<p>Obviously, an expert user might just resort to creating and managing their anomaly detection jobs for their logs within the ML app. But it is nice that the Logs app does surface <a id="_idIndexMarker551"/>Elastic ML's capabilities in a way that makes the functionality obvious and easy to implement. Let's continue this trend to see how Elastic ML is utilized in the Metrics app.</p>
			<h2 id="_idParaDest-153"><a id="_idTextAnchor155"/>Anomaly detection in the Metrics app</h2>
			<p>The Metrics<a id="_idIndexMarker552"/> app, also part of the <strong class="bold">Observability</strong> section<a id="_idIndexMarker553"/> of Kibana, allows users to have an inventory and metrics-driven view of their data:</p>
			<ul>
				<li>In the <strong class="bold">Inventory</strong> view, users see an overall map of monitored resources. Entities such as hosts, pods, or containers can be organized and filtered to customize the view – including a color-coded health scale as shown in the following figure:</li>
			</ul>
			<div>
				<div id="_idContainer191" class="IMG---Figure">
					<img src="image/B17040_08_20..jpg" alt="Figure 8.20 – The Metrics app showing the Inventory view&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.20 – The Metrics app showing the Inventory view</p>
			<p>Notice that<a id="_idIndexMarker554"/> the bottom panel would display <a id="_idIndexMarker555"/>anomalies, if detected. This is currently the only place to view anomalies within the Metrics app.</p>
			<ul>
				<li>To enable the built-in anomaly detection jobs via the Metrics app, click the <strong class="bold">Anomaly detection</strong> button at the top to enable the configuration flyout:</li>
			</ul>
			<div>
				<div id="_idContainer192" class="IMG---Figure">
					<img src="image/B17040_08_21..jpg" alt="Figure 8.21 – The Metrics app showing the management of anomaly detection jobs&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.21 – The Metrics app showing the management of anomaly detection jobs</p>
			<ul>
				<li>If, for<a id="_idIndexMarker556"/> example, we choose to enable anomaly <a id="_idIndexMarker557"/>detection for hosts, clicking the appropriate <strong class="bold">Enable</strong> button will show this:</li>
			</ul>
			<div>
				<div id="_idContainer193" class="IMG---Figure">
					<img src="image/B17040_08_22..jpg" alt="Figure 8.22 – The Metrics app showing the config of anomaly detection on hosts&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.22 – The Metrics app showing the config of anomaly detection on hosts</p>
			<ul>
				<li>Notice <a id="_idIndexMarker558"/>that <a id="_idIndexMarker559"/>a partition field is offered as part of the configuration, if desired. When you click the <strong class="bold">Enable jobs</strong> button, three different anomaly detection jobs are created for you on your behalf, viewable in Elastic ML's <strong class="bold">Job</strong> <strong class="bold">Management</strong> section:</li>
			</ul>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer194" class="IMG---Figure">
					<img src="image/B17040_08_23..jpg" alt="Figure 8.23 – The anomaly detection jobs for hosts created by the Metrics app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.23 – The anomaly detection jobs for hosts created by the Metrics app</p>
			<ul>
				<li>To set the <a id="_idIndexMarker560"/>minimum anomaly score required to<a id="_idIndexMarker561"/> have the Metrics app display anomalies for you, head on over to the <strong class="bold">Settings</strong> tab and configure the <strong class="bold">Anomaly Severity Threshold </strong>setting:</li>
			</ul>
			<p class="figure-caption">  </p>
			<div>
				<div id="_idContainer195" class="IMG---Figure">
					<img src="image/B17040_08_24..jpg" alt="Figure 8.24 – The Anomaly Severity Threshold setting within the Metrics app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.24 – The Anomaly Severity Threshold setting within the Metrics app</p>
			<p>The Elastic ML integration with the Metrics app is quite simple and straightforward – it allows the user to quickly get started using anomaly detection on their metric data. Let's now take a quick look at the integration in the Uptime app.</p>
			<h1 id="_idParaDest-154"><a id="_idTextAnchor156"/>Anomaly detection in the Uptime app</h1>
			<p>The<a id="_idIndexMarker562"/> Uptime<a id="_idIndexMarker563"/> app allows simple availability and response time monitoring of services via a variety of network protocols, including <strong class="bold">HTTP/S</strong>, <strong class="bold">TCP</strong>, and <strong class="bold">ICMP</strong>:</p>
			<ol>
				<li value="1">Often classified as <em class="italic">synthetic monitoring</em>, the Uptime app uses Heartbeat to actively probe network endpoints from one or more locations:<p class="figure-caption">  </p><div id="_idContainer196" class="IMG---Figure"><img src="image/B17040_08_25..jpg" alt="Figure 8.25 – The Uptime app in Kibana&#13;&#10;"/></div><p class="figure-caption">Figure 8.25 – The Uptime app in Kibana</p></li>
				<li>If you <a id="_idIndexMarker564"/>would <a id="_idIndexMarker565"/>like to enable anomaly detection on a monitor, simply click on the monitor name to see the monitor detail. Within the <strong class="bold">Monitor duration</strong> panel, notice the <strong class="bold">Enable anomaly detection</strong> button:<p class="figure-caption">  </p><div id="_idContainer197" class="IMG---Figure"><img src="image/B17040_08_26..jpg" alt="Figure 8.26 – Enabling anomaly detection for an Uptime monitor&#13;&#10;"/></div><p class="figure-caption">Figure 8.26 – Enabling anomaly detection for an Uptime monitor</p></li>
				<li>Clicking<a id="_idIndexMarker566"/> on the <strong class="bold">Enable anomaly detection</strong> button <a id="_idIndexMarker567"/>creates the job in the background and offers the user the option to create an alert for anomalies surfaced by the job:<p class="figure-caption">  </p><div id="_idContainer198" class="IMG---Figure"><img src="image/B17040_08_27..jpg" alt="Figure 8.27 – Creating an alert on the anomaly detection job in the Uptime app&#13;&#10;"/></div><p class="figure-caption">Figure 8.27 – Creating an alert on the anomaly detection job in the Uptime app</p></li>
				<li>Once<a id="_idIndexMarker568"/> the <a id="_idIndexMarker569"/>anomaly detection job is available, any anomalies discovered will also be displayed within the monitor's detail page in the <strong class="bold">Monitor duration</strong> panel:</li>
			</ol>
			<div>
				<div id="_idContainer199" class="IMG---Figure">
					<img src="image/B17040_08_28..jpg" alt="Figure 8.28 – Anomalies displayed in the Uptime app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.28 – Anomalies displayed in the Uptime app</p>
			<p>Again, the integration of Elastic ML with another one of the <strong class="bold">Observability</strong> applications in the stack makes it incredibly easy for users to take advantage of sophisticated anomaly <a id="_idIndexMarker570"/>detection. But we also know that Elastic ML can do<a id="_idIndexMarker571"/> some interesting things with respect to population and rare analysis. The integration of ML with the Elastic SIEM is in store for you in the next section – let's get detecting!</p>
			<h1 id="_idParaDest-155"><a id="_idTextAnchor157"/>Anomaly detection in the Elastic Security app</h1>
			<p>Elastic<a id="_idIndexMarker572"/> Security is truly the quintessence<a id="_idIndexMarker573"/> of a purpose-driven application in the Elastic Stack. Created from the ground up with the security analyst's workflow in mind, the comprehensiveness of the Elastic Security app could fill an entire book on its own. However, the heart of the Elastic Security app is the Detections feature in which user- and Elastic-created rules execute to create alerts when rules' conditions are met. As we'll see, Elastic ML plays a significant role in the Detections feature.</p>
			<h2 id="_idParaDest-156"><a id="_idTextAnchor158"/>Prebuilt anomaly detection jobs</h2>
			<p>The majority of the <a id="_idIndexMarker574"/>detection rules in Elastic Security are static, but many are backed by prebuilt anomaly detection jobs that operate on the data collected from Elastic Agent or Beats, or equivalent data that conforms with the ECS fields that are applicable for each job type. To see a comprehensive list of anomaly detection jobs supplied by Elastic, view the datafeed and job configuration definition in the <strong class="source-inline">security_*</strong> and <strong class="source-inline">siem_*</strong> folders in the following GitHub repository: <a href="https://github.com/elastic/kibana/tree/7.12/x-pack/plugins/ml/server/models/data_recognizer/modules">https://github.com/elastic/kibana/tree/7.12/x-pack/plugins/ml/server/models/data_recognizer/modules</a>. </p>
			<p>(You can add the latest release version number in the spot currently occupied by 7.12.) </p>
			<p>An astute reader will notice that many of the prebuilt jobs leverage either population analysis or the rare detector. Each of these styles of anomaly detection is well aligned with the goals of the security analyst – where finding novel behaviors and/or behaviors that make users or entities different from the crowd is often linked to an indicator of compromise.</p>
			<p>The prebuilt anomaly detection jobs are viewable in the <strong class="bold">Detections</strong> tab of Elastic Security and have the ML tag:</p>
			<p class="figure-caption">  </p>
			<div>
				<div id="_idContainer200" class="IMG---Figure">
					<img src="image/B17040_08_29..jpg" alt="Figure 8.29 – ML jobs in the Detection rules section of the Security app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.29 – ML jobs in the Detection rules section of the Security app</p>
			<p>Clicking<a id="_idIndexMarker575"/> on <strong class="bold">ML job settings</strong> at the top right of the screen will expose the settings list, where the user can see all of the jobs in the library – even the ones that are not available (marked with a warning icon):</p>
			<p class="figure-caption">  </p>
			<div>
				<div id="_idContainer201" class="IMG---Figure">
					<img src="image/B17040_08_30..jpg" alt="Figure 8.30 – All jobs in the ML job settings section of the Security app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.30 – All jobs in the ML job settings section of the Security app</p>
			<p>Jobs are marked<a id="_idIndexMarker576"/> as unavailable if the necessary data for the job to use is not currently indexed in Elasticsearch. If the job is available, you can activate the job by clicking the toggle switch and the anomaly detection job will be provisioned in the background. Of course, you can always view the jobs created in the Elastic ML <strong class="bold">Job</strong> <strong class="bold">Management</strong> UI:</p>
			<p class="figure-caption">  </p>
			<div>
				<div id="_idContainer202" class="IMG---Figure">
					<img src="image/B17040_08_31..jpg" alt="Figure 8.31 – Elastic ML jobs created by Security as a view in the Job Management UI&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.31 – Elastic ML jobs created by Security as a view in the Job Management UI</p>
			<p>Now that we<a id="_idIndexMarker577"/> know how to enable anomaly detection jobs, it is time to see how they create detection alerts for the Security app.</p>
			<h2 id="_idParaDest-157"><a id="_idTextAnchor159"/>Anomaly detection jobs as detection alerts</h2>
			<p>As we return<a id="_idIndexMarker578"/> to the <strong class="bold">Detections</strong> view shown back in <em class="italic">Figure 8.28</em>, if you click on the <strong class="bold">Create new rule</strong> button, we can see that we can select <strong class="bold">Machine Learning</strong> as the rule type:</p>
			<p class="figure">  </p>
			<div>
				<div id="_idContainer203" class="IMG---Figure">
					<img src="image/B17040_08_32..jpg" alt="Figure 8.32 – Creating an ML-based detection rule&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.32 – Creating an ML-based detection rule</p>
			<p>If you were to select <a id="_idIndexMarker579"/>a specific machine learning job using the drop-down list, you would also be asked to select the <strong class="bold">Anomaly score threshold</strong> value that needs to be exceeded to trigger the detection alert:</p>
			<p class="figure-caption">  </p>
			<div>
				<div id="_idContainer204" class="IMG---Figure">
					<img src="image/B17040_08_33.jpg" alt="Figure 8.33 – Selecting the ML job and score threshold for the detection rule&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.33 – Selecting the ML job and score threshold for the detection rule</p>
			<p>Obviously, if the job is not currently running, a warning will indicate that the job needs to be started. It is also notable that if you created your own custom job (that is, not using one of the prebuilt jobs) but<a id="_idIndexMarker580"/> assigned it to a <strong class="bold">Job Group</strong> called "security" in the Elastic ML<a id="_idIndexMarker581"/> app, that custom job would also be a candidate to be chosen within the drop-down box in this view. The remainder of the detection rule configuration can be left to the reader – as the rest is not specific to machine learning.</p>
			<p>The Elastic Security app clearly relies heavily on anomaly detection to augment traditional static<a id="_idIndexMarker582"/> rules with dynamic, user/entity behavioral analysis that can surface notable events that are often worthy of investigation. It will be interesting to see how far and how broadly the machine learning capabilities continue to bolster this emerging use case as time goes on!</p>
			<h1 id="_idParaDest-158"><a id="_idTextAnchor160"/>Summary</h1>
			<p>Elastic ML has clearly infiltrated many of the other apps in the Elastic Stack, bringing easy-to-use functionality to users' fingertips. This proves how much Elastic ML is really a core functionality to the Stack itself, akin to other key stack features such as aggregations. </p>
			<p>Congratulations, you have reached the end of the first half of this book, and hopefully you feel well armed with everything that you need to know about Elastic ML's anomaly detection. </p>
			<p>Now, we will venture into the "<em class="italic">other side"</em> of Elastic ML – data frame analytics – where you will learn how to bring other machine learning techniques (including supervised-based model creation and inferencing) to open up analytical solutions to a vast new array of use cases.</p>
		</div>
	</body></html>