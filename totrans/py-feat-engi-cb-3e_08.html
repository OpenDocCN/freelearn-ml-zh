<html><head></head><body>
<div id="_idContainer164">
<p><a id="_idTextAnchor984"/><a id="_idTextAnchor985"/><a id="_idTextAnchor986"/></p>
<h1 class="chapter-number" id="_idParaDest-219"><a id="_idTextAnchor987"/><span class="koboSpan" id="kobo.1.1" xmlns:="http://www.w3.org/1999/xhtml">8</span></h1>
<h1 id="_idParaDest-220"><a id="_idTextAnchor988"/><span class="koboSpan" id="kobo.2.1" xmlns:="http://www.w3.org/1999/xhtml">Creating New Features</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns:="http://www.w3.org/1999/xhtml">Adding new features to a dataset can help machine learning models learn patterns and important details in the data. </span><span class="koboSpan" id="kobo.3.2" xmlns:="http://www.w3.org/1999/xhtml">For example, in finance, the </span><strong class="bold"><span class="koboSpan" id="kobo.4.1" xmlns:="http://www.w3.org/1999/xhtml">disposable income</span></strong><span class="koboSpan" id="kobo.5.1" xmlns:="http://www.w3.org/1999/xhtml">, which is the </span><em class="italic"><span class="koboSpan" id="kobo.6.1" xmlns:="http://www.w3.org/1999/xhtml">total income</span></em><span class="koboSpan" id="kobo.7.1" xmlns:="http://www.w3.org/1999/xhtml"> minus the </span><em class="italic"><span class="koboSpan" id="kobo.8.1" xmlns:="http://www.w3.org/1999/xhtml">acquired debt</span></em><span class="koboSpan" id="kobo.9.1" xmlns:="http://www.w3.org/1999/xhtml"> for any</span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.10.1" xmlns:="http://www.w3.org/1999/xhtml"> one month, might be more relevant for credit risk than just the income or the acquired debt. </span><span class="koboSpan" id="kobo.10.2" xmlns:="http://www.w3.org/1999/xhtml">Similarly, the </span><em class="italic"><span class="koboSpan" id="kobo.11.1" xmlns:="http://www.w3.org/1999/xhtml">total acquired debt</span></em><span class="koboSpan" id="kobo.12.1" xmlns:="http://www.w3.org/1999/xhtml"> of a person across financial products, such as a car loan, a mortgage, and credit cards, might be more important to estimate the credit risk than any debt considered individually. </span><span class="koboSpan" id="kobo.12.2" xmlns:="http://www.w3.org/1999/xhtml">In these examples, we use domain knowledge to craft new variables, and these variables are created by adding or subtracting </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1" xmlns:="http://www.w3.org/1999/xhtml">existing features.</span></span></p>
<p><span class="koboSpan" id="kobo.14.1" xmlns:="http://www.w3.org/1999/xhtml">In some cases, a variable may not have a linear or monotonic relationship with the target, but a polynomial combination might. </span><span class="koboSpan" id="kobo.14.2" xmlns:="http://www.w3.org/1999/xhtml">For example, if our variable has a quadratic relationship with the target, </span><span class="koboSpan" id="kobo.15.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow&gt;&lt;mrow&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/math&gt;" src="image/36.png" style="vertical-align:-0.257em;height:0.960em;width:2.392em"/></span><span class="koboSpan" id="kobo.16.1" xmlns:="http://www.w3.org/1999/xhtml">, we can convert that into a linear relationship by squaring the original variable. </span><span class="koboSpan" id="kobo.16.2" xmlns:="http://www.w3.org/1999/xhtml">We can also help linear models better understand the relationships between variables and targets by transforming the predictors through splines, or by using </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1" xmlns:="http://www.w3.org/1999/xhtml">decision trees.</span></span></p>
<p><span class="koboSpan" id="kobo.18.1" xmlns:="http://www.w3.org/1999/xhtml">The advantage of crafting additional features to train simpler models, such as linear or logistic regression, is that both the features and the models remain interpretable. </span><span class="koboSpan" id="kobo.18.2" xmlns:="http://www.w3.org/1999/xhtml">We can explain the reasons driving a model’s output to management, clients, and regulators, adding a layer of transparency to our machine learning pipelines. </span><span class="koboSpan" id="kobo.18.3" xmlns:="http://www.w3.org/1999/xhtml">In addition, simpler models tend to be faster to train and easier to deploy </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1" xmlns:="http://www.w3.org/1999/xhtml">and maintain.</span></span></p>
<p><span class="koboSpan" id="kobo.20.1" xmlns:="http://www.w3.org/1999/xhtml">In this chapter, we will create new features by transforming or combining variables with mathematical functions, splines, and </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1" xmlns:="http://www.w3.org/1999/xhtml">decision trees.</span></span></p>
<p><span class="koboSpan" id="kobo.22.1" xmlns:="http://www.w3.org/1999/xhtml">This chapter will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1" xmlns:="http://www.w3.org/1999/xhtml">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.24.1" xmlns:="http://www.w3.org/1999/xhtml">Combining features with </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1" xmlns:="http://www.w3.org/1999/xhtml">mathematical functions</span></span></li>
<li><span class="koboSpan" id="kobo.26.1" xmlns:="http://www.w3.org/1999/xhtml">Comparing features to </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1" xmlns:="http://www.w3.org/1999/xhtml">reference variables</span></span></li>
<li><span class="koboSpan" id="kobo.28.1" xmlns:="http://www.w3.org/1999/xhtml">Performing </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1" xmlns:="http://www.w3.org/1999/xhtml">polynomial expansion</span></span></li>
<li><span class="koboSpan" id="kobo.30.1" xmlns:="http://www.w3.org/1999/xhtml">Combining features with </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1" xmlns:="http://www.w3.org/1999/xhtml">decision trees</span></span></li>
<li><span class="koboSpan" id="kobo.32.1" xmlns:="http://www.w3.org/1999/xhtml">Creating periodic features from </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1" xmlns:="http://www.w3.org/1999/xhtml">cyclical variables</span></span></li>
<li><span class="koboSpan" id="kobo.34.1" xmlns:="http://www.w3.org/1999/xhtml">Creating </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1" xmlns:="http://www.w3.org/1999/xhtml">spline features</span></span><a id="_idTextAnchor989"/><a id="_idTextAnchor990"/></li>
</ul>
<h1 id="_idParaDest-221"><a id="_idTextAnchor991"/><span class="koboSpan" id="kobo.36.1" xmlns:="http://www.w3.org/1999/xhtml">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.37.1" xmlns:="http://www.w3.org/1999/xhtml">In this chapter, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.38.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.39.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.40.1" xmlns:="http://www.w3.org/1999/xhtml">numpy</span></strong><span class="koboSpan" id="kobo.41.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.42.1" xmlns:="http://www.w3.org/1999/xhtml">matplotlib</span></strong><span class="koboSpan" id="kobo.43.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.44.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.45.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.46.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.47.1" xmlns:="http://www.w3.org/1999/xhtml">Python libraries.</span></span><a id="_idTextAnchor992"/><a id="_idTextAnchor993"/></p>
<h1 id="_idParaDest-222"><a id="_idTextAnchor994"/><span class="koboSpan" id="kobo.48.1" xmlns:="http://www.w3.org/1999/xhtml">Combining features with mathematical functions</span></h1>
<p><span class="koboSpan" id="kobo.49.1" xmlns:="http://www.w3.org/1999/xhtml">New features</span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.50.1" xmlns:="http://www.w3.org/1999/xhtml"> can be created by combining existing variables with mathematical and statistical functions. </span><span class="koboSpan" id="kobo.50.2" xmlns:="http://www.w3.org/1999/xhtml">Taking an example from</span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.51.1" xmlns:="http://www.w3.org/1999/xhtml"> the finance industry, we can calcula</span><a id="_idTextAnchor995"/><span class="koboSpan" id="kobo.52.1" xmlns:="http://www.w3.org/1999/xhtml">te the total debt of a person by summing up their debt across individual financial products, such as car loan, mortgage, or credit </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1" xmlns:="http://www.w3.org/1999/xhtml">card debt:</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.54.1" xmlns:="http://www.w3.org/1999/xhtml">Total debt = car loan debt + credit card debt + </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.55.1" xmlns:="http://www.w3.org/1999/xhtml">mortgage debt</span></em></span></p>
<p><span class="koboSpan" id="kobo.56.1" xmlns:="http://www.w3.org/1999/xhtml">We can also derive other insightful features using alternative statistical operations. </span><span class="koboSpan" id="kobo.56.2" xmlns:="http://www.w3.org/1999/xhtml">For example, we can determine the maximum debt of a customer across financial products or the average time a user spends on </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1" xmlns:="http://www.w3.org/1999/xhtml">a website:</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.58.1" xmlns:="http://www.w3.org/1999/xhtml">maximum debt = max(car loan balance, credit card balance, </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.59.1" xmlns:="http://www.w3.org/1999/xhtml">mortgage balance)</span></em></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.60.1" xmlns:="http://www.w3.org/1999/xhtml">average time on website = mean(time spent on homepage, time spent on about page, time spent on </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.61.1" xmlns:="http://www.w3.org/1999/xhtml">FAQ page)</span></em></span></p>
<p><span class="koboSpan" id="kobo.62.1" xmlns:="http://www.w3.org/1999/xhtml">We can, in principle, use any mathematical or statistical operation to create new features, such as the product, mean, standard deviation, or maximum or minimum values. </span><span class="koboSpan" id="kobo.62.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will implement these mathematical operations using </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.64.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.65.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.66.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.67.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.68.1" xmlns:="http://www.w3.org/1999/xhtml">While, in the recipe, we can show you how to combine features with mathematical functions, we can’t do justice to the use of domain knowledge in deciding which function to apply, as that varies with every domain. </span><span class="koboSpan" id="kobo.68.2" xmlns:="http://www.w3.org/1999/xhtml">So, we will leave that </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1" xmlns:="http://www.w3.org/1999/xhtml">with yo</span><a id="_idTextAnchor996"/><a id="_idTextAnchor997"/><span class="koboSpan" id="kobo.70.1" xmlns:="http://www.w3.org/1999/xhtml">u.</span></span></p>
<h2 id="_idParaDest-223"><a id="_idTextAnchor998"/><span class="koboSpan" id="kobo.71.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.72.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we </span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.73.1" xmlns:="http://www.w3.org/1999/xhtml">will use the breast cancer dataset from </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.75.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.75.2" xmlns:="http://www.w3.org/1999/xhtml">The features are computed from digitized images of </span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.76.1" xmlns:="http://www.w3.org/1999/xhtml">breast cells and describe the characteristics of their cell nuclei, in terms of smoothness, concavity, symmetry, and compactness, among others. </span><span class="koboSpan" id="kobo.76.2" xmlns:="http://www.w3.org/1999/xhtml">Each row contains information about the morphology of cell nuclei in a tissue sample. </span><span class="koboSpan" id="kobo.76.3" xmlns:="http://www.w3.org/1999/xhtml">The target variable indicates whether the tissue sample corresponds to cancerous cells. </span><span class="koboSpan" id="kobo.76.4" xmlns:="http://www.w3.org/1999/xhtml">The idea is to predict whether the tissue samples belong to benign or malignant breast cells, based on their cell </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1" xmlns:="http://www.w3.org/1999/xhtml">nuclei morphology.</span></span></p>
<p><span class="koboSpan" id="kobo.78.1" xmlns:="http://www.w3.org/1999/xhtml">To become familiar with the dataset, run the following commands in a Jupyter notebook or </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1" xmlns:="http://www.w3.org/1999/xhtml">Python console:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.80.1" xmlns:="http://www.w3.org/1999/xhtml">
from sklearn.datasets import load_breast_cancer
data = load_breast_cancer()
print(data.DESCR)</span></pre> <p><span class="koboSpan" id="kobo.81.1" xmlns:="http://www.w3.org/1999/xhtml">The preceding code block should print out a description of the dataset and an interpretation of </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1" xmlns:="http://www.w3.org/1999/xhtml">its variab</span><a id="_idTextAnchor999"/><a id="_idTextAnchor1000"/><span class="koboSpan" id="kobo.83.1" xmlns:="http://www.w3.org/1999/xhtml">les.</span></span></p>
<h2 id="_idParaDest-224"><a id="_idTextAnchor1001"/><span class="koboSpan" id="kobo.84.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.85.1" xmlns:="http://www.w3.org/1999/xhtml">In </span><a id="_idTextAnchor1002"/><span class="koboSpan" id="kobo.86.1" xmlns:="http://www.w3.org/1999/xhtml">this recipe, we will create new features by combining variables using multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1" xmlns:="http://www.w3.org/1999/xhtml">mathematical operations:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.88.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by loading the necessary libraries, classes, </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1" xmlns:="http://www.w3.org/1999/xhtml">and data:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.90.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
from feature_engine.creation import MathFeatures
from sklearn.datasets import load_breast_cancer</span></pre></li> <li><span class="koboSpan" id="kobo.91.1" xmlns:="http://www.w3.org/1999/xhtml">Next, load the breast cancer dataset into a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.92.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.93.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.94.1" xmlns:="http://www.w3.org/1999/xhtml">
data = load_breast_cancer()
df = pd.DataFrame(data.data,
    columns=data.feature_names)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.95.1" xmlns:="http://www.w3.org/1999/xhtml">In the following code lines, we will create new features by combining variables using multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1" xmlns:="http://www.w3.org/1999/xhtml">mathematical operations.</span></span></p></li> <li><span class="koboSpan" id="kobo.97.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s</span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.98.1" xmlns:="http://www.w3.org/1999/xhtml"> begin</span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.99.1" xmlns:="http://www.w3.org/1999/xhtml"> by creating a list with the subset of the features that we want </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1" xmlns:="http://www.w3.org/1999/xhtml">to combine:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.101.1" xmlns:="http://www.w3.org/1999/xhtml">
features = [
    «mean smoothness",
    «mean compactness",
    «mean concavity",
    «mean concave points",
    «mean symmetry",
]</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.102.1" xmlns:="http://www.w3.org/1999/xhtml">The features in </span><em class="italic"><span class="koboSpan" id="kobo.103.1" xmlns:="http://www.w3.org/1999/xhtml">step 3</span></em><span class="koboSpan" id="kobo.104.1" xmlns:="http://www.w3.org/1999/xhtml"> represent the mean characteristics of cell nuclei in the images. </span><span class="koboSpan" id="kobo.104.2" xmlns:="http://www.w3.org/1999/xhtml">It might be useful to obtain the mean across all </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1" xmlns:="http://www.w3.org/1999/xhtml">examined characteristics.</span></span></p></li> <li><span class="koboSpan" id="kobo.106.1" xmlns:="http://www.w3.org/1999/xhtml">Let</span><a id="_idTextAnchor1003"/><span class="koboSpan" id="kobo.107.1" xmlns:="http://www.w3.org/1999/xhtml">’s get the mean value of the features and then display the </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1" xmlns:="http://www.w3.org/1999/xhtml">resulting feature:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.109.1" xmlns:="http://www.w3.org/1999/xhtml">
df["mean_features"] = df[features].mean(axis=1)
df["mean_features"].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.110.1" xmlns:="http://www.w3.org/1999/xhtml">The following output shows the mean value of the features from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.111.1" xmlns:="http://www.w3.org/1999/xhtml">step 3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.112.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.113.1" xmlns:="http://www.w3.org/1999/xhtml">0    0.21702</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.114.1" xmlns:="http://www.w3.org/1999/xhtml">1    0.10033</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.115.1" xmlns:="http://www.w3.org/1999/xhtml">2    0.16034</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.116.1" xmlns:="http://www.w3.org/1999/xhtml">3    0.20654</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.117.1" xmlns:="http://www.w3.org/1999/xhtml">4    0.14326</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.118.1" xmlns:="http://www.w3.org/1999/xhtml">Name: mean_features, dtype: float64</span></strong></pre></li> <li><span class="koboSpan" id="kobo.119.1" xmlns:="http://www.w3.org/1999/xhtml">Similarly, to</span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.120.1" xmlns:="http://www.w3.org/1999/xhtml"> capture the general </span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.121.1" xmlns:="http://www.w3.org/1999/xhtml">variability of the cell nuclei, let’s determine the standard deviation of the mean characteristics, and then display the </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1" xmlns:="http://www.w3.org/1999/xhtml">resulting feature:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.123.1" xmlns:="http://www.w3.org/1999/xhtml">
df["std_features"] = df[features].std(axis=1)
df["std_features"].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.124.1" xmlns:="http://www.w3.org/1999/xhtml">The following output shows the standard deviation of the features from </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1" xmlns:="http://www.w3.org/1999/xhtml">step 3:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.126.1" xmlns:="http://www.w3.org/1999/xhtml">0    0.080321</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.127.1" xmlns:="http://www.w3.org/1999/xhtml">1    0.045671</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.128.1" xmlns:="http://www.w3.org/1999/xhtml">2    0.042333</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.129.1" xmlns:="http://www.w3.org/1999/xhtml">3    0.078097</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.130.1" xmlns:="http://www.w3.org/1999/xhtml">4    0.044402</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.131.1" xmlns:="http://www.w3.org/1999/xhtml">Name: std_features, dtype: float64</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.132.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.133.1" xmlns:="http://www.w3.org/1999/xhtml">When we craft new features based on domain knowledge, we know exactly how we want to combine the variables. </span><span class="koboSpan" id="kobo.133.2" xmlns:="http://www.w3.org/1999/xhtml">We could also combine features with multiple operations and then evaluate whether they are predictive, using, for example, a feature selection algorithm or deriving feature importance from the machine </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1" xmlns:="http://www.w3.org/1999/xhtml">learning model.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.135.1" xmlns:="http://www.w3.org/1999/xhtml">Le</span><a id="_idTextAnchor1004"/><span class="koboSpan" id="kobo.136.1" xmlns:="http://www.w3.org/1999/xhtml">t’s make a list containing mathematical functions that we want to use to combine </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1" xmlns:="http://www.w3.org/1999/xhtml">the features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.138.1" xmlns:="http://www.w3.org/1999/xhtml">
math_func = [
    "sum", "prod", "mean", "std", "max", "min"]</span></pre></li> <li><span class="koboSpan" id="kobo.139.1" xmlns:="http://www.w3.org/1999/xhtml">Now, let’s apply the functions from </span><em class="italic"><span class="koboSpan" id="kobo.140.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.141.1" xmlns:="http://www.w3.org/1999/xhtml"> to combine the features from </span><em class="italic"><span class="koboSpan" id="kobo.142.1" xmlns:="http://www.w3.org/1999/xhtml">step 3</span></em><span class="koboSpan" id="kobo.143.1" xmlns:="http://www.w3.org/1999/xhtml">, capturing the</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.144.1" xmlns:="http://www.w3.org/1999/xhtml"> resulting variables in a </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1" xmlns:="http://www.w3.org/1999/xhtml">new DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.146.1" xmlns:="http://www.w3.org/1999/xhtml">
df_t = df[features].agg(math_func, axis="columns")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.147.1" xmlns:="http://www.w3.org/1999/xhtml">If we</span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.148.1" xmlns:="http://www.w3.org/1999/xhtml"> execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1" xmlns:="http://www.w3.org/1999/xhtml">df_t.head()</span></strong><span class="koboSpan" id="kobo.150.1" xmlns:="http://www.w3.org/1999/xhtml">, we will see the DataFrame with the newly </span><span class="No-Break"><span class="koboSpan" id="kobo.151.1" xmlns:="http://www.w3.org/1999/xhtml">created </span><a id="_idTextAnchor1005"/><span class="koboSpan" id="kobo.152.1" xmlns:="http://www.w3.org/1999/xhtml">features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer139">
<span class="koboSpan" id="kobo.153.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.1 – A DataFrame with the newly created features" src="image/B22396_08_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.154.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.1 – A DataFrame with the newly created features</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.155.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.156.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.157.1" xmlns:="http://www.w3.org/1999/xhtml">agg</span></strong><span class="koboSpan" id="kobo.158.1" xmlns:="http://www.w3.org/1999/xhtml"> can apply multiple functions to combine features. </span><span class="koboSpan" id="kobo.158.2" xmlns:="http://www.w3.org/1999/xhtml">It can take a list of strings with the function names, as we did in </span><em class="italic"><span class="koboSpan" id="kobo.159.1" xmlns:="http://www.w3.org/1999/xhtml">step 7</span></em><span class="koboSpan" id="kobo.160.1" xmlns:="http://www.w3.org/1999/xhtml">; a list of NumPy functions, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1" xmlns:="http://www.w3.org/1999/xhtml">np.log</span></strong><span class="koboSpan" id="kobo.162.1" xmlns:="http://www.w3.org/1999/xhtml">; and Python functions that </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1" xmlns:="http://www.w3.org/1999/xhtml">you creat</span><a id="_idTextAnchor1006"/><span class="koboSpan" id="kobo.164.1" xmlns:="http://www.w3.org/1999/xhtml">e.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.165.1" xmlns:="http://www.w3.org/1999/xhtml">We can create the same features that we created with </span><strong class="source-inline"><span class="koboSpan" id="kobo.166.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.167.1" xmlns:="http://www.w3.org/1999/xhtml"> automatically by </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1" xmlns:="http://www.w3.org/1999/xhtml">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.169.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.170.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.171.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a list by using the name of the </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1" xmlns:="http://www.w3.org/1999/xhtml">output features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.173.1" xmlns:="http://www.w3.org/1999/xhtml">
new_feature_names = [
    "sum_f", "prod_f", "mean_f",
    „std_f", „max_f", „min_f"]</span></pre></li> <li><span class="koboSpan" id="kobo.174.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set up </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1" xmlns:="http://www.w3.org/1999/xhtml">MathFeatures()</span></strong><span class="koboSpan" id="kobo.176.1" xmlns:="http://www.w3.org/1999/xhtml"> to apply the functions in </span><em class="italic"><span class="koboSpan" id="kobo.177.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.178.1" xmlns:="http://www.w3.org/1999/xhtml"> to the features from </span><em class="italic"><span class="koboSpan" id="kobo.179.1" xmlns:="http://www.w3.org/1999/xhtml">step 3</span></em><span class="koboSpan" id="kobo.180.1" xmlns:="http://www.w3.org/1999/xhtml">, naming the new features with the strings from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.181.1" xmlns:="http://www.w3.org/1999/xhtml">step 8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.182.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.183.1" xmlns:="http://www.w3.org/1999/xhtml">
create = MathFeatures(
    variables=features,
    func=math_func,
    new_variables_names=new_feature_names</span><a id="_idTextAnchor1007"/><span class="koboSpan" id="kobo.184.1" xmlns:="http://www.w3.org/1999/xhtml">,
)</span></pre></li> <li><span class="koboSpan" id="kobo.185.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add </span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.186.1" xmlns:="http://www.w3.org/1999/xhtml">the new features</span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.187.1" xmlns:="http://www.w3.org/1999/xhtml"> to the original DataFrame, capturing the result in a </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1" xmlns:="http://www.w3.org/1999/xhtml">new variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.189.1" xmlns:="http://www.w3.org/1999/xhtml">
df_t = create.fit_transform(df)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.190.1" xmlns:="http://www.w3.org/1999/xhtml">We can display the input and output features by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1" xmlns:="http://www.w3.org/1999/xhtml">df_t[features + </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.192.1" xmlns:="http://www.w3.org/1999/xhtml">new_feature_name</span><a id="_idTextAnchor1008"/><span class="koboSpan" id="kobo.193.1" xmlns:="http://www.w3.org/1999/xhtml">s].head()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.194.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer140">
<span class="koboSpan" id="kobo.195.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.2 – DataFrame with the input features and the newly created variables" src="image/B22396_08_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.196.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.2 – DataFrame with the input features and the newly created variables</span></p>
<p><span class="koboSpan" id="kobo.197.1" xmlns:="http://www.w3.org/1999/xhtml">While </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.199.1" xmlns:="http://www.w3.org/1999/xhtml">agg</span></strong><span class="koboSpan" id="kobo.200.1" xmlns:="http://www.w3.org/1999/xhtml"> returns a DataFrame with the features resulting from the operation, </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.202.1" xmlns:="http://www.w3.org/1999/xhtml"> goes one step further, by concatenating the new features to the </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1" xmlns:="http://www.w3.org/1999/xhtml">original </span><a id="_idTextAnchor1009"/><a id="_idTextAnchor1010"/><span class="koboSpan" id="kobo.204.1" xmlns:="http://www.w3.org/1999/xhtml">DataFrame.</span></span></p>
<h2 id="_idParaDest-225"><a id="_idTextAnchor1011"/><span class="koboSpan" id="kobo.205.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.206.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.207.1" xmlns:="http://www.w3.org/1999/xhtml"> has many built-in operations to apply mathematical and statistical computations to a group of variables. </span><span class="koboSpan" id="kobo.207.2" xmlns:="http://www.w3.org/1999/xhtml">To combine features mathematically, we first made a list containing the names of the features we wanted to combine. </span><span class="koboSpan" id="kobo.207.3" xmlns:="http://www.w3.org/1999/xhtml">Then, we determined the mean and standard deviation of those features by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.209.1" xmlns:="http://www.w3.org/1999/xhtml">mean()</span></strong><span class="koboSpan" id="kobo.210.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1" xmlns:="http://www.w3.org/1999/xhtml">std()</span></strong><span class="koboSpan" id="kobo.212.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.212.2" xmlns:="http://www.w3.org/1999/xhtml">We could also apply any of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1" xmlns:="http://www.w3.org/1999/xhtml">sum()</span></strong><span class="koboSpan" id="kobo.214.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1" xmlns:="http://www.w3.org/1999/xhtml">prod()</span></strong><span class="koboSpan" id="kobo.216.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1" xmlns:="http://www.w3.org/1999/xhtml">max()</span></strong><span class="koboSpan" id="kobo.218.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1" xmlns:="http://www.w3.org/1999/xhtml">min()</span></strong><span class="koboSpan" id="kobo.220.1" xmlns:="http://www.w3.org/1999/xhtml"> methods, which return the sum, product, maximum, and minimum values of those features, respectively. </span><span class="koboSpan" id="kobo.220.2" xmlns:="http://www.w3.org/1999/xhtml">To perform these operations across the columns, we added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1" xmlns:="http://www.w3.org/1999/xhtml">axis=1</span></strong><span class="koboSpan" id="kobo.222.1" xmlns:="http://www.w3.org/1999/xhtml"> argument within </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1" xmlns:="http://www.w3.org/1999/xhtml">the methods.</span></span></p>
<p><span class="koboSpan" id="kobo.224.1" xmlns:="http://www.w3.org/1999/xhtml">With pandas </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1" xmlns:="http://www.w3.org/1999/xhtml">agg()</span></strong><span class="koboSpan" id="kobo.226.1" xmlns:="http://www.w3.org/1999/xhtml">, we </span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.227.1" xmlns:="http://www.w3.org/1999/xhtml">applied several mathematical functions simultaneously. </span><span class="koboSpan" id="kobo.227.2" xmlns:="http://www.w3.org/1999/xhtml">It takes as arguments a list of strings, corresponding to the functions to apply and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1" xmlns:="http://www.w3.org/1999/xhtml">axis</span></strong><span class="koboSpan" id="kobo.229.1" xmlns:="http://www.w3.org/1999/xhtml"> that the functions should be applied to, which can be either </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1" xmlns:="http://www.w3.org/1999/xhtml">1</span></strong><span class="koboSpan" id="kobo.231.1" xmlns:="http://www.w3.org/1999/xhtml"> for columns or </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1" xmlns:="http://www.w3.org/1999/xhtml">0</span></strong><span class="koboSpan" id="kobo.233.1" xmlns:="http://www.w3.org/1999/xhtml"> for rows. </span><span class="koboSpan" id="kobo.233.2" xmlns:="http://www.w3.org/1999/xhtml">As a result, pandas </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1" xmlns:="http://www.w3.org/1999/xhtml">agg()</span></strong><span class="koboSpan" id="kobo.235.1" xmlns:="http://www.w3.org/1999/xhtml"> returned a </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.237.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame, resulting from applying the mathematical functions to the groups </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1" xmlns:="http://www.w3.org/1999/xhtml">of features.</span></span></p>
<p><span class="koboSpan" id="kobo.239.1" xmlns:="http://www.w3.org/1999/xhtml">Finally,</span><a id="_idTextAnchor1012"/><span class="koboSpan" id="kobo.240.1" xmlns:="http://www.w3.org/1999/xhtml"> we </span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.241.1" xmlns:="http://www.w3.org/1999/xhtml">created the same features by combining variables with </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.243.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.243.2" xmlns:="http://www.w3.org/1999/xhtml">We used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.244.1" xmlns:="http://www.w3.org/1999/xhtml">MathFeatures()</span></strong><span class="koboSpan" id="kobo.245.1" xmlns:="http://www.w3.org/1999/xhtml"> transformer, which takes the features to combine and the functions to apply as input; it also has the option to indicate the names of the resulting features. </span><span class="koboSpan" id="kobo.245.2" xmlns:="http://www.w3.org/1999/xhtml">When we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1" xmlns:="http://www.w3.org/1999/xhtml">fit()</span></strong><span class="koboSpan" id="kobo.247.1" xmlns:="http://www.w3.org/1999/xhtml">, the transformer did not learn parameters but checked that the variables were indeed numerical. </span><span class="koboSpan" id="kobo.247.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.249.1" xmlns:="http://www.w3.org/1999/xhtml"> method triggered the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1" xmlns:="http://www.w3.org/1999/xhtml">pandas.agg</span></strong><span class="koboSpan" id="kobo.251.1" xmlns:="http://www.w3.org/1999/xhtml"> under the hood, applying the mathematical functions to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1" xmlns:="http://www.w3.org/1999/xhtml">ne</span><a id="_idTextAnchor1013"/><a id="_idTextAnchor1014"/><span class="koboSpan" id="kobo.253.1" xmlns:="http://www.w3.org/1999/xhtml">w variables.</span></span></p>
<h2 id="_idParaDest-226"><span class="koboSpan" id="kobo.254.1" xmlns:="http://www.w3.org/1999/xhtml">See also</span><a id="_idTextAnchor1015"/></h2>
<p><span class="koboSpan" id="kobo.255.1" xmlns:="http://www.w3.org/1999/xhtml">To find out more about the mathematical operations supported by </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.257.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/frame.html#computations-descriptive-stats"><span class="No-Break"><span class="koboSpan" id="kobo.259.1" xmlns:="http://www.w3.org/1999/xhtml">https://pandas.pydata.org/pandas-docs/stable/reference/frame.html#computations-descriptive-stats</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.260.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.261.1" xmlns:="http://www.w3.org/1999/xhtml">To learn more about </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.263.1" xmlns:="http://www.w3.org/1999/xhtml">aggregate</span></strong><span class="koboSpan" id="kobo.264.1" xmlns:="http://www.w3.org/1999/xhtml">, check </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1" xmlns:="http://www.w3.org/1999/xhtml">out </span></span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.aggregate.html"><span class="No-Break"><span class="koboSpan" id="kobo.266.1" xmlns:="http://www.w3.org/1999/xhtml">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.agg</span><span id="_idTextAnchor1016"/><span id="_idTextAnchor1017"/><span class="koboSpan" id="kobo.267.1" xmlns:="http://www.w3.org/1999/xhtml">regate.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.268.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h1 id="_idParaDest-227"><span class="koboSpan" id="kobo.269.1" xmlns:="http://www.w3.org/1999/xhtml">Comparing features to reference vari</span><a id="_idTextAnchor1018"/><span class="koboSpan" id="kobo.270.1" xmlns:="http://www.w3.org/1999/xhtml">ables</span></h1>
<p><span class="koboSpan" id="kobo.271.1" xmlns:="http://www.w3.org/1999/xhtml">In the </span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.272.1" xmlns:="http://www.w3.org/1999/xhtml">previous recipe, </span><em class="italic"><span class="koboSpan" id="kobo.273.1" xmlns:="http://www.w3.org/1999/xhtml">Combining features with mathematical functions</span></em><span class="koboSpan" id="kobo.274.1" xmlns:="http://www.w3.org/1999/xhtml">, we created new features by applying mathematical</span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.275.1" xmlns:="http://www.w3.org/1999/xhtml"> or statistical functions, such as the sum or the mean, to a group of variables. </span><span class="koboSpan" id="kobo.275.2" xmlns:="http://www.w3.org/1999/xhtml">Some mathematical operations, however, such as subtraction or division, are performed </span><em class="italic"><span class="koboSpan" id="kobo.276.1" xmlns:="http://www.w3.org/1999/xhtml">between</span></em><span class="koboSpan" id="kobo.277.1" xmlns:="http://www.w3.org/1999/xhtml"> features. </span><span class="koboSpan" id="kobo.277.2" xmlns:="http://www.w3.org/1999/xhtml">Th</span><a id="_idTextAnchor1019"/><span class="koboSpan" id="kobo.278.1" xmlns:="http://www.w3.org/1999/xhtml">ese operations are useful to derive ratios, such as the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.279.1" xmlns:="http://www.w3.org/1999/xhtml">debt-to-income ratio</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.280.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.281.1" xmlns:="http://www.w3.org/1999/xhtml">debt-to-income ratio = total debt / </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.282.1" xmlns:="http://www.w3.org/1999/xhtml">total income</span></em></span></p>
<p><span class="koboSpan" id="kobo.283.1" xmlns:="http://www.w3.org/1999/xhtml">These operations </span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.284.1" xmlns:="http://www.w3.org/1999/xhtml">are also useful to compute differences, such as the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.285.1" xmlns:="http://www.w3.org/1999/xhtml">disposable income</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.286.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.287.1" xmlns:="http://www.w3.org/1999/xhtml">disposable income = income - </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.288.1" xmlns:="http://www.w3.org/1999/xhtml">total debt</span></em></span></p>
<p><span class="koboSpan" id="kobo.289.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we</span><a id="_idIndexMarker578"/><span class="koboSpan" id="kobo.290.1" xmlns:="http://www.w3.org/1999/xhtml"> will learn how to create new features by subtracting or dividing variables with </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.292.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.293.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.294.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.295.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.296.1" xmlns:="http://www.w3.org/1999/xhtml">In the recipe, we will show you how to create features with subtraction and division. </span><span class="koboSpan" id="kobo.296.2" xmlns:="http://www.w3.org/1999/xhtml">We hope that the examples, relating to the financial sector, shed some light on how to use domain knowledge to decide which features to </span><a id="_idTextAnchor1020"/><a id="_idTextAnchor1021"/><span class="koboSpan" id="kobo.297.1" xmlns:="http://www.w3.org/1999/xhtml">combine </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1" xmlns:="http://www.w3.org/1999/xhtml">and how.</span></span></p>
<h2 id="_idParaDest-228"><span class="koboSpan" id="kobo.299.1" xmlns:="http://www.w3.org/1999/xhtml">How to do</span><a id="_idTextAnchor1022"/><span class="koboSpan" id="kobo.300.1" xmlns:="http://www.w3.org/1999/xhtml"> it…</span></h2>
<p><span class="koboSpan" id="kobo.301.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by loading the necessary Python libraries and the breast cancer dataset </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1" xmlns:="http://www.w3.org/1999/xhtml">from scikit-learn:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.303.1" xmlns:="http://www.w3.org/1999/xhtml">Load the necessary libraries, classes, </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1" xmlns:="http://www.w3.org/1999/xhtml">and data:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.305.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
from feature_engine.creation import RelativeFeatures
from sklearn.datasets import load_breast_cancer</span></pre></li> <li><span class="koboSpan" id="kobo.306.1" xmlns:="http://www.w3.org/1999/xhtml">Load the breast cancer dataset into a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.307.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.308.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.309.1" xmlns:="http://www.w3.org/1999/xhtml">
data = load_breast_cancer()
df = pd.DataFrame(data.data,
    columns=data.feature_names)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.310.1" xmlns:="http://www.w3.org/1999/xhtml">In the breast cancer dataset, some features capture the worst and the mean characteristics of the cell nuclei of breast cells. </span><span class="koboSpan" id="kobo.310.2" xmlns:="http://www.w3.org/1999/xhtml">For example, for each image (that is, for each row), we have the worst compactness observed in all nuclei and the mean compactness of all nuclei. </span><span class="koboSpan" id="kobo.310.3" xmlns:="http://www.w3.org/1999/xhtml">A </span><a id="_idIndexMarker579"/><span class="koboSpan" id="kobo.311.1" xmlns:="http://www.w3.org/1999/xhtml">feature that captures the difference between the worst and the mean value</span><a id="_idIndexMarker580"/><span class="koboSpan" id="kobo.312.1" xmlns:="http://www.w3.org/1999/xhtml"> could </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1" xmlns:="http://www.w3.org/1999/xhtml">predict malignancy.</span></span><a id="_idTextAnchor1023"/></p></li> <li><span class="koboSpan" id="kobo.314.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s capture the difference between two features, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1" xmlns:="http://www.w3.org/1999/xhtml">worst compactness</span></strong><span class="koboSpan" id="kobo.316.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1" xmlns:="http://www.w3.org/1999/xhtml">mean compactness</span></strong><span class="koboSpan" id="kobo.318.1" xmlns:="http://www.w3.org/1999/xhtml"> of cel</span><a id="_idTextAnchor1024"/><span class="koboSpan" id="kobo.319.1" xmlns:="http://www.w3.org/1999/xhtml">l nuclei, in a new variable and display </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1" xmlns:="http://www.w3.org/1999/xhtml">its values:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.321.1" xmlns:="http://www.w3.org/1999/xhtml">
df["difference"] = df["worst compactness"].sub(
    df["mean compactness"])
df["differen</span><a id="_idTextAnchor1025"/><span class="koboSpan" id="kobo.322.1" xmlns:="http://www.w3.org/1999/xhtml">ce"].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.323.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the difference between these </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1" xmlns:="http://www.w3.org/1999/xhtml">feature values:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.325.1" xmlns:="http://www.w3.org/1999/xhtml">0    0.38800</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.326.1" xmlns:="http://www.w3.org/1999/xhtml">1    0.10796</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.327.1" xmlns:="http://www.w3.org/1999/xhtml">2    0.26460</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.328.1" xmlns:="http://www.w3.org/1999/xhtml">3    0.58240</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.329.1" xmlns:="http://www.w3.org/1999/xhtml">4    0.07220</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.330.1" xmlns:="http://www.w3.org/1999/xhtml">Name: difference, dtype: float64</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.331.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.332.1" xmlns:="http://www.w3.org/1999/xhtml">We can perform the same calculation by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1" xmlns:="http://www.w3.org/1999/xhtml">df["difference"] = df["worst compactness"] - (</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.334.1" xmlns:="http://www.w3.org/1999/xhtml">df["mean compactness"])</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.335.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.336.1" xmlns:="http://www.w3.org/1999/xhtml">Similarly, the ratio between the worst and the average characteristic of the cell nuclei might be indicative </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1" xmlns:="http://www.w3.org/1999/xhtml">of malignancy.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.338.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create a new feature with the ratio between the worst and mean radius of the nuclei, and then display </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1" xmlns:="http://www.w3.org/1999/xhtml">its values:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.340.1" xmlns:="http://www.w3.org/1999/xhtml">
df["quotient"] = df["worst radius"].div(
    df["mean radius"])
df["quotient"].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.341.1" xmlns:="http://www.w3.org/1999/xhtml">In the </span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.342.1" xmlns:="http://www.w3.org/1999/xhtml">following output, we can see the </span><a id="_idIndexMarker582"/><span class="koboSpan" id="kobo.343.1" xmlns:="http://www.w3.org/1999/xhtml">values corresponding to the ratio between </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1" xmlns:="http://www.w3.org/1999/xhtml">the features:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.345.1" xmlns:="http://www.w3.org/1999/xhtml">0    1.410784</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.346.1" xmlns:="http://www.w3.org/1999/xhtml">1    1.214876</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.347.1" xmlns:="http://www.w3.org/1999/xhtml">2    1.197054</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.348.1" xmlns:="http://www.w3.org/1999/xhtml">3    1.305604</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.349.1" xmlns:="http://www.w3.org/1999/xhtml">4    1.110892</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.350.1" xmlns:="http://www.w3.org/1999/xhtml">Name: quotient, dtype: float64</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.351.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.352.1" xmlns:="http://www.w3.org/1999/xhtml">We can calculate the ratio by executing an alternative command, </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1" xmlns:="http://www.w3.org/1999/xhtml">df["quotient"] = df["worst radius"] / (</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.354.1" xmlns:="http://www.w3.org/1999/xhtml">df["me</span><a id="_idTextAnchor1026"/><span class="koboSpan" id="kobo.355.1" xmlns:="http://www.w3.org/1999/xhtml">an radius"])</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.356.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.357.1" xmlns:="http://www.w3.org/1999/xhtml">We can also capture the ratio and difference between every nuclei morphology characteristic and the mean radius or mean area of the nuclei. </span><span class="koboSpan" id="kobo.357.2" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by capturing these subsets of variables </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1" xmlns:="http://www.w3.org/1999/xhtml">into lists.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.359.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make a list of the features in </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1" xmlns:="http://www.w3.org/1999/xhtml">the numerator:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.361.1" xmlns:="http://www.w3.org/1999/xhtml">
features = [
    "mean smoothness",
    «mean compactness",
    "mean concavity",
    "mean symmetry"
]</span></pre></li> <li><span class="koboSpan" id="kobo.362.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s make a list of the features in </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1" xmlns:="http://www.w3.org/1999/xhtml">the denominator:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.364.1" xmlns:="http://www.w3.org/1999/xhtml">
reference = ["mean radius", "mean area"]</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.365.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.366.1" xmlns:="http://www.w3.org/1999/xhtml">We can create features by dividing the features in </span><em class="italic"><span class="koboSpan" id="kobo.367.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.368.1" xmlns:="http://www.w3.org/1999/xhtml"> by one of the features in </span><em class="italic"><span class="koboSpan" id="kobo.369.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.370.1" xmlns:="http://www.w3.org/1999/xhtml"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.372.1" xmlns:="http://www.w3.org/1999/xhtml">, by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1" xmlns:="http://www.w3.org/1999/xhtml">df[features].div(df["mean radius"])</span></strong><span class="koboSpan" id="kobo.374.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.374.2" xmlns:="http://www.w3.org/1999/xhtml">For subtraction, we’d execute </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.375.1" xmlns:="http://www.w3.org/1999/xhtml">df[features].sub(df["mean radius"])</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.376.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.377.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set </span><a id="_idIndexMarker583"/><span class="koboSpan" id="kobo.378.1" xmlns:="http://www.w3.org/1999/xhtml">up the </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.380.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1" xmlns:="http://www.w3.org/1999/xhtml">RelativeFeatures()</span></strong><span class="koboSpan" id="kobo.382.1" xmlns:="http://www.w3.org/1999/xhtml"> so that it subtracts or divides every feature </span><a id="_idIndexMarker584"/><span class="koboSpan" id="kobo.383.1" xmlns:="http://www.w3.org/1999/xhtml">from </span><em class="italic"><span class="koboSpan" id="kobo.384.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.385.1" xmlns:="http://www.w3.org/1999/xhtml"> with respect to the features from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.386.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.387.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.388.1" xmlns:="http://www.w3.org/1999/xhtml">
creator = RelativeFeatures(
    variables=features,
    reference=reference,
    func=["sub", "div"],
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.389.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.390.1" xmlns:="http://www.w3.org/1999/xhtml">Subtracting the features from </span><em class="italic"><span class="koboSpan" id="kobo.391.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.392.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.393.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em><span class="koboSpan" id="kobo.394.1" xmlns:="http://www.w3.org/1999/xhtml"> does not make biological sense, but we will do it anyway to demonstrate the use of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.395.1" xmlns:="http://www.w3.org/1999/xhtml">RelativeFeatures()</span></strong></span><span class="No-Break"> <a id="_idTextAnchor1027"/><span class="koboSpan" id="kobo.396.1" xmlns:="http://www.w3.org/1999/xhtml">transformer.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.397.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add the new features to the DataFrame and capture the result in a </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1" xmlns:="http://www.w3.org/1999/xhtml">new variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.399.1" xmlns:="http://www.w3.org/1999/xhtml">
df_t = creator.fit_transform(df)</span></pre></li> <li><span class="koboSpan" id="kobo.400.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s capture the names of the new features in </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1" xmlns:="http://www.w3.org/1999/xhtml">a list:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.402.1" xmlns:="http://www.w3.org/1999/xhtml">
all_feat = creator.feature_names_in_
new_features = [
    f for f in df_t.columns if f not in all_feat]</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.403.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.404.1" xmlns:="http://www.w3.org/1999/xhtml">feature_names_in_</span><a id="_idTextAnchor1028"/></strong><span class="koboSpan" id="kobo.405.1" xmlns:="http://www.w3.org/1999/xhtml"> is a </span><a id="_idIndexMarker585"/><span class="koboSpan" id="kobo.406.1" xmlns:="http://www.w3.org/1999/xhtml">common attribute in </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.408.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.410.1" xmlns:="http://www.w3.org/1999/xhtml"> transformers and stores the name of the variables from the DataFrame used to fit the transformer. </span><span class="koboSpan" id="kobo.410.2" xmlns:="http://www.w3.org/1999/xhtml">In other words, it stores the names of the input features. </span><span class="koboSpan" id="kobo.410.3" xmlns:="http://www.w3.org/1999/xhtml">When using </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.412.1" xmlns:="http://www.w3.org/1999/xhtml">, the transformers check that the features from the new input dataset match those used during training. </span><span class="koboSpan" id="kobo.412.2" xmlns:="http://www.w3.org/1999/xhtml">In </span><em class="italic"><span class="koboSpan" id="kobo.413.1" xmlns:="http://www.w3.org/1999/xhtml">step 9</span></em><span class="koboSpan" id="kobo.414.1" xmlns:="http://www.w3.org/1999/xhtml">, we leverage this attribute to find the additional variables added to the data after </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1" xmlns:="http://www.w3.org/1999/xhtml">the transformation.</span></span></p>
<p><span class="koboSpan" id="kobo.416.1" xmlns:="http://www.w3.org/1999/xhtml">If we</span><a id="_idIndexMarker586"/><span class="koboSpan" id="kobo.417.1" xmlns:="http://www.w3.org/1999/xhtml"> execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1" xmlns:="http://www.w3.org/1999/xhtml">print(new_features)</span></strong><span class="koboSpan" id="kobo.419.1" xmlns:="http://www.w3.org/1999/xhtml">, we</span><a id="_idIndexMarker587"/><span class="koboSpan" id="kobo.420.1" xmlns:="http://www.w3.org/1999/xhtml"> will see a list with the names of the features created by </span><strong class="source-inline"><span class="koboSpan" id="kobo.421.1" xmlns:="http://www.w3.org/1999/xhtml">ReferenceFeatures()</span></strong><span class="koboSpan" id="kobo.422.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.422.2" xmlns:="http://www.w3.org/1999/xhtml">Note </span><a id="_idTextAnchor1029"/><span class="koboSpan" id="kobo.423.1" xmlns:="http://www.w3.org/1999/xhtml">that the features contain the variables on the left- and right-hand sides of the mathematical equation, plus the function that was applied to them to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1" xmlns:="http://www.w3.org/1999/xhtml">new feature:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.425.1" xmlns:="http://www.w3.org/1999/xhtml">
['mean smoothness_sub_mean radius',
'mean compactness_sub_mean radius',
'mean concavity_sub_mean radius',
'mean symmetry_sub_mean radius',
'mean smoothness_sub_mean area',
'mean compactness_sub_mean area',
'mean concavity_sub_mean area',
'mean symmetry_sub_mean area',
'mean smoothness_div_mean radius',
'mean compactness_div_mean radius',
'mean concavity_div_mean radius',
'mean symmetry_div_mean radius',
'mean smoothness_div_mean area',
'mean compactness_div_mean area',
'mean concavity_div_mean area',
'mean symmetry_div_mean area']</span></pre> <p><span class="koboSpan" id="kobo.426.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, we can display the first five rows of the resulting variables by </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1" xmlns:="http://www.w3.org/1999/xhtml">executing </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.428.1" xmlns:="http://www.w3.org/1999/xhtml">df</span><a id="_idTextAnchor1030"/><span class="koboSpan" id="kobo.429.1" xmlns:="http://www.w3.org/1999/xhtml">_t[new_features].head()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.430.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer141">
<span class="koboSpan" id="kobo.431.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.3 – A DataFrame with the newly created features" src="image/B22396_08_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.432.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.3 – A DataFrame with the newly created features</span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.433.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.434.1" xmlns:="http://www.w3.org/1999/xhtml"> adds </span><a id="_idIndexMarker588"/><span class="koboSpan" id="kobo.435.1" xmlns:="http://www.w3.org/1999/xhtml">new features as columns</span><a id="_idIndexMarker589"/><span class="koboSpan" id="kobo.436.1" xmlns:="http://www.w3.org/1999/xhtml"> at the right of the original DataFrame and automatically adds variable names to those features. </span><span class="koboSpan" id="kobo.436.2" xmlns:="http://www.w3.org/1999/xhtml">By doing so, </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.438.1" xmlns:="http://www.w3.org/1999/xhtml"> automates much of the manual work tha</span><a id="_idTextAnchor1031"/><a id="_idTextAnchor1032"/><span class="koboSpan" id="kobo.439.1" xmlns:="http://www.w3.org/1999/xhtml">t we would do </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.441.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.442.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-229"><a id="_idTextAnchor1033"/><span class="koboSpan" id="kobo.443.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.444.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.445.1" xmlns:="http://www.w3.org/1999/xhtml"> has many built-in operations to compare a feature or a group of features to a reference variable. </span><span class="koboSpan" id="kobo.445.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we used pandas </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1" xmlns:="http://www.w3.org/1999/xhtml">sub()</span></strong><span class="koboSpan" id="kobo.447.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1" xmlns:="http://www.w3.org/1999/xhtml">div()</span></strong><span class="koboSpan" id="kobo.449.1" xmlns:="http://www.w3.org/1999/xhtml"> to determine the difference or the ratio between two variables, or a subset of variables and one </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1" xmlns:="http://www.w3.org/1999/xhtml">refe</span><a id="_idTextAnchor1034"/><span class="koboSpan" id="kobo.451.1" xmlns:="http://www.w3.org/1999/xhtml">rence feature.</span></span></p>
<p><span class="koboSpan" id="kobo.452.1" xmlns:="http://www.w3.org/1999/xhtml">To subtract one variable from another, we applied </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1" xmlns:="http://www.w3.org/1999/xhtml">sub()</span></strong><span class="koboSpan" id="kobo.454.1" xmlns:="http://www.w3.org/1999/xhtml"> to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.456.1" xmlns:="http://www.w3.org/1999/xhtml"> series with the first variable, passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.458.1" xmlns:="http://www.w3.org/1999/xhtml"> series with the second variable as an argument to </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1" xmlns:="http://www.w3.org/1999/xhtml">sub()</span></strong><span class="koboSpan" id="kobo.460.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.460.2" xmlns:="http://www.w3.org/1999/xhtml">This operation returned a third </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.462.1" xmlns:="http://www.w3.org/1999/xhtml"> series with the difference between the first and second variables. </span><span class="koboSpan" id="kobo.462.2" xmlns:="http://www.w3.org/1999/xhtml">To divide one variable from another, we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1" xmlns:="http://www.w3.org/1999/xhtml">div()</span></strong><span class="koboSpan" id="kobo.464.1" xmlns:="http://www.w3.org/1999/xhtml">, which works identically to </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1" xmlns:="http://www.w3.org/1999/xhtml">sub()</span></strong><span class="koboSpan" id="kobo.466.1" xmlns:="http://www.w3.org/1999/xhtml"> – that is, it divides the variable on the left by the variable passed as an argument </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.468.1" xmlns:="http://www.w3.org/1999/xhtml">div()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.469.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.470.1" xmlns:="http://www.w3.org/1999/xhtml">Then, we combined several variables with two reference variables automatically via subtraction or division, by utilizing </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1" xmlns:="http://www.w3.org/1999/xhtml">ReferenceFeatures()</span></strong><span class="koboSpan" id="kobo.472.1" xmlns:="http://www.w3.org/1999/xhtml"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1" xmlns:="http://www.w3.org/1999/xhtml">Feature-engine</span></strong><span class="koboSpan" id="kobo.474.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.474.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1" xmlns:="http://www.w3.org/1999/xhtml">ReferenceFeatures()</span></strong><span class="koboSpan" id="kobo.476.1" xmlns:="http://www.w3.org/1999/xhtml"> transformer takes the variables to be combined, the reference variables, and the functions to use to combine them. </span><span class="koboSpan" id="kobo.476.2" xmlns:="http://www.w3.org/1999/xhtml">When using </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1" xmlns:="http://www.w3.org/1999/xhtml">fit()</span></strong><span class="koboSpan" id="kobo.478.1" xmlns:="http://www.w3.org/1999/xhtml">, the transformer did not learn about parameters but checked that the variables were numerical. </span><span class="koboSpan" id="kobo.478.2" xmlns:="http://www.w3.org/1999/xhtml">Executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.480.1" xmlns:="http://www.w3.org/1999/xhtml"> added the new features to </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1" xmlns:="http://www.w3.org/1999/xhtml">the DataFrame.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.482.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.483.1" xmlns:="http://www.w3.org/1999/xhtml">ReferenceFeatures()</span></strong><span class="koboSpan" id="kobo.484.1" xmlns:="http://www.w3.org/1999/xhtml"> can also add, multiply, get the modulo, or get the power of a group of variables relating to a second group of reference variables. </span><span class="koboSpan" id="kobo.484.2" xmlns:="http://www.w3.org/1999/xhtml">You can find out more in its </span><span class="No-Break"><span class="koboSpan" id="kobo.485.1" xmlns:="http://www.w3.org/1999/xhtml">documentation: </span></span><a href="https://feature-engine.readthedocs.io/en/latest/api_doc/creation/RelativeFeatures.html"><span class="No-Break"><span class="koboSpan" id="kobo.486.1" xmlns:="http://www.w3.org/1999/xhtml">https://feature-engine.readthedocs.io/en/latest/api_doc/creation/RelativeFeatures.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.487.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-230"><a id="_idTextAnchor1035"/><span class="koboSpan" id="kobo.488.1" xmlns:="http://www.w3.org/1999/xhtml">See also</span></h2>
<p><span class="koboSpan" id="kobo.489.1" xmlns:="http://www.w3.org/1999/xhtml">To learn more about the binary operations supported by </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.491.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1" xmlns:="http://www.w3.org/1999/xhtml">visit </span></span><a href="https://pandas.pydata.org/pandas-docs/stable/reference/frame.html#binary-operator-functions"><span class="No-Break"><span class="koboSpan" id="kobo.493.1" xmlns:="http://www.w3.org/1999/xhtml">https://pandas.pydata.org/pandas-docs/stable/reference/frame.html#binary-operator-functions</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.494.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h1 id="_idParaDest-231"><a id="_idTextAnchor1036"/><span class="koboSpan" id="kobo.495.1" xmlns:="http://www.w3.org/1999/xhtml">Performing polynomial expansion</span></h1>
<p><span class="koboSpan" id="kobo.496.1" xmlns:="http://www.w3.org/1999/xhtml">Simple </span><a id="_idIndexMarker590"/><span class="koboSpan" id="kobo.497.1" xmlns:="http://www.w3.org/1999/xhtml">models, such as linear and logistic regression, can capture complex patterns if we feed them the right features. </span><span class="koboSpan" id="kobo.497.2" xmlns:="http://www.w3.org/1999/xhtml">Sometimes, we can create powerful features by combining the variables in our datasets with themselves or with other variables. </span><span class="koboSpan" id="kobo.497.3" xmlns:="http://www.w3.org/1999/xhtml">For example, in the following figure, we can see that the target, </span><em class="italic"><span class="koboSpan" id="kobo.498.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></em><span class="koboSpan" id="kobo.499.1" xmlns:="http://www.w3.org/1999/xhtml">, has a quadratic relation with the variable, </span><em class="italic"><span class="koboSpan" id="kobo.500.1" xmlns:="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.501.1" xmlns:="http://www.w3.org/1999/xhtml">, and as shown in the left panel, a linear model is not able to capture that </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1" xmlns:="http://www.w3.org/1999/xhtml">relationship accurately:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer142">
<span class="koboSpan" id="kobo.503.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.4 – A linear model fit to predict a target, y, from a feature, x, which has a quadratic relationship to the target, before and after squaring x. In the left panel: the model offers a poor fit by using the original variable; in the right panel, the model offers a better fit, based on the squar﻿e of the original variable" src="image/B22396_08_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.504.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.4 – A linear model fit to predict a target, y, from a feature, x, which has a quadratic relationship to the target, before and after squaring x. </span><span class="koboSpan" id="kobo.504.2" xmlns:="http://www.w3.org/1999/xhtml">In the left panel: the model offers a poor fit by using the original variable; in the right panel, the model offers a better fit, based on the squar</span><a id="_idTextAnchor1037"/><span class="koboSpan" id="kobo.505.1" xmlns:="http://www.w3.org/1999/xhtml">e of the original variable</span></p>
<p><span class="koboSpan" id="kobo.506.1" xmlns:="http://www.w3.org/1999/xhtml">This linear </span><a id="_idIndexMarker591"/><span class="koboSpan" id="kobo.507.1" xmlns:="http://www.w3.org/1999/xhtml">model has a quadratic relationship to the target, before and after squaring </span><em class="italic"><span class="koboSpan" id="kobo.508.1" xmlns:="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.509.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.509.2" xmlns:="http://www.w3.org/1999/xhtml">However, if we square </span><em class="italic"><span class="koboSpan" id="kobo.510.1" xmlns:="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.511.1" xmlns:="http://www.w3.org/1999/xhtml">, or, in other words, if we create a second-degree polynomial of the feature, the linear model can accurately predict the target, </span><em class="italic"><span class="koboSpan" id="kobo.512.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></em><span class="koboSpan" id="kobo.513.1" xmlns:="http://www.w3.org/1999/xhtml">, from the square of </span><em class="italic"><span class="koboSpan" id="kobo.514.1" xmlns:="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.515.1" xmlns:="http://www.w3.org/1999/xhtml">, as we see in the </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1" xmlns:="http://www.w3.org/1999/xhtml">right panel.</span></span></p>
<p><span class="koboSpan" id="kobo.517.1" xmlns:="http://www.w3.org/1999/xhtml">Another classical example in which a simple feature can make a simple model, such as logistic regression, understand the underlying relationship in the data is the </span><strong class="bold"><span class="koboSpan" id="kobo.518.1" xmlns:="http://www.w3.org/1999/xhtml">XOR</span></strong><span class="koboSpan" id="kobo.519.1" xmlns:="http://www.w3.org/1999/xhtml"> situation. </span><span class="koboSpan" id="kobo.519.2" xmlns:="http://www.w3.org/1999/xhtml">In</span><a id="_idIndexMarker592"/><span class="koboSpan" id="kobo.520.1" xmlns:="http://www.w3.org/1999/xhtml"> the left panel of the following diagram, we see how the target class is distributed across the values of </span><em class="italic"><span class="koboSpan" id="kobo.521.1" xmlns:="http://www.w3.org/1999/xhtml">x1</span></em><span class="koboSpan" id="kobo.522.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><em class="italic"><span class="koboSpan" id="kobo.523.1" xmlns:="http://www.w3.org/1999/xhtml">x2</span></em><span class="koboSpan" id="kobo.524.1" xmlns:="http://www.w3.org/1999/xhtml"> (the class is highlighted with different </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1" xmlns:="http://www.w3.org/1999/xhtml">color shades):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.526.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.5 – An illustration of the XOR relationship and how combining features allows a full class separation" src="image/B22396_08_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.527.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.5 – An illustration of the XOR relationship and how combining features allows a full class separation</span></p>
<p><span class="koboSpan" id="kobo.528.1" xmlns:="http://www.w3.org/1999/xhtml">If both features are positive, or both features are negative, then the class is 1, but if the features take different signs, then the class is 0 (left panel). </span><span class="koboSpan" id="kobo.528.2" xmlns:="http://www.w3.org/1999/xhtml">Logistic regression will not be able to pick this pattern from each individual feature because, as we can see in the middle panel, there</span><a id="_idIndexMarker593"/><span class="koboSpan" id="kobo.529.1" xmlns:="http://www.w3.org/1999/xhtml"> is significant class overlap across the values of the feature – in this case, x1. </span><span class="koboSpan" id="kobo.529.2" xmlns:="http://www.w3.org/1999/xhtml">However, multiplying x1 by x2 creates a feature that allows a logistic regression to predict the classes accurately because x3, as can we see in the right panel, allows the classes to be </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1" xmlns:="http://www.w3.org/1999/xhtml">clearly separated.</span></span></p>
<p><span class="koboSpan" id="kobo.531.1" xmlns:="http://www.w3.org/1999/xhtml">With similar logic, polynomial combinations of the same or different variables can return new variables that convey additional information and capture feature interaction thereby resulting in useful inputs for linear models. </span><span class="koboSpan" id="kobo.531.2" xmlns:="http://www.w3.org/1999/xhtml">With huge datasets, analyzing every possible variable combination is not always possible. </span><span class="koboSpan" id="kobo.531.3" xmlns:="http://www.w3.org/1999/xhtml">But we can create several polynomial variables automatically, using, for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.533.1" xmlns:="http://www.w3.org/1999/xhtml">, and we can let the model decide which variables are useful. </span><span class="koboSpan" id="kobo.533.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will learn how to create multiple features through polynomial comb</span><a id="_idTextAnchor1038"/><a id="_idTextAnchor1039"/><span class="koboSpan" id="kobo.534.1" xmlns:="http://www.w3.org/1999/xhtml">inations </span><span class="No-Break"><span class="koboSpan" id="kobo.535.1" xmlns:="http://www.w3.org/1999/xhtml">using scikit-learn.</span></span></p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor1040"/><span class="koboSpan" id="kobo.536.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.537.1" xmlns:="http://www.w3.org/1999/xhtml">Polynomial expansion serves to automate the creation of new features, capture feature interaction, and potential non-linear relationships between the original variables and the target. </span><span class="koboSpan" id="kobo.537.2" xmlns:="http://www.w3.org/1999/xhtml">To create polynomial features, we need to determine which features to combine and which polynomial degree </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1" xmlns:="http://www.w3.org/1999/xhtml">to use.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.539.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.540.1" xmlns:="http://www.w3.org/1999/xhtml">While determining the features to combine or the degree of the polynomial combination is not an easy task, keep in mind that high polynomial degrees will result in a lot of new features and may lead to overfitting. </span><span class="koboSpan" id="kobo.540.2" xmlns:="http://www.w3.org/1999/xhtml">In general, we keep the degree low, to a maximum of 2 </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1" xmlns:="http://www.w3.org/1999/xhtml">or 3.</span></span></p>
<p><span class="koboSpan" id="kobo.542.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.544.1" xmlns:="http://www.w3.org/1999/xhtml"> transformer from </span><strong class="source-inline"><span class="koboSpan" id="kobo.545.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.546.1" xmlns:="http://www.w3.org/1999/xhtml"> creates polynomial combinations of the features with a degree less than or equal to a user-specified </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1" xmlns:="http://www.w3.org/1999/xhtml">degree, automatically.</span></span></p>
<p><span class="koboSpan" id="kobo.548.1" xmlns:="http://www.w3.org/1999/xhtml">To follow up easily with this recipe, let’s first understand the output of </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.550.1" xmlns:="http://www.w3.org/1999/xhtml"> when used to create second- and third-degree polynomial combinations of </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1" xmlns:="http://www.w3.org/1999/xhtml">th</span><a id="_idTextAnchor1041"/><span class="koboSpan" id="kobo.552.1" xmlns:="http://www.w3.org/1999/xhtml">ree variables.</span></span></p>
<p><span class="koboSpan" id="kobo.553.1" xmlns:="http://www.w3.org/1999/xhtml">Second-degree polynomial combinations of three variables – </span><em class="italic"><span class="koboSpan" id="kobo.554.1" xmlns:="http://www.w3.org/1999/xhtml">a</span></em><span class="koboSpan" id="kobo.555.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.556.1" xmlns:="http://www.w3.org/1999/xhtml">b</span></em><span class="koboSpan" id="kobo.557.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.558.1" xmlns:="http://www.w3.org/1999/xhtml">c</span></em><span class="koboSpan" id="kobo.559.1" xmlns:="http://www.w3.org/1999/xhtml"> – will return the following </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.561.1" xmlns:="http://www.w3.org/1999/xhtml">1, a, b, c, ab, ac, bc, a2, </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.562.1" xmlns:="http://www.w3.org/1999/xhtml">b2, c2</span></em></span></p>
<p><span class="koboSpan" id="kobo.563.1" xmlns:="http://www.w3.org/1999/xhtml">From</span><a id="_idIndexMarker594"/><span class="koboSpan" id="kobo.564.1" xmlns:="http://www.w3.org/1999/xhtml"> the previous features, </span><em class="italic"><span class="koboSpan" id="kobo.565.1" xmlns:="http://www.w3.org/1999/xhtml">a</span></em><span class="koboSpan" id="kobo.566.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.567.1" xmlns:="http://www.w3.org/1999/xhtml">b</span></em><span class="koboSpan" id="kobo.568.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.569.1" xmlns:="http://www.w3.org/1999/xhtml">c</span></em><span class="koboSpan" id="kobo.570.1" xmlns:="http://www.w3.org/1999/xhtml"> are the original variables; </span><em class="italic"><span class="koboSpan" id="kobo.571.1" xmlns:="http://www.w3.org/1999/xhtml">ab</span></em><span class="koboSpan" id="kobo.572.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.573.1" xmlns:="http://www.w3.org/1999/xhtml">ac</span></em><span class="koboSpan" id="kobo.574.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.575.1" xmlns:="http://www.w3.org/1999/xhtml">bc</span></em><span class="koboSpan" id="kobo.576.1" xmlns:="http://www.w3.org/1999/xhtml"> are the products of those features; and </span><em class="italic"><span class="koboSpan" id="kobo.577.1" xmlns:="http://www.w3.org/1999/xhtml">a2</span></em><span class="koboSpan" id="kobo.578.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.579.1" xmlns:="http://www.w3.org/1999/xhtml">b2</span></em><span class="koboSpan" id="kobo.580.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.581.1" xmlns:="http://www.w3.org/1999/xhtml">c2</span></em><span class="koboSpan" id="kobo.582.1" xmlns:="http://www.w3.org/1999/xhtml"> are the squared values of the original features. </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.584.1" xmlns:="http://www.w3.org/1999/xhtml"> also returns the bias term </span><em class="italic"><span class="koboSpan" id="kobo.585.1" xmlns:="http://www.w3.org/1999/xhtml">1</span></em><span class="koboSpan" id="kobo.586.1" xmlns:="http://www.w3.org/1999/xhtml">, which we would probably exclude when </span><span class="No-Break"><span class="koboSpan" id="kobo.587.1" xmlns:="http://www.w3.org/1999/xhtml">creating features.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.588.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.589.1" xmlns:="http://www.w3.org/1999/xhtml">The resulting features – </span><em class="italic"><span class="koboSpan" id="kobo.590.1" xmlns:="http://www.w3.org/1999/xhtml">ab</span></em><span class="koboSpan" id="kobo.591.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.592.1" xmlns:="http://www.w3.org/1999/xhtml">ac</span></em><span class="koboSpan" id="kobo.593.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.594.1" xmlns:="http://www.w3.org/1999/xhtml">bc</span></em><span class="koboSpan" id="kobo.595.1" xmlns:="http://www.w3.org/1999/xhtml"> – are </span><a id="_idIndexMarker595"/><span class="koboSpan" id="kobo.596.1" xmlns:="http://www.w3.org/1999/xhtml">called </span><strong class="bold"><span class="koboSpan" id="kobo.597.1" xmlns:="http://www.w3.org/1999/xhtml">interactions</span></strong><span class="koboSpan" id="kobo.598.1" xmlns:="http://www.w3.org/1999/xhtml"> or feature interactions of </span><strong class="bold"><span class="koboSpan" id="kobo.599.1" xmlns:="http://www.w3.org/1999/xhtml">degree 2</span></strong><span class="koboSpan" id="kobo.600.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.600.2" xmlns:="http://www.w3.org/1999/xhtml">The degree </span><a id="_idIndexMarker596"/><span class="koboSpan" id="kobo.601.1" xmlns:="http://www.w3.org/1999/xhtml">reflects the number of variables combined. </span><span class="koboSpan" id="kobo.601.2" xmlns:="http://www.w3.org/1999/xhtml">The result combines a maximum of two variables because we indicated a second-degree polynomial as the maximum </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1" xmlns:="http://www.w3.org/1999/xhtml">allowed combination.</span></span></p>
<p><span class="koboSpan" id="kobo.603.1" xmlns:="http://www.w3.org/1999/xhtml">Third-degree polynomial combinations of the three variables – </span><em class="italic"><span class="koboSpan" id="kobo.604.1" xmlns:="http://www.w3.org/1999/xhtml">a</span></em><span class="koboSpan" id="kobo.605.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.606.1" xmlns:="http://www.w3.org/1999/xhtml">b</span></em><span class="koboSpan" id="kobo.607.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.608.1" xmlns:="http://www.w3.org/1999/xhtml">c</span></em><span class="koboSpan" id="kobo.609.1" xmlns:="http://www.w3.org/1999/xhtml"> – will return the following </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.611.1" xmlns:="http://www.w3.org/1999/xhtml">1, a, b, c, ab, ac, bc, abc, a2b, a2c, b2a, b2c, c2a, c2b, a3, </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.612.1" xmlns:="http://www.w3.org/1999/xhtml">b3, c3</span></em></span></p>
<p><span class="koboSpan" id="kobo.613.1" xmlns:="http://www.w3.org/1999/xhtml">Among the returned features, in addition to those returned by the second-degree polynomial combination, we now have the third-degree combinations of the features with themselves (</span><em class="italic"><span class="koboSpan" id="kobo.614.1" xmlns:="http://www.w3.org/1999/xhtml">a3</span></em><span class="koboSpan" id="kobo.615.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.616.1" xmlns:="http://www.w3.org/1999/xhtml">b3</span></em><span class="koboSpan" id="kobo.617.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.618.1" xmlns:="http://www.w3.org/1999/xhtml">c3</span></em><span class="koboSpan" id="kobo.619.1" xmlns:="http://www.w3.org/1999/xhtml">), the squared values of every feature combined linearly with a second feature (</span><em class="italic"><span class="koboSpan" id="kobo.620.1" xmlns:="http://www.w3.org/1999/xhtml">a2b</span></em><span class="koboSpan" id="kobo.621.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.622.1" xmlns:="http://www.w3.org/1999/xhtml">a2c</span></em><span class="koboSpan" id="kobo.623.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.624.1" xmlns:="http://www.w3.org/1999/xhtml">b2a</span></em><span class="koboSpan" id="kobo.625.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.626.1" xmlns:="http://www.w3.org/1999/xhtml">b2c</span></em><span class="koboSpan" id="kobo.627.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><em class="italic"><span class="koboSpan" id="kobo.628.1" xmlns:="http://www.w3.org/1999/xhtml">c2a</span></em><span class="koboSpan" id="kobo.629.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><em class="italic"><span class="koboSpan" id="kobo.630.1" xmlns:="http://www.w3.org/1999/xhtml">c2b</span></em><span class="koboSpan" id="kobo.631.1" xmlns:="http://www.w3.org/1999/xhtml">), and the product of the three features (</span><em class="italic"><span class="koboSpan" id="kobo.632.1" xmlns:="http://www.w3.org/1999/xhtml">abc</span></em><span class="koboSpan" id="kobo.633.1" xmlns:="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.633.2" xmlns:="http://www.w3.org/1999/xhtml">Note how we have all possible interactions of degrees 1, 2, and 3 and the bias </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1" xmlns:="http://www.w3.org/1999/xhtml">term</span></span><span class="No-Break"> </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.635.1" xmlns:="http://www.w3.org/1999/xhtml">1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.636.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.637.1" xmlns:="http://www.w3.org/1999/xhtml">Now that we understand the output of the polynomial expansion implemented by </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-lea</span><a id="_idTextAnchor1042"/><a id="_idTextAnchor1043"/><span class="koboSpan" id="kobo.639.1" xmlns:="http://www.w3.org/1999/xhtml">rn</span></strong><span class="koboSpan" id="kobo.640.1" xmlns:="http://www.w3.org/1999/xhtml">, let’s jump into </span><span class="No-Break"><span class="koboSpan" id="kobo.641.1" xmlns:="http://www.w3.org/1999/xhtml">the recipe.</span></span></p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor1044"/><span class="koboSpan" id="kobo.642.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.643.1" xmlns:="http://www.w3.org/1999/xhtml">In this </span><a id="_idIndexMarker597"/><span class="koboSpan" id="kobo.644.1" xmlns:="http://www.w3.org/1999/xhtml">recipe, we will create features with polynomial expansion using a toy dataset to become familiar with the resulting variables. </span><span class="koboSpan" id="kobo.644.2" xmlns:="http://www.w3.org/1999/xhtml">Creating features with the polynomial expansion of a real dataset is identical to what we will discuss in </span><span class="No-Break"><span class="koboSpan" id="kobo.645.1" xmlns:="http://www.w3.org/1999/xhtml">this recipe:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.646.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s import the required libraries, classes, </span><span class="No-Break"><span class="koboSpan" id="kobo.647.1" xmlns:="http://www.w3.org/1999/xhtml">and data:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.648.1" xmlns:="http://www.w3.org/1999/xhtml">
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn import set_config
from sklearn.preprocessing import PolynomialFeatures</span></pre></li> <li><span class="koboSpan" id="kobo.649.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.651.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1" xmlns:="http://www.w3.org/1999/xhtml">set_output</span></strong><span class="koboSpan" id="kobo.653.1" xmlns:="http://www.w3.org/1999/xhtml"> API globally so that all transformers return a DataFrame as a result of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.654.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.655.1" xmlns:="http://www.w3.org/1999/xhtml"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.656.1" xmlns:="http://www.w3.org/1999/xhtml">
set_config(transform_output="pandas")</span></pre></li> <li><span class="koboSpan" id="kobo.657.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s </span><a id="_idIndexMarker598"/><span class="koboSpan" id="kobo.658.1" xmlns:="http://www.w3.org/1999/xhtml">create a DataFrame containing one variable, with values from 1 </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1" xmlns:="http://www.w3.org/1999/xhtml">to 10:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.660.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.DataFrame(np.linspace(
    0, 10, 11), columns=["var"])</span></pre></li> <li><span class="koboSpan" id="kobo.661.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s set up </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.663.1" xmlns:="http://www.w3.org/1999/xhtml"> to create all possible combinations up to a third-degree polynomial of the single variable and exclude the bias term from the result – that is, we will exclude the </span><span class="No-Break"><span class="koboSpan" id="kobo.664.1" xmlns:="http://www.w3.org/1999/xhtml">value </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.665.1" xmlns:="http://www.w3.org/1999/xhtml">1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.666.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.667.1" xmlns:="http://www.w3.org/1999/xhtml">
poly = PolynomialFeatures(
    degree=3,
    interaction_only=False,
    include_bias=False)</span></pre></li> <li><span class="koboSpan" id="kobo.668.1" xmlns:="http://www.w3.org/1999/xhtml">Now, let’s create the </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1" xmlns:="http://www.w3.org/1999/xhtml">polynomial combinations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.670.1" xmlns:="http://www.w3.org/1999/xhtml">
dft = poly.fit_transform(df)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.671.1" xmlns:="http://www.w3.org/1999/xhtml">If we execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1" xmlns:="http://www.w3.org/1999/xhtml">dft</span></strong><span class="koboSpan" id="kobo.673.1" xmlns:="http://www.w3.org/1999/xhtml">, we’ll </span><a id="_idTextAnchor1045"/><span class="koboSpan" id="kobo.674.1" xmlns:="http://www.w3.org/1999/xhtml">see a DataFrame with the original feature, followed by its values squared, and then its values to the power </span><span class="No-Break"><span class="koboSpan" id="kobo.675.1" xmlns:="http://www.w3.org/1999/xhtml">of three:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.676.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.6 – A DataFrame with the polynomial expansion of the third degree of a single variable" src="image/B22396_08_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.677.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.6 – A DataFrame with the polynomial expansion of the third degree of a single variable</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.678.1" xmlns:="http://www.w3.org/1999/xhtml">If, instead </span><a id="_idIndexMarker599"/><span class="koboSpan" id="kobo.679.1" xmlns:="http://www.w3.org/1999/xhtml">of returning a DataFrame, </span><strong class="source-inline"><span class="koboSpan" id="kobo.680.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.681.1" xmlns:="http://www.w3.org/1999/xhtml"> returns a NumPy array and you want to obtain the names of the features in the array, you can do so by executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.682.1" xmlns:="http://www.w3.org/1999/xhtml">poly.get_feature_names_out()</span></strong><span class="koboSpan" id="kobo.683.1" xmlns:="http://www.w3.org/1999/xhtml">, which returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1" xmlns:="http://www.w3.org/1999/xhtml">array(['var', 'var^2', '</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.685.1" xmlns:="http://www.w3.org/1999/xhtml">var^3'], dtype=object)</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.686.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.687.1" xmlns:="http://www.w3.org/1999/xhtml">Now, let’s plot the new feature values against the </span><span class="No-Break"><span class="koboSpan" id="kobo.688.1" xmlns:="http://www.w3.org/1999/xhtml">original variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.689.1" xmlns:="http://www.w3.org/1999/xhtml">
dft = pd.DataFrame(
    dft, columns=poly.get_feature_names_out())
plt.plot(df["var"], dft)
plt.legend(dft.columns)
plt.xlabel("original variable")
plt.ylabel("new variables")
plt.show()</span><a id="_idTextAnchor1046"/></pre><p class="list-inset"><span class="koboSpan" id="kobo.690.1" xmlns:="http://www.w3.org/1999/xhtml">In the following diagram, we can see the relationship between the polynomial fea</span><a id="_idTextAnchor1047"/><span class="koboSpan" id="kobo.691.1" xmlns:="http://www.w3.org/1999/xhtml">tures and the </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1" xmlns:="http://www.w3.org/1999/xhtml">original variable:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.693.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.7 – The relationship between the features resulting from polynomial expansion and the original variable" src="image/B22396_08_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.694.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.7 – The relationship between the features resulting from polynomial expansion and the original variable</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.695.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s add </span><a id="_idIndexMarker600"/><span class="koboSpan" id="kobo.696.1" xmlns:="http://www.w3.org/1999/xhtml">two additional variables to our toy dataset, with values from 1 </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1" xmlns:="http://www.w3.org/1999/xhtml">to 10:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.698.1" xmlns:="http://www.w3.org/1999/xhtml">
df["col"] = np.linspace(0, 5, 11)
df["feat"] = np.linspace(0, 5, 11)</span></pre></li> <li><span class="koboSpan" id="kobo.699.1" xmlns:="http://www.w3.org/1999/xhtml">Next, let’s combine the three features in the </span><a id="_idTextAnchor1048"/><span class="koboSpan" id="kobo.700.1" xmlns:="http://www.w3.org/1999/xhtml">dataset with polynomial expansion up to the second degree, but this time, we will only return features produced by combining at least two different variables – that is, the </span><span class="No-Break"><span class="koboSpan" id="kobo.701.1" xmlns:="http://www.w3.org/1999/xhtml">interaction features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.702.1" xmlns:="http://www.w3.org/1999/xhtml">
poly = PolynomialFeatures(
    degree=2, interaction_only=True,
    include_bias=False)
dft = poly.fit_transform(df)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.703.1" xmlns:="http://www.w3.org/1999/xhtml">If we execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.704.1" xmlns:="http://www.w3.org/1999/xhtml">dft</span></strong><span class="koboSpan" id="kobo.705.1" xmlns:="http://www.w3.org/1999/xhtml">, we will see the features resulting from the polynomial expansion, which contain the original features, plus all possible combinations of the three variables but without the quadratic terms, as we set the transformer to return only </span><a id="_idIndexMarker601"/><span class="koboSpan" id="kobo.706.1" xmlns:="http://www.w3.org/1999/xhtml">the interaction </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1" xmlns:="http://www.w3.org/1999/xhtml">between features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.708.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.8 – A DataFrame with the result of creating features with polynomial expansion but retaining only the interactio﻿n between variables" src="image/B22396_08_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.709.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.8 – A DataFrame with the result of creating features with polynomial expansion but retaining only the interactio</span><a id="_idTextAnchor1049"/><span class="koboSpan" id="kobo.710.1" xmlns:="http://www.w3.org/1999/xhtml">n between variables</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.711.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.712.1" xmlns:="http://www.w3.org/1999/xhtml">Go ahead and create third-degree polynomial combinations of the features, returning only the interactions or all possible features to get a better sense of the output </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.714.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.715.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.716.1" xmlns:="http://www.w3.org/1999/xhtml">With that, we’ve </span><a id="_idIndexMarker602"/><span class="koboSpan" id="kobo.717.1" xmlns:="http://www.w3.org/1999/xhtml">learned how to create new features by combining existing variables with themselves or other features in data. </span><span class="koboSpan" id="kobo.717.2" xmlns:="http://www.w3.org/1999/xhtml">Creating features via polynomial expansion using a real dataset is, in </span><span class="No-Break"><span class="koboSpan" id="kobo.718.1" xmlns:="http://www.w3.org/1999/xhtml">essence, identical.</span></span></p>
<p><span class="koboSpan" id="kobo.719.1" xmlns:="http://www.w3.org/1999/xhtml">If you want to combine only a subset of features, you can select the features to combine by utilizing </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1" xmlns:="http://www.w3.org/1999/xhtml">ColumnTransformer()</span></strong><span class="koboSpan" id="kobo.721.1" xmlns:="http://www.w3.org/1999/xhtml">, as we will demonstrate in the </span><em class="italic"><span class="koboSpan" id="kobo.722.1" xmlns:="http://www.w3.org/1999/xhtml">There’s more…</span></em><span class="koboSpan" id="kobo.723.1" xmlns:="http://www.w3.org/1999/xhtml"> section ahead in this recipe, or by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1" xmlns:="http://www.w3.org/1999/xhtml">SklearnTransformerWrapper()</span></strong><span class="koboSpan" id="kobo.725.1" xmlns:="http://www.w3.org/1999/xhtml"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.727.1" xmlns:="http://www.w3.org/1999/xhtml">, as you can see in the accompanying GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.728.1" xmlns:="http://www.w3.org/1999/xhtml">repository: </span></span><a href="https://github.com/PacktPublishing/Python-Feature-Engineering-Cookbook-Third-Edition/blob/main/ch08-creation/Recipe3-PolynomialExpansion.ipynb"><span class="No-Break"><span class="koboSpan" id="kobo.729.1" xmlns:="http://www.w3.org/1999/xhtml">https://github.com/PacktPublishing/Python-Feature-Engineering-Cookbook-Third-Edition/blob/main/ch08-creation/</span><span id="_idTextAnchor1050"/><span id="_idTextAnchor1051"/><span class="koboSpan" id="kobo.730.1" xmlns:="http://www.w3.org/1999/xhtml">Recipe3-PolynomialExpansion.ipynb</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.731.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor1052"/><span class="koboSpan" id="kobo.732.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.733.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we </span><a id="_idIndexMarker603"/><span class="koboSpan" id="kobo.734.1" xmlns:="http://www.w3.org/1999/xhtml">created features by using polynomial combinations of a feature with itself or among three variables. </span><span class="koboSpan" id="kobo.734.2" xmlns:="http://www.w3.org/1999/xhtml">To create these polynomial features, we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.736.1" xmlns:="http://www.w3.org/1999/xhtml"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.738.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.738.2" xmlns:="http://www.w3.org/1999/xhtml">By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1" xmlns:="http://www.w3.org/1999/xhtml">Polynomia</span><a id="_idTextAnchor1053"/><span class="koboSpan" id="kobo.740.1" xmlns:="http://www.w3.org/1999/xhtml">lFeatures()</span></strong><span class="koboSpan" id="kobo.741.1" xmlns:="http://www.w3.org/1999/xhtml"> generates a new feature matrix consisting of all polynomial combinations of the features in the data, with a degree less than or equal to the user-specified </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1" xmlns:="http://www.w3.org/1999/xhtml">degree</span></strong><span class="koboSpan" id="kobo.743.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.743.2" xmlns:="http://www.w3.org/1999/xhtml">By setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.744.1" xmlns:="http://www.w3.org/1999/xhtml">degree</span></strong><span class="koboSpan" id="kobo.745.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1" xmlns:="http://www.w3.org/1999/xhtml">3</span></strong><span class="koboSpan" id="kobo.747.1" xmlns:="http://www.w3.org/1999/xhtml">, we created all possible polynomial combinations of a degree of 3 or smaller. </span><span class="koboSpan" id="kobo.747.2" xmlns:="http://www.w3.org/1999/xhtml">To retain the combination of a feature with itself, we set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.748.1" xmlns:="http://www.w3.org/1999/xhtml">interaction_only</span></strong><span class="koboSpan" id="kobo.749.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter to </span><strong class="source-inline"><span class="koboSpan" id="kobo.750.1" xmlns:="http://www.w3.org/1999/xhtml">False</span></strong><span class="koboSpan" id="kobo.751.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.751.2" xmlns:="http://www.w3.org/1999/xhtml">To avoid returning the bias term, we set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.752.1" xmlns:="http://www.w3.org/1999/xhtml">include_bias</span></strong><span class="koboSpan" id="kobo.753.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.754.1" xmlns:="http://www.w3.org/1999/xhtml">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.755.1" xmlns:="http://www.w3.org/1999/xhtml">False</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.756.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.757.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.758.1" xmlns:="http://www.w3.org/1999/xhtml">Setting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1" xmlns:="http://www.w3.org/1999/xhtml">interaction_only</span></strong><span class="koboSpan" id="kobo.760.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter to </span><strong class="source-inline"><span class="koboSpan" id="kobo.761.1" xmlns:="http://www.w3.org/1999/xhtml">True</span></strong><span class="koboSpan" id="kobo.762.1" xmlns:="http://www.w3.org/1999/xhtml"> returns the interaction terms only – that is, the variables resulting from combinations of two or </span><span class="No-Break"><span class="koboSpan" id="kobo.763.1" xmlns:="http://www.w3.org/1999/xhtml">more variables.</span></span></p>
<p><span class="koboSpan" id="kobo.764.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1" xmlns:="http://www.w3.org/1999/xhtml">fit()</span></strong><span class="koboSpan" id="kobo.766.1" xmlns:="http://www.w3.org/1999/xhtml"> method determined all of the possible feature combinations based on the parameters specified. </span><span class="koboSpan" id="kobo.766.2" xmlns:="http://www.w3.org/1999/xhtml">At this stage, the transformer did not perform actual mathematical computations. </span><span class="koboSpan" id="kobo.766.3" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.767.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.768.1" xmlns:="http://www.w3.org/1999/xhtml"> method performed the mathematical computations with the features to create the new variables. </span><span class="koboSpan" id="kobo.768.2" xmlns:="http://www.w3.org/1999/xhtml">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1" xmlns:="http://www.w3.org/1999/xhtml">get_feature_names()</span></strong><span class="koboSpan" id="kobo.770.1" xmlns:="http://www.w3.org/1999/xhtml"> method, we could identify the terms of the expansion – that is, how each new feature </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1" xmlns:="http://www.w3.org/1999/xhtml">was calculated.</span></span></p>
<p><span class="koboSpan" id="kobo.772.1" xmlns:="http://www.w3.org/1999/xhtml">In </span><em class="italic"><span class="koboSpan" id="kobo.773.1" xmlns:="http://www.w3.org/1999/xhtml">step 2</span></em><span class="koboSpan" id="kobo.774.1" xmlns:="http://www.w3.org/1999/xhtml">, we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.775.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.776.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1" xmlns:="http://www.w3.org/1999/xhtml">set_output</span></strong><span class="koboSpan" id="kobo.778.1" xmlns:="http://www.w3.org/1999/xhtml"> API </span><strong class="bold"><span class="koboSpan" id="kobo.779.1" xmlns:="http://www.w3.org/1999/xhtml">globally</span></strong><span class="koboSpan" id="kobo.780.1" xmlns:="http://www.w3.org/1999/xhtml"> to return </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.782.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrames as a result of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.784.1" xmlns:="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.784.2" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn transformers return </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1" xmlns:="http://www.w3.org/1999/xhtml">NumPy</span></strong><span class="koboSpan" id="kobo.786.1" xmlns:="http://www.w3.org/1999/xhtml"> arrays by default. </span><span class="koboSpan" id="kobo.786.2" xmlns:="http://www.w3.org/1999/xhtml">The new </span><strong class="source-inline"><span class="koboSpan" id="kobo.787.1" xmlns:="http://www.w3.org/1999/xhtml">set_output</span></strong><span class="koboSpan" id="kobo.788.1" xmlns:="http://www.w3.org/1999/xhtml"> API allows us to change the container of the result to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.789.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.790.1" xmlns:="http://www.w3.org/1999/xhtml"> or a </span><strong class="source-inline"><span class="koboSpan" id="kobo.791.1" xmlns:="http://www.w3.org/1999/xhtml">polars</span></strong><span class="koboSpan" id="kobo.792.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame. </span><span class="koboSpan" id="kobo.792.2" xmlns:="http://www.w3.org/1999/xhtml">We can set the output individually every time we set up a transformer – for example, by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1" xmlns:="http://www.w3.org/1999/xhtml">poly = PolynomialFeatures().set_output(transform="pandas")</span></strong><span class="koboSpan" id="kobo.794.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.794.2" xmlns:="http://www.w3.org/1999/xhtml">Alternatively, as we did in this recipe, we can set the global configuration, and then every time we set up a new transformer,</span><a id="_idTextAnchor1054"/><a id="_idTextAnchor1055"/><span class="koboSpan" id="kobo.795.1" xmlns:="http://www.w3.org/1999/xhtml"> it will return a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.796.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.797.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame.</span></span></p>
<h2 id="_idParaDest-235"><a id="_idTextAnchor1056"/><span class="koboSpan" id="kobo.798.1" xmlns:="http://www.w3.org/1999/xhtml">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.799.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create features by</span><a id="_idIndexMarker604"/><span class="koboSpan" id="kobo.800.1" xmlns:="http://www.w3.org/1999/xhtml"> performing polynomial expansion on a subset of variables in the breast </span><span class="No-Break"><span class="koboSpan" id="kobo.801.1" xmlns:="http://www.w3.org/1999/xhtml">cancer dataset:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.802.1" xmlns:="http://www.w3.org/1999/xhtml">First, import the necessary libraries, classes, </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1" xmlns:="http://www.w3.org/1999/xhtml">and data:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.804.1" xmlns:="http://www.w3.org/1999/xhtml">
import pandas as pd
from sklearn.datasets import load_breast_cancer
from sklearn.compose import ColumnTransformer
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import PolynomialFeatures</span></pre></li> <li><span class="koboSpan" id="kobo.805.1" xmlns:="http://www.w3.org/1999/xhtml">Then, load the data and separate it into train and </span><span class="No-Break"><span class="koboSpan" id="kobo.806.1" xmlns:="http://www.w3.org/1999/xhtml">test sets:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.807.1" xmlns:="http://www.w3.org/1999/xhtml">
data = load_breast_cancer()
df = pd.DataFrame(data.data,
    columns=data.feature_names)
X_train, X_test, y_train, y_test = train_test_split(
    df, data.target, </span><a id="_idTextAnchor1057"/><span class="koboSpan" id="kobo.808.1" xmlns:="http://www.w3.org/1999/xhtml">test_size=0.3, random_state=0
)</span></pre></li> <li><span class="koboSpan" id="kobo.809.1" xmlns:="http://www.w3.org/1999/xhtml">Make a list with the features </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1" xmlns:="http://www.w3.org/1999/xhtml">to combine:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.811.1" xmlns:="http://www.w3.org/1999/xhtml">
features = [
    "mean smoothness",
    "mean compactness",
    "mean concavity"]</span></pre></li> <li><span class="koboSpan" id="kobo.812.1" xmlns:="http://www.w3.org/1999/xhtml">Set up </span><strong class="source-inline"><span class="koboSpan" id="kobo.813.1" xmlns:="http://www.w3.org/1999/xhtml">PolynomialFeatures()</span></strong><span class="koboSpan" id="kobo.814.1" xmlns:="http://www.w3.org/1999/xhtml"> to create all possible combinations up to the </span><span class="No-Break"><span class="koboSpan" id="kobo.815.1" xmlns:="http://www.w3.org/1999/xhtml">third degree:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.816.1" xmlns:="http://www.w3.org/1999/xhtml">
poly = PolynomialFeatures(
    degree=3,
    interaction_only=False,
    include_bias=False)</span></pre></li> <li><span class="koboSpan" id="kobo.817.1" xmlns:="http://www.w3.org/1999/xhtml">Set up the column transformer to create features only from those specified in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.818.1" xmlns:="http://www.w3.org/1999/xhtml">step 3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.819.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.820.1" xmlns:="http://www.w3.org/1999/xhtml">
ct = ColumnTransformer([("poly", poly, features)])</span></pre></li> <li><span class="koboSpan" id="kobo.821.1" xmlns:="http://www.w3.org/1999/xhtml">Create the </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1" xmlns:="http://www.w3.org/1999/xhtml">polynomial features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.823.1" xmlns:="http://www.w3.org/1999/xhtml">
train_t = ct.fit_transform(X_train)
test_t = ct.transform(X_test)</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.824.1" xmlns:="http://www.w3.org/1999/xhtml">And that’s it. </span><span class="koboSpan" id="kobo.824.2" xmlns:="http://www.w3.org/1999/xhtml">By </span><a id="_idIndexMarker605"/><span class="koboSpan" id="kobo.825.1" xmlns:="http://www.w3.org/1999/xhtml">executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.826.1" xmlns:="http://www.w3.org/1999/xhtml">ct.get_featur</span><a id="_idTextAnchor1058"/><span class="koboSpan" id="kobo.827.1" xmlns:="http://www.w3.org/1999/xhtml">e_names_out()</span></strong><span class="koboSpan" id="kobo.828.1" xmlns:="http://www.w3.org/1999/xhtml">, we obtain the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.829.1" xmlns:="http://www.w3.org/1999/xhtml">new features.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.830.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.831.1" xmlns:="http://www.w3.org/1999/xhtml">ColumnTransformer()</span></strong><span class="koboSpan" id="kobo.832.1" xmlns:="http://www.w3.org/1999/xhtml"> will append the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.833.1" xmlns:="http://www.w3.org/1999/xhtml">poly</span></strong><span class="koboSpan" id="kobo.834.1" xmlns:="http://www.w3.org/1999/xhtml"> to the resulting variables, which is the name we gave to the step within </span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1" xmlns:="http://www.w3.org/1999/xhtml">ColumnTransformer()</span></strong><span class="koboSpan" id="kobo.836.1" xmlns:="http://www.w3.org/1999/xhtml"> in </span><em class="italic"><span class="koboSpan" id="kobo.837.1" xmlns:="http://www.w3.org/1999/xhtml">step 5</span></em><span class="koboSpan" id="kobo.838.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.838.2" xmlns:="http://www.w3.org/1999/xhtml">I am not a huge fan of this behavior because it makes data analysis harder, as you need to keep track of the variable name changes. </span><span class="koboSpan" id="kobo.838.3" xmlns:="http://www.w3.org/1999/xhtml">To avoid variable name changes, you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.840.1" xmlns:="http://www.w3.org/1999/xhtml">’s</span><a id="_idTextAnchor1059"/><a id="_idTextAnchor1060"/><a id="_idTextAnchor1061"/> <span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.841.1" xmlns:="http://www.w3.org/1999/xhtml">SklearnTransformerWrapper()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.842.1" xmlns:="http://www.w3.org/1999/xhtml"> instead.</span></span></p>
<h1 id="_idParaDest-236"><a id="_idTextAnchor1062"/><span class="koboSpan" id="kobo.843.1" xmlns:="http://www.w3.org/1999/xhtml">Combining features with decision trees</span></h1>
<p><span class="koboSpan" id="kobo.844.1" xmlns:="http://www.w3.org/1999/xhtml">In the</span><a id="_idIndexMarker606"/><span class="koboSpan" id="kobo.845.1" xmlns:="http://www.w3.org/1999/xhtml"> winning solution of the </span><strong class="bold"><span class="koboSpan" id="kobo.846.1" xmlns:="http://www.w3.org/1999/xhtml">Knowledge Discovery and Data</span></strong><span class="koboSpan" id="kobo.847.1" xmlns:="http://www.w3.org/1999/xhtml"> Mining (</span><strong class="bold"><span class="koboSpan" id="kobo.848.1" xmlns:="http://www.w3.org/1999/xhtml">KDD</span></strong><span class="koboSpan" id="kobo.849.1" xmlns:="http://www.w3.org/1999/xhtml">) competition in 200</span><a id="_idTextAnchor1063"/><span class="koboSpan" id="kobo.850.1" xmlns:="http://www.w3.org/1999/xhtml">9, the authors created new features by combining two or more variables using decision trees. </span><span class="koboSpan" id="kobo.850.2" xmlns:="http://www.w3.org/1999/xhtml">When examining the</span><a id="_idIndexMarker607"/><span class="koboSpan" id="kobo.851.1" xmlns:="http://www.w3.org/1999/xhtml"> variables, they noticed that some features had a high level of mutual information with the target yet low correlation, indicating that the relationship with the target was not linear. </span><span class="koboSpan" id="kobo.851.2" xmlns:="http://www.w3.org/1999/xhtml">While these features </span><a id="_idIndexMarker608"/><span class="koboSpan" id="kobo.852.1" xmlns:="http://www.w3.org/1999/xhtml">were predictive when used in tree-based algorithms, linear models could not take advantage of them. </span><span class="koboSpan" id="kobo.852.2" xmlns:="http://www.w3.org/1999/xhtml">Hence, to use these features in linear models, they replaced the features with the outputs of decision trees trained on the individual features, or combinations of two or three variables, to return new features with a monotonic relationship with </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1" xmlns:="http://www.w3.org/1999/xhtml">the target.</span></span></p>
<p><span class="koboSpan" id="kobo.854.1" xmlns:="http://www.w3.org/1999/xhtml">In short, combining features with decision trees is useful for creating features that show a monotonic relationship with the target, which is useful for making accurate predictions</span><a id="_idIndexMarker609"/><span class="koboSpan" id="kobo.855.1" xmlns:="http://www.w3.org/1999/xhtml"> using linear models. </span><span class="koboSpan" id="kobo.855.2" xmlns:="http://www.w3.org/1999/xhtml">The procedure consists of training a decision tree using a subset of the </span><a id="_idIndexMarker610"/><span class="koboSpan" id="kobo.856.1" xmlns:="http://www.w3.org/1999/xhtml">features – typically, one, two, or three at a time – and then using the prediction of the tree as a </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1" xmlns:="http://www.w3.org/1999/xhtml">new feature.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.858.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.859.1" xmlns:="http://www.w3.org/1999/xhtml">You can find more details about this procedure and the overall winning solution of the 2009 KDD data competition in this </span><span class="No-Break"><span class="koboSpan" id="kobo.860.1" xmlns:="http://www.w3.org/1999/xhtml">article: </span></span><a href="http://proceedings.mlr.press/v7/niculescu09/niculescu09.pdf"><span class="No-Break"><span class="koboSpan" id="kobo.861.1" xmlns:="http://www.w3.org/1999/xhtml">http://proceedings.mlr.press/v7/niculescu09/niculescu09.pdf</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.862.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.863.1" xmlns:="http://www.w3.org/1999/xhtml">The good news is that we can automate the creation of features using trees, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.864.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.865.1" xmlns:="http://www.w3.org/1999/xhtml">, and i</span><a id="_idTextAnchor1064"/><a id="_idTextAnchor1065"/><a id="_idTextAnchor1066"/><span class="koboSpan" id="kobo.866.1" xmlns:="http://www.w3.org/1999/xhtml">n this recipe, we will learn how to </span><span class="No-Break"><span class="koboSpan" id="kobo.867.1" xmlns:="http://www.w3.org/1999/xhtml">do so.</span></span></p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor1067"/><span class="koboSpan" id="kobo.868.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.869.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we’ll combine features with decision trees, using the California </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1" xmlns:="http://www.w3.org/1999/xhtml">housing dataset:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.871.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by importing </span><strong class="source-inline"><span class="koboSpan" id="kobo.872.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.873.1" xmlns:="http://www.w3.org/1999/xhtml"> and the required functions, classes, </span><span class="No-Break"><span class="koboSpan" id="kobo.874.1" xmlns:="http://www.w3.org/1999/xhtml">and dataset:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.875.1" xmlns:="http://www.w3.org/1999/xhtml">
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.datasets import fetch_california_housing
from sklearn.model_selection import train_test_split
from </span><strong class="source-inline"><span class="koboSpan" id="kobo.876.1" xmlns:="http://www.w3.org/1999/xhtml">feature_engine.creation</span></strong><span class="koboSpan" id="kobo.877.1" xmlns:="http://www.w3.org/1999/xhtml">, import DecisionTreeFeatures</span></pre></li> <li><span class="koboSpan" id="kobo.878.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s load the California housing dataset into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.879.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.880.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame and remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.881.1" xmlns:="http://www.w3.org/1999/xhtml">Latitude</span></strong><span class="koboSpan" id="kobo.882.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.883.1" xmlns:="http://www.w3.org/1999/xhtml">Longitude</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.884.1" xmlns:="http://www.w3.org/1999/xhtml"> variables:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.885.1" xmlns:="http://www.w3.org/1999/xhtml">
X, y = fetch_california_housing(
    return_X_y=True, as_frame=True)
X.drop(labels=[
    "Latitude", "Longitude"], axis=1, inplace=True)</span></pre></li> <li><span class="koboSpan" id="kobo.886.1" xmlns:="http://www.w3.org/1999/xhtml">Separate the dataset into train and </span><span class="No-Break"><span class="koboSpan" id="kobo.887.1" xmlns:="http://www.w3.org/1999/xhtml">test sets:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.888.1" xmlns:="http://www.w3.org/1999/xhtml">
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.3, random_state=0)</span></pre></li> <li><span class="koboSpan" id="kobo.889.1" xmlns:="http://www.w3.org/1999/xhtml">Check out </span><a id="_idIndexMarker611"/><span class="koboSpan" id="kobo.890.1" xmlns:="http://www.w3.org/1999/xhtml">Pearson’s correlation coefficient </span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.891.1" xmlns:="http://www.w3.org/1999/xhtml">between the features and the target, which is a measure of a </span><span class="No-Break"><span class="koboSpan" id="kobo.892.1" xmlns:="http://www.w3.org/1999/xhtml">linear relationship:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.893.1" xmlns:="http://www.w3.org/1999/xhtml">
for var in X_train.columns:
    pearson = np.corrcoef(X_train[var], y_train)[0, 1]
    pearson = np.round(pearson, 2)
    print(
        f"corr {var} vs target: {pearson}")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.894.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see that, apart from </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1" xmlns:="http://www.w3.org/1999/xhtml">MedInc</span></strong><span class="koboSpan" id="kobo.896.1" xmlns:="http://www.w3.org/1999/xhtml">, most variables do not show a strong linear relationship with the target; the correlation coefficient is smaller </span><span class="No-Break"><span class="koboSpan" id="kobo.897.1" xmlns:="http://www.w3.org/1999/xhtml">than 0.5:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.898.1" xmlns:="http://www.w3.org/1999/xhtml">corr MedInc vs target: 0.69</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.899.1" xmlns:="http://www.w3.org/1999/xhtml">corr HouseAge vs target: 0.1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.900.1" xmlns:="http://www.w3.org/1999/xhtml">corr AveRooms vs target: 0.16</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.901.1" xmlns:="http://www.w3.org/1999/xhtml">corr AveBedrms vs target: -0.05</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.902.1" xmlns:="http://www.w3.org/1999/xhtml">corr Population vs target: -0.03</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.903.1" xmlns:="http://www.w3.org/1999/xhtml">corr AveOccup vs target: -0.03</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.904.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.906.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.907.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.908.1" xmlns:="http://www.w3.org/1999/xhtml"> selects the best tree by </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1" xmlns:="http://www.w3.org/1999/xhtml">using cross-validation.</span></span></p></li> <li><span class="koboSpan" id="kobo.910.1" xmlns:="http://www.w3.org/1999/xhtml">Create a grid of hyperparameters to optimize each </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1" xmlns:="http://www.w3.org/1999/xhtml">decision tree:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.912.1" xmlns:="http://www.w3.org/1999/xhtml">
param_grid = {"max_depth": [2, 3, 4, None]}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.913.1" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.914.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong><span class="koboSpan" id="kobo.915.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.916.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.917.1" xmlns:="http://www.w3.org/1999/xhtml"> allows us to add features resulting from the predictions of a decision tree, trained on one or more features. </span><span class="koboSpan" id="kobo.917.2" xmlns:="http://www.w3.org/1999/xhtml">There</span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.918.1" xmlns:="http://www.w3.org/1999/xhtml"> are many ways in which we can instruct the transformer to combine the features. </span><span class="koboSpan" id="kobo.918.2" xmlns:="http://www.w3.org/1999/xhtml">We’ll start by creating all possible combinations between </span><span class="No-Break"><span class="koboSpan" id="kobo.919.1" xmlns:="http://www.w3.org/1999/xhtml">two variables.</span></span></p></li> <li><span class="koboSpan" id="kobo.920.1" xmlns:="http://www.w3.org/1999/xhtml">Make a list</span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.921.1" xmlns:="http://www.w3.org/1999/xhtml"> with the two features that we want to use </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1" xmlns:="http://www.w3.org/1999/xhtml">as inputs:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.923.1" xmlns:="http://www.w3.org/1999/xhtml">
variables = ["AveRooms", "AveBedrms"]</span></pre></li> <li><span class="koboSpan" id="kobo.924.1" xmlns:="http://www.w3.org/1999/xhtml">Set up </span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.926.1" xmlns:="http://www.w3.org/1999/xhtml"> to create all possible combinations between the features from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.927.1" xmlns:="http://www.w3.org/1999/xhtml">step 6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.928.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.929.1" xmlns:="http://www.w3.org/1999/xhtml">
dtf = DecisionTreeFeatures(
    variables=variables,
    features_to_combine=None,
    cv=5,
    param_grid=param_grid,
    scoring="neg_mean_squared_error",
    regression=True,
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.930.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.931.1" xmlns:="http://www.w3.org/1999/xhtml">We set </span><strong class="source-inline"><span class="koboSpan" id="kobo.932.1" xmlns:="http://www.w3.org/1999/xhtml">regression</span></strong><span class="koboSpan" id="kobo.933.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.934.1" xmlns:="http://www.w3.org/1999/xhtml">True</span></strong><span class="koboSpan" id="kobo.935.1" xmlns:="http://www.w3.org/1999/xhtml"> because the target in this dataset is continuous. </span><span class="koboSpan" id="kobo.935.2" xmlns:="http://www.w3.org/1999/xhtml">If you have a binary target or are performing classification, set it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.936.1" xmlns:="http://www.w3.org/1999/xhtml">False</span></strong><span class="koboSpan" id="kobo.937.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.937.2" xmlns:="http://www.w3.org/1999/xhtml">Make sure to select an evaluation metric (</span><strong class="source-inline"><span class="koboSpan" id="kobo.938.1" xmlns:="http://www.w3.org/1999/xhtml">scoring</span></strong><span class="koboSpan" id="kobo.939.1" xmlns:="http://www.w3.org/1999/xhtml">) that is suitable for </span><span class="No-Break"><span class="koboSpan" id="kobo.940.1" xmlns:="http://www.w3.org/1999/xhtml">your model.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.941.1" xmlns:="http://www.w3.org/1999/xhtml">Fit the transformer so that it trains the decision trees on the </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1" xmlns:="http://www.w3.org/1999/xhtml">input features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.943.1" xmlns:="http://www.w3.org/1999/xhtml">
dtf.fit(X_train, y_train)</span></pre></li> <li><span class="koboSpan" id="kobo.944.1" xmlns:="http://www.w3.org/1999/xhtml">If you wonder </span><a id="_idIndexMarker615"/><span class="koboSpan" id="kobo.945.1" xmlns:="http://www.w3.org/1999/xhtml">which features have been used to train decision trees, you can inspect them </span><span class="No-Break"><span class="koboSpan" id="kobo.946.1" xmlns:="http://www.w3.org/1999/xhtml">like this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.947.1" xmlns:="http://www.w3.org/1999/xhtml">
dtf.input_features_</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.948.1" xmlns:="http://www.w3.org/1999/xhtml">In the</span><a id="_idIndexMarker616"/><span class="koboSpan" id="kobo.949.1" xmlns:="http://www.w3.org/1999/xhtml"> following output, we can see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.951.1" xmlns:="http://www.w3.org/1999/xhtml"> has trained three decision trees – two by using the single features, </span><strong class="source-inline"><span class="koboSpan" id="kobo.952.1" xmlns:="http://www.w3.org/1999/xhtml">AveRooms</span></strong><span class="koboSpan" id="kobo.953.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1" xmlns:="http://www.w3.org/1999/xhtml">AveBedrms</span></strong><span class="koboSpan" id="kobo.955.1" xmlns:="http://www.w3.org/1999/xhtml">, and one by using </span><span class="No-Break"><span class="koboSpan" id="kobo.956.1" xmlns:="http://www.w3.org/1999/xhtml">both features:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.957.1" xmlns:="http://www.w3.org/1999/xhtml">['AveRooms', 'AveBedrms', ['AveRooms', 'AveBedrms']]</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.958.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.959.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.960.1" xmlns:="http://www.w3.org/1999/xhtml"> also stores the decision trees. </span><span class="koboSpan" id="kobo.960.2" xmlns:="http://www.w3.org/1999/xhtml">You can check them out by executing  </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.961.1" xmlns:="http://www.w3.org/1999/xhtml">dtf.estimators_</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.962.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.963.1" xmlns:="http://www.w3.org/1999/xhtml">Now, add the features to the training and </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1" xmlns:="http://www.w3.org/1999/xhtml">testing sets:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.965.1" xmlns:="http://www.w3.org/1999/xhtml">
train_t = dtf.transform(X_train)
test_t = dtf.transform(X_test)</span></pre></li> <li><span class="koboSpan" id="kobo.966.1" xmlns:="http://www.w3.org/1999/xhtml">Make a list with the name of the new features (the transformer appends the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.967.1" xmlns:="http://www.w3.org/1999/xhtml">tree</span></strong><span class="koboSpan" id="kobo.968.1" xmlns:="http://www.w3.org/1999/xhtml"> to the </span><span class="No-Break"><span class="koboSpan" id="kobo.969.1" xmlns:="http://www.w3.org/1999/xhtml">feature names):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.970.1" xmlns:="http://www.w3.org/1999/xhtml">
tree_features = [
    var for var in test_t.columns if "tree" in var ]</span></pre></li> <li><span class="koboSpan" id="kobo.971.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, display the features that were added to the </span><span class="No-Break"><span class="koboSpan" id="kobo.972.1" xmlns:="http://www.w3.org/1999/xhtml">test set:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.973.1" xmlns:="http://www.w3.org/1999/xhtml">
test_t[tree_features].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.974.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the first five rows of the new features, resulting from the decision trees trained in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.975.1" xmlns:="http://www.w3.org/1999/xhtml">step 8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.976.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.977.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="    Figure 8.9 – A portion of the testing set containing the features derived from the decision trees" src="image/B22396_08_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.978.1" xmlns:="http://www.w3.org/1999/xhtml">    Figure 8.9 – A portion of the testing set containing the features derived from the decision trees</span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.979.1" xmlns:="http://www.w3.org/1999/xhtml">To check the </span><a id="_idIndexMarker617"/><span class="koboSpan" id="kobo.980.1" xmlns:="http://www.w3.org/1999/xhtml">power of this transformation, calculate </span><a id="_idIndexMarker618"/><span class="koboSpan" id="kobo.981.1" xmlns:="http://www.w3.org/1999/xhtml">Pearson’s correlation coefficient between the new features and </span><span class="No-Break"><span class="koboSpan" id="kobo.982.1" xmlns:="http://www.w3.org/1999/xhtml">the target:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.983.1" xmlns:="http://www.w3.org/1999/xhtml">
for var in tree_features:
    pearson = np.corrcoef(test_t[var], y_test)[0, 1]
    pearson = np.round(pearson, 2)
    print(
        f"corr {var} vs target: {pearson}")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.984.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see that the correlation between the new variables and the target is greater than the correlation shown by the original features (compare these values with those of </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.985.1" xmlns:="http://www.w3.org/1999/xhtml">step 4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.986.1" xmlns:="http://www.w3.org/1999/xhtml">):</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.987.1" xmlns:="http://www.w3.org/1999/xhtml">corr tree(AveRooms) vs target: 0.37
corr tree(AveBedrms) vs target: 0.12
corr tree(['AveRooms', 'AveBedrms']) vs target: 0.47</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.988.1" xmlns:="http://www.w3.org/1999/xhtml">If you want to combine specific features instead of getting all possible combinations between variables, you can do so by specifying the input features </span><span class="No-Break"><span class="koboSpan" id="kobo.989.1" xmlns:="http://www.w3.org/1999/xhtml">in tuples.</span></span></p></li> <li><span class="koboSpan" id="kobo.990.1" xmlns:="http://www.w3.org/1999/xhtml">Create a tuple of tuples with the different features that we want to use as input for </span><span class="No-Break"><span class="koboSpan" id="kobo.991.1" xmlns:="http://www.w3.org/1999/xhtml">decision trees:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.992.1" xmlns:="http://www.w3.org/1999/xhtml">
features = (('Population'), ('Population','AveOccup'),
    ('Population', 'AveOccup', 'HouseAge'))</span></pre></li> <li><span class="koboSpan" id="kobo.993.1" xmlns:="http://www.w3.org/1999/xhtml">Now, we </span><a id="_idIndexMarker619"/><span class="koboSpan" id="kobo.994.1" xmlns:="http://www.w3.org/1999/xhtml">need </span><a id="_idIndexMarker620"/><span class="koboSpan" id="kobo.995.1" xmlns:="http://www.w3.org/1999/xhtml">to pass these tuples to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1" xmlns:="http://www.w3.org/1999/xhtml">features_to_combine</span></strong><span class="koboSpan" id="kobo.997.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.998.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.999.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1000.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1001.1" xmlns:="http://www.w3.org/1999/xhtml">
dtf = DecisionTreeFeatures(
    variables=None,
    features_to_combine=features,
    cv=5,
    param_grid=param_grid,
    scoring="neg_mean_squared_error"
)
dtf.fit(X_train, y_train)</span></pre></li> <li><span class="koboSpan" id="kobo.1002.1" xmlns:="http://www.w3.org/1999/xhtml">We fitted the transformer in the previous step, so we can go ahead and add the features to training and </span><span class="No-Break"><span class="koboSpan" id="kobo.1003.1" xmlns:="http://www.w3.org/1999/xhtml">test sets:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1004.1" xmlns:="http://www.w3.org/1999/xhtml">
train_t = dtf.transform(X_train)
test_t = dtf.transform(X_test)</span></pre></li> <li><span class="koboSpan" id="kobo.1005.1" xmlns:="http://www.w3.org/1999/xhtml">Display the </span><span class="No-Break"><span class="koboSpan" id="kobo.1006.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1007.1" xmlns:="http://www.w3.org/1999/xhtml">
tree_features = [
    var for var in test_t.columns if "tree" in var]
test_t[tree_features].head()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1008.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the new features derived from predictions of decision trees in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1009.1" xmlns:="http://www.w3.org/1999/xhtml">test set:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.1010.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="    Figure 8.10 – A portion of the testing set containing the features derived from the decision trees" src="image/B22396_08_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1011.1" xmlns:="http://www.w3.org/1999/xhtml">    Figure 8.10 – A portion of the testing set containing the features derived from the decision trees</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1012.1" xmlns:="http://www.w3.org/1999/xhtml">To wrap up</span><a id="_idIndexMarker621"/><span class="koboSpan" id="kobo.1013.1" xmlns:="http://www.w3.org/1999/xhtml"> the recipe, we’ll compare </span><a id="_idIndexMarker622"/><span class="koboSpan" id="kobo.1014.1" xmlns:="http://www.w3.org/1999/xhtml">the performance of a Lasso linear regression model trained using the original features with one using the features derived from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1" xmlns:="http://www.w3.org/1999/xhtml">decision trees.</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.1016.1" xmlns:="http://www.w3.org/1999/xhtml">Import </span><strong class="source-inline"><span class="koboSpan" id="kobo.1017.1" xmlns:="http://www.w3.org/1999/xhtml">Lasso</span></strong><span class="koboSpan" id="kobo.1018.1" xmlns:="http://www.w3.org/1999/xhtml"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1" xmlns:="http://www.w3.org/1999/xhtml">cross_validate</span></strong><span class="koboSpan" id="kobo.1020.1" xmlns:="http://www.w3.org/1999/xhtml"> function </span><span class="No-Break"><span class="koboSpan" id="kobo.1021.1" xmlns:="http://www.w3.org/1999/xhtml">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1023.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1024.1" xmlns:="http://www.w3.org/1999/xhtml">
from sklearn.linear_model import Lasso
from sklearn.model_selection import cross_validate</span></pre></li> <li><span class="koboSpan" id="kobo.1025.1" xmlns:="http://www.w3.org/1999/xhtml">Set up a Lasso </span><span class="No-Break"><span class="koboSpan" id="kobo.1026.1" xmlns:="http://www.w3.org/1999/xhtml">regression model:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1027.1" xmlns:="http://www.w3.org/1999/xhtml">
lasso = Lasso(random_state=0, alpha=0.0001)</span></pre></li> <li><span class="koboSpan" id="kobo.1028.1" xmlns:="http://www.w3.org/1999/xhtml">Train and evaluate the model using the original data with cross-validation, and then print out the </span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1" xmlns:="http://www.w3.org/1999/xhtml">resulting </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1030.1" xmlns:="http://www.w3.org/1999/xhtml">r</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1031.1" xmlns:="http://www.w3.org/1999/xhtml">-squared:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1032.1" xmlns:="http://www.w3.org/1999/xhtml">
cv_results = cross_validate(lasso, X_train, y_train,
    cv=3)
mean = cv_results['test_score'].mean()
std = cv_results['test_score'].std()
print(f"Results: {mean} +/- {std}")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1033.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the </span><em class="italic"><span class="koboSpan" id="kobo.1034.1" xmlns:="http://www.w3.org/1999/xhtml">r</span></em><span class="koboSpan" id="kobo.1035.1" xmlns:="http://www.w3.org/1999/xhtml">-squared of the Lasso regression model trained using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1036.1" xmlns:="http://www.w3.org/1999/xhtml">original features:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1037.1" xmlns:="http://www.w3.org/1999/xhtml">Results: 0.5480403481478856 +/- 0.004214649109293269</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1038.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, train a Lasso regression model with the features derived from the decision trees</span><a id="_idIndexMarker623"/><span class="koboSpan" id="kobo.1039.1" xmlns:="http://www.w3.org/1999/xhtml"> and evaluate it </span><span class="No-Break"><span class="koboSpan" id="kobo.1040.1" xmlns:="http://www.w3.org/1999/xhtml">with cross-validation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1041.1" xmlns:="http://www.w3.org/1999/xhtml">
variables = ["AveRooms", "AveBedrms", "Population"]
train_t = train_t.drop(variables, axis=1)
cv_results = cross_validate(lasso, train_t, y_train,
    cv=3)
mean = cv_results['test_score'].mean()
std = cv_results['test_score'].std()
print(f"Results: {mean} +/- {std}")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1042.1" xmlns:="http://www.w3.org/1999/xhtml">In the</span><a id="_idIndexMarker624"/><span class="koboSpan" id="kobo.1043.1" xmlns:="http://www.w3.org/1999/xhtml"> following output, we can see that the performance of the Lasso regression model trained based of the tree-derived features is b</span><a id="_idTextAnchor1068"/><span class="koboSpan" id="kobo.1044.1" xmlns:="http://www.w3.org/1999/xhtml">etter; the </span><em class="italic"><span class="koboSpan" id="kobo.1045.1" xmlns:="http://www.w3.org/1999/xhtml">r</span></em><span class="koboSpan" id="kobo.1046.1" xmlns:="http://www.w3.org/1999/xhtml">-square is greater than that from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1047.1" xmlns:="http://www.w3.org/1999/xhtml">step 20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1048.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1049.1" xmlns:="http://www.w3.org/1999/xhtml">Results: 0.5800993721099441 +/- 0.002845475651622909</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1050.1" xmlns:="http://www.w3.org/1999/xhtml">I hope I’ve given you a flavor of the power of combining features wit</span><a id="_idTextAnchor1069"/><a id="_idTextAnchor1070"/><span class="koboSpan" id="kobo.1051.1" xmlns:="http://www.w3.org/1999/xhtml">h decision trees and how to do so </span><span class="No-Break"><span class="koboSpan" id="kobo.1052.1" xmlns:="http://www.w3.org/1999/xhtml">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1054.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor1071"/><span class="koboSpan" id="kobo.1055.1" xmlns:="http://www.w3.org/1999/xhtml">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.1056.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we created new features based on the predictions of decision trees trained on one or more variables. </span><span class="koboSpan" id="kobo.1056.2" xmlns:="http://www.w3.org/1999/xhtml">We used </span><strong class="source-inline"><span class="koboSpan" id="kobo.1057.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1058.1" xmlns:="http://www.w3.org/1999/xhtml"> from</span><strong class="source-inline"><span class="koboSpan" id="kobo.1059.1" xmlns:="http://www.w3.org/1999/xhtml"> Feature-engine</span></strong><span class="koboSpan" id="kobo.1060.1" xmlns:="http://www.w3.org/1999/xhtml"> to automate the process of training the decision trees with cross-validation and </span><span class="No-Break"><span class="koboSpan" id="kobo.1061.1" xmlns:="http://www.w3.org/1999/xhtml">hyperparameter optimization.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1063.1" xmlns:="http://www.w3.org/1999/xhtml"> trains decision trees using grid-search under the hood. </span><span class="koboSpan" id="kobo.1063.2" xmlns:="http://www.w3.org/1999/xhtml">Hence, you can pass a grid of hyperparameters to optimize the tree, or the transformer will optimize just the depth, which, in any case, is the most important parameter in a decision tree. </span><span class="koboSpan" id="kobo.1063.3" xmlns:="http://www.w3.org/1999/xhtml">You can also change the metric you want to optimize through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1" xmlns:="http://www.w3.org/1999/xhtml">scoring</span></strong><span class="koboSpan" id="kobo.1065.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter and the cross-validation scheme you want to use through the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1066.1" xmlns:="http://www.w3.org/1999/xhtml">cv</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1067.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.1068.1" xmlns:="http://www.w3.org/1999/xhtml">The most exciting feature of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1070.1" xmlns:="http://www.w3.org/1999/xhtml"> is its ability to infer the feature combinations to create tree-derived features, which is regulated through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1" xmlns:="http://www.w3.org/1999/xhtml">features_to_combine</span></strong><span class="koboSpan" id="kobo.1072.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter. </span><span class="koboSpan" id="kobo.1072.2" xmlns:="http://www.w3.org/1999/xhtml">If you pass an integer to this parameter – say, for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1073.1" xmlns:="http://www.w3.org/1999/xhtml">3</span></strong><span class="koboSpan" id="kobo.1074.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1075.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1076.1" xmlns:="http://www.w3.org/1999/xhtml"> will create all possible combinations of 1, 2, and 3 features and use these to train the decision trees. </span><span class="koboSpan" id="kobo.1076.2" xmlns:="http://www.w3.org/1999/xhtml">Instead of an integer, you can pass a list of integers – say, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1" xmlns:="http://www.w3.org/1999/xhtml">[2,3]</span></strong><span class="koboSpan" id="kobo.1078.1" xmlns:="http://www.w3.org/1999/xhtml"> – in which case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1080.1" xmlns:="http://www.w3.org/1999/xhtml"> will create all</span><a id="_idIndexMarker625"/><span class="koboSpan" id="kobo.1081.1" xmlns:="http://www.w3.org/1999/xhtml"> possible combinations of 2 and 3 features. </span><span class="koboSpan" id="kobo.1081.2" xmlns:="http://www.w3.org/1999/xhtml">You</span><a id="_idIndexMarker626"/><span class="koboSpan" id="kobo.1082.1" xmlns:="http://www.w3.org/1999/xhtml"> can also specify which features you want to combine and how by passing the feature combinations in tuples, as we did in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1083.1" xmlns:="http://www.w3.org/1999/xhtml">step 14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1084.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1085.1" xmlns:="http://www.w3.org/1999/xhtml">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1" xmlns:="http://www.w3.org/1999/xhtml">fit()</span></strong><span class="koboSpan" id="kobo.1087.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1088.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1089.1" xmlns:="http://www.w3.org/1999/xhtml"> finds the feature combinations and trains the decision trees. </span><span class="koboSpan" id="kobo.1089.2" xmlns:="http://www.w3.org/1999/xhtml">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.1091.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1" xmlns:="http://www.w3.org/1999/xhtml">DecisionTreeFeatures()</span></strong><span class="koboSpan" id="kobo.1093.1" xmlns:="http://www.w3.org/1999/xhtml"> adds the features resulting from the decision trees to </span><span class="No-Break"><span class="koboSpan" id="kobo.1094.1" xmlns:="http://www.w3.org/1999/xhtml">the DataFrame.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1095.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1096.1" xmlns:="http://www.w3.org/1999/xhtml">If you are training regression or multi-class classification, the new features will be either the prediction of the continuous target or the class. </span><span class="koboSpan" id="kobo.1096.2" xmlns:="http://www.w3.org/1999/xhtml">If you are training a binary classification model, the new features will result from the probability of </span><span class="No-Break"><span class="koboSpan" id="kobo.1097.1" xmlns:="http://www.w3.org/1999/xhtml">class 1.</span></span></p>
<p><span class="koboSpan" id="kobo.1098.1" xmlns:="http://www.w3.org/1999/xhtml">After adding the new features, we compared their relationship to the target by analyzing Pearson’s correlation coefficient, which returned a measure of linear association. </span><span class="koboSpan" id="kobo.1098.2" xmlns:="http://www.w3.org/1999/xhtml">We saw that the features derived from trees had a greater </span><span class="No-Break"><span class="koboSpan" id="kobo.1099.1" xmlns:="http://www.w3.org/1999/xhtml">correlation coefficient.</span></span></p>
<h2 id="_idParaDest-239"><a id="_idTextAnchor1072"/><span class="koboSpan" id="kobo.1100.1" xmlns:="http://www.w3.org/1999/xhtml">See also</span></h2>
<p><span class="koboSpan" id="kobo.1101.1" xmlns:="http://www.w3.org/1999/xhtml">If you want to know more about what mutual information is and how to calculate it, check out this </span><span class="No-Break"><span class="koboSpan" id="kobo.1102.1" xmlns:="http://www.w3.org/1999/xhtml">article: </span></span><a href="https://www.blog.trainindata.com/mutual-information-with-python/"><span class="No-Break"><span class="koboSpan" id="kobo.1103.1" xmlns:="http://www.w3.org/1999/xhtml">https://www.blog.trainindata.com/mutual-information-with-python/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1104.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<h1 id="_idParaDest-240"><a id="_idTextAnchor1073"/><span class="koboSpan" id="kobo.1105.1" xmlns:="http://www.w3.org/1999/xhtml">Creating periodic features from cyclical variables</span></h1>
<p><span class="koboSpan" id="kobo.1106.1" xmlns:="http://www.w3.org/1999/xhtml">Some features</span><a id="_idIndexMarker627"/><span class="koboSpan" id="kobo.1107.1" xmlns:="http://www.w3.org/1999/xhtml"> are periodic – for e</span><a id="_idTextAnchor1074"/><span class="koboSpan" id="kobo.1108.1" xmlns:="http://www.w3.org/1999/xhtml">xample, the</span><a id="_idIndexMarker628"/><span class="koboSpan" id="kobo.1109.1" xmlns:="http://www.w3.org/1999/xhtml"> hours in</span><a id="_idTextAnchor1075"/><span class="koboSpan" id="kobo.1110.1" xmlns:="http://www.w3.org/1999/xhtml"> a day, the months in a year, and the days in a week. </span><span class="koboSpan" id="kobo.1110.2" xmlns:="http://www.w3.org/1999/xhtml">They all start at a certain value (say, January), go up to a certain other value (say, December), and then start over from the beginning. </span><span class="koboSpan" id="kobo.1110.3" xmlns:="http://www.w3.org/1999/xhtml">Some features are numeric, such as the hours, and some can be represented with numbers, such as the months, with values of 1 to 12. </span><span class="koboSpan" id="kobo.1110.4" xmlns:="http://www.w3.org/1999/xhtml">Yet, this numeric representation does not capture the periodicity or cyclical nature of the variable. </span><span class="koboSpan" id="kobo.1110.5" xmlns:="http://www.w3.org/1999/xhtml">For example, December (12) is closer to January (1) than June (6); however, this relationship is not captured by the numerical representation of the feature. </span><span class="koboSpan" id="kobo.1110.6" xmlns:="http://www.w3.org/1999/xhtml">But we could change it if we transformed these variables with the sine and cosine, two naturally </span><span class="No-Break"><span class="koboSpan" id="kobo.1111.1" xmlns:="http://www.w3.org/1999/xhtml">periodic functions.</span></span></p>
<p><span class="koboSpan" id="kobo.1112.1" xmlns:="http://www.w3.org/1999/xhtml">Encoding </span><a id="_idIndexMarker629"/><span class="koboSpan" id="kobo.1113.1" xmlns:="http://www.w3.org/1999/xhtml">cyclical features </span><a id="_idIndexMarker630"/><span class="koboSpan" id="kobo.1114.1" xmlns:="http://www.w3.org/1999/xhtml">with the sine and cosine functions allows linear models to leverage the cyclical nature of features and reduce their modeling error. </span><span class="koboSpan" id="kobo.1114.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will create new features from </span><a id="_idTextAnchor1076"/><a id="_idTextAnchor1077"/><span class="koboSpan" id="kobo.1115.1" xmlns:="http://www.w3.org/1999/xhtml">periodic variables that capture the cyclical nature </span><span class="No-Break"><span class="koboSpan" id="kobo.1116.1" xmlns:="http://www.w3.org/1999/xhtml">of time.</span></span></p>
<h2 id="_idParaDest-241"><a id="_idTextAnchor1078"/><span class="koboSpan" id="kobo.1117.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1118.1" xmlns:="http://www.w3.org/1999/xhtml">Trigonometric functions</span><a id="_idTextAnchor1079"/><span class="koboSpan" id="kobo.1119.1" xmlns:="http://www.w3.org/1999/xhtml">, such as sine and cosine, are periodic, with valu</span><a id="_idTextAnchor1080"/><span class="koboSpan" id="kobo.1120.1" xmlns:="http://www.w3.org/1999/xhtml">es cycling between -1 and 1 every 2π cycles, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1121.1" xmlns:="http://www.w3.org/1999/xhtml">s</span><a id="_idTextAnchor1081"/><span class="koboSpan" id="kobo.1122.1" xmlns:="http://www.w3.org/1999/xhtml">hown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.1123.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.11 – Sine and cosine functions" src="image/B22396_08_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1124.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.11 – Sine and cosine functions</span></p>
<p><span class="koboSpan" id="kobo.1125.1" xmlns:="http://www.w3.org/1999/xhtml">We can capture the periodicity of a cyclical variable by applying a trigonometric transformation after normalizing the variable values between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.1126.1" xmlns:="http://www.w3.org/1999/xhtml">and 2π:</span></span></p>
<p><span class="koboSpan" id="kobo.1127.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow&gt;&lt;mrow&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mfenced open=&quot;(&quot; close=&quot;)&quot;&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mfenced&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mrow&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mi&gt;π&lt;/mi&gt;&lt;mfrac&gt;&lt;mi&gt;X&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;X&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mfrac&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/math&gt;" src="image/37.png" style="vertical-align:-0.738em;height:1.983em;width:8.377em"/></span></p>
<p><span class="koboSpan" id="kobo.1128.1" xmlns:="http://www.w3.org/1999/xhtml">Dividing the variable’s values by its maximum will normalize it between 0 and 1 (assuming that the minimum value is 0), and multiplying it by 2π will rescale the variable between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.1129.1" xmlns:="http://www.w3.org/1999/xhtml">and 2π.</span></span></p>
<p><span class="koboSpan" id="kobo.1130.1" xmlns:="http://www.w3.org/1999/xhtml">Should we </span><a id="_idIndexMarker631"/><span class="koboSpan" id="kobo.1131.1" xmlns:="http://www.w3.org/1999/xhtml">use sine? </span><span class="koboSpan" id="kobo.1131.2" xmlns:="http://www.w3.org/1999/xhtml">Or should we use cosine? </span><span class="koboSpan" id="kobo.1131.3" xmlns:="http://www.w3.org/1999/xhtml">The thing is, we need to use both to encode all the values of the variables unequivocally. </span><span class="koboSpan" id="kobo.1131.4" xmlns:="http://www.w3.org/1999/xhtml">Since sine and cosine circle between 0 and 1, they will take a value of 0 for more than one value of </span><em class="italic"><span class="koboSpan" id="kobo.1132.1" xmlns:="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.1133.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1133.2" xmlns:="http://www.w3.org/1999/xhtml">For example, the sine of 0 returns 0, and so does the sine of π. </span><span class="koboSpan" id="kobo.1133.3" xmlns:="http://www.w3.org/1999/xhtml">So, if we encode a variable with just the sine, we wouldn’t be able to distinguish between the values 0 and π anymore. </span><span class="koboSpan" id="kobo.1133.4" xmlns:="http://www.w3.org/1999/xhtml">However, because the sine and the cosine are out of phase, the cosine of 0 returns 1, whereas the </span><a id="_idIndexMarker632"/><span class="koboSpan" id="kobo.1134.1" xmlns:="http://www.w3.org/1999/xhtml">cosine of π returns -1. </span><span class="koboSpan" id="kobo.1134.2" xmlns:="http://www.w3.org/1999/xhtml">Hence, by encoding the variable with the two functions, we are now able to distinguish between 0 and 1, which would take (0,1) and (0,-</span><a id="_idTextAnchor1082"/><a id="_idTextAnchor1083"/><span class="koboSpan" id="kobo.1135.1" xmlns:="http://www.w3.org/1999/xhtml">1) as values for the sine and cosine </span><span class="No-Break"><span class="koboSpan" id="kobo.1136.1" xmlns:="http://www.w3.org/1999/xhtml">functions, respectively.</span></span></p>
<h2 id="_idParaDest-242"><a id="_idTextAnchor1084"/><span class="koboSpan" id="kobo.1137.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.1138.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will first</span><a id="_idTextAnchor1085"/><span class="koboSpan" id="kobo.1139.1" xmlns:="http://www.w3.org/1999/xhtml"> transform the </span><a id="_idTextAnchor1086"/><strong class="source-inline"><span class="koboSpan" id="kobo.1140.1" xmlns:="http://www.w3.org/1999/xhtml">hour</span></strong><span class="koboSpan" id="kobo.1141.1" xmlns:="http://www.w3.org/1999/xhtml"> variable in a toy DataFrame with the sine and the cosine to get a sense of the new variable representation. </span><span class="koboSpan" id="kobo.1141.2" xmlns:="http://www.w3.org/1999/xhtml">Then, we will automate feature creation from multiple cyclical variables </span><span class="No-Break"><span class="koboSpan" id="kobo.1142.1" xmlns:="http://www.w3.org/1999/xhtml">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1143.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1144.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1145.1" xmlns:="http://www.w3.org/1999/xhtml">Begin by importing the </span><span class="No-Break"><span class="koboSpan" id="kobo.1146.1" xmlns:="http://www.w3.org/1999/xhtml">necessary libraries:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1147.1" xmlns:="http://www.w3.org/1999/xhtml">
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt</span></pre></li> <li><span class="koboSpan" id="kobo.1148.1" xmlns:="http://www.w3.org/1999/xhtml">Create a toy DataFrame with one variable – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1" xmlns:="http://www.w3.org/1999/xhtml">hour</span></strong><span class="koboSpan" id="kobo.1150.1" xmlns:="http://www.w3.org/1999/xhtml"> – with values between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.1151.1" xmlns:="http://www.w3.org/1999/xhtml">and 23:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1152.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.DataFrame([i for i in range(24)],
    columns=["hour"])</span></pre></li> <li><span class="koboSpan" id="kobo.1153.1" xmlns:="http://www.w3.org/1999/xhtml">Next, create two features using the sine and cosine transformations, after normalizing the variable values between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.1154.1" xmlns:="http://www.w3.org/1999/xhtml">and 2π:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1155.1" xmlns:="http://www.w3.org/1999/xhtml">
df["hour_sin"] = np.sin(
    df["hour"] / df["hour"].max() * 2 * np.pi)
df["hour_cos"] = np.cos(
    df["hour"] / df["hour"].max() * 2 * np.pi)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1156.1" xmlns:="http://www.w3.org/1999/xhtml">If we e</span><a id="_idTextAnchor1087"/><span class="koboSpan" id="kobo.1157.1" xmlns:="http://www.w3.org/1999/xhtml">xecute </span><strong class="source-inline"><span class="koboSpan" id="kobo.1158.1" xmlns:="http://www.w3.org/1999/xhtml">df.head()</span></strong><span class="koboSpan" id="kobo.1159.1" xmlns:="http://www.w3.org/1999/xhtml">, we will see the original and </span><span class="No-Break"><span class="koboSpan" id="kobo.1160.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.1161.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.12 – A DataFrame with the hour variable and the new features obtaine﻿d through the sine and cosine transformations" src="image/B22396_08_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1162.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.12 – A DataFrame with the hour variable and the new features obtaine</span><a id="_idTextAnchor1088"/><span class="koboSpan" id="kobo.1163.1" xmlns:="http://www.w3.org/1999/xhtml">d through the sine and cosine transformations</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1164.1" xmlns:="http://www.w3.org/1999/xhtml">Make</span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.1165.1" xmlns:="http://www.w3.org/1999/xhtml"> a scatter plot between the </span><a id="_idIndexMarker634"/><span class="koboSpan" id="kobo.1166.1" xmlns:="http://www.w3.org/1999/xhtml">hour and its </span><span class="No-Break"><span class="koboSpan" id="kobo.1167.1" xmlns:="http://www.w3.org/1999/xhtml">sine-transformed values:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1168.1" xmlns:="http://www.w3.org/1999/xhtml">
plt.scatter(df["hour"], df["hour_sin"])
plt.ylabel("Sine of hour")
plt.xlabel("Hour")
plt.title("Sine transformation")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1169.1" xmlns:="http://www.w3.org/1999/xhtml">In the following plot, we can see how the values of the hour circle between -1</span><a id="_idTextAnchor1089"/><span class="koboSpan" id="kobo.1170.1" xmlns:="http://www.w3.org/1999/xhtml"> and 1, just like the sine function after </span><span class="No-Break"><span class="koboSpan" id="kobo.1171.1" xmlns:="http://www.w3.org/1999/xhtml">the transformation:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.1172.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.13 – A sca﻿tter plot of th﻿e hour versus its sine transformed values" src="image/B22396_08_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1173.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.13 – A sca</span><a id="_idTextAnchor1090"/><span class="koboSpan" id="kobo.1174.1" xmlns:="http://www.w3.org/1999/xhtml">tter plot of th</span><a id="_idTextAnchor1091"/><span class="koboSpan" id="kobo.1175.1" xmlns:="http://www.w3.org/1999/xhtml">e hour versus its sine transformed values</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1176.1" xmlns:="http://www.w3.org/1999/xhtml">Now, make</span><a id="_idIndexMarker635"/><span class="koboSpan" id="kobo.1177.1" xmlns:="http://www.w3.org/1999/xhtml"> a scatter plot between </span><a id="_idIndexMarker636"/><span class="koboSpan" id="kobo.1178.1" xmlns:="http://www.w3.org/1999/xhtml">the hour and its </span><span class="No-Break"><span class="koboSpan" id="kobo.1179.1" xmlns:="http://www.w3.org/1999/xhtml">cosine transformation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1180.1" xmlns:="http://www.w3.org/1999/xhtml">
plt.scatter(df["hour"], df["hour_cos"])
plt.ylabel("Cosine of hour")
plt.xlabel("Hour")
plt.title("Cosine transformation")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1181.1" xmlns:="http://www.w3.org/1999/xhtml">In the following plot, we can see how the values of the hour circle between -1 </span><a id="_idTextAnchor1092"/><span class="koboSpan" id="kobo.1182.1" xmlns:="http://www.w3.org/1999/xhtml">and 1, just like the cosine function after </span><span class="No-Break"><span class="koboSpan" id="kobo.1183.1" xmlns:="http://www.w3.org/1999/xhtml">the transformation:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.1184.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.14 – A scatter plot of the hour versus its cosine-transformed values" src="image/B22396_08_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1185.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.14 – A scatter plot of the hour versus its cosine-transformed values</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1186.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, we</span><a id="_idIndexMarker637"/><span class="koboSpan" id="kobo.1187.1" xmlns:="http://www.w3.org/1999/xhtml"> can reconstitute the cyclical nature o</span><a id="_idTextAnchor1093"/><span class="koboSpan" id="kobo.1188.1" xmlns:="http://www.w3.org/1999/xhtml">f the hour,</span><a id="_idTextAnchor1094"/><span class="koboSpan" id="kobo.1189.1" xmlns:="http://www.w3.org/1999/xhtml"> which is now captured by the two </span><span class="No-Break"><span class="koboSpan" id="kobo.1190.1" xmlns:="http://www.w3.org/1999/xhtml">new features.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1191.1" xmlns:="http://www.w3.org/1999/xhtml">Plot the </span><a id="_idIndexMarker638"/><span class="koboSpan" id="kobo.1192.1" xmlns:="http://www.w3.org/1999/xhtml">values of the sine versus the cosine of the hour, and overlay the original values of the hour using a </span><span class="No-Break"><span class="koboSpan" id="kobo.1193.1" xmlns:="http://www.w3.org/1999/xhtml">color map:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1194.1" xmlns:="http://www.w3.org/1999/xhtml">
fig, ax = plt.subplots(figsize=(7, 5))
sp = ax.scatter(
    df["hour_sin"], df["hour_cos"], c=df["hour"])
ax.set(
    xlabel="s</span><a id="_idTextAnchor1095"/><span class="koboSpan" id="kobo.1195.1" xmlns:="http://www.w3.org/1999/xhtml">in(hour)",
    ylab</span><a id="_idTextAnchor1096"/><span class="koboSpan" id="kobo.1196.1" xmlns:="http://www.w3.org/1999/xhtml">el="cos(hour)",
)
_ = fig.colorbar(sp)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1197.1" xmlns:="http://www.w3.org/1999/xhtml">In the following plot, we can see how the two trigonometric transformations of the hour reflect</span><a id="_idIndexMarker639"/><span class="koboSpan" id="kobo.1198.1" xmlns:="http://www.w3.org/1999/xhtml"> the cy</span><a id="_idTextAnchor1097"/><span class="koboSpan" id="kobo.1199.1" xmlns:="http://www.w3.org/1999/xhtml">clical </span><a id="_idIndexMarker640"/><span class="koboSpan" id="kobo.1200.1" xmlns:="http://www.w3.org/1999/xhtml">nature of the hour, in a plot that reminds us of </span><span class="No-Break"><span class="koboSpan" id="kobo.1201.1" xmlns:="http://www.w3.org/1999/xhtml">a clock:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.1202.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.15 – A scatter plot of the trigonometric transformation of the hour" src="image/B22396_08_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1203.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.15 – A scatter plot of the trigonometric transformation of the hour</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1204.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1205.1" xmlns:="http://www.w3.org/1999/xhtml">The code implementation and idea for this plot were taken from scikit-learn’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1" xmlns:="http://www.w3.org/1999/xhtml">documentation: </span></span><a href="https://scikit-learn.org/stable/auto_examples/applications/plot_cyclical_feature_engineering.html#trigonometric-features"><span class="No-Break"><span class="koboSpan" id="kobo.1207.1" xmlns:="http://www.w3.org/1999/xhtml">https://scikit-learn.org/stable/auto_examples/applications/plot_cyclical_feature_engineering.html#trigonometric-features</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1208.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1209.1" xmlns:="http://www.w3.org/1999/xhtml">Now that we understand the n</span><a id="_idTextAnchor1098"/><span class="koboSpan" id="kobo.1210.1" xmlns:="http://www.w3.org/1999/xhtml">ature and effect of the transformation, let’s create new features using the sine and cosine transformations from multiple variables automatically. </span><span class="koboSpan" id="kobo.1210.2" xmlns:="http://www.w3.org/1999/xhtml">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1" xmlns:="http://www.w3.org/1999/xhtml">feature-engine</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1212.1" xmlns:="http://www.w3.org/1999/xhtml">library’s </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1213.1" xmlns:="http://www.w3.org/1999/xhtml">CyclicalFeatures()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1214.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="7"><span class="No-Break"><span class="koboSpan" id="kobo.1215.1" xmlns:="http://www.w3.org/1999/xhtml">Import </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1216.1" xmlns:="http://www.w3.org/1999/xhtml">CyclicalFeatures()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1217.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1218.1" xmlns:="http://www.w3.org/1999/xhtml">
from feature_engine.creation import CyclicalFeatures</span></pre></li> <li><span class="koboSpan" id="kobo.1219.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s create</span><a id="_idIndexMarker641"/><span class="koboSpan" id="kobo.1220.1" xmlns:="http://www.w3.org/1999/xhtml"> a toy DataFrame that contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1" xmlns:="http://www.w3.org/1999/xhtml">hour</span></strong><span class="koboSpan" id="kobo.1222.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1223.1" xmlns:="http://www.w3.org/1999/xhtml">month</span></strong><span class="koboSpan" id="kobo.1224.1" xmlns:="http://www.w3.org/1999/xhtml">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1225.1" xmlns:="http://www.w3.org/1999/xhtml">week</span></strong><span class="koboSpan" id="kobo.1226.1" xmlns:="http://www.w3.org/1999/xhtml"> variables, whose</span><a id="_idIndexMarker642"/><span class="koboSpan" id="kobo.1227.1" xmlns:="http://www.w3.org/1999/xhtml"> values vary between 0 and 23, 1 and 12, and 0 and </span><span class="No-Break"><span class="koboSpan" id="kobo.1228.1" xmlns:="http://www.w3.org/1999/xhtml">6, respectively:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1229.1" xmlns:="http://www.w3.org/1999/xhtml">
df = pd.DataFrame()
df["hour"] = pd.Series([i for i in range(24)])
df["month"] = pd.Series([i for i in range(1, 13)]*2)
df["week"] = pd.Series([i for i in range(7)]*4)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1230.1" xmlns:="http://www.w3.org/1999/xhtml">If we execut</span><a id="_idTextAnchor1099"/><span class="koboSpan" id="kobo.1231.1" xmlns:="http://www.w3.org/1999/xhtml">e </span><strong class="source-inline"><span class="koboSpan" id="kobo.1232.1" xmlns:="http://www.w3.org/1999/xhtml">df.head()</span></strong><span class="koboSpan" id="kobo.1233.1" xmlns:="http://www.w3.org/1999/xhtml">, we will see the first five rows of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1234.1" xmlns:="http://www.w3.org/1999/xhtml">toy DataFra</span><a id="_idTextAnchor1100"/><span class="koboSpan" id="kobo.1235.1" xmlns:="http://www.w3.org/1999/xhtml">me:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.1236.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.16 – The﻿ toy DataFrame with three cyclical features" src="image/B22396_08_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1237.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.16 – The</span><a id="_idTextAnchor1101"/><span class="koboSpan" id="kobo.1238.1" xmlns:="http://www.w3.org/1999/xhtml"> toy DataFrame with three cyclical features</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1239.1" xmlns:="http://www.w3.org/1999/xhtml">Set up the transformer to create the sine and cosine features from </span><span class="No-Break"><span class="koboSpan" id="kobo.1240.1" xmlns:="http://www.w3.org/1999/xhtml">these variables:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1241.1" xmlns:="http://www.w3.org/1999/xhtml">
cyclic = CyclicalFeatures(
    variables=None,
    drop_original=False,
)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1242.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1243.1" xmlns:="http://www.w3.org/1999/xhtml">By setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.1244.1" xmlns:="http://www.w3.org/1999/xhtml">variables</span></strong><span class="koboSpan" id="kobo.1245.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1" xmlns:="http://www.w3.org/1999/xhtml">None</span></strong><span class="koboSpan" id="kobo.1247.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1" xmlns:="http://www.w3.org/1999/xhtml">CyclicalFeatures()</span></strong><span class="koboSpan" id="kobo.1249.1" xmlns:="http://www.w3.org/1999/xhtml"> will create trigonometric features from all numerical variables. </span><span class="koboSpan" id="kobo.1249.2" xmlns:="http://www.w3.org/1999/xhtml">To create trigonometric features from a subset of variables, we can pass the variables’ names in a list to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1" xmlns:="http://www.w3.org/1999/xhtml">variables</span></strong><span class="koboSpan" id="kobo.1251.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter. </span><span class="koboSpan" id="kobo.1251.2" xmlns:="http://www.w3.org/1999/xhtml">We can retain or drop the original variables after creating the cyclical features using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1" xmlns:="http://www.w3.org/1999/xhtml">drop_original</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1253.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1254.1" xmlns:="http://www.w3.org/1999/xhtml">To finish, add the </span><a id="_idIndexMarker643"/><span class="koboSpan" id="kobo.1255.1" xmlns:="http://www.w3.org/1999/xhtml">features to the DataFrame and capture the result in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1256.1" xmlns:="http://www.w3.org/1999/xhtml">new variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1257.1" xmlns:="http://www.w3.org/1999/xhtml">
dft = cyclic.fit_transform(df)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1258.1" xmlns:="http://www.w3.org/1999/xhtml">If</span><a id="_idTextAnchor1102"/><span class="koboSpan" id="kobo.1259.1" xmlns:="http://www.w3.org/1999/xhtml"> we execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1" xmlns:="http://www.w3.org/1999/xhtml">dft.head()</span></strong><span class="koboSpan" id="kobo.1261.1" xmlns:="http://www.w3.org/1999/xhtml">, we will see the original and </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1" xmlns:="http://www.w3.org/1999/xhtml">new features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer156">
<span class="koboSpan" id="kobo.1263.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.17 – DataFrame with cyclical features plus the features created through the sine and cosine functions" src="image/B22396_08_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1264.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.17 – DataFrame with cyclical features plus the features created through the sine and cosine functions</span></p>
<p><span class="koboSpan" id="kobo.1265.1" xmlns:="http://www.w3.org/1999/xhtml">And that’s it – we’ve </span><a id="_idIndexMarker644"/><span class="koboSpan" id="kobo.1266.1" xmlns:="http://www.w3.org/1999/xhtml">created features by using the sine and cosine transformation automatically from mu</span><a id="_idTextAnchor1103"/><a id="_idTextAnchor1104"/><span class="koboSpan" id="kobo.1267.1" xmlns:="http://www.w3.org/1999/xhtml">ltiple variables and added them directly to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1" xmlns:="http://www.w3.org/1999/xhtml">original DataFrame.</span></span></p>
<h2 id="_idParaDest-243"><a id="_idTextAnchor1105"/><span class="koboSpan" id="kobo.1269.1" xmlns:="http://www.w3.org/1999/xhtml">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1270.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we enco</span><a id="_idTextAnchor1106"/><span class="koboSpan" id="kobo.1271.1" xmlns:="http://www.w3.org/1999/xhtml">ded cyclical features with</span><a id="_idTextAnchor1107"/><span class="koboSpan" id="kobo.1272.1" xmlns:="http://www.w3.org/1999/xhtml"> values obtained from the sine and cosine functions, applied to the normalized values of the variable. </span><span class="koboSpan" id="kobo.1272.2" xmlns:="http://www.w3.org/1999/xhtml">First, we normalized the variable values between 0 and 2 π. </span><span class="koboSpan" id="kobo.1272.3" xmlns:="http://www.w3.org/1999/xhtml">To do this, we divided the variable values by the variable maximum value, which we obtained with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1" xmlns:="http://www.w3.org/1999/xhtml">pandas.max()</span></strong><span class="koboSpan" id="kobo.1274.1" xmlns:="http://www.w3.org/1999/xhtml">, to scale the variables between 0 and 1. </span><span class="koboSpan" id="kobo.1274.2" xmlns:="http://www.w3.org/1999/xhtml">Then, we multiplied those values by 2π, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1" xmlns:="http://www.w3.org/1999/xhtml">numpy.pi</span></strong><span class="koboSpan" id="kobo.1276.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1276.2" xmlns:="http://www.w3.org/1999/xhtml">Finally, we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.1277.1" xmlns:="http://www.w3.org/1999/xhtml">np.sin</span></strong><span class="koboSpan" id="kobo.1278.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1279.1" xmlns:="http://www.w3.org/1999/xhtml">np.cos</span></strong><span class="koboSpan" id="kobo.1280.1" xmlns:="http://www.w3.org/1999/xhtml"> to apply the sine and cosine </span><span class="No-Break"><span class="koboSpan" id="kobo.1281.1" xmlns:="http://www.w3.org/1999/xhtml">transformations, respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.1282.1" xmlns:="http://www.w3.org/1999/xhtml">To automate this procedure for multiple variables, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1" xmlns:="http://www.w3.org/1999/xhtml">Feature-engine</span></strong><span class="koboSpan" id="kobo.1284.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1" xmlns:="http://www.w3.org/1999/xhtml">CyclicalFeatures()</span></strong><span class="koboSpan" id="kobo.1286.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1286.2" xmlns:="http://www.w3.org/1999/xhtml">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1287.1" xmlns:="http://www.w3.org/1999/xhtml">fit()</span></strong><span class="koboSpan" id="kobo.1288.1" xmlns:="http://www.w3.org/1999/xhtml">, the transformer learned the maximum values of each variable, and with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1289.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.1290.1" xmlns:="http://www.w3.org/1999/xhtml">, it added the features resulting from the sine </span><a id="_idIndexMarker645"/><span class="koboSpan" id="kobo.1291.1" xmlns:="http://www.w3.org/1999/xhtml">and cosine transformations to </span><span class="No-Break"><span class="koboSpan" id="kobo.1292.1" xmlns:="http://www.w3.org/1999/xhtml">the DataFrame.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1293.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1294.1" xmlns:="http://www.w3.org/1999/xhtml">In theory, to apply the sine and cosine transformation, we need to scale the original variable between 0 and 1. </span><span class="koboSpan" id="kobo.1294.2" xmlns:="http://www.w3.org/1999/xhtml">Dividing by the maximum of the variable will only result in this scaling if the minimum value is 0. </span><span class="koboSpan" id="kobo.1294.3" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn’s documentation and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1295.1" xmlns:="http://www.w3.org/1999/xhtml">Feature-engine</span></strong><span class="koboSpan" id="kobo.1296.1" xmlns:="http://www.w3.org/1999/xhtml">’s current implementation divide the variable by its maximum value (or an arbitrary period), without paying too much attention to whether the variable starts at 0. </span><span class="koboSpan" id="kobo.1296.2" xmlns:="http://www.w3.org/1999/xhtml">In practice, you won’t see a big difference in the resulting variables if you divide the hour feature by 23 or 24, or the month feature by 12 or 11. </span><span class="koboSpan" id="kobo.1296.3" xmlns:="http://www.w3.org/1999/xhtml">Discussions are underway on whether Feature-engine’s implementation should be updated, so the default behavior might change by the time t</span><a id="_idTextAnchor1108"/><a id="_idTextAnchor1109"/><a id="_idTextAnchor1110"/><a id="_idTextAnchor1111"/><span class="koboSpan" id="kobo.1297.1" xmlns:="http://www.w3.org/1999/xhtml">his book is published. </span><span class="koboSpan" id="kobo.1297.2" xmlns:="http://www.w3.org/1999/xhtml">Check out the documentation for </span><span class="No-Break"><span class="koboSpan" id="kobo.1298.1" xmlns:="http://www.w3.org/1999/xhtml">more details.</span></span></p>
<h1 id="_idParaDest-244"><a id="_idTextAnchor1112"/><span class="koboSpan" id="kobo.1299.1" xmlns:="http://www.w3.org/1999/xhtml">Creating spline features</span></h1>
<p><span class="koboSpan" id="kobo.1300.1" xmlns:="http://www.w3.org/1999/xhtml">Linear models</span><a id="_idIndexMarker646"/><span class="koboSpan" id="kobo.1301.1" xmlns:="http://www.w3.org/1999/xhtml"> expect a linear relationship between the predictor variables and the target. </span><span class="koboSpan" id="kobo.1301.2" xmlns:="http://www.w3.org/1999/xhtml">However, we can use linear models to model non-linear effects if we first transform the f</span><a id="_idTextAnchor1113"/><span class="koboSpan" id="kobo.1302.1" xmlns:="http://www.w3.org/1999/xhtml">eatures. </span><span class="koboSpan" id="kobo.1302.2" xmlns:="http://www.w3.org/1999/xhtml">In the </span><em class="italic"><span class="koboSpan" id="kobo.1303.1" xmlns:="http://www.w3.org/1999/xhtml">Performing polynomial expansion</span></em><span class="koboSpan" id="kobo.1304.1" xmlns:="http://www.w3.org/1999/xhtml"> recipe, we saw how we can unmask linear patterns by creating features with polynomial functions. </span><span class="koboSpan" id="kobo.1304.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we will discuss the use </span><span class="No-Break"><span class="koboSpan" id="kobo.1305.1" xmlns:="http://www.w3.org/1999/xhtml">of splines.</span></span></p>
<p><span class="koboSpan" id="kobo.1306.1" xmlns:="http://www.w3.org/1999/xhtml">Splines are used to mathematically reproduce flexible shapes. </span><span class="koboSpan" id="kobo.1306.2" xmlns:="http://www.w3.org/1999/xhtml">They consist of piecewise low-degree polynomial functions. </span><span class="koboSpan" id="kobo.1306.3" xmlns:="http://www.w3.org/1999/xhtml">To create splines, we must place knots at several values of </span><em class="italic"><span class="koboSpan" id="kobo.1307.1" xmlns:="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.1308.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1308.2" xmlns:="http://www.w3.org/1999/xhtml">These knots indicate where the pieces of the function join. </span><span class="koboSpan" id="kobo.1308.3" xmlns:="http://www.w3.org/1999/xhtml">Then, we fit low-degree polynomials to the data between two </span><span class="No-Break"><span class="koboSpan" id="kobo.1309.1" xmlns:="http://www.w3.org/1999/xhtml">consecutive knots.</span></span></p>
<p><span class="koboSpan" id="kobo.1310.1" xmlns:="http://www.w3.org/1999/xhtml">There are several types of splines, such as smoothing splines, regression splines, and B-splines. </span><span class="koboSpan" id="kobo.1310.2" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn supports the use of B-splines to create features. </span><span class="koboSpan" id="kobo.1310.3" xmlns:="http://www.w3.org/1999/xhtml">The procedure to fit and, therefore, return the spline values for a certain variable, based on a polynomial degree and the number of knots, exceeds the scope of this recipe. </span><span class="koboSpan" id="kobo.1310.4" xmlns:="http://www.w3.org/1999/xhtml">For more details, check out the resources in the </span><em class="italic"><span class="koboSpan" id="kobo.1311.1" xmlns:="http://www.w3.org/1999/xhtml">See also</span></em><span class="koboSpan" id="kobo.1312.1" xmlns:="http://www.w3.org/1999/xhtml"> section of this recipe. </span><span class="koboSpan" id="kobo.1312.2" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we’ll get a sense of what splines are</span><a id="_idTextAnchor1114"/><a id="_idTextAnchor1115"/><span class="koboSpan" id="kobo.1313.1" xmlns:="http://www.w3.org/1999/xhtml"> and how we can use them to improve the performance of </span><span class="No-Break"><span class="koboSpan" id="kobo.1314.1" xmlns:="http://www.w3.org/1999/xhtml">linear models.</span></span></p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor1116"/><span class="koboSpan" id="kobo.1315.1" xmlns:="http://www.w3.org/1999/xhtml">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.1316.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s get a sense of what splines are. </span><span class="koboSpan" id="kobo.1316.2" xmlns:="http://www.w3.org/1999/xhtml">In the following figure, on the left, we can see a spline with a degree of 1. </span><span class="koboSpan" id="kobo.1316.3" xmlns:="http://www.w3.org/1999/xhtml">It consists of two linear pieces – one from 2.5 to 5 and the other from 5 to 7.5. </span><span class="koboSpan" id="kobo.1316.4" xmlns:="http://www.w3.org/1999/xhtml">There are three knots – 2.5, 5, and 7.5. </span><span class="koboSpan" id="kobo.1316.5" xmlns:="http://www.w3.org/1999/xhtml">Outside the interval between 2.5 and 7.5, the spline takes a value of 0. </span><span class="koboSpan" id="kobo.1316.6" xmlns:="http://www.w3.org/1999/xhtml">The latter is characteristic of splines; they are only non-negative between certain values. </span><span class="koboSpan" id="kobo.1316.7" xmlns:="http://www.w3.org/1999/xhtml">On the right panel of the figure, we can see three</span><a id="_idIndexMarker647"/><span class="koboSpan" id="kobo.1317.1" xmlns:="http://www.w3.org/1999/xhtml"> splines of degree 1. </span><span class="koboSpan" id="kobo.1317.2" xmlns:="http://www.w3.org/1999/xhtml">W</span><a id="_idTextAnchor1117"/><span class="koboSpan" id="kobo.1318.1" xmlns:="http://www.w3.org/1999/xhtml">e can construct as many splines as we want by introducing </span><span class="No-Break"><span class="koboSpan" id="kobo.1319.1" xmlns:="http://www.w3.org/1999/xhtml">more knots:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<span class="koboSpan" id="kobo.1320.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.18 – The splines with a degree of 1" src="image/B22396_08_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1321.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.18 – The splines with a degree of 1</span></p>
<p><span class="koboSpan" id="kobo.1322.1" xmlns:="http://www.w3.org/1999/xhtml">In the following figure, on the left, we can see</span><a id="_idTextAnchor1118"/><span class="koboSpan" id="kobo.1323.1" xmlns:="http://www.w3.org/1999/xhtml"> a quadratic spline, also known as a spline with a degree of 2. </span><span class="koboSpan" id="kobo.1323.2" xmlns:="http://www.w3.org/1999/xhtml">It is based on four adjacent knots – 0, 2.5, 5, and 7.5. </span><span class="koboSpan" id="kobo.1323.3" xmlns:="http://www.w3.org/1999/xhtml">On the ri</span><a id="_idTextAnchor1119"/><span class="koboSpan" id="kobo.1324.1" xmlns:="http://www.w3.org/1999/xhtml">ght-hand side of the figure, we can see several splines of </span><span class="No-Break"><span class="koboSpan" id="kobo.1325.1" xmlns:="http://www.w3.org/1999/xhtml">degree 2:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<span class="koboSpan" id="kobo.1326.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.19 – The splines with a degree of 2" src="image/B22396_08_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1327.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.19 – The splines with a degree of 2</span></p>
<p><span class="koboSpan" id="kobo.1328.1" xmlns:="http://www.w3.org/1999/xhtml">We can use splines to model non-lin</span><a id="_idTextAnchor1120"/><a id="_idTextAnchor1121"/><span class="koboSpan" id="kobo.1329.1" xmlns:="http://www.w3.org/1999/xhtml">ear functions, and we will learn how to do this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1330.1" xmlns:="http://www.w3.org/1999/xhtml">next section.</span></span></p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor1122"/><span class="koboSpan" id="kobo.1331.1" xmlns:="http://www.w3.org/1999/xhtml">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.1332.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we</span><a id="_idIndexMarker648"/><span class="koboSpan" id="kobo.1333.1" xmlns:="http://www.w3.org/1999/xhtml"> will use splines to model the sine function. </span><span class="koboSpan" id="kobo.1333.2" xmlns:="http://www.w3.org/1999/xhtml">Once we get a sense of what splines are and how we can use them to fit non-linear relationships through a linear model, we will use splines for regression in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1" xmlns:="http://www.w3.org/1999/xhtml">real dataset:</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1335.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1336.1" xmlns:="http://www.w3.org/1999/xhtml">The idea to model the sine function with splines was taken from scikit-learn’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1" xmlns:="http://www.w3.org/1999/xhtml">documentation: </span></span><a href="https://scikit-learn.org/stable/auto_examples/linear_model/plot_polynomial_interpolation.html"><span class="No-Break"><span class="koboSpan" id="kobo.1338.1" xmlns:="http://www.w3.org/1999/xhtml">https://scikit-learn.org/stable/auto_</span><span id="_idTextAnchor1123"/><span class="koboSpan" id="kobo.1339.1" xmlns:="http://www.w3.org/1999/xhtml">examples/linear_model/plot_polynomial_interpolation.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1340.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1341.1" xmlns:="http://www.w3.org/1999/xhtml">Let’s begin by importing the necessary libraries </span><span class="No-Break"><span class="koboSpan" id="kobo.1342.1" xmlns:="http://www.w3.org/1999/xhtml">and classes:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1343.1" xmlns:="http://www.w3.org/1999/xhtml">
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.linear_model import Ridge
from sklearn.preprocessing import SplineTransformer</span></pre></li> <li><span class="koboSpan" id="kobo.1344.1" xmlns:="http://www.w3.org/1999/xhtml">Create a training set, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1345.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1346.1" xmlns:="http://www.w3.org/1999/xhtml">, with 20 values between -1 and 11, and the target variable, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1347.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong><span class="koboSpan" id="kobo.1348.1" xmlns:="http://www.w3.org/1999/xhtml">, which is the sine </span><span class="No-Break"><span class="koboSpan" id="kobo.1349.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1351.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1352.1" xmlns:="http://www.w3.org/1999/xhtml">
X = np.linspace(-1, 11, 20)
y = np.sin(X)</span></pre></li> <li><span class="koboSpan" id="kobo.1353.1" xmlns:="http://www.w3.org/1999/xhtml">Plot the relationship between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1354.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1355.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1356.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1357.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1358.1" xmlns:="http://www.w3.org/1999/xhtml">
plt.plot(X, y)
plt.ylabel("y")
plt.x</span><a id="_idTextAnchor1124"/><span class="koboSpan" id="kobo.1359.1" xmlns:="http://www.w3.org/1999/xhtml">label("X")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1360.1" xmlns:="http://www.w3.org/1999/xhtml">In the following plot, we can see the sine function </span><span class="No-Break"><span class="koboSpan" id="kobo.1361.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1362.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1363.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer159">
<span class="koboSpan" id="kobo.1364.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.20 – The relationship ﻿between the predictor and the target variable, where y = sine(x)" src="image/B22396_08_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1365.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.20 – The relationship </span><a id="_idTextAnchor1125"/><span class="koboSpan" id="kobo.1366.1" xmlns:="http://www.w3.org/1999/xhtml">between the predictor and the target variable, where y = sine(x)</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1367.1" xmlns:="http://www.w3.org/1999/xhtml">Fit a linear</span><a id="_idIndexMarker649"/><span class="koboSpan" id="kobo.1368.1" xmlns:="http://www.w3.org/1999/xhtml"> model to predict </span><strong class="source-inline"><span class="koboSpan" id="kobo.1369.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong><span class="koboSpan" id="kobo.1370.1" xmlns:="http://www.w3.org/1999/xhtml"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1371.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1372.1" xmlns:="http://www.w3.org/1999/xhtml"> by utilizing a Ridge regression, and then obtain the predictions of </span><span class="No-Break"><span class="koboSpan" id="kobo.1373.1" xmlns:="http://www.w3.org/1999/xhtml">the model:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1374.1" xmlns:="http://www.w3.org/1999/xhtml">
linmod = Ridge(random_state=10)
linmod.fit(X.reshape(-1, 1), y)
pred = linmod.predict(X.reshape(-1, 1))</span></pre></li> <li><span class="koboSpan" id="kobo.1375.1" xmlns:="http://www.w3.org/1999/xhtml">Now, plot the relationship between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1376.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1377.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1378.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong><span class="koboSpan" id="kobo.1379.1" xmlns:="http://www.w3.org/1999/xhtml">, and overlay </span><span class="No-Break"><span class="koboSpan" id="kobo.1380.1" xmlns:="http://www.w3.org/1999/xhtml">the predictions:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1381.1" xmlns:="http://www.w3.org/1999/xhtml">
plt.plot(X, y)
plt.plot(X, pred)
plt.ylabel("y")
plt.xlabel("X")
plt.legend(
    ["y", "linear"],
    bbox_to_anchor=(1, 1),
    loc="upper left")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1382.1" xmlns:="http://www.w3.org/1999/xhtml">In the following figure, we can see that the linear model m</span><a id="_idTextAnchor1126"/><span class="koboSpan" id="kobo.1383.1" xmlns:="http://www.w3.org/1999/xhtml">akes a very poor fit of the non-linear relationship between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1384.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1385.1" xmlns:="http://www.w3.org/1999/xhtml">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1386.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1387.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer160">
<span class="koboSpan" id="kobo.1388.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.21 – The linear fit between X and y" src="image/B22396_08_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1389.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.21 – The linear fit between X and y</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1390.1" xmlns:="http://www.w3.org/1999/xhtml">Now, set</span><a id="_idIndexMarker650"/> <a id="_idTextAnchor1127"/><span class="koboSpan" id="kobo.1391.1" xmlns:="http://www.w3.org/1999/xhtml">up </span><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1" xmlns:="http://www.w3.org/1999/xhtml">SplineTransformer()</span></strong><span class="koboSpan" id="kobo.1393.1" xmlns:="http://www.w3.org/1999/xhtml"> to obtain spline features from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1395.1" xmlns:="http://www.w3.org/1999/xhtml">, by utilizing third-degree polynomials and five knots at equidistant places within the values </span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1397.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1398.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1399.1" xmlns:="http://www.w3.org/1999/xhtml">
spl = SplineTransformer(degree=3, n_knots=5)</span></pre></li> <li><span class="koboSpan" id="kobo.1400.1" xmlns:="http://www.w3.org/1999/xhtml">Obtain the spline features and convert the NumPy array into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1401.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1402.1" xmlns:="http://www.w3.org/1999/xhtml"> DataFrame, adding the names of the spline </span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1" xmlns:="http://www.w3.org/1999/xhtml">basis functions:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1404.1" xmlns:="http://www.w3.org/1999/xhtml">
X_t = spl.fit_transform(X.reshape(-1, 1))
X_df = pd.DataFrame(
    X_t,
    columns=spl.get_feature_names_out(</span><a id="_idTextAnchor1128"/><span class="koboSpan" id="kobo.1405.1" xmlns:="http://www.w3.org/1999/xhtml">["var"])
)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1406.1" xmlns:="http://www.w3.org/1999/xhtml">By executing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1" xmlns:="http://www.w3.org/1999/xhtml">X_df.head()</span></strong><span class="koboSpan" id="kobo.1408.1" xmlns:="http://www.w3.org/1999/xhtml">, we can see the </span><span class="No-Break"><span class="koboSpan" id="kobo.1409.1" xmlns:="http://www.w3.org/1999/xhtml">spline features:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer161">
<span class="koboSpan" id="kobo.1410.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.22 – A DataFrame with the splines" src="image/B22396_08_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1411.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.22 – A DataFrame with the splines</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1412.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1" xmlns:="http://www.w3.org/1999/xhtml">SplineTransformer()</span></strong><span class="koboSpan" id="kobo.1414.1" xmlns:="http://www.w3.org/1999/xhtml"> returns a</span><a id="_idTextAnchor1129"/><span class="koboSpan" id="kobo.1415.1" xmlns:="http://www.w3.org/1999/xhtml"> feature matrix consisting of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1416.1" xmlns:="http://www.w3.org/1999/xhtml">n_splines = n_knots + degree – </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1417.1" xmlns:="http://www.w3.org/1999/xhtml">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1418.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1419.1" xmlns:="http://www.w3.org/1999/xhtml">Now, plot </span><a id="_idIndexMarker651"/><span class="koboSpan" id="kobo.1420.1" xmlns:="http://www.w3.org/1999/xhtml">the splines against the values </span><span class="No-Break"><span class="koboSpan" id="kobo.1421.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1422.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1423.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1424.1" xmlns:="http://www.w3.org/1999/xhtml">
plt.plot(X, X_t)
plt.legend(
    spl.get_feature_names_out(["var"]),
    bbox_to_anchor=(1, 1),
    loc="upper left")
plt.xlabel("X")
plt.ylabel("Splines values")
plt.title("Splines")
plt.show()</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1425.1" xmlns:="http://www.w3.org/1999/xhtml">In the following figure, we can see the relationship betwee</span><a id="_idTextAnchor1130"/><span class="koboSpan" id="kobo.1426.1" xmlns:="http://www.w3.org/1999/xhtml">n the different splines and the values of the predictor </span><span class="No-Break"><span class="koboSpan" id="kobo.1427.1" xmlns:="http://www.w3.org/1999/xhtml">variable, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1428.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1429.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer162">
<span class="koboSpan" id="kobo.1430.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.23 – Spli﻿nes plotted against the values of the predictor variable, X" src="image/B22396_08_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1431.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.23 – Spli</span><a id="_idTextAnchor1131"/><span class="koboSpan" id="kobo.1432.1" xmlns:="http://www.w3.org/1999/xhtml">nes plotted against the values of the predictor variable, X</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1433.1" xmlns:="http://www.w3.org/1999/xhtml">Now, fit a </span><a id="_idIndexMarker652"/><span class="koboSpan" id="kobo.1434.1" xmlns:="http://www.w3.org/1999/xhtml">linear model to predict </span><strong class="source-inline"><span class="koboSpan" id="kobo.1435.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong><span class="koboSpan" id="kobo.1436.1" xmlns:="http://www.w3.org/1999/xhtml"> from the spline features obtained from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1437.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1438.1" xmlns:="http://www.w3.org/1999/xhtml">, by utilizing a Ridge regression, and then obtain the predictions of </span><span class="No-Break"><span class="koboSpan" id="kobo.1439.1" xmlns:="http://www.w3.org/1999/xhtml">the model:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1440.1" xmlns:="http://www.w3.org/1999/xhtml">
linmod = Ridge(random_state=10)
linmod.fit(X_t, y)
pred = linmod.predict(X_t)</span></pre></li> <li><span class="koboSpan" id="kobo.1441.1" xmlns:="http://www.w3.org/1999/xhtml">Now, plot the relationship between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1442.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1443.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1444.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong><span class="koboSpan" id="kobo.1445.1" xmlns:="http://www.w3.org/1999/xhtml">, and overlay </span><span class="No-Break"><span class="koboSpan" id="kobo.1446.1" xmlns:="http://www.w3.org/1999/xhtml">the predictions:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1447.1" xmlns:="http://www.w3.org/1999/xhtml">
plt.plot(X, y)
plt.plot(X, pred)
plt.ylabel("y")
plt.xlabel("X")
plt.legend(
    ["y", </span><a id="_idTextAnchor1132"/><span class="koboSpan" id="kobo.1448.1" xmlns:="http://www.w3.org/1999/xhtml">"splines"],
    bbox_to_anchor=(1, 1),
    loc="upper left")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1449.1" xmlns:="http://www.w3.org/1999/xhtml">In the following figure, we can see that by utilizing spline featur</span><a id="_idTextAnchor1133"/><span class="koboSpan" id="kobo.1450.1" xmlns:="http://www.w3.org/1999/xhtml">es as input, the Ridge regression can better predict the shape </span><span class="No-Break"><span class="koboSpan" id="kobo.1451.1" xmlns:="http://www.w3.org/1999/xhtml">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1452.1" xmlns:="http://www.w3.org/1999/xhtml">y</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1453.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer163">
<span class="koboSpan" id="kobo.1454.1" xmlns:="http://www.w3.org/1999/xhtml"><img alt="Figure 8.24 – The predictions of a linear model, based on splines overlaid over the true relationship between X and y" src="image/B22396_08_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1455.1" xmlns:="http://www.w3.org/1999/xhtml">Figure 8.24 – The predictions of a linear model, based on splines overlaid over the true relationship between X and y</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1456.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1457.1" xmlns:="http://www.w3.org/1999/xhtml">Increasing the number of knots or the degree of the polynomial increases the flexibility of the spline curves. </span><span class="koboSpan" id="kobo.1457.2" xmlns:="http://www.w3.org/1999/xhtml">Try creating splines from higher polynomial degrees and see how the Ridge regression </span><span class="No-Break"><span class="koboSpan" id="kobo.1458.1" xmlns:="http://www.w3.org/1999/xhtml">predictions change.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1459.1" xmlns:="http://www.w3.org/1999/xhtml">Now that we </span><a id="_idIndexMarker653"/><span class="koboSpan" id="kobo.1460.1" xmlns:="http://www.w3.org/1999/xhtml">understand what the spline features are and how we can use them to predict non-linear effects, let’s try them out on a </span><span class="No-Break"><span class="koboSpan" id="kobo.1461.1" xmlns:="http://www.w3.org/1999/xhtml">real dataset.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1462.1" xmlns:="http://www.w3.org/1999/xhtml">Import some additional classes and functions </span><span class="No-Break"><span class="koboSpan" id="kobo.1463.1" xmlns:="http://www.w3.org/1999/xhtml">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1464.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1465.1" xmlns:="http://www.w3.org/1999/xhtml">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1466.1" xmlns:="http://www.w3.org/1999/xhtml">
from sklearn.datasets import fetch_california_housing
from sklearn.compose import Colu</span><a id="_idTextAnchor1134"/><span class="koboSpan" id="kobo.1467.1" xmlns:="http://www.w3.org/1999/xhtml">mnTransformer
from sklearn.model_selection import cross_validate</span></pre></li> <li><span class="koboSpan" id="kobo.1468.1" xmlns:="http://www.w3.org/1999/xhtml">Load the California housing dataset and drop two of the variables, which we won’t use </span><span class="No-Break"><span class="koboSpan" id="kobo.1469.1" xmlns:="http://www.w3.org/1999/xhtml">for modeling:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1470.1" xmlns:="http://www.w3.org/1999/xhtml">
X, y = fetch_california_housing(
    return_X_y=True, as_frame=True)
X.drop(["Latitude", "Longitude"], axis=1,
    inplace=True)</span></pre></li> <li><span class="koboSpan" id="kobo.1471.1" xmlns:="http://www.w3.org/1999/xhtml">First, we </span><a id="_idIndexMarker654"/><span class="koboSpan" id="kobo.1472.1" xmlns:="http://www.w3.org/1999/xhtml">wil</span><a id="_idTextAnchor1135"/><span class="koboSpan" id="kobo.1473.1" xmlns:="http://www.w3.org/1999/xhtml">l fit a Ridge regression to predict house prices based on the existing variables, by utilizing cross-validation, and then obtain the performance of the model to set up </span><span class="No-Break"><span class="koboSpan" id="kobo.1474.1" xmlns:="http://www.w3.org/1999/xhtml">the benchmark:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1475.1" xmlns:="http://www.w3.org/1999/xhtml">
linmod = Ridge(random_state=10)
cv = cross_validate(linmod, X, y)
mean_, std_ = np.mean(
    cv[«test_score"]), np.std(cv["test_score"])
print(f"Model score: {mean_} +- {std_}")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1476.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the model performance, where the values are </span><span class="No-Break"><span class="koboSpan" id="kobo.1477.1" xmlns:="http://www.w3.org/1999/xhtml">the </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1478.1" xmlns:="http://www.w3.org/1999/xhtml">R</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1479.1" xmlns:="http://www.w3.org/1999/xhtml">-squared:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1480.1" xmlns:="http://www.w3.org/1999/xhtml">Model score: 0.490618615960575 +- 0.03617289854929812</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1481.1" xmlns:="http://www.w3.org/1999/xhtml">Now, set up </span><strong class="source-inline"><span class="koboSpan" id="kobo.1482.1" xmlns:="http://www.w3.org/1999/xhtml">SplineTransformer()</span></strong><span class="koboSpan" id="kobo.1483.1" xmlns:="http://www.w3.org/1999/xhtml"> to obtain spline features from four variables by utilizing third-degree polynomials and 50 knots, and then fit the pipeline to </span><span class="No-Break"><span class="koboSpan" id="kobo.1484.1" xmlns:="http://www.w3.org/1999/xhtml">the data:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1485.1" xmlns:="http://www.w3.org/1999/xhtml">
spl = SplineTransformer(degree=3, n_knots=50)
ct = ColumnTransformer(
    [("splines", spl, [
        "AveRooms", "AveBedrms", "Population",
        "AveOccup"]
    )],
    remainder="passthrough",
)
ct.fit(X, y)</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1486.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1487.1" xmlns:="http://www.w3.org/1999/xhtml">Remember that we need to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1488.1" xmlns:="http://www.w3.org/1999/xhtml">ColumnTransformer()</span></strong><span class="koboSpan" id="kobo.1489.1" xmlns:="http://www.w3.org/1999/xhtml"> to obtain features from a subset of variables in the data. </span><span class="koboSpan" id="kobo.1489.2" xmlns:="http://www.w3.org/1999/xhtml">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1490.1" xmlns:="http://www.w3.org/1999/xhtml">remainder=passthrough</span></strong><span class="koboSpan" id="kobo.1491.1" xmlns:="http://www.w3.org/1999/xhtml">, we ensure that the variables that are not used as templates for the splines – that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1492.1" xmlns:="http://www.w3.org/1999/xhtml">MedInc</span></strong><span class="koboSpan" id="kobo.1493.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1494.1" xmlns:="http://www.w3.org/1999/xhtml">HouseAge</span></strong><span class="koboSpan" id="kobo.1495.1" xmlns:="http://www.w3.org/1999/xhtml"> – are also returned in the resulting DataFrame. </span><span class="koboSpan" id="kobo.1495.2" xmlns:="http://www.w3.org/1999/xhtml">To check out the features resulting from this step, </span><span class="No-Break"><span class="koboSpan" id="kobo.1496.1" xmlns:="http://www.w3.org/1999/xhtml">execute </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1" xmlns:="http://www.w3.org/1999/xhtml">ct.get_feature_names_out()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1498.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.1499.1" xmlns:="http://www.w3.org/1999/xhtml">Now, fit a Ridge </span><a id="_idIndexMarker655"/><span class="koboSpan" id="kobo.1500.1" xmlns:="http://www.w3.org/1999/xhtml">regression to predict house prices based on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1501.1" xmlns:="http://www.w3.org/1999/xhtml">MedInc</span></strong><span class="koboSpan" id="kobo.1502.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1" xmlns:="http://www.w3.org/1999/xhtml">HouseAge</span></strong><span class="koboSpan" id="kobo.1504.1" xmlns:="http://www.w3.org/1999/xhtml">, and the spline features, using cross-validation, and then obtain the performance of </span><span class="No-Break"><span class="koboSpan" id="kobo.1505.1" xmlns:="http://www.w3.org/1999/xhtml">the model:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1506.1" xmlns:="http://www.w3.org/1999/xhtml">
cv = cross_validate(linmod, ct.transform(X), y)
mean_, std_ = np.mean(
    cv[«test_score"]), np.std(cv["test_score"])
print(f"Model score: {mean_} +- {std_}")</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1507.1" xmlns:="http://www.w3.org/1999/xhtml">In the following output, we can see the model performance, where the values are </span><span class="No-Break"><span class="koboSpan" id="kobo.1508.1" xmlns:="http://www.w3.org/1999/xhtml">the </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1509.1" xmlns:="http://www.w3.org/1999/xhtml">R</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1510.1" xmlns:="http://www.w3.org/1999/xhtml">-squared:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1511.1" xmlns:="http://www.w3.org/1999/xhtml">Model score: 0.5553526813919297 +- 0.02244513992785257</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1512.1" xmlns:="http://www.w3.org/1999/xhtml">As we can see, by using splines in place of some of the original va</span><a id="_idTextAnchor1136"/><a id="_idTextAnchor1137"/><span class="koboSpan" id="kobo.1513.1" xmlns:="http://www.w3.org/1999/xhtml">riables, we can improve the performance of the linear </span><span class="No-Break"><span class="koboSpan" id="kobo.1514.1" xmlns:="http://www.w3.org/1999/xhtml">regression model.</span></span></p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor1138"/><span class="koboSpan" id="kobo.1515.1" xmlns:="http://www.w3.org/1999/xhtml">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1516.1" xmlns:="http://www.w3.org/1999/xhtml">In this recipe, we created new features based on splines. </span><span class="koboSpan" id="kobo.1516.2" xmlns:="http://www.w3.org/1999/xhtml">First, we used a toy variable, with values from -1 to 11, and then we obtained splines from a real dataset. </span><span class="koboSpan" id="kobo.1516.3" xmlns:="http://www.w3.org/1999/xhtml">The procedure in both cases was identical – we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.1517.1" xmlns:="http://www.w3.org/1999/xhtml">SplineTransformer()</span></strong><span class="koboSpan" id="kobo.1518.1" xmlns:="http://www.w3.org/1999/xhtml"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1519.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.1520.1" xmlns:="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1520.2" xmlns:="http://www.w3.org/1999/xhtml">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1521.1" xmlns:="http://www.w3.org/1999/xhtml">SplineTransformer()</span></strong><span class="koboSpan" id="kobo.1522.1" xmlns:="http://www.w3.org/1999/xhtml"> transformer takes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1523.1" xmlns:="http://www.w3.org/1999/xhtml">degree</span></strong><span class="koboSpan" id="kobo.1524.1" xmlns:="http://www.w3.org/1999/xhtml"> property of the polynomial and the number of knots (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1525.1" xmlns:="http://www.w3.org/1999/xhtml">n_knots</span></strong><span class="koboSpan" id="kobo.1526.1" xmlns:="http://www.w3.org/1999/xhtml">) as input and returns the splines that better fit the data. </span><span class="koboSpan" id="kobo.1526.2" xmlns:="http://www.w3.org/1999/xhtml">The knots are placed at equidistant values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1527.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1528.1" xmlns:="http://www.w3.org/1999/xhtml"> by default, but through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1529.1" xmlns:="http://www.w3.org/1999/xhtml">knots</span></strong><span class="koboSpan" id="kobo.1530.1" xmlns:="http://www.w3.org/1999/xhtml"> parameter, we can choose to uniformly distribute them to the quantiles of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1531.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1532.1" xmlns:="http://www.w3.org/1999/xhtml"> instead, or we can pass an array with the specific values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1533.1" xmlns:="http://www.w3.org/1999/xhtml">X</span></strong><span class="koboSpan" id="kobo.1534.1" xmlns:="http://www.w3.org/1999/xhtml"> that should be used </span><span class="No-Break"><span class="koboSpan" id="kobo.1535.1" xmlns:="http://www.w3.org/1999/xhtml">as knots.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1536.1" xmlns:="http://www.w3.org/1999/xhtml">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1537.1" xmlns:="http://www.w3.org/1999/xhtml">The number, spacing, and position of the knots are arbitrarily set by the user and are the parameters that influence the shape of the splines the most. </span><span class="koboSpan" id="kobo.1537.2" xmlns:="http://www.w3.org/1999/xhtml">When using splines in regression models, we can optimize these parameters in a randomized search </span><span class="No-Break"><span class="koboSpan" id="kobo.1538.1" xmlns:="http://www.w3.org/1999/xhtml">with cross-validation.</span></span></p>
<p><span class="koboSpan" id="kobo.1539.1" xmlns:="http://www.w3.org/1999/xhtml">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1540.1" xmlns:="http://www.w3.org/1999/xhtml">fit()</span></strong><span class="koboSpan" id="kobo.1541.1" xmlns:="http://www.w3.org/1999/xhtml">, the </span><a id="_idIndexMarker656"/><span class="koboSpan" id="kobo.1542.1" xmlns:="http://www.w3.org/1999/xhtml">transformer computes the knots of the splines. </span><span class="koboSpan" id="kobo.1542.2" xmlns:="http://www.w3.org/1999/xhtml">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1543.1" xmlns:="http://www.w3.org/1999/xhtml">transform()</span></strong><span class="koboSpan" id="kobo.1544.1" xmlns:="http://www.w3.org/1999/xhtml">, it returns the array of B-splines. </span><span class="koboSpan" id="kobo.1544.2" xmlns:="http://www.w3.org/1999/xhtml">The transformer returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.1545.1" xmlns:="http://www.w3.org/1999/xhtml">n_splines=n_knots + degree – </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1" xmlns:="http://www.w3.org/1999/xhtml">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1547.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></p>
<p><span class="koboSpan" id="kobo.1548.1" xmlns:="http://www.w3.org/1999/xhtml">Remember that, like most scikit-learn transformers, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1" xmlns:="http://www.w3.org/1999/xhtml">SplineTransformer()</span></strong><span class="koboSpan" id="kobo.1550.1" xmlns:="http://www.w3.org/1999/xhtml"> also now has the option to return </span><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1" xmlns:="http://www.w3.org/1999/xhtml">pandas</span></strong><span class="koboSpan" id="kobo.1552.1" xmlns:="http://www.w3.org/1999/xhtml"> and polars DataFrames in addition to NumPy arrays, a behavior that can be modified through the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1553.1" xmlns:="http://www.w3.org/1999/xhtml">set_output()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1554.1" xmlns:="http://www.w3.org/1999/xhtml"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.1555.1" xmlns:="http://www.w3.org/1999/xhtml">Finally, we used </span><strong class="source-inline"><span class="koboSpan" id="kobo.1556.1" xmlns:="http://www.w3.org/1999/xhtml">ColumnTransformer()</span></strong><span class="koboSpan" id="kobo.1557.1" xmlns:="http://www.w3.org/1999/xhtml"> to derive splines from a subset of features. </span><span class="koboSpan" id="kobo.1557.2" xmlns:="http://www.w3.org/1999/xhtml">Because we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1558.1" xmlns:="http://www.w3.org/1999/xhtml">remainder</span></strong><span class="koboSpan" id="kobo.1559.1" xmlns:="http://www.w3.org/1999/xhtml"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1560.1" xmlns:="http://www.w3.org/1999/xhtml">passthrough</span></strong><span class="koboSpan" id="kobo.1561.1" xmlns:="http://www.w3.org/1999/xhtml">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1562.1" xmlns:="http://www.w3.org/1999/xhtml">ColumnTransformer</span><a id="_idTextAnchor1139"/><span class="koboSpan" id="kobo.1563.1" xmlns:="http://www.w3.org/1999/xhtml">() </span></strong><span class="koboSpan" id="kobo.1564.1" xmlns:="http://www.w3.org/1999/xhtml">concatenated the features that were not used to obtain splines to the resulting matrix of splines. </span><span class="koboSpan" id="kobo.1564.2" xmlns:="http://www.w3.org/1999/xhtml">By doing this, we fitted a Ridge regression with the splines, plus the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1" xmlns:="http://www.w3.org/1999/xhtml">MedInc</span></strong><span class="koboSpan" id="kobo.1566.1" xmlns:="http://www.w3.org/1999/xhtml"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1567.1" xmlns:="http://www.w3.org/1999/xhtml">Ho</span><a id="_idTextAnchor1140"/><a id="_idTextAnchor1141"/><span class="koboSpan" id="kobo.1568.1" xmlns:="http://www.w3.org/1999/xhtml">useAge</span></strong><span class="koboSpan" id="kobo.1569.1" xmlns:="http://www.w3.org/1999/xhtml"> variables, and managed to improve the linear </span><span class="No-Break"><span class="koboSpan" id="kobo.1570.1" xmlns:="http://www.w3.org/1999/xhtml">model’s performance.</span></span></p>
<h2 id="_idParaDest-248"><a id="_idTextAnchor1142"/><span class="koboSpan" id="kobo.1571.1" xmlns:="http://www.w3.org/1999/xhtml">See also</span></h2>
<p><span class="koboSpan" id="kobo.1572.1" xmlns:="http://www.w3.org/1999/xhtml">To find out more about the math underlying B-splines, check out the </span><span class="No-Break"><span class="koboSpan" id="kobo.1573.1" xmlns:="http://www.w3.org/1999/xhtml">following articles:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1574.1" xmlns:="http://www.w3.org/1999/xhtml">Perperoglou, et al. </span><em class="italic"><span class="koboSpan" id="kobo.1575.1" xmlns:="http://www.w3.org/1999/xhtml">A review of spline function procedures in R</span></em><span class="koboSpan" id="kobo.1576.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span><a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-019-0666-3"><span class="koboSpan" id="kobo.1577.1" xmlns:="http://www.w3.org/1999/xhtml">https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-019-0666-3</span></a><span class="koboSpan" id="kobo.1578.1" xmlns:="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.1578.2" xmlns:="http://www.w3.org/1999/xhtml">BMC Med Res Methodol 19, </span><span class="No-Break"><span class="koboSpan" id="kobo.1579.1" xmlns:="http://www.w3.org/1999/xhtml">46 (2019).</span></span></li>
<li><span class="koboSpan" id="kobo.1580.1" xmlns:="http://www.w3.org/1999/xhtml">Eilers and Marx. </span><em class="italic"><span class="koboSpan" id="kobo.1581.1" xmlns:="http://www.w3.org/1999/xhtml">Flexible Smoothing with B-splines and </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1582.1" xmlns:="http://www.w3.org/1999/xhtml">Penalties</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1" xmlns:="http://www.w3.org/1999/xhtml"> (</span></span><a href="https://projecteuclid.org/journals/statistical-science/volume-11/issue-2/Flexible-smoothing-with-B-splines-and-penalties/10.1214/ss/1038425655.full"><span class="No-Break"><span class="koboSpan" id="kobo.1584.1" xmlns:="http://www.w3.org/1999/xhtml">https://projecteuclid.org/journals/statistical-science/volume-11/issue-2/Flexible-smoothing-with-B-splines-and-penalties/10.1214/ss/1038425655.full</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1585.1" xmlns:="http://www.w3.org/1999/xhtml">).</span></span></li>
<li><span class="koboSpan" id="kobo.1586.1" xmlns:="http://www.w3.org/1999/xhtml">For an example of how to use B-splines to model time series data, check out the following page in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1587.1" xmlns:="http://www.w3.org/1999/xhtml">scikit-learn</span></strong><span class="koboSpan" id="kobo.1588.1" xmlns:="http://www.w3.org/1999/xhtml"> library’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1589.1" xmlns:="http://www.w3.org/1999/xhtml">documentation: </span></span><a href="https://scikit-learn.org/stable/auto_examples/applications/plot_cyclical_feature_engineering.html#periodic-spline-features"><span class="No-Break"><span class="koboSpan" id="kobo.1590.1" xmlns:="http://www.w3.org/1999/xhtml">https://scikit-learn.org/stable/auto_examples/applications/plot_cyclical_feature_engineering.html#periodic-spline-features</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1591.1" xmlns:="http://www.w3.org/1999/xhtml">.</span></span></li>
</ul>
</div>
</body></html>