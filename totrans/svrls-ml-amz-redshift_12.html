<html><head></head><body>
		<div id="_idContainer208">
			<h1 id="_idParaDest-161" class="chapter-number"><a id="_idTextAnchor217"/>12</h1>
			<h1 id="_idParaDest-162"><a id="_idTextAnchor218"/>Time-Series Forecasting in Your Data Warehouse</h1>
			<p>In previous chapters, we discussed how you can use Amazon Redshift <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>) to easily create, train, and apply ML models using familiar SQL commands. We talked about how we can use supervised learning algorithms for classification or regression problems to predict a certain outcome. In this chapter, we will talk about how you can use your data in Amazon Redshift to forecast a certain future event using <span class="No-Break">Amazon Forecast.</span></p>
			<p>This chapter will introduce you to time-series forecasting on Amazon Redshift using Amazon Forecast (<a href="https://aws.amazon.com/forecast/">https://aws.amazon.com/forecast/</a>), a fully managed time-series forecasting service, using SQL, and without moving your data or learning new skills. We will guide you through the <span class="No-Break">following topics:</span></p>
			<ul>
				<li>Forecasting and <span class="No-Break">time-series data</span></li>
				<li>What is <span class="No-Break">Amazon Forecast?</span></li>
				<li>Configuration <span class="No-Break">and security</span></li>
				<li>Creating forecasting models using <span class="No-Break">Redshift ML</span></li>
			</ul>
			<h1 id="_idParaDest-163"><a id="_idTextAnchor219"/>Technical requirements</h1>
			<p>This chapter requires a web browser and access to <span class="No-Break">the following:</span></p>
			<ul>
				<li>An <span class="No-Break">AWS account</span></li>
				<li><span class="No-Break">Amazon Redshift</span></li>
				<li>Amazon Redshift query <span class="No-Break">editor v2</span></li>
			</ul>
			<p>You can find the code used in this chapter <span class="No-Break">here: </span><a href="https://github.com/PacktPublishing/Serverless-Machine-Learning-with-Amazon-Redshift/blob/main/CodeFiles/chapter12/chapter-12.sql"><span class="No-Break">https://github.com/PacktPublishing/Serverless-Machine-Learning-with-Amazon-Redshift/blob/main/CodeFiles/chapter12/chapter-12.sql</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-164"><a id="_idTextAnchor220"/>Forecasting and time-series data</h1>
			<p>Forecasting<a id="_idIndexMarker548"/> is a way of estimating future events, which involves analyzing historical data and past patterns to derive a possible outcome in the future. For example, based on historical data, a business can predict their sales revenue or identify what will happen in the next <span class="No-Break">time period.</span></p>
			<p>Forecasting plays a valuable role in guiding businesses to make informed decisions about their operations and priorities. Many organizations rely on data warehouses such as Amazon Redshift to perform deep analytics on vast amounts of historical and current data, enabling them to drive their business goals and gauge future success. Acting as a planning tool, forecasting helps enterprises prepare for future uncertainties by leveraging past patterns, with the underlying principle that what happened in the past will likely recur in the future. These predictions are based on analyzing observations over time within the <span class="No-Break">given timeframe.</span></p>
			<p>Here are some <a id="_idIndexMarker549"/>examples of how organizations <span class="No-Break">use forecasting:</span></p>
			<ul>
				<li><span class="No-Break">Financial planning</span></li>
				<li>Supply and <span class="No-Break">demand planning</span></li>
				<li>Timing the launch of new products <span class="No-Break">or services</span></li>
				<li><span class="No-Break">Resource planning</span></li>
				<li>Predicting future events, such as sales and <span class="No-Break">revenue earnings</span></li>
				<li>Reviewing <span class="No-Break">management decisions</span></li>
			</ul>
			<p>Looking at a trend graph helps us predict the trend, but a<a id="_idIndexMarker550"/> time-series forecast gives us a better estimate of how it may continue. We can also model data that doesn’t show any clear pattern or trend over time. When there is a pattern, we can look at the entire history of the data to see how it happened before. If there is no pattern, we can rely more on recent data <span class="No-Break">for forecasting.</span></p>
			<h2 id="_idParaDest-165"><a id="_idTextAnchor221"/>Types of forecasting methods</h2>
			<p>There are two types of forecasting methods: qualitative <span class="No-Break">and quantitative.</span></p>
			<p>Let’s take a look at what qualitative and quantitative methods are, as defined <span class="No-Break">at </span><a href="https://aws.amazon.com/what-is/forecast/"><span class="No-Break">https://aws.amazon.com/what-is/forecast/</span></a><span class="No-Break">:</span></p>
			<ul>
				<li><strong class="bold">Qualitative forecasting</strong> is subjective and relies on marketing experts’ opinions to make<a id="_idIndexMarker551"/> predictions. You can use these methods when there is not enough historical data. Some examples of qualitative<a id="_idIndexMarker552"/> forecasting methods are market research such as polls and surveys, and the Delphi method to collect informed opinions and <span class="No-Break">predict trends.</span></li>
				<li><strong class="bold">Quantitative forecasting</strong> is <a id="_idIndexMarker553"/>objective in nature and is used to predict long-term future trends. It uses historical and current<a id="_idIndexMarker554"/> data to forecast future trends. Some examples of quantitative forecasting methods are <em class="italic">time-series forecasting</em>, <em class="italic">econometric modeling</em>, and the <span class="No-Break"><em class="italic">indicator approach</em></span><span class="No-Break">.</span></li>
			</ul>
			<p>In this chapter, we will focus on quantitative forecasting using time series for data, also known as time-series forecasting. Now, let’s look into what time-series <span class="No-Break">forecasting is.</span></p>
			<h2 id="_idParaDest-166"><a id="_idTextAnchor222"/>What is time-series forecasting?</h2>
			<p><strong class="bold">Time-series forecasting</strong> is a data<a id="_idIndexMarker555"/> science technique that uses ML to study historical <a id="_idIndexMarker556"/>data and predict future trends or behavior in time-series data. Time-series data is used in many situations, such as weather forecasting, financial studies, statistics, resource planning, and econometrics. In the previous chapter, we looked into regression models to predict values using cross-sectional data, where your input variables are used to determine the relationship between the variables so that you can predict the unknown target on sets of data without the <span class="No-Break">target variables.</span></p>
			<p>This data is unique because it arranges data points by time. Time-series data can be plotted on a graph and these graphs are valuable tools for visualizing and analyzing the data. In many organizations, data scientists or data analysts use these graphs to identify forecasting data features or attributes. Let us look into some examples of time-series <span class="No-Break">data characteristics.</span></p>
			<h2 id="_idParaDest-167"><a id="_idTextAnchor223"/>Time trending data</h2>
			<p>In trending data, the <a id="_idIndexMarker557"/>observations are captured at equal time intervals. In time-series graphs, the <em class="italic">y</em> axis is always a unit of time, such as quarter, year, month, day, hour, minute, or second. In <span class="No-Break"><em class="italic">Figure 12</em></span><em class="italic">.1</em>, we have an example of the trend of total <a id="_idIndexMarker558"/>subscribers <span class="No-Break">by year:</span></p>
			<div>
				<div id="_idContainer196" class="IMG---Figure">
					<img src="image/B19071_12_01.jpg" alt="Figure 12.1 – Trend of total subscribers per year"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.1 – Trend of total subscribers per year</p>
			<h2 id="_idParaDest-168"><a id="_idTextAnchor224"/>Seasonality</h2>
			<p>In seasonality<a id="_idIndexMarker559"/> observations, we can see periodic fluctuations over time, and these fluctuations are predictable because we understand the behavior and the cause based on historical patterns. For example, retailers know that sales will increase during certain holiday periods. In <span class="No-Break"><em class="italic">Figure 12</em></span><em class="italic">.2</em>, we see an upward spike in sales for November and December, which is expected because of the <span class="No-Break">holiday season:</span></p>
			<div>
				<div id="_idContainer197" class="IMG---Figure">
					<img src="image/B19071_12_02.jpg" alt="Figure 12.2 – Upward spike due to holiday season"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.2 – Upward spike due to holiday season</p>
			<h2 id="_idParaDest-169"><a id="_idTextAnchor225"/>Structural breaks</h2>
			<p>In structural breaks, we have<a id="_idIndexMarker560"/> fluctuations that are less predictable and can occur at any point in time. For example, during a recession or geo-political disturbances, the economic situation of a country might show structural breaks. In <span class="No-Break"><em class="italic">Figure 12</em></span><em class="italic">.3</em>, we can see a visualization of economic growth over time. The dips indicate an event that occurred at certain data points; for example, the one in 2009 correlates to the mortgage crisis in <span class="No-Break">the US.</span></p>
			<div>
				<div id="_idContainer198" class="IMG---Figure">
					<img src="image/B19071_12_03.jpg" alt="Figure 12.3 – Economic growth over time"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.3 – Economic growth over time</p>
			<p>Let’s take a look into how Amazon Redshift ML uses Amazon Forecast to generate models using <span class="No-Break">time-series datasets.</span></p>
			<h1 id="_idParaDest-170"><a id="_idTextAnchor226"/>What is Amazon Forecast?</h1>
			<p><strong class="bold">Amazon Forecast</strong>, like<a id="_idIndexMarker561"/> Amazon Redshift ML, requires no ML experience to use. Time-series forecasts are generated using various ML and statistical algorithms based on historical data. As a user, you simply send data to Amazon Forecast and it will examine the data and automatically identify what is meaningful and produces a <span class="No-Break">forecasting model.</span></p>
			<p>With Amazon Redshift ML, you can leverage Amazon Forecast to create and train forecasting models from your time-series data and use these models to generate forecasts. For forecasting, we require a target time-series dataset. In target time-series forecasting, we predict the future value of a variable using the past data or previous values, which is often called univariate time series because the data is sequential over equal time increments. Currently, Redshift ML supports target time-series datasets with a custom domain. The dataset in your data warehouse must contain the frequency or interval at which you capture your data. For example, you might record and aggregate the average temperature <span class="No-Break">every hour.</span></p>
			<p>Amazon Forecast <a id="_idIndexMarker562"/>automatically trains your model based on an algorithm using Auto ML and provides six built-in algorithms (to learn more about the built-in algorithms, please check out this resource: <a href="https://docs.aws.amazon.com/forecast/latest/dg/aws-forecast-choosing-recipes.html#forecast-algos">https://docs.aws.amazon.com/forecast/latest/dg/aws-forecast-choosing-recipes.html#forecast-algos</a>). These forecasting models, known as predictors, are created using an optimal combination of these algorithms from your time-series data in <span class="No-Break">Amazon Redshift.</span></p>
			<h1 id="_idParaDest-171"><a id="_idTextAnchor227"/>Configuration and security</h1>
			<p>As Amazon Forecast<a id="_idIndexMarker563"/> is a separate fully managed service, you will need to create or modify your IAM role to include access permissions for your serverless endpoint or Redshift cluster. Additionally, you should configure a trust relationship for Amazon Forecast (<a href="http://forecast.amazonaws.com">forecast.amazonaws.com</a>) in the IAM role to enable the <span class="No-Break">necessary permissions.</span></p>
			<p>You can use the <strong class="bold">AmazonForecastFullAccess</strong> managed policy, which grants full access to Amazon Forecast and all of the<a id="_idIndexMarker564"/> supported operations. You can attach this policy to your default role but, in your production environments, you must follow the principle of least-privilege permissions. You may use more restrictive permissions, such as <span class="No-Break">the following:</span></p>
			<pre class="source-code">
 {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "forecast:DescribeDataset",
                "forecast:DescribeDatasetGroup",
                "forecast:DescribeAutoPredictor",
                "forecast:CreateDatasetImportJob",
                "forecast:CreateForecast",
                "forecast:DescribeForecast",
                "forecast:DescribeForecastExportJob",
                "forecast:CreateMonitor",
                "forecast:CreateForecastExportJob",
                "forecast:CreateAutoPredictor",
                "forecast:DescribeDatasetImportJob",
                "forecast:CreateDatasetGroup",
                "forecast:CreateDataset",
                "forecast:TagResource",
                "forecast:UpdateDatasetGroup"
            ],
            "Resource": "*"
        } ,
    {
      "Effect": "Allow",
      "Action": [
        "iam:PassRole"
      ],
      "Resource":"arn:aws:iam::&lt;aws_account_id&gt;:role/service-role/&lt;Amazon_Redshift_cluster_iam_role_name&gt;"
    }
    ]
}</pre>
			<h1 id="_idParaDest-172"><a id="_idTextAnchor228"/>Creating forecasting models using Redshift ML</h1>
			<p>Currently, if<a id="_idIndexMarker565"/> you have to perform forecasting in your data warehouse, you need to export the dataset into external systems and then apply forecasting algorithms to create output datasets and then import them back into the data warehouse for your presentation layer or further analysis. With Redshift ML’s integration with Amazon Forecast, you don’t have to perform all these steps. You can now create the forecasting models right on your dataset within your <span class="No-Break">data warehouse.</span></p>
			<p>In <a href="B19071_05.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, we<a id="_idIndexMarker566"/> talked about the basic <strong class="source-inline">CREATE MODEL</strong> syntax and its constructs. Let’s take a look at the <strong class="source-inline">CREATE MODEL</strong> syntax <span class="No-Break">for forecasting:</span></p>
			<pre class="source-code">
CREATE MODEL forecast_model_name
FROM { table_name | ( select_query ) }
TARGET column_name
IAM_ROLE { default | 'arn:aws:iam::&lt;AWS account-id&gt;:role/&lt;role-name&gt;' }
AUTO ON MODEL_TYPE FORECAST
[ OBJECTIVE optimization_metric ]
SETTINGS (S3_BUCKET 'bucket',
          HORIZON integer,
          FREQUENCY forecast_frequency,
          [, PERCENTILES perc_comma_delim_string],
          [ S3_GARGABE_COLLECT OFF ])</pre>
			<p>There are a few things to notice with the <strong class="source-inline">CREATE MODEL</strong> statement <span class="No-Break">for forecasting.</span></p>
			<p>First, forecast models do not create inference functions. The reason for this is that when we train a predictor on Amazon Forecast, we specify in the training request the number (<strong class="source-inline">HORIZON</strong>) and frequency of predictions (<strong class="source-inline">FREQUENCY</strong>) we want to make in the future. Because of this, a trained model has a fixed forecast, so there isn’t a physical model to compile and execute. A custom CTAS command (which will be discussed later) is used to extract a forecast from the training output location in S3 into a table locally <span class="No-Break">in Redshift.</span></p>
			<p>Next, we can specify the <em class="italic">optional</em> objective or optimization metric, which is used to optimize the predictor for under-forecasting and over-forecasting. Amazon Forecast provides different <a id="_idIndexMarker567"/>model accuracy metrics for<a id="_idIndexMarker568"/> you to assess the strength of your forecasting <a id="_idIndexMarker569"/>models, which are <span class="No-Break">listed here:</span></p>
			<ul>
				<li><strong class="source-inline">AverageWeightedQuantileLoss</strong> – measures the accuracy of a model at a <span class="No-Break">specified quantile</span></li>
				<li><strong class="source-inline">WAPE</strong> (weighted absolute percentage error) – measures the overall deviation of forecasted values from the <span class="No-Break">observed value</span></li>
				<li><strong class="source-inline">RMSE</strong> (root mean square error) – the square root of the average of <span class="No-Break">squared errors</span></li>
				<li><strong class="source-inline">MASE</strong> (mean absolute scaled error) – calculated by dividing the average error by a <span class="No-Break">scaling factor</span></li>
				<li><strong class="source-inline">MAPE</strong> (mean absolute percentage error) – takes the absolute value of the percentage error between observed and <a id="_idIndexMarker570"/>predicted values for each unit of time, then<a id="_idIndexMarker571"/> averages <span class="No-Break">those values</span></li>
			</ul>
			<p>Lastly, it is important to note that <strong class="source-inline">FORECAST</strong> does not support any hyperparameters. Instead, any <strong class="source-inline">FORECAST</strong>-specific settings for training will be specified using the <strong class="source-inline">SETTINGS</strong> clause. Currently, the supported settings are <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="source-inline">FREQUENCY</strong>: Granularity of predictions in a forecast. Valid values are <strong class="source-inline">Y</strong> (year), <strong class="source-inline">M</strong> (month), <strong class="source-inline">W</strong> (week), <strong class="source-inline">D</strong> (day), <strong class="source-inline">H</strong> (hour), and <strong class="source-inline">min</strong> (minute), for example, <strong class="source-inline">H</strong> for hourly forecasts or <strong class="source-inline">1min</strong> for forecasts <span class="No-Break">every minute).</span></li>
				<li><strong class="source-inline">HORIZON</strong>: The number of time steps in the future to forecast (<span class="No-Break">e.g., </span><span class="No-Break"><strong class="source-inline">24</strong></span><span class="No-Break">).</span></li>
			</ul>
			<p class="callout-heading">Note</p>
			<p class="callout"><strong class="source-inline">FREQUENCY</strong> <strong class="source-inline">H</strong> and <strong class="source-inline">HORIZON</strong> <strong class="source-inline">24</strong> mean you want hourly forecasts for the <span class="No-Break">next day.</span></p>
			<ul>
				<li><strong class="source-inline">PERCENTILES</strong> (optional): The<a id="_idIndexMarker572"/> forecast types are used to train a predictor. Up to five forecast types or percentiles can be specified. These types can be quantiles <strong class="source-inline">[0.01 to 0.99]</strong> or <strong class="source-inline">mean</strong>. A forecast at the <strong class="source-inline">0.50</strong> quantile will estimate a lower value 50% of <span class="No-Break">the time.</span></li>
			</ul>
			<p>Now, let’s take a look at one use case where we can use the target time-series dataset for predicting the target <span class="No-Break">forecast value.</span></p>
			<h2 id="_idParaDest-173"><a id="_idTextAnchor229"/>Business problem</h2>
			<p>For this use case, let’s take the <a id="_idIndexMarker573"/>example of an online retail store to forecast the future demand for certain products in the store. This dataset is taken from the UCI ML repository and is available here: <a href="https://archive.ics.uci.edu/dataset/352/online+retail">https://archive.ics.uci.edu/dataset/352/online+retail</a>. For this exercise, we have modified the data to resemble more of a target time-series dataset, containing <strong class="source-inline">item_id</strong>, <strong class="source-inline">date</strong>, and <strong class="source-inline">target_value</strong> fields. The data spans a two-year time period starting from December 2018 to November 2020. The modified data contains the item name, date products were sold, and total number of <span class="No-Break">products sold.</span></p>
			<p class="callout-heading">Dataset citation</p>
			<p class="callout">Online Retail. (2015). UCI Machine Learning <span class="No-Break">Repository. </span><a href="https://doi.org/10.24432/C5BW33"><span class="No-Break">https://doi.org/10.24432/C5BW33</span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-174"><a id="_idTextAnchor230"/>Uploading and analyzing the data</h2>
			<p>After successfully <a id="_idIndexMarker574"/>connecting to Redshift as an admin or database developer, load data into Amazon Redshift and follow the steps <span class="No-Break">outlined here:</span></p>
			<ol>
				<li>Navigate to query editor v2, connect to <strong class="bold">Serverless</strong> endpoint, and connect to the <span class="No-Break"><strong class="bold">dev</strong></span><span class="No-Break"> database:</span></li>
			</ol>
			<div>
				<div id="_idContainer199" class="IMG---Figure">
					<img src="image/B19071_12_04.jpg" alt="Figure 12.4 – Connecting to the dev database"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.4 – Connecting to the dev database</p>
			<ol>
				<li value="2">Execute<a id="_idIndexMarker575"/> the following steps to create the schema and the trade details table and load <span class="No-Break">the data:</span><pre class="source-code">
CREATE SCHEMA chapter12_forecasting;</pre><pre class="source-code">
Create table chapter12_forecasting.web_retail_sales</pre><pre class="source-code">
(invoice_Date date, item_id varchar(500), quantity int);</pre><pre class="source-code">
COPY chapter12_forecasting.web_retail_sales</pre><pre class="source-code">
FROM 's3://packt-serverless-ml-redshift/chapter12/web_retail_sales.csv'</pre><pre class="source-code">
IAM_ROLE default</pre><pre class="source-code">
FORMAT AS CSV</pre><pre class="source-code">
DELIMITER ','</pre><pre class="source-code">
IGNOREHEADER 1</pre><pre class="source-code">
DATEFORMAT 'YYYY-MM-DD'</pre><pre class="source-code">
REGION AS 'eu-west-1';</pre></li>
				<li>Run the following query to examine some <span class="No-Break">sample data:</span><pre class="source-code">
select * from chapter12_forecasting.web_retail_sales;</pre></li>
			</ol>
			<p>The result will be similar <span class="No-Break">to this:</span></p>
			<div>
				<div id="_idContainer200" class="IMG---Figure">
					<img src="image/B19071_12_05.jpg" alt="Figure 12.5 – Query results"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.5 – Query results</p>
			<p>As you can see in the preceding figure, we have <span class="No-Break">the following:</span></p>
			<ul>
				<li><strong class="source-inline">invoice_date</strong> (date when the item <span class="No-Break">was sold)</span></li>
				<li><strong class="source-inline">item_id</strong> (name of the <span class="No-Break">product sold)</span></li>
				<li><strong class="source-inline">quantity</strong> (number of items sold for that product for <span class="No-Break">each day)</span></li>
			</ul>
			<p>Using this dataset, we<a id="_idIndexMarker576"/> will create a model in Amazon Forecast and predict the demand for the future for the given products. The goal is to analyze what a particular product’s demand is going to look like in the coming five days. For accuracy and validation, we will create the model using the data until October 2020. Once we have the predictor ready, we will then compare the output values with the actual values in November 2020 to determine the accuracy of our model. We will also take a look at different <a id="_idIndexMarker577"/>accuracy metrics, such as the average <strong class="bold">weighted quantile loss</strong> (<strong class="bold">wQL</strong>), WAPE, MAPE, MASE, <span class="No-Break">and RMSE.</span></p>
			<p>Let’s create the model using the <strong class="source-inline">CREATE MODEL</strong> statement we discussed at the beginning of the <em class="italic">Creating forecasting models using Redshift </em><span class="No-Break"><em class="italic">ML</em></span><span class="No-Break"> section.</span></p>
			<p><strong class="source-inline">Objective</strong> is set to <strong class="source-inline">AverageWeightedQuantileLoss</strong> (mean of wQL), which is the accuracy metric for <strong class="source-inline">optimization_metric</strong>. <strong class="source-inline">Frequency</strong> is set to <strong class="source-inline">D</strong> (Days), <strong class="source-inline">Horizon</strong> is set to <strong class="source-inline">5</strong>, and <strong class="source-inline">Percentiles</strong> is set to <strong class="source-inline">0.25</strong>, <strong class="source-inline">0.50</strong>, <strong class="source-inline">0.75</strong>, <strong class="source-inline">0.90</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">mean</strong></span><span class="No-Break">.</span></p>
			<p>If you do not specify the percentiles settings, then Forecast generates the predictions on <strong class="source-inline">p10</strong>, <strong class="source-inline">p50</strong>, and <strong class="source-inline">p90</strong> (0.10, 0.50, <span class="No-Break">and 0.90).</span></p>
			<p>Run the following command in query editor v2 to create the model. Note this will take approximately <span class="No-Break">90 minutes.</span></p>
			<pre class="source-code">
CREATE MODEL forecast_sales_demand
FROM (select item_id, invoice_date, quantity from  chapter12_forecasting.web_retail_sales where invoice_date &lt;  '2020-10-31')
TARGET quantity
IAM_ROLE 'arn:aws:your-IAM-Role'
AUTO ON MODEL_TYPE FORECAST
OBJECTIVE 'AverageWeightedQuantileLoss'
SETTINGS (S3_BUCKET '&lt;&lt;bucket name&gt;&gt;',
 HORIZON 5,
 FREQUENCY 'D',
 PERCENTILES '0.25,0.50,0.75,0.90,mean',
 S3_GARBAGE_COLLECT OFF);</pre>
			<p>Run the <strong class="source-inline">SHOW MODEL</strong> command<a id="_idIndexMarker578"/> to see whether model training <span class="No-Break">is complete:</span></p>
			<pre class="source-code">
SHOW MODEL forecast_sales_demand;</pre>
			<p>The result is <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer201" class="IMG---Figure">
					<img src="image/B19071_12_06.jpg" alt="Figure 12.6 – Result of model training"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.6 – Result of model training</p>
			<p>You can also view<a id="_idIndexMarker579"/> the status of the predictor using the value of <strong class="bold">Training Job Name</strong> shown in the preceding screenshot. Navigate to your AWS console and type in <span class="No-Break"><strong class="source-inline">Amazon Forecast</strong></span><span class="No-Break">.</span></p>
			<p>Click on <strong class="bold">View dataset groups</strong> and find the dataset group name by <span class="No-Break">pasting </span><span class="No-Break"><strong class="bold">redshiftml_</strong></span><strong class="bold"> </strong><span class="No-Break"><strong class="bold">20221224001451333090</strong></span><span class="No-Break">.</span></p>
			<p>Click on this dataset group name and verify whether <strong class="bold">Target time series data</strong> is <strong class="bold">Active</strong>, as shown in <span class="No-Break"><em class="italic">Figure 12</em></span><span class="No-Break"><em class="italic">.7</em></span><span class="No-Break">.</span></p>
			<p>You can also view the details about your time-series data by clicking <strong class="bold">View</strong> and seeing the schema, frequency of data registered in your data file, dataset import details, and <span class="No-Break">so on.</span></p>
			<div>
				<div id="_idContainer202" class="IMG---Figure">
					<img src="image/B19071_12_07.jpg" alt="Figure 12.7 – Verify the status of target time-series data"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.7 – Verify the status of target time-series data</p>
			<p>Once active, you can <a id="_idIndexMarker580"/>view the predictor by clicking <strong class="bold">View predictors</strong>. The <strong class="bold">Predictors</strong> dialog box will show the training status, <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer203" class="IMG---Figure">
					<img src="image/B19071_12_08.jpg" alt="Figure 12.8 – Training status in View predictors"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.8 – Training status in View predictors</p>
			<p>Run the <strong class="source-inline">SHOW MODEL</strong> command again to see if model training <span class="No-Break">is complete:</span></p>
			<pre class="source-code">
SHOW MODEL forecast_sales_demand;</pre>
			<p>The result is <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer204" class="IMG---Figure">
					<img src="image/B19071_12_09.jpg" alt="Figure 12.9 – Status of model training completion"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.9 – Status of model training completion</p>
			<p>Once the model <a id="_idIndexMarker581"/>training is finished and ready, you can then view the outputs by creating a table on <span class="No-Break">your forecast:</span></p>
			<p>For a retail <a id="_idIndexMarker582"/>store, the company needs to ensure that they do not over-forecast or under-forecast the predicted quantity required in order to effectively manage inventory and enhance profits. As mentioned earlier, Redshift ML with Amazon Forecast provides different optimization metrics that can be used in order to measure the accuracy of a model specified at different quantiles. For this use case, we have created the model for <strong class="source-inline">0.25</strong>, <strong class="source-inline">0.50</strong>, <strong class="source-inline">0.75</strong>, <strong class="source-inline">0.90</strong>, and <strong class="source-inline">mean</strong>. If the emphasis is on over-forecasting, then for a retailer, choosing a higher quantile (<strong class="source-inline">0.90</strong>) captures the spike in demand in a much better way for a high-demand item or product. This suggests that there is a 90% probability of success for the product to meet the forecasted demand. Now, let’s see how to get our <span class="No-Break">forecasted results.</span></p>
			<h2 id="_idParaDest-175"><a id="_idTextAnchor231"/>Creating a table with output results</h2>
			<p>After the <a id="_idIndexMarker583"/>model has finished training and is ready, we now create a table in our schema to hold all the forecast results using a simple CTAS command, <span class="No-Break">as shown:</span></p>
			<pre class="source-code">
create table chapter12_forecasting.tbl_forecast_sales_demand as SELECT
FORECAST(forecast_sales_demand);</pre>
			<p>In this command, <strong class="source-inline">forecast()</strong> is a pseudo table function that takes the name of your model as an input parameter. The data is then pulled from the S3 bucket location where your model results <span class="No-Break">are stored.</span></p>
			<p>Let’s take a look at the output from the preceding table by running the following <span class="No-Break">SQL command:</span></p>
			<pre class="source-code">
select * from chapter12_forecasting.tbl_forecast_sales_demand;</pre>
			<p>Looking at <span class="No-Break"><em class="italic">Figure 12</em></span><em class="italic">.10</em>, you can see that for each day, Forecast has generated the output predictions for each distribution point or quantile that we provided and <span class="No-Break">the mean:</span></p>
			<div>
				<div id="_idContainer205" class="IMG---Figure">
					<img src="image/B19071_12_10.jpg" alt="Figure 12.10 – Output of the table"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.10 – Output of the table</p>
			<p>For products in <a id="_idIndexMarker584"/>high demand, the retailer can choose a higher quantile, such as <strong class="source-inline">0.90</strong> (<strong class="source-inline">p90</strong>), which better captures spikes in demand, rather than forecasting at the mean or <span class="No-Break"><strong class="source-inline">0.50</strong></span><span class="No-Break"> quantile.</span></p>
			<p>Now, let’s take a look at the data of a popular product: <strong class="bold">JUMBO BAG </strong><span class="No-Break"><strong class="bold">RED RETROSPOT</strong></span><span class="No-Break">.</span></p>
			<p>Run the following <span class="No-Break">SQL query:</span></p>
			<pre class="source-code">
select a.item_id as product,
a.invoice_date,
a.quantity as actual_quantity ,
p90::int as p90_forecast,
p90::int - a.quantity as p90_error ,mean::int,
p50::int as p50_forecast
from chapter12_forecasting.web_retail_sales a
inner join chapter12_forecasting.tbl_forecast_sales_demand b
on upper(a.item_id) = upper(b.id)
and a.invoice_date = to_date(b.time, 'YYYY-MM-DD')
AND a.item_id = 'JUMBO BAG RED RETROSPOT'
where invoice_date &gt; '2020-10-31'
order by 1,2;</pre>
			<p>Here’s <span class="No-Break">the result:</span></p>
			<div>
				<div id="_idContainer206" class="IMG---Figure">
					<img src="image/B19071_12_11.jpg" alt="Figure 12.11 – Forecast data"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.11 – Forecast data</p>
			<p>To visualize the<a id="_idIndexMarker585"/> data, select <strong class="bold">Chart</strong>. For the <em class="italic">x</em> axis, choose the <strong class="source-inline">invoice_date</strong> attribute, and for the <em class="italic">y</em> axis, <span class="No-Break">choose </span><span class="No-Break"><strong class="source-inline">p90_forecast</strong></span><span class="No-Break">:</span></p>
			<div>
				<div id="_idContainer207" class="IMG---Figure">
					<img src="image/B19071_12_12.jpg" alt="Figure 12.12 – Forecast chart"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.12 – Forecast chart</p>
			<p>If we closely examine the preceding data in <span class="No-Break"><em class="italic">Figure 12</em></span><em class="italic">.11</em>, we can observe that Line 1 was under-forecasted, while Lines 2 and 3 were very close to the actual values, and Line 4 was just slightly over-forecasted. In order to test the forecasting, you can further perform tests with different sets of data or even on different quantiles. Additionally, a retailer can use this data for different products, such as products with low demand, and make use of other quantiles, such as <strong class="source-inline">p50</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">mean</strong></span><span class="No-Break">.</span></p>
			<p>The wQL is used to calculate the <strong class="source-inline">AverageWeightedQuantileLoss</strong> metric. The wQL can be used to manage the costs of over- and under-forecasting. These metrics will be available to you in the Amazon Forecast console for your predictor. Generally, to <a id="_idIndexMarker586"/>calculate the wQL at <strong class="source-inline">0.90</strong>, sum the values of the positive values in above <strong class="source-inline">p90</strong> error field and multiply them by a smaller weight of <strong class="source-inline">0.10</strong>, and sum the absolute values of the negative values in <strong class="source-inline">p90</strong> error and multiply them <span class="No-Break">by </span><span class="No-Break"><strong class="source-inline">0.90</strong></span><span class="No-Break">.</span></p>
			<p>To align with your business outcomes, you can create the forecasting models at different quantiles (<strong class="bold">Percentiles</strong>) in your Amazon Redshift data warehouse. This gives you the flexibility to measure your business goals and keep the impacts on cost on the <span class="No-Break">lower side.</span></p>
			<h1 id="_idParaDest-176"><a id="_idTextAnchor232"/>Summary</h1>
			<p>In this chapter, we discussed how you can use Redshift ML to generate forecasting models using Amazon Forecast by creating the model for Forecast <strong class="source-inline">Model_Type</strong>. You learned about what forecasting is and how time-series data is used to generate different models for different quantiles. We also looked at different quantiles and talked briefly about different <span class="No-Break">optimization metrics.</span></p>
			<p>We showed how forecast models can be used to predict the future quantity sale for a retailer use case and how they can be used to balance the effect of over-forecasting <span class="No-Break">and under-forecasting.</span></p>
			<p>In the next chapter, we will look at operational and <span class="No-Break">optimization considerations.</span></p>
		</div>
	</body></html>