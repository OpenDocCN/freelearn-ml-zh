<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Build Your First Recommendation Engine"><div class="titlepage" id="aid-J2B82"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Build Your First Recommendation Engine</h1></div></div></div><p>In the previous chapter, we had an introduction to various types of recommendation engines, which we will be building in the subsequent chapters. Now that we have got introduced to recommendation engines, let's build our first recommendation engine using R.</p><p>Before we proceed further for implementation, let's have a brief discussion about the required software and packages for building our first recommendation using R.</p><p>For this exercise, we have used the R 3.2.2 version and RStudio 0.99 or above. For installation and setup of R and RStudio, please refer to the software and hardware list section of the book.</p><p>The R packages we have used for this exercise are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">dplyr</code></li><li class="listitem"><code class="literal">data.table</code></li><li class="listitem"><code class="literal">reshape2</code></li></ul></div><p>Installing a R package is given by the following codes:</p><pre class="programlisting">#for online installation&#13;
Install.packages("dplyr")  &#13;
</pre><p>For offline installation, first download the required <code class="literal">gz</code> file from CRAN Repository to a local folder, and then execute the following code:</p><pre class="programlisting">install.packages("path/to/file/<a class="ulink" href="https://cran.r-project.org/src/contrib/dplyr_0.5.0.tar.gz">dplyr_0.5.0.tar.gz</a>", repos=NULL) &#13;
</pre><p>The recommendation engine we are going to build is based on the collaborative filtering approach. As explained in <a class="link" title="Chapter 1. Introduction to Recommendation Engines" href="part0014.xhtml#aid-DB7S1">Chapter 1</a>, <span class="emphasis"><em>Introduction to Recommendation Engines</em></span>, is based on the user's neighbourhood, as explained in the following figure:</p><div class="mediaobject"><img src="../Images/image00213.jpeg" alt="Build Your First Recommendation Engine"/></div><p style="clear:both; height: 1em;"> </p><div class="section" title="Building our basic recommendation engine"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Building our basic recommendation engine</h1></div></div></div><p>The steps to build our basic recommendation engine are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Loading and formatting data.</li><li class="listitem">Calculating similarity between users.</li><li class="listitem">Predicting the unknown ratings for users.</li><li class="listitem">Recommending items to users based on user-similarity score.</li></ol><div style="height:10px; width: 1px"/></div><p>These steps can be seen in the following diagram:</p><div class="mediaobject"><img src="../Images/image00214.jpeg" alt="Building our basic recommendation engine"/></div><p style="clear:both; height: 1em;"> </p><div class="section" title="Loading and formatting data"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec12"/>Loading and formatting data</h2></div></div></div><p>The dataset used for this chapter can be downloaded from <a class="ulink" href="https://raw.githubusercontent.com/sureshgorakala/RecommenderSystems_R/master/movie_rating.csv">https://raw.githubusercontent.com/sureshgorakala/RecommenderSystems_R/master/movie_rating.csv</a>.</p><p>The dataset chosen for the chapter is a movie-rating dataset containing ratings for six movies given by six users on a scale of 0 to 5:</p><div class="mediaobject"><img src="../Images/image00215.jpeg" alt="Loading and formatting data"/></div><p style="clear:both; height: 1em;"> </p><p>Before we load the data, let me explain a few things about the data. The dataset chosen is a comma-separated file having movie ratings from 1 to 5 in steps of 5 given by six users on six movies. Not all critics have rated all the titles in the dataset.</p><p>Our objective is to build a recommendation engine that recommends unknown movies to users based on the ratings of similar users.</p><p>Loading the data from a <code class="literal">csv</code> file in R is given by <code class="literal">read.csv()</code>:</p><pre class="programlisting">ratings = read.csv("~/movie_rating.csv") &#13;
</pre><p>The first six rows of the data can be viewed using <code class="literal">head()</code>, an inbuilt function in R:</p><pre class="programlisting">head(ratings) &#13;
</pre><div class="mediaobject"><img src="../Images/image00216.jpeg" alt="Loading and formatting data"/></div><p style="clear:both; height: 1em;"> </p><p>To see the dimensions of the dataset, we use <code class="literal">dim()</code>, an inbuilt function in R:</p><pre class="programlisting">dim(ratings) &#13;
[1] 31  3 &#13;
</pre><p>To see the structure of the input data, we may use the <code class="literal">str()</code> function in R, as follows:</p><pre class="programlisting">Str(ratings) &#13;
</pre><div class="mediaobject"><img src="../Images/image00217.jpeg" alt="Loading and formatting data"/></div><p style="clear:both; height: 1em;"> </p><p>We see that we have a dataset containing 31 observations and three variables such as critic, title, and rating. Also, we see that six critics have rated six movies. The ratings are between 1 and 5.</p><p>To see the levels of the attributes of a variable, we use <code class="literal">levels()</code> in R:</p><div class="mediaobject"><img src="../Images/image00218.jpeg" alt="Loading and formatting data"/></div><p style="clear:both; height: 1em;"> </p><p>To build a recommender system, we would be requiring a matrix where rows contain users, columns contain items, and the cells contain the ratings given by users to the items.</p><p>The next step is to arrange the data in a format that is useful to build the recommendation engine. The current data contains a row containing critic, title, and rating. This has to be converted to matrix format containing critics as rows, title as columns, and ratings as the cell values.</p><p>The following code helps us achieve this. We use the <code class="literal">acast()</code> function available in <code class="literal">reshape2</code> package. The <code class="literal">reshape2</code> package is a R package popularly used for restructuring data. The <code class="literal">acast()</code> function in <code class="literal">reshape2</code> package casts a data frame to matrix representation.</p><p>The <code class="literal">cast</code> function takes the ratings dataset as input, <code class="literal">title</code> as row attribute, <code class="literal">critic</code> as column attribute, and <code class="literal">rating</code> as value.</p><pre class="programlisting">#data processing and formatting&#13;
movie_ratings = as.data.frame(acast(ratings, title~critic,&#13;
    value.var="rating"))</pre><p>The transformed data can be viewed as follows:</p><pre class="programlisting">View(movie_ratings) &#13;
</pre><div class="mediaobject"><img src="../Images/image00219.jpeg" alt="Loading and formatting data"/></div><p style="clear:both; height: 1em;"> </p><p>From the formatted data, we see that <code class="literal">Toby</code> has rated three movies. <code class="literal">Lisa Rose</code>, <code class="literal">Mick LaSalle</code>, and <code class="literal">Gene Seymour</code> have rated all the movies. <code class="literal">Claudia Puig</code>
<span class="emphasis"><em>,</em></span> and <code class="literal">Jack Matthews</code> have not rated one movie each. Here, let's revisit our objective, which is defined at the beginning of the section: we shall recommend to critics movies that they have not rated, based on similar users. For example, we shall recommend movies to <code class="literal">Toby</code> based on the ratings provided by other critics similar to <code class="literal">Toby</code>.</p></div><div class="section" title="Calculating similarity between users"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Calculating similarity between users</h2></div></div></div><p>This is a very important step as we need to recommend the previously unseen movies based on the ratings given to these movies by other similar critics. There are various similarity measures, such as Euclidean distance, cosine distance, Pearson coefficient, Jaccard distance, and so on. The details of these measures or similarity metrics are explained in detail in the <a class="link" title="Chapter 4. Data Mining Techniques Used in Recommendation Engines" href="part0029.xhtml#aid-RL0A2">Chapter 4</a>, <span class="emphasis"><em>Data Mining Techniques Used in Recommendation Engines</em></span>.</p><p>In this chapter, we'll use correlation as the similarity measure between users. The reason for choosing correlation is that correlation represents the association two items or how closely two item vectors covary or are related to each other. So for this chapter, we have chosen the correlation value as the measure of similarity between two items in a matrix.</p><p>In R, we have the <code class="literal">cor()</code> function to find correlation between variables in a dataset. The following code calculates the similarity between critics:</p><p>While finding similarity between Toby and other critics,use the <code class="literal">use="complete.obs" </code>attribute, of the <code class="literal">cor()</code> function to consider complete observations:</p><pre class="programlisting">sim_users = cor(movie_ratings[,1:6],use="complete.obs") &#13;
View(sim_users) &#13;
</pre><div class="mediaobject"><img src="../Images/image00220.jpeg" alt="Calculating similarity between users"/></div><p style="clear:both; height: 1em;"> </p><p>From the preceding code, we observe that <code class="literal">Lisa Rose</code> is very similar to <code class="literal">Toby</code> with <code class="literal">0.99</code> and <code class="literal">Mick LaSalle</code> with <code class="literal">0.92</code>.</p></div><div class="section" title="Predicting the unknown ratings for users"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>Predicting the unknown ratings for users</h2></div></div></div><p>In this section, we will predict the unrated movies of Toby using the ratings given by similar users. The following are the steps to achieve this:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extract the titles which Toby has not rated.</li><li class="listitem">For these titles, separate all the ratings given by other critics.</li><li class="listitem">Multiply the ratings given for these movies by all critics other than Toby with the similarity values of critics with Toby.</li><li class="listitem">Sum up the total ratings for each movie, and divide this summed up value with the sum of similarity critic values.</li></ol><div style="height:10px; width: 1px"/></div><p>Before we go into the code, let's learn a bit about the <code class="literal">data.table</code> package and the <code class="literal">setDT()</code> method we have used in the following code.</p><p><code class="literal">Data.table</code> is a popular R package that provides an enhanced <code class="literal">data.frame</code> version, which allows us to do manipulations on data with lightening speed. Another advantage of the <code class="literal">data.table</code> package is that it can handle very large datasets up to 100 GB data in RAM. Various operations, such as creating a data table, an enhanced version of data frame, sub-setting data, manipulating the data, joins etc.</p><p>For this exercise, we have made use of the <code class="literal">setDT()</code> method available in <code class="literal">data.table</code>. The <code class="literal">set*</code> functions in <code class="literal">data.table</code> help manipulate input data by reference instead of value, that is, while transforming data, there won't be any physical copy of the data.</p><p>The preceding explanation is written as code, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extract the titles which Toby has not rated. We have used the <code class="literal">setDT()</code> function available in the <code class="literal">data.table</code> package to extract the non-rated titles and create a <code class="literal">data.table</code> and <code class="literal">data.frame</code> object, <code class="literal">rating_critic</code>. The <code class="literal">setDT()</code> method extracts column values and corresponding row names and creates a two-dimension <code class="literal">data.frame</code> or <code class="literal">data.table</code> object:<pre class="programlisting">        rating_critic  = setDT(movie_ratings[colnames(movie_ratings)&#13;
            [6]],keep.rownames = TRUE)[]&#13;
        names(rating_critic) = c('title','rating')&#13;
        View(rating_critic)</pre><div class="mediaobject"><img src="../Images/image00221.jpeg" alt="Predicting the unknown ratings for users"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Isolate the non-rated movies from the aforementioned list:<pre class="programlisting">        titles_na_critic =&#13;
            rating_critic$title[is.na(rating_critic$rating)]&#13;
        titles_na_critic</pre><div class="mediaobject"><img src="../Images/image00222.jpeg" alt="Predicting the unknown ratings for users"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="note3"/>Note</h3><p>Please note that the <code class="literal">is.na()</code> function is used to filter out NA values.</p></div><p>Take the ratings based on the original dataset and subset all the critics who have rated the aforementioned shown movies.</p><p>In the following code, <code class="literal">%in%</code> acts as the where condition in SQL:</p><pre class="programlisting">        ratings_t =ratings[ratings$title %in% titles_na_critic,]&#13;
        View(ratings_t)</pre><div class="mediaobject"><img src="../Images/image00223.jpeg" alt="Predicting the unknown ratings for users"/></div><p style="clear:both; height: 1em;"> </p><p>To the aforementioned data frame, now let's add a new variable, <code class="literal">similarity,</code> using the similarity values of each <code class="literal">critic</code> w.r.t Toby:</p><pre class="programlisting">        x = (setDT(data.frame(sim_users[,6]),keep.rownames = TRUE)[])&#13;
        names(x) = c('critic','similarity')&#13;
        ratings_t =  merge(x = ratings_t, y = x, by = "critic", all.x = &#13;
            TRUE)&#13;
        View(ratings_t)</pre><div class="mediaobject"><img src="../Images/image00224.jpeg" alt="Predicting the unknown ratings for users"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Multiply rating with similarity value, and add the resultant as a new variable, <code class="literal">sim_rating</code>:<pre class="programlisting">        ratings_t$sim_rating = ratings_t$rating*ratings_t$similarity&#13;
            ratings_t</pre><div class="mediaobject"><img src="../Images/image00225.jpeg" alt="Predicting the unknown ratings for users"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Sum up all the rating values for each title calculated in the preceding step, and then divide this summed up value for each title with the sum of similarity values of each critic, that is, for the <code class="literal">Just My Luck</code> title, the rating for <code class="literal">Toby</code> is calculated by summing up all the <code class="literal">sim_rating</code> values for <code class="literal">Just My Luck</code> divided by the sum of similarity values of all the critics who have rated the <code class="literal">Just My Luck</code> title:<p><span class="emphasis"><em>(2.6802154+0.5718696+2.9737221+1.8489469)/(0.8934051+0.3812464+0.9912407+0.9244735) = 2.530981
</em></span></p><p>The preceding calculation for all the titles are done in R using two functions available in the <code class="literal">dplyr</code> package, <code class="literal">group_by()</code>, and <code class="literal">summarise()</code>.</p><p>The <code class="literal">dplyr</code> package is an R package used for data manipulations. This package is very useful, like <code class="literal">data.table</code>; it comes in very handy for exploratory analysis and data manipulation.
The <code class="literal">summarise()</code> function is available in the <code class="literal">dply</code> package for summarizing results. The <code class="literal">group_by()</code> function is used to group data by one or more variables.</p><p>The <code class="literal">%&gt;%</code> operator available in the <code class="literal">dply</code> package is a very handy function used to group multiple codes together. In the following code, we are using the <code class="literal">%&gt;%</code> code to group the <code class="literal">group_by()</code> and <code class="literal">summarise()</code> functions together and compute the results without writing intermediate results:</p><pre class="programlisting">        result = ratings_t %&gt;% group_by(title) %&gt;%&#13;
            summarise(sum(sim_rating)/sum(similarity))&#13;
        result&#13;
        Source: local data frame [3 x 2]&#13;
        title sum(sim_rating)/sum(similarity)&#13;
        (fctr) (dbl)&#13;
        1 Just My Luck 2.530981&#13;
        2 Lady in the Water 2.832550&#13;
        3 The Night Listener 3.347790</pre><p>You can see the calculated or predicted ratings for all the three titles not rated by Toby. Now you can recommend these new titles, the ratings for which are greater than the average ratings given by Toby. For example, the <code class="literal">mean</code> rating given by Toby to three titles is given by the following code:</p><pre class="programlisting">        mean(rating_critic$rating,na.rm = T)&#13;
        3.166667</pre><p>Now that we know the average rating by Toby is <code class="literal">3.16</code>, we can recommend movies with ratings greater than the mean values. From the predicted values, we can recommend the movie <code class="literal">The Night Listener</code>, which is above his mean value.</p><p>The aforementioned generating recommendations for all the users can be easily extended by writing a function as follows:</p><pre class="programlisting">        generateRecommendations &lt;- function(userId){&#13;
        rating_critic = setDT(movie_ratings[colnames(movie_ratings)&#13;
            [userId]],keep.rownames = TRUE)[]&#13;
        names(rating_critic) = c('title','rating')&#13;
        titles_na_critic =&#13;
            rating_critic$title[is.na(rating_critic$rating)]&#13;
        ratings_t =ratings[ratings$title %in% titles_na_critic,]&#13;
        #add similarity values for each user as new variable&#13;
        x = (setDT(data.frame(sim_users[,userId]),keep.rownames = TRUE)&#13;
            [])&#13;
        names(x) = c('critic','similarity')&#13;
        ratings_t = merge(x = ratings_t, y = x, by = "critic", all.x = &#13;
            TRUE)&#13;
        #mutiply rating with similarity values&#13;
        ratings_t$sim_rating = ratings_t$rating*ratings_t$similarity&#13;
        #predicting the non rated titles&#13;
        result = ratings_t %&gt;% group_by(title) %&gt;%&#13;
            summarise(sum(sim_rating)/sum(similarity))&#13;
        return(result)&#13;
        }</pre><p>Making predictions now for each of the users will be very easy and is shown next:</p><div class="mediaobject"><img src="../Images/image00226.jpeg" alt="Predicting the unknown ratings for users"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Kudos to us for having built our first and basic recommender system. Let's put together the entire code we have done till now. The following is the full version of the code:</p><pre class="programlisting">library(reshape2)&#13;
library(data.table)&#13;
library(dplyr)&#13;
#data loading&#13;
ratings = read.csv("C:/Users/Suresh/Desktop/movie_rating.csv")&#13;
#data processing and formatting&#13;
movie_ratings = as.data.frame(acast(ratings, title~critic, value.var="rating"))&#13;
#similarity calculation&#13;
sim_users = cor(movie_ratings[,1:6],use="complete.obs")&#13;
#sim_users[colnames(sim_users) == 'Toby']&#13;
sim_users[,6]&#13;
#predicting the unknown values&#13;
#seperating the non rated movies of Toby&#13;
rating_critic = setDT(movie_ratings[colnames(movie_ratings)[6]],keep.rownames = TRUE)[]&#13;
names(rating_critic) = c('title','rating')&#13;
titles_na_critic = rating_critic$title[is.na(rating_critic$rating)]&#13;
ratings_t =ratings[ratings$title %in% titles_na_critic,]&#13;
#add similarity values for each user as new variable&#13;
x = (setDT(data.frame(sim_users[,6]),keep.rownames = TRUE)[])&#13;
names(x) = c('critic','similarity')&#13;
ratings_t = merge(x = ratings_t, y = x, by = "critic", all.x = TRUE)&#13;
#mutiply rating with similarity values&#13;
ratings_t$sim_rating = ratings_t$rating*ratings_t$similarity&#13;
#predicting the non rated titles&#13;
result = ratings_t %&gt;% group_by(title) %&gt;% summarise(sum(sim_rating)/sum(similarity))&#13;
#function to make recommendations&#13;
generateRecommendations &lt;- function(userId){&#13;
rating_critic = setDT(movie_ratings[colnames(movie_ratings)[userId]],keep.rownames = TRUE)[]&#13;
names(rating_critic) = c('title','rating')&#13;
titles_na_critic = rating_critic$title[is.na(rating_critic$rating)]&#13;
ratings_t =ratings[ratings$title %in% titles_na_critic,]&#13;
#add similarity values for each user as new variable&#13;
x = (setDT(data.frame(sim_users[,userId]),keep.rownames = TRUE)[])&#13;
names(x) = c('critic','similarity')&#13;
ratings_t = merge(x = ratings_t, y = x, by = "critic", all.x = TRUE)&#13;
#mutiply rating with similarity values&#13;
ratings_t$sim_rating = ratings_t$rating*ratings_t$similarity&#13;
#predicting the non rated titles&#13;
result = ratings_t %&gt;% group_by(title) %&gt;% summarise(sum(sim_rating)/sum(similarity))&#13;
return(result)&#13;
}</pre></div></div></div>
<div class="section" title="Summary" id="aid-K0RQ1"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Summary</h1></div></div></div><p>Congratulations! We have built a very basic recommendation engine using R. We have seen the step-by-step approach of building a recommendation engine. In the following chapters, we will learn about different types of recommendation engines and their implementations in various technologies such, as Spark, Mahout, Neo4j, R, and Python. In the next chapter, we will learn about the various types of recommendation engines in depth.</p></div></body></html>