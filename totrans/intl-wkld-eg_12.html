<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer142">
			<h1 id="_idParaDest-178"><em class="italic"><a id="_idTextAnchor182"/>Chapter 9</em>: Fleet Management at Scale</h1>
			<p>The <strong class="bold">Internet of things</strong> (<strong class="bold">IoT</strong>) had a humble beginning in 1999, in Procter &amp; Gamble, when Kevin Ashton introduced the idea of integrating a <strong class="bold">radio-frequency identification</strong> (<strong class="bold">RFID</strong>) antenna into lipstick shelves to enable branch managers to better track cosmetic inventories for replenishments. Since then, this technology has been adopted across all industry segments in some form or another and has become ubiquitous in today's world. </p>
			<p>Managing a set of RFID tags, sensors, and actuators inside a known physical boundary is a relatively easy task. However, managing millions (or billions or trillions) of these devices globally throughout their lifecycle is not. Especially when these devices are spread across different locations with various forms of connectivity and interfaces.</p>
			<p>Therefore, in this chapter, you will learn about the best practices of onboarding, maintaining, and diagnosing a fleet of devices remotely through AWS native services. Additionally, you will gain hands-on experience in building an operational hub to assess the health of the connected fleet for taking required actions. </p>
			<p>In this chapter, we will be covering the following topics:</p>
			<ul>
				<li>Onboarding a fleet of devices globally</li>
				<li>Managing your fleet at scale</li>
				<li>A hands-on exercise building an operational hub</li>
				<li>Checking your knowledge</li>
			</ul>
			<h1 id="_idParaDest-179"><a id="_idTextAnchor183"/>Technical requirements </h1>
			<p>The technical requirements for this chapter are the same as those outlined in <a href="B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032"><em class="italic">Chapter 2</em></a><em class="italic">, Foundations of Edge Workloads</em>. See the full requirements in that chapter.</p>
			<h1 id="_idParaDest-180"><a id="_idTextAnchor184"/>Onboarding a fleet of devices globally</h1>
			<p>We already<a id="_idIndexMarker836"/> introduced you to the different activities involved in the IoT manufacturing supply chain in <a href="B17595_08_Final_SS_ePub.xhtml#_idTextAnchor163"><em class="italic">Chapter 8</em></a>, <em class="italic">DevOps and MLOps for the Edge</em>. <strong class="bold">Onboarding</strong> refers to the process of manufacturing, assembling, and registering a device with a registration authority. In this section, we will dive deeper into the following activities that play a part in the onboarding workflow:</p>
			<div>
				<div id="_idContainer132" class="IMG---Figure">
					<img src="Images/Table_09_01.jpg" alt="Figure 9.1 – Device onboarding activities&#13;&#10;" width="1116" height="281"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.1 – Device onboarding activities</p>
			<p>So far, in this book, you have been using a <strong class="bold">Raspberry Pi</strong> (or a virtual environment) to perform the hands-on exercises. This is a common practice for development and prototyping needs. However, as your project progresses toward a higher environment (such as QA or production), it is recommended that you consider hardware that's industry-grade and can operate in various conditions. Therefore, all the aforementioned activities in <em class="italic">Figure 9.1</em> need to be completed before your device (that is, the connected HBS hub) can be made available through your distribution channels at different retail stores (and sell like hotcakes!). </p>
			<p>For the remainder of this chapter, we assume that your company already has a defined supply chain with your preferred vendors and the device manufacturing workflow is operational to assemble the devices. As your customers unbox these devices (with so much excitement!) and kick off the setup process, the device needs to bootstrap locally (on the edge) and register with the <strong class="bold">AWS IoT </strong>services successfully to become fully operational. </p>
			<p>So, you must be<a id="_idIndexMarker837"/> thinking, what are the necessary steps to perform in advance for the device registration to be a success? Here it comes. </p>
			<h2 id="_idParaDest-181"><a id="_idTextAnchor185"/>Registering a certificate authority </h2>
			<p>There are <a id="_idIndexMarker838"/>different types of <em class="italic">cryptographic</em> credentials <a id="_idIndexMarker839"/>such as a user ID, password, vended<a id="_idIndexMarker840"/> tokens (such<a id="_idIndexMarker841"/> as <strong class="bold">JWT</strong> and <strong class="bold">OAuth</strong>), and symmetric or asymmetric keys that can be used by an IoT device. We recommend using asymmetric keys as, at the time of writing, these are considered to be the most secure approach in the industry. In all the previous hands-on exercises, you took advantage of the <strong class="bold">asymmetric X.509</strong> keys and certificates generated by the AWS IoT <strong class="bold">Certificate Authority</strong> (<strong class="bold">CA</strong>), that were embedded in the connected HBS hub running Greengrass. A CA is a trusted entity that issues cryptographic credentials such as digital keys and certificates. These credentials are registered on the cloud and embedded onto the devices to enable transport-layer security or TLS-based mutual authentication. Specifically, there are four digital resources associated with a mutual TLS authentication workflow, as follows:</p>
			<ul>
				<li><strong class="bold">X.509 certificate</strong>: This is a <a id="_idIndexMarker842"/>certificate that is required to be present both on the device and in the cloud and is presented during the mutual TLS handshake.</li>
				<li><strong class="bold">Private and public keys</strong>: The asymmetric key pair that is generated using an algorithm <a id="_idIndexMarker843"/>such <a id="_idIndexMarker844"/>as <strong class="bold">Rivest-Shamir-Adleman</strong> (<strong class="bold">RSA</strong>) or <strong class="bold">Elliptical Curve cryptography</strong> (<strong class="bold">ECC</strong>). As a best practice, the private key only stays on the device and should be protected to avoid identity compromises.</li>
				<li><strong class="bold">Signer CA</strong>: This is a root or intermediate certificate that has been issued and signed by a trusted CA such as AWS and Verisign. The device will need to send this issuing CA along with the client certificate during the registration process. If the signer CA is not available, it's also possible to send the <strong class="bold">Server Name Indication</strong> (<strong class="bold">SNI</strong>) part <a id="_idIndexMarker845"/>of the TLS mutual authentication to validate trust.</li>
				<li><strong class="bold">Server certificate</strong>: This is a certificate that's used by the devices to verify, using the certificate chain <a id="_idIndexMarker846"/>presented during the TLS handshake, that it's not communicating with an impersonating server. </li>
			</ul>
			<p>The following diagram shows the workflow and the location of these digital resources on the <a id="_idIndexMarker847"/>device<a id="_idIndexMarker848"/> and in the cloud:</p>
			<div>
				<div id="_idContainer133" class="IMG---Figure">
					<img src="Images/Figure_09_02.jpg" alt="Figure 9.2 – Cryptographic credentials within an IoT workflow&#13;&#10;" width="1650" height="708"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.2 – Cryptographic credentials within an IoT workflow</p>
			<p>Therefore, it's critical to decide on a CA early on in the design process. This is so that it can issue the aforementioned digital resources required by the devices to perform registration with a backend authority and become fully operational. There are three different ways a CA can be used with AWS IoT Core, as shown in the following table along with a list of pros and cons:</p>
			<div>
				<div id="_idContainer134" class="IMG---Figure">
					<img src="Images/B17595_09_03.jpg" alt="Figure 9.3 – Choosing a CA&#13;&#10;" width="1026" height="477"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.3 – Choosing a CA</p>
			<p>Once the CA setup is complete, the next step is to choose the device provisioning approach based <a id="_idIndexMarker849"/>on the scenario. Let's understand<a id="_idIndexMarker850"/> that in more detail next. </p>
			<h2 id="_idParaDest-182"><a id="_idTextAnchor186"/>Deciding the provisioning approach</h2>
			<p>Terms such<a id="_idIndexMarker851"/> as provisioning and registration are used interchangeably in many contexts in the IoT world, but we believe there is a clear distinction between them. For us, device provisioning is the amalgamation of two activities – device registration and device activation. <em class="italic">Device registration</em> is the process where a device successfully authenticates using its initial cryptographic credentials against a registration authority (such as the AWS IoT Identity service), reports distinctive attributes such as the model and serial number, and gets associated as a unique identity in a device registry. Additionally, the authority can return a new set of credentials, which the device can replace with the prior ones. Following this, a privilege escalator can enhance the privilege of the associated principal (such as the X.509 certificate) for the device to be activated and fully operational. </p>
			<p>There are different approaches to these provisioning steps, which are often derived from the level of control or convenience an organization intends to have in the manufacturing supply chain. Often, this choice is determined by several factors such as in-house skills, cost, security, time to market, or sensitivity to the intellectual property of the product. You learned about the approach of automatic provisioning through IoT Device Tester in <a href="B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032"><em class="italic">Chapter 2</em></a>, <em class="italic">Foundations of Edge Workloads</em>, which is prevalent for prototyping and experimentation purposes. </p>
			<p>In this section, we will discuss two production-grade provisioning approaches that can scale from one<a id="_idIndexMarker852"/> device to millions of devices (or more) by working backward from the following scenarios. </p>
			<h3>Scenario 1 – HBS hubs with unique firmware images are provisioned in bulk</h3>
			<p>In this scenario, you <a id="_idIndexMarker853"/>can provision the fleet of HBS hubs in bulk in your supply chain using unique firmware images that include unique cryptographic credentials:</p>
			<ol>
				<li>As a device maker of the HBS hub, first, you will associate the CA of your choice with AWS IoT Core using a supported API. This CA will manage the chain of trust and create and validate the cryptographic credentials (such as certificates or certificate signing requests) for the entire fleet of devices. </li>
				<li>Then, you will create a provisioning template, which, essentially, is a configuration file that holds the instruction for the AWS IoT identity service to create a thing (or the virtual representation) for the fleet of HBS hub devices. This template <a id="_idIndexMarker854"/>will include different input parameters such as <strong class="source-inline">ThingName</strong>, <strong class="source-inline">SerialNumber</strong>, and <strong class="bold">Certificate Signing Requests</strong> (<strong class="bold">CSRs</strong>) that will lead to the creation of IoT resources such as the virtual thing, device metadata, certificates, and policies. You can refer to the template shown on the official <em class="italic">Internet of things on AWS</em> blog, titled <em class="italic">Deploy Fleets Easily with AWS IoT Device Management Services</em> (<a href="https://aws.amazon.com/blogs/iot/deploy-fleets-easily-with-aws-iot-device-management-services/">https://aws.amazon.com/blogs/iot/deploy-fleets-easily-with-aws-iot-device-management-services/</a>). The template can be found in the <em class="italic">Create Provisioning Template</em> section.</li>
				<li>The next step is to generate cryptographic credentials, such as the private keys and CSRs, through preferred tool <a id="_idIndexMarker855"/>chains (such as <strong class="bold">OpenSSL</strong>). Following this, create an input file with a list of devices and cryptographic credentials, which will be fed to the provisioning template. The input file, in its simplest form, might look like this: <p class="source-code">{"ThingName": "hbshub-one", "SerialNumber": "0001", "CSR": "*** CSR FILE CONTENT ***"}</p><p class="source-code">{"ThingName": "hbshub-two", "SerialNumber": "0002", "CSR": "*** CSR FILE CONTENT ***"}</p><p class="source-code">{"ThingName": "hbshub-three", "SerialNumber": "0003", "CSR": "*** CSR FILE CONTENT ***"}</p></li>
				<li>Now, the time has arrived to invoke an API to create all these virtual devices (that is, things), in <a id="_idIndexMarker856"/>bulk, in the IoT device registry on the cloud along with its respective cryptographic credentials (such as the certificates or CSRs) that are signed by the CA. Once this step is complete, a token exchange role needs to be created, and these things need to be associated with Greengrass-specific constructs such as a Greengrass core, a thing group, and a configuration file (<strong class="source-inline">config.yaml</strong>) that is required for the installation process. </li>
				<li>Following this, you will inject the credentials generated in the earlier steps, which include the private key from <em class="italic">step 3</em> and the signed certificate from <em class="italic">step 4</em>, into your firmware. This updated firmware, often referred to as the golden image, is then shared with your assembly team (either in-house or a contract manufacturer). The assembly team will flash this image onto the device part of the manufacturing workflow: </li>
			</ol>
			<div>
				<div id="_idContainer135" class="IMG---Figure">
					<img src="Images/Figure_09_04.jpg" alt="Figure 9.4 – Bulk provisioning with embedded credentials&#13;&#10;" width="984" height="641"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.4 – Bulk provisioning with embedded credentials</p>
			<p>This approach is pretty common with microcontrollers running an RTOS since incremental updates are not supported (yet) with those hardwares. However, for the connected HBS hub, it's more agile and operationally efficient to decouple <a id="_idIndexMarker857"/>the firmware image from the crypto credentials. </p>
			<p>That's where this second option comes in. Here, you will still generate the things and unique credentials from your CA in the same way as you did in the previous step, but you will not inject it into the firmware. Instead, you will develop an intelligent<a id="_idIndexMarker858"/> firmware that can<a id="_idIndexMarker859"/> accept credentials <a id="_idIndexMarker860"/>over different interfaces such as <strong class="bold">secure shell</strong> (<strong class="bold">SSH</strong>), a <strong class="bold">network file system</strong> (<strong class="bold">NFS</strong>), or a <strong class="bold">serial connection</strong>. As a best practice, it's also common to store the credentials in a separate chip such as a secure <a id="_idIndexMarker861"/>element or a <strong class="bold">trusted platform module</strong> (<strong class="bold">TPM</strong>). Additionally, the firmware can use a public key cryptography standards interface (such as <em class="italic">PKCS#11</em>) to retrieve the keys and certificates as required by the firmware or other local applications in real time. At the time of writing this book, Greengrass v2 is awaiting support for TPM, although it was a supported feature in Greengrass v1: </p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer136" class="IMG---Figure">
					<img src="Images/Figure_09_05.jpg" alt="Figure 9.5 – Bulk provisioning with the injection interface&#13;&#10;" width="1204" height="395"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.5 – Bulk provisioning with the injection interface</p>
			<p>Let us take a look at how to go about the second option:</p>
			<ol>
				<li value="1">Once the device assembly is complete with the golden image that contains the necessary configurations and credentials, the product reaches the hands of the customer through different distribution channels. When the customer switches on the device and it wakes up for the first time, the bootstrapping process kicks off.</li>
				<li>The bootstrapping will instantiate various local processes (or <em class="italic">daemons</em>), that is, the firmware instructions. One of those processes includes registration with AWS IoT Identity services where the device will connect to the cloud endpoint and exchange the embedded credentials part of the TLS mutual authentication. Considering <a id="_idIndexMarker862"/>the things, certificates, and policies are already created as a prerequisite to the assembly, the device is fully operational if the mutual authentication is successful. </li>
			</ol>
			<h3>Scenario 2 – HBS hubs with shared claims are provisioned just in time</h3>
			<p>Let's consider the following scenario; your devices might not have the capability to accept unique credentials at the time of manufacturing. Or it's cost-prohibitive for your organization to undertake the operational overhead of embedding unique credentials in each HBS hub in your supply chain. This is where another pattern emerges, referred to as fleet provisioning by claim, where, as a device maker, you can embed a non-unique shared credential (referred to as claim) in your fleet. However, we recommend that you do not share the same claim for the entire fleet, rather only a percentage of it to reduce the blast radius in the case of any security issues. Take a look at the following steps: </p>
			<ol>
				<li value="1">As a first step, the firmware along with a fleet provisioning plugin and a shared certificate (that is, claim) is loaded by the contract manufacturer on the device without performing any customization. The fleet provisioning by claim approach uses a templated methodology that is similar to the previous scenario to provision the required cloud resources. You can refer to a sample template that is provided in AWS's documentation, called <em class="italic">Set up AWS IoT fleet provisioning for Greengrass core devices</em> (<a href="https://docs.aws.amazon.com/greengrass/v2/developerguide/fleet-provisioning-setup.html#create-provisioning-template">https://docs.aws.amazon.com/greengrass/v2/developerguide/fleet-provisioning-setup.html#create-provisioning-template</a>). The primary difference is that all of these resources are provisioned just in time, where each device initiates the bootstrapping process from their current location over being imaged in bulk in a manufacturing facility.</li>
				<li>This approach also supports a pre-provisioning hook feature in which a lambda function can be <a id="_idIndexMarker863"/>invoked to validate different parameters or perform pre-provisioning logic. For example, it can be as simple as overriding a parameter to more complex validations such as checking whether the claim certificate is part of a revocation list:<p class="source-code">def pre_provisioning_hook(event, context):</p><p class="source-code">    return {</p><p class="source-code">        'allowProvisioning': True,</p><p class="source-code">        'parameterOverrides': {</p><p class="source-code">            'DeviceLocation': 'NewYork'</p><p class="source-code">        }</p><p class="source-code">        }</p><p>Here, when the hub wakes up and connects to AWS IoT for the first time, the claim certificate is exchanged for permanent X.509 credentials that have been signed by the CA (AWS or BYO). This is where the fleet provisioning plugin helps, as it allows the device to publish and subscribe to the required <strong class="bold">MQ telemetry transport</strong> (<strong class="bold">mqtt</strong>) topics, accept the unique credentials, and<a id="_idIndexMarker864"/> persist in a secure type of storage:</p><div id="_idContainer137" class="IMG---Figure"><img src="Images/Figure_09_06.jpg" alt="Figure 9.6 – Fleet provisioning with shared claims&#13;&#10;" width="1650" height="1379"/></div><p class="figure-caption">Figure 9.6 – Fleet provisioning with shared claims</p></li>
				<li>Following<a id="_idIndexMarker865"/> this, the device must also disconnect from the previous session it initiated with the shared claim and reconnect with the unique credentials.<p class="callout-heading">Word of Caution</p><p class="callout">Fleet provisioning by claim poses security risks if the shared claims are not protected through the supply channels.</p></li>
			</ol>
			<p>Once the devices have been provisioned, the next step is to organize them to ease the management throughout its life cycle. The Greengrass core devices can be organized into thing groups, which is the construct for organizing a fleet of devices within the AWS IoT ecosystem. A <strong class="bold">thing group</strong> can <a id="_idIndexMarker866"/>be either static or dynamic in nature. As their name suggests, static groups allow the organization of devices based on non-changing attributes such as the product type, the manufacturer, the serial number, the production date, and more. </p>
			<p>Additionally, static groups permit building a hierarchy of devices with parent and child devices that can span up to seven layers. For example, querying a group of washing machine sensors within a serial number range that belongs to company XYZ can be useful to identify devices that need to be recalled due to a production defect. </p>
			<p>In comparison, dynamic groups are created using indexed information such as the connectivity status, registry metadata, or device shadow. Therefore, the membership of dynamic groups is always changing. That is the reason dynamic groups are not associated with any device hierarchy; for example, querying a group of HBS devices that are connected at a point in time and have a firmware version of v1. This result can allow a fleet operator to push a firmware update notification to the respective owners. </p>
			<p>Another advantage <a id="_idIndexMarker867"/>of using thing groups is the ability to assign fleet permissions (that is, policies) at the device group level, which then cascades to all the devices in that hierarchy. This eases the overhead of managing policies at each device level. Concurrently, though, it's possible to have device-specific policies, and the AWS IoT Identity service will automatically assess the least-privileged level of access permitted between the group and device level during the authentication and authorization workflow. </p>
			<p>Now you have a good understanding of how to provision and organize the HBS hubs using different approaches. Next, let's discuss how to manage the fleet once it has been rolled out. </p>
			<h1 id="_idParaDest-183"><a id="_idTextAnchor187"/>Managing your device fleet at scale</h1>
			<p>Although it might <a id="_idIndexMarker868"/>be easier to monitor a handful of devices, managing a fleet of devices at scale can turn out to be an operational nightmare. Why? Well, this is because IoT devices (such as the HBS hub) are not just deployed in a controlled perimeter (such as a data center). As you should have gathered by now, these devices can be deployed anywhere, such as home, office, business locations, that might have disparate power utilization, network connectivity, and security postures. For example, there can be times when the devices operate offline and are not available over a public or private network due to the intermittent unavailability of WI-FI connectivity in that premises. Therefore, as an IoT professional, you have to consider various scenarios and plan in advance for managing your fleet at scale.</p>
			<p>In the context of a connected HBS hub, device management can help you achieve the following:</p>
			<ul>
				<li>Capture actionable information from the real world.</li>
				<li>Increase efficiency of the solution by capturing anomalies early.</li>
				<li>Optimize cost using predictive or preventive maintenance.</li>
				<li>Prevent the theft of intellectual IP or unauthorized access.</li>
				<li>Build a continuous feedback loop to improve customer experience.</li>
				<li>Generate additional revenue streams with more data insights.</li>
			</ul>
			<p>So, as you might have gathered, developing an IoT solution and rolling it out to the customers is just the beginning. It's necessary to govern the entire life cycle of the solution to achieve the business outcomes cited earlier. Therefore, device management can also be considered as a bigger umbrella for the following activities:</p>
			<ul>
				<li>Provision </li>
				<li>Organize</li>
				<li>Monitor</li>
				<li>Maintain</li>
				<li>Diagnose</li>
			</ul>
			<p>The following is a diagram showing the IoT Device Management workflow:</p>
			<div>
				<div id="_idContainer138" class="IMG---Figure">
					<img src="Images/Figure_09_07.jpg" alt="Figure 9.7 – The IoT Device Management workflow&#13;&#10;" width="1604" height="369"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.7 – The IoT Device Management workflow</p>
			<p>We have already<a id="_idIndexMarker869"/> discussed the first three topics in the preceding section in the context of Greengrass. Therefore, we will move on to focus on the remaining activities. </p>
			<h2 id="_idParaDest-184"><a id="_idTextAnchor188"/>Monitor </h2>
			<p>Monitoring the<a id="_idIndexMarker870"/> Greengrass-enabled HBS hubs and the associated <a id="_idIndexMarker871"/>devices will be key in achieving a reliable, highly available, and performant IoT workload. You should have a mechanism to collect monitoring data from the edge solution to debug failures when they occur. Greengrass supports the collection of <em class="italic">system health telemetry</em> and <em class="italic">custom metrics</em>, which are diagnostic data points to monitor the performance of critical operations of different components and applications on the Greengrass core devices. The following is a list of the different ways to gather this data:</p>
			<ul>
				<li><strong class="bold">Nucleus emitter</strong> is a<a id="_idIndexMarker872"/> Greengrass component that can be deployed to your Greengrass core device to publish telemetry data to a local topic by default:<em class="italic"> </em><ul><li>Once the data has been published to a local topic (such as <strong class="source-inline">$local/greengrass/telemetry</strong>), you can act locally on that data on your core device, even when there is intermittent connectivity to the cloud. </li><li>Optionally, the component can be configured to publish telemetry data to the <em class="italic">mqtt</em> topic in the cloud.</li><li>This is a continuous stream of system telemetry data published to a local topic in near real time. The default configuration is every 60 seconds. </li><li>There are no costs if the telemetry data is published locally, but charges apply when it is pushed to the cloud. </li></ul></li>
				<li>A <strong class="bold">telemetry agent</strong> is another <a id="_idIndexMarker873"/>option that you can use to collect local telemetry data, which is enabled by default for all Greengrass core devices:<ul><li>This agent collects telemetry data and publishes it to the cloud on a best effort basis through <strong class="bold">Amazon EventBridge</strong>, which is a serverless event bus service.</li><li>Data starts to flow as soon as the Greengrass core device is up and running. By default, the telemetry agent aggregates telemetry data every hour and publishes it to the cloud every 24 hours.</li><li>There <a id="_idIndexMarker874"/>are no data transfer charges since the messages are<a id="_idIndexMarker875"/> published to reserved topics on AWS IoT Core. </li></ul></li>
				<li>A <em class="italic">telemetry agent</em> publishes the following metrics natively: <ul><li>System memory and CPU utilization</li><li>The total number of file descriptors, where each descriptor represents an open file</li><li>The number of components in various states, such as the following:<ul><li>Installed, new, and starting</li><li>Running, stopping, and finishing</li><li>Errored, broken, and stateless</li></ul></li></ul><p>Later, in the hands-on section, you will collect these metrics and process them on the cloud.</p></li>
				<li><em class="italic">CloudWatch metrics</em> is a Greengrass component that allows you to publish custom metrics to Amazon CloudWatch:<ul><li>Any custom component such as lambda functions or containers deployed on the core device can publish the custom metrics to a local topic (<strong class="source-inline">cloudwatch</strong>/<strong class="source-inline">metric</strong>/<strong class="source-inline">put</strong>).</li><li>The components can be configured to specify different publish intervals (in seconds), so the metrics can be published with or without batching. For example, with lambda, the default batching window is 10 seconds and the maximum wait time could be 900 seconds.</li><li>So, if you think of scenarios where you have to collect metrics from the sensors and actuators associated with the hub and not just from the gateways, a custom application can retrieve those data points and publish them locally or to cloud endpoints for monitoring purposes.</li></ul></li>
				<li><em class="italic">Log manager</em> is a Greengrass component that can be deployed to your Greengrass core device to collect and, optionally, upload logs to Amazon CloudWatch Logs:<ul><li>Although <a id="_idIndexMarker876"/>metrics <a id="_idIndexMarker877"/>can help reflect the state of the device, logs are critical for troubleshooting exceptions or failures. </li><li>For the real-time observability of logs, Greengrass offers various log files. Some of these you might have already used by now, such as the following: <ul><li><strong class="bold">Greengrass.log</strong>: This is a log file that is used to view real-time information about nucleus and component deployments. For example, with an HBS hub, this log file can report the errors, exceptions, and failures of the nucleus software, which you (or the customer) can analyze for downtimes or malfunctions. </li><li><strong class="bold">Component.log</strong>: This is a log file(s) to view real-time information about the components running on the core device. </li><li><strong class="bold">Main.log</strong>: This is a log file that handles the component life cycle information. </li></ul></li><li>The log manager component can upload logs in various frequencies. The default configuration for log manager is to upload new logs every 5 minutes to AWS CloudWatch. Additionally, it's possible to configure a lower upload interval for more frequent uploads. The log format is also configurable between text format and JSON format.</li><li>Log manager also supports file rotation every hour or when the file size limit has exceeded. The default size limit for the log files is 1 MB and the disk size is 10 MB and is fully configurable. To optimize log sizes, it's also a best practice to use different verbosity levels for different environments (such as development, testing, and production):<ul><li>For example, you can choose DEBUG-level logs to help with troubleshooting in non-production environments or ERROR-level logs to reduce the number of logs that a device generates in a production environment. This choice also helps to optimize costs.</li></ul></li></ul></li>
			</ul>
			<p>As you are collecting all of these data points (metrics and logs) from the HBS hub and publishing them to the cloud, the next step is to allow different personas such as fleet operators (or other downstream businesses) to consume this information. This can be achieved through CloudWatch, which natively offers various capabilities related to logging insights, generating dashboards, setting up alarms, and more. If your organization has already standardized on a monitoring solution (such as <strong class="bold">Splunk</strong>, <strong class="bold">Sumologic</strong>, <strong class="bold">Datadog</strong>, or others) CloudWatch also supports that integration.</p>
			<p>Finally, in the control plane, Greengrass integrates with <strong class="bold">AWS CloudTrail</strong> to log access events <a id="_idIndexMarker878"/>related to service APIs, IAM users, and roles. These access logs can <a id="_idIndexMarker879"/>be used to determine additional details about Greengrass access such as the IP address from which a request was made, who the request was made by, and when it was made, which can be useful for various security and operational needs.</p>
			<h2 id="_idParaDest-185"><a id="_idTextAnchor189"/>Maintenance</h2>
			<p>The previously <a id="_idIndexMarker880"/>explained services, such as Amazon CloudWatch (or a third-party solution), can be robust enough to generate the various insights required to monitor the health of IoT workloads. However, another common ask from IoT administrators or fleet operators is to have a single-pane-of-glass view that allows them to consume a comprehensive set of information from the device fleet, to quickly troubleshoot operational events. </p>
			<p>For example, consider a scenario where customers are complaining that their HBS hubs are malfunctioning. As a fleet operator, you can observe a lot of connection drops and high-resource utilization from the dashboard. Therefore, you look up the logs (on a device or in the cloud) and identify it as a memory leak issue due to a specific component (such as <em class="italic">Aggregator</em>). Based on your operation playbook, you need to identify whether this is a one-off issue or whether more devices in the fleet are showing similar behavior. Therefore, you need an interface to search, identify, and visualize the metrics such as the device state, device connection, battery level across the fleet, or on a set filtered by user location. Here comes the need for a fleet management solution such as <strong class="bold">AWS Fleet Hub</strong>, which<a id="_idIndexMarker881"/> allows the creation of a fully managed web application to cater to various personas using a no-code approach. In our scenario, this web application can help the operators to view, query, and interact with a fleet of connected HBS hubs in near real time and troubleshoot the issue further. In addition to monitoring, the operators can also respond to alarms and trigger a remote operation <strong class="bold">over the air</strong> (<strong class="bold">OTA</strong>) to <a id="_idIndexMarker882"/>remediate deployed devices from a single interface. AWS Fleet Hub applications also <a id="_idIndexMarker883"/>enable the following:</p>
			<ul>
				<li><em class="italic">Integration</em> with existing identity and access management systems such as Active Directory and LDAP, which allow role-based access to different personas such as the fleet operators, fleet managers, device makers, third parties, and IT operators who are interacting with the HBS hub in some way. Additionally, this allows these users<a id="_idIndexMarker884"/> to use <strong class="bold">single sign-on</strong> (<strong class="bold">SSO</strong>) and access a fleet hub from any browser on a desktop, tablet, or smartphone. </li>
				<li><em class="italic">Aggregation</em> of data from other services such as AWS IoT Fleet Indexing, Amazon<a id="_idIndexMarker885"/> CloudWatch, or <strong class="bold">Amazon Simple Notification Service</strong> (<strong class="bold">SNS</strong>). The IoT Fleet Indexing service helps to index, search, query, and aggregate data from device registry, device shadow, and device connectivity events. Also, it's possible to create custom fields. CloudWatch metrics can be used in combination with these searchable fields to create alarms. Finally, Amazon SNS can notify different personas when an alarm threshold has been breached.</li>
			</ul>
			<p>In summary, these capabilities from Fleet Hub can allow an organization to respond more quickly to <a id="_idIndexMarker886"/>different operational events and, thereby, improve customer experience.</p>
			<h2 id="_idParaDest-186"><a id="_idTextAnchor190"/>Diagnose</h2>
			<p>In the preceding <a id="_idIndexMarker887"/>scenario, you learned how a fleet operator can stay well informed about the operational events in near real time through a single-pane-of-glass view. However, what about diagnosing the issue further if the remote actions through Fleet Hub are not sufficient to remediate the identified issue? For example, an operator might have triggered a remote action to restart the aggregator component or the HBS hub itself, but that did not solve the problem for the end consumer. Therefore, as a next step, the operator is required to gain direct access to the hub or associated sensors for further troubleshooting. Traditionally, in such a situation, a company will schedule an appointment with a technician, which means additional cost and wait time for the customers. That's where a remote diagnostics capability such as <strong class="bold">AWS IoT Secure Tunneling</strong> can be useful. This is an AWS Managed service that allows fleet operators to gain additional privileges (such as SSH or RDP access) over a secure tunnel to the destination device. </p>
			<p>The secure tunneling component of Greengrass enables secure bidirectional communication between an operator workstation and a Greengrass-enabled device (such as the HBS hub) even if it's behind restricted firewalls. This is made possible because the remote operations navigate through a secure tunnel under the hood. Moreover, the devices will also continue to use the same cryptographic credentials (that is, <em class="italic">X509 certificates</em>) used in telemetry for this remote operation. The only other dependency from the client <a id="_idIndexMarker888"/>side (that is, the <strong class="bold">fleet operator</strong>) is the installation of proxy software on the laptop or a web browser. That is because this proxy software makes the magic happen by allowing the exchange of temporary credentials (that is, <strong class="bold">access tokens</strong>) with the tunneling service when the sessions are initiated. The following diagram shows the workflow of secure tunneling:</p>
			<div>
				<div id="_idContainer139" class="IMG---Figure">
					<img src="Images/Figure_09_08.jpg" alt="Figure 9.8 – The secure tunneling workflow for diagnostics&#13;&#10;" width="1325" height="504"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.8 – The secure tunneling workflow for diagnostics</p>
			<p>For our scenario, the source refers to the workstation of the fleet operator, the destination refers to the connected HBS hub, and the secure tunnel service is managed by AWS. </p>
			<p>Now that you have gained a good understanding of how to better monitor, maintain, and diagnose <a id="_idIndexMarker889"/>edge devices, let's get our hands dirty in the final section of this chapter.</p>
			<h1 id="_idParaDest-187"><a id="_idTextAnchor191"/>Getting hands-on with Fleet Hub architecture</h1>
			<p>In this<a id="_idIndexMarker890"/> section, you will learn how to use the nucleus emitter and the telemetry agent to capture various metrics and logs from edge devices and visualize those through Amazon CloudWatch and AWS IoT Fleet Hub. The following is the architecture that shows the different services and steps you will complete during the lab:</p>
			<div>
				<div id="_idContainer140" class="IMG---Figure">
					<img src="Images/Figure_09_09.jpg" alt="Figure 9.9 – Hands-on operational hub&#13;&#10;" width="1650" height="615"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.9 – Hands-on operational hub</p>
			<p>The following<a id="_idIndexMarker891"/> table lists the services that you will use in this exercise:</p>
			<div>
				<div id="_idContainer141" class="IMG---Figure">
					<img src="Images/Table_09_10.jpg" alt="Figure 9.10 – The services in scope for this exercise&#13;&#10;" width="1146" height="431"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.10 – The services in scope for this exercise</p>
			<p>Your objective in this hands-on section includes the following steps, as depicted in the preceding architecture:</p>
			<ol>
				<li value="1">Build an operational dashboard using AWS IoT Fleet Hub.</li>
				<li>Deploy a nucleus emitter component and collect metrics through the telemetry from the edge.</li>
				<li>Deploy a log manager component and stream the logs to Cloudwatch.</li>
				<li>Visualize the results on IoT Fleet Hub and CloudWatch.</li>
			</ol>
			<p>Let's take<a id="_idIndexMarker892"/> a look at the preceding steps, in more detail, next.</p>
			<h2 id="_idParaDest-188"><a id="_idTextAnchor192"/>Building the cloud resources </h2>
			<p>In this section, you<a id="_idIndexMarker893"/> will learn how to set up a Fleet Hub application that can be used to monitor the metrics from the connected HBS hub. Perform the following steps:</p>
			<ol>
				<li value="1">Navigate to <strong class="bold">AWS IoT Core Console</strong> and select <strong class="bold">Fleet Hub</strong>. Choose <strong class="bold">Get started</strong> and click on <strong class="bold">Create Application</strong>.</li>
				<li>This will prompt you to set up <strong class="bold">Single Sign-On</strong> using AWS SSO. If you have not used this service in the past, create a user with the necessary information. You will receive an invitation via email that you need to accept along with instructions about how to set up your password. Click on <strong class="bold">Next</strong>.</li>
				<li>Now you need to configure indexing with AWS IoT data. As discussed earlier, Fleet Hub gives you a single-pane-of-glass view by aggregating information from different sources. This is where you set all of these integrations. </li>
				<li>Click on <strong class="bold">Manage Indexing</strong> in the <strong class="bold">Fleet indexing</strong> section. This will open up the AWS IoT settings page. Click on <strong class="bold">Manage Indexing</strong> again and enable all the available options such as <strong class="bold">Thing Indexing</strong> and <strong class="bold">Thing Group Indexing</strong>. Optionally, you can also create custom search fields if you wish. Click on <strong class="bold">Update</strong>.</li>
				<li>Navigate back to the Fleet Hub setup screen and the settings should be in active status now. Click on <strong class="bold">Next</strong>.</li>
				<li>Create an application role and an application with a name of your choice. Click on the view policy permissions to understand the access provided to the application. You should notice that you are providing access to the IoT, CloudWatch, and SNS resources for Fleet Hub to integrate with all of these sources, as mentioned earlier. Click on <strong class="bold">Create application</strong>. </li>
				<li>On the <strong class="bold">Applications</strong> tab of Fleet Hub, click on the application URL once it shows active. For the first access, this will prompt you to add an SSO user. Click on that and add the user you created earlier. Click on <strong class="bold">Add selected users</strong>. </li>
				<li>Once it's complete, click on the application URL again, proceed to the web dashboard, and sign in with the credentials you configured in <em class="italic">step 2</em>. Click on the application icon, and it should open up the dashboard for you. </li>
			</ol>
			<p>Congratulations! You<a id="_idIndexMarker894"/> are all set up with the Fleet Hub dashboard!</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Although we have only created one user for this lab, you can integrate AWS SSO with your organization's identity management systems such as Active Directory. This will allow role-based access to the dashboard for different personas. Ideally, this configuration will fall under the purview of identity engineers and won't be the responsibility of the IoT professionals. </p>
			<p>Next, let's set up the routing rules for ingesting the telemetry data from the HBS hub to the cloud:</p>
			<ol>
				<li value="1">Navigate to the <strong class="bold">Amazon EventBridge</strong> console (<a href="https://go.aws/3xcB2T7">https://go.aws/3xcB2T7</a>), and click on <strong class="bold">Create rule</strong>.</li>
				<li>Choose a name and description for the rule.</li>
				<li>In the <strong class="bold">Define pattern</strong> section, configure the following:<ul><li>Check the event pattern and predefined pattern by service.</li><li>Service provider: <strong class="source-inline">AWS</strong>.</li><li>Service name: <strong class="source-inline">Greengrass</strong>.</li><li>Event type: <strong class="source-inline">Greengrass Telemetry Data</strong>.</li></ul></li>
				<li>Keep the <strong class="bold">Select an Event Bus</strong> section in its default setting.</li>
				<li>Under <strong class="bold">Select targets</strong>, configure the target to be a CloudWatch group:<ul><li><strong class="bold">Target</strong>: CloudWatch log group</li><li><strong class="bold">Log Group</strong>: <strong class="source-inline">/aws/events/</strong>&lt;replace this with a name of your choice&gt;</li></ul></li>
				<li>Keep everything else in its default setting and click on <strong class="bold">Create</strong>.</li>
			</ol>
			<p>Great work! EventBridge is all set to ingest telemetry data and publish it to the CloudWatch group. </p>
			<p>We will revisit these dashboards again at the end of the lab to visualize the collected data from<a id="_idIndexMarker895"/> the hubs. For now, let's switch gears to configure and deploy the edge connectors on Greengrass.</p>
			<h2 id="_idParaDest-189"><a id="_idTextAnchor193"/>Deploying the components from the cloud to the edge</h2>
			<p>In this <a id="_idIndexMarker896"/>section, you will learn how to deploy the <strong class="bold">Nucleus Emitter</strong> and <strong class="bold">Log Manager</strong> agents to a Greengrass-enabled HBS hub, to publish the health telemetry to the cloud. Perform the following steps:</p>
			<ol>
				<li value="1">Please navigate to the Amazon Greengrass console and choose <strong class="bold">Deployments</strong>. Choose the existing deployment, and click on <strong class="bold">Revise</strong>. On the <strong class="bold">Select Components</strong> page, in the <strong class="bold">Public components</strong> section, search for and select the <strong class="source-inline">aws.greengrass.telemetry.NucleusEmitter</strong> and <strong class="source-inline">aws.greengrass.LogManager</strong> components. Feel free to click on <strong class="bold">View recipe</strong> to review the configuration of this component. </li>
				<li>Click on <strong class="bold">Next</strong> by keeping all the previous components along with the preceding two components selected. Keep the other options in their default settings in the following screens and choose <strong class="bold">Deploy</strong>. </li>
			</ol>
			<h2 id="_idParaDest-190"><a id="_idTextAnchor194"/>Visualizing the results </h2>
			<p>Now you have <a id="_idIndexMarker897"/>set up the fleet hub and deployed the agents on the edge, you can visualize the health telemetry data using the following steps: </p>
			<ol>
				<li value="1">Navigate to <strong class="bold">AWS IoT Core Console</strong>, click on <strong class="bold">Fleet Hub</strong>, and select the application you created earlier in the lab. </li>
				<li>In the <strong class="bold">Device list</strong> section, click on the Greengrass-enabled HBS hub device. You will be able to view the status of the device along with various other attributes such as the field attributes, the device shadow file (that is, the device state if configured), the group to which the device belongs, and the history of the deployments (that is, the jobs).</li>
				<li>Navigate back to the home screen. Feel free to play with the search and filter options provided at the top of the screen to refine your results. Generally, this is useful when you have a large number of gateways and associated devices. You can also flip to the <strong class="bold">Summary</strong> section to visualize the total number of devices by thing types, the thing groups, and the reasons to disconnect.</li>
				<li>Click on <strong class="bold">Create alarm</strong>. This will help you set up notifications for the following breach:<ol><li>Choose a field: <strong class="bold">Disconnect Reason</strong>.</li><li>Choose an aggregation type: <strong class="bold">Count</strong>.</li><li>Choose a <strong class="bold">Period</strong> setting of <strong class="bold">5 minutes</strong>, then click on <strong class="bold">Next</strong>.</li><li>Choose the <strong class="bold">Metric</strong> setting to be <strong class="bold">Greater/Equal than 1</strong>, then click on <strong class="bold">Next</strong>.</li><li>Assuming you have only one device gateway, you can increase the count if you have more.</li><li>Configure the notify and alarm details, then click on <strong class="bold">Next and Submit</strong>.</li></ol><p>Therefore, as a fleet operator, you can now visualize the health of your device fleet along with being alarmed for threshold breaches.</p></li>
				<li>Navigate to the <strong class="bold">AWS CloudWatch</strong> console, click on <strong class="bold">Logs</strong> and then select <strong class="bold">Log groups</strong>.</li>
				<li>Search for and click on the <strong class="source-inline">/aws/events/&lt;replace this with a name of your choice&gt; log group</strong>, and visualize the log streams.</li>
				<li>It might take some time to populate, but the log streams should show the telemetry data collected from the Greengrass hub device. </li>
				<li>Feel free to play with <strong class="bold">Log Insights</strong>, which allows you to analyze the logs through a query interface. </li>
			</ol>
			<p>So far, you have learned how to operate a fleet of Greengrass-enabled devices using AWS native solutions. These patterns are also applicable for non-Greengrass devices, for example, the devices that leverage other devices' SDKs (such as <em class="italic">AWS IoT Device SDK</em> or <em class="italic">FreeRTOS</em>). </p>
			<p class="callout-heading">Challenge Zone</p>
			<p class="callout">I would like to throw a quick challenge for you to determine how you can trigger an OTA job from AWS IoT Fleet Hub to a specific HBS hub device. This can be useful when you have to push an update such as a configuration file that is required during an <a id="_idIndexMarker898"/>operational event. Best of luck!</p>
			<p>Let's wrap up this chapter with a quick summary and a set of knowledge-check questions.</p>
			<h1 id="_idParaDest-191"><a id="_idTextAnchor195"/>Summary </h1>
			<p>In this chapter, you were introduced to design patterns and the best practices of onboarding, managing, and maintaining a fleet of devices. These practices can help you to provision and operate millions (or more) of connected devices across different geographic locations. Additionally, you learned how to diagnose edge devices remotely for common problems or tunnel in securely for advanced troubleshooting. Following this, you implemented an edge-to-cloud architecture, leveraging various AWS-built components and services. This allowed you to collect health telemetry from the HBS hubs, which a fleet operator can visualize through dashboards, be notified through alarms, or take action as required. </p>
			<p>In the next and final chapter, we will summarize all the key lessons that you have learned throughout the book (and more), so you are all set to build well-architected solutions for the real world.</p>
			<h1 id="_idParaDest-192"><a id="_idTextAnchor196"/>Knowledge check</h1>
			<p>Before moving on to the next chapter, test your knowledge by answering these questions. The answers can be found at the end of the book:</p>
			<ol>
				<li value="1">True or false: Device registration and device activation are the same.</li>
				<li>What are the different ways to leverage a CA with AWS IoT Greengrass?</li>
				<li>Is there an option to provision devices in real time? If yes, then what is it? </li>
				<li>True or false: Metrics and logs are the only data points required to monitor an IoT workload.</li>
				<li>What do you think is a benefit of having a single-pane-of-glass view for your entire fleet of devices?</li>
				<li>What is a mitigation strategy for remote troubleshooting devices without sending technicians if required? (Hint: think tunnel.)</li>
				<li>What components does AWS IoT Greengrass provide to collect system  health telemetry? </li>
				<li>True or false: Aggregation of metrics on the edge device is not possible. It can only be done in the cloud.</li>
			</ol>
			<h1 id="_idParaDest-193"><a id="_idTextAnchor197"/>References</h1>
			<p>Take a look at the following resources for additional information on the concepts discussed in this chapter:</p>
			<ul>
				<li>Whitepaper on <em class="italic">Device Manufacturing and Provisioning with X.509 Certificates in AWS IoT Core</em>: <a href="https://d1.awsstatic.com/whitepapers/device-manufacturing-provisioning.pdf">https://d1.awsstatic.com/whitepapers/device-manufacturing-provisioning.pdf</a></li>
				<li>When to use AWS IoT device management: <a href="https://aws.amazon.com/iot-device-management/">https://aws.amazon.com/iot-device-management/</a></li>
				<li>The AWS IoT Greengrass launch of fleet management capabilities: <a href="https://aws.amazon.com/about-aws/whats-new/2021/08/aws-iot-greengrass-v-2-4/">https://aws.amazon.com/about-aws/whats-new/2021/08/aws-iot-greengrass-v-2-4/</a></li>
				<li>Fleet Hub for AWS IoT Device Management: <a href="https://docs.aws.amazon.com/iot/latest/fleethubuserguide/what-is-aws-iot-monitor.html">https://docs.aws.amazon.com/iot/latest/fleethubuserguide/what-is-aws-iot-monitor.html</a></li>
				<li>AWS IoT thing groups: <a href="https://docs.aws.amazon.com/iot/latest/developerguide/thing-groups.html">https://docs.aws.amazon.com/iot/latest/developerguide/thing-groups.html</a></li>
			</ul>
		</div>
	</div></body></html>