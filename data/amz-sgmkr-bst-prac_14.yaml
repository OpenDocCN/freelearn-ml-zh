- en: 'Chapter 11: Monitoring Production Models with Amazon SageMaker Model Monitor
    and Clarify'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第11章：使用Amazon SageMaker Model Monitor和Clarify监控生产模型
- en: Monitoring production **machine learning** (**ML**) models is a critical step
    to ensure that the models continue to meet business needs. Besides the infrastructure
    hosting the model, there are other important aspects of ML models that should
    be monitored regularly. As models age over a period of time, the real-world inference
    data distribution may change as compared to the data used for training the model.
    For example, consumer purchase patterns may change in the retail industry and
    economic conditions such as mortgage rates may change in the financial industry.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 监控生产**机器学习**（**ML**）模型是确保模型持续满足业务需求的关键步骤。除了托管模型的底层基础设施外，还有其他重要的ML模型方面需要定期监控。随着时间的推移，模型老化，与用于训练模型的相比，实际推理数据分布可能会发生变化。例如，零售行业的消费者购买模式可能会改变，金融行业的抵押贷款利率等经济条件可能会改变。
- en: This gradual misalignment between the training and the live inference datasets
    can have a big impact on model predictions. Model quality metrics such as accuracy
    may degrade over time as well. Degraded model quality has a negative impact on
    business outcomes. Regulatory requirements, such as ensuring that ML models are
    unbiased and explainable, add another angle to model monitoring. Comprehensive
    monitoring of production models for these aspects allows you to proactively identify
    if and when a production model needs to be updated. Updating a production model
    needs both retraining and deployment resources. The costs involved in updating
    a production model should be weighed against the opportunity costs of effectively
    serving the model consumers.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 训练数据和实时推理数据集之间的这种逐渐偏差可能会对模型预测产生重大影响。模型质量指标，如准确性，也可能随着时间的推移而下降。模型质量的下降会对业务结果产生负面影响。监管要求，如确保ML模型无偏见且可解释，为模型监控增添了另一个角度。对这些方面的全面监控生产模型，让您能够主动识别生产模型是否需要更新。更新生产模型需要重新训练和部署资源。更新生产模型涉及的成本应与有效服务模型消费者的机会成本进行权衡。
- en: This chapter addresses the challenge of monitoring production models using two
    managed services – **Amazon SageMaker Model Monitor** and **Amazon SageMaker Clarify**.
    These managed services eliminate the need to build custom tooling to monitor models
    and detect when corrective actions need to be taken. By the end of this chapter,
    you will be able to monitor production models for data drift, model quality, model
    bias, and model explainability. You will further learn how to automate remediation
    actions for the issues detected during monitoring.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章通过使用两个托管服务——**Amazon SageMaker Model Monitor**和**Amazon SageMaker Clarify**，来解决监控生产模型的挑战。这些托管服务消除了构建自定义工具以监控模型和检测何时需要采取纠正措施的需求。在本章结束时，您将能够监控生产模型的数据漂移、模型质量、模型偏差和模型可解释性。您还将进一步了解如何在监控过程中自动修复检测到的问题。
- en: 'In this chapter, we are going to cover the following main topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主要内容：
- en: Basic concepts of Amazon SageMaker Model Monitor and Amazon SageMaker Clarify
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Amazon SageMaker Model Monitor和Amazon SageMaker Clarify的基本概念
- en: End-to-end architectures for monitoring ML models
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控ML模型的全栈架构
- en: Best practices for monitoring ML models
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控ML模型的最佳实践
- en: Technical requirements
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: You will need an AWS account to run the examples included in this chapter. If
    you have not set up the data science environment yet, please refer to [*Chapter
    2*](B17249_02_Final_JM_ePub.xhtml#_idTextAnchor039), *Data Science Environments*,
    which walks you through the setup process.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要AWS账户才能运行本章包含的示例。如果您尚未设置数据科学环境，请参阅[*第2章*](B17249_02_Final_JM_ePub.xhtml#_idTextAnchor039)，*数据科学环境*，其中将指导您完成设置过程。
- en: The code examples included in the book are available on GitHub at [https://github.com/PacktPublishing/Amazon-SageMaker-Best-Practices/tree/main/Chapter11](https://github.com/PacktPublishing/Amazon-SageMaker-Best-Practices/tree/main/Chapter11).
    You will need to install a Git client to access them ([https://git-scm.com/](https://git-scm.com/)).
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 书中包含的代码示例可在GitHub上找到，网址为[https://github.com/PacktPublishing/Amazon-SageMaker-Best-Practices/tree/main/Chapter11](https://github.com/PacktPublishing/Amazon-SageMaker-Best-Practices/tree/main/Chapter11)。您需要安装Git客户端才能访问它们（[https://git-scm.com/](https://git-scm.com/))。
- en: Basic concepts of Amazon SageMaker Model Monitor and Amazon SageMaker Clarify
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Amazon SageMaker Model Monitor和Amazon SageMaker Clarify的基本概念
- en: 'In this section, let''s review the capabilities provided by two SageMaker features:
    Model Monitor and Clarify.'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，让我们回顾两个 SageMaker 功能提供的功能：Model Monitor 和 Clarify。
- en: 'Amazon SageMaker Model Monitor provides capabilities to monitor data drift
    and the model quality of models deployed as SageMaker real-time endpoints. Amazon
    SageMaker Clarify provides capabilities to monitor the deployed model for bias
    and feature attribution drift. Using a combination of these two features, you
    can monitor the following four different aspects of ML models deployed on SageMaker:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: Amazon SageMaker Model Monitor 提供了监控作为 SageMaker 实时端点部署的模型的数据漂移和模型质量的功能。Amazon
    SageMaker Clarify 提供了监控部署模型是否存在偏差和特征归因漂移的功能。通过结合这两个功能，您可以监控在 SageMaker 上部署的机器学习模型的以下四个不同方面：
- en: '**Data drift**: If the live inference traffic data served by the deployed model
    is statistically different from the training data the model was trained on, the
    model prediction accuracy will start to deteriorate. Using a combination of a
    training data baseline and periodic monitoring to compare the incoming inference
    requests with the baseline data, SageMaker Model Monitor detects data drift. Model
    Monitor further generates data drift metrics that are integrated with Amazon CloudWatch.
    Using these CloudWatch alerts, you can generate data drift detection alerts.'
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**数据漂移**：如果部署的模型提供的实时推理流量数据在统计上与模型训练时所用的训练数据不同，模型预测的准确性将开始下降。通过结合训练数据基线和定期监控来比较传入的推理请求与基线数据，SageMaker
    Model Monitor 检测数据漂移。Model Monitor 进一步生成与 Amazon CloudWatch 集成的数据漂移指标。使用这些 CloudWatch
    警报，您可以生成数据漂移检测警报。'
- en: '**Model quality**: Monitoring model quality involves comparing labels predicted
    by a model to the actual labels, also called the ground truth inference labels.
    Model Monitor periodically merges data captured from real-time inferences with
    the ground truth labels to compare model quality drift against a baseline generated
    with training data. Similar to data drift metrics, model quality metrics are integrated
    with CloudWatch, so alerts can be generated if the model quality falls below a
    threshold.'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**模型质量**：监控模型质量涉及将模型预测的标签与实际标签（也称为真实推理标签）进行比较。Model Monitor 定期将来自实时推理的数据与真实标签合并，以比较模型质量漂移与使用训练数据生成的基线。与数据漂移指标类似，模型质量指标集成到
    CloudWatch 中，因此如果模型质量低于阈值，可以生成警报。'
- en: '**Bias drift**: Statistically, significant drift between the live inference
    traffic data and the training data could also result in bias in the model over
    a period of time. This could happen even after detecting and addressing bias in
    the training data before training and deploying the model. SageMaker Clarify continuously
    monitors a deployed model for bias and generates bias metrics that are integrated
    with CloudWatch metrics.'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**偏差漂移**：在实时推理流量数据和训练数据之间存在统计上显著的漂移也可能导致模型在一段时间内出现偏差。即使检测并解决了在训练和部署模型之前训练数据中的偏差，这也可能发生。SageMaker
    Clarify 持续监控部署的模型是否存在偏差，并生成与 CloudWatch 指标集成的偏差指标。'
- en: '**Feature attribution drift**: Along with introducing bias in deployed models,
    drift in live inference data distribution can also cause drift in feature attribution
    values. Feature attribution ranks the individual features of a dataset according
    to their relative importance to a model trained using that dataset using an importance
    score. The feature importance score provides one way of explaining the model predictions
    by providing insight into which features played a role in making predictions.
    SageMaker Clarify compares the feature attribution or feature rankings in the
    training data to the feature attribution or feature rankings in live inference
    traffic data. Similar to other types of monitoring, feature attribution drift
    metrics are generated and integrated with CloudWatch.'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**特征归因漂移**：除了在部署的模型中引入偏差外，实时推理数据分布的漂移也可能导致特征归因值的变化。特征归因根据使用该数据集训练的模型中各个特征的相对重要性，使用重要性分数对数据集的各个特征进行排名。特征重要性分数提供了一种通过提供对哪些特征在预测中起作用的洞察来解释模型预测的方法。SageMaker
    Clarify 将训练数据中的特征归因或特征排名与实时推理流量数据中的特征归因或特征排名进行比较。与其他类型的监控类似，特征归因漂移指标被生成并集成到 CloudWatch
    中。'
- en: 'Monitoring an ML model with SageMaker Model Monitor or SageMaker Clarify involves
    four high-level steps, as shown in the following diagram:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 SageMaker Model Monitor 或 SageMaker Clarify 监控机器学习模型涉及以下四个高级步骤，如下所示图示：
- en: '![Figure 11.1 – High-level steps for model monitoring'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 11.1 – 模型监控的高级步骤'
- en: '](img/B17249_11_01.jpg)'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/B17249_11_01.jpg)'
- en: Figure 11.1 – High-level steps for model monitoring
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.1 – 模型监控的高级步骤
- en: 'Let''s see what is involved in each of these steps in a bit more detail:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们更详细地看看这些步骤中涉及的内容：
- en: '**Enable data capture**: The first step is to enable data capture on the real-time
    endpoint. On enabling data capture, input to and output from the SageMaker endpoint
    is captured and saved in Amazon **Simple Storage Service** (**S3**). Input captured
    includes the live inference traffic requests and output captured includes predictions
    from the deployed model. This is a common step for all four types of monitoring:
    data drift, model quality, bias drift, and feature attribution drift monitoring.'
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**启用数据捕获**：第一步是在实时端点上启用数据捕获。启用数据捕获后，SageMaker端点的输入和输出将被捕获并保存在Amazon **简单存储服务**（**S3**）中。捕获的输入包括实时推理流量请求，捕获的输出包括部署的模型的预测。这是所有四种类型监控的共同步骤：数据漂移、模型质量、偏差漂移和特征归因漂移监控。'
- en: '**Generate baseline**: In this step, the training or validation data is analyzed
    to generate a baseline. The baseline generated will be further used in the next
    step to compare against the live inference traffic. The baseline generation process
    computes metrics about the data analyzed and suggests constraints for the metrics.
    The baseline generated is unique to the type of monitoring.'
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**生成基线**：在这个步骤中，分析训练或验证数据以生成基线。生成的基线将在下一步中用于与实时推理流量进行比较。基线生成过程计算分析数据的指标，并为指标提出约束。生成的基线对于监控类型是唯一的。'
- en: '**Schedule and execute monitoring job**: To continuously monitor the real-time
    endpoint, the next step is to create a monitoring schedule to execute at a predefined
    interval. Once the monitoring schedule is in place, SageMaker Processing jobs
    are automatically kicked off to analyze the data captured from the endpoint in
    a specific interval. For each execution of the monitoring job, the processing
    job compares live traffic data captured with the baseline. If the metrics generated
    on the live traffic data captured in a period are outside the range of constraints
    suggested by the baseline, a violation is generated. The scheduled monitoring
    jobs also generate monitoring reports for each execution, which are saved in an
    S3 bucket. Additionally, CloudWatch metrics are also generated, the exact metrics
    being unique to the type of monitoring.'
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**安排和执行监控作业**：为了持续监控实时端点，下一步是创建一个预定义间隔执行的监控计划。一旦监控计划就绪，SageMaker Processing作业将自动启动，以特定间隔分析从端点捕获的数据。对于监控作业的每次执行，处理作业将比较捕获的实时流量数据与基线。如果在某个时间段内捕获的实时流量数据生成的指标超出了基线建议的约束范围，将生成违规。计划中的监控作业还会为每次执行生成监控报告，这些报告保存在S3桶中。此外，还会生成CloudWatch指标，这些指标的具体指标取决于监控的类型。'
- en: '**Analyze and act on results**: Reports generated by the monitoring job can
    either be downloaded directly from S3 or visualized in a SageMaker Studio environment.
    In the Studio environment, you can also visualize the details of the monitoring
    jobs and create charts that compare the baseline metrics with the metrics calculated
    by the monitoring job.'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**分析和采取行动**：由监控作业生成的报告可以直接从S3下载或在SageMaker Studio环境中可视化。在Studio环境中，您还可以可视化监控作业的详细信息，并创建比较基线指标与监控作业计算的指标的图表。'
- en: To remediate issues discovered, you can use the CloudWatch metrics emitted from
    the monitoring job. The specific metrics depend on the type of the monitoring
    job. You can configure CloudWatch alerts for these metrics, based on the threshold
    values suggested by the baseline job. CloudWatch alerts allow you to automate
    responses to violations and metrics generated by monitoring jobs.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 为了修复发现的问题，您可以使用监控作业发出的CloudWatch指标。具体的指标取决于监控作业的类型。您可以根据基线作业建议的阈值值配置CloudWatch警报，CloudWatch警报允许您自动响应监控作业生成的违规和指标。
- en: Now that you know what aspects of an ML model can be monitored, what the steps
    involved in monitoring are, and how you can respond to the issues discovered,
    you can build a monitoring solution that meets your business needs. In the next
    section, you will learn how to build end-to-end model monitoring architectures
    for the different types of monitoring.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您已经知道了可以监控ML模型的哪些方面，监控涉及的步骤以及如何应对发现的问题，您就可以构建一个满足您业务需求的监控解决方案。在下一节中，您将学习如何为不同类型的监控构建端到端模型监控架构。
- en: End-to-end architectures for monitoring ML models
  id: totrans-29
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控机器学习模型的端到端架构
- en: In this section, you will put together the four high-level steps of monitoring
    to build end-to-end architectures for **data drift**, **model quality**, **bias
    drift**, and **feature attribution drift monitoring**. Along with the architecture,
    you will dive into the unique aspects of the individual steps as applicable to
    each type of monitoring.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，您将组合监控的四个高级步骤，以构建**数据漂移**、**模型质量**、**偏差漂移**和**特征归因漂移监控**的端到端架构。除了架构之外，您还将深入了解适用于每种监控类型的各个步骤的独特方面。
- en: For all four types of monitoring, the first and last steps – enabling data capture
    and analyzing monitoring results – remain the same. We will discuss these two
    steps in detail for the first type of monitoring – data drift monitoring. For
    the other three types of monitoring, we will only briefly mention them.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 对于所有四种类型的监控，第一步和最后一步——启用数据捕获和分析监控结果——保持不变。我们将详细讨论第一种监控类型——数据漂移监控的这两个步骤。对于其他三种类型的监控，我们只会简要提及。
- en: Data drift monitoring
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 数据漂移监控
- en: 'You monitor a production model for data drift to ensure that the distribution
    of the live inference traffic the deployed model is serving does not drift away
    from the distribution of the dataset used for training the model. The end-to-end
    architecture for the monitoring model for data drift is shown in the following
    diagram:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 您监控生产模型以检测数据漂移，以确保部署的模型所服务的实时推理流量的分布不会偏离用于训练模型的数据集的分布。以下图表显示了用于数据漂移监控的端到端架构：
- en: '![Figure 11.2 – Data drift monitoring: end-to-end architecture'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '![图11.2 – 数据漂移监控：端到端架构](img/B17249_11_02.jpg)'
- en: '](img/B17249_11_02.jpg)'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: '![图11.2 – 数据漂移监控：端到端架构](img/B17249_11_02.jpg)'
- en: 'Figure 11.2 – Data drift monitoring: end-to-end architecture'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: '![图11.2 – 数据漂移监控：端到端架构](img/B17249_11_02.jpg)'
- en: 'Let''s dive into the four high-level steps involved in this end-to-end architecture:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们深入了解构成此端到端架构的四个高级步骤：
- en: '**Enable data capture for the deployed endpoint**: The first step is to deploy
    a SageMaker endpoint with data capture enabled. As you can see from the following
    sample code, configuring data capture includes specifying the percentage of inference
    traffic to capture and the S3 location to save the captured traffic:'
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**为部署的端点启用数据捕获**：第一步是部署一个启用数据捕获的SageMaker端点。如以下示例代码所示，配置数据捕获包括指定要捕获的推理流量的百分比和保存捕获流量的S3位置：'
- en: '[PRE0]'
  id: totrans-39
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To deploy the model, create the endpoint by passing in the data capture configuration
    as follows:'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 部署模型时，通过以下方式创建端点，并传入数据捕获配置：
- en: '[PRE1]'
  id: totrans-41
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The following code shows a sample of the data captured. As you can see, both
    the request to and response from the endpoint along with event metadata are captured:'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 以下代码显示了捕获的数据样本。如您所见，端点请求和响应以及事件元数据都被捕获了：
- en: '[PRE2]'
  id: totrans-43
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '`DefaultModelMonitor` to configure the infrastructure to execute the processing
    job on and the maximum runtime. Sample code is shown as follows:'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`DefaultModelMonitor`来配置执行处理作业的基础设施和最大运行时间。以下是一个示例代码：
- en: '[PRE3]'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Use the `suggest_baseline` method on `DefaultModelMonitor` to configure and
    kick off the baseline job. To configure the baseline job, specify where the baseline
    data is and where you want the baseline results to be saved in S3, as follows:'
  id: totrans-46
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 使用`DefaultModelMonitor`上的`suggest_baseline`方法来配置并启动基线作业。要配置基线作业，指定基线数据的位置以及您希望将基线结果保存到S3的位置，如下所示：
- en: '[PRE4]'
  id: totrans-47
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The baseline job results in two files – `statistics.json` and `constraints.json`
    – saved in the S3 location you specified. The `statistics.json` file includes
    metadata analysis of the training data – such as sum, mean, min, and max values
    for numerical features and distinct counts for text features.
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 基线作业会在您指定的S3位置生成两个文件——`statistics.json`和`constraints.json`。`statistics.json`文件包括对训练数据的元数据分析——例如数值特征的求和、平均值、最小值和最大值以及文本特征的唯一计数。
- en: Note
  id: totrans-49
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: 'This baseline job uses a SageMaker-provided container called `sagemaker-model-monitor-analyzer`
    to analyze the training dataset. This Spark-based container uses the open source
    `constraints.json` file captures the thresholds for the statistics for monitoring
    purposes. The constraints also include conditions such as whether a particular
    feature should be considered a string, not an integer or whether a specific field
    should be not-null. The following screenshot shows a sample of constraints generated
    by the baseline job, which indicates that the `value` feature should always be
    treated as a string:'
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此基线作业使用SageMaker提供的名为`sagemaker-model-monitor-analyzer`的容器来分析训练数据集。这个基于Spark的容器使用开源的`constraints.json`文件捕获用于监控目的的统计阈值。约束还包括条件，例如是否应将特定特征视为字符串而不是整数，或者是否特定字段不应为空。以下截图显示了基线作业生成的约束样本，表明`value`特征应始终被视为字符串：
- en: '![Figure 11.5 – Constraints generated by the data drift baseline job'
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![Figure 11.5 – 数据漂移基线作业生成的约束]'
- en: '](img/B17249_11_05.jpg)'
  id: totrans-52
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![img/B17249_11_05.jpg]'
- en: Figure 11.5 – Constraints generated by the data drift baseline job
  id: totrans-53
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图11.5 – 数据漂移基线作业生成的约束
- en: The generated constraints also suggest completeness for each feature, which
    represents the percentage of values that can be non-null in the inference traffic.
    In this example, since completeness for all features is at `1.0`, there cannot
    be any null values of these features in the inference traffic. Additionally, as
    suggested by `num_constraints.is_non_negative`, none of the integral and fractional
    features can be null.
  id: totrans-54
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 生成的约束还表明了每个特征的完整性，这代表了在推理流量中可以非空值的百分比。在这个例子中，由于所有特征的完整性都是`1.0`，因此在推理流量中这些特征的任何值都不能为空。此外，根据`num_constraints.is_non_negative`的建议，没有任何整数和小数特征可以为空。
- en: 'The constraints generated are suggestions provided by the baseline job after
    analyzing the training data. You can choose to override the constraint file based
    on the domain knowledge you have about your specific use case. You can override
    the suggested constraint at the individual field level or override the entire
    file. In the `constraints.json` file, you will also see an `emit_metrics : Enabled`
    entry. This suggests that CloudWatch metrics will be emitted during monitoring.'
  id: totrans-55
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '生成的约束是基线作业在分析训练数据后提供的建议。您可以根据您对特定用例的领域知识选择覆盖约束文件。您可以在单个字段级别覆盖建议的约束，或者覆盖整个文件。在`constraints.json`文件中，您还会看到`emit_metrics
    : Enabled`条目。这表明在监控期间将发出CloudWatch指标。'
- en: '`Completeness` and `BaselineDrift`. The `Completeness` metric indicates the
    percentage of values that can be null for a given feature in a specific interval.
    The `BaselineDrift` metric indicates how much a feature has drifted in a specific
    interval from the baseline. Additionally, for numerical features, a few other
    metrics emitted are `Max`, `Min`, `Sum`, `SampleCount`, and `AverageCount`, as
    observed during the interval.'
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`完整性`和`基线漂移`。`完整性`指标表示在特定区间内给定特征可以null的值的百分比。`基线漂移`指标表示特征在特定区间内相对于基线的漂移程度。此外，对于数值特征，在区间内观察到的其他一些指标是`最大值`、`最小值`、`总和`、`样本计数`和`平均计数`。'
- en: For any of these metrics, you can configure a CloudWatch alert to be triggered
    based on threshold values suggested in the constraints file. If the feature values
    in the inference traffic observed during a given interval violate the threshold
    values, an alert is raised.
  id: totrans-57
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对于这些指标中的任何一个，您都可以根据约束文件中建议的阈值值配置CloudWatch警报。如果在给定区间内观察到的推理流量中的特征值违反了阈值值，则会触发警报。
- en: '**Analyze and act on results**: The final step is to analyze and act on the
    monitoring results. As mentioned in the high-level monitoring steps discussion
    earlier, you can download the monitoring reports from S3 and analyze them in your
    notebook environment or use Studio to view the monitoring details. For example,
    downloading the violation report to a notebook environment and viewing the report
    contents shows results similar to the following screenshot:'
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**分析和采取行动**：最后一步是对监控结果进行分析并采取行动。如前所述的高层次监控步骤讨论中提到，您可以从S3下载监控报告并在您的笔记本环境中分析它们，或者使用Studio查看监控细节。例如，将违规报告下载到笔记本环境中并查看报告内容，显示的结果类似于以下截图：'
- en: '![Figure 11.7 – Violations generated by the data drift monitoring job'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '![Figure 11.7 – 数据漂移监控作业生成的违规]'
- en: '](img/B17249_11_07.jpg)'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '![img/B17249_11_07.jpg]'
- en: Figure 11.7 – Violations generated by the data drift monitoring job
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.7 – 数据漂移监控作业生成的违规
- en: You can decide what actions you want to take on these alerts according to your
    business and operational requirements. You can automate actions such as updating
    the model, updating your training data, and retraining and updating the model
    as a response to the CloudWatch alert triggered.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以根据您的业务和运营需求决定对这些警报采取什么行动。您可以根据 CloudWatch 警报触发的响应自动执行操作，如更新模型、更新您的训练数据以及重新训练和更新模型。
- en: Important note
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: An example notebook that provides a complete walk-through of using SageMaker
    Model Monitor for data drift monitoring is provided in the GitHub repo [https://gitlab.com/randydefauw/packt_book/-/blob/main/CH10/data_drift_monitoring/WeatherPredictionDataDriftModelMonitoring.ipynb](https://gitlab.com/randydefauw/packt_book/-/blob/main/CH10/data_drift_monitoring/WeatherPredictionDataDriftModelMonitoring.ipynb).
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: GitHub 仓库 [https://gitlab.com/randydefauw/packt_book/-/blob/main/CH10/data_drift_monitoring/WeatherPredictionDataDriftModelMonitoring.ipynb](https://gitlab.com/randydefauw/packt_book/-/blob/main/CH10/data_drift_monitoring/WeatherPredictionDataDriftModelMonitoring.ipynb)
    中提供了一个示例笔记本，该笔记本提供了使用 SageMaker Model Monitor 进行数据漂移监控的完整教程。
- en: Model quality drift monitoring
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 模型质量漂移监控
- en: You monitor the quality of a production model to ensure that the performance
    of the production model continues to meet your requirements. Model quality is
    measured by different metrics depending on the type of the underlying ML problem.
    For example, for classification problems, accuracy or recall are good metrics
    and **root mean square error** (**RMSE**) is a metric to use with regression problems.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 您监控生产模型的性能，以确保生产模型的性能持续满足您的需求。模型质量根据底层机器学习问题的类型通过不同的指标来衡量。例如，对于分类问题，准确率或召回率是好的指标，**均方根误差**（**RMSE**）是用于回归问题的指标。
- en: 'The end-to-end architecture for monitoring a model for model quality drift
    is shown in the following diagram:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 监控模型质量漂移的端到端架构如下所示：
- en: '![Figure 11.8 – Model quality monitoring: end-to-end architecture'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 11.8 – 模型质量监控：端到端架构](img/B17249_11_08.jpg)'
- en: '](img/B17249_11_08.jpg)'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: '![img/B17249_11_08.jpg](img/B17249_11_08.jpg)'
- en: 'Figure 11.8 – Model quality monitoring: end-to-end architecture'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11.8 – 模型质量监控：端到端架构
- en: 'The architecture is very similar to data drift monitoring with an additional
    step for merging the actual inference ground truth labels in an S3 bucket with
    the model predictions. Let''s dive into the four high-level steps involved in
    this end-to-end architecture:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 架构与数据漂移监控非常相似，但增加了一个步骤，将实际推理真实标签与模型预测合并到一个 S3 存储桶中。让我们深入了解这个端到端架构中的四个高级步骤：
- en: '**Enable data capture for the deployed endpoint**: The first step is to deploy
    a SageMaker endpoint with data capture enabled and capture predictions made by
    the model in an S3 bucket.'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**为部署的端点启用数据捕获**：第一步是部署一个启用数据捕获的 SageMaker 端点，并在 S3 存储桶中捕获模型做出的预测。'
- en: '`probability`, `prediction`, and `label`. While `probability` is the values
    returned by the model, `prediction` is inferred from the probability based on
    a threshold value. `label` represents the ground truth label from the validation
    set:'
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`probability`（概率）、`prediction`（预测）和 `label`（标签）。其中 `probability` 是模型返回的值，`prediction`
    是基于阈值值从概率推断出来的。`label` 代表验证集的真实标签：'
- en: '[PRE5]'
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'For model quality monitoring, you use `ModelQualityMonitor` to configure the
    infrastructure to execute the processing jobs and the maximum runtime, as shown
    in the following code:'
  id: totrans-75
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对于模型质量监控，您使用 `ModelQualityMonitor` 配置基础设施以执行处理作业和最大运行时间，如下所示：
- en: '[PRE6]'
  id: totrans-76
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Use the `suggest_baseline` method to configure and kick off the baseline job.
    To configure the baseline job, specify where the baseline data is and where you
    want the baseline results to be saved in S3, as follows:'
  id: totrans-77
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 使用 `suggest_baseline` 方法配置并启动基线作业。要配置基线作业，指定基线数据的位置以及您希望将基线结果保存到 S3 的位置，如下所示：
- en: '[PRE7]'
  id: totrans-78
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: The baseline job results in two files – `statistics.json` and `constraints.json`
    – saved in the S3 location you specified.
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 基线作业生成了两个文件 – `statistics.json` 和 `constraints.json` – 保存在您指定的 S3 位置。
- en: 'The following figure shows the statistics generated by the baseline job:'
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 以下图显示了基线作业生成的统计信息：
- en: '![Figure 11.9 – Statistics generated by the model quality baseline job'
  id: totrans-81
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 11.9 – 模型质量基线作业生成的统计信息](img/B17249_11_09.jpg)'
- en: '](img/B17249_11_09.jpg)'
  id: totrans-82
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![img/B17249_11_09.jpg](img/B17249_11_09.jpg)'
- en: Figure 11.9 – Statistics generated by the model quality baseline job
  id: totrans-83
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 11.9 – 模型质量基线作业生成的统计信息
- en: 'Similarly, the following figure also shows the statistics generated by the
    baseline job:'
  id: totrans-84
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 类似地，以下图也显示了基线作业生成的统计信息：
- en: '![Figure 11.10 – Constraints generated by the model quality baseline job'
  id: totrans-85
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 11.10 – 模型质量基线作业生成的约束'
- en: '](img/B17249_11_10.jpg)'
  id: totrans-86
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B17249_11_10.jpg)'
- en: Figure 11.10 – Constraints generated by the model quality baseline job
  id: totrans-87
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 11.10 – 模型质量基线作业生成的约束
- en: As you can see in *Figure 11.10*, one of the constraints generated is for the
    `rmse` model. It suggests that if the `rmse` value of the production model is
    greater than `3.87145` in any interval, it is an indication that the model quality
    is degrading. If any of the constraints suggested by the baseline job are either
    too restrictive or too lenient for your requirements, you can modify the constraints
    file.
  id: totrans-88
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如您在 *图 11.10* 中所见，生成的约束之一是针对 `rmse` 模型的。它建议，如果生产模型的 `rmse` 值在任何时间间隔内大于 `3.87145`，则表明模型质量正在下降。如果基线作业建议的任何约束对于您的需求来说过于严格或过于宽松，您可以修改约束文件。
- en: '`confusion_matrix`, `recall`, and `precision`.'
  id: totrans-89
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`confusion_matrix`、`recall` 和 `precision`。'
- en: Note
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: For a complete list of metrics generated, please review the SageMaker documentation
    at [https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-metrics.html](https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-metrics.html).
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要查看生成的完整指标列表，请查阅 SageMaker 文档 [https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-metrics.html](https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-metrics.html)。
- en: For any of these metrics, you can configure a CloudWatch alert to be triggered
    based on threshold values suggested in the constraints file. If model predictions
    for the inference traffic observed during a given interval violate the threshold
    values, a CloudWatch alert is raised.
  id: totrans-92
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对于这些指标中的任何一个，您可以根据约束文件中建议的阈值值配置 CloudWatch 警报。如果在给定时间间隔内观察到的推理流量中的模型预测违反了阈值值，则会触发
    CloudWatch 警报。
- en: '**Analyze and act on results**: Finally, to analyze and act on the monitoring
    results, similar to the draft drift monitoring results, you can access the monitoring
    reports directly from S3, visualize them in your notebook or Studio environment,
    and finally, automate responses to the CloudWatch alerts raised.'
  id: totrans-93
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**分析和采取行动**：最后，为了分析和采取监控结果，类似于草稿偏差监控结果，您可以直接从 S3 访问监控报告，在您的笔记本或 Studio 环境中可视化它们，并最终自动化对触发的
    CloudWatch 警报的响应。'
- en: Important note
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 重要提示
- en: An example notebook that provides a complete walk-through of using SageMaker
    Model Monitor for quality model monitoring is provided in the GitHub repo [https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/model_quality_monitoring/WeatherPredictionModelQualityMonitoring.ipynb](https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/model_quality_monitoring/WeatherPredictionModelQualityMonitoring.ipynb).
  id: totrans-95
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: GitHub 仓库 [https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/model_quality_monitoring/WeatherPredictionModelQualityMonitoring.ipynb](https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/model_quality_monitoring/WeatherPredictionModelQualityMonitoring.ipynb)
    中提供了一个示例笔记本，它详细介绍了如何使用 SageMaker Model Monitor 进行质量模型监控。
- en: Bias drift monitoring
  id: totrans-96
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 偏差漂移监控
- en: 'The concept of bias relates to the individual features of a dataset. Bias is
    typically measured for sensitive features called facets to identify whether any
    particular feature or a set of feature values are disproportionately represented
    in the dataset. Amazon Clarify provides capabilities to detect and monitor bias
    in a pre-training dataset and deployed models. The end-to-end architecture to
    monitor deployed models for bias drift is shown in the following diagram:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 偏差的概念与数据集的个体特征相关。偏差通常用于测量敏感特征，称为方面，以确定数据集中是否存在任何特定特征或一组特征值被不成比例地表示。Amazon Clarify
    提供了检测和监控预训练数据集和部署模型中偏差的能力。以下图表显示了用于监控部署模型偏差漂移的端到端架构：
- en: '![Figure 11.11 – Bias drift and feature attribution monitoring: end-to-end
    architecture'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 11.11 – 偏差漂移和特征归因监控：端到端架构'
- en: '](img/B17249_11_11.jpg)'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B17249_11_11.jpg)'
- en: 'Figure 11.11 – Bias drift and feature attribution monitoring: end-to-end architecture'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11.11 – 偏差漂移和特征归因监控：端到端架构
- en: 'Let''s dive into the four high-level steps involved in this end-to-end architecture:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们深入了解这个端到端架构中涉及的四个高级步骤：
- en: '**Enable data capture for the deployed endpoint**: The first step for bias
    drift monitoring remains the same as other types of monitoring – enabling data
    capture while deploying a SageMaker endpoint.'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**为部署的端点启用数据捕获**：偏差漂移监控的第一步与其他类型的监控相同——在部署 SageMaker 端点时启用数据捕获。'
- en: '`DataConfig`. Sample code is as follows:'
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`DataConfig`。以下是一个示例代码：'
- en: '[PRE8]'
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Details of sensitive features along with threshold values considered as bias
    are captured by `BiasConfig`. In the following code, we are monitoring for bias
    drift in the `"City"` feature:'
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '`BiasConfig` 捕获了被认为是偏差的敏感特征及其阈值值的详细信息。在以下代码中，我们正在监控 `"City"` 特征的偏差漂移：'
- en: '[PRE9]'
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'To calculate the bias metrics, a deployed model to execute inferences is necessary.
    `ModelConfig` captures this model''s related information as follows:'
  id: totrans-107
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要计算偏差指标，需要一个部署的模型来执行推理。`ModelConfig` 捕获此模型的相关信息如下：
- en: '[PRE10]'
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Finally, `ModelPredictedLabelConfig` indicates how to extract a predicted label
    from the model output. For example, the following sample code indicates a prediction
    of `1` if the probability returned by the model is above `0.8`:'
  id: totrans-109
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 最后，`ModelPredictedLabelConfig` 指示如何从模型输出中提取预测标签。例如，以下示例代码指示如果模型返回的概率高于 `0.8`，则预测为
    `1`：
- en: '[PRE11]'
  id: totrans-110
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'With `DataConfig`, `BiasConfig`, `ModelConfig`, and `ModelPredictedLabelConfig`
    in hand, you are ready to create and kick off a baseline job. Sample code is as
    follows:'
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 拥有 `DataConfig`、`BiasConfig`、`ModelConfig` 和 `ModelPredictedLabelConfig`，您就可以创建并启动基线作业了。以下是一个示例代码：
- en: '[PRE12]'
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: During the baseline job execution, SageMaker creates a temporary endpoint called
    a **shadow endpoint**. A baselining job runs predictions on the validation dataset,
    calculates bias metrics, and suggests constraints on these metrics. Once the bias
    metrics are computed, the shadow endpoint is deleted.
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在基线作业执行期间，SageMaker 创建一个临时端点，称为**影子端点**。基线作业在验证数据集上运行预测，计算偏差指标，并建议对这些指标的限制。一旦计算了偏差指标，影子端点将被删除。
- en: 'Baseline job execution results in a constraints file that shows the bias metric
    values computed along with the suggested thresholds. A sample of the constraints
    generated is shown here:'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 基线作业执行结果生成一个约束文件，显示计算的偏差指标值以及建议的阈值。以下显示了生成的约束样本：
- en: '[PRE13]'
  id: totrans-115
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: '**Schedule and execute a model quality monitoring job**: The next step is to
    schedule a bias drift monitoring job. In this step, the monitored bias of the
    model will be compared against the baseline generated in the previous step. SageMaker
    executes the bias drift monitoring job using SageMaker Processing periodically
    according to the schedule you specify. The bias drift monitoring job generates
    a monitoring report and constraint violations along with CloudWatch metrics.'
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**安排和执行模型质量监控作业**：下一步是安排偏差漂移监控作业。在此步骤中，将监控的模型偏差与上一步生成的基线进行比较。SageMaker 将根据您指定的计划定期使用
    SageMaker Processing 执行偏差漂移监控作业。偏差漂移监控作业生成监控报告和违反约束，以及 CloudWatch 指标。'
- en: '**Analyze and act on results**: Finally, analyzing the monitoring results and
    taking remedial actions is similar to the previous monitoring types.'
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**分析和采取行动**：最后，分析和采取行动与之前的监控类型相似。'
- en: Implementation of the end-to-end flow of this architecture is provided in the
    notebook. Review the notebook and the results of the execution to view the bias
    metrics generated.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 该架构端到端流程的实现提供在笔记本中。请查看笔记本和执行结果，以查看生成的偏差指标。
- en: Important note
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: An example notebook that provides a complete walk-through of using SageMaker
    Model Monitor for quality model monitoring is provided in the GitHub repo [https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/bias_drift_monitoring/WeatherPredictionBiasDriftMonitoring.ipynb](https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/bias_drift_monitoring/WeatherPredictionBiasDriftMonitoring.ipynb).
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 在 GitHub 仓库 [https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/bias_drift_monitoring/WeatherPredictionBiasDriftMonitoring.ipynb](https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/bias_drift_monitoring/WeatherPredictionBiasDriftMonitoring.ipynb)
    中提供了一个示例笔记本，该笔记本详细介绍了如何使用 SageMaker Model Monitor 进行质量模型监控。
- en: Feature attribution drift monitoring
  id: totrans-121
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 特征归因漂移监控
- en: Feature attribution ranks the individual features of a dataset according to
    their relative importance to a model trained using that dataset using an importance
    score. The feature importance score provides one way of explaining the model predictions
    by providing insight into which features played a role in making predictions.
    With continuous monitoring of the model, you can identify when the feature attribution
    of the live inference traffic starts to drift away from the feature attribution
    of the training dataset.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 特征归因根据使用该数据集训练的模型中各个特征的相对重要性对数据集的各个特征进行排名，使用重要性分数。特征重要性分数提供了一种解释模型预测的方法，通过提供有关哪些特征在做出预测中起作用的见解。通过对模型的持续监控，您可以确定实时推理流量的特征归因何时开始偏离训练数据集的特征归因。
- en: 'The end-to-end flow for monitoring feature attribution drift is the same as
    the flow for bias drift monitoring as previously shown in *Figure 11.11*. Let''s
    dive into the four high-level steps involved in this end-to-end architecture:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 监控特征归因漂移的端到端流程与之前在*图11.11*中显示的偏差漂移监控流程相同。让我们深入了解涉及此端到端架构的四个高级步骤：
- en: '**Enable data capture for the deployed endpoint**: The first step for feature
    attribution drift monitoring remains the same as other types of monitoring – enabling
    data capture while deploying a SageMaker endpoint.'
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**启用部署端点的数据捕获**：特征归因漂移监控的第一步与其他类型的监控相同——在部署SageMaker端点时启用数据捕获。'
- en: '`DataConfig` and `ModelConfig`, which capture the data and model details, are
    the same as for bias drift monitoring.'
  id: totrans-125
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`DataConfig`和`ModelConfig`，它们捕获数据和模型细节，与偏差漂移监控相同。'
- en: 'However, instead of using `BiasConfig` to capture sensitive features, you will
    need to configure `SHAPConfig`, which captures a baseline dataset to use, a number
    of samples to use in the Kernel SHAP algorithm, and a method for determining global
    SHAP values. Sample code is as follows:'
  id: totrans-126
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然而，您将需要配置`SHAPConfig`来捕获敏感特征，而不是使用`BiasConfig`，`SHAPConfig`捕获要使用的基线数据集、在Kernel
    SHAP算法中使用样本的数量以及确定全局SHAP值的方法。以下是一个示例代码：
- en: '[PRE14]'
  id: totrans-127
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'For feature attribution drift monitoring, you use `ModelExplainabilityMonitor`
    to configure the infrastructure to execute the processing jobs and the maximum
    runtime, as shown in the following code. `ModelExplainabilityMonitor` explains
    model predictions using the feature importance score and detects feature attribution
    drift:'
  id: totrans-128
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对于特征归因漂移监控，您使用`ModelExplainabilityMonitor`配置基础设施以执行处理作业和最大运行时间，如下面的代码所示。`ModelExplainabilityMonitor`使用特征重要性分数解释模型预测并检测特征归因漂移：
- en: '[PRE15]'
  id: totrans-129
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'With the different config objects in hand, you can now kick off the baseline
    job as follows:'
  id: totrans-130
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 拥有不同配置对象后，你现在可以启动基线作业，如下所示：
- en: '[PRE16]'
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Baseline job execution results in a constraints file that shows the feature
    importance values computed along with the suggested thresholds. A sample of the
    constraints generated is shown here:'
  id: totrans-132
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 基线作业执行结果生成一个约束文件，显示计算的特征重要性值以及建议的阈值。以下是生成的约束示例：
- en: '[PRE17]'
  id: totrans-133
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: '**Schedule and execute the model quality monitoring job**: The next step to
    schedule a feature attribution monitoring job is similar to scheduling the bias
    drift monitoring job.'
  id: totrans-134
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**安排并执行模型质量监控作业**：安排特征归因监控作业的下一步与安排偏差漂移监控作业类似。'
- en: '`https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/bias_drift_monitoring/WeatherPredictionFeatureAttributionDriftMonitoring
    .ipynb`.'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`https://gitlab.com/randydefauw/packt_book/-/blob/master/CH10/bias_drift_monitoring/WeatherPredictionFeatureAttributionDriftMonitoring
    .ipynb`].'
- en: 'Let''s now summarize the details of the four different monitoring types. The
    following table shows a summary of the monitoring types discussed so far and brings
    focus to the unique aspects of each monitoring type:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们总结四种不同监控类型的详细信息。以下表格显示了迄今为止讨论的监控类型的总结，并关注每种监控类型的独特方面：
- en: '![Figure 11.12 – Summary of model monitoring'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: '![图11.12 – 模型监控概要'
- en: '](img/B17249_Table-02.jpg)'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: '![img/B17249_Table-02.jpg]'
- en: Figure 11.12 – Summary of model monitoring
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.12 – 模型监控概要
- en: Now that you can put together end-to-end architecture for monitoring different
    aspects of deployed models using SageMaker Clarify and Model Monitor, in the next
    section, you will learn the best practices of using these capabilities along with
    some limitations.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您可以使用SageMaker Clarify和Model Monitor构建用于监控部署模型不同方面的端到端架构，在下一节中，您将了解使用这些功能的最佳实践以及一些限制。
- en: Best practices for monitoring ML models
  id: totrans-141
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控机器学习模型的最佳实践
- en: 'This section discusses best practices for monitoring models using SageMaker
    Model Monitor and SageMaker Clarify, taking into consideration the under-the-hood
    operation of these features and a few limitations as they stand at the time of
    publication of this book:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 本节讨论了使用 SageMaker Model Monitor 和 SageMaker Clarify 监控模型的最佳实践，考虑到这些功能的底层操作以及本书出版时的某些限制：
- en: '**Choosing the correct data format**: Model Monitor and Clarify can only monitor
    for drift in tabular data. Therefore, ensure that your training data is in tabular
    format. For other data formats, you will have to build custom monitoring containers.'
  id: totrans-143
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**选择正确的数据格式**：Model Monitor 和 Clarify 只能监控表格数据的漂移。因此，请确保您的训练数据是表格格式。对于其他数据格式，您将不得不构建自定义监控容器。'
- en: '**Choosing real-time endpoints as the mode of model deployment**: Model Monitor
    and Clarify support monitoring for a single-model real-time endpoint. Monitoring
    a model used with batch transform or multi-model endpoints is not supported. So,
    ensure that the model you want to monitor is deployed as a single-model real-time
    endpoint. Additionally, if the model is part of an inference pipeline, the entire
    pipeline is monitored, not the individual models that make up the pipeline.'
  id: totrans-144
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**选择实时端点作为模型部署模式**：Model Monitor 和 Clarify 支持对单个模型实时端点的监控。不支持对用于批量转换或多模型端点的模型进行监控。因此，请确保您想要监控的模型以单个模型实时端点的方式部署。此外，如果模型是推理管道的一部分，则整个管道都会被监控，而不是管道中构成的单个模型。'
- en: '**Choosing sampling data capture – sampling percentage**: When you enable data
    capture on a real-time endpoint, a configuration parameter to pay attention to
    is **sampling percentage**, which indicates what percentage of the live traffic
    is captured. Choosing the values for this metric depends on your use case. It
    is a trade-off between the amount of inference traffic saved and the effectiveness
    of the model monitoring. If the value of this parameter is close to 100, you have
    more information stored, leading to more storage costs, and more data for the
    monitoring job to analyze, leading to a long execution time. On the other hand,
    a higher sampling percentage leads to capturing more inference traffic patterns
    to compare against the baseline.'
  id: totrans-145
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**选择采样数据捕获 - 采样百分比**：当您在实时端点上启用数据捕获时，需要注意的一个配置参数是 **采样百分比**，它表示捕获了多少比例的实时流量。选择此指标值取决于您的用例。这是在保存推理流量量和模型监控的有效性之间的一种权衡。如果此参数的值接近
    100，则存储的信息更多，导致更高的存储成本，以及更多用于监控作业分析的数据，从而导致较长的执行时间。另一方面，更高的采样百分比会导致捕获更多与基线进行比较的推理流量模式。'
- en: If your production model is operating in dynamic environments such as retail
    or financial services, where the consumer behavior or environment factors often
    change, impacting the model predictions, the best practice is to use a sampling
    percentage of 100.
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您的生产模型在动态环境中运行，例如零售或金融服务，在这些环境中消费者行为或环境因素经常变化，影响模型预测，最佳实践是使用 100% 的采样百分比。
- en: '**Choosing a dataset for baseline generation**: For generating the baseline,
    the training dataset is typically a good dataset to use. For baseline generation,
    keep in mind that the first column in the training dataset is considered to be
    the label. Besides the label, ensure that the number and order of the features
    in the inference traffic match the training dataset.'
  id: totrans-147
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**选择用于基线生成的数据集**：对于生成基线，通常使用训练数据集是一个很好的选择。在生成基线时，请注意，训练数据集中的第一列被认为是标签。除了标签之外，确保推理流量中的特征数量和顺序与训练数据集相匹配。'
- en: Additionally, for bias drift and feature attribution drift, the baseline generation
    process stands up a shadow endpoint to collect predictions from. So, consider
    the limit of the number of active endpoints in your AWS account when executing
    a baseline job.
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此外，对于偏差漂移和特征归因漂移，基线生成过程会启动一个影子端点来收集预测。因此，在执行基线作业时，请考虑您 AWS 账户中活动端点的数量限制。
- en: '**Choosing the monitoring schedule execution frequency**: Monitoring jobs,
    as you have seen so far, are executed on a periodic basis where the minimum interval
    length is 1 hour. This minimum interval is necessary because enough inference
    traffic needs to be collected to be compared against the baseline. When determining
    the monitoring execution frequency, you should select this interval based on the
    inference traffic your model is serving. For example, a model deployed as part
    of a busy e-commerce website may serve higher traffic volumes, so running a monitoring
    job every few hours will give you the chance to detect data and model quality
    issues quickly. However, every time a monitoring job is executed, it adds to your
    model monitoring costs. The monitoring job schedule should therefore consider
    the trade-off between the ability to robustly detect model issues and monitoring
    costs.'
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**选择监控计划执行频率**：如你所见，监控作业是周期性执行的，最小间隔长度为1小时。这个最小间隔是必要的，因为需要收集足够的推理流量来与基线进行比较。在确定监控执行频率时，你应该根据模型所服务的推理流量选择这个间隔。例如，作为繁忙的电子商务网站部署的一部分的模型可能需要处理更高的流量量，因此每隔几个小时运行一次监控作业将给你快速检测数据和模型质量问题的机会。然而，每次执行监控作业都会增加你的模型监控成本。因此，监控作业计划应考虑在稳健地检测模型问题和监控成本之间的权衡。'
- en: Note
  id: totrans-150
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: There could be a delay of 0-20 minutes between the scheduled time and execution
    of the monitoring job.
  id: totrans-151
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 监控作业的预定时间和执行之间可能会有0-20分钟的延迟。
- en: '`StartOffset` and `EndOffset` fields of the `ModelQualityJobInput` parameter.
    `StartOffset` specifies the time subtracted from the start time and `EndOffset`
    specifies the time subtracted from the end time of the monitoring job. Offsets
    are in the format of `-P#D`, `-P#M`, or `-P#H`, where `D`, `M`, and `H` represent
    days, minutes, and hours, respectively, and `#` is the number. For example, a
    `-P7H` value of `StartOffset` will cause the monitoring job to start 7 hours after
    the scheduled time.'
  id: totrans-152
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ModelQualityJobInput`参数的`StartOffset`和`EndOffset`字段。`StartOffset`指定从开始时间减去的时间，`EndOffset`指定从监控作业结束时间减去的时间。偏移量格式为`-P#D`、`-P#M`或`-P#H`，其中`D`、`M`和`H`分别代表天、分钟和小时，`#`是数字。例如，`StartOffset`的`-P7H`值将导致监控作业在预定时间后7小时开始。'
- en: Additionally, ensure that the monitoring schedule cadence is such that any given
    execution should be completed before the subsequent execution starts, allowing
    both the ground truth merge job and the monitoring job to complete for each interval.
  id: totrans-153
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此外，确保监控计划的节奏是这样的，任何给定的执行应在后续执行开始之前完成，以便每个间隔内都能完成真实合并作业和监控作业。
- en: '**Automating remediation actions**: While a monitoring solution proactively
    detects the data and model issues, without a proper plan to act on the issues,
    you cannot ensure the model''s continued ability to meet your business needs.
    To reap the benefits of the model monitoring alerts generated, as much as possible,
    automate actions that you need to perform as a result. For example, automate notifications
    sent to operations and data science teams about possible data and model issues.
    Similarly, automate collecting or importing new training data and triggering re-training
    and testing of the models in non-production environments such as dev/QA and staging.'
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**自动化修复操作**：虽然监控解决方案可以主动检测数据和模型问题，但没有适当的行动计划来处理这些问题，你无法确保模型持续满足你的业务需求。为了最大限度地利用生成的模型监控警报的好处，尽可能自动化你需要执行的操作。例如，自动化发送给运维和数据科学团队的有关可能的数据和模型问题的通知。同样，自动化收集或导入新的训练数据，并在非生产环境（如开发/测试和预发布）中触发模型的重新训练和测试。'
- en: '`sagemaker-model-monitor-analyzer` that provides the capabilities we have reviewed
    in this chapter so far. This Spark-based container built on the open source Deequ
    framework provides a range of capabilities, such as generating statistics, suggesting
    constraints, validating constraints against a baseline, and emitting CloudWatch
    metrics.'
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`sagemaker-model-monitor-analyzer`提供了本章迄今为止我们已经审查过的功能。这个基于Spark的容器是在开源Deequ框架上构建的，提供了一系列功能，例如生成统计数据、建议约束、验证约束与基线，以及发出CloudWatch指标。'
- en: Whenever possible, choose to use this built-in container since SageMaker takes
    on the burden of securing, managing, and updating this container with new capabilities.
    You can extend the capabilities of this container by providing your own preprocessing
    and postprocessing scripts. For example, you can use a custom preprocessing script
    to make small changes to data, such as converting from an array to flattened JSON
    as required by the baseline job. Similarly, you can perform postprocessing to
    make changes to monitoring results.
  id: totrans-156
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在可能的情况下，选择使用此内置容器，因为 SageMaker 承担了确保、管理和更新此容器以添加新功能的负担。您可以通过提供自己的预处理和后处理脚本来扩展此容器的功能。例如，您可以使用自定义预处理脚本来对数据进行小幅度修改，例如将数组转换为基线作业所需的扁平化
    JSON。同样，您可以对监控结果进行后处理以进行更改。
- en: In addition to using the SageMaker-provided container, you can also use your
    own containers for custom monitoring. Custom containers allow you to build your
    own monitoring schedules as well as your own logic for generating custom statistics,
    constraints, and violations, along with custom CloudWatch metrics. When creating
    a custom container, you should follow the input and output contracts published
    by SageMaker. Additionally, you will be responsible for registering, managing,
    and updating this custom container.
  id: totrans-157
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 除了使用 SageMaker 提供的容器外，您还可以使用自己的容器进行自定义监控。自定义容器允许您构建自己的监控计划以及生成自定义统计信息、约束和违规的自己的逻辑，同时还有自定义的
    CloudWatch 指标。在创建自定义容器时，您应遵循 SageMaker 发布的输入和输出合约。此外，您将负责注册、管理和更新此自定义容器。
- en: '**Including human reviews in the monitoring workflow**: For some critical ML
    applications, say, for example, a financial loan approval application, it will
    often be necessary to include human reviewers in the monitoring loop. Especially
    when the ML model returns predictions with low confidence, human experts need
    to ensure that the predictions are valid. Amazon A2I allows you to configure custom
    monitoring workflows to include human experts to review predictions from SageMaker
    models. Please see the *References* section for a link to a detailed blog on configuring
    custom human-in-the-loop workflows using SageMaker and Amazon A2I.'
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**在监控工作流程中包含人工审查**：对于一些关键机器学习应用，例如，例如，一个金融贷款审批应用，通常需要将人工审查人员纳入监控循环。特别是在机器学习模型返回置信度低的预测时，专家需要确保预测的有效性。Amazon
    A2I 允许您配置自定义监控工作流程，以包含人工专家审查 SageMaker 模型的预测。请参阅 *参考文献* 部分，以获取有关使用 SageMaker 和
    Amazon A2I 配置自定义人工在环工作流程的详细博客链接。'
- en: Use the best practices discussed in this section to create model monitoring
    configurations that best meet your business and organizational requirements.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 使用本节讨论的最佳实践来创建最适合您的业务和组织要求的模型监控配置。
- en: Summary
  id: totrans-160
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, you learned the importance of monitoring ML models deployed
    in production and the different aspects of models to monitor. You dove deep into
    multiple end-to-end architectures to build continuous monitoring, automate responses
    to detected data, and model issues using SageMaker Model Monitor and SageMaker
    Clarify. You learned how to use the various metrics and reports generated to gain
    insight into your data and model.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，您学习了监控在生产中部署的机器学习模型的重要性以及需要监控的模型的不同方面。您深入研究了多个端到端架构，以使用 SageMaker Model
    Monitor 和 SageMaker Clarify 构建持续监控、自动响应检测到的数据和模型问题。您学习了如何使用生成的各种指标和报告来深入了解您的数据和模型。
- en: Finally, we concluded with a discussion on the best practices for configuring
    model monitoring. Using the concepts discussed in this chapter, you can build
    a comprehensive monitoring solution to meet your performance and regulatory requirements,
    without having to use various different third-party tools for monitoring various
    aspects of your model.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们以讨论配置模型监控的最佳实践作为总结。利用本章讨论的概念，您可以构建一个全面的监控解决方案，以满足您的性能和监管要求，而无需使用各种不同的第三方工具来监控模型的不同方面。
- en: In the next chapter, we will introduce end-to-end ML workflows that stitch all
    the individual steps involved in the ML process together.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将介绍端到端机器学习工作流程，该工作流程将 ML 过程中涉及的各个单独步骤连接起来。
- en: References
  id: totrans-164
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参考文献
- en: 'For additional reading material, please review the following reference:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 对于额外的阅读材料，请查阅以下参考文献：
- en: 'Automated monitoring of your ML models with Amazon SageMaker Model Monitor
    and sending predictions to human review workflows using Amazon A2I:'
  id: totrans-166
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Amazon SageMaker Model Monitor 自动监控您的机器学习模型，并通过 Amazon A2I 将预测发送到人工审查工作流程：
- en: '[https://aws.amazon.com/blogs/machine-learning/automated-monitoring-of-your-machine-learning-models-with-amazon-sagemaker-model-monitor-and-sending-predictions-to-human-review-workflows-using-amazon-a2i](https://aws.amazon.com/blogs/machine-learning/automated-monitoring-of-your-machine-learning-models-with-amazon-sagemaker-model-monitor-and-sending-predictions-to-human-review-workflows-using-amazon-a2i)'
  id: totrans-167
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '[使用Amazon SageMaker模型监控自动监控您的机器学习模型，并通过Amazon A2I将预测发送到人工审查工作流程](https://aws.amazon.com/blogs/machine-learning/automated-monitoring-of-your-machine-learning-models-with-amazon-sagemaker-model-monitor-and-sending-predictions-to-human-review-workflows-using-amazon-a2i)'
